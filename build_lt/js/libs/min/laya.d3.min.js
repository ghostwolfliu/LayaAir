!function(e,t){"use strict";let r=(()=>{class e{constructor(){}static isZero(t){return Math.abs(t)<e.zeroTolerance}static nearEqual(t,r){return!!e.isZero(t-r)}static fastInvSqrt(t){return e.isZero(t)?t:1/Math.sqrt(t)}}return e.zeroTolerance=1e-6,e.MaxValue=340282347e30,e.MinValue=-340282347e30,e.Deg2Rad=Math.PI/180,e})(),i=(()=>{class e{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){this.x=e,this.y=t}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}cloneTo(e){var t=e;t.x=this.x,t.y=this.y}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var r=e.x,i=e.y,n=r*r+i*i;n>0&&(n=1/Math.sqrt(n),t.x=r*n,t.y=i*n)}static scalarLength(e){var t=e.x,r=e.y;return Math.sqrt(t*t+r*r)}clone(){var t=new e;return this.cloneTo(t),t}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),e.rewriteNumProperty(this,"x",0),e.rewriteNumProperty(this,"y",1)}static rewriteNumProperty(e,t,r){Object.defineProperty(e,t,{get:function(){return this.elements[r]},set:function(e){this.elements[r]=e}})}}return e.ZERO=new e(0,0),e.ONE=new e(1,1),e})(),n=(()=>{class e{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.z=r,this.w=i}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var t=new e;return this.cloneTo(t),t}static lerp(e,t,r,i){var n=e.x,a=e.y,s=e.z,o=e.w;i.x=n+r*(t.x-n),i.y=a+r*(t.y-a),i.z=s+r*(t.z-s),i.w=o+r*(t.w-o)}static transformByM4x4(e,t,r){var i=e.x,n=e.y,a=e.z,s=e.w,o=t.elements;r.x=i*o[0]+n*o[4]+a*o[8]+s*o[12],r.y=i*o[1]+n*o[5]+a*o[9]+s*o[13],r.z=i*o[2]+n*o[6]+a*o[10]+s*o[14],r.w=i*o[3]+n*o[7]+a*o[11]+s*o[15]}static equals(e,t){return r.nearEqual(Math.abs(e.x),Math.abs(t.x))&&r.nearEqual(Math.abs(e.y),Math.abs(t.y))&&r.nearEqual(Math.abs(e.z),Math.abs(t.z))&&r.nearEqual(Math.abs(e.w),Math.abs(t.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var r=e.length();if(r>0){var i=1/r;t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i}}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t}static Clamp(e,t,r,i){var n=e.x,a=e.y,s=e.z,o=e.w,l=t.x,_=t.y,h=t.z,c=t.w,d=r.x,u=r.y,m=r.z,f=r.w;n=(n=n>d?d:n)<l?l:n,a=(a=a>u?u:a)<_?_:a,s=(s=s>m?m:s)<h?h:s,o=(o=o>f?f:o)<c?c:o,i.x=n,i.y=a,i.z=s,i.w=o}static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,n=e.z-t.z,a=e.w-t.w;return r*r+i*i+n*n+a*a}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,n=e.z-t.z,a=e.w-t.w;return Math.sqrt(r*r+i*i+n*n+a*a)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),i.rewriteNumProperty(this,"x",0),i.rewriteNumProperty(this,"y",1),i.rewriteNumProperty(this,"z",2),i.rewriteNumProperty(this,"w",3)}}return e.ZERO=new e,e.ONE=new e(1,1,1,1),e.UnitX=new e(1,0,0,0),e.UnitY=new e(0,1,0,0),e.UnitZ=new e(0,0,1,0),e.UnitW=new e(0,0,0,1),e})(),a=(()=>{class e{constructor(e=0,t=0,r=0,i=null){this.x=e,this.y=t,this.z=r}static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,n=e.z-t.z;return r*r+i*i+n*n}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,n=e.z-t.z;return Math.sqrt(r*r+i*i+n*n)}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)}static transformQuat(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.x,o=t.y,l=t.z,_=t.w,h=_*i+o*a-l*n,c=_*n+l*i-s*a,d=_*a+s*n-o*i,u=-s*i-o*n-l*a;r.x=h*_+u*-s+c*-l-d*-o,r.y=c*_+u*-o+d*-s-h*-l,r.z=d*_+u*-l+h*-o-c*-s}static scalarLength(e){var t=e.x,r=e.y,i=e.z;return Math.sqrt(t*t+r*r+i*i)}static scalarLengthSquared(e){var t=e.x,r=e.y,i=e.z;return t*t+r*r+i*i}static normalize(e,t){var r=e.x,i=e.y,n=e.z,a=r*r+i*i+n*n;a>0&&(a=1/Math.sqrt(a),t.x=r*a,t.y=i*a,t.z=n*a)}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t}static lerp(e,t,r,i){var n=e.x,a=e.y,s=e.z;i.x=n+r*(t.x-n),i.y=a+r*(t.y-a),i.z=s+r*(t.z-s)}static transformV3ToV3(t,r,i){var n=e._tempVector4;e.transformV3ToV4(t,r,n),i.x=n.x,i.y=n.y,i.z=n.z}static transformV3ToV4(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.elements;r.x=i*s[0]+n*s[4]+a*s[8]+s[12],r.y=i*s[1]+n*s[5]+a*s[9]+s[13],r.z=i*s[2]+n*s[6]+a*s[10]+s[14],r.w=i*s[3]+n*s[7]+a*s[11]+s[15]}static TransformNormal(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.elements;r.x=i*s[0]+n*s[4]+a*s[8],r.y=i*s[1]+n*s[5]+a*s[9],r.z=i*s[2]+n*s[6]+a*s[10]}static transformCoordinate(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.elements,o=i*s[3]+n*s[7]+a*s[11]+s[15];r.x=(i*s[0]+n*s[4]+a*s[8]+s[12])/o,r.y=(i*s[1]+n*s[5]+a*s[9]+s[13])/o,r.z=(i*s[2]+n*s[6]+a*s[10]+s[14])/o}static Clamp(e,t,r,i){var n=e.x,a=e.y,s=e.z,o=t.x,l=t.y,_=t.z,h=r.x,c=r.y,d=r.z;n=(n=n>h?h:n)<o?o:n,a=(a=a>c?c:a)<l?l:a,s=(s=s>d?d:s)<_?_:s,i.x=n,i.y=a,i.z=s}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z}static cross(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.x,o=t.y,l=t.z;r.x=n*l-a*o,r.y=a*s-i*l,r.z=i*o-n*s}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)&&r.nearEqual(e.z,t.z)}setValue(e,t,r){this.x=e,this.y=t,this.z=r}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}clone(){var t=new e;return this.cloneTo(t),t}toDefault(){this.x=0,this.y=0,this.z=0}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),i.rewriteNumProperty(this,"x",0),i.rewriteNumProperty(this,"y",1),i.rewriteNumProperty(this,"z",2)}}return e._tempVector4=new n,e._ZERO=new e(0,0,0),e._ONE=new e(1,1,1),e._NegativeUnitX=new e(-1,0,0),e._UnitX=new e(1,0,0),e._UnitY=new e(0,1,0),e._UnitZ=new e(0,0,1),e._ForwardRH=new e(0,0,-1),e._ForwardLH=new e(0,0,1),e._Up=new e(0,1,0),e})();var s;(s=e.PBRRenderQuality||(e.PBRRenderQuality={}))[s.High=0]="High",s[s.Low=1]="Low";let o=(()=>{class e{constructor(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}static createRotationQuaternion(e,t){var r=e.x,i=e.y,n=e.z,a=e.w,s=r*r,o=i*i,l=n*n,_=r*i,h=n*a,c=n*r,d=i*a,u=i*n,m=r*a,f=t.elements;f[0]=1-2*(o+l),f[1]=2*(_+h),f[2]=2*(c-d),f[3]=2*(_-h),f[4]=1-2*(l+s),f[5]=2*(u+m),f[6]=2*(c+d),f[7]=2*(u-m),f[8]=1-2*(o+s)}static createFromTranslation(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1}static createFromRotation(e,t){var r=t.elements,i=Math.sin(e),n=Math.cos(e);r[0]=n,r[1]=i,r[2]=0,r[3]=-i,r[4]=n,r[5]=0,r[6]=0,r[7]=0,r[8]=1}static createFromScaling(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=e.z}static createFromMatrix4x4(e,t){var r=e.elements,i=t.elements;i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[4],i[4]=r[5],i[5]=r[6],i[6]=r[8],i[7]=r[9],i[8]=r[10]}static multiply(e,t,r){var i=e.elements,n=t.elements,a=r.elements,s=i[0],o=i[1],l=i[2],_=i[3],h=i[4],c=i[5],d=i[6],u=i[7],m=i[8],f=n[0],T=n[1],E=n[2],p=n[3],g=n[4],S=n[5],R=n[6],v=n[7],A=n[8];a[0]=f*s+T*_+E*d,a[1]=f*o+T*h+E*v,a[2]=f*l+T*c+E*m,a[3]=p*s+g*_+S*d,a[4]=p*o+g*h+S*u,a[5]=p*l+g*c+S*m,a[6]=R*s+v*_+A*d,a[7]=R*o+v*h+A*u,a[8]=R*l+v*c+A*m}determinant(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],_=e[8];return t*(_*a-s*l)+r*(-_*n+s*o)+i*(l*n-a*o)}translate(e,t){var r=t.elements,i=this.elements,n=i[0],a=i[1],s=i[2],o=i[3],l=i[4],_=i[5],h=i[6],c=i[7],d=i[8],u=e.x,m=e.y;r[0]=n,r[1]=a,r[2]=s,r[3]=o,r[4]=l,r[5]=_,r[6]=u*n+m*o+h,r[7]=u*a+m*l+c,r[8]=u*s+m*_+d}rotate(e,t){var r=t.elements,i=this.elements,n=i[0],a=i[1],s=i[2],o=i[3],l=i[4],_=i[5],h=i[6],c=i[7],d=i[8],u=Math.sin(e),m=Math.cos(e);r[0]=m*n+u*o,r[1]=m*a+u*l,r[2]=m*s+u*_,r[3]=m*o-u*n,r[4]=m*l-u*a,r[5]=m*_-u*s,r[6]=h,r[7]=c,r[8]=d}scale(e,t){var r=t.elements,i=this.elements,n=e.x,a=e.y;r[0]=n*i[0],r[1]=n*i[1],r[2]=n*i[2],r[3]=a*i[3],r[4]=a*i[4],r[5]=a*i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8]}invert(e){var t=e.elements,r=this.elements,i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],l=r[5],_=r[6],h=r[7],c=r[8],d=c*o-l*h,u=-c*s+l*_,m=h*s-o*_,f=i*d+n*u+a*m;f||(e=null),f=1/f,t[0]=d*f,t[1]=(-c*n+a*h)*f,t[2]=(l*n-a*o)*f,t[3]=u*f,t[4]=(c*i-a*_)*f,t[5]=(-l*i+a*s)*f,t[6]=m*f,t[7]=(-h*i+n*_)*f,t[8]=(o*i-n*s)*f}transpose(e){var t=e.elements,r=this.elements;if(e===this){var i=r[1],n=r[2],a=r[5];t[1]=r[3],t[2]=r[6],t[3]=i,t[5]=r[7],t[6]=n,t[7]=a}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8]}identity(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}cloneTo(e){var t,r,i;if((r=this.elements)!==(i=e.elements))for(t=0;t<9;++t)i[t]=r[t]}clone(){var t=new e;return this.cloneTo(t),t}static lookAt(t,r,i,n){a.subtract(t,r,e._tempV30),a.normalize(e._tempV30,e._tempV30),a.cross(i,e._tempV30,e._tempV31),a.normalize(e._tempV31,e._tempV31),a.cross(e._tempV30,e._tempV31,e._tempV32);var s=e._tempV30,o=e._tempV31,l=e._tempV32,_=n.elements;_[0]=o.x,_[3]=o.y,_[6]=o.z,_[1]=l.x,_[4]=l.y,_[7]=l.z,_[2]=s.x,_[5]=s.y,_[8]=s.z}}return e.DEFAULT=new e,e._tempV30=new a,e._tempV31=new a,e._tempV32=new a,e})(),l=(()=>{class e{}return e.Shader3D=null,e.Scene3D=null,e.MeshRenderStaticBatchManager=null,e.MeshRenderDynamicBatchManager=null,e.SubMeshDynamicBatch=null,e.Laya3D=null,e.Matrix4x4=null,e.Physics3D=null,e.ShadowLightType=null,e})(),_=(()=>{class e{constructor(e=0,t=0,r=0,i=1,n=null){this.x=e,this.y=t,this.z=r,this.w=i}static createFromYawPitchRoll(e,t,r,i){var n=.5*r,a=.5*t,s=.5*e,o=Math.sin(n),l=Math.cos(n),_=Math.sin(a),h=Math.cos(a),c=Math.sin(s),d=Math.cos(s);i.x=d*_*l+c*h*o,i.y=c*h*l-d*_*o,i.z=d*h*o-c*_*l,i.w=d*h*l+c*_*o}static multiply(e,t,r){var i=e.x,n=e.y,a=e.z,s=e.w,o=t.x,l=t.y,_=t.z,h=t.w,c=n*_-a*l,d=a*o-i*_,u=i*l-n*o,m=i*o+n*l+a*_;r.x=i*h+o*s+c,r.y=n*h+l*s+d,r.z=a*h+_*s+u,r.w=s*h-m}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(t,r,i){a.subtract(r,t,e.TEMPVector30),a.normalize(e.TEMPVector30,e.TEMPVector30),i.x=Math.asin(e.TEMPVector30.y),i.y=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)}static createFromAxisAngle(e,t,r){t*=.5;var i=Math.sin(t);r.x=i*e.x,r.y=i*e.y,r.z=i*e.z,r.w=Math.cos(t)}static createFromMatrix4x4(e,t){var r,i,n=e.elements,a=n[0]+n[5]+n[10];a>0?(r=Math.sqrt(a+1),t.w=.5*r,r=.5/r,t.x=(n[6]-n[9])*r,t.y=(n[8]-n[2])*r,t.z=(n[1]-n[4])*r):n[0]>=n[5]&&n[0]>=n[10]?(i=.5/(r=Math.sqrt(1+n[0]-n[5]-n[10])),t.x=.5*r,t.y=(n[1]+n[4])*i,t.z=(n[2]+n[8])*i,t.w=(n[6]-n[9])*i):n[5]>n[10]?(i=.5/(r=Math.sqrt(1+n[5]-n[0]-n[10])),t.x=(n[4]+n[1])*i,t.y=.5*r,t.z=(n[9]+n[6])*i,t.w=(n[8]-n[2])*i):(i=.5/(r=Math.sqrt(1+n[10]-n[0]-n[5])),t.x=(n[8]+n[2])*i,t.y=(n[9]+n[6])*i,t.z=.5*r,t.w=(n[1]-n[4])*i)}static slerp(e,t,r,i){var n,a,s,o,l,_=e.x,h=e.y,c=e.z,d=e.w,u=t.x,m=t.y,f=t.z,T=t.w;return(a=_*u+h*m+c*f+d*T)<0&&(a=-a,u=-u,m=-m,f=-f,T=-T),1-a>1e-6?(n=Math.acos(a),s=Math.sin(n),o=Math.sin((1-r)*n)/s,l=Math.sin(r*n)/s):(o=1-r,l=r),i.x=o*_+l*u,i.y=o*h+l*m,i.z=o*c+l*f,i.w=o*d+l*T,i}static lerp(t,r,i,n){var a=1-i;e.dot(t,r)>=0?(n.x=a*t.x+i*r.x,n.y=a*t.y+i*r.y,n.z=a*t.z+i*r.z,n.w=a*t.w+i*r.w):(n.x=a*t.x-i*r.x,n.y=a*t.y-i*r.y,n.z=a*t.z-i*r.z,n.w=a*t.w-i*r.w),n.normalize(n)}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.w*r,t.y=this.y*i+this.z*r,t.z=this.z*i-this.y*r,t.w=this.w*i-this.x*r}rotateY(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i-this.z*r,t.y=this.y*i+this.w*r,t.z=this.z*i+this.x*r,t.w=this.w*i-this.y*r}rotateZ(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.y*r,t.y=this.y*i-this.x*r,t.z=this.z*i+this.w*r,t.w=this.w*i-this.z*r}getYawPitchRoll(t){a.transformQuat(a._ForwardRH,this,e.TEMPVector31),a.transformQuat(a._Up,this,e.TEMPVector32);var r=e.TEMPVector32;e.angleTo(a._ZERO,e.TEMPVector31,e.TEMPVector33);var i=e.TEMPVector33;i.x==Math.PI/2?(i.y=e.arcTanAngle(r.z,r.x),i.z=0):i.x==-Math.PI/2?(i.y=e.arcTanAngle(-r.z,-r.x),i.z=0):(l.Matrix4x4.createRotationY(-i.y,l.Matrix4x4.TEMPMatrix0),l.Matrix4x4.createRotationX(-i.x,l.Matrix4x4.TEMPMatrix1),a.transformCoordinate(e.TEMPVector32,l.Matrix4x4.TEMPMatrix0,e.TEMPVector32),a.transformCoordinate(e.TEMPVector32,l.Matrix4x4.TEMPMatrix1,e.TEMPVector32),i.z=e.arcTanAngle(r.y,-r.x)),i.y<=-Math.PI&&(i.y=Math.PI),i.z<=-Math.PI&&(i.z=Math.PI),i.y>=Math.PI&&i.z>=Math.PI&&(i.y=0,i.z=0,i.x=Math.PI-i.x);var n=t;n.x=i.y,n.y=i.x,n.z=i.z}invert(e){var t=this.x,r=this.y,i=this.z,n=this.w,a=t*t+r*r+i*i+n*n,s=a?1/a:0;e.x=-t*s,e.y=-r*s,e.z=-i*s,e.w=n*s}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var t=new e;return this.cloneTo(t),t}equals(e){return r.nearEqual(this.x,e.x)&&r.nearEqual(this.y,e.y)&&r.nearEqual(this.z,e.z)&&r.nearEqual(this.w,e.w)}static rotationLookAt(t,r,i){e.lookAt(a._ZERO,t,r,i)}static lookAt(t,r,i,n){o.lookAt(t,r,i,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,n)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var i=e.lengthSquared();r.isZero(i)||(i=1/i,t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i)}static rotationMatrix(e,t){var r,i,n=e.elements,a=n[0],s=n[1],o=n[2],l=n[3],_=n[4],h=n[5],c=n[6],d=n[7],u=n[8],m=a+_+u;m>0?(r=Math.sqrt(m+1),t.w=.5*r,r=.5/r,t.x=(h-d)*r,t.y=(c-o)*r,t.z=(s-l)*r):a>=_&&a>=u?(i=.5/(r=Math.sqrt(1+a-_-u)),t.x=.5*r,t.y=(s+l)*i,t.z=(o+c)*i,t.w=(h-d)*i):_>u?(i=.5/(r=Math.sqrt(1+_-a-u)),t.x=(l+s)*i,t.y=.5*r,t.z=(d+h)*i,t.w=(c-o)*i):(i=.5/(r=Math.sqrt(1+u-a-_)),t.x=(c+o)*i,t.y=(d+h)*i,t.z=.5*r,t.w=(s-l)*i)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),i.rewriteNumProperty(this,"x",0),i.rewriteNumProperty(this,"y",1),i.rewriteNumProperty(this,"z",2),i.rewriteNumProperty(this,"w",3)}}return e.TEMPVector30=new a,e.TEMPVector31=new a,e.TEMPVector32=new a,e.TEMPVector33=new a,e._tempMatrix3x3=new o,e.DEFAULT=new e,e.NAN=new e(NaN,NaN,NaN,NaN),e})(),h=(()=>{class e{constructor(e=1,t=0,r=0,i=0,n=0,a=1,s=0,o=0,l=0,_=0,h=1,c=0,d=0,u=0,m=0,f=1,T=null){var E=this.elements=T||new Float32Array(16);E[0]=e,E[1]=t,E[2]=r,E[3]=i,E[4]=n,E[5]=a,E[6]=s,E[7]=o,E[8]=l,E[9]=_,E[10]=h,E[11]=c,E[12]=d,E[13]=u,E[14]=m,E[15]=f}static createRotationX(e,t){var r=t.elements,i=Math.sin(e),n=Math.cos(e);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=n,r[6]=i,r[9]=-i}static createRotationY(e,t){var r=t.elements,i=Math.sin(e),n=Math.cos(e);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=n,r[2]=-i,r[8]=i}static createRotationZ(e,t){var r=t.elements,i=Math.sin(e),n=Math.cos(e);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=n,r[1]=i,r[4]=-i}static createRotationYawPitchRoll(t,r,i,n){_.createFromYawPitchRoll(t,r,i,e._tempQuaternion),e.createRotationQuaternion(e._tempQuaternion,n)}static createRotationAxis(e,t,r){var i=e.x,n=e.y,a=e.z,s=Math.cos(t),o=Math.sin(t),l=i*i,_=n*n,h=a*a,c=i*n,d=i*a,u=n*a,m=r.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=l+s*(1-l),m[1]=c-s*c+o*a,m[2]=d-s*d-o*n,m[4]=c-s*c-o*a,m[5]=_+s*(1-_),m[6]=u-s*u+o*i,m[8]=d-s*d+o*n,m[9]=u-s*u-o*i,m[10]=h+s*(1-h)}setRotation(e){var t=e.x,r=e.y,i=e.z,n=e.w,a=t*t,s=r*r,o=i*i,l=t*r,_=i*n,h=i*t,c=r*n,d=r*i,u=t*n,m=this.elements;m[0]=1-2*(s+o),m[1]=2*(l+_),m[2]=2*(h-c),m[4]=2*(l-_),m[5]=1-2*(o+a),m[6]=2*(d+u),m[8]=2*(h+c),m[9]=2*(d-u),m[10]=1-2*(s+a)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}static createRotationQuaternion(e,t){var r=t.elements,i=e.x,n=e.y,a=e.z,s=e.w,o=i*i,l=n*n,_=a*a,h=i*n,c=a*s,d=a*i,u=n*s,m=n*a,f=i*s;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(l+_),r[1]=2*(h+c),r[2]=2*(d-u),r[4]=2*(h-c),r[5]=1-2*(_+o),r[6]=2*(m+f),r[8]=2*(d+u),r[9]=2*(m-f),r[10]=1-2*(l+o)}static createTranslate(e,t){var r=t.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}static createScaling(e,t){var r=t.elements;r[0]=e.x,r[5]=e.y,r[10]=e.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}static multiply(e,t,r){var i=t.elements,n=e.elements,a=r.elements,s=i[0],o=i[1],l=i[2],_=i[3],h=i[4],c=i[5],d=i[6],u=i[7],m=i[8],f=i[9],T=i[10],E=i[11],p=i[12],g=i[13],S=i[14],R=i[15],v=n[0],A=n[1],I=n[2],x=n[3],C=n[4],L=n[5],y=n[6],D=n[7],M=n[8],O=n[9],N=n[10],b=n[11],P=n[12],w=n[13],V=n[14],F=n[15];a[0]=s*v+o*C+l*M+_*P,a[1]=s*A+o*L+l*O+_*w,a[2]=s*I+o*y+l*N+_*V,a[3]=s*x+o*D+l*b+_*F,a[4]=h*v+c*C+d*M+u*P,a[5]=h*A+c*L+d*O+u*w,a[6]=h*I+c*y+d*N+u*V,a[7]=h*x+c*D+d*b+u*F,a[8]=m*v+f*C+T*M+E*P,a[9]=m*A+f*L+T*O+E*w,a[10]=m*I+f*y+T*N+E*V,a[11]=m*x+f*D+T*b+E*F,a[12]=p*v+g*C+S*M+R*P,a[13]=p*A+g*L+S*O+R*w,a[14]=p*I+g*y+S*N+R*V,a[15]=p*x+g*D+S*b+R*F}static multiplyForNative(e,r,i){t.LayaGL.instance.matrix4x4Multiply(e.elements,r.elements,i.elements)}static createFromQuaternion(e,t){var r=t.elements,i=e.x,n=e.y,a=e.z,s=e.w,o=i+i,l=n+n,_=a+a,h=i*o,c=n*o,d=n*l,u=a*o,m=a*l,f=a*_,T=s*o,E=s*l,p=s*_;r[0]=1-d-f,r[1]=c+p,r[2]=u-E,r[3]=0,r[4]=c-p,r[5]=1-h-f,r[6]=m+T,r[7]=0,r[8]=u+E,r[9]=m-T,r[10]=1-h-d,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}static createAffineTransformation(e,t,r,i){var n=i.elements,a=t.x,s=t.y,o=t.z,l=t.w,_=a+a,h=s+s,c=o+o,d=a*_,u=a*h,m=a*c,f=s*h,T=s*c,E=o*c,p=l*_,g=l*h,S=l*c,R=r.x,v=r.y,A=r.z;n[0]=(1-(f+E))*R,n[1]=(u+S)*R,n[2]=(m-g)*R,n[3]=0,n[4]=(u-S)*v,n[5]=(1-(d+E))*v,n[6]=(T+p)*v,n[7]=0,n[8]=(m+g)*A,n[9]=(T-p)*A,n[10]=(1-(d+f))*A,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1}static createLookAt(t,r,i,n){var s=n.elements,o=e._tempVector0,l=e._tempVector1,_=e._tempVector2;a.subtract(t,r,_),a.normalize(_,_),a.cross(i,_,o),a.normalize(o,o),a.cross(_,o,l),s[3]=s[7]=s[11]=0,s[15]=1,s[0]=o.x,s[4]=o.y,s[8]=o.z,s[1]=l.x,s[5]=l.y,s[9]=l.z,s[2]=_.x,s[6]=_.y,s[10]=_.z,s[12]=-a.dot(o,t),s[13]=-a.dot(l,t),s[14]=-a.dot(_,t)}static createPerspective(t,r,i,n,a){var s=1/Math.tan(.5*t),o=i/(s/r),l=i/s;e.createPerspectiveOffCenter(-o,o,-l,l,i,n,a)}static createPerspectiveOffCenter(e,t,r,i,n,a,s){var o=s.elements,l=a/(a-n);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[12]=o[13]=o[15]=0,o[0]=2*n/(t-e),o[5]=2*n/(i-r),o[8]=(e+t)/(t-e),o[9]=(i+r)/(i-r),o[10]=-l,o[11]=-1,o[14]=-n*l}static createOrthoOffCenter(e,t,r,i,n,a,s){var o=s.elements,l=1/(a-n);o[1]=o[2]=o[3]=o[4]=o[6]=o[8]=o[7]=o[9]=o[11]=0,o[15]=1,o[0]=2/(t-e),o[5]=2/(i-r),o[10]=-l,o[12]=(e+t)/(e-t),o[13]=(i+r)/(r-i),o[14]=-n*l}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,r){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=r}equalsOtherMatrix(e){var t=this.elements,i=e.elements;return r.nearEqual(t[0],i[0])&&r.nearEqual(t[1],i[1])&&r.nearEqual(t[2],i[2])&&r.nearEqual(t[3],i[3])&&r.nearEqual(t[4],i[4])&&r.nearEqual(t[5],i[5])&&r.nearEqual(t[6],i[6])&&r.nearEqual(t[7],i[7])&&r.nearEqual(t[8],i[8])&&r.nearEqual(t[9],i[9])&&r.nearEqual(t[10],i[10])&&r.nearEqual(t[11],i[11])&&r.nearEqual(t[12],i[12])&&r.nearEqual(t[13],i[13])&&r.nearEqual(t[14],i[14])&&r.nearEqual(t[15],i[15])}decomposeTransRotScale(t,r,i){var n=e._tempMatrix4x4;return this.decomposeTransRotMatScale(t,n,i)?(_.createFromMatrix4x4(n,r),!0):(r.identity(),!1)}decomposeTransRotMatScale(t,i,n){var s=this.elements,o=t,l=i.elements,_=n;o.x=s[12],o.y=s[13],o.z=s[14];var h=s[0],c=s[1],d=s[2],u=s[4],m=s[5],f=s[6],T=s[8],E=s[9],p=s[10],g=_.x=Math.sqrt(h*h+c*c+d*d),S=_.y=Math.sqrt(u*u+m*m+f*f),R=_.z=Math.sqrt(T*T+E*E+p*p);if(r.isZero(g)||r.isZero(S)||r.isZero(R))return l[1]=l[2]=l[3]=l[4]=l[6]=l[7]=l[8]=l[9]=l[11]=l[12]=l[13]=l[14]=0,l[0]=l[5]=l[10]=l[15]=1,!1;var v=e._tempVector0;v.x=T/R,v.y=E/R,v.z=p/R;var A=e._tempVector1;A.x=h/g,A.y=c/g,A.z=d/g;var I=e._tempVector2;a.cross(v,A,I);var x=e._tempVector1;return a.cross(I,v,x),l[3]=l[7]=l[11]=l[12]=l[13]=l[14]=0,l[15]=1,l[0]=x.x,l[1]=x.y,l[2]=x.z,l[4]=I.x,l[5]=I.y,l[6]=I.z,l[8]=v.x,l[9]=v.y,l[10]=v.z,l[0]*h+l[1]*c+l[2]*d<0&&(_.x=-g),l[4]*u+l[5]*m+l[6]*f<0&&(_.y=-S),l[8]*T+l[9]*E+l[10]*p<0&&(_.z=-R),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>r.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=Math.sqrt(t*t+r*r+i*i);if(!n)return e[0]=0,e[1]=0,void(e[2]=0);1!=n&&(n=1/n,e[0]=t*n,e[1]=r*n,e[2]=i*n)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,r=e.elements,i=t[0],n=t[1],a=t[2],s=t[3],o=t[4],l=t[5],_=t[6],h=t[7],c=t[8],d=t[9],u=t[10],m=t[11],f=t[12],T=t[13],E=t[14],p=t[15],g=i*l-n*o,S=i*_-a*o,R=i*h-s*o,v=n*_-a*l,A=n*h-s*l,I=a*h-s*_,x=c*T-d*f,C=c*E-u*f,L=c*p-m*f,y=d*E-u*T,D=d*p-m*T,M=u*p-m*E,O=g*M-S*D+R*y+v*L-A*C+I*x;0!==Math.abs(O)&&(O=1/O,r[0]=(l*M-_*D+h*y)*O,r[1]=(a*D-n*M-s*y)*O,r[2]=(T*I-E*A+p*v)*O,r[3]=(u*A-d*I-m*v)*O,r[4]=(_*L-o*M-h*C)*O,r[5]=(i*M-a*L+s*C)*O,r[6]=(E*R-f*I-p*S)*O,r[7]=(c*I-u*R+m*S)*O,r[8]=(o*D-l*L+h*x)*O,r[9]=(n*L-i*D-s*x)*O,r[10]=(f*A-T*R+p*g)*O,r[11]=(d*R-c*A-m*g)*O,r[12]=(l*C-o*y-_*x)*O,r[13]=(i*y-n*C+a*x)*O,r[14]=(T*S-f*v-E*g)*O,r[15]=(c*v-d*S+u*g)*O)}static billboard(t,i,n,s,o,l){a.subtract(t,i,e._tempVector0);var _=a.scalarLengthSquared(e._tempVector0);r.isZero(_)?(a.scale(o,-1,e._tempVector1),e._tempVector1.cloneTo(e._tempVector0)):a.scale(e._tempVector0,1/Math.sqrt(_),e._tempVector0),a.cross(s,e._tempVector0,e._tempVector2),a.normalize(e._tempVector2,e._tempVector2),a.cross(e._tempVector0,e._tempVector2,e._tempVector3);var h=e._tempVector2,c=e._tempVector3,d=e._tempVector0,u=t,m=l.elements;m[0]=h.x,m[1]=h.y,m[2]=h.z,m[3]=0,m[4]=c.x,m[5]=c.y,m[6]=c.z,m[7]=0,m[8]=d.x,m[9]=d.y,m[10]=d.z,m[11]=0,m[12]=u.x,m[13]=u.y,m[14]=u.z,m[15]=1}identity(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}cloneTo(e){var t,r,i;if((r=this.elements)!==(i=e.elements))for(t=0;t<16;++t)i[t]=r[t]}clone(){var t=new e;return this.cloneTo(t),t}static translation(e,t){var r=t.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,r=e;t[12]=r.x,t[13]=r.y,t[14]=r.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}}return e._tempMatrix4x4=new e,e.TEMPMatrix0=new e,e.TEMPMatrix1=new e,e._tempVector0=new a,e._tempVector1=new a,e._tempVector2=new a,e._tempVector3=new a,e._tempQuaternion=new _,e.DEFAULT=new e,e.ZERO=new e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),e})(),c=(()=>{class e{constructor(){this._scale=new a(1,1,1),this._centerMatrix=new h,this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this._localOffset=new a(0,0,0),this._localRotation=new _(0,0,0,1),this.needsCustomCollisionCallback=!1}static __init__(){e._btScale=new CANNON.Vec3,e._btVector30=new CANNON.Vec3,e._btQuaternion0=new CANNON.Quaternion}static _createAffineTransformation(e,t,r){var i=t.x,n=t.y,a=t.z,s=t.w,o=i+i,l=n+n,_=a+a,h=i*o,c=i*l,d=i*_,u=n*l,m=n*_,f=a*_,T=s*o,E=s*l,p=s*_;r[0]=1-(u+f),r[1]=c+p,r[2]=d-E,r[3]=0,r[4]=c-p,r[5]=1-(h+f),r[6]=m+T,r[7]=0,r[8]=d+E,r[9]=m-T,r[10]=1-(h+u),r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1}get type(){return this._type}get localOffset(){return this._localOffset}set localOffset(e){e.cloneTo(this._localOffset)}get localRotation(){return this._localRotation}set localRotation(e){this._localRotation=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}_setScale(e){}_addReference(){this._referenceCount++}_removeReference(){this._referenceCount--}updateLocalTransformations(){if(this._compoundParent){var t=e._tempVector30;a.multiply(this.localOffset,this._scale,t),e._createAffineTransformation(t,this.localRotation,this._centerMatrix.elements)}else e._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements)}cloneTo(e){var t=e;this._localOffset.cloneTo(t.localOffset),this._localRotation.cloneTo(t.localRotation),t.localOffset=t.localOffset,t.localRotation=t.localRotation}clone(){return null}destroy(){this._btShape&&(this._btShape=null)}}return e.SHAPEORIENTATION_UPX=0,e.SHAPEORIENTATION_UPY=1,e.SHAPEORIENTATION_UPZ=2,e.SHAPETYPES_BOX=0,e.SHAPETYPES_SPHERE=1,e.SHAPETYPES_CYLINDER=2,e.SHAPETYPES_CAPSULE=3,e.SHAPETYPES_CONVEXHULL=4,e.SHAPETYPES_COMPOUND=5,e.SHAPETYPES_STATICPLANE=6,e.SHAPETYPES_CONE=7,e._tempVector30=new a,e})(),d=(()=>{class e extends t.EventDispatcher{constructor(t){super(),this._localPosition=new a(0,0,0),this._localRotation=new _(0,0,0,1),this._localScale=new a(1,1,1),this._localRotationEuler=new a(0,0,0),this._localMatrix=new h,this._position=new a(0,0,0),this._rotation=new _(0,0,0,1),this._scale=new a(1,1,1),this._rotationEuler=new a(0,0,0),this._worldMatrix=new h,this._children=null,this._parent=null,this._dummy=null,this._transformFlag=0,this._owner=t,this._children=[],this._setTransformFlag(e.TRANSFORM_LOCALQUATERNION|e.TRANSFORM_LOCALEULER|e.TRANSFORM_LOCALMATRIX,!1),this._setTransformFlag(e.TRANSFORM_WORLDPOSITION|e.TRANSFORM_WORLDQUATERNION|e.TRANSFORM_WORLDEULER|e.TRANSFORM_WORLDSCALE|e.TRANSFORM_WORLDMATRIX,!0)}get _isFrontFaceInvert(){var e=this.getWorldLossyScale(),t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}get owner(){return this._owner}get worldNeedUpdate(){return this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)}get localPositionX(){return this._localPosition.x}set localPositionX(e){this._localPosition.x=e,this.localPosition=this._localPosition}get localPositionY(){return this._localPosition.y}set localPositionY(e){this._localPosition.y=e,this.localPosition=this._localPosition}get localPositionZ(){return this._localPosition.z}set localPositionZ(e){this._localPosition.z=e,this.localPosition=this._localPosition}get localPosition(){return this._localPosition}set localPosition(t){this._localPosition!==t&&t.cloneTo(this._localPosition),this._setTransformFlag(e.TRANSFORM_LOCALMATRIX,!0),this._onWorldPositionTransform()}get localRotationX(){return this.localRotation.x}set localRotationX(e){this._localRotation.x=e,this.localRotation=this._localRotation}get localRotationY(){return this.localRotation.y}set localRotationY(e){this._localRotation.y=e,this.localRotation=this._localRotation}get localRotationZ(){return this.localRotation.z}set localRotationZ(e){this._localRotation.z=e,this.localRotation=this._localRotation}get localRotationW(){return this.localRotation.w}set localRotationW(e){this._localRotation.w=e,this.localRotation=this._localRotation}get localRotation(){if(this._getTransformFlag(e.TRANSFORM_LOCALQUATERNION)){var t=this._localRotationEuler;_.createFromYawPitchRoll(t.y/e._angleToRandin,t.x/e._angleToRandin,t.z/e._angleToRandin,this._localRotation),this._setTransformFlag(e.TRANSFORM_LOCALQUATERNION,!1)}return this._localRotation}set localRotation(t){this._localRotation!==t&&t.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(e.TRANSFORM_LOCALEULER|e.TRANSFORM_LOCALMATRIX,!0),this._setTransformFlag(e.TRANSFORM_LOCALQUATERNION,!1),this._onWorldRotationTransform()}get localScaleX(){return this._localScale.x}set localScaleX(e){this._localScale.x=e,this.localScale=this._localScale}get localScaleY(){return this._localScale.y}set localScaleY(e){this._localScale.y=e,this.localScale=this._localScale}get localScaleZ(){return this._localScale.z}set localScaleZ(e){this._localScale.z=e,this.localScale=this._localScale}get localScale(){return this._localScale}set localScale(t){this._localScale!==t&&t.cloneTo(this._localScale),this._setTransformFlag(e.TRANSFORM_LOCALMATRIX,!0),this._onWorldScaleTransform()}get localRotationEulerX(){return this.localRotationEuler.x}set localRotationEulerX(e){this._localRotationEuler.x=e,this.localRotationEuler=this._localRotationEuler}get localRotationEulerY(){return this.localRotationEuler.y}set localRotationEulerY(e){this._localRotationEuler.y=e,this.localRotationEuler=this._localRotationEuler}get localRotationEulerZ(){return this.localRotationEuler.z}set localRotationEulerZ(e){this._localRotationEuler.z=e,this.localRotationEuler=this._localRotationEuler}get localRotationEuler(){if(this._getTransformFlag(e.TRANSFORM_LOCALEULER)){this._localRotation.getYawPitchRoll(e._tempVector30);var t=e._tempVector30,r=this._localRotationEuler;r.x=t.y*e._angleToRandin,r.y=t.x*e._angleToRandin,r.z=t.z*e._angleToRandin,this._setTransformFlag(e.TRANSFORM_LOCALEULER,!1)}return this._localRotationEuler}set localRotationEuler(t){this._localRotationEuler!==t&&t.cloneTo(this._localRotationEuler),this._setTransformFlag(e.TRANSFORM_LOCALEULER,!1),this._setTransformFlag(e.TRANSFORM_LOCALQUATERNION|e.TRANSFORM_LOCALMATRIX,!0),this._onWorldRotationTransform()}get localMatrix(){return this._getTransformFlag(e.TRANSFORM_LOCALMATRIX)&&(h.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix),this._setTransformFlag(e.TRANSFORM_LOCALMATRIX,!1)),this._localMatrix}set localMatrix(t){this._localMatrix!==t&&t.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(e.TRANSFORM_LOCALEULER,!0),this._setTransformFlag(e.TRANSFORM_LOCALMATRIX,!1),this._onWorldTransform()}get position(){if(this._getTransformFlag(e.TRANSFORM_WORLDPOSITION)){if(null!=this._parent){var t=this.worldMatrix.elements;this._position.x=t[12],this._position.y=t[13],this._position.z=t[14]}else this._localPosition.cloneTo(this._position);this._setTransformFlag(e.TRANSFORM_WORLDPOSITION,!1)}return this._position}set position(t){if(null!=this._parent){var r=e._tempMatrix0;this._parent.worldMatrix.invert(r),a.transformCoordinate(t,r,this._localPosition)}else t.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==t&&t.cloneTo(this._position),this._setTransformFlag(e.TRANSFORM_WORLDPOSITION,!1)}get rotation(){return this._getTransformFlag(e.TRANSFORM_WORLDQUATERNION)&&(null!=this._parent?_.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(e.TRANSFORM_WORLDQUATERNION,!1)),this._rotation}set rotation(t){null!=this._parent?(this._parent.rotation.invert(e._tempQuaternion0),_.multiply(e._tempQuaternion0,t,this._localRotation)):t.cloneTo(this._localRotation),this.localRotation=this._localRotation,t!==this._rotation&&t.cloneTo(this._rotation),this._setTransformFlag(e.TRANSFORM_WORLDQUATERNION,!1)}get rotationEuler(){if(this._getTransformFlag(e.TRANSFORM_WORLDEULER)){this.rotation.getYawPitchRoll(e._tempVector30);var t=e._tempVector30,r=this._rotationEuler;r.x=t.y*e._angleToRandin,r.y=t.x*e._angleToRandin,r.z=t.z*e._angleToRandin,this._setTransformFlag(e.TRANSFORM_WORLDEULER,!1)}return this._rotationEuler}set rotationEuler(t){_.createFromYawPitchRoll(t.y/e._angleToRandin,t.x/e._angleToRandin,t.z/e._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==t&&t.cloneTo(this._rotationEuler),this._setTransformFlag(e.TRANSFORM_WORLDEULER,!1)}get worldMatrix(){return this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)&&(null!=this._parent?h.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(e.TRANSFORM_WORLDMATRIX,!1)),this._worldMatrix}set worldMatrix(t){null===this._parent?t.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),h.multiply(this._localMatrix,t,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==t&&t.cloneTo(this._worldMatrix),this._setTransformFlag(e.TRANSFORM_WORLDMATRIX,!1)}_getScaleMatrix(){var t=e._tempQuaternion0,r=e._tempMatrix3x30,i=e._tempMatrix3x31,n=e._tempMatrix3x32;return o.createFromMatrix4x4(this.worldMatrix,i),this.rotation.invert(t),o.createRotationQuaternion(t,r),o.multiply(r,i,n),n}_setTransformFlag(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}_getTransformFlag(e){return 0!=(this._transformFlag&e)}_setParent(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,r=t.indexOf(this);t.splice(r,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}_onWorldPositionRotationTransform(){if(!(this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(e.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(e.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(e.TRANSFORM_WORLDEULER))){this._setTransformFlag(e.TRANSFORM_WORLDMATRIX|e.TRANSFORM_WORLDPOSITION|e.TRANSFORM_WORLDQUATERNION|e.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var r=0,i=this._children.length;r<i;r++)this._children[r]._onWorldPositionRotationTransform()}}_onWorldPositionScaleTransform(){if(!this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(e.TRANSFORM_WORLDPOSITION)||!this._getTransformFlag(e.TRANSFORM_WORLDSCALE)){this._setTransformFlag(e.TRANSFORM_WORLDMATRIX|e.TRANSFORM_WORLDPOSITION|e.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var r=0,i=this._children.length;r<i;r++)this._children[r]._onWorldPositionScaleTransform()}}_onWorldPositionTransform(){if(!this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(e.TRANSFORM_WORLDPOSITION)){this._setTransformFlag(e.TRANSFORM_WORLDMATRIX|e.TRANSFORM_WORLDPOSITION,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var r=0,i=this._children.length;r<i;r++)this._children[r]._onWorldPositionTransform()}}_onWorldRotationTransform(){if(!this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(e.TRANSFORM_WORLDQUATERNION)||!this._getTransformFlag(e.TRANSFORM_WORLDEULER)){this._setTransformFlag(e.TRANSFORM_WORLDMATRIX|e.TRANSFORM_WORLDQUATERNION|e.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var r=0,i=this._children.length;r<i;r++)this._children[r]._onWorldPositionRotationTransform()}}_onWorldScaleTransform(){if(!this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(e.TRANSFORM_WORLDSCALE)){this._setTransformFlag(e.TRANSFORM_WORLDMATRIX|e.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var r=0,i=this._children.length;r<i;r++)this._children[r]._onWorldPositionScaleTransform()}}_onWorldTransform(){if(!(this._getTransformFlag(e.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(e.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(e.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(e.TRANSFORM_WORLDEULER)&&this._getTransformFlag(e.TRANSFORM_WORLDSCALE))){this._setTransformFlag(e.TRANSFORM_WORLDMATRIX|e.TRANSFORM_WORLDPOSITION|e.TRANSFORM_WORLDQUATERNION|e.TRANSFORM_WORLDEULER|e.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var r=0,i=this._children.length;r<i;r++)this._children[r]._onWorldTransform()}}translate(t,r=!0){r?(h.createFromQuaternion(this.localRotation,e._tempMatrix0),a.transformCoordinate(t,e._tempMatrix0,e._tempVector30),a.add(this.localPosition,e._tempVector30,this._localPosition),this.localPosition=this._localPosition):(a.add(this.position,t,this._position),this.position=this._position)}rotate(t,r=!0,i=!0){var n;i?n=t:(a.scale(t,Math.PI/180,e._tempVector30),n=e._tempVector30),_.createFromYawPitchRoll(n.y,n.x,n.z,e._tempQuaternion0),r?(_.multiply(this._localRotation,e._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(_.multiply(e._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)}getForward(e){var t=this.worldMatrix.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}getUp(e){var t=this.worldMatrix.elements;e.x=t[4],e.y=t[5],e.z=t[6]}getRight(e){var t=this.worldMatrix.elements;e.x=t[0],e.y=t[1],e.z=t[2]}lookAt(e,t,i=!1){var n;if(i){if(n=this._localPosition,Math.abs(n.x-e.x)<r.zeroTolerance&&Math.abs(n.y-e.y)<r.zeroTolerance&&Math.abs(n.z-e.z)<r.zeroTolerance)return;_.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(n=a,Math.abs(n.x-e.x)<r.zeroTolerance&&Math.abs(n.y-e.y)<r.zeroTolerance&&Math.abs(n.z-e.z)<r.zeroTolerance)return;_.lookAt(a,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}}getWorldLossyScale(){if(this._getTransformFlag(e.TRANSFORM_WORLDSCALE)){if(null!==this._parent){var t=this._getScaleMatrix().elements;this._scale.x=t[0],this._scale.y=t[4],this._scale.z=t[8]}else this._localScale.cloneTo(this._scale);this._setTransformFlag(e.TRANSFORM_WORLDSCALE,!1)}return this._scale}setWorldLossyScale(t){if(null!==this._parent){var r=e._tempMatrix3x33,i=e._tempMatrix3x33,n=i.elements,a=this._parent._getScaleMatrix();a.invert(a),o.createFromScaling(t,r),o.multiply(a,r,i),this._localScale.x=n[0],this._localScale.y=n[4],this._localScale.z=n[8]}else t.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==t&&t.cloneTo(this._scale),this._setTransformFlag(e.TRANSFORM_WORLDSCALE,!1)}get scale(){return console.warn("Transfrm3D: discard function,please use getWorldLossyScale instead."),this.getWorldLossyScale()}set scale(e){console.warn("Transfrm3D: discard function,please use setWorldLossyScale instead."),this.setWorldLossyScale(e)}}return e._tempVector30=new a,e._tempQuaternion0=new _,e._tempMatrix0=new h,e._tempMatrix3x30=new o,e._tempMatrix3x31=new o,e._tempMatrix3x32=new o,e._tempMatrix3x33=new o,e.TRANSFORM_LOCALQUATERNION=1,e.TRANSFORM_LOCALEULER=2,e.TRANSFORM_LOCALMATRIX=4,e.TRANSFORM_WORLDPOSITION=8,e.TRANSFORM_WORLDQUATERNION=16,e.TRANSFORM_WORLDSCALE=32,e.TRANSFORM_WORLDMATRIX=64,e.TRANSFORM_WORLDEULER=128,e._angleToRandin=180/Math.PI,e})(),u=(()=>{class e{constructor(){}static setColliderCollision(e,t,r){}static getIColliderCollision(e,t){return!1}}return e.COLLISIONFILTERGROUP_DEFAULTFILTER=1,e.COLLISIONFILTERGROUP_STATICFILTER=2,e.COLLISIONFILTERGROUP_KINEMATICFILTER=4,e.COLLISIONFILTERGROUP_DEBRISFILTER=8,e.COLLISIONFILTERGROUP_SENSORTRIGGER=16,e.COLLISIONFILTERGROUP_CHARACTERFILTER=32,e.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,e.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,e.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,e.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,e.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,e.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,e.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,e.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,e.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,e.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,e.COLLISIONFILTERGROUP_ALLFILTER=-1,e.gravity=new a(0,-9.81,0),e})();class m extends c{constructor(e=1,t=1,r=1){super(),this._sizeX=e,this._sizeY=t,this._sizeZ=r,this._type=c.SHAPETYPES_BOX;var i=new CANNON.Vec3(e/2,t/2,r/2);this._btShape=new CANNON.Box(i)}static __init__(){m._btSize=new CANNON.Vec3}get sizeX(){return this._sizeX}get sizeY(){return this._sizeY}get sizeZ(){return this._sizeZ}_setScale(e){this._scale.setValue(e.x,e.y,e.z),this._btShape.halfExtents.set(this.sizeX/2*e.x,this.sizeY/2*e.y,this.sizeZ/2*e.z),this._btShape.updateConvexPolyhedronRepresentation(),this._btShape.updateBoundingSphereRadius()}clone(){var e=new m(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(e),e}}class f extends c{constructor(e=.5){super(),this._radius=e,this._type=c.SHAPETYPES_SPHERE,this._btShape=new CANNON.Sphere(e)}get radius(){return this._radius}_setScale(e){var t=Math.max(e.x,e.y,e.z);this._scale.setValue(t,t,t),this._btShape.radius=t*this.radius,this._btShape.updateBoundingSphereRadius()}clone(){var e=new f(this._radius);return this.cloneTo(e),e}}let T=(()=>{class e extends t.Component{constructor(t,r){super(),this._restitution=0,this._friction=.5,this._collisionGroup=u.COLLISIONFILTERGROUP_DEFAULTFILTER,this._canCollideWith=u.COLLISIONFILTERGROUP_ALLFILTER,this._colliderShape=null,this._transformFlag=2147483647,this._controlBySimulation=!1,this._enableProcessCollisions=!0,this._inPhysicUpdateListIndex=-1,this.canScaleShape=!0,this._collisionGroup=t,this._canCollideWith=r,e._physicObjectsMap[this.id]=this}static __init__(){e._btVector30=new CANNON.Vec3(0,0,0),e._btQuaternion0=new CANNON.Quaternion(0,0,0,1)}static _creatShape(e){var t;switch(e.type){case"BoxColliderShape":var r=e.size;t=r?new m(r[0],r[1],r[2]):new m;break;case"SphereColliderShape":t=new f(e.radius);break;default:throw"unknown shape type."}if(e.center){var i=t.localOffset;i.fromArray(e.center),t.localOffset=i}return t}static physicQuaternionMultiply(e,t,r,i,n,a){var s=n.x,o=n.y,l=n.z,_=n.w,h=t*l-r*o,c=r*s-e*l,d=e*o-t*s,u=e*s+t*o+r*l;a.x=e*_+s*i+h,a.y=t*_+o*i+c,a.z=r*_+l*i+d,a.w=i*_-u}get restitution(){return this._restitution}set restitution(e){this._restitution=e,this._btColliderObject&&(this._btColliderObject.material.restitution=e)}get friction(){return this._friction}set friction(e){this._friction=e,this._btColliderObject&&(this._btColliderObject.material.friction=e)}get colliderShape(){return this._colliderShape}set colliderShape(e){var t=this._colliderShape;if(t&&(t._attatched=!1,t._attatchedCollisionObject=null),this._colliderShape=e,e){if(e._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(e._attatched=!0,e._attatchedCollisionObject=this,this._btColliderObject){if(e.type!=c.SHAPETYPES_COMPOUND){this._btColliderObject.shapes.length=0,this._btColliderObject.shapeOffsets.length=0,this._btColliderObject.shapeOrientations.length=0;var r=e.localOffset,i=e._scale,n=new CANNON.Vec3(r.x*i.x,r.y*i.y,r.z*i.z);this._btColliderObject.addShape(this._colliderShape._btShape,n),this._btColliderObject.updateBoundingRadius()}else e.bindRigidBody(this);var a=this._simulation&&this._enabled;a&&t&&this._removeFromSimulation(),this._onShapeChange(e),a&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&t&&this._removeFromSimulation()}get simulation(){return this._simulation}get collisionGroup(){return this._collisionGroup}set collisionGroup(e){this._collisionGroup!==e&&(this._collisionGroup=e,this._btColliderObject.collisionFilterGroup=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}get canCollideWith(){return this._canCollideWith}set canCollideWith(e){this._canCollideWith!==e&&(this._canCollideWith=e,this._btColliderObject.collisionFilterMask=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}_parseShape(t){if(1===t.length){var r=e._creatShape(t[0]);this.colliderShape=r}}_onScaleChange(e){this._colliderShape._setScale(e)}_onEnable(){this._simulation=this.owner._scene._cannonPhysicsSimulation,this._colliderShape&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}_onDisable(){this._colliderShape&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null}_onDestroy(){delete e._physicObjectsMap[this.id],this._btColliderObject=null,this._colliderShape.destroy(),super._onDestroy(),this._btColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}_isValid(){return this._simulation&&this._colliderShape&&this._enabled}_parse(e){null!=e.collisionGroup&&(this.collisionGroup=e.collisionGroup),null!=e.canCollideWith&&(this.canCollideWith=e.canCollideWith)}_setTransformFlag(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}_getTransformFlag(e){return 0!=(this._transformFlag&e)}_addToSimulation(){}_removeFromSimulation(){}_derivePhysicsTransformation(e){var t=this._btColliderObject;this._innerDerivePhysicsTransformation(t,e)}_innerDerivePhysicsTransformation(t,r){var i=this.owner._transform;if(r||this._getTransformFlag(d.TRANSFORM_WORLDPOSITION)){var n=this._colliderShape.localOffset,s=i.position,o=e._btVector30;if(0!==n.x||0!==n.y||0!==n.z){var l=e._tempVector30,_=i.worldMatrix;a.transformCoordinate(n,_,l),o.set(l.x,l.y,l.z)}else o.set(s.x,s.y,s.z);t.position.set(o.x,o.y,o.z),this._setTransformFlag(d.TRANSFORM_WORLDPOSITION,!1)}if(r||this._getTransformFlag(d.TRANSFORM_WORLDQUATERNION)){var h=this._colliderShape.localRotation,c=e._btQuaternion0,u=i.rotation;if(0!==h.x||0!==h.y||0!==h.z||1!==h.w){var m=e._tempQuaternion0;e.physicQuaternionMultiply(u.x,u.y,u.z,u.w,h,m),c.set(m.x,m.y,m.z,m.w)}else c.set(u.x,u.y,u.z,u.w);t.quaternion.set(c.x,c.y,c.z,c.w),this._setTransformFlag(d.TRANSFORM_WORLDQUATERNION,!1)}(r||this._getTransformFlag(d.TRANSFORM_WORLDSCALE))&&(this._onScaleChange(i.getWorldLossyScale()),this._setTransformFlag(d.TRANSFORM_WORLDSCALE,!1))}_updateTransformComponent(t){var r=this._colliderShape,i=r.localOffset,n=r.localRotation,s=this.owner._transform,o=s.position,l=s.rotation,_=t.position,h=t.quaternion,c=h.x,d=h.y,u=h.z,m=h.w;if(0!==n.x||0!==n.y||0!==n.z||1!==n.w){var f=e._tempQuaternion0;n.invert(f),e.physicQuaternionMultiply(c,d,u,m,f,l)}else l.x=c,l.y=d,l.z=u,l.w=m;if(s.rotation=l,0!==i.x||0!==i.y||0!==i.z){var T=e._tempVector30;T.x=i.x,T.y=i.y,T.z=i.z,a.transformQuat(T,l,T),o.x=_.x-T.x,o.y=_.y-T.z,o.z=_.z-T.y}else o.x=_.x,o.y=_.y,o.z=_.z;s.position=o}_onShapeChange(e){}_onAdded(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}_onTransformChanged(t){!e._addUpdateList&&this._controlBySimulation||(t&=d.TRANSFORM_WORLDPOSITION|d.TRANSFORM_WORLDQUATERNION|d.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=t,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}_cloneTo(e){var t=e;t.restitution=this._restitution,t.friction=this._friction,t.collisionGroup=this._collisionGroup,t.canCollideWith=this._canCollideWith,t.canScaleShape=this.canScaleShape,this._colliderShape&&(t.colliderShape=this._colliderShape.clone())}}return e.ACTIVATIONSTATE_ACTIVE_TAG=1,e.ACTIVATIONSTATE_ISLAND_SLEEPING=2,e.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,e.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,e.ACTIVATIONSTATE_DISABLE_SIMULATION=5,e.COLLISIONFLAGS_STATIC_OBJECT=1,e.COLLISIONFLAGS_KINEMATIC_OBJECT=2,e.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,e.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,e.COLLISIONFLAGS_CHARACTER_OBJECT=16,e.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,e.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,e._tempVector30=new a,e._tempQuaternion0=new _,e._tempQuaternion1=new _,e._tempMatrix4x40=new h,e._physicObjectsMap={},e._addUpdateList=!0,e})();class E{constructor(){this.elements=[],this.length=0}_add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++}}class p extends E{constructor(){super()}add(e){if(-1!==e._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(e),e._inPhysicUpdateListIndex=this.length++}remove(e){var t=e._inPhysicUpdateListIndex;if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._inPhysicUpdateListIndex=t}e._inPhysicUpdateListIndex=-1}}class g{constructor(){this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new a,this.positionOnA=new a,this.positionOnB=new a,this._id=++this._idCounter}}class S{constructor(){this.succeeded=!1,this.collider=null,this.point=new a,this.normal=new a,this.hitFraction=0}}class R{constructor(){this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}_setUpdateFrame(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}}class v{constructor(){this._hitResultsPoolIndex=0,this._hitResultsPool=[],this._contactPonintsPoolIndex=0,this._contactPointsPool=[],this._collisionsPool=[],this._collisions={}}getHitResult(){var e=this._hitResultsPool[this._hitResultsPoolIndex++];return e||(e=new S,this._hitResultsPool.push(e)),e}recoverAllHitResultsPool(){this._hitResultsPoolIndex=0}getContactPoints(){var e=this._contactPointsPool[this._contactPonintsPoolIndex++];return e||(e=new g,this._contactPointsPool.push(e)),e}recoverAllContactPointsPool(){this._contactPonintsPoolIndex=0}getCollision(e,t){var r,i=e.id,n=t.id,a=this._collisions[i];return a&&(r=a[n]),r||(a||(a={},this._collisions[i]=a),(r=0===this._collisionsPool.length?new R:this._collisionsPool.pop())._colliderA=e,r._colliderB=t,a[n]=r),r}recoverCollision(e){var t=e._colliderA.id,r=e._colliderB.id;this._collisions[t][r]=null,this._collisionsPool.push(e)}garbageCollection(){for(var e in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var t=this._collisionsPool[e],r=!0;for(var i in t)t[i]?r=!1:delete t[i];r&&delete this._collisionsPool[e]}}}let A=(()=>{class e{constructor(e,t=0){this._gravity=new a(0,-10,0),this._btClosestRayResultCallback=new CANNON.RaycastResult,this._btRayoption={},this._collisionsUtils=new v,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._physicsUpdateList=new p,this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.maxSubSteps=e.maxSubSteps,this.fixedTimeStep=e.fixedTimeStep,this._btDiscreteDynamicsWorld=new CANNON.World,this._btBroadphase=new CANNON.NaiveBroadphase,this._btDiscreteDynamicsWorld.broadphase=this._btBroadphase,this._btDiscreteDynamicsWorld.defaultContactMaterial.contactEquationRelaxation=e.contactEquationRelaxation,this._btDiscreteDynamicsWorld.defaultContactMaterial.contactEquationStiffness=e.contactEquationStiffness,this.gravity=this._gravity}static __init__(){e._btTempVector30=new CANNON.Vec3(0,0,0),e._btTempVector31=new CANNON.Vec3(0,0,0)}static createConstraint(){}get continuousCollisionDetection(){return!1}set continuousCollisionDetection(e){throw"Simulation:Cannon physical engine does not support this feature"}get gravity(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity}set gravity(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=e,this._btDiscreteDynamicsWorld.gravity.set(e.x,e.y,e.z)}get solverIterations(){if(!this._btDiscreteDynamicsWorld||!this._btDiscreteDynamicsWorld.solver)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._iterations}set solverIterations(e){if(!this._btDiscreteDynamicsWorld||!this._btDiscreteDynamicsWorld.solver)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._btDiscreteDynamicsWorld.solver.iterations=e,this._iterations=e}get speculativeContactRestitution(){return!1}set speculativeContactRestitution(e){}_simulate(e){this._updatedRigidbodies=0,this._btDiscreteDynamicsWorld&&this._btDiscreteDynamicsWorld.step(this.fixedTimeStep,e,this.maxSubSteps);for(var t=this._btDiscreteDynamicsWorld.callBackBody,r=0,i=t.length;r<i;r++){var n=t[r],a=T._physicObjectsMap[n.layaID];a._simulation._updatedRigidbodies++,a._updateTransformComponent(a._btColliderObject)}}_destroy(){this._btDiscreteDynamicsWorld=null,this._btBroadphase=null}_addPhysicsCollider(e){this._btDiscreteDynamicsWorld.addBody(e._btColliderObject)}_removePhysicsCollider(e){this._btDiscreteDynamicsWorld.removeBody(e._btColliderObject)}_addRigidBody(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._btDiscreteDynamicsWorld.addBody(e._btColliderObject)}_removeRigidBody(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._btDiscreteDynamicsWorld.removeBody(e._btColliderObject)}raycastFromTo(t,r,i=null,n=u.COLLISIONFILTERGROUP_ALLFILTER,a=u.COLLISIONFILTERGROUP_ALLFILTER){var s=this._btClosestRayResultCallback;s.hasHit=!1;var o=this._btRayoption,l=e._btTempVector30,_=e._btTempVector31;if(l.set(t.x,t.y,t.z),_.set(r.x,r.y,r.z),o.skipBackfaces=!0,o.collisionFilterMask=a,o.collisionFilterGroup=n,o.result=s,this._btDiscreteDynamicsWorld.raycastClosest(l,_,o,s),s.hasHit){if(i){i.succeeded=!0,i.collider=T._physicObjectsMap[s.body.layaID];var h=i.point,c=i.normal,d=s.hitPointWorld,m=s.hitNormalWorld;h.setValue(d.x,d.y,d.z),c.setValue(m.x,m.y,m.z)}return!0}return i.succeeded=!1,!1}raycastAllFromTo(t,r,i,n=u.COLLISIONFILTERGROUP_ALLFILTER,a=u.COLLISIONFILTERGROUP_ALLFILTER){var s=this._btRayoption,o=e._btTempVector30,l=e._btTempVector31;return o.set(t.x,t.y,t.z),l.set(r.x,r.y,r.z),s.skipBackfaces=!0,s.collisionFilterMask=a,s.collisionFilterGroup=n,i.length=0,this._btDiscreteDynamicsWorld.raycastAll(o,l,s,(function(e){var t=this._collisionsUtils.getHitResult();i.push(t),t.succeeded=!0,t.collider=T._physicObjectsMap[e.body.layaID];var r=t.point,n=t.normal,a=e.hitPointWorld,s=e.hitNormalWorld;r.setValue(a.x,a.y,a.z),n.setValue(s.x,s.y,s.z)})),0!=i.length}rayCast(t,r=null,i=2147483647,n=u.COLLISIONFILTERGROUP_ALLFILTER,s=u.COLLISIONFILTERGROUP_ALLFILTER){var o=t.origin,l=e._tempVector30;return a.normalize(t.direction,l),a.scale(l,i,l),a.add(o,l,l),this.raycastFromTo(o,l,r,n,s)}rayCastAll(t,r,i=2147483647,n=u.COLLISIONFILTERGROUP_ALLFILTER,s=u.COLLISIONFILTERGROUP_ALLFILTER){var o=t.origin,l=e._tempVector30;return a.normalize(t.direction,l),a.scale(l,i,l),a.add(o,l,l),this.raycastAllFromTo(o,l,r,n,s)}_updatePhysicsTransformFromRender(){for(var e=this._physicsUpdateList.elements,t=0,r=this._physicsUpdateList.length;t<r;t++){var i=e[t];i._derivePhysicsTransformation(!1),i._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0}_updateCollisions(){this._collisionsUtils.recoverAllContactPointsPool();var e=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=e;for(var r=t.Stat.loopCount,i=this._btDiscreteDynamicsWorld.allContacts,n=i.length,a=0;a<n;a++){var s,o=i[a],l=T._physicObjectsMap[o.bi.layaID],_=T._physicObjectsMap[o.bj.layaID],h=null,c=null;if((l.isTrigger||_.isTrigger)&&(l.owner._needProcessTriggers||_.owner._needProcessTriggers))c=(h=this._collisionsUtils.getCollision(l,_)).contacts,(s=h._updateFrame!==r)&&(h._isTrigger=!0,c.length=0);else if((l.owner._needProcessCollisions||_.owner._needProcessCollisions)&&(l._enableProcessCollisions||_._enableProcessCollisions)){var d=this._collisionsUtils.getContactPoints();d.colliderA=l,d.colliderB=_;var u=d.normal,m=d.positionOnA,f=d.positionOnB,E=o.ni,p=o.ri,g=o.rj;u.setValue(E.x,E.y,E.z),m.setValue(p.x,p.y,p.z),f.setValue(g.x,g.y,-g.z),c=(h=this._collisionsUtils.getCollision(l,_)).contacts,(s=h._updateFrame!==r)&&(h._isTrigger=!1,c.length=0),c.push(d)}h&&s&&(this._currentFrameCollisions.push(h),h._setUpdateFrame(r))}}_eventScripts(){for(var e=t.Stat.loopCount,r=0,i=this._currentFrameCollisions.length;r<i;r++){var n=this._currentFrameCollisions[r],a=n._colliderA,s=n._colliderB;if(!a.destroyed&&!s.destroyed)if(e-n._lastUpdateFrame==1){var o=a.owner,l=o._scripts;if(l)if(n._isTrigger){if(o._needProcessTriggers)for(var _=0,h=l.length;_<h;_++)l[_].onTriggerStay(s)}else if(o._needProcessCollisions)for(_=0,h=l.length;_<h;_++)n.other=s,l[_].onCollisionStay(n);var c=s.owner,d=c._scripts;if(d)if(n._isTrigger){if(c._needProcessTriggers)for(_=0,h=d.length;_<h;_++)d[_].onTriggerStay(a)}else if(c._needProcessCollisions)for(_=0,h=d.length;_<h;_++)n.other=a,d[_].onCollisionStay(n)}else{if(l=(o=a.owner)._scripts)if(n._isTrigger){if(o._needProcessTriggers)for(_=0,h=l.length;_<h;_++)l[_].onTriggerEnter(s)}else if(o._needProcessCollisions)for(_=0,h=l.length;_<h;_++)n.other=s,l[_].onCollisionEnter(n);if(d=(c=s.owner)._scripts)if(n._isTrigger){if(c._needProcessTriggers)for(_=0,h=d.length;_<h;_++)d[_].onTriggerEnter(a)}else if(c._needProcessCollisions)for(_=0,h=d.length;_<h;_++)n.other=a,d[_].onCollisionEnter(n)}}for(r=0,i=this._previousFrameCollisions.length;r<i;r++){var u=this._previousFrameCollisions[r],m=u._colliderA,f=u._colliderB;if(!m.destroyed&&!f.destroyed&&e-u._updateFrame==1){if(this._collisionsUtils.recoverCollision(u),l=(o=m.owner)._scripts)if(u._isTrigger){if(o._needProcessTriggers)for(_=0,h=l.length;_<h;_++)l[_].onTriggerExit(f)}else if(o._needProcessCollisions)for(_=0,h=l.length;_<h;_++)u.other=f,l[_].onCollisionExit(u);if(d=(c=f.owner)._scripts)if(u._isTrigger){if(c._needProcessTriggers)for(_=0,h=d.length;_<h;_++)d[_].onTriggerExit(m)}else if(c._needProcessCollisions)for(_=0,h=d.length;_<h;_++)u.other=m,d[_].onCollisionExit(u)}}}clearForces(){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly"}}return e.PHYSICSENGINEFLAGS_NONE=0,e.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,e.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,e.PHYSICSENGINEFLAGS_MULTITHREADED=4,e.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,e.SOLVERMODE_RANDMIZE_ORDER=1,e.SOLVERMODE_FRICTION_SEPARATE=2,e.SOLVERMODE_USE_WARMSTARTING=4,e.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,e.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,e.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,e.SOLVERMODE_CACHE_FRIENDLY=128,e.SOLVERMODE_SIMD=256,e.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,e.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,e._tempVector30=new a,e.disableSimulation=!1,e})();class I extends T{constructor(e,t){super(e,t),this._isTrigger=!1}get isTrigger(){return this._isTrigger}set isTrigger(e){if(this._isTrigger=e,this._btColliderObject)if(this._btColliderObject.isTrigger=e,e){var t=this._btColliderObject.type;this._btColliderObject.collisionResponse=!1,0==(t&CANNON.Body.STATIC)&&(this._btColliderObject.type|=CANNON.Body.STATIC)}else this._btColliderObject.collisionResponse=!0,0!=(t&CANNON.Body.STATIC)&&(this._btColliderObject.type^=CANNON.Body.STATIC)}_onAdded(){super._onAdded(),this.isTrigger=this._isTrigger}_cloneTo(e){super._cloneTo(e),e.isTrigger=this._isTrigger}}class x extends I{constructor(e=-1,t=-1){super(e,t),this._enableProcessCollisions=!1}_addToSimulation(){this._simulation._addPhysicsCollider(this)}_removeFromSimulation(){this._simulation._removePhysicsCollider(this)}_parse(e){null!=e.friction&&(this.friction=e.friction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),super._parse(e),this._parseShape(e.shapes)}_onAdded(){this._btColliderObject=new CANNON.Body,this._btColliderObject.material=new CANNON.Material,this._btColliderObject.layaID=this._id,this._btColliderObject.type=CANNON.Body.STATIC,this._btColliderObject.collisionFilterGroup=this._collisionGroup,this._btColliderObject.collisionFilterMask=this._canCollideWith,super._onAdded()}}let C=(()=>{class e extends x{constructor(e=-1,t=u.COLLISIONFILTERGROUP_ALLFILTER){super(e,t),this._isKinematic=!1,this._mass=1,this._gravity=new a(0,-10,0),this._angularDamping=0,this._linearDamping=0,this._totalTorque=new a(0,0,0),this._totalForce=new a(0,0,0),this._linearVelocity=new a,this._angularVelocity=new a,this._controlBySimulation=!0}static __init__(){e._btTempVector30=new CANNON.Vec3,e._btTempVector31=new CANNON.Vec3}get mass(){return this._mass}set mass(e){e=Math.max(e,1e-7),this._mass=e,this._isKinematic||this._updateMass(e)}get isKinematic(){return this._isKinematic}set isKinematic(e){this._isKinematic=e,this._controlBySimulation=!e;var t=!!(this._simulation&&this._enabled&&this._colliderShape);t&&this._removeFromSimulation();var r=this._btColliderObject,i=r.type;e?(i|=CANNON.Body.KINEMATIC,r.type=i,this._enableProcessCollisions=!1,this._updateMass(0)):((i&CANNON.Body.KINEMATIC)>0&&(i^=CANNON.Body.KINEMATIC),r.allowSleep=!0,r.type=i,this._enableProcessCollisions=!0,this._updateMass(this._mass)),r.velocity.set(0,0,0),r.angularVelocity.set(0,0,0),t&&this._addToSimulation()}get linearDamping(){return this._linearDamping}set linearDamping(e){this._linearDamping=e,this._btColliderObject&&(this._btColliderObject.linearDamping=e)}get angularDamping(){return this._angularDamping}set angularDamping(e){this._angularDamping=e,this._btColliderObject&&(this._btColliderObject.angularDamping=e)}get totalForce(){if(this._btColliderObject){var e=this.btColliderObject.force;return this.totalForce.setValue(e.x,e.y,e.z),this._totalForce}return null}get linearVelocity(){if(this._btColliderObject){var e=this.btColliderObject.velocity;this._linearVelocity.setValue(e.x,e.y,e.z)}return this._linearVelocity}set linearVelocity(e){if(this._linearVelocity=e,this._btColliderObject){var t=this.btColliderObject.velocity;this.isSleeping&&this.wakeUp(),t.set(e.x,e.y,e.z),this.btColliderObject.velocity=t}}get angularVelocity(){if(this._btColliderObject){var e=this._btColliderObject.angularVelocity;this.angularVelocity.setValue(e.x,e.y,e.z)}return this._angularVelocity}set angularVelocity(e){if(this._angularVelocity=e,this._btColliderObject){var t=this.btColliderObject.angularVelocity;this.isSleeping&&this.wakeUp(),t.set(e.x,e.y,e.z),this.btColliderObject.velocity=t}}get totalTorque(){if(this._btColliderObject){var e=this._btColliderObject.torque;return this._totalTorque.setValue(e.x,e.y,e.z),this._totalTorque}return null}get isSleeping(){return!!this._btColliderObject&&this._btColliderObject.sleepState!=CANNON.Body.AWAKE}get sleepLinearVelocity(){return this._btColliderObject.sleepSpeedLimit}set sleepLinearVelocity(e){this._btColliderObject.sleepSpeedLimit=e}get btColliderObject(){return this._btColliderObject}_updateMass(e){this._btColliderObject&&this._colliderShape&&(this._btColliderObject.mass=e,this._btColliderObject.updateMassProperties(),this._btColliderObject.updateSolveMassProperties())}_onScaleChange(e){super._onScaleChange(e),this._updateMass(this._isKinematic?0:this._mass)}_derivePhysicsTransformation(e){this._innerDerivePhysicsTransformation(this.btColliderObject,e)}_onAdded(){var e=new CANNON.Body;e.material=new CANNON.Material,e.layaID=this.id,e.collisionFilterGroup=this.collisionGroup,e.collisionFilterMask=this._canCollideWith,this._btColliderObject=e,super._onAdded(),this.mass=this._mass,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.isKinematic=this._isKinematic,this.isKinematic?this._btColliderObject.type=CANNON.Body.KINEMATIC:this._btColliderObject.type=CANNON.Body.DYNAMIC}_onShapeChange(e){super._onShapeChange(e),this._isKinematic?this._updateMass(0):this._updateMass(this._mass)}_parse(e){null!=e.friction&&(this.friction=e.friction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),null!=e.mass&&(this.mass=e.mass),null!=e.isKinematic&&(this.isKinematic=e.isKinematic),null!=e.linearDamping&&(this.linearDamping=e.linearDamping),null!=e.angularDamping&&(this.angularDamping=e.angularDamping),super._parse(e),this._parseShape(e.shapes)}_onDestroy(){super._onDestroy(),this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null}_addToSimulation(){this._simulation._addRigidBody(this)}_removeFromSimulation(){this._simulation._removeRigidBody(this)}_cloneTo(e){super._cloneTo(e);var t=e;t.isKinematic=this._isKinematic,t.mass=this._mass,t.angularDamping=this._angularDamping,t.linearDamping=this._linearDamping,t.linearVelocity=this._linearVelocity,t.angularVelocity=this._angularVelocity}applyForce(t,r=null){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var i=e._btTempVector30;i.set(t.x,t.y,t.z);var n=e._btTempVector31;r?n.set(r.x,r.y,r.z):n.set(0,0,0),this.btColliderObject.applyLocalForce(i,n)}applyTorque(t){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=e._btTempVector30;r.set(t.x,t.y,t.z);var i=this.btColliderObject.torque;i.set(i.x+r.x,i.y+r.y,i.z+r.z),this.btColliderObject.torque=i}applyImpulse(t,r=null){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var i=e._btTempVector30;i.set(t.x,t.y,t.z);var n=e._btTempVector31;r?n.set(r.x,r.y,r.z):n.set(0,0,0),this.btColliderObject.applyImpulse(i,n)}wakeUp(){this._btColliderObject&&this._btColliderObject.wakeUp()}clearForces(){var e=this._btColliderObject;if(null==e)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";e.velocity.set(0,0,0),e.velocity=e.velocity,e.angularVelocity.set(0,0,0),e.angularVelocity=e.angularVelocity}}return e.TYPE_STATIC=0,e.TYPE_DYNAMIC=1,e.TYPE_KINEMATIC=2,e._BT_DISABLE_WORLD_GRAVITY=1,e._BT_ENABLE_GYROPSCOPIC_FORCE=2,e})(),L=(()=>{class e{constructor(){this._scale=new a(1,1,1),this._centerMatrix=new h,this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this._localOffset=new a(0,0,0),this._localRotation=new _(0,0,0,1),this.needsCustomCollisionCallback=!1}static __init__(){var t=l.Physics3D._bullet;e._btScale=t.btVector3_create(1,1,1),e._btVector30=t.btVector3_create(0,0,0),e._btQuaternion0=t.btQuaternion_create(0,0,0,1),e._btTransform0=t.btTransform_create()}static _createAffineTransformation(e,t,r){var i=t.x,n=t.y,a=t.z,s=t.w,o=i+i,l=n+n,_=a+a,h=i*o,c=i*l,d=i*_,u=n*l,m=n*_,f=a*_,T=s*o,E=s*l,p=s*_;r[0]=1-(u+f),r[1]=c+p,r[2]=d-E,r[3]=0,r[4]=c-p,r[5]=1-(h+f),r[6]=m+T,r[7]=0,r[8]=d+E,r[9]=m-T,r[10]=1-(h+u),r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1}get type(){return this._type}get localOffset(){return this._localOffset}set localOffset(e){this._localOffset=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}get localRotation(){return this._localRotation}set localRotation(e){this._localRotation=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}_setScale(t){if(this._compoundParent)this.updateLocalTransformations();else{var r=l.Physics3D._bullet;r.btVector3_setValue(e._btScale,t.x,t.y,t.z),r.btCollisionShape_setLocalScaling(this._btShape,e._btScale)}}_addReference(){this._referenceCount++}_removeReference(){this._referenceCount--}updateLocalTransformations(){if(this._compoundParent){var t=e._tempVector30;a.multiply(this.localOffset,this._scale,t),e._createAffineTransformation(t,this.localRotation,this._centerMatrix.elements)}else e._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements)}cloneTo(e){var t=e;this._localOffset.cloneTo(t.localOffset),this._localRotation.cloneTo(t.localRotation),t.localOffset=t.localOffset,t.localRotation=t.localRotation}clone(){return null}destroy(){this._btShape&&(l.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}}return e.SHAPEORIENTATION_UPX=0,e.SHAPEORIENTATION_UPY=1,e.SHAPEORIENTATION_UPZ=2,e.SHAPETYPES_BOX=0,e.SHAPETYPES_SPHERE=1,e.SHAPETYPES_CYLINDER=2,e.SHAPETYPES_CAPSULE=3,e.SHAPETYPES_CONVEXHULL=4,e.SHAPETYPES_COMPOUND=5,e.SHAPETYPES_STATICPLANE=6,e.SHAPETYPES_CONE=7,e._tempVector30=new a,e})();class y extends L{constructor(e,t){super(),this._normal=e,this._offset=t,this._type=L.SHAPETYPES_STATICPLANE;var r=l.Physics3D._bullet;r.btVector3_setValue(y._btNormal,-e.x,e.y,e.z),this._btShape=r.btStaticPlaneShape_create(y._btNormal,t)}static __init__(){y._btNormal=l.Physics3D._bullet.btVector3_create(0,0,0)}clone(){var e=new y(this._normal,this._offset);return this.cloneTo(e),e}}class D extends L{constructor(){super(),this._childColliderShapes=[],this._type=L.SHAPETYPES_COMPOUND,this._btShape=l.Physics3D._bullet.btCompoundShape_create()}static __init__(){var e=l.Physics3D._bullet;D._btVector3One=e.btVector3_create(1,1,1),D._btTransform=e.btTransform_create(),D._btOffset=e.btVector3_create(0,0,0),D._btRotation=e.btQuaternion_create(0,0,0,1)}_clearChildShape(e){e._attatched=!1,e._compoundParent=null,e._indexInCompound=-1}_addReference(){}_removeReference(){}_updateChildTransform(e){var t=l.Physics3D._bullet,r=e.localOffset,i=e.localRotation,n=L._btVector30,a=L._btQuaternion0,s=L._btTransform0;t.btVector3_setValue(n,-r.x,r.y,r.z),t.btQuaternion_setValue(a,-i.x,i.y,i.z,-i.w),t.btTransform_setOrigin(s,n),t.btTransform_setRotation(s,a),t.btCompoundShape_updateChildTransform(this._btShape,e._indexInCompound,s,!0)}addChildShape(e){if(e._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";e._attatched=!0,e._compoundParent=this,e._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(e);var t=e.localOffset,r=e.localRotation,i=l.Physics3D._bullet;i.btVector3_setValue(D._btOffset,-t.x,t.y,t.z),i.btQuaternion_setValue(D._btRotation,-r.x,r.y,r.z,-r.w),i.btTransform_setOrigin(D._btTransform,D._btOffset),i.btTransform_setRotation(D._btTransform,D._btRotation);var n=i.btCollisionShape_getLocalScaling(this._btShape);i.btCollisionShape_setLocalScaling(this._btShape,D._btVector3One),i.btCompoundShape_addChildShape(this._btShape,D._btTransform,e._btShape),i.btCollisionShape_setLocalScaling(this._btShape,n),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this)}removeChildShape(e){if(e._compoundParent===this){var t=e._indexInCompound;this._clearChildShape(e);var r=this._childColliderShapes[this._childColliderShapes.length-1];r._indexInCompound=t,this._childColliderShapes[t]=r,this._childColliderShapes.pop(),l.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,t)}}clearChildShape(){for(var e=0,t=this._childColliderShapes.length;e<t;e++)this._clearChildShape(this._childColliderShapes[e]),l.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,0);this._childColliderShapes.length=0}getChildShapeCount(){return this._childColliderShapes.length}cloneTo(e){var t=e;t.clearChildShape();for(var r=0,i=this._childColliderShapes.length;r<i;r++)t.addChildShape(this._childColliderShapes[r].clone())}clone(){var e=new D;return this.cloneTo(e),e}destroy(){super.destroy();for(var e=0,t=this._childColliderShapes.length;e<t;e++){var r=this._childColliderShapes[e];0===r._referenceCount&&r.destroy()}}}class M extends L{constructor(e=1,t=1,r=1){super(),this._sizeX=e,this._sizeY=t,this._sizeZ=r,this._type=L.SHAPETYPES_BOX;var i=l.Physics3D._bullet;i.btVector3_setValue(M._btSize,e/2,t/2,r/2),this._btShape=i.btBoxShape_create(M._btSize)}static __init__(){M._btSize=l.Physics3D._bullet.btVector3_create(0,0,0)}get sizeX(){return this._sizeX}get sizeY(){return this._sizeY}get sizeZ(){return this._sizeZ}clone(){var e=new M(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(e),e}}let O=(()=>{class e extends L{constructor(e=.5,t=1.25,r=L.SHAPEORIENTATION_UPY){super(),this._radius=e,this._length=t,this._orientation=r,this._type=L.SHAPETYPES_CAPSULE;var i=l.Physics3D._bullet;switch(r){case L.SHAPEORIENTATION_UPX:this._btShape=i.btCapsuleShapeX_create(e,t-2*e);break;case L.SHAPEORIENTATION_UPY:this._btShape=i.btCapsuleShape_create(e,t-2*e);break;case L.SHAPEORIENTATION_UPZ:this._btShape=i.btCapsuleShapeZ_create(e,t-2*e);break;default:throw"CapsuleColliderShape:unknown orientation."}}get radius(){return this._radius}get length(){return this._length}get orientation(){return this._orientation}_setScale(t){var r=e._tempVector30;switch(this.orientation){case L.SHAPEORIENTATION_UPX:r.x=t.x,r.y=r.z=Math.max(t.y,t.z);break;case L.SHAPEORIENTATION_UPY:r.y=t.y,r.x=r.z=Math.max(t.x,t.z);break;case L.SHAPEORIENTATION_UPZ:r.z=t.z,r.x=r.y=Math.max(t.x,t.y);break;default:throw"CapsuleColliderShape:unknown orientation."}super._setScale(r)}clone(){var t=new e(this._radius,this._length,this._orientation);return this.cloneTo(t),t}}return e._tempVector30=new a,e})();class N extends L{constructor(e=.5,t=1,r=L.SHAPEORIENTATION_UPY){super(),this._radius=1,this._height=.5,this._radius=e,this._height=t,this._orientation=r,this._type=L.SHAPETYPES_CYLINDER;var i=l.Physics3D._bullet;switch(r){case L.SHAPEORIENTATION_UPX:this._btShape=i.btConeShapeX_create(e,t);break;case L.SHAPEORIENTATION_UPY:this._btShape=i.btConeShape_create(e,t);break;case L.SHAPEORIENTATION_UPZ:this._btShape=i.btConeShapeZ_create(e,t);break;default:throw"ConeColliderShape:unknown orientation."}}get radius(){return this._radius}get height(){return this._height}get orientation(){return this._orientation}clone(){var e=new N(this._radius,this._height,this._orientation);return this.cloneTo(e),e}}class b extends L{constructor(e=.5,t=1,r=L.SHAPEORIENTATION_UPY){super(),this._radius=1,this._height=.5,this._radius=e,this._height=t,this._orientation=r,this._type=L.SHAPETYPES_CYLINDER;var i=l.Physics3D._bullet;switch(r){case L.SHAPEORIENTATION_UPX:i.btVector3_setValue(b._btSize,t/2,e,e),this._btShape=i.btCylinderShapeX_create(b._btSize);break;case L.SHAPEORIENTATION_UPY:i.btVector3_setValue(b._btSize,e,t/2,e),this._btShape=i.btCylinderShape_create(b._btSize);break;case L.SHAPEORIENTATION_UPZ:i.btVector3_setValue(b._btSize,e,e,t/2),this._btShape=i.btCylinderShapeZ_create(b._btSize);break;default:throw"CapsuleColliderShape:unknown orientation."}}static __init__(){b._btSize=l.Physics3D._bullet.btVector3_create(0,0,0)}get radius(){return this._radius}get height(){return this._height}get orientation(){return this._orientation}clone(){var e=new b(this._radius,this._height,this._orientation);return this.cloneTo(e),e}}class P extends L{constructor(){super(),this._mesh=null,this._convex=!1}get mesh(){return this._mesh}set mesh(e){if(this._mesh!==e){var t=l.Physics3D._bullet;this._mesh&&t.btCollisionShape_destroy(this._btShape),e&&(this._btShape=t.btGImpactMeshShape_create(e._getPhysicMesh()),t.btGImpactShapeInterface_updateBound(this._btShape)),this._mesh=e}}get convex(){return this._convex}set convex(e){this._convex=e}_setScale(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=l.Physics3D._bullet;t.btVector3_setValue(L._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,L._btScale),t.btGImpactShapeInterface_updateBound(this._btShape)}}cloneTo(e){var t=e;t.convex=this._convex,t.mesh=this._mesh,super.cloneTo(e)}clone(){var e=new P;return this.cloneTo(e),e}destroy(){this._btShape&&(l.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}}class w extends L{constructor(e=.5){super(),this._radius=e,this._type=L.SHAPETYPES_SPHERE,this._btShape=l.Physics3D._bullet.btSphereShape_create(e)}get radius(){return this._radius}clone(){var e=new w(this._radius);return this.cloneTo(e),e}}let V=(()=>{class e extends t.Component{constructor(t,r){super(),this._restitution=0,this._friction=.5,this._rollingFriction=0,this._ccdMotionThreshold=0,this._ccdSweptSphereRadius=0,this._collisionGroup=u.COLLISIONFILTERGROUP_DEFAULTFILTER,this._canCollideWith=u.COLLISIONFILTERGROUP_ALLFILTER,this._colliderShape=null,this._transformFlag=2147483647,this._controlBySimulation=!1,this._enableProcessCollisions=!0,this._inPhysicUpdateListIndex=-1,this.canScaleShape=!0,this._collisionGroup=t,this._canCollideWith=r,e._physicObjectsMap[this.id]=this}static __init__(){var t=l.Physics3D._bullet;e._btVector30=t.btVector3_create(0,0,0),e._btQuaternion0=t.btQuaternion_create(0,0,0,1)}static _createAffineTransformationArray(e,t,r,i,n,a,s,o,l){var _=i+i,h=n+n,c=a+a,d=i*_,u=i*h,m=i*c,f=n*h,T=n*c,E=a*c,p=s*_,g=s*h,S=s*c,R=o[0],v=o[1],A=o[2];l[0]=(1-(f+E))*R,l[1]=(u+S)*R,l[2]=(m-g)*R,l[3]=0,l[4]=(u-S)*v,l[5]=(1-(d+E))*v,l[6]=(T+p)*v,l[7]=0,l[8]=(m+g)*A,l[9]=(T-p)*A,l[10]=(1-(d+f))*A,l[11]=0,l[12]=e,l[13]=t,l[14]=r,l[15]=1}static _creatShape(e){var r;switch(e.type){case"BoxColliderShape":var i=e.size;r=i?new M(i[0],i[1],i[2]):new M;break;case"SphereColliderShape":r=new w(e.radius);break;case"CapsuleColliderShape":r=new O(e.radius,e.height,e.orientation);break;case"MeshColliderShape":var n=new P;e.mesh&&(n.mesh=t.Loader.getRes(e.mesh)),r=n;break;case"ConeColliderShape":r=new N(e.radius,e.height,e.orientation);break;case"CylinderColliderShape":r=new b(e.radius,e.height,e.orientation);break;default:throw"unknown shape type."}if(e.center){var a=r.localOffset;a.fromArray(e.center),r.localOffset=a}return r}static physicVector3TransformQuat(e,t,r,i,n,a){var s=e.x,o=e.y,l=e.z,_=n*s+r*l-i*o,h=n*o+i*s-t*l,c=n*l+t*o-r*s,d=-t*s-r*o-i*l;a.x=_*n+d*-t+h*-i-c*-r,a.y=h*n+d*-r+c*-t-_*-i,a.z=c*n+d*-i+_*-r-h*-t}static physicQuaternionMultiply(e,t,r,i,n,a){var s=n.x,o=n.y,l=n.z,_=n.w,h=t*l-r*o,c=r*s-e*l,d=e*o-t*s,u=e*s+t*o+r*l;a.x=e*_+s*i+h,a.y=t*_+o*i+c,a.z=r*_+l*i+d,a.w=i*_-u}get restitution(){return this._restitution}set restitution(e){this._restitution=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setRestitution(this._btColliderObject,e)}get friction(){return this._friction}set friction(e){this._friction=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setFriction(this._btColliderObject,e)}get rollingFriction(){return this._rollingFriction}set rollingFriction(e){this._rollingFriction=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setRollingFriction(this._btColliderObject,e)}get ccdMotionThreshold(){return this._ccdMotionThreshold}set ccdMotionThreshold(e){this._ccdMotionThreshold=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setCcdMotionThreshold(this._btColliderObject,e)}get ccdSweptSphereRadius(){return this._ccdSweptSphereRadius}set ccdSweptSphereRadius(e){this._ccdSweptSphereRadius=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setCcdSweptSphereRadius(this._btColliderObject,e)}get isActive(){return!!this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_isActive(this._btColliderObject)}get colliderShape(){return this._colliderShape}set colliderShape(e){var t=this._colliderShape;if(t&&(t._attatched=!1,t._attatchedCollisionObject=null),this._colliderShape=e,e){if(e._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(e._attatched=!0,e._attatchedCollisionObject=this,this._btColliderObject){l.Physics3D._bullet.btCollisionObject_setCollisionShape(this._btColliderObject,e._btShape);var r=this._simulation&&this._enabled;r&&t&&this._removeFromSimulation(),this._onShapeChange(e),r&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&t&&this._removeFromSimulation()}get simulation(){return this._simulation}get collisionGroup(){return this._collisionGroup}set collisionGroup(e){this._collisionGroup!==e&&(this._collisionGroup=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}get canCollideWith(){return this._canCollideWith}set canCollideWith(e){this._canCollideWith!==e&&(this._canCollideWith=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}_parseShape(t){var r=t.length;if(1===r){var i=e._creatShape(t[0]);this.colliderShape=i}else{for(var n=new D,a=0;a<r;a++)i=e._creatShape(t[a]),n.addChildShape(i);this.colliderShape=n}}_onScaleChange(e){this._colliderShape._setScale(e)}_onEnable(){this._simulation=this.owner._scene.physicsSimulation,l.Physics3D._bullet.btCollisionObject_setContactProcessingThreshold(this._btColliderObject,1e30),this._colliderShape&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}_onDisable(){this._colliderShape&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null}_onDestroy(){delete e._physicObjectsMap[this.id],l.Physics3D._bullet.btCollisionObject_destroy(this._btColliderObject),this._colliderShape.destroy(),super._onDestroy(),this._btColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}_isValid(){return this._simulation&&this._colliderShape&&this._enabled}_parse(e){null!=e.collisionGroup&&(this.collisionGroup=e.collisionGroup),null!=e.canCollideWith&&(this.canCollideWith=e.canCollideWith),null!=e.ccdMotionThreshold&&(this.ccdMotionThreshold=e.ccdMotionThreshold),null!=e.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=e.ccdSweptSphereRadius)}_setTransformFlag(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}_getTransformFlag(e){return 0!=(this._transformFlag&e)}_addToSimulation(){}_removeFromSimulation(){}_derivePhysicsTransformation(e){var t=l.Physics3D._bullet,r=this._btColliderObject,i=t.btCollisionObject_getWorldTransform(r);this._innerDerivePhysicsTransformation(i,e),t.btCollisionObject_setWorldTransform(r,i)}_innerDerivePhysicsTransformation(t,r){var i=l.Physics3D._bullet,n=this.owner._transform;if(r||this._getTransformFlag(d.TRANSFORM_WORLDPOSITION)){var s=this._colliderShape.localOffset,o=n.position,_=e._btVector30;if(0!==s.x||0!==s.y||0!==s.z){var h=e._tempVector30,c=n.worldMatrix;a.transformCoordinate(s,c,h),i.btVector3_setValue(_,-h.x,h.y,h.z)}else i.btVector3_setValue(_,-o.x,o.y,o.z);i.btTransform_setOrigin(t,_),this._setTransformFlag(d.TRANSFORM_WORLDPOSITION,!1)}if(r||this._getTransformFlag(d.TRANSFORM_WORLDQUATERNION)){var u=this._colliderShape.localRotation,m=e._btQuaternion0,f=n.rotation;if(0!==u.x||0!==u.y||0!==u.z||1!==u.w){var T=e._tempQuaternion0;e.physicQuaternionMultiply(f.x,f.y,f.z,f.w,u,T),i.btQuaternion_setValue(m,-T.x,T.y,T.z,-T.w)}else i.btQuaternion_setValue(m,-f.x,f.y,f.z,-f.w);i.btTransform_setRotation(t,m),this._setTransformFlag(d.TRANSFORM_WORLDQUATERNION,!1)}(r||this._getTransformFlag(d.TRANSFORM_WORLDSCALE))&&(this._onScaleChange(n.getWorldLossyScale()),this._setTransformFlag(d.TRANSFORM_WORLDSCALE,!1))}_updateTransformComponent(t){var r=l.Physics3D._bullet,i=this._colliderShape,n=i.localOffset,s=i.localRotation,o=this.owner._transform,_=o.position,h=o.rotation,c=r.btTransform_getOrigin(t),d=r.btTransform_getRotation(t),u=-r.btQuaternion_x(d),m=r.btQuaternion_y(d),f=r.btQuaternion_z(d),T=-r.btQuaternion_w(d);if(0!==s.x||0!==s.y||0!==s.z||1!==s.w){var E=e._tempQuaternion0;s.invert(E),e.physicQuaternionMultiply(u,m,f,T,E,h)}else h.x=u,h.y=m,h.z=f,h.w=T;if(o.rotation=h,0!==n.x||0!==n.y||0!==n.z){var p=r.btCollisionShape_getLocalScaling(i._btShape),g=e._tempVector30;g.x=n.x*r.btVector3_x(p),g.y=n.y*r.btVector3_y(p),g.z=n.z*r.btVector3_z(p),a.transformQuat(g,h,g),_.x=-r.btVector3_x(c)-g.x,_.y=r.btVector3_y(c)-g.y,_.z=r.btVector3_z(c)-g.z}else _.x=-r.btVector3_x(c),_.y=r.btVector3_y(c),_.z=r.btVector3_z(c);o.position=_}_onShapeChange(t){var r=this._btColliderObject,i=l.Physics3D._bullet,n=i.btCollisionObject_getCollisionFlags(r);t.needsCustomCollisionCallback?0==(n&e.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)&&i.btCollisionObject_setCollisionFlags(r,n|e.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK):(n&e.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)>0&&i.btCollisionObject_setCollisionFlags(r,n^e.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)}_onAdded(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}_onTransformChanged(t){!e._addUpdateList&&this._controlBySimulation||(t&=d.TRANSFORM_WORLDPOSITION|d.TRANSFORM_WORLDQUATERNION|d.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=t,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}_cloneTo(e){var t=e;t.restitution=this._restitution,t.friction=this._friction,t.rollingFriction=this._rollingFriction,t.ccdMotionThreshold=this._ccdMotionThreshold,t.ccdSweptSphereRadius=this._ccdSweptSphereRadius,t.collisionGroup=this._collisionGroup,t.canCollideWith=this._canCollideWith,t.canScaleShape=this.canScaleShape,this._colliderShape&&(t.colliderShape=this._colliderShape.clone())}}return e.ACTIVATIONSTATE_ACTIVE_TAG=1,e.ACTIVATIONSTATE_ISLAND_SLEEPING=2,e.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,e.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,e.ACTIVATIONSTATE_DISABLE_SIMULATION=5,e.COLLISIONFLAGS_STATIC_OBJECT=1,e.COLLISIONFLAGS_KINEMATIC_OBJECT=2,e.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,e.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,e.COLLISIONFLAGS_CHARACTER_OBJECT=16,e.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,e.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,e._tempVector30=new a,e._tempQuaternion0=new _,e._tempQuaternion1=new _,e._tempMatrix4x40=new h,e._physicObjectsMap={},e._addUpdateList=!0,e})();class F extends E{constructor(){super()}add(e){if(-1!==e._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(e),e._inPhysicUpdateListIndex=this.length++}remove(e){var t=e._inPhysicUpdateListIndex;if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._inPhysicUpdateListIndex=t}e._inPhysicUpdateListIndex=-1}}class B{constructor(){this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new a,this.positionOnA=new a,this.positionOnB=new a,this._id=++this._idCounter}}class U{constructor(){this.succeeded=!1,this.collider=null,this.point=new a,this.normal=new a,this.hitFraction=0}}class G{constructor(){this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}_setUpdateFrame(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}}class z{constructor(){this._hitResultsPoolIndex=0,this._hitResultsPool=[],this._contactPonintsPoolIndex=0,this._contactPointsPool=[],this._collisionsPool=[],this._collisions={}}getHitResult(){var e=this._hitResultsPool[this._hitResultsPoolIndex++];return e||(e=new U,this._hitResultsPool.push(e)),e}recoverAllHitResultsPool(){this._hitResultsPoolIndex=0}getContactPoints(){var e=this._contactPointsPool[this._contactPonintsPoolIndex++];return e||(e=new B,this._contactPointsPool.push(e)),e}recoverAllContactPointsPool(){this._contactPonintsPoolIndex=0}getCollision(e,t){var r,i=e.id,n=t.id,a=this._collisions[i];return a&&(r=a[n]),r||(a||(a={},this._collisions[i]=a),(r=0===this._collisionsPool.length?new G:this._collisionsPool.pop())._colliderA=e,r._colliderB=t,a[n]=r),r}recoverCollision(e){var t=e._colliderA.id,r=e._colliderB.id;this._collisions[t][r]=null,this._collisionsPool.push(e)}garbageCollection(){for(var e in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var t=this._collisionsPool[e],r=!0;for(var i in t)t[i]?r=!1:delete t[i];r&&delete this._collisionsPool[e]}}}let H=(()=>{class e{constructor(t,r=0){this._gravity=new a(0,-10,0),this._btVector3Zero=l.Physics3D._bullet.btVector3_create(0,0,0),this._btDefaultQuaternion=l.Physics3D._bullet.btQuaternion_create(0,0,0,-1),this._collisionsUtils=new z,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._currentConstraint={},this._physicsUpdateList=new F,this._characters=[],this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.maxSubSteps=t.maxSubSteps,this.fixedTimeStep=t.fixedTimeStep;var i=l.Physics3D._bullet;this._btCollisionConfiguration=i.btDefaultCollisionConfiguration_create(),this._btDispatcher=i.btCollisionDispatcher_create(this._btCollisionConfiguration),this._btBroadphase=i.btDbvtBroadphase_create(),i.btOverlappingPairCache_setInternalGhostPairCallback(i.btDbvtBroadphase_getOverlappingPairCache(this._btBroadphase),i.btGhostPairCallback_create());var n=t.flags;if(n&e.PHYSICSENGINEFLAGS_COLLISIONSONLY)this._btCollisionWorld=new i.btCollisionWorld(this._btDispatcher,this._btBroadphase,this._btCollisionConfiguration);else{if(n&e.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT)throw"PhysicsSimulation:SoftBody processing is not yet available";var s=i.btSequentialImpulseConstraintSolver_create();this._btDiscreteDynamicsWorld=i.btDiscreteDynamicsWorld_create(this._btDispatcher,this._btBroadphase,s,this._btCollisionConfiguration),this._btCollisionWorld=this._btDiscreteDynamicsWorld}this._btDiscreteDynamicsWorld&&(this._btSolverInfo=i.btDynamicsWorld_getSolverInfo(this._btDiscreteDynamicsWorld),this._btDispatchInfo=i.btCollisionWorld_getDispatchInfo(this._btDiscreteDynamicsWorld)),this._btClosestRayResultCallback=i.ClosestRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllHitsRayResultCallback=i.AllHitsRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btClosestConvexResultCallback=i.ClosestConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllConvexResultCallback=i.AllConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),i.btGImpactCollisionAlgorithm_RegisterAlgorithm(this._btDispatcher)}static __init__(){var t=l.Physics3D._bullet;e._btTempVector30=t.btVector3_create(0,0,0),e._btTempVector31=t.btVector3_create(0,0,0),e._btTempQuaternion0=t.btQuaternion_create(0,0,0,1),e._btTempQuaternion1=t.btQuaternion_create(0,0,0,1),e._btTempTransform0=t.btTransform_create(),e._btTempTransform1=t.btTransform_create()}static createConstraint(){}get continuousCollisionDetection(){return l.Physics3D._bullet.btCollisionWorld_get_m_useContinuous(this._btDispatchInfo)}set continuousCollisionDetection(e){l.Physics3D._bullet.btCollisionWorld_set_m_useContinuous(this._btDispatchInfo,e)}get gravity(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity}set gravity(t){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=t;var r=l.Physics3D._bullet,i=e._btTempVector30;r.btVector3_setValue(i,-t.x,t.y,t.z),r.btDiscreteDynamicsWorld_setGravity(this._btDiscreteDynamicsWorld,i)}get speculativeContactRestitution(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return l.Physics3D._bullet.btDiscreteDynamicsWorld_getApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld)}set speculativeContactRestitution(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_setApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld,e)}_simulate(e){this._updatedRigidbodies=0;var t=l.Physics3D._bullet;this._btDiscreteDynamicsWorld?t.btDiscreteDynamicsWorld_stepSimulation(this._btDiscreteDynamicsWorld,e,this.maxSubSteps,this.fixedTimeStep):t.PerformDiscreteCollisionDetection(this._btCollisionWorld)}_destroy(){var e=l.Physics3D._bullet;this._btDiscreteDynamicsWorld?(e.btCollisionWorld_destroy(this._btDiscreteDynamicsWorld),this._btDiscreteDynamicsWorld=null):(e.btCollisionWorld_destroy(this._btCollisionWorld),this._btCollisionWorld=null),e.btDbvtBroadphase_destroy(this._btBroadphase),this._btBroadphase=null,e.btCollisionDispatcher_destroy(this._btDispatcher),this._btDispatcher=null,e.btDefaultCollisionConfiguration_destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null}_addPhysicsCollider(e,t,r){l.Physics3D._bullet.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,r)}_removePhysicsCollider(e){l.Physics3D._bullet.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject)}_addRigidBody(e,t,r){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_addRigidBody(this._btCollisionWorld,e._btColliderObject,t,r)}_removeRigidBody(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_removeRigidBody(this._btCollisionWorld,e._btColliderObject)}_addCharacter(e,t,r){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var i=l.Physics3D._bullet;i.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,r),i.btDynamicsWorld_addAction(this._btCollisionWorld,e._btKinematicCharacter)}_removeCharacter(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var t=l.Physics3D._bullet;t.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject),t.btDynamicsWorld_removeAction(this._btCollisionWorld,e._btKinematicCharacter)}raycastFromTo(t,r,i=null,n=u.COLLISIONFILTERGROUP_ALLFILTER,a=u.COLLISIONFILTERGROUP_ALLFILTER){var s=l.Physics3D._bullet,o=this._btClosestRayResultCallback,_=e._btTempVector30,h=e._btTempVector31;if(s.btVector3_setValue(_,-t.x,t.y,t.z),s.btVector3_setValue(h,-r.x,r.y,r.z),s.ClosestRayResultCallback_set_m_rayFromWorld(o,_),s.ClosestRayResultCallback_set_m_rayToWorld(o,h),s.RayResultCallback_set_m_collisionFilterGroup(o,n),s.RayResultCallback_set_m_collisionFilterMask(o,a),s.RayResultCallback_set_m_collisionObject(o,null),s.RayResultCallback_set_m_closestHitFraction(o,1),s.btCollisionWorld_rayTest(this._btCollisionWorld,_,h,o),s.RayResultCallback_hasHit(o)){if(i){i.succeeded=!0,i.collider=V._physicObjectsMap[s.btCollisionObject_getUserIndex(s.RayResultCallback_get_m_collisionObject(o))],i.hitFraction=s.RayResultCallback_get_m_closestHitFraction(o);var c=s.ClosestRayResultCallback_get_m_hitPointWorld(o),d=i.point;d.x=-s.btVector3_x(c),d.y=s.btVector3_y(c),d.z=s.btVector3_z(c);var m=s.ClosestRayResultCallback_get_m_hitNormalWorld(o),f=i.normal;f.x=-s.btVector3_x(m),f.y=s.btVector3_y(m),f.z=s.btVector3_z(m)}return!0}return i&&(i.succeeded=!1),!1}raycastAllFromTo(t,r,i,n=u.COLLISIONFILTERGROUP_ALLFILTER,a=u.COLLISIONFILTERGROUP_ALLFILTER){var s=l.Physics3D._bullet,o=this._btAllHitsRayResultCallback,_=e._btTempVector30,h=e._btTempVector31;i.length=0,s.btVector3_setValue(_,-t.x,t.y,t.z),s.btVector3_setValue(h,-r.x,r.y,r.z),s.AllHitsRayResultCallback_set_m_rayFromWorld(o,_),s.AllHitsRayResultCallback_set_m_rayToWorld(o,h),s.RayResultCallback_set_m_collisionFilterGroup(o,n),s.RayResultCallback_set_m_collisionFilterMask(o,a);var c=s.AllHitsRayResultCallback_get_m_collisionObjects(o),d=s.AllHitsRayResultCallback_get_m_hitPointWorld(o),m=s.AllHitsRayResultCallback_get_m_hitNormalWorld(o),f=s.AllHitsRayResultCallback_get_m_hitFractions(o);s.tBtCollisionObjectArray_clear(c),s.tVector3Array_clear(d),s.tVector3Array_clear(m),s.tScalarArray_clear(f),s.btCollisionWorld_rayTest(this._btCollisionWorld,_,h,o);var T=s.tBtCollisionObjectArray_size(c);if(T>0){this._collisionsUtils.recoverAllHitResultsPool();for(var E=0;E<T;E++){var p=this._collisionsUtils.getHitResult();i.push(p),p.succeeded=!0,p.collider=V._physicObjectsMap[s.btCollisionObject_getUserIndex(s.tBtCollisionObjectArray_at(c,E))],p.hitFraction=s.tScalarArray_at(f,E);var g=s.tVector3Array_at(d,E),S=p.point;S.x=-s.btVector3_x(g),S.y=s.btVector3_y(g),S.z=s.btVector3_z(g);var R=s.tVector3Array_at(m,E),v=p.normal;v.x=-s.btVector3_x(R),v.y=s.btVector3_y(R),v.z=s.btVector3_z(R)}return!0}return!1}rayCast(t,r=null,i=2147483647,n=u.COLLISIONFILTERGROUP_ALLFILTER,s=u.COLLISIONFILTERGROUP_ALLFILTER){var o=t.origin,l=e._tempVector30;return a.normalize(t.direction,l),a.scale(l,i,l),a.add(o,l,l),this.raycastFromTo(o,l,r,n,s)}rayCastAll(t,r,i=2147483647,n=u.COLLISIONFILTERGROUP_ALLFILTER,s=u.COLLISIONFILTERGROUP_ALLFILTER){var o=t.origin,l=e._tempVector30;return a.normalize(t.direction,l),a.scale(l,i,l),a.add(o,l,l),this.raycastAllFromTo(o,l,r,n,s)}shapeCast(t,r,i,n=null,a=null,s=null,o=u.COLLISIONFILTERGROUP_ALLFILTER,_=u.COLLISIONFILTERGROUP_ALLFILTER,h=0){var c=l.Physics3D._bullet,d=this._btClosestConvexResultCallback,m=e._btTempVector30,f=e._btTempVector31,T=e._btTempQuaternion0,E=e._btTempQuaternion1,p=e._btTempTransform0,g=e._btTempTransform1,S=t._btShape;if(c.btVector3_setValue(m,-r.x,r.y,r.z),c.btVector3_setValue(f,-i.x,i.y,i.z),c.ConvexResultCallback_set_m_collisionFilterGroup(d,o),c.ConvexResultCallback_set_m_collisionFilterMask(d,_),c.btTransform_setOrigin(p,m),c.btTransform_setOrigin(g,f),a?(c.btQuaternion_setValue(T,-a.x,a.y,a.z,-a.w),c.btTransform_setRotation(p,T)):c.btTransform_setRotation(p,this._btDefaultQuaternion),s?(c.btQuaternion_setValue(E,-s.x,s.y,s.z,-s.w),c.btTransform_setRotation(g,E)):c.btTransform_setRotation(g,this._btDefaultQuaternion),c.ClosestConvexResultCallback_set_m_hitCollisionObject(d,null),c.ConvexResultCallback_set_m_closestHitFraction(d,1),c.btCollisionWorld_convexSweepTest(this._btCollisionWorld,S,p,g,d,h),c.ConvexResultCallback_hasHit(d)){if(n){n.succeeded=!0,n.collider=V._physicObjectsMap[c.btCollisionObject_getUserIndex(c.ClosestConvexResultCallback_get_m_hitCollisionObject(d))],n.hitFraction=c.ConvexResultCallback_get_m_closestHitFraction(d);var R=c.ClosestConvexResultCallback_get_m_hitPointWorld(d),v=c.ClosestConvexResultCallback_get_m_hitNormalWorld(d),A=n.point,I=n.normal;A.x=-c.btVector3_x(R),A.y=c.btVector3_y(R),A.z=c.btVector3_z(R),I.x=-c.btVector3_x(v),I.y=c.btVector3_y(v),I.z=c.btVector3_z(v)}return!0}return n&&(n.succeeded=!1),!1}shapeCastAll(t,r,i,n,a=null,s=null,o=u.COLLISIONFILTERGROUP_ALLFILTER,_=u.COLLISIONFILTERGROUP_ALLFILTER,h=0){var c=l.Physics3D._bullet,d=this._btAllConvexResultCallback,m=e._btTempVector30,f=e._btTempVector31,T=e._btTempQuaternion0,E=e._btTempQuaternion1,p=e._btTempTransform0,g=e._btTempTransform1,S=t._btShape;n.length=0,c.btVector3_setValue(m,-r.x,r.y,r.z),c.btVector3_setValue(f,-i.x,i.y,i.z),c.ConvexResultCallback_set_m_collisionFilterGroup(d,o),c.ConvexResultCallback_set_m_collisionFilterMask(d,_),c.btTransform_setOrigin(p,m),c.btTransform_setOrigin(g,f),a?(c.btQuaternion_setValue(T,-a.x,a.y,a.z,-a.w),c.btTransform_setRotation(p,T)):c.btTransform_setRotation(p,this._btDefaultQuaternion),s?(c.btQuaternion_setValue(E,-s.x,s.y,s.z,-s.w),c.btTransform_setRotation(g,E)):c.btTransform_setRotation(g,this._btDefaultQuaternion);var R=c.AllConvexResultCallback_get_m_collisionObjects(d);c.tBtCollisionObjectArray_clear(R),c.btCollisionWorld_convexSweepTest(this._btCollisionWorld,S,p,g,d,h);var v=c.tBtCollisionObjectArray_size(R);if(v>0){this._collisionsUtils.recoverAllHitResultsPool();for(var A=c.AllConvexResultCallback_get_m_hitPointWorld(d),I=c.AllConvexResultCallback_get_m_hitNormalWorld(d),x=c.AllConvexResultCallback_get_m_hitFractions(d),C=0;C<v;C++){var L=this._collisionsUtils.getHitResult();n.push(L),L.succeeded=!0,L.collider=V._physicObjectsMap[c.btCollisionObject_getUserIndex(c.tBtCollisionObjectArray_at(R,C))],L.hitFraction=c.tScalarArray_at(x,C);var y=c.tVector3Array_at(A,C),D=L.point;D.x=-c.btVector3_x(y),D.y=c.btVector3_y(y),D.z=c.btVector3_z(y);var M=c.tVector3Array_at(I,C),O=L.normal;O.x=-c.btVector3_x(M),O.y=c.btVector3_y(M),O.z=c.btVector3_z(M)}return!0}return!1}addConstraint(e,t=!1){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btCollisionWorld_addConstraint(this._btDiscreteDynamicsWorld,e._btConstraint,t),this._currentConstraint[e.id]=e}removeConstraint(e){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btCollisionWorld_removeConstraint(this._btDiscreteDynamicsWorld,e._btConstraint),delete this._currentConstraint[e.id]}_updatePhysicsTransformFromRender(){for(var e=this._physicsUpdateList.elements,t=0,r=this._physicsUpdateList.length;t<r;t++){var i=e[t];i._derivePhysicsTransformation(!1),i._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0}_updateCharacters(){for(var e=0,t=this._characters.length;e<t;e++){var r=this._characters[e];r._updateTransformComponent(l.Physics3D._bullet.btCollisionObject_getWorldTransform(r._btColliderObject))}}_updateCollisions(){this._collisionsUtils.recoverAllContactPointsPool();var e=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=e;for(var r=t.Stat.loopCount,i=l.Physics3D._bullet,n=i.btDispatcher_getNumManifolds(this._btDispatcher),a=0;a<n;a++){var s,o=i.btDispatcher_getManifoldByIndexInternal(this._btDispatcher,a),_=V._physicObjectsMap[i.btCollisionObject_getUserIndex(i.btPersistentManifold_getBody0(o))],h=V._physicObjectsMap[i.btCollisionObject_getUserIndex(i.btPersistentManifold_getBody1(o))],c=null,d=null;if((_.isTrigger||h.isTrigger)&&(_.owner._needProcessTriggers||h.owner._needProcessTriggers))for(var u=i.btPersistentManifold_getNumContacts(o),m=0;m<u;m++){var f=i.btPersistentManifold_getContactPoint(o,m),T=i.btManifoldPoint_getDistance(f);if(T<=0){d=(c=this._collisionsUtils.getCollision(_,h)).contacts,(s=c._updateFrame!==r)&&(c._isTrigger=!0,d.length=0);break}}else if((_.owner._needProcessCollisions||h.owner._needProcessCollisions)&&(_._enableProcessCollisions||h._enableProcessCollisions))for(u=i.btPersistentManifold_getNumContacts(o),m=0;m<u;m++)if(f=i.btPersistentManifold_getContactPoint(o,m),(T=i.btManifoldPoint_getDistance(f))<=0){var E=this._collisionsUtils.getContactPoints();E.colliderA=_,E.colliderB=h,E.distance=T;var p=i.btManifoldPoint_get_m_normalWorldOnB(f),g=E.normal;g.x=-i.btVector3_x(p),g.y=i.btVector3_y(p),g.z=i.btVector3_z(p);var S=i.btManifoldPoint_get_m_positionWorldOnA(f),R=E.positionOnA;R.x=-i.btVector3_x(S),R.y=i.btVector3_y(S),R.z=i.btVector3_z(S);var v=i.btManifoldPoint_get_m_positionWorldOnB(f),A=E.positionOnB;A.x=-i.btVector3_x(v),A.y=i.btVector3_y(v),A.z=i.btVector3_z(v),c||(d=(c=this._collisionsUtils.getCollision(_,h)).contacts,(s=c._updateFrame!==r)&&(c._isTrigger=!1,d.length=0)),d.push(E)}c&&s&&(this._currentFrameCollisions.push(c),c._setUpdateFrame(r))}}_eventScripts(){for(var e=t.Stat.loopCount,r=0,i=this._currentFrameCollisions.length;r<i;r++){var n=this._currentFrameCollisions[r],a=n._colliderA,s=n._colliderB;if(!a.destroyed&&!s.destroyed)if(e-n._lastUpdateFrame==1){var o=a.owner,l=o._scripts;if(l)if(n._isTrigger){if(o._needProcessTriggers)for(var _=0,h=l.length;_<h;_++)l[_].onTriggerStay(s)}else if(o._needProcessCollisions)for(_=0,h=l.length;_<h;_++)n.other=s,l[_].onCollisionStay(n);var c=s.owner,d=c._scripts;if(d)if(n._isTrigger){if(c._needProcessTriggers)for(_=0,h=d.length;_<h;_++)d[_].onTriggerStay(a)}else if(c._needProcessCollisions)for(_=0,h=d.length;_<h;_++)n.other=a,d[_].onCollisionStay(n)}else{if(l=(o=a.owner)._scripts)if(n._isTrigger){if(o._needProcessTriggers)for(_=0,h=l.length;_<h;_++)l[_].onTriggerEnter(s)}else if(o._needProcessCollisions)for(_=0,h=l.length;_<h;_++)n.other=s,l[_].onCollisionEnter(n);if(d=(c=s.owner)._scripts)if(n._isTrigger){if(c._needProcessTriggers)for(_=0,h=d.length;_<h;_++)d[_].onTriggerEnter(a)}else if(c._needProcessCollisions)for(_=0,h=d.length;_<h;_++)n.other=a,d[_].onCollisionEnter(n)}}for(r=0,i=this._previousFrameCollisions.length;r<i;r++){var u=this._previousFrameCollisions[r],m=u._colliderA,f=u._colliderB;if(!m.destroyed&&!f.destroyed&&e-u._updateFrame==1){if(this._collisionsUtils.recoverCollision(u),l=(o=m.owner)._scripts)if(u._isTrigger){if(o._needProcessTriggers)for(_=0,h=l.length;_<h;_++)l[_].onTriggerExit(f)}else if(o._needProcessCollisions)for(_=0,h=l.length;_<h;_++)u.other=f,l[_].onCollisionExit(u);if(d=(c=f.owner)._scripts)if(u._isTrigger){if(c._needProcessTriggers)for(_=0,h=d.length;_<h;_++)d[_].onTriggerExit(m)}else if(c._needProcessCollisions)for(_=0,h=d.length;_<h;_++)u.other=m,d[_].onCollisionExit(u)}}for(var T in this._currentConstraint){var E=this._currentConstraint[T],p=E.owner._scripts;if(E.enabled&&E._isBreakConstrained()&&p&&0!=p.length)for(r=0,i=p.length;r<i;r++)p[r].onJointBreak()}}clearForces(){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_clearForces(this._btDiscreteDynamicsWorld)}}return e.PHYSICSENGINEFLAGS_NONE=0,e.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,e.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,e.PHYSICSENGINEFLAGS_MULTITHREADED=4,e.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,e.SOLVERMODE_RANDMIZE_ORDER=1,e.SOLVERMODE_FRICTION_SEPARATE=2,e.SOLVERMODE_USE_WARMSTARTING=4,e.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,e.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,e.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,e.SOLVERMODE_CACHE_FRIENDLY=128,e.SOLVERMODE_SIMD=256,e.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,e.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,e._tempVector30=new a,e.disableSimulation=!1,e})();class W{constructor(){}static lightAttenTexture(e,t,r,i,n,a){var s=e/r,o=1/(1+25*s);s>=.64&&(s>1?o=0:o*=1-(s-.64)/.36),a[n]=Math.floor(255*o+.5)}static haloTexture(e,t,r,i,n,a){var s=(e-(r>>=1))/r,o=(t-(i>>=1))/i,l=s*s+o*o;l>1&&(l=1),a[n]=Math.floor(255*(1-l)+.5)}static _generateTexture2D(e,r,i,n){var a=0,s=0;switch(e.format){case t.TextureFormat.R8G8B8:s=3;break;case t.TextureFormat.R8G8B8A8:s=4;break;case t.TextureFormat.Alpha8:s=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var o=new Uint8Array(r*i*s),l=0;l<i;l++)for(var _=0;_<r;_++)n(_,l,r,i,a,o),a+=s;e.setPixels(o)}}let k=(()=>{class e{static _createFloatTextureBuffer(e,r){var i=new t.Texture2D(e,r,t.TextureFormat.R32G32B32A32,!1,!1);return i.filterMode=t.FilterMode.Point,i.wrapModeU=t.WarpMode.Clamp,i.wrapModeV=t.WarpMode.Clamp,i.anisoLevel=0,i}static _convertToLayaVec3(e,t,r){var i=l.Physics3D._bullet;t.x=r?-i.btVector3_x(e):i.btVector3_x(e),t.y=i.btVector3_y(e),t.z=i.btVector3_z(e)}static _convertToBulletVec3(e,t,r){l.Physics3D._bullet.btVector3_setValue(t,r?-e.x:e.x,e.y,e.z)}static _rotationTransformScaleSkinAnimation(t,r,i,n,a,s,o,l,_,h,c,d){var u,m,f,T,E,p=e._tempArray16_0,g=e._tempArray16_1,S=e._tempArray16_2,R=n+n,v=a+a,A=s+s,I=n*R,x=a*R,C=a*v,L=s*R,y=s*v,D=s*A,M=o*R,O=o*v,N=o*A;for(p[15]=1,p[0]=1-C-D,p[1]=x+N,p[2]=L-O,p[4]=x-N,p[5]=1-I-D,p[6]=y+M,p[8]=L+O,p[9]=y-M,p[10]=1-I-C,g[15]=1,g[0]=l,g[5]=_,g[10]=h,u=0;u<4;u++)m=p[u],f=p[u+4],T=p[u+8],E=p[u+12],S[u]=m,S[u+4]=f,S[u+8]=T,S[u+12]=m*t+f*r+T*i+E;for(u=0;u<4;u++)m=S[u],f=S[u+4],T=S[u+8],E=S[u+12],c[u+d]=m*g[0]+f*g[1]+T*g[2]+E*g[3],c[u+d+4]=m*g[4]+f*g[5]+T*g[6]+E*g[7],c[u+d+8]=m*g[8]+f*g[9]+T*g[10]+E*g[11],c[u+d+12]=m*g[12]+f*g[13]+T*g[14]+E*g[15]}static _computeBoneAndAnimationDatasByBindPoseMatrxix(t,r,i,n,a,s){var o,l,_=0,h=0,c=t.length;for(o=0;o<c;_+=t[o].keyframeWidth,h+=16,o++)e._rotationTransformScaleSkinAnimation(r[_+0],r[_+1],r[_+2],r[_+3],r[_+4],r[_+5],r[_+6],r[_+7],r[_+8],r[_+9],n,h),0!=o&&(l=16*t[o].parentIndex,e.mulMatrixByArray(n,l,n,h,n,h));var d=i.length;for(o=0;o<d;o++)e.mulMatrixByArrayAndMatrixFast(n,16*s[o],i[o],a,16*o)}static _computeAnimationDatasByArrayAndMatrixFast(t,r,i,n){for(var a=0,s=t.length;a<s;a++)e.mulMatrixByArrayAndMatrixFast(r,16*n[a],t[a],i,16*a)}static _computeBoneAndAnimationDatasByBindPoseMatrxixOld(t,r,i,n,a){var s,o,l=0,_=0,h=t.length;for(s=0;s<h;l+=t[s].keyframeWidth,_+=16,s++)e._rotationTransformScaleSkinAnimation(r[l+7],r[l+8],r[l+9],r[l+3],r[l+4],r[l+5],r[l+6],r[l+0],r[l+1],r[l+2],n,_),0!=s&&(o=16*t[s].parentIndex,e.mulMatrixByArray(n,o,n,_,n,_));var c=i.length;for(s=0;s<c;s++){var d=16*s;e.mulMatrixByArrayAndMatrixFast(n,d,i[s],a,d)}}static _computeAnimationDatasByArrayAndMatrixFastOld(t,r,i){for(var n=t.length,a=0;a<n;a++){var s=16*a;e.mulMatrixByArrayAndMatrixFast(r,s,t[a],i,s)}}static _computeRootAnimationData(t,r,i){for(var n=0,a=0,s=0,o=t.length;n<o;a+=t[n].keyframeWidth,s+=16,n++)e.createAffineTransformationArray(r[a+0],r[a+1],r[a+2],r[a+3],r[a+4],r[a+5],r[a+6],r[a+7],r[a+8],r[a+9],i,s)}static transformVector3ArrayByQuat(e,t,r,i,n){var a=e[t],s=e[t+1],o=e[t+2],l=r.x,_=r.y,h=r.z,c=r.w,d=c*a+_*o-h*s,u=c*s+h*a-l*o,m=c*o+l*s-_*a,f=-l*a-_*s-h*o;i[n]=d*c+f*-l+u*-h-m*-_,i[n+1]=u*c+f*-_+m*-l-d*-h,i[n+2]=m*c+f*-h+d*-_-u*-l}static mulMatrixByArray(t,r,i,n,a,s){var o,l,_,h,c;if(a===i){for(i=e._tempArray16_3,o=0;o<16;++o)i[o]=a[s+o];n=0}for(o=0;o<4;o++)l=t[r+o],_=t[r+o+4],h=t[r+o+8],c=t[r+o+12],a[s+o]=l*i[n+0]+_*i[n+1]+h*i[n+2]+c*i[n+3],a[s+o+4]=l*i[n+4]+_*i[n+5]+h*i[n+6]+c*i[n+7],a[s+o+8]=l*i[n+8]+_*i[n+9]+h*i[n+10]+c*i[n+11],a[s+o+12]=l*i[n+12]+_*i[n+13]+h*i[n+14]+c*i[n+15]}static mulMatrixByArrayFast(e,t,r,i,n,a){var s,o,l,_,h;for(s=0;s<4;s++)o=e[t+s],l=e[t+s+4],_=e[t+s+8],h=e[t+s+12],n[a+s]=o*r[i+0]+l*r[i+1]+_*r[i+2]+h*r[i+3],n[a+s+4]=o*r[i+4]+l*r[i+5]+_*r[i+6]+h*r[i+7],n[a+s+8]=o*r[i+8]+l*r[i+9]+_*r[i+10]+h*r[i+11],n[a+s+12]=o*r[i+12]+l*r[i+13]+_*r[i+14]+h*r[i+15]}static mulMatrixByArrayAndMatrixFast(e,t,r,i,n){var a,s,o,l,_,h=r.elements,c=h[0],d=h[1],u=h[2],m=h[3],f=h[4],T=h[5],E=h[6],p=h[7],g=h[8],S=h[9],R=h[10],v=h[11],A=h[12],I=h[13],x=h[14],C=h[15],L=t,y=t+4,D=t+8,M=t+12,O=n,N=n+4,b=n+8,P=n+12;for(a=0;a<4;a++)s=e[L+a],o=e[y+a],l=e[D+a],_=e[M+a],i[O+a]=s*c+o*d+l*u+_*m,i[N+a]=s*f+o*T+l*E+_*p,i[b+a]=s*g+o*S+l*R+_*v,i[P+a]=s*A+o*I+l*x+_*C}static createAffineTransformationArray(e,t,r,i,n,a,s,o,l,_,h,c){var d=i+i,u=n+n,m=a+a,f=i*d,T=i*u,E=i*m,p=n*u,g=n*m,S=a*m,R=s*d,v=s*u,A=s*m;h[c+0]=(1-(p+S))*o,h[c+1]=(T+A)*o,h[c+2]=(E-v)*o,h[c+3]=0,h[c+4]=(T-A)*l,h[c+5]=(1-(f+S))*l,h[c+6]=(g+R)*l,h[c+7]=0,h[c+8]=(E+v)*_,h[c+9]=(g-R)*_,h[c+10]=(1-(f+p))*_,h[c+11]=0,h[c+12]=e,h[c+13]=t,h[c+14]=r,h[c+15]=1}static transformVector3ArrayToVector3ArrayCoordinate(e,t,r,i,n){var a=e[t+0],s=e[t+1],o=e[t+2],l=r.elements,_=a*l[3]+s*l[7]+o*l[11]+l[15];i[n]=a*l[0]+s*l[4]+o*l[8]+l[12]/_,i[n+1]=a*l[1]+s*l[5]+o*l[9]+l[13]/_,i[n+2]=a*l[2]+s*l[6]+o*l[10]+l[14]/_}static transformVector3ArrayToVector3ArrayNormal(e,t,r,i,n){var a=e[t+0],s=e[t+1],o=e[t+2],l=r.elements;i[n]=a*l[0]+s*l[4]+o*l[8],i[n+1]=a*l[1]+s*l[5]+o*l[9],i[n+2]=a*l[2]+s*l[6]+o*l[10]}static transformLightingMapTexcoordArray(e,t,r,i,n){i[n+0]=e[t+0]*r.x+r.z,i[n+1]=1-((1-e[t+1])*r.y+r.w)}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substr(t):null}static _createAffineTransformationArray(e,t,r,i){var n=t.x,a=t.y,s=t.z,o=t.w,l=n+n,_=a+a,h=s+s,c=n*l,d=n*_,u=n*h,m=a*_,f=a*h,T=s*h,E=o*l,p=o*_,g=o*h,S=r.x,R=r.y,v=r.z;i[0]=(1-(m+T))*S,i[1]=(d+g)*S,i[2]=(u-p)*S,i[3]=0,i[4]=(d-g)*R,i[5]=(1-(c+T))*R,i[6]=(f+E)*R,i[7]=0,i[8]=(u+p)*v,i[9]=(f-E)*v,i[10]=(1-(c+m))*v,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}static _mulMatrixArray(e,t,r,i,n){var a=t,s=e,o=i,l=a[r],_=a[r+1],h=a[r+2],c=a[r+3],d=a[r+4],u=a[r+5],m=a[r+6],f=a[r+7],T=a[r+8],E=a[r+9],p=a[r+10],g=a[r+11],S=a[r+12],R=a[r+13],v=a[r+14],A=a[r+15],I=s[0],x=s[1],C=s[2],L=s[3],y=s[4],D=s[5],M=s[6],O=s[7],N=s[8],b=s[9],P=s[10],w=s[11],V=s[12],F=s[13],B=s[14],U=s[15];o[n]=l*I+_*y+h*N+c*V,o[n+1]=l*x+_*D+h*b+c*F,o[n+2]=l*C+_*M+h*P+c*B,o[n+3]=l*L+_*O+h*w+c*U,o[n+4]=d*I+u*y+m*N+f*V,o[n+5]=d*x+u*D+m*b+f*F,o[n+6]=d*C+u*M+m*P+f*B,o[n+7]=d*L+u*O+m*w+f*U,o[n+8]=T*I+E*y+p*N+g*V,o[n+9]=T*x+E*D+p*b+g*F,o[n+10]=T*C+E*M+p*P+g*B,o[n+11]=T*L+E*O+p*w+g*U,o[n+12]=S*I+R*y+v*N+A*V,o[n+13]=S*x+R*D+v*b+A*F,o[n+14]=S*C+R*M+v*P+A*B,o[n+15]=S*L+R*O+v*w+A*U}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(t,r,i){a.subtract(r,t,_.TEMPVector30),a.normalize(_.TEMPVector30,_.TEMPVector30),i.x=Math.asin(_.TEMPVector30.y),i.y=e.arcTanAngle(-_.TEMPVector30.z,-_.TEMPVector30.x)}static transformQuat(e,t,r){var i=t,n=e.x,a=e.y,s=e.z,o=i[0],l=i[1],_=i[2],h=i[3],c=h*n+l*s-_*a,d=h*a+_*n-o*s,u=h*s+o*a-l*n,m=-o*n-l*a-_*s;r.x=c*h+m*-o+d*-_-u*-l,r.y=d*h+m*-l+u*-o-c*-_,r.z=u*h+m*-_+c*-l-d*-o}static quaternionWeight(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w}static quaternionConjugate(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}static scaleWeight(e,t,r){var i=e.x,n=e.y,a=e.z;r.x=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),r.y=n>0?Math.pow(Math.abs(n),t):-Math.pow(Math.abs(n),t),r.z=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t)}static scaleBlend(t,r,i,n){var a=e._tempVector3_0,s=e._tempVector3_1;e.scaleWeight(t,1-i,a),e.scaleWeight(r,i,s);var o=i>.5?r:t;n.x=o.x>0?Math.abs(a.x*s.x):-Math.abs(a.x*s.x),n.y=o.y>0?Math.abs(a.y*s.y):-Math.abs(a.y*s.y),n.z=o.z>0?Math.abs(a.z*s.z):-Math.abs(a.z*s.z)}static matrix4x4MultiplyFFF(e,t,r){var i,n,a,s,o;if(r===t)for(t=new Float32Array(16),i=0;i<16;++i)t[i]=r[i];var l=t[0],_=t[1],h=t[2],c=t[3],d=t[4],u=t[5],m=t[6],f=t[7],T=t[8],E=t[9],p=t[10],g=t[11],S=t[12],R=t[13],v=t[14],A=t[15];for(i=0;i<4;i++)n=e[i],a=e[i+4],s=e[i+8],o=e[i+12],r[i]=n*l+a*_+s*h+o*c,r[i+4]=n*d+a*u+s*m+o*f,r[i+8]=n*T+a*E+s*p+o*g,r[i+12]=n*S+a*R+s*v+o*A}static matrix4x4MultiplyFFFForNative(e,r,i){t.LayaGL.instance.matrix4x4Multiply(e,r,i)}static matrix4x4MultiplyMFM(t,r,i){e.matrix4x4MultiplyFFF(t.elements,r,i.elements)}static _buildTexture2D(e,r,i,n,a=!1){var s=new t.Texture2D(e,r,i,a,!0);return s.anisoLevel=1,s.filterMode=t.FilterMode.Point,W._generateTexture2D(s,e,r,n),s}static _drawBound(t,r,i){t.lineCount+12>t.maxLineCount&&(t.maxLineCount+=12);var n=e._tempVector3_0,a=e._tempVector3_1,s=r.min,o=r.max;n.setValue(s.x,s.y,s.z),a.setValue(o.x,s.y,s.z),t.addLine(n,a,i,i),n.setValue(s.x,s.y,s.z),a.setValue(s.x,s.y,o.z),t.addLine(n,a,i,i),n.setValue(o.x,s.y,s.z),a.setValue(o.x,s.y,o.z),t.addLine(n,a,i,i),n.setValue(s.x,s.y,o.z),a.setValue(o.x,s.y,o.z),t.addLine(n,a,i,i),n.setValue(s.x,s.y,s.z),a.setValue(s.x,o.y,s.z),t.addLine(n,a,i,i),n.setValue(s.x,s.y,o.z),a.setValue(s.x,o.y,o.z),t.addLine(n,a,i,i),n.setValue(o.x,s.y,s.z),a.setValue(o.x,o.y,s.z),t.addLine(n,a,i,i),n.setValue(o.x,s.y,o.z),a.setValue(o.x,o.y,o.z),t.addLine(n,a,i,i),n.setValue(s.x,o.y,s.z),a.setValue(o.x,o.y,s.z),t.addLine(n,a,i,i),n.setValue(s.x,o.y,s.z),a.setValue(s.x,o.y,o.z),t.addLine(n,a,i,i),n.setValue(o.x,o.y,s.z),a.setValue(o.x,o.y,o.z),t.addLine(n,a,i,i),n.setValue(s.x,o.y,o.z),a.setValue(o.x,o.y,o.z),t.addLine(n,a,i,i)}static _getHierarchyPath(e,t,r){r.length=0;for(var i=t;i!==e;){var n=i._parent;if(!n)return null;r.push(n.getChildIndex(i)),i=n}return r}static _getNodeByHierarchyPath(e,t){for(var r=e,i=t.length-1;i>=0;i--)r=r.getChildAt(t[i]);return r}}return e._tempVector3_0=new a,e._tempVector3_1=new a,e._tempArray16_0=new Float32Array(16),e._tempArray16_1=new Float32Array(16),e._tempArray16_2=new Float32Array(16),e._tempArray16_3=new Float32Array(16),e._compIdToNode=new Object,e})(),X=(()=>{class e extends V{constructor(e=.1,t=null,r=u.COLLISIONFILTERGROUP_DEFAULTFILTER,i=u.COLLISIONFILTERGROUP_ALLFILTER){super(r,i),this._upAxis=new a(0,1,0),this._maxSlope=45,this._jumpSpeed=10,this._fallSpeed=55,this._gravity=new a(0,3*-9.8,0),this._btKinematicCharacter=null,this._stepHeight=e,t&&(this._upAxis=t),this._controlBySimulation=!0}static __init__(){e._btTempVector30=l.Physics3D._bullet.btVector3_create(0,0,0)}get fallSpeed(){return this._fallSpeed}set fallSpeed(e){this._fallSpeed=e,l.Physics3D._bullet.btKinematicCharacterController_setFallSpeed(this._btKinematicCharacter,e)}get jumpSpeed(){return this._jumpSpeed}set jumpSpeed(e){this._jumpSpeed=e,l.Physics3D._bullet.btKinematicCharacterController_setJumpSpeed(this._btKinematicCharacter,e)}get gravity(){return this._gravity}set gravity(t){this._gravity=t;var r=l.Physics3D._bullet,i=e._btTempVector30;r.btVector3_setValue(i,-t.x,t.y,t.z),r.btKinematicCharacterController_setGravity(this._btKinematicCharacter,i)}get maxSlope(){return this._maxSlope}set maxSlope(e){this._maxSlope=e,l.Physics3D._bullet.btKinematicCharacterController_setMaxSlope(this._btKinematicCharacter,e/180*Math.PI)}get isGrounded(){return l.Physics3D._bullet.btKinematicCharacterController_onGround(this._btKinematicCharacter)}get stepHeight(){return this._stepHeight}set stepHeight(e){this._stepHeight=e,l.Physics3D._bullet.btKinematicCharacterController_setStepHeight(this._btKinematicCharacter,e)}get upAxis(){return this._upAxis}set upAxis(t){this._upAxis=t;var r=e._btTempVector30;k._convertToBulletVec3(t,r,!1),l.Physics3D._bullet.btKinematicCharacterController_setUp(this._btKinematicCharacter,r)}_constructCharacter(){var t=l.Physics3D._bullet;this._btKinematicCharacter&&t.btKinematicCharacterController_destroy(this._btKinematicCharacter);var r=e._btTempVector30;t.btVector3_setValue(r,this._upAxis.x,this._upAxis.y,this._upAxis.z),this._btKinematicCharacter=t.btKinematicCharacterController_create(this._btColliderObject,this._colliderShape._btShape,this._stepHeight,r),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity}_onShapeChange(e){super._onShapeChange(e),this._constructCharacter()}_onAdded(){var e=l.Physics3D._bullet,t=e.btPairCachingGhostObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_setCollisionFlags(t,V.COLLISIONFLAGS_CHARACTER_OBJECT),this._btColliderObject=t,this._colliderShape&&this._constructCharacter(),super._onAdded()}_addToSimulation(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith)}_removeFromSimulation(){this._simulation._removeCharacter(this);var e=this._simulation._characters;e.splice(e.indexOf(this),1)}_cloneTo(e){super._cloneTo(e);var t=e;t.stepHeight=this._stepHeight,t.upAxis=this._upAxis,t.maxSlope=this._maxSlope,t.jumpSpeed=this._jumpSpeed,t.fallSpeed=this._fallSpeed,t.gravity=this._gravity}_onDestroy(){l.Physics3D._bullet.btKinematicCharacterController_destroy(this._btKinematicCharacter),super._onDestroy(),this._btKinematicCharacter=null}move(t){var r=e._btVector30,i=l.Physics3D._bullet;i.btVector3_setValue(r,-t.x,t.y,t.z),i.btKinematicCharacterController_setWalkDirection(this._btKinematicCharacter,r)}jump(t=null){var r=l.Physics3D._bullet,i=e._btVector30;t?(k._convertToBulletVec3(t,i,!0),r.btKinematicCharacterController_jump(this._btKinematicCharacter,i)):(r.btVector3_setValue(i,0,0,0),r.btKinematicCharacterController_jump(this._btKinematicCharacter,i))}}return e.UPAXIS_X=0,e.UPAXIS_Y=1,e.UPAXIS_Z=2,e})();class Y extends V{constructor(e,t){super(e,t),this._isTrigger=!1}get isTrigger(){return this._isTrigger}set isTrigger(e){this._isTrigger=e;var t=l.Physics3D._bullet;if(this._btColliderObject){var r=t.btCollisionObject_getCollisionFlags(this._btColliderObject);e?0==(r&V.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,r|V.COLLISIONFLAGS_NO_CONTACT_RESPONSE):0!=(r&V.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,r^V.COLLISIONFLAGS_NO_CONTACT_RESPONSE)}}_onAdded(){super._onAdded(),this.isTrigger=this._isTrigger}_cloneTo(e){super._cloneTo(e),e.isTrigger=this._isTrigger}}let j=(()=>{class e extends Y{constructor(e=u.COLLISIONFILTERGROUP_DEFAULTFILTER,t=u.COLLISIONFILTERGROUP_ALLFILTER){super(e,t),this._isKinematic=!1,this._mass=1,this._gravity=new a(0,-10,0),this._angularDamping=0,this._linearDamping=0,this._overrideGravity=!1,this._totalTorque=new a(0,0,0),this._totalForce=new a(0,0,0),this._linearVelocity=new a,this._angularVelocity=new a,this._linearFactor=new a(1,1,1),this._angularFactor=new a(1,1,1),this._detectCollisions=!0,this._controlBySimulation=!0}static __init__(){var t=l.Physics3D._bullet;e._btTempVector30=t.btVector3_create(0,0,0),e._btTempVector31=t.btVector3_create(0,0,0),e._btVector3Zero=t.btVector3_create(0,0,0),e._btInertia=t.btVector3_create(0,0,0),e._btImpulse=t.btVector3_create(0,0,0),e._btImpulseOffset=t.btVector3_create(0,0,0),e._btGravity=t.btVector3_create(0,0,0),e._btTransform0=t.btTransform_create()}get mass(){return this._mass}set mass(e){e=Math.max(e,1e-7),this._mass=e,this._isKinematic||this._updateMass(e)}get isKinematic(){return this._isKinematic}set isKinematic(t){this._isKinematic=t,this._controlBySimulation=!t;var r=l.Physics3D._bullet,i=!!(this._simulation&&this._enabled&&this._colliderShape);i&&this._removeFromSimulation();var n=this._btColliderObject,a=r.btCollisionObject_getCollisionFlags(n);t?(a|=V.COLLISIONFLAGS_KINEMATIC_OBJECT,r.btCollisionObject_setCollisionFlags(n,a),r.btCollisionObject_forceActivationState(this._btColliderObject,V.ACTIVATIONSTATE_DISABLE_DEACTIVATION),this._enableProcessCollisions=!1,this._updateMass(0)):((a&V.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(a^=V.COLLISIONFLAGS_KINEMATIC_OBJECT),r.btCollisionObject_setCollisionFlags(n,a),r.btCollisionObject_setActivationState(this._btColliderObject,V.ACTIVATIONSTATE_ACTIVE_TAG),this._enableProcessCollisions=!0,this._updateMass(this._mass));var s=e._btVector3Zero;r.btCollisionObject_setInterpolationLinearVelocity(n,s),r.btRigidBody_setLinearVelocity(n,s),r.btCollisionObject_setInterpolationAngularVelocity(n,s),r.btRigidBody_setAngularVelocity(n,s),i&&this._addToSimulation()}get linearDamping(){return this._linearDamping}set linearDamping(e){this._linearDamping=e,this._btColliderObject&&l.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,e,this._angularDamping)}get angularDamping(){return this._angularDamping}set angularDamping(e){this._angularDamping=e,this._btColliderObject&&l.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,this._linearDamping,e)}get overrideGravity(){return this._overrideGravity}set overrideGravity(t){this._overrideGravity=t;var r=l.Physics3D._bullet;if(this._btColliderObject){var i=r.btRigidBody_getFlags(this._btColliderObject);t?0==(i&e._BT_DISABLE_WORLD_GRAVITY)&&r.btRigidBody_setFlags(this._btColliderObject,i|e._BT_DISABLE_WORLD_GRAVITY):(i&e._BT_DISABLE_WORLD_GRAVITY)>0&&r.btRigidBody_setFlags(this._btColliderObject,i^e._BT_DISABLE_WORLD_GRAVITY)}}get gravity(){return this._gravity}set gravity(t){this._gravity=t;var r=l.Physics3D._bullet;r.btVector3_setValue(e._btGravity,-t.x,t.y,t.z),r.btRigidBody_setGravity(this._btColliderObject,e._btGravity)}get totalForce(){if(this._btColliderObject){var e=l.Physics3D._bullet.btRigidBody_getTotalForce(this._btColliderObject);return k._convertToLayaVec3(e,this._totalForce,!0),this._totalForce}return null}get linearFactor(){return this._linearFactor}set linearFactor(t){this._linearFactor=t;var r=e._btTempVector30;k._convertToBulletVec3(t,r,!1),l.Physics3D._bullet.btRigidBody_setLinearFactor(this._btColliderObject,r)}get linearVelocity(){return this._btColliderObject&&k._convertToLayaVec3(l.Physics3D._bullet.btRigidBody_getLinearVelocity(this._btColliderObject),this._linearVelocity,!0),this._linearVelocity}set linearVelocity(t){if(this._linearVelocity=t,this._btColliderObject){var r=e._btTempVector30;k._convertToBulletVec3(t,r,!0),this.isSleeping&&this.wakeUp(),l.Physics3D._bullet.btRigidBody_setLinearVelocity(this._btColliderObject,r)}}get angularFactor(){return this._angularFactor}set angularFactor(t){this._angularFactor=t;var r=e._btTempVector30;k._convertToBulletVec3(t,r,!1),l.Physics3D._bullet.btRigidBody_setAngularFactor(this._btColliderObject,r)}get angularVelocity(){return this._btColliderObject&&k._convertToLayaVec3(l.Physics3D._bullet.btRigidBody_getAngularVelocity(this._btColliderObject),this._angularVelocity,!0),this._angularVelocity}set angularVelocity(t){if(this._angularVelocity=t,this._btColliderObject){var r=e._btTempVector30;k._convertToBulletVec3(t,r,!0),this.isSleeping&&this.wakeUp(),l.Physics3D._bullet.btRigidBody_setAngularVelocity(this._btColliderObject,r)}}get totalTorque(){if(this._btColliderObject){var e=l.Physics3D._bullet.btRigidBody_getTotalTorque(this._btColliderObject);return k._convertToLayaVec3(e,this._totalTorque,!0),this._totalTorque}return null}get detectCollisions(){return this._detectCollisions}set detectCollisions(e){this._detectCollisions!==e&&(this._detectCollisions=e,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,e?this._canCollideWith:0)))}get isSleeping(){return!!this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_getActivationState(this._btColliderObject)===V.ACTIVATIONSTATE_ISLAND_SLEEPING}get sleepLinearVelocity(){return l.Physics3D._bullet.btRigidBody_getLinearSleepingThreshold(this._btColliderObject)}set sleepLinearVelocity(e){var t=l.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,e,t.btRigidBody_getAngularSleepingThreshold(this._btColliderObject))}get sleepAngularVelocity(){return l.Physics3D._bullet.btRigidBody_getAngularSleepingThreshold(this._btColliderObject)}set sleepAngularVelocity(e){var t=l.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,t.btRigidBody_getLinearSleepingThreshold(this._btColliderObject),e)}get btColliderObject(){return this._btColliderObject}set constaintRigidbodyA(e){this._constaintRigidbodyA=e}get constaintRigidbodyA(){return this._constaintRigidbodyA}set constaintRigidbodyB(e){this._constaintRigidbodyB=e}get constaintRigidbodyB(){return this._constaintRigidbodyB}_updateMass(t){if(this._btColliderObject&&this._colliderShape){var r=l.Physics3D._bullet;r.btCollisionShape_calculateLocalInertia(this._colliderShape._btShape,t,e._btInertia),r.btRigidBody_setMassProps(this._btColliderObject,t,e._btInertia),r.btRigidBody_updateInertiaTensor(this._btColliderObject)}}_onScaleChange(e){super._onScaleChange(e),this._updateMass(this._isKinematic?0:this._mass)}_derivePhysicsTransformation(t){var r=l.Physics3D._bullet,i=this._btColliderObject,n=r.btCollisionObject_getWorldTransform(i),a=e._btTransform0;r.btTransform_equal(a,n),this._innerDerivePhysicsTransformation(a,t),r.btRigidBody_setCenterOfMassTransform(i,a)}_onAdded(){var t=l.Physics3D._bullet,r=t.layaMotionState_create();t.layaMotionState_set_rigidBodyID(r,this._id),this._btLayaMotionState=r;var i=t.btRigidBodyConstructionInfo_create(0,r,null,e._btVector3Zero),n=t.btRigidBody_create(i);t.btCollisionObject_setUserIndex(n,this.id),this._btColliderObject=n,super._onAdded(),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,t.btRigidBodyConstructionInfo_destroy(i)}_onEnable(){super._onEnable(),this._constaintRigidbodyA&&this._constaintRigidbodyA.connectedBody._simulation&&(this._constaintRigidbodyA._createConstraint(),this._constaintRigidbodyA._onEnable()),this._constaintRigidbodyB&&this._constaintRigidbodyB.ownBody._simulation&&(this._constaintRigidbodyB._createConstraint(),this._constaintRigidbodyB._onEnable())}_onShapeChange(e){if(super._onShapeChange(e),this._isKinematic)this._updateMass(0);else{var t=l.Physics3D._bullet;t.btRigidBody_setCenterOfMassTransform(this._btColliderObject,t.btCollisionObject_getWorldTransform(this._btColliderObject)),this._updateMass(this._mass)}}_parse(e){if(null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),null!=e.mass&&(this.mass=e.mass),null!=e.linearDamping&&(this.linearDamping=e.linearDamping),null!=e.angularDamping&&(this.angularDamping=e.angularDamping),null!=e.overrideGravity&&(this.overrideGravity=e.overrideGravity),null!=e.linearFactor){var t=this.linearFactor;t.fromArray(e.linearFactor),this.linearFactor=t}if(null!=e.angularFactor){var r=this.angularFactor;r.fromArray(e.angularFactor),this.angularFactor=r}e.gravity&&(this.gravity.fromArray(e.gravity),this.gravity=this.gravity),super._parse(e),this._parseShape(e.shapes),null!=e.isKinematic&&(this._isKinematic=e.isKinematic)}_onDestroy(){l.Physics3D._bullet.btMotionState_destroy(this._btLayaMotionState),super._onDestroy(),this._btLayaMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null,this.constaintRigidbodyA&&this.constaintRigidbodyA._breakConstrained(),this.constaintRigidbodyB&&(this.constaintRigidbodyB.connectedBody=null,this.constaintRigidbodyB._onDisable())}_addToSimulation(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0)}_removeFromSimulation(){this._simulation._removeRigidBody(this)}_cloneTo(e){super._cloneTo(e);var t=e;t.isKinematic=this._isKinematic,t.mass=this._mass,t.gravity=this._gravity,t.angularDamping=this._angularDamping,t.linearDamping=this._linearDamping,t.overrideGravity=this._overrideGravity,t.linearVelocity=this._linearVelocity,t.angularVelocity=this._angularVelocity,t.linearFactor=this._linearFactor,t.angularFactor=this._angularFactor,t.detectCollisions=this._detectCollisions}applyForce(t,r=null){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var i=l.Physics3D._bullet,n=e._btTempVector30;if(i.btVector3_setValue(n,-t.x,t.y,t.z),r){var a=e._btTempVector31;i.btVector3_setValue(a,-r.x,r.y,r.z),i.btRigidBody_applyForce(this._btColliderObject,n,a)}else i.btRigidBody_applyCentralForce(this._btColliderObject,n)}applyTorque(t){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=l.Physics3D._bullet,i=e._btTempVector30;r.btVector3_setValue(i,-t.x,t.y,t.z),r.btRigidBody_applyTorque(this._btColliderObject,i)}applyImpulse(t,r=null){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var i=l.Physics3D._bullet;i.btVector3_setValue(e._btImpulse,-t.x,t.y,t.z),r?(i.btVector3_setValue(e._btImpulseOffset,-r.x,r.y,r.z),i.btRigidBody_applyImpulse(this._btColliderObject,e._btImpulse,e._btImpulseOffset)):i.btRigidBody_applyCentralImpulse(this._btColliderObject,e._btImpulse)}applyTorqueImpulse(t){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=l.Physics3D._bullet,i=e._btTempVector30;r.btVector3_setValue(i,-t.x,t.y,t.z),r.btRigidBody_applyTorqueImpulse(this._btColliderObject,i)}wakeUp(){this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_activate(this._btColliderObject,!1)}clearForces(){var t=this._btColliderObject;if(null==t)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=l.Physics3D._bullet;r.btRigidBody_clearForces(t);var i=e._btVector3Zero;r.btCollisionObject_setInterpolationLinearVelocity(t,i),r.btRigidBody_setLinearVelocity(t,i),r.btCollisionObject_setInterpolationAngularVelocity(t,i),r.btRigidBody_setAngularVelocity(t,i)}}return e.TYPE_STATIC=0,e.TYPE_DYNAMIC=1,e.TYPE_KINEMATIC=2,e._BT_DISABLE_WORLD_GRAVITY=1,e._BT_ENABLE_GYROPSCOPIC_FORCE=2,e})(),Z=(()=>{class e{static __bulletinit__(){this._bullet=window.Physics3D,this._bullet&&(y.__init__(),L.__init__(),D.__init__(),V.__init__(),H.__init__(),M.__init__(),b.__init__(),X.__init__(),j.__init__())}static __cannoninit__(){this._cannon=window.CANNON,this._cannon&&(c.__init__(),T.__init__(),A.__init__(),m.__init__(),C.__init__())}}return e._bullet=null,e._cannon=null,e._enablePhysics=!1,e})();class q{constructor(){this.flags=0,this.maxSubSteps=3,this.fixedTimeStep=1/60,this.contactEquationRelaxation=10,this.contactEquationStiffness=1e6}}let Q=(()=>{class t{constructor(){this._defaultPhysicsMemory=16,this._maxLightCount=32,this._lightClusterCount=new a(12,12,12),this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0,this.enableMultiLight=!0,this.octreeCulling=!1,this.octreeInitialSize=64,this.octreeInitialCenter=new a(0,0,0),this.octreeMinNodeSize=2,this.octreeLooseness=1.25,this.debugFrustumCulling=!1,this.pbrRenderQuality=e.PBRRenderQuality.High,this.isUseCannonPhysicsEngine=!1,this._maxAreaLightCountPerClusterAverage=Math.min(4*Math.floor(2048/this._lightClusterCount.z-1),this._maxLightCount)}static get useCannonPhysics(){return t._config.isUseCannonPhysicsEngine}static set useCannonPhysics(e){t._config.isUseCannonPhysicsEngine=e,e&&(Z.__cannoninit__(),l.Scene3D.cannonPhysicsSettings||(l.Scene3D.cannonPhysicsSettings=new q))}get defaultPhysicsMemory(){return this._defaultPhysicsMemory}set defaultPhysicsMemory(e){if(e<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=e}get maxLightCount(){return this._maxLightCount}set maxLightCount(e){e>2048?(this._maxLightCount=2048,console.warn("Config3D: maxLightCount must less equal 2048.")):this._maxLightCount=e}get lightClusterCount(){return this._lightClusterCount}set lightClusterCount(e){e.x>128||e.y>128||e.z>128?(this._lightClusterCount.setValue(Math.min(e.x,128),Math.min(e.y,128),Math.min(e.z,128)),console.warn("Config3D: lightClusterCount X and YZ must less equal 128.")):e.cloneTo(this._lightClusterCount);var t=4*Math.floor(2048/this._lightClusterCount.z-1);t<this._maxLightCount&&console.warn("Config3D: if the area light(PointLightSpotLight) count is large than "+t+",maybe the far away culster will ingonre some light."),this._maxAreaLightCountPerClusterAverage=Math.min(t,this._maxLightCount)}cloneTo(e){var t=e;t._defaultPhysicsMemory=this._defaultPhysicsMemory,t._editerEnvironment=this._editerEnvironment,t.isAntialias=this.isAntialias,t.isAlpha=this.isAlpha,t.premultipliedAlpha=this.premultipliedAlpha,t.isStencil=this.isStencil,t.octreeCulling=this.octreeCulling,this.octreeInitialCenter.cloneTo(t.octreeInitialCenter),t.octreeInitialSize=this.octreeInitialSize,t.octreeMinNodeSize=this.octreeMinNodeSize,t.octreeLooseness=this.octreeLooseness,t.debugFrustumCulling=this.debugFrustumCulling,t.maxLightCount=this.maxLightCount,t.enableMultiLight=this.enableMultiLight;var r=t.lightClusterCount;this.lightClusterCount.cloneTo(r),t.lightClusterCount=r,t.pbrRenderQuality=this.pbrRenderQuality}clone(){var e=new t;return this.cloneTo(e),e}}return t._config=new t,t})();window.Config3D=Q;class K{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_joinOwnerPath(e){return this._ownerPath.join(e)}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_joinProperty(e){return this._propertys.join(e)}_setKeyframeCount(e){this._keyFrames.length=e}_setKeyframeByIndex(e,t){this._keyFrames[e]=t}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}getKeyframeByIndex(e){return this._keyFrames[e]}}class J{constructor(){}}class ${constructor(){}cloneTo(e){e.time=this.time}clone(){var e=new $;return this.cloneTo(e),e}}class ee extends ${constructor(){super()}cloneTo(e){super.cloneTo(e);var t=e;t.inTangent=this.inTangent,t.outTangent=this.outTangent,t.value=this.value}}class te extends ${constructor(){super(),this.inTangent=new n,this.outTangent=new n,this.value=new _}cloneTo(e){super.cloneTo(e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}class re extends ${constructor(){super(),this.inTangent=new a,this.outTangent=new a,this.value=new a}cloneTo(e){super.cloneTo(e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}let ie=(()=>{class e{static READ_DATA(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()}static READ_BLOCK(){for(var t=e._BLOCK.count=e._reader.getUint16(),r=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],n=0;n<t;n++)r.push(e._reader.getUint32()),i.push(e._reader.getUint32())}static READ_STRINGS(){var t=e._reader.getUint32(),r=e._reader.getUint16(),i=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var n=0;n<r;n++)e._strings[n]=e._reader.readUTFString();e._reader.pos=i}static parse(t,r){e._animationClip=t,e._reader=r;r.__getBuffer();e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var i=0,n=e._BLOCK.count;i<n;i++){var a=r.getUint16(),s=e._strings[a],o=e["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call(null)}}static READ_ANIMATIONS(){var r,i,n,a=e._reader,s=(a.__getBuffer(),[]),o=a.getUint16();for(s.length=o,r=0;r<o;r++)s[r]=a.getFloat32();var l=e._animationClip;l.name=e._strings[a.getUint16()];var _=l._duration=a.getFloat32();l.islooping=!!a.getByte(),l._frameRate=a.getInt16();var h=a.getInt16(),c=l._nodes;c.count=h;var d=l._nodesMap={},u=l._nodesDic={};for(r=0;r<h;r++){n=new K,c.setNodeByIndex(r,n),n._indexInList=r;var m=n.type=a.getUint8(),f=a.getUint16();for(n._setOwnerPathCount(f),i=0;i<f;i++)n._setOwnerPathByIndex(i,e._strings[a.getUint16()]);var T=n._joinOwnerPath("/"),E=d[T];E||(d[T]=E=[]),E.push(n),n.propertyOwner=e._strings[a.getUint16()];var p=a.getUint16();for(n._setPropertyCount(p),i=0;i<p;i++)n._setPropertyByIndex(i,e._strings[a.getUint16()]);var g=T+"."+n.propertyOwner+"."+n._joinProperty(".");u[g]=n,n.fullPath=g;var S=a.getUint16();for(n._setKeyframeCount(S),i=0;i<S;i++)switch(m){case 0:var R=new ee;n._setKeyframeByIndex(i,R),R.time=s[a.getUint16()],R.inTangent=a.getFloat32(),R.outTangent=a.getFloat32(),R.value=a.getFloat32();break;case 1:case 3:case 4:var v=new re;if(n._setKeyframeByIndex(i,v),v.time=s[a.getUint16()],t.Render.supportWebGLPlusAnimation){for(var A=v.data=new Float32Array(9),I=0;I<3;I++)A[I]=a.getFloat32();for(I=0;I<3;I++)A[3+I]=a.getFloat32();for(I=0;I<3;I++)A[6+I]=a.getFloat32()}else{var x=v.inTangent,C=v.outTangent,L=v.value;x.x=a.getFloat32(),x.y=a.getFloat32(),x.z=a.getFloat32(),C.x=a.getFloat32(),C.y=a.getFloat32(),C.z=a.getFloat32(),L.x=a.getFloat32(),L.y=a.getFloat32(),L.z=a.getFloat32()}break;case 2:var y=new te;if(n._setKeyframeByIndex(i,y),y.time=s[a.getUint16()],t.Render.supportWebGLPlusAnimation){for(A=y.data=new Float32Array(12),I=0;I<4;I++)A[I]=a.getFloat32();for(I=0;I<4;I++)A[4+I]=a.getFloat32();for(I=0;I<4;I++)A[8+I]=a.getFloat32()}else{var D=y.inTangent,M=y.outTangent,O=y.value;D.x=a.getFloat32(),D.y=a.getFloat32(),D.z=a.getFloat32(),D.w=a.getFloat32(),M.x=a.getFloat32(),M.y=a.getFloat32(),M.z=a.getFloat32(),M.w=a.getFloat32(),O.x=a.getFloat32(),O.y=a.getFloat32(),O.z=a.getFloat32(),O.w=a.getFloat32()}break;default:throw"AnimationClipParser03:unknown type."}}var N=a.getUint16();for(r=0;r<N;r++){var b,P=new J;P.time=Math.min(_,a.getFloat32()),P.eventName=e._strings[a.getUint16()];var w=a.getUint16();for(w>0&&(P.params=b=[]),i=0;i<w;i++){switch(a.getByte()){case 0:b.push(!!a.getByte());break;case 1:b.push(a.getInt32());break;case 2:b.push(a.getFloat32());break;case 3:b.push(e._strings[a.getUint16()]);break;default:throw new Error("unknown type.")}}l.addEvent(P)}}}return e._strings=[],e._BLOCK={count:0},e._DATA={offset:0,size:0},e})(),ne=(()=>{class e{static __init__(){for(var t=0;t<256;++t){var r=t-127;r<-27?(e._baseTable[0|t]=0,e._baseTable[256|t]=32768,e._shiftTable[0|t]=24,e._shiftTable[256|t]=24):r<-14?(e._baseTable[0|t]=1024>>-r-14,e._baseTable[256|t]=1024>>-r-14|32768,e._shiftTable[0|t]=-r-1,e._shiftTable[256|t]=-r-1):r<=15?(e._baseTable[0|t]=r+15<<10,e._baseTable[256|t]=r+15<<10|32768,e._shiftTable[0|t]=13,e._shiftTable[256|t]=13):r<128?(e._baseTable[0|t]=31744,e._baseTable[256|t]=64512,e._shiftTable[0|t]=24,e._shiftTable[256|t]=24):(e._baseTable[0|t]=31744,e._baseTable[256|t]=64512,e._shiftTable[0|t]=13,e._shiftTable[256|t]=13)}for(e._mantissaTable[0]=0,t=1;t<1024;++t){var i=t<<13;for(r=0;0==(8388608&i);)r-=8388608,i<<=1;i&=-8388609,r+=947912704,e._mantissaTable[t]=i|r}for(t=1024;t<2048;++t)e._mantissaTable[t]=939524096+(t-1024<<13);for(e._exponentTable[0]=0,t=1;t<31;++t)e._exponentTable[t]=t<<23;for(e._exponentTable[31]=1199570944,e._exponentTable[32]=2147483648,t=33;t<63;++t)e._exponentTable[t]=2147483648+(t-32<<23);for(e._exponentTable[63]=3347054592,e._offsetTable[0]=0,t=1;t<64;++t)e._offsetTable[t]=32===t?0:1024}static roundToFloat16Bits(t){e._floatView[0]=t;var r=e._uint32View[0],i=r>>23&511;return e._baseTable[i]+((8388607&r)>>e._shiftTable[i])}static convertToNumber(t){var r=t>>10;return e._uint32View[0]=e._mantissaTable[e._offsetTable[r]+(1023&t)]+e._exponentTable[r],e._floatView[0]}}return e._buffer=new ArrayBuffer(4),e._floatView=new Float32Array(e._buffer),e._uint32View=new Uint32Array(e._buffer),e._baseTable=new Uint32Array(512),e._shiftTable=new Uint32Array(512),e._mantissaTable=new Uint32Array(2048),e._exponentTable=new Uint32Array(64),e._offsetTable=new Uint32Array(64),e})(),ae=(()=>{class e{static READ_DATA(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()}static READ_BLOCK(){for(var t=e._BLOCK.count=e._reader.getUint16(),r=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],n=0;n<t;n++)r.push(e._reader.getUint32()),i.push(e._reader.getUint32())}static READ_STRINGS(){var t=e._reader.getUint32(),r=e._reader.getUint16(),i=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var n=0;n<r;n++)e._strings[n]=e._reader.readUTFString();e._reader.pos=i}static parse(t,r,i){e._animationClip=t,e._reader=r,e._version=i,e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var n=0,a=e._BLOCK.count;n<a;n++){var s=r.getUint16(),o=e._strings[s],l=e["READ_"+o];if(null==l)throw new Error("model file err,no this function:"+s+" "+o);l.call(null)}e._version=null,e._reader=null,e._animationClip=null}static READ_ANIMATIONS(){var r,i,n,a=e._reader,s=(a.__getBuffer(),[]),o=a.getUint16();for(s.length=o,r=0;r<o;r++)s[r]=a.getFloat32();var l=e._animationClip;l.name=e._strings[a.getUint16()];var _=l._duration=a.getFloat32();l.islooping=!!a.getByte(),l._frameRate=a.getInt16();var h=a.getInt16(),c=l._nodes;c.count=h;var d=l._nodesMap={},u=l._nodesDic={};for(r=0;r<h;r++){n=new K,c.setNodeByIndex(r,n),n._indexInList=r;var m=n.type=a.getUint8(),f=a.getUint16();for(n._setOwnerPathCount(f),i=0;i<f;i++)n._setOwnerPathByIndex(i,e._strings[a.getUint16()]);var T=n._joinOwnerPath("/"),E=d[T];E||(d[T]=E=[]),E.push(n),n.propertyOwner=e._strings[a.getUint16()];var p=a.getUint16();for(n._setPropertyCount(p),i=0;i<p;i++)n._setPropertyByIndex(i,e._strings[a.getUint16()]);var g=T+"."+n.propertyOwner+"."+n._joinProperty(".");u[g]=n,n.fullPath=g;var S=a.getUint16();switch(n._setKeyframeCount(S),e._version){case"LAYAANIMATION:04":for(i=0;i<S;i++)switch(m){case 0:var R=new ee;n._setKeyframeByIndex(i,R),R.time=s[a.getUint16()],R.inTangent=a.getFloat32(),R.outTangent=a.getFloat32(),R.value=a.getFloat32();break;case 1:case 3:case 4:var v=new re;if(n._setKeyframeByIndex(i,v),v.time=s[a.getUint16()],t.Render.supportWebGLPlusAnimation){for(var A=v.data=new Float32Array(9),I=0;I<3;I++)A[I]=a.getFloat32();for(I=0;I<3;I++)A[3+I]=a.getFloat32();for(I=0;I<3;I++)A[6+I]=a.getFloat32()}else{var x=v.inTangent,C=v.outTangent,L=v.value;x.x=a.getFloat32(),x.y=a.getFloat32(),x.z=a.getFloat32(),C.x=a.getFloat32(),C.y=a.getFloat32(),C.z=a.getFloat32(),L.x=a.getFloat32(),L.y=a.getFloat32(),L.z=a.getFloat32()}break;case 2:var y=new te;if(n._setKeyframeByIndex(i,y),y.time=s[a.getUint16()],t.Render.supportWebGLPlusAnimation){for(A=y.data=new Float32Array(12),I=0;I<4;I++)A[I]=a.getFloat32();for(I=0;I<4;I++)A[4+I]=a.getFloat32();for(I=0;I<4;I++)A[8+I]=a.getFloat32()}else{var D=y.inTangent,M=y.outTangent,O=y.value;D.x=a.getFloat32(),D.y=a.getFloat32(),D.z=a.getFloat32(),D.w=a.getFloat32(),M.x=a.getFloat32(),M.y=a.getFloat32(),M.z=a.getFloat32(),M.w=a.getFloat32(),O.x=a.getFloat32(),O.y=a.getFloat32(),O.z=a.getFloat32(),O.w=a.getFloat32()}break;default:throw"AnimationClipParser04:unknown type."}break;case"LAYAANIMATION:COMPRESSION_04":for(i=0;i<S;i++)switch(m){case 0:R=new ee,n._setKeyframeByIndex(i,R),R.time=s[a.getUint16()],R.inTangent=ne.convertToNumber(a.getUint16()),R.outTangent=ne.convertToNumber(a.getUint16()),R.value=ne.convertToNumber(a.getUint16());break;case 1:case 3:case 4:if(v=new re,n._setKeyframeByIndex(i,v),v.time=s[a.getUint16()],t.Render.supportWebGLPlusAnimation){for(A=v.data=new Float32Array(9),I=0;I<3;I++)A[I]=ne.convertToNumber(a.getUint16());for(I=0;I<3;I++)A[3+I]=ne.convertToNumber(a.getUint16());for(I=0;I<3;I++)A[6+I]=ne.convertToNumber(a.getUint16())}else x=v.inTangent,C=v.outTangent,L=v.value,x.x=ne.convertToNumber(a.getUint16()),x.y=ne.convertToNumber(a.getUint16()),x.z=ne.convertToNumber(a.getUint16()),C.x=ne.convertToNumber(a.getUint16()),C.y=ne.convertToNumber(a.getUint16()),C.z=ne.convertToNumber(a.getUint16()),L.x=ne.convertToNumber(a.getUint16()),L.y=ne.convertToNumber(a.getUint16()),L.z=ne.convertToNumber(a.getUint16());break;case 2:if(y=new te,n._setKeyframeByIndex(i,y),y.time=s[a.getUint16()],t.Render.supportWebGLPlusAnimation){for(A=y.data=new Float32Array(12),I=0;I<4;I++)A[I]=ne.convertToNumber(a.getUint16());for(I=0;I<4;I++)A[4+I]=ne.convertToNumber(a.getUint16());for(I=0;I<4;I++)A[8+I]=ne.convertToNumber(a.getUint16())}else D=y.inTangent,M=y.outTangent,O=y.value,D.x=ne.convertToNumber(a.getUint16()),D.y=ne.convertToNumber(a.getUint16()),D.z=ne.convertToNumber(a.getUint16()),D.w=ne.convertToNumber(a.getUint16()),M.x=ne.convertToNumber(a.getUint16()),M.y=ne.convertToNumber(a.getUint16()),M.z=ne.convertToNumber(a.getUint16()),M.w=ne.convertToNumber(a.getUint16()),O.x=ne.convertToNumber(a.getUint16()),O.y=ne.convertToNumber(a.getUint16()),O.z=ne.convertToNumber(a.getUint16()),O.w=ne.convertToNumber(a.getUint16());break;default:throw"AnimationClipParser04:unknown type."}}}var N=a.getUint16();for(r=0;r<N;r++){var b,P=new J;P.time=Math.min(_,a.getFloat32()),P.eventName=e._strings[a.getUint16()];var w=a.getUint16();for(w>0&&(P.params=b=[]),i=0;i<w;i++){switch(a.getByte()){case 0:b.push(!!a.getByte());break;case 1:b.push(a.getInt32());break;case 2:b.push(a.getFloat32());break;case 3:b.push(e._strings[a.getUint16()]);break;default:throw new Error("unknown type.")}}l.addEvent(P)}}}return e._strings=[],e._BLOCK={count:0},e._DATA={offset:0,size:0},e})();class se{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}let oe=(()=>{class e extends t.Resource{constructor(){super(),this._nodes=new se,this._animationEvents=[]}static _parse(r,i=null,n=null){var a=new e,s=new t.Byte(r),o=s.readUTFString();switch(o){case"LAYAANIMATION:03":ie.parse(a,s);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":ae.parse(a,s,o);break;default:throw"unknown animationClip version."}return a}static load(r,i){t.ILaya.loader.create(r,i,null,e.ANIMATIONCLIP)}duration(){return this._duration}_hermiteInterpolate(e,t,r,i){var n=e.outTangent,a=t.inTangent;if(Number.isFinite(n)&&Number.isFinite(a)){var s=r*r,o=s*r,l=o-2*s+r,_=o-s,h=-2*o+3*s;return(2*o-3*s+1)*e.value+l*n*i+_*a*i+h*t.value}return e.value}_hermiteInterpolateVector3(e,t,r,i,n){var a=e.value,s=e.outTangent,o=t.value,l=t.inTangent,_=r*r,h=_*r,c=2*h-3*_+1,d=h-2*_+r,u=h-_,m=-2*h+3*_,f=s.x,T=l.x;Number.isFinite(f)&&Number.isFinite(T)?n.x=c*a.x+d*f*i+u*T*i+m*o.x:n.x=a.x,f=s.y,T=l.y,Number.isFinite(f)&&Number.isFinite(T)?n.y=c*a.y+d*f*i+u*T*i+m*o.y:n.y=a.y,f=s.z,T=l.z,Number.isFinite(f)&&Number.isFinite(T)?n.z=c*a.z+d*f*i+u*T*i+m*o.z:n.z=a.z}_hermiteInterpolateQuaternion(e,t,r,i,n){var a=e.value,s=e.outTangent,o=t.value,l=t.inTangent,_=r*r,h=_*r,c=2*h-3*_+1,d=h-2*_+r,u=h-_,m=-2*h+3*_,f=s.x,T=l.x;Number.isFinite(f)&&Number.isFinite(T)?n.x=c*a.x+d*f*i+u*T*i+m*o.x:n.x=a.x,f=s.y,T=l.y,Number.isFinite(f)&&Number.isFinite(T)?n.y=c*a.y+d*f*i+u*T*i+m*o.y:n.y=a.y,f=s.z,T=l.z,Number.isFinite(f)&&Number.isFinite(T)?n.z=c*a.z+d*f*i+u*T*i+m*o.z:n.z=a.z,f=s.w,T=l.w,Number.isFinite(f)&&Number.isFinite(T)?n.w=c*a.w+d*f*i+u*T*i+m*o.w:n.w=a.w}_evaluateClipDatasRealTime(t,r,i,n,a,s){for(var o=0,l=t.count;o<l;o++){var h,c=t.getNodeByIndex(o),d=c.type,u=c._keyFrames,m=u.length,f=i[o];if(a)for(-1!==f&&r<u[f].time&&(f=-1,i[o]=f),h=f+1;h<m&&!(u[h].time>r);)f++,h++,i[o]=f;else for((h=f+1)!==m&&r>u[h].time&&(f=m-1,i[o]=f),h=f+1;f>-1&&!(u[f].time<r);)f--,h--,i[o]=f;var T=h===m;switch(d){case 0:if(-1!==f){var E=u[f];if(T)s[o]=E.value;else{var p,g=u[h],S=g.time-E.time;p=0!==S?(r-E.time)/S:0,s[o]=this._hermiteInterpolate(E,g,p,S)}}else s[o]=u[0].value;n&&(s[o]=s[o]-u[0].value);break;case 1:case 4:var R=s[o];if(this._evaluateFrameNodeVector3DatasRealTime(u,f,T,r,R),n){var v=u[0].value;R.x-=v.x,R.y-=v.y,R.z-=v.z}break;case 2:var A=s[o];if(this._evaluateFrameNodeQuaternionDatasRealTime(u,f,T,r,A),n){var I=e._tempQuaternion0,x=u[0].value;k.quaternionConjugate(x,I),_.multiply(I,A,A)}break;case 3:R=s[o],this._evaluateFrameNodeVector3DatasRealTime(u,f,T,r,R),n&&(v=u[0].value,R.x/=v.x,R.y/=v.y,R.z/=v.z);break;default:throw"AnimationClip:unknown node type."}}}_evaluateClipDatasRealTimeForNative(e,r,i,n){t.LayaGL.instance.evaluateClipDatasRealTime(e._nativeObj,r,i,n)}_evaluateFrameNodeVector3DatasRealTime(e,t,r,i,n){if(-1!==t){var a=e[t];if(r){var s=a.value;n.x=s.x,n.y=s.y,n.z=s.z}else{var o,l=e[t+1],_=a.time,h=l.time-_;o=0!==h?(i-_)/h:0,this._hermiteInterpolateVector3(a,l,o,h,n)}}else{var c=e[0].value;n.x=c.x,n.y=c.y,n.z=c.z}}_evaluateFrameNodeQuaternionDatasRealTime(e,t,r,i,n){if(-1!==t){var a=e[t];if(r){var s=a.value;n.x=s.x,n.y=s.y,n.z=s.z,n.w=s.w}else{var o,l=e[t+1],_=a.time,h=l.time-_;o=0!==h?(i-_)/h:0,this._hermiteInterpolateQuaternion(a,l,o,h,n)}}else{var c=e[0].value;n.x=c.x,n.y=c.y,n.z=c.z,n.w=c.w}}_binarySearchEventIndex(e){for(var t,r=0,i=this._animationEvents.length-1;r<=i;){t=Math.floor((r+i)/2);var n=this._animationEvents[t].time;if(n==e)return t;n>e?i=t-1:r=t+1}return r}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}_disposeResource(){this._nodes=null,this._nodesMap=null}}return e.ANIMATIONCLIP="ANIMATIONCLIP",e._tempQuaternion0=new _,e})();class le{constructor(){this._currentState=null}get normalizedTime(){return this._normalizedTime}get duration(){return this._duration}get animatorState(){return this._currentState}_resetPlayState(e){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._playEventIndex=0,this._lastIsFront=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._normalizedTime=this._normalizedTime,e._normalizedPlayTime=this._normalizedPlayTime,e._playEventIndex=this._playEventIndex,e._lastIsFront=this._lastIsFront}}let _e=(()=>{class e{constructor(t){this._defaultState=null,this._referenceCount=0,this._playType=-1,this._crossDuration=-1,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this._statesMap={},this._states=[],this._playStateInfo=new le,this._crossPlayStateInfo=new le,this.blendingMode=e.BLENDINGMODE_OVERRIDE,this.defaultWeight=1,this.playOnWake=!0,this.name=t}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e,this._statesMap[e.name]=e}_removeClip(e,t,r,i){var n=i._clip,a=e[r];if(e.splice(r,1),delete t[i.name],this._animator){var s=n._nodes,o=a._nodeOwners;n._removeReference();for(var l=0,_=s.count;l<_;l++)this._animator._removeKeyframeNodeOwner(o,s.getNodeByIndex(l))}}_getReferenceCount(){return this._referenceCount}_addReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getAnimatorState(e){var t=this._statesMap[e];return t||null}addState(e){var t=e.name;if(this._statesMap[t])throw"AnimatorControllerLayer:this stat's name has exist.";this._statesMap[t]=e,this._states.push(e),this._animator&&(e._clip._addReference(),this._animator._getOwnersByClip(e))}removeState(e){for(var t=this._states,r=-1,i=0,n=t.length;i<n;i++)if(t[i]===e){r=i;break}-1!==r&&this._removeClip(t,this._statesMap,r,e)}destroy(){this._clearReference(),this._statesMap=null,this._states=null,this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null}cloneTo(e){var t=e;t.name=this.name,t.blendingMode=this.blendingMode,t.defaultWeight=this.defaultWeight,t.playOnWake=this.playOnWake}clone(){var t=new e(this.name);return this.cloneTo(t),t}}return e.BLENDINGMODE_OVERRIDE=0,e.BLENDINGMODE_ADDTIVE=1,e})(),he=(()=>{class e{constructor(e=0,t=0,r=0,i=0){var n=this.elements=new Float32Array(4);n[0]=e,n[1]=t,n[2]=r,n[3]=i}get x(){return this.elements[0]}set x(e){this.elements[0]=e}get y(){return this.elements[1]}set y(e){this.elements[1]=e}get z(){return this.elements[2]}set z(e){this.elements[2]=e}get w(){return this.elements[3]}set w(e){this.elements[3]=e}fromArray(e,t=0){this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}cloneTo(e){var t=e.elements,r=this.elements;t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3]}clone(){var t=new e;return this.cloneTo(t),t}static lerp(e,t,r,i){var n=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],_=a[2],h=a[3];n[0]=o+r*(s[0]-o),n[1]=l+r*(s[1]-l),n[2]=_+r*(s[2]-_),n[3]=h+r*(s[3]-h)}static transformByM4x4(e,t,r){var i=e.elements,n=i[0],a=i[1],s=i[2],o=i[3],l=t.elements,_=r.elements;_[0]=n*l[0]+a*l[4]+s*l[8]+o*l[12],_[1]=n*l[1]+a*l[5]+s*l[9]+o*l[13],_[2]=n*l[2]+a*l[6]+s*l[10]+o*l[14],_[3]=n*l[3]+a*l[7]+s*l[11]+o*l[15]}static equals(e,t){var i=e.elements,n=t.elements;return r.nearEqual(Math.abs(i[0]),Math.abs(n[0]))&&r.nearEqual(Math.abs(i[1]),Math.abs(n[1]))&&r.nearEqual(Math.abs(i[2]),Math.abs(n[2]))&&r.nearEqual(Math.abs(i[3]),Math.abs(n[3]))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var r=e.elements,i=t.elements,n=e.length();n>0&&(i[0]=r[0]*n,i[1]=r[1]*n,i[2]=r[2]*n,i[3]=r[3]*n)}static add(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]+a[0],i[1]=n[1]+a[1],i[2]=n[2]+a[2],i[3]=n[3]+a[3]}static subtract(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]-a[0],i[1]=n[1]-a[1],i[2]=n[2]-a[2],i[3]=n[3]-a[3]}static multiply(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]*a[0],i[1]=n[1]*a[1],i[2]=n[2]*a[2],i[3]=n[3]*a[3]}static scale(e,t,r){var i=r.elements,n=e.elements;i[0]=n[0]*t,i[1]=n[1]*t,i[2]=n[2]*t,i[3]=n[3]*t}static Clamp(e,t,r,i){var n=e.elements,a=n[0],s=n[1],o=n[2],l=n[3],_=t.elements,h=_[0],c=_[1],d=_[2],u=_[3],m=r.elements,f=m[0],T=m[1],E=m[2],p=m[3],g=i.elements;a=(a=a>f?f:a)<h?h:a,s=(s=s>T?T:s)<c?c:s,o=(o=o>E?E:o)<d?d:o,l=(l=l>p?p:l)<u?u:l,g[0]=a,g[1]=s,g[2]=o,g[3]=l}static distanceSquared(e,t){var r=e.elements,i=t.elements,n=r[0]-i[0],a=r[1]-i[1],s=r[2]-i[2],o=r[3]-i[3];return n*n+a*a+s*s+o*o}static distance(e,t){var r=e.elements,i=t.elements,n=r[0]-i[0],a=r[1]-i[1],s=r[2]-i[2],o=r[3]-i[3];return Math.sqrt(n*n+a*a+s*s+o*o)}static dot(e,t){var r=e.elements,i=t.elements;return r[0]*i[0]+r[1]*i[1]+r[2]*i[2]+r[3]*i[3]}static min(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=Math.min(n[0],a[0]),i[1]=Math.min(n[1],a[1]),i[2]=Math.min(n[2],a[2]),i[3]=Math.min(n[3],a[3])}static max(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=Math.max(n[0],a[0]),i[1]=Math.max(n[1],a[1]),i[2]=Math.max(n[2],a[2]),i[3]=Math.max(n[3],a[3])}}return e.ZERO=new e,e.ONE=new e(1,1,1,1),e.UnitX=new e(1,0,0,0),e.UnitY=new e(0,1,0,0),e.UnitZ=new e(0,0,1,0),e.UnitW=new e(0,0,0,1),e})(),ce=(()=>{class e{constructor(e=0,t=0,r=0,i=null){var n;n=i||new Float32Array(3),this.elements=n,n[0]=e,n[1]=t,n[2]=r}static distanceSquared(e,t){var r=e.elements,i=t.elements,n=r[0]-i[0],a=r[1]-i[1],s=r[2]-i[2];return n*n+a*a+s*s}static distance(e,t){var r=e.elements,i=t.elements,n=r[0]-i[0],a=r[1]-i[1],s=r[2]-i[2];return Math.sqrt(n*n+a*a+s*s)}static min(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=Math.min(n[0],a[0]),i[1]=Math.min(n[1],a[1]),i[2]=Math.min(n[2],a[2])}static max(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=Math.max(n[0],a[0]),i[1]=Math.max(n[1],a[1]),i[2]=Math.max(n[2],a[2])}static transformQuat(e,t,r){var i=r.elements,n=e.elements,a=t.elements,s=n[0],o=n[1],l=n[2],_=a[0],h=a[1],c=a[2],d=a[3],u=d*s+h*l-c*o,m=d*o+c*s-_*l,f=d*l+_*o-h*s,T=-_*s-h*o-c*l;i[0]=u*d+T*-_+m*-c-f*-h,i[1]=m*d+T*-h+f*-_-u*-c,i[2]=f*d+T*-c+u*-h-m*-_}static scalarLength(e){var t=e.elements,r=t[0],i=t[1],n=t[2];return Math.sqrt(r*r+i*i+n*n)}static scalarLengthSquared(e){var t=e.elements,r=t[0],i=t[1],n=t[2];return r*r+i*i+n*n}static normalize(e,t){var r=e.elements,i=t.elements,n=r[0],a=r[1],s=r[2],o=n*n+a*a+s*s;o>0&&(o=1/Math.sqrt(o),i[0]=r[0]*o,i[1]=r[1]*o,i[2]=r[2]*o)}static multiply(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]*a[0],i[1]=n[1]*a[1],i[2]=n[2]*a[2]}static scale(e,t,r){var i=r.elements,n=e.elements;i[0]=n[0]*t,i[1]=n[1]*t,i[2]=n[2]*t}static lerp(e,t,r,i){var n=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],_=a[2];n[0]=o+r*(s[0]-o),n[1]=l+r*(s[1]-l),n[2]=_+r*(s[2]-_)}static transformV3ToV3(t,r,i){var n=e._tempVector4;e.transformV3ToV4(t,r,n);var a=n.elements,s=i.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]}static transformV3ToV4(e,t,r){var i=e.elements,n=i[0],a=i[1],s=i[2],o=t.elements,l=r.elements;l[0]=n*o[0]+a*o[4]+s*o[8]+o[12],l[1]=n*o[1]+a*o[5]+s*o[9]+o[13],l[2]=n*o[2]+a*o[6]+s*o[10]+o[14],l[3]=n*o[3]+a*o[7]+s*o[11]+o[15]}static TransformNormal(e,t,r){var i=e.elements,n=i[0],a=i[1],s=i[2],o=t.elements,l=r.elements;l[0]=n*o[0]+a*o[4]+s*o[8],l[1]=n*o[1]+a*o[5]+s*o[9],l[2]=n*o[2]+a*o[6]+s*o[10]}static transformCoordinate(e,t,r){var i=e.elements,n=i[0],a=i[1],s=i[2],o=t.elements,l=n*o[3]+a*o[7]+s*o[11]+o[15],_=r.elements;_[0]=n*o[0]+a*o[4]+s*o[8]+o[12]/l,_[1]=n*o[1]+a*o[5]+s*o[9]+o[13]/l,_[2]=n*o[2]+a*o[6]+s*o[10]+o[14]/l}static Clamp(e,t,r,i){var n=e.elements,a=n[0],s=n[1],o=n[2],l=t.elements,_=l[0],h=l[1],c=l[2],d=r.elements,u=d[0],m=d[1],f=d[2],T=i.elements;a=(a=a>u?u:a)<_?_:a,s=(s=s>m?m:s)<h?h:s,o=(o=o>f?f:o)<c?c:o,T[0]=a,T[1]=s,T[2]=o}static add(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]+a[0],i[1]=n[1]+a[1],i[2]=n[2]+a[2]}static subtract(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]-a[0],i[1]=n[1]-a[1],i[2]=n[2]-a[2]}static cross(e,t,r){var i=e.elements,n=t.elements,a=r.elements,s=i[0],o=i[1],l=i[2],_=n[0],h=n[1],c=n[2];a[0]=o*c-l*h,a[1]=l*_-s*c,a[2]=s*h-o*_}static dot(e,t){var r=e.elements,i=t.elements;return r[0]*i[0]+r[1]*i[1]+r[2]*i[2]}static equals(e,t){var i=e.elements,n=t.elements;return r.nearEqual(i[0],n[0])&&r.nearEqual(i[1],n[1])&&r.nearEqual(i[2],n[2])}get x(){return this.elements[0]}set x(e){this.elements[0]=e}get y(){return this.elements[1]}set y(e){this.elements[1]=e}get z(){return this.elements[2]}set z(e){this.elements[2]=e}setValue(e,t,r){this.elements[0]=e,this.elements[1]=t,this.elements[2]=r}fromArray(e,t=0){this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]}cloneTo(e){var t=e.elements,r=this.elements;t[0]=r[0],t[1]=r[1],t[2]=r[2]}clone(){var t=new e;return this.cloneTo(t),t}toDefault(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0}}return e._tempVector4=new he,e.ZERO=new e(0,0,0),e.ONE=new e(1,1,1),e.NegativeUnitX=new e(-1,0,0),e.UnitX=new e(1,0,0),e.UnitY=new e(0,1,0),e.UnitZ=new e(0,0,1),e.ForwardRH=new e(0,0,-1),e.ForwardLH=new e(0,0,1),e.Up=new e(0,1,0),e.NAN=new e(NaN,NaN,NaN),e})(),de=(()=>{class e{constructor(e=0,t=0,r=0,i=1,n=null){var a;(a=n||new Float32Array(4))[0]=e,a[1]=t,a[2]=r,a[3]=i,this.elements=a}static _dotArray(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}static _normalizeArray(e,t){var r=e[0],i=e[1],n=e[2],a=e[3],s=r*r+i*i+n*n+a*a;s>0&&(s=1/Math.sqrt(s),t[0]=r*s,t[1]=i*s,t[2]=n*s,t[3]=a*s)}static _lerpArray(t,r,i,n){var a=1-i;e._dotArray(t,r)>=0?(n[0]=a*t[0]+i*r[0],n[1]=a*t[1]+i*r[1],n[2]=a*t[2]+i*r[2],n[3]=a*t[3]+i*r[3]):(n[0]=a*t[0]-i*r[0],n[1]=a*t[1]-i*r[1],n[2]=a*t[2]-i*r[2],n[3]=a*t[3]-i*r[3]),e._normalizeArray(n,n)}static createFromYawPitchRoll(e,t,r,i){var n=.5*r,a=.5*t,s=.5*e,o=Math.sin(n),l=Math.cos(n),_=Math.sin(a),h=Math.cos(a),c=Math.sin(s),d=Math.cos(s),u=i.elements;u[0]=d*_*l+c*h*o,u[1]=c*h*l-d*_*o,u[2]=d*h*o-c*_*l,u[3]=d*h*l+c*_*o}static multiply(e,t,r){var i=e.elements,n=t.elements,a=r.elements,s=i[0],o=i[1],l=i[2],_=i[3],h=n[0],c=n[1],d=n[2],u=n[3],m=o*d-l*c,f=l*h-s*d,T=s*c-o*h,E=s*h+o*c+l*d;a[0]=s*u+h*_+m,a[1]=o*u+c*_+f,a[2]=l*u+d*_+T,a[3]=_*u-E}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(t,r,i){ce.subtract(r,t,e.TEMPVector30),ce.normalize(e.TEMPVector30,e.TEMPVector30),i.elements[0]=Math.asin(e.TEMPVector30.y),i.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)}static createFromAxisAngle(e,t,r){var i=r.elements,n=e.elements;t*=.5;var a=Math.sin(t);i[0]=a*n[0],i[1]=a*n[1],i[2]=a*n[2],i[3]=Math.cos(t)}static createFromMatrix3x3(e,t){var r,i=t.elements,n=e.elements,a=n[0]+n[4]+n[8];if(a>0)r=Math.sqrt(a+1),i[3]=.5*r,r=.5/r,i[0]=(n[5]-n[7])*r,i[1]=(n[6]-n[2])*r,i[2]=(n[1]-n[3])*r;else{var s=0;n[4]>n[0]&&(s=1),n[8]>n[3*s+s]&&(s=2);var o=(s+1)%3,l=(s+2)%3;r=Math.sqrt(n[3*s+s]-n[3*o+o]-n[3*l+l]+1),i[s]=.5*r,r=.5/r,i[3]=(n[3*o+l]-n[3*l+o])*r,i[o]=(n[3*o+s]+n[3*s+o])*r,i[l]=(n[3*l+s]+n[3*s+l])*r}}static createFromMatrix4x4(e,t){var r,i,n=e.elements,a=t.elements,s=n[0]+n[5]+n[10];s>0?(r=Math.sqrt(s+1),a[3]=.5*r,r=.5/r,a[0]=(n[6]-n[9])*r,a[1]=(n[8]-n[2])*r,a[2]=(n[1]-n[4])*r):n[0]>=n[5]&&n[0]>=n[10]?(i=.5/(r=Math.sqrt(1+n[0]-n[5]-n[10])),a[0]=.5*r,a[1]=(n[1]+n[4])*i,a[2]=(n[2]+n[8])*i,a[3]=(n[6]-n[9])*i):n[5]>n[10]?(i=.5/(r=Math.sqrt(1+n[5]-n[0]-n[10])),a[0]=(n[4]+n[1])*i,a[1]=.5*r,a[2]=(n[9]+n[6])*i,a[3]=(n[8]-n[2])*i):(i=.5/(r=Math.sqrt(1+n[10]-n[0]-n[5])),a[0]=(n[8]+n[2])*i,a[1]=(n[9]+n[6])*i,a[2]=.5*r,a[3]=(n[1]-n[4])*i)}static slerp(e,t,r,i){var n,a,s,o,l,_=e.elements,h=t.elements,c=i.elements,d=_[0],u=_[1],m=_[2],f=_[3],T=h[0],E=h[1],p=h[2],g=h[3];return(a=d*T+u*E+m*p+f*g)<0&&(a=-a,T=-T,E=-E,p=-p,g=-g),1-a>1e-6?(n=Math.acos(a),s=Math.sin(n),o=Math.sin((1-r)*n)/s,l=Math.sin(r*n)/s):(o=1-r,l=r),c[0]=o*d+l*T,c[1]=o*u+l*E,c[2]=o*m+l*p,c[3]=o*f+l*g,c}static lerp(t,r,i,n){e._lerpArray(t.elements,r.elements,i,n.elements)}static add(e,t,r){var i=r.elements,n=e.elements,a=t.elements;i[0]=n[0]+a[0],i[1]=n[1]+a[1],i[2]=n[2]+a[2],i[3]=n[3]+a[3]}static dot(t,r){return e._dotArray(t.elements,r.elements)}get x(){return this.elements[0]}set x(e){this.elements[0]=e}get y(){return this.elements[1]}set y(e){this.elements[1]=e}get z(){return this.elements[2]}set z(e){this.elements[2]=e}get w(){return this.elements[3]}set w(e){this.elements[3]=e}scaling(e,t){var r=t.elements,i=this.elements;r[0]=i[0]*e,r[1]=i[1]*e,r[2]=i[2]*e,r[3]=i[3]*e}normalize(t){e._normalizeArray(this.elements,t.elements)}length(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3];return Math.sqrt(t*t+r*r+i*i+n*n)}rotateX(e,t){var r=t.elements,i=this.elements;e*=.5;var n=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),_=Math.cos(e);r[0]=n*_+o*l,r[1]=a*_+s*l,r[2]=s*_-a*l,r[3]=o*_-n*l}rotateY(e,t){var r=t.elements,i=this.elements;e*=.5;var n=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),_=Math.cos(e);r[0]=n*_-s*l,r[1]=a*_+o*l,r[2]=s*_+n*l,r[3]=o*_-a*l}rotateZ(e,t){var r=t.elements,i=this.elements;e*=.5;var n=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),_=Math.cos(e);r[0]=n*_+a*l,r[1]=a*_-n*l,r[2]=s*_+o*l,r[3]=o*_-s*l}getYawPitchRoll(t){ce.transformQuat(ce.ForwardRH,this,e.TEMPVector31),ce.transformQuat(ce.Up,this,e.TEMPVector32);var r=e.TEMPVector32.elements;e.angleTo(ce.ZERO,e.TEMPVector31,e.TEMPVector33);var i=e.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=e.arcTanAngle(r[2],r[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=e.arcTanAngle(-r[2],-r[0]),i[2]=0):(h.createRotationY(-i[1],e.TEMPMatrix0),h.createRotationX(-i[0],e.TEMPMatrix1),ce.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),ce.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),i[2]=e.arcTanAngle(r[1],-r[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]);var n=t.elements;n[0]=i[1],n[1]=i[0],n[2]=i[2]}invert(e){var t=e.elements,r=this.elements,i=r[0],n=r[1],a=r[2],s=r[3],o=i*i+n*n+a*a+s*s,l=o?1/o:0;t[0]=-i*l,t[1]=-n*l,t[2]=-a*l,t[3]=s*l}identity(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1}fromArray(e,t=0){this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}cloneTo(e){var t,r,i;if((r=this.elements)!==(i=e.elements))for(t=0;t<4;++t)i[t]=r[t]}clone(){var t=new e;return this.cloneTo(t),t}equals(e){var t=this.elements,i=e.elements;return r.nearEqual(t[0],i[0])&&r.nearEqual(t[1],i[1])&&r.nearEqual(t[2],i[2])&&r.nearEqual(t[3],i[3])}static rotationLookAt(t,r,i){e.lookAt(ce.ZERO,t,r,i)}static lookAt(t,r,i,n){o.lookAt(t,r,i,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,n)}lengthSquared(){var e=this.elements[0],t=this.elements[1],r=this.elements[2],i=this.elements[3];return e*e+t*t+r*r+i*i}static invert(e,t){var i=e.elements,n=t.elements,a=e.lengthSquared();r.isZero(a)||(a=1/a,n[0]=-i[0]*a,n[1]=-i[1]*a,n[2]=-i[2]*a,n[3]=i[3]*a)}static rotationMatrix(e,t){var r,i,n=e.elements,a=n[0],s=n[1],o=n[2],l=n[3],_=n[4],h=n[5],c=n[6],d=n[7],u=n[8],m=t.elements,f=a+_+u;f>0?(r=Math.sqrt(f+1),m[3]=.5*r,r=.5/r,m[0]=(h-d)*r,m[1]=(c-o)*r,m[2]=(s-l)*r):a>=_&&a>=u?(i=.5/(r=Math.sqrt(1+a-_-u)),m[0]=.5*r,m[1]=(s+l)*i,m[2]=(o+c)*i,m[3]=(h-d)*i):_>u?(i=.5/(r=Math.sqrt(1+_-a-u)),m[0]=(l+s)*i,m[1]=.5*r,m[2]=(d+h)*i,m[3]=(c-o)*i):(i=.5/(r=Math.sqrt(1+u-a-_)),m[0]=(c+o)*i,m[1]=(d+h)*i,m[2]=.5*r,m[3]=(s-l)*i)}}return e.TEMPVector30=new ce,e.TEMPVector31=new ce,e.TEMPVector32=new ce,e.TEMPVector33=new ce,e.TEMPMatrix0=new h,e.TEMPMatrix1=new h,e._tempMatrix3x3=new o,e.DEFAULT=new e,e.NAN=new e(NaN,NaN,NaN,NaN),e})();class ue{constructor(){this._referenceCount=0,this._clip=null,this._nodeOwners=[],this._currentFrameIndices=null,this._realtimeDatas=[],this._scripts=null,this.speed=1,this.clipStart=0,this.clipEnd=1}get clip(){return this._clip}set clip(e){if(this._clip!==e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var r=this._realtimeDatas,i=e._nodes,n=i.count;this._currentFrameIndices=new Int16Array(n),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=n;for(var s=0;s<n;s++)switch(i.getNodeByIndex(s).type){case 0:break;case 1:case 3:case 4:r[s]=t.Render.supportWebGLPlusAnimation?new ce:new a;break;case 2:r[s]=t.Render.supportWebGLPlusAnimation?new de:new _;break;default:throw"AnimationClipParser04:unknown type."}}this._clip=e}}_getReferenceCount(){return this._referenceCount}_addReference(e=1){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e=1){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var i=this._scripts[t];if(i instanceof e)return i}return null}getScripts(e){var t;if(this._scripts)for(var r=0,i=this._scripts.length;r<i;r++){var n=this._scripts[r];n instanceof e&&(t=t||[]).push(n)}return t}cloneTo(e){var t=e;t.name=this.name,t.speed=this.speed,t.clipStart=this.clipStart,t.clipEnd=this.clipEnd,t.clip=this._clip}clone(){var e=new ue;return this.cloneTo(e),e}}class me{constructor(){this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.value=null,this.crossFixedValue=null}saveCrossFixedValue(){if(this.propertyOwner)switch(this.type){case 0:this.crossFixedValue=this.value;break;case 1:case 3:case 4:case 2:this.value.cloneTo(this.crossFixedValue);break;default:throw"Animator:unknown type."}}}let fe=(()=>{class e extends t.Component{constructor(){super(),this._keyframeNodeOwners=[],this._linkAvatarSpritesData={},this._linkAvatarSprites=[],this._renderableSprites=[],this.cullingMode=e.CULLINGMODE_CULLCOMPLETELY,this._controllerLayers=[],this._linkSprites={},this._speed=1,this._keyframeNodeOwnerMap={},this._updateMark=0}static _update(e){for(var t=e._animatorPool,r=t.elements,i=0,n=t.length;i<n;i++){var a=r[i];a&&a.enabled&&a._update()}}get speed(){return this._speed}set speed(e){this._speed=e}_linkToSprites(e){for(var t in e){for(var r=this.owner,i=e[t],n=0,a=i.length;n<a;n++){var s=i[n];if(""===s)break;if(!(r=r.getChildByName(s)))break}r&&this.linkSprite3DToAvatarNode(t,r)}}_addKeyframeNodeOwner(e,t,r){var i=t._indexInList,n=t.fullPath,a=this._keyframeNodeOwnerMap[n];if(a)a.referenceCount++,e[i]=a;else{for(var s=r,o=0,l=t.propertyCount;o<l&&(s=s[t.getPropertyByIndex(o)]);o++);(a=this._keyframeNodeOwnerMap[n]=new me).fullPath=n,a.indexInList=this._keyframeNodeOwners.length,a.referenceCount=1,a.propertyOwner=r;var _=t.propertyCount,h=[];for(o=0;o<_;o++)h[o]=t.getPropertyByIndex(o);if(a.property=h,a.type=t.type,s)if(0===t.type)a.defaultValue=s;else{var c=new s.constructor;s.cloneTo(c),a.defaultValue=c,a.value=new s.constructor,a.crossFixedValue=new s.constructor}this._keyframeNodeOwners.push(a),e[i]=a}}_removeKeyframeNodeOwner(e,t){var r=t.fullPath,i=this._keyframeNodeOwnerMap[r];i&&(i.referenceCount--,0===i.referenceCount&&(delete this._keyframeNodeOwnerMap[r],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(i),1)),e[t._indexInList]=null)}_getOwnersByClip(e){var t=e._clip._nodes,r=t.count,i=e._nodeOwners;i.length=r;for(var n=0;n<r;n++){for(var a=t.getNodeByIndex(n),s=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,o=0,l=a.ownerPathCount;o<l;o++){var _=a.getOwnerPathByIndex(o);if(""===_)break;if(!(s=s.getChildByName(_)))break}if(s){var h=a.propertyOwner;h&&(s=s[h]),s&&this._addKeyframeNodeOwner(i,a,s)}}}_updatePlayer(e,t,r,i){var n=e._clip._duration*(e.clipEnd-e.clipStart),a=t._elapsedTime,s=a+r;t._lastElapsedTime=a,t._elapsedTime=s;var o=s/n;t._normalizedTime=o;var l=o%1;t._normalizedPlayTime=l<0?l+1:l,t._duration=n;var _=e._scripts;if(!i&&s>=n){if(t._finish=!0,t._elapsedTime=n,t._normalizedPlayTime=1,_)for(var h=0,c=_.length;h<c;h++)_[h].onStateExit()}else if(_)for(h=0,c=_.length;h<c;h++)_[h].onStateUpdate()}_eventScript(e,t,r,i,n){if(n)for(var a=t.length;r<a;r++){var s=t[r];if(!(s.time<=i))break;for(var o=0,l=e.length;o<l;o++){var _=e[o],h=_[s.eventName];h&&h.apply(_,s.params)}}else for(;r>=0&&(s=t[r]).time>=i;r--)for(o=0,l=e.length;o<l;o++)(h=(_=e[o])[s.eventName])&&h.apply(_,s.params);return r}_updateEventScript(e,t){var r=this.owner._scripts;if(r){var i=e._clip,n=i._animationEvents,a=i._duration,s=t._elapsedTime,o=s%a,l=Math.abs(Math.floor(s/a)-Math.floor(t._lastElapsedTime/a)),_=t._elapsedTime>=t._lastElapsedTime;if(t._lastIsFront!==_&&(_?t._playEventIndex++:t._playEventIndex--,t._lastIsFront=_),_){t._playEventIndex=this._eventScript(r,n,t._playEventIndex,l>0?a:o,!0);for(var h=0,c=l-1;h<c;h++)this._eventScript(r,n,0,a,!0);l>0&&o>0&&(t._playEventIndex=this._eventScript(r,n,0,o,!0))}else{t._playEventIndex=this._eventScript(r,n,t._playEventIndex,l>0?0:o,!1);var d=n.length-1;for(h=0,c=l-1;h<c;h++)this._eventScript(r,n,d,0,!1);l>0&&o>0&&(t._playEventIndex=this._eventScript(r,n,d,o,!1))}}}_updateClipDatas(e,t,r,i){var n=e._clip,a=n._duration,s=e.clipStart*a+r._normalizedPlayTime*r._duration,o=e._currentFrameIndices,l=r._elapsedTime>r._lastElapsedTime;n._evaluateClipDatasRealTime(n._nodes,s,o,t,l,e._realtimeDatas)}_applyFloat(e,t,r,i,n,a,s){if(r.updateMark===this._updateMark)if(i)e[t]+=n*s;else{var o=e[t];e[t]=o+n*(s-o)}else if(a)e[t]=i?r.defaultValue+s:s;else if(i)e[t]=r.defaultValue+n*s;else{var l=r.defaultValue;e[t]=l+n*(s-l)}}_applyPositionAndRotationEuler(e,t,r,i,n,a){if(e.updateMark===this._updateMark)if(t)a.x+=r*n.x,a.y+=r*n.y,a.z+=r*n.z;else{var s=a.x,o=a.y,l=a.z;a.x=s+r*(n.x-s),a.y=o+r*(n.y-o),a.z=l+r*(n.z-l)}else if(i)if(t){var _=e.defaultValue;a.x=_.x+n.x,a.y=_.y+n.y,a.z=_.z+n.z}else a.x=n.x,a.y=n.y,a.z=n.z;else if(_=e.defaultValue,t)a.x=_.x+r*n.x,a.y=_.y+r*n.y,a.z=_.z+r*n.z;else{var h=_.x,c=_.y,d=_.z;a.x=h+r*(n.x-h),a.y=c+r*(n.y-c),a.z=d+r*(n.z-d)}}_applyRotation(t,r,i,n,a,s){if(t.updateMark===this._updateMark)if(r){var o=e._tempQuaternion1;k.quaternionWeight(a,i,o),o.normalize(o),_.multiply(s,o,s)}else _.lerp(s,a,i,s);else if(n)if(r){var l=t.defaultValue;_.multiply(l,a,s)}else s.x=a.x,s.y=a.y,s.z=a.z,s.w=a.w;else l=t.defaultValue,r?(o=e._tempQuaternion1,k.quaternionWeight(a,i,o),o.normalize(o),_.multiply(l,o,s)):_.lerp(l,a,i,s)}_applyScale(t,r,i,n,a,s){if(t.updateMark===this._updateMark)if(r){var o=e._tempVector31;k.scaleWeight(a,i,o),s.x=s.x*o.x,s.y=s.y*o.y,s.z=s.z*o.z}else k.scaleBlend(s,a,i,s);else if(n)if(r){var l=t.defaultValue;s.x=l.x*a.x,s.y=l.y*a.y,s.z=l.z*a.z}else s.x=a.x,s.y=a.y,s.z=a.z;else l=t.defaultValue,r?(o=e._tempVector31,k.scaleWeight(a,i,o),s.x=l.x*o.x,s.y=l.y*o.y,s.z=l.z*o.z):k.scaleBlend(l,a,i,s)}_applyCrossData(e,t,r,i,n,a,s){var o=e.propertyOwner;if(o){switch(e.type){case 0:for(var l=e.property,h=l.length-1,c=0;c<h&&(o=o[l[c]]);c++);var d=n+s*(a-n);e.value=d,this._applyFloat(o,l[h],e,t,r,i,d);break;case 1:var u=o.localPosition,m=e.value,f=n.x,T=n.y,E=n.z;m.x=f+s*(a.x-f),m.y=T+s*(a.y-T),m.z=E+s*(a.z-E),this._applyPositionAndRotationEuler(e,t,r,i,m,u),o.localPosition=u;break;case 2:var p=o.localRotation,g=e.value;_.lerp(n,a,s,g),this._applyRotation(e,t,r,i,g,p),o.localRotation=p;break;case 3:var S=o.localScale,R=e.value;k.scaleBlend(n,a,s,R),this._applyScale(e,t,r,i,R,S),o.localScale=S;break;case 4:var v=o.localRotationEuler,A=e.value;f=n.x,T=n.y,E=n.z,A.x=f+s*(a.x-f),A.y=T+s*(a.y-T),A.z=E+s*(a.z-E),this._applyPositionAndRotationEuler(e,t,r,i,A,v),o.localRotationEuler=v}e.updateMark=this._updateMark}}_setClipDatasToNode(e,t,r,i){for(var n=e._realtimeDatas,a=e._clip._nodes,s=e._nodeOwners,o=0,l=a.count;o<l;o++){var _=s[o];if(_){var h=_.propertyOwner;if(h){switch(_.type){case 0:for(var c=_.property,d=c.length-1,u=0;u<d&&(h=h[c[u]]);u++);this._applyFloat(h,c[d],_,t,r,i,n[o]);break;case 1:var m=h.localPosition;this._applyPositionAndRotationEuler(_,t,r,i,n[o],m),h.localPosition=m;break;case 2:var f=h.localRotation;this._applyRotation(_,t,r,i,n[o],f),h.localRotation=f;break;case 3:var T=h.localScale;this._applyScale(_,t,r,i,n[o],T),h.localScale=T;break;case 4:var E=h.localRotationEuler;this._applyPositionAndRotationEuler(_,t,r,i,n[o],E),h.localRotationEuler=E}_.updateMark=this._updateMark}}}}_setCrossClipDatasToNode(e,t,r,i,n){for(var a=e._crossNodesOwners,s=e._crossNodesOwnersCount,o=e.blendingMode!==_e.BLENDINGMODE_OVERRIDE,l=e.defaultWeight,_=r._realtimeDatas,h=e._destCrossClipNodeIndices,c=r._nodeOwners,d=t._realtimeDatas,u=e._srcCrossClipNodeIndices,m=t._nodeOwners,f=0;f<s;f++){var T=a[f];if(T){var E=u[f],p=h[f],g=-1!==E?d[E]:c[p].defaultValue,S=-1!==p?_[p]:m[E].defaultValue;this._applyCrossData(T,o,l,n,g,S,i)}}}_setFixedCrossClipDatasToNode(e,t,r,i){for(var n=e._crossNodesOwners,a=e._crossNodesOwnersCount,s=e.blendingMode!==_e.BLENDINGMODE_OVERRIDE,o=e.defaultWeight,l=t._realtimeDatas,_=e._destCrossClipNodeIndices,h=0;h<a;h++){var c=n[h];if(c){var d=_[h],u=c.crossFixedValue,m=-1!==d?l[d]:c.defaultValue;this._applyCrossData(c,s,o,i,u,m,r)}}}_revertDefaultKeyframeNodes(e){for(var t=e._nodeOwners,r=0,i=t.length;r<i;r++){var n=t[r];if(n){var a=n.propertyOwner;if(a)switch(n.type){case 0:for(var s=n.property,o=s.length-1,l=0;l<o&&(a=a[s[l]]);l++);a[s[o]]=n.defaultValue;break;case 1:var _=a.localPosition,h=n.defaultValue;_.x=h.x,_.y=h.y,_.z=h.z,a.localPosition=_;break;case 2:var c=a.localRotation,d=n.defaultValue;c.x=d.x,c.y=d.y,c.z=d.z,c.w=d.w,a.localRotation=c;break;case 3:var u=a.localScale;h=n.defaultValue,u.x=h.x,u.y=h.y,u.z=h.z,a.localScale=u;break;case 4:var m=a.localRotationEuler;h=n.defaultValue,m.x=h.x,m.y=h.y,m.z=h.z,a.localRotationEuler=m;break;default:throw"Animator:unknown type."}}}}_onAdded(){var e=this.owner._parent;this.owner._setHierarchyAnimator(this,e?e._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[])}_onDestroy(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e]._removeReference();var r=this.owner._parent;this.owner._clearHierarchyAnimator(this,r?r._hierarchyAnimator:null)}_onEnable(){this.owner._scene._animatorPool.add(this);for(var e=0,t=this._controllerLayers.length;e<t;e++){if(this._controllerLayers[e].playOnWake)this.getDefaultState(e)&&this.play(null,e,0)}}_onDisable(){this.owner._scene._animatorPool.remove(this)}_handleSpriteOwnersBySprite(e,t,r){for(var i=0,n=this._controllerLayers.length;i<n;i++)for(var a=this._controllerLayers[i]._states,s=0,o=a.length;s<o;s++){var l=a[s],_=l._clip,h=t.join("/"),c=_._nodesMap[h];if(c)for(var d=l._nodeOwners,u=0,m=c.length;u<m;u++)e?this._addKeyframeNodeOwner(d,c[u],r):this._removeKeyframeNodeOwner(d,c[u])}}_parse(e){var r=e.avatar;if(r){this.avatar=t.Loader.getRes(r.path);var i=r.linkSprites;this._linkSprites=i,this._linkToSprites(i)}e.clipPaths;for(var n=e.playOnWake,a=e.layers,s=0;s<a.length;s++){var o=a[s],l=new _e(o.name);l.defaultWeight=0===s?1:o.weight;var _=o.blendingMode;_&&(l.blendingMode=_),this.addControllerLayer(l);for(var h=o.states,c=0,d=h.length;c<d;c++){var u=h[c],m=u.clipPath;if(m){var f,T=u.name;if(f=t.Loader.getRes(m)){var E=new ue;E.name=T,E.clip=f,l.addState(E),0===c&&(this.getControllerLayer(s).defaultState=E)}}}void 0!==n&&(l.playOnWake=n)}var p=e.cullingMode;void 0!==p&&(this.cullingMode=p)}_update(){var r=this.owner._scene.timer,i=r._delta/1e3;if(0!==this._speed&&0!==i){var n;if(this.cullingMode===e.CULLINGMODE_CULLCOMPLETELY){n=!1;for(var a=0,s=this._renderableSprites.length;a<s;a++)if(this._renderableSprites[a]._render.isRender){n=!0;break}}else n=!0;this._updateMark++;var o=r.scale;for(a=0,s=this._controllerLayers.length;a<s;a++){var l=this._controllerLayers[a],_=l._playStateInfo,h=l._crossPlayStateInfo;switch(f=l.blendingMode!==_e.BLENDINGMODE_OVERRIDE,l._playType){case 0:var c=_._currentState,d=c._clip,u=this._speed*c.speed,m=_._finish;if(m||this._updatePlayer(c,_,i*u,d.islooping),n){var f=l.blendingMode!==_e.BLENDINGMODE_OVERRIDE;this._updateClipDatas(c,f,_,o*u),this._setClipDatasToNode(c,f,l.defaultWeight,0===a),m||this._updateEventScript(c,_)}break;case 1:d=(c=_._currentState)._clip;var T=l._crossPlayState,E=T._clip,p=l._crossDuration,g=h._startPlayTime,S=E._duration-g,R=p>S?S/p:1,v=this._speed*T.speed;this._updatePlayer(T,h,i*R*v,E.islooping);var A=(h._elapsedTime-g)/R/p;A>=1?n&&(this._updateClipDatas(T,f,h,o*v),this._setClipDatasToNode(T,f,l.defaultWeight,0===a),l._playType=0,_._currentState=T,h._cloneTo(_)):(_._finish||(u=this._speed*c.speed,this._updatePlayer(c,_,i*u,d.islooping),n&&this._updateClipDatas(c,f,_,o*u)),n&&(this._updateClipDatas(T,f,h,o*R*v),this._setCrossClipDatasToNode(l,c,T,A,0===a))),n&&(this._updateEventScript(c,_),this._updateEventScript(T,h));break;case 2:E=(T=l._crossPlayState)._clip,p=l._crossDuration,g=h._startPlayTime,R=p>(S=E._duration-g)?S/p:1,v=this._speed*T.speed,this._updatePlayer(T,h,i*R*v,E.islooping),n&&((A=(h._elapsedTime-g)/R/p)>=1?(this._updateClipDatas(T,f,h,o*v),this._setClipDatasToNode(T,f,1,0===a),l._playType=0,_._currentState=T,h._cloneTo(_)):(this._updateClipDatas(T,f,h,o*R*v),this._setFixedCrossClipDatasToNode(l,T,A,0===a)),this._updateEventScript(T,h))}}n&&this._avatar&&(t.Render.supportWebGLPlusAnimation&&this._updateAnimationNodeWorldMatix(this._animationNodeLocalPositions,this._animationNodeLocalRotations,this._animationNodeLocalScales,this._animationNodeWorldMatrixs,this._animationNodeParentIndices),this._updateAvatarNodesToSprite())}}_cloneTo(e){var t=e;t.avatar=this.avatar,t.cullingMode=this.cullingMode;for(var r=0,i=this._controllerLayers.length;r<i;r++){var n=this._controllerLayers[r];t.addControllerLayer(n.clone());for(var a=n._states,s=0,o=a.length;s<o;s++){var l=a[s].clone(),_=t.getControllerLayer(r);_.addState(l),0==s&&(_.defaultState=l)}}t._linkSprites=this._linkSprites,t._linkToSprites(this._linkSprites)}getDefaultState(e=0){return this._controllerLayers[e].defaultState}addState(e,t=0){this._controllerLayers[t].addState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.addState() instead.")}removeState(e,t=0){this._controllerLayers[t].removeState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.removeState() instead.")}addControllerLayer(e){this._controllerLayers.push(e),e._animator=this,e._addReference();for(var t=e._states,r=0,i=t.length;r<i;r++)this._getOwnersByClip(t[r])}getControllerLayer(e=0){return this._controllerLayers[e]}play(e=null,t=0,r=Number.NEGATIVE_INFINITY){var i=this._controllerLayers[t];if(i){var n=i.defaultState;if(!e&&!n)throw new Error("Animator:must have default clip value,please set clip property.");var a=i._playStateInfo,s=a._currentState,o=e?i._statesMap[e]:n,l=o._clip._duration;s!==o?(r!==Number.NEGATIVE_INFINITY?a._resetPlayState(l*r):a._resetPlayState(0),null!==s&&s!==o&&this._revertDefaultKeyframeNodes(s),i._playType=0,a._currentState=o):r!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(l*r),i._playType=0);var _=o._scripts;if(_)for(var h=0,c=_.length;h<c;h++)_[h].onStateEnter()}else console.warn("Invalid layerIndex "+t+".")}crossFade(e,t,r=0,i=Number.NEGATIVE_INFINITY){var n=this._controllerLayers[r];if(n){var a=n._statesMap[e];if(a){var s=n._playType;if(-1===s)return void this.play(e,r,i);var o=n._crossPlayStateInfo,l=n._crossNodesOwners,_=n._crossNodesOwnersIndicesMap,h=n._playStateInfo._currentState,c=a._nodeOwners,d=n._destCrossClipNodeIndices,u=a._clip,m=u._nodes,f=u._nodesDic;switch(s){case 0:var T=h._nodeOwners,E=n._srcCrossClipNodeIndices,p=h._clip,g=p._nodes,S=p._nodesDic;n._playType=1;for(var R=++n._crossMark,v=n._crossNodesOwnersCount=0,A=0,I=g.count;A<I;A++){var x=g.getNodeByIndex(A),C=x._indexInList,L=T[C];if(L){var y=x.fullPath;E[v]=C;var D=f[y];d[v]=D?D._indexInList:-1,_[y]=R,l[v]=L,v++}}for(A=0,I=m.count;A<I;A++){var M=(D=m.getNodeByIndex(A))._indexInList,O=c[M];if(O){var N=D.fullPath;S[N]||(E[v]=-1,d[v]=M,_[N]=R,l[v]=O,v++)}}break;case 1:case 2:for(n._playType=2,A=0,I=l.length;A<I;A++){var b=l[A];b.saveCrossFixedValue(),D=f[b.fullPath],d[A]=D?D._indexInList:-1}for(v=n._crossNodesOwnersCount,R=n._crossMark,A=0,I=m.count;A<I;A++)(O=c[M=(D=m.getNodeByIndex(A))._indexInList])&&_[N=D.fullPath]!==R&&(d[v]=M,_[N]=R,b=c[M],l[v]=b,b.saveCrossFixedValue(),v++)}n._crossNodesOwnersCount=v,n._crossPlayState=a,n._crossDuration=h._clip._duration*t,i!==Number.NEGATIVE_INFINITY?o._resetPlayState(u._duration*i):o._resetPlayState(0);var P=a._scripts;if(P)for(A=0,I=P.length;A<I;A++)P[A].onStateEnter()}else console.warn("Invalid name "+r+".")}else console.warn("Invalid layerIndex "+r+".")}getCurrentAnimatorPlayState(e=0){return this._controllerLayers[e]._playStateInfo}get avatar(){return this._avatar}set avatar(e){if(this._avatar!==e)if(this._avatar=e,e)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,e);else{var t=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,t?t._hierarchyAnimator._avatar:null)}}_isLinkSpriteToAnimationNodeData(e,t,r){var i=this._linkAvatarSpritesData[t];if(r)i||(this._linkAvatarSpritesData[t]=i=[]),i.push(e);else{var n=i.indexOf(e);i.splice(n,1)}}_getAvatarOwnersAndInitDatasAsync(){for(var e=0,t=this._controllerLayers.length;e<t;e++)for(var r=this._controllerLayers[e]._states,i=0,n=r.length;i<n;i++)this._getOwnersByClip(r[i]);for(var a in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var s=this._linkAvatarSpritesData[a];if(s)for(var o=0,l=s.length;o<l;o++)this._isLinkSpriteToAnimationNode(s[o],a,!0)}}_isLinkSpriteToAnimationNode(e,t,r){if(this._avatar){var i=this._avatarNodeMap[t];if(i)if(r){e._transform._dummy=i.transform,this._linkAvatarSprites.push(e);var n=i.transform,a=e.transform;if(!a.owner.isStatic&&n){var s=a.worldMatrix,o=this.owner._transform._parent;if(o)k.matrix4x4MultiplyMFM(o.worldMatrix,n.getWorldMatrix(),s);else for(var l=s.elements,_=n.getWorldMatrix(),h=0;h<16;h++)l[h]=_[h];a.worldMatrix=s}}else e._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(e),1)}}_updateAvatarNodesToSprite(){for(var e=0,t=this._linkAvatarSprites.length;e<t;e++){var r=this._linkAvatarSprites[e],i=r.transform._dummy,n=r.transform;if(!n.owner.isStatic&&i){var a=n.worldMatrix,s=this.owner._transform;k.matrix4x4MultiplyMFM(s.worldMatrix,i.getWorldMatrix(),a),n.worldMatrix=a}}}linkSprite3DToAvatarNode(e,t){return this._isLinkSpriteToAnimationNodeData(t,e,!0),this._isLinkSpriteToAnimationNode(t,e,!0),!0}unLinkSprite3DToAvatarNode(e){var t=e.transform._dummy;if(t){var r=t._owner.name;return this._isLinkSpriteToAnimationNodeData(e,r,!1),this._isLinkSpriteToAnimationNode(e,r,!1),!0}return!1}_updateAnimationNodeWorldMatix(e,r,i,n,a){t.LayaGL.instance.updateAnimationNodeWorldMatix(e,r,i,a,n)}}return e._tempVector30=new a,e._tempVector31=new a,e._tempQuaternion0=new _,e._tempQuaternion1=new _,e.CULLINGMODE_ALWAYSANIMATE=0,e.CULLINGMODE_CULLCOMPLETELY=2,e})();class Te{constructor(){this.source=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.command=null,this.deferredReleaseTextures=[]}}let Ee=(()=>{class e{constructor(){this.invertY=!1}}return e._instance=new e,e})(),pe=(()=>{class e extends t.BaseTexture{constructor(e,r,i=t.RenderTextureFormat.R8G8B8,n=t.RenderTextureDepthFormat.DEPTH_16){super(i,!1),this._inPool=!1,this._isCameraTarget=!1,this._glTextureType=t.LayaGL.instance.TEXTURE_2D,this._width=e,this._height=r,this._depthStencilFormat=n,this._mipmapCount=1,this._create(e,r)}static get currentActive(){return e._currentActive}static createFromPool(r,i,n=t.RenderTextureFormat.R8G8B8,a=t.RenderTextureDepthFormat.DEPTH_16){for(var s,o=0,l=e._pool.length;o<l;o++)if((s=e._pool[o])._width==r&&s._height==i&&s._format==n&&s._depthStencilFormat==a){s._inPool=!1;var _=e._pool[l-1];return e._pool[o]=_,e._pool.length-=1,s}return(s=new e(r,i,n,a)).lock=!0,s}static recoverToPool(t){t._inPool||(e._pool.push(t),t._inPool=!0)}get depthStencilFormat(){return this._depthStencilFormat}get defaulteTexture(){return t.Texture2D.grayTexture}_create(e,r){var i=t.LayaGL.instance,n=i,a=this._glTextureType,s=t.LayaGL.layaGPUInstance,o=s._isWebGL2,l=this._format;if(this._frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),l!==t.RenderTextureFormat.Depth&&l!==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(i,a,this._glTexture),l){case t.RenderTextureFormat.R8G8B8:o?n.texStorage2D(a,this._mipmapCount,n.RGB8,e,r):i.texImage2D(a,0,i.RGB,e,r,0,i.RGB,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R8G8B8A8:o?n.texStorage2D(a,this._mipmapCount,n.RGBA8,e,r):i.texImage2D(a,0,i.RGBA,e,r,0,i.RGBA,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.Alpha8:o?n.texStorage2D(a,0,n.R8,e,r):i.texImage2D(a,0,i.ALPHA,e,r,0,i.ALPHA,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R16G16B16A16:o?n.texStorage2D(a,this._mipmapCount,n.RGBA16F,e,r):i.texImage2D(a,0,i.RGBA,e,r,0,i.RGBA,s._oesTextureHalfFloat.HALF_FLOAT_OES,null)}i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this._glTexture,0)}if(l==t.RenderTextureFormat.Depth||l==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(i,a,this._glTexture),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o?n.texStorage2D(a,this._mipmapCount,n.DEPTH_COMPONENT16,e,r):i.texImage2D(a,0,i.DEPTH_COMPONENT,e,r,0,i.DEPTH_COMPONENT,i.UNSIGNED_SHORT,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,this._glTexture,0);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o?n.texStorage2D(a,this._mipmapCount,n.DEPTH24_STENCIL8,e,r):i.texImage2D(a,0,i.DEPTH_STENCIL,e,r,0,i.DEPTH_STENCIL,s._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.TEXTURE_2D,this._glTexture,0);break;default:throw"RenderTexture: depth format RenderTexture must use depthFormat with DEPTH_16 and DEPTHSTENCIL_16_8."}o&&l==t.RenderTextureFormat.ShadowMap&&n.texParameteri(a,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)}else if(this._depthStencilFormat!==t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE){switch(this._depthStencilBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this._depthStencilBuffer),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,r),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.STENCIL_8:i.renderbufferStorage(i.RENDERBUFFER,i.STENCIL_INDEX8,e,r),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,e,r),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format."}i.bindRenderbuffer(i.RENDERBUFFER,null)}i.bindFramebuffer(i.FRAMEBUFFER,null),this._setWarpMode(i.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(i.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource(),this._setGPUMemory(e*r*4)}_start(){var r=t.LayaGL.instance;r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),e._currentActive=this,this._isCameraTarget&&(Ee._instance.invertY=!0),this._readyed=!1}_end(){var r=t.LayaGL.instance;r.bindFramebuffer(r.FRAMEBUFFER,null),e._currentActive=null,this._isCameraTarget&&(Ee._instance.invertY=!1),this._readyed=!0}getData(e,r,i,n,a){if(t.Render.isConchApp&&2==window.conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var s=t.LayaGL.instance;return s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.checkFramebufferStatus(s.FRAMEBUFFER)===s.FRAMEBUFFER_COMPLETE?(s.readPixels(e,r,i,n,s.RGBA,s.UNSIGNED_BYTE,a),s.bindFramebuffer(s.FRAMEBUFFER,null),a):(s.bindFramebuffer(s.FRAMEBUFFER,null),null)}_disposeResource(){if(this._frameBuffer){var e=t.LayaGL.instance;e.deleteTexture(this._glTexture),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}}getDataAsync(e,r,i,n,a){var s=t.LayaGL.instance;s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.readPixelsAsync(e,r,i,n,s.RGBA,s.UNSIGNED_BYTE,(function(e){a(new Uint8Array(e))})),s.bindFramebuffer(s.FRAMEBUFFER,null)}}return e._pool=[],e})();class ge{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,i=this._length-1;i>=0;i--){var n=r[i]&t[i];0==n&&i==this._length-1?this._length--:r[i]=n}}add(e){var t=e._index,r=t+1,i=this._mask,n=this._length;if(n<r){for(i.length<r&&(i.length=r);n<t;n++)i[n]=0;i[t]=e._value,this._length=r}else r>this._length?(i[t]=e._value,this._length=r):i[t]|=e._value}remove(e){var t=e._index,r=this._mask,i=this._length-1;if(!(t>i)){var n=r[t]&~e._value;t==i&&0===n?this._length--:r[t]=n}}addDefineDatas(e){var t=e._mask,r=e._length,i=this._mask,n=i.length;if(n<r){i.length=r;for(var a=0;a<n;a++)i[a]|=t[a];for(;n<r;n++)i[n]=t[n];this._length=r}else{for(a=0;a<r;a++)i[a]|=t[a];this._length=Math.max(this._length,r)}}removeDefineDatas(e){for(var t=e._mask,r=this._mask,i=this._length-1,n=e._length-1;n>=0;n--)if(!(n>i)){var a=r[n]&~t[n];n==i&&0===a?(i--,this._length--):r[n]=a}}has(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}clear(){this._length=0}cloneTo(e){var t=e,r=t._mask,i=this._mask,n=this._length;r.length=n;for(var a=0;a<n;a++)r[a]=i[a];t._length=n}clone(){var e=new ge;return this.cloneTo(e),e}}class Se{constructor(e,t){this._index=e,this._value=t}}class Re{constructor(e,t,r,i){this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,r,i)}get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}setValue(e,t,r,i){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var n=e.getSubShaderAt(t);if(!n)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${t}.`;var a=n._passes[r];if(!a)throw`ShaderVariantInfo:Shader don't have passIndex of ${r}.`;for(var s=a._validDefine,o=0,_=i.length;o<_;o++){var h=i[o];if(!s.has(l.Shader3D.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${e._name} subShaderIndex of ${t} passIndex of ${r}.`}this._shader=e,this._subShaderIndex=t,this._passIndex=r,this._defineNames=i}equal(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,r=e._defineNames;if(t.length!==r.length)return!1;for(var i=0,n=this._defineNames.length;i<n;i++)if(t[i]!==r[i])return!1;return!0}clone(){return new Re(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class ve{constructor(){this._allCompiled=!1,this._variants=[]}get allCompiled(){return this._allCompiled}get variantCount(){return this._variants.length}add(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}remove(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}contatins(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!0;return!1}getByIndex(e){return this._variants[e]}clear(){this._variants.length=0}compile(){if(!this._allCompiled){for(var e=this._variants,t=0,r=e.length;t<r;t++){var i=e[t];l.Shader3D.compileShaderByDefineNames(i._shader._name,i._subShaderIndex,i._passIndex,i._defineNames)}this._allCompiled=!0}}}let Ae=(()=>{class e{constructor(e,t,r,i){this._attributeMap=null,this._uniformMap=null,this._enableInstancing=!1,this._subShaders=[],this._name=e,this._attributeMap=t,this._uniformMap=r,this._enableInstancing=i}static _getNamesByDefineData(t,r){var i=e._maskMap,n=t._mask;r.length=0;for(var a=0,s=t._length;a<s;a++)for(var o=i[a],l=n[a],_=0;_<32;_++){var h=1<<_;if(l>0&&h>l)break;l&h&&r.push(o[h])}}static getDefineByName(t){var r=e._defineMap[t];if(!r){var i=e._maskMap,n=e._defineCounter,a=Math.floor(n/32),s=1<<n%32;r=new Se(a,s),e._defineMap[t]=r,a==i.length&&(i.length++,i[a]={}),i[a][s]=t,e._defineCounter++}return r}static propertyNameToID(t){if(null!=e._propertyNameMap[t])return e._propertyNameMap[t];var r=e._propertyNameCounter++;return e._propertyNameMap[t]=r,r}static addInclude(e,r){r=r.replace(t.ShaderCompile._clearCR,""),t.ShaderCompile.addInclude(e,r)}static compileShaderByDefineNames(t,r,i,n){var a=e.find(t);if(a){var s=a.getSubShaderAt(r);if(s){var o=s._passes[i];if(o){var l=e._compileDefineDatas;l.clear();for(var _=0,h=n.length;_<h;_++)l.add(e.getDefineByName(n[_]));o.withCompile(l)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}static add(t,r=null,i=null,n=!1){return e._preCompileShader[t]=new e(t,r,i,n)}static find(t){return e._preCompileShader[t]}get name(){return this._name}addSubShader(e){this._subShaders.push(e),e._owner=this}getSubShaderAt(e){return this._subShaders[e]}static compileShader(t,r,i,...n){var a=e.find(t);if(a){var s=a.getSubShaderAt(r);if(s){var o=s._passes[i];if(o){var l=e._compileDefineDatas,_=l._mask;_.length=0;for(var h=0,c=n.length;h<c;h++)_.push(n[h]);l._length=n.length,o.withCompile(l)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}return e._compileDefineDatas=new ge,e.RENDER_STATE_CULL=0,e.RENDER_STATE_BLEND=1,e.RENDER_STATE_BLEND_SRC=2,e.RENDER_STATE_BLEND_DST=3,e.RENDER_STATE_BLEND_SRC_RGB=4,e.RENDER_STATE_BLEND_DST_RGB=5,e.RENDER_STATE_BLEND_SRC_ALPHA=6,e.RENDER_STATE_BLEND_DST_ALPHA=7,e.RENDER_STATE_BLEND_CONST_COLOR=8,e.RENDER_STATE_BLEND_EQUATION=9,e.RENDER_STATE_BLEND_EQUATION_RGB=10,e.RENDER_STATE_BLEND_EQUATION_ALPHA=11,e.RENDER_STATE_DEPTH_TEST=12,e.RENDER_STATE_DEPTH_WRITE=13,e.PERIOD_CUSTOM=0,e.PERIOD_MATERIAL=1,e.PERIOD_SPRITE=2,e.PERIOD_CAMERA=3,e.PERIOD_SCENE=4,e._propertyNameCounter=0,e._propertyNameMap={},e._defineCounter=0,e._defineMap={},e._preCompileShader={},e._maskMap=[],e.debugMode=!1,e.debugShaderVariantCollection=new ve,e})(),Ie=(()=>{class e{constructor(e=null){this._ownerResource=null,this._data=null,this._defineDatas=new ge,this._runtimeCopyValues=[],this._ownerResource=e,this._initData()}_initData(){this._data=new Object}getData(){return this._data}addDefine(e){this._defineDatas.add(e)}removeDefine(e){this._defineDatas.remove(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]=t}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]=t}getVector(e){return this._data[e]}setVector(e,t){this._data[e]=t}getQuaternion(e){return this._data[e]}setQuaternion(e,t){this._data[e]=t}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]=t}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t}setTexture(e,t){var r=this._data[e];this._data[e]=t,this._ownerResource&&this._ownerResource.referenceCount>0&&(r&&r._removeReference(),t&&t._addReference())}getTexture(e){return this._data[e]}setAttribute(e,t){this._data[e]=t}getAttribute(e){return this._data[e]}getLength(){return this._data.length}setLength(e){this._data.length=e}cloneTo(e){var r=e,s=r._data;for(var o in this._data){var l=this._data[o];if(null!=l)if("number"==typeof l)s[o]=l;else if("number"==typeof l)s[o]=l;else if("boolean"==typeof l)s[o]=l;else if(l instanceof i){var _=s[o]||(s[o]=new i);l.cloneTo(_),s[o]=_}else if(l instanceof a){var c=s[o]||(s[o]=new a);l.cloneTo(c),s[o]=c}else if(l instanceof n){var d=s[o]||(s[o]=new n);l.cloneTo(d),s[o]=d}else if(l instanceof h){var u=s[o]||(s[o]=new h);l.cloneTo(u),s[o]=u}else l instanceof t.BaseTexture&&(s[o]=l)}this._defineDatas.cloneTo(r._defineDatas)}clone(){var t=new e;return this.cloneTo(t),t}cloneToForNative(e){var r=e;this._int32Data.length-r._int32Data.length>0&&r.needRenewArrayBufferForNative(this._int32Data.length),r._int32Data.set(this._int32Data,0);var s=r._nativeArray,o=this._nativeArray.length;s.length=o;for(var l=0;l<o;l++){var _=this._nativeArray[l];if(_)if("number"==typeof _)s[l]=_,r.setNumber(l,_);else if("number"==typeof _)s[l]=_,r.setInt(l,_);else if("boolean"==typeof _)s[l]=_,r.setBool(l,_);else if(_ instanceof i){var c=s[l]||(s[l]=new i);_.cloneTo(c),s[l]=c,r.setVector2(l,c)}else if(_ instanceof a){var d=s[l]||(s[l]=new a);_.cloneTo(d),s[l]=d,r.setVector3(l,d)}else if(_ instanceof n){var u=s[l]||(s[l]=new n);_.cloneTo(u),s[l]=u,r.setVector(l,u)}else if(_ instanceof h){var m=s[l]||(s[l]=new h);_.cloneTo(m),s[l]=m,r.setMatrix4x4(l,m)}else _ instanceof t.BaseTexture&&(s[l]=_,r.setTexture(l,_))}this._defineDatas.cloneTo(r._defineDatas)}_initDataForNative(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),t.LayaGL.instance.createArrayBufferRef(this._data,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0)}needRenewArrayBufferForNative(e){if(e>=this._int32Data.length){var r=4*(e+1),i=this._int32Data,n=this._data.conchRef,a=this._data._ptrID;this._data=new ArrayBuffer(r),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=n,this._data._ptrID=a,i&&this._int32Data.set(i,0);var s=t.LayaGL.instance;s.updateArrayBufferRef?s.updateArrayBufferRef(this._data._ptrID,n.isSyncToRender(),this._data):window.conch.updateArrayBufferRef(this._data._ptrID,n.isSyncToRender(),this._data)}}getDataForNative(){return this._nativeArray}getIntForNative(e){return this._int32Data[e]}setIntForNative(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t,this._nativeArray[e]=t}getBoolForNative(e){return 1==this._int32Data[e]}setBoolForNative(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t?1:0,this._nativeArray[e]=t}getNumberForNative(e){return this._float32Data[e]}setNumberForNative(e,t){this.needRenewArrayBufferForNative(e),this._float32Data[e]=t,this._nativeArray[e]=t}getMatrix4x4ForNative(e){return this._nativeArray[e]}setMatrix4x4ForNative(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}getVectorForNative(e){return this._nativeArray[e]}setVectorForNative(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}getVector2ForNative(e){return this._nativeArray[e]}setVector2ForNative(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}getVector3ForNative(e){return this._nativeArray[e]}setVector3ForNative(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}getQuaternionForNative(e){return this._nativeArray[e]}setQuaternionForNative(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}getBufferForNative(e){return this._nativeArray[e]}setBufferForNative(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var r=this.setReferenceForNative(t);this._int32Data[e]=r}getAttributeForNative(e){return this._nativeArray[e]}setAttributeForNative(e,r){this._nativeArray[e]=r,r._ptrID||t.LayaGL.instance.createArrayBufferRef(r,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0),t.LayaGL.instance.syncBufferToRenderThread(r),this._int32Data[e]=r._ptrID}getTextureForNative(e){return this._nativeArray[e]}setTextureForNative(e,t){if(t){this.needRenewArrayBufferForNative(e);var r=this._nativeArray[e];this._nativeArray[e]=t;var i=t._getSource()||t.defaulteTexture._getSource();this._int32Data[e]=i.id,this._ownerResource&&this._ownerResource.referenceCount>0&&(r&&r._removeReference(),t&&t._addReference())}}setReferenceForNative(r){this.clearRuntimeCopyArray();var i=0,n=0;return e._SET_RUNTIME_VALUE_MODE_REFERENCE_?(t.LayaGL.instance.createArrayBufferRefs(r,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_REFERENCE),i=0,n=r.getPtrID(i)):(t.LayaGL.instance.createArrayBufferRefs(r,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_COPY),i=r.getRefNum()-1,n=r.getPtrID(i),this._runtimeCopyValues.push({obj:r,refID:i,ptrID:n})),t.LayaGL.instance.syncBufferToRenderThread(r,i),n}static setRuntimeValueMode(t){e._SET_RUNTIME_VALUE_MODE_REFERENCE_=t}clearRuntimeCopyArray(){var e=t.Stat.loopCount;if(this._frameCount!=e){this._frameCount=e;for(var r=0,i=this._runtimeCopyValues.length;r<i;r++){this._runtimeCopyValues[r].obj.clearRefNum()}this._runtimeCopyValues.length=0}}}return e._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0,e})(),xe=(()=>{class e{constructor(){this._compositeShader=Ae.find("PostProcessComposite"),this._compositeShaderData=new Ie,this._effects=[],this._context=null,this._context=new Te,this._context.compositeShaderData=this._compositeShaderData}static __init__(){e.SHADERDEFINE_BLOOM_LOW=Ae.getDefineByName("BLOOM_LOW"),e.SHADERDEFINE_BLOOM=Ae.getDefineByName("BLOOM"),e.SHADERDEFINE_FINALPASS=Ae.getDefineByName("FINALPASS")}_init(e,t){this._context.camera=e,this._context.command=t}_render(){var r=Ie._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&Ie.setRuntimeValueMode(!1);var i=this._context.camera,n=i.viewport,a=pe.createFromPool(Ee.clientWidth,Ee.clientHeight,i._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE),s=i._internalRenderTexture;this._context.command.clear(),this._context.source=a,this._context.destination=s,this._context.compositeShaderData.clearDefine(),this._context.command.blitScreenTriangle(s,a),this._context.compositeShaderData.setTexture(e.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);for(var o=0,l=this._effects.length;o<l;o++)this._effects[o].render(this._context);this._compositeShaderData.addDefine(e.SHADERDEFINE_FINALPASS);var _=i._offScreenRenderTexture,h=_||null;this._context.destination=h;var c=i._getCanvasWidth(),d=i._getCanvasHeight();i._screenOffsetScale.setValue(n.x/c,n.y/d,n.width/c,n.height/d),this._context.command.blitScreenTriangle(this._context.source,h,i._screenOffsetScale,this._compositeShader,this._compositeShaderData),pe.recoverToPool(a);var u=this._context.deferredReleaseTextures;for(o=0,l=u.length;o<l;o++)pe.recoverToPool(u[o]);u.length=0,t.ILaya.Render.supportWebGLPlusRendering&&Ie.setRuntimeValueMode(r)}addEffect(e){this._effects.push(e)}removeEffect(e){var t=this._effects.indexOf(e);-1!==t&&this._effects.splice(t,1)}}return e.SHADERVALUE_MAINTEX=Ae.propertyNameToID("u_MainTex"),e.SHADERVALUE_BLOOMTEX=Ae.propertyNameToID("u_BloomTex"),e.SHADERVALUE_AUTOEXPOSURETEX=Ae.propertyNameToID("u_AutoExposureTex"),e.SHADERVALUE_BLOOM_DIRTTEX=Ae.propertyNameToID("u_Bloom_DirtTex"),e.SHADERVALUE_BLOOMTEX_TEXELSIZE=Ae.propertyNameToID("u_BloomTex_TexelSize"),e.SHADERVALUE_BLOOM_DIRTTILEOFFSET=Ae.propertyNameToID("u_Bloom_DirtTileOffset"),e.SHADERVALUE_BLOOM_SETTINGS=Ae.propertyNameToID("u_Bloom_Settings"),e.SHADERVALUE_BLOOM_COLOR=Ae.propertyNameToID("u_Bloom_Color"),e})(),Ce=(()=>{class e extends t.EventDispatcher{constructor(e,r=null,i=null,n=null,s=null){super(),this._owner=e,this._children=[],this._localMatrix=new Float32Array(16),t.Render.supportWebGLPlusAnimation?(this._localPosition=new ce(0,0,0,r),this._localRotation=new de(0,0,0,1,i),this._localScale=new ce(0,0,0,n),this._worldMatrix=s):(this._localPosition=new a,this._localRotation=new _,this._localScale=new a,this._worldMatrix=new Float32Array(16)),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0}_getlocalMatrix(){return this._localUpdate&&(k._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix}_onWorldTransform(){if(!this._worldUpdate){this._worldUpdate=!0,this.event(t.Event.TRANSFORM_CHANGED);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldTransform()}}get localPosition(){return this._localPosition}set localPosition(e){this._localPosition=e,this._localUpdate=!0,this._onWorldTransform()}get localRotation(){if(this._localQuaternionUpdate){var t=this._localRotationEuler;_.createFromYawPitchRoll(t.y/e._angleToRandin,t.x/e._angleToRandin,t.z/e._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation}set localRotation(e){this._localRotation=e,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()}get localScale(){return this._localScale}set localScale(e){this._localScale=e,this._localUpdate=!0,this._onWorldTransform()}get localRotationEuler(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector3);var t=e._tempVector3,r=this._localRotationEuler;r.x=t.y*e._angleToRandin,r.y=t.x*e._angleToRandin,r.z=t.z*e._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler}set localRotationEuler(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform()}getWorldMatrix(){if(!t.Render.supportWebGLPlusAnimation&&this._worldUpdate){if(null!=this._parent)k.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else{var e=this._worldMatrix;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}this._worldUpdate=!1}return t.Render.supportWebGLPlusAnimation&&this._worldUpdate&&(this._worldUpdate=!1),this._worldMatrix}setParent(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,r=t.indexOf(this);t.splice(r,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}}return e._tempVector3=new a,e._angleToRandin=180/Math.PI,e})();class Le{constructor(e=null,t=null,r=null,i=null){this._children=[],this.transform=new Ce(this,e,t,r,i)}addChild(e){e._parent=this,e.transform.setParent(this.transform),this._children.push(e)}removeChild(e){var t=this._children.indexOf(e);-1!==t&&this._children.splice(t,1)}getChildByName(e){for(var t=0,r=this._children.length;t<r;t++){var i=this._children[t];if(i.name===e)return i}return null}getChildByIndex(e){return this._children[e]}getChildCount(){return this._children.length}cloneTo(e){var t=e;t.name=this.name;for(var r=0,i=this._children.length;r<i;r++){var n=this._children[r],a=n.clone();t.addChild(a);var s=n.transform,o=a.transform,l=o.localPosition,_=o.localRotation,h=o.localScale;s.localPosition.cloneTo(l),s.localRotation.cloneTo(_),s.localScale.cloneTo(h),o.localPosition=l,o.localRotation=_,o.localScale=h}}clone(){var e=new Le;return this.cloneTo(e),e}_cloneNative(e,t,r,i,n,a,s){var o=s._nativeCurCloneCount;n[o]=a;var l=new Float32Array(e.buffer,3*o*4,3),_=new Float32Array(t.buffer,4*o*4,4),h=new Float32Array(r.buffer,3*o*4,3),c=new Float32Array(i.buffer,16*o*4,16),d=new Le(l,_,h,c);return d._worldMatrixIndex=o,this._cloneToNative(d,e,t,r,i,n,o,s),d}_cloneToNative(e,t,r,i,n,a,s,o){var l=e;l.name=this.name;for(var _=0,h=this._children.length;_<h;_++){var c=this._children[_];o._nativeCurCloneCount++;var d=c._cloneNative(t,r,i,n,a,s,o);l.addChild(d);var u=c.transform,m=d.transform,f=m.localPosition,T=m.localRotation,E=m.localScale;u.localPosition.cloneTo(f),u.localRotation.cloneTo(T),u.localScale.cloneTo(E),m.localPosition=f,m.localRotation=T,m.localScale=E}}}let ye=(()=>{class e extends t.Resource{constructor(){super(),this._nativeNodeCount=0,this._nativeCurCloneCount=0}static _parse(r,i=null,n=null){var a=new e;if(a._rootNode=new Le(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16)),t.Render.supportWebGLPlusAnimation&&a._nativeNodeCount++,r.version){var s=r.rootNode;s&&a._parseNode(s,a._rootNode)}return a}static load(r,i){t.ILaya.loader.create(r,i,null,e.AVATAR)}_initCloneToAnimator(e,t){t._avatarNodeMap[e.name]=e;for(var r=0,i=e.getChildCount();r<i;r++)this._initCloneToAnimator(e.getChildByIndex(r),t)}_parseNode(e,r){var i=e.props.name;r.name=i;var n=e.props,a=r.transform,s=a.localPosition,o=a.localRotation,l=a.localScale;s.fromArray(n.translate),o.fromArray(n.rotation),l.fromArray(n.scale),a.localPosition=s,a.localRotation=o,a.localScale=l;for(var _=e.child,h=0,c=_.length;h<c;h++){var d=_[h],u=new Le(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16));r.addChild(u),t.Render.supportWebGLPlusAnimation&&this._nativeNodeCount++,this._parseNode(d,u)}}_cloneDatasToAnimator(e){var t;t=this._rootNode.clone();var r=this._rootNode.transform,i=t.transform,n=i.localPosition,a=i.localRotation,s=i.localScale;r.localPosition.cloneTo(n),r.localRotation.cloneTo(a),r.localScale.cloneTo(s),i.localPosition=n,i.localRotation=a,i.localScale=s,e._avatarNodeMap={},this._initCloneToAnimator(t,e)}cloneTo(e){var t=e,r=this._rootNode.clone();t._rootNode=r}clone(){var t=new e;return this.cloneTo(t),t}_cloneDatasToAnimatorNative(e){var t=new Float32Array(3*this._nativeNodeCount),r=new Float32Array(4*this._nativeNodeCount),i=new Float32Array(3*this._nativeNodeCount),n=new Float32Array(16*this._nativeNodeCount),a=new Int16Array(this._nativeNodeCount);e._animationNodeLocalPositions=t,e._animationNodeLocalRotations=r,e._animationNodeLocalScales=i,e._animationNodeWorldMatrixs=n,e._animationNodeParentIndices=a,this._nativeCurCloneCount=0;var s=this._rootNode._cloneNative(t,r,i,n,a,-1,this),o=this._rootNode.transform,l=s.transform,_=l.localPosition,h=l.localRotation,c=l.localScale;o.localPosition.cloneTo(_),o.localRotation.cloneTo(h),o.localScale.cloneTo(c),l.localPosition=_,l.localRotation=h,l.localScale=c,e._avatarNodeMap={},this._initCloneToAnimator(s,e)}}return e.AVATAR="AVATAR",e})(),De=(()=>{class e extends t.Resource{constructor(){super(),this._shaderValues=null,this._shaderValues=new Ie(this),this.renderQueue=e.RENDERQUEUE_OPAQUE,this._alphaTest=!1}static load(r,i){t.Laya.loader.create(r,i,null,e.MATERIAL)}static __initDefine__(){e.SHADERDEFINE_ALPHATEST=Ae.getDefineByName("ALPHATEST")}static _parse(e,r=null,s=null){var o,l=e,_=l.props,h=_.type,c=t.ClassUtils.getRegClass(h);if(!c)throw"_getSprite3DHierarchyInnerUrls : "+e.type+" ";switch(o=new c,l.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var d,u;for(var m in _)switch(m){case"type":break;case"vectors":var f=_[m];for(d=0,u=f.length;d<u;d++){var T=f[d],E=T.value;switch(E.length){case 2:o[T.name]=new i(E[0],E[1]);break;case 3:o[T.name]=new a(E[0],E[1],E[2]);break;case 4:o[T.name]=new n(E[0],E[1],E[2],E[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var p=_[m];for(d=0,u=p.length;d<u;d++){var g=p[d],S=g.path;S&&(o[g.name]=t.Loader.getRes(S))}break;case"defines":var R=_[m];for(d=0,u=R.length;d<u;d++){var v=Ae.getDefineByName(R[d]);o._shaderValues.addDefine(v)}break;case"renderStates":var A=_[m][0],I=o;I.blend=A.blend,I.cull=A.cull,I.depthTest=A.depthTest,I.depthWrite=A.depthWrite,I.blendSrc=A.srcBlend,I.blendDst=A.dstBlend;break;case"cull":o.cull=_[m];break;case"blend":o.blend=_[m];break;case"depthWrite":o.depthWrite=_[m];break;case"srcBlend":o.blendSrc=_[m];break;case"dstBlend":o.blendDst=_[m];break;default:o[m]=_[m]}break;default:throw new Error("BaseMaterial:unkonwn version.")}return o}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(e.ALPHATESTVALUE)}set alphaTestValue(t){this._shaderValues.setNumber(e.ALPHATESTVALUE,t)}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest=t,t?this._shaderValues.addDefine(e.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(e.SHADERDEFINE_ALPHATEST)}_removeTetxureReference(){var e=this._shaderValues.getData();for(var r in e){var i=e[r];i&&i instanceof t.BaseTexture&&i._removeReference()}}_disposeResource(){this._referenceCount>0&&this._removeTetxureReference(),this._shaderValues=null}_addReference(e=1){super._addReference(e);var r=this._shaderValues.getData();for(var i in r){var n=r[i];n&&n instanceof t.BaseTexture&&n._addReference()}}_removeReference(e=1){super._removeReference(e),this._removeTetxureReference()}setShaderName(e){if(this._shader=Ae.find(e),!this._shader)throw new Error("BaseMaterial: unknown shader name.")}cloneTo(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,this._shaderValues.cloneTo(t._shaderValues)}clone(){var t=new e;return this.cloneTo(t),t}get _defineDatas(){return this._shaderValues._defineDatas}}return e.MATERIAL="MATERIAL",e.RENDERQUEUE_OPAQUE=2e3,e.RENDERQUEUE_ALPHATEST=2450,e.RENDERQUEUE_TRANSPARENT=3e3,e.ALPHATESTVALUE=Ae.propertyNameToID("u_AlphaTestValue"),e.SHADERDEFINE_ALPHATEST=null,e})(),Me=(()=>{class e{static load(e,r){t.Laya.loader.create(e,r,null,De.MATERIAL)}static __initDefine__(){e.SHADERDEFINE_ALPHATEST=De.SHADERDEFINE_ALPHATEST}}return e.MATERIAL="MATERIAL",e.RENDERQUEUE_OPAQUE=2e3,e.RENDERQUEUE_ALPHATEST=2450,e.RENDERQUEUE_TRANSPARENT=3e3,e.ALPHATESTVALUE=Ae.propertyNameToID("u_AlphaTestValue"),e.SHADERDEFINE_ALPHATEST=null,e})(),Oe=(()=>{class e{constructor(){this.cull=e.CULL_BACK,this.blend=e.BLEND_DISABLE,this.srcBlend=e.BLENDPARAM_ONE,this.dstBlend=e.BLENDPARAM_ZERO,this.srcBlendRGB=e.BLENDPARAM_ONE,this.dstBlendRGB=e.BLENDPARAM_ZERO,this.srcBlendAlpha=e.BLENDPARAM_ONE,this.dstBlendAlpha=e.BLENDPARAM_ZERO,this.blendConstColor=new n(1,1,1,1),this.blendEquation=e.BLENDEQUATION_ADD,this.blendEquationRGB=e.BLENDEQUATION_ADD,this.blendEquationAlpha=e.BLENDEQUATION_ADD,this.depthTest=e.DEPTHTEST_LEQUAL,this.depthWrite=!0}cloneTo(e){var t=e;t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite}clone(){var t=new e;return this.cloneTo(t),t}}return e.CULL_NONE=0,e.CULL_FRONT=1,e.CULL_BACK=2,e.BLEND_DISABLE=0,e.BLEND_ENABLE_ALL=1,e.BLEND_ENABLE_SEPERATE=2,e.BLENDPARAM_ZERO=0,e.BLENDPARAM_ONE=1,e.BLENDPARAM_SRC_COLOR=768,e.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,e.BLENDPARAM_DST_COLOR=774,e.BLENDPARAM_ONE_MINUS_DST_COLOR=775,e.BLENDPARAM_SRC_ALPHA=770,e.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,e.BLENDPARAM_DST_ALPHA=772,e.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,e.BLENDPARAM_SRC_ALPHA_SATURATE=776,e.BLENDEQUATION_ADD=32774,e.BLENDEQUATION_SUBTRACT=32778,e.BLENDEQUATION_REVERSE_SUBTRACT=32779,e.DEPTHTEST_OFF=0,e.DEPTHTEST_NEVER=512,e.DEPTHTEST_LESS=513,e.DEPTHTEST_EQUAL=514,e.DEPTHTEST_LEQUAL=515,e.DEPTHTEST_GREATER=516,e.DEPTHTEST_NOTEQUAL=517,e.DEPTHTEST_GEQUAL=518,e.DEPTHTEST_ALWAYS=519,e})(),Ne=(()=>{class e extends De{constructor(){super(),this._enableVertexColor=!1,this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new n(1,1,1,1);var t=this._shaderValues;t.setVector(e.ALBEDOCOLOR,new n(1,1,1,1)),t.setVector(e.MATERIALSPECULAR,new n(1,1,1,1)),t.setNumber(e.SHININESS,.078125),t.setNumber(De.ALPHATESTVALUE,.5),t.setVector(e.TILINGOFFSET,new n(1,1,0,0)),this._enableLighting=!0,this.renderMode=e.RENDERMODE_OPAQUE}static __initDefine__(){e.SHADERDEFINE_DIFFUSEMAP=Ae.getDefineByName("DIFFUSEMAP"),e.SHADERDEFINE_NORMALMAP=Ae.getDefineByName("NORMALMAP"),e.SHADERDEFINE_SPECULARMAP=Ae.getDefineByName("SPECULARMAP"),e.SHADERDEFINE_TILINGOFFSET=Ae.getDefineByName("TILINGOFFSET"),e.SHADERDEFINE_ENABLEVERTEXCOLOR=Ae.getDefineByName("ENABLEVERTEXCOLOR")}get _ColorR(){return this._albedoColor.x}set _ColorR(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}get _ColorG(){return this._albedoColor.y}set _ColorG(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}get _ColorB(){return this._albedoColor.z}set _ColorB(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}get _ColorA(){return this._albedoColor.w}set _ColorA(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}get _SpecColorR(){return this._shaderValues.getVector(e.MATERIALSPECULAR).x}set _SpecColorR(t){this._shaderValues.getVector(e.MATERIALSPECULAR).x=t}get _SpecColorG(){return this._shaderValues.getVector(e.MATERIALSPECULAR).y}set _SpecColorG(t){this._shaderValues.getVector(e.MATERIALSPECULAR).y=t}get _SpecColorB(){return this._shaderValues.getVector(e.MATERIALSPECULAR).z}set _SpecColorB(t){this._shaderValues.getVector(e.MATERIALSPECULAR).z=t}get _SpecColorA(){return this._shaderValues.getVector(e.MATERIALSPECULAR).w}set _SpecColorA(t){this._shaderValues.getVector(e.MATERIALSPECULAR).w=t}get _AlbedoIntensity(){return this._albedoIntensity}set _AlbedoIntensity(t){if(this._albedoIntensity!==t){var r=this._shaderValues.getVector(e.ALBEDOCOLOR);n.scale(this._albedoColor,t,r),this._albedoIntensity=t,this._shaderValues.setVector(e.ALBEDOCOLOR,r)}}get _Shininess(){return this._shaderValues.getNumber(e.SHININESS)}set _Shininess(t){t=Math.max(0,Math.min(1,t)),this._shaderValues.setNumber(e.SHININESS,t)}get _MainTex_STX(){return this._shaderValues.getVector(e.TILINGOFFSET).x}set _MainTex_STX(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.x=t,this.tilingOffset=r}get _MainTex_STY(){return this._shaderValues.getVector(e.TILINGOFFSET).y}set _MainTex_STY(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.y=t,this.tilingOffset=r}get _MainTex_STZ(){return this._shaderValues.getVector(e.TILINGOFFSET).z}set _MainTex_STZ(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.z=t,this.tilingOffset=r}get _MainTex_STW(){return this._shaderValues.getVector(e.TILINGOFFSET).w}set _MainTex_STW(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.w=t,this.tilingOffset=r}get _Cutoff(){return this.alphaTestValue}set _Cutoff(e){this.alphaTestValue=e}set renderMode(t){switch(t){case e.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=De.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS;break;case e.RENDERMODE_CUTOUT:this.renderQueue=De.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS;break;case e.RENDERMODE_TRANSPARENT:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LESS;break;default:throw new Error("Material:renderMode value error.")}}get enableVertexColor(){return this._enableVertexColor}set enableVertexColor(t){this._enableVertexColor=t,t?this._shaderValues.addDefine(e.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(e.SHADERDEFINE_ENABLEVERTEXCOLOR)}get tilingOffsetX(){return this._MainTex_STX}set tilingOffsetX(e){this._MainTex_STX=e}get tilingOffsetY(){return this._MainTex_STY}set tilingOffsetY(e){this._MainTex_STY=e}get tilingOffsetZ(){return this._MainTex_STZ}set tilingOffsetZ(e){this._MainTex_STZ=e}get tilingOffsetW(){return this._MainTex_STW}set tilingOffsetW(e){this._MainTex_STW=e}get tilingOffset(){return this._shaderValues.getVector(e.TILINGOFFSET)}set tilingOffset(t){t&&(1!=t.x||1!=t.y||0!=t.z||0!=t.w)?this._shaderValues.addDefine(e.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(e.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(e.TILINGOFFSET,t)}get albedoColorR(){return this._ColorR}set albedoColorR(e){this._ColorR=e}get albedoColorG(){return this._ColorG}set albedoColorG(e){this._ColorG=e}get albedoColorB(){return this._ColorB}set albedoColorB(e){this._ColorB=e}get albedoColorA(){return this._ColorA}set albedoColorA(e){this._ColorA=e}get albedoColor(){return this._albedoColor}set albedoColor(t){var r=this._shaderValues.getVector(e.ALBEDOCOLOR);n.scale(t,this._albedoIntensity,r),this._albedoColor=t,this._shaderValues.setVector(e.ALBEDOCOLOR,r)}get albedoIntensity(){return this._albedoIntensity}set albedoIntensity(e){this._AlbedoIntensity=e}get specularColorR(){return this._SpecColorR}set specularColorR(e){this._SpecColorR=e}get specularColorG(){return this._SpecColorG}set specularColorG(e){this._SpecColorG=e}get specularColorB(){return this._SpecColorB}set specularColorB(e){this._SpecColorB=e}get specularColorA(){return this._SpecColorA}set specularColorA(e){this._SpecColorA=e}get specularColor(){return this._shaderValues.getVector(e.MATERIALSPECULAR)}set specularColor(t){this._shaderValues.setVector(e.MATERIALSPECULAR,t)}get shininess(){return this._Shininess}set shininess(e){this._Shininess=e}get albedoTexture(){return this._shaderValues.getTexture(e.ALBEDOTEXTURE)}set albedoTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(e.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(e.ALBEDOTEXTURE,t)}get normalTexture(){return this._shaderValues.getTexture(e.NORMALTEXTURE)}set normalTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_NORMALMAP):this._shaderValues.removeDefine(e.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(e.NORMALTEXTURE,t)}get specularTexture(){return this._shaderValues.getTexture(e.SPECULARTEXTURE)}set specularTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_SPECULARMAP):this._shaderValues.removeDefine(e.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(e.SPECULARTEXTURE,t)}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}clone(){var t=new e;return this.cloneTo(t),t}cloneTo(e){super.cloneTo(e);var t=e;t._enableLighting=this._enableLighting,t._albedoIntensity=this._albedoIntensity,t._enableVertexColor=this._enableVertexColor,this._albedoColor.cloneTo(t._albedoColor)}}return e.RENDERMODE_OPAQUE=0,e.RENDERMODE_CUTOUT=1,e.RENDERMODE_TRANSPARENT=2,e.ALBEDOTEXTURE=Ae.propertyNameToID("u_DiffuseTexture"),e.NORMALTEXTURE=Ae.propertyNameToID("u_NormalTexture"),e.SPECULARTEXTURE=Ae.propertyNameToID("u_SpecularTexture"),e.ALBEDOCOLOR=Ae.propertyNameToID("u_DiffuseColor"),e.MATERIALSPECULAR=Ae.propertyNameToID("u_MaterialSpecular"),e.SHININESS=Ae.propertyNameToID("u_Shininess"),e.TILINGOFFSET=Ae.propertyNameToID("u_TilingOffset"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})(),be=(()=>{class e extends De{constructor(){super(),this.setShaderName("Effect"),this._color=new n(1,1,1,1),this._shaderValues.setVector(e.TINTCOLOR,new n(1,1,1,1)),this.renderMode=e.RENDERMODE_ADDTIVE}static __initDefine__(){e.SHADERDEFINE_MAINTEXTURE=Ae.getDefineByName("MAINTEXTURE"),e.SHADERDEFINE_TILINGOFFSET=Ae.getDefineByName("TILINGOFFSET"),e.SHADERDEFINE_ADDTIVEFOG=Ae.getDefineByName("ADDTIVEFOG")}get _TintColorR(){return this._color.x}set _TintColorR(e){this._color.x=e,this.color=this._color}get _TintColorG(){return this._color.y}set _TintColorG(e){this._color.y=e,this.color=this._color}get _TintColorB(){return this._color.z}set _TintColorB(e){this._color.z=e,this.color=this._color}get _TintColorA(){return this._color.w}set _TintColorA(e){this._color.w=e,this.color=this._color}get _MainTex_STX(){return this._shaderValues.getVector(e.TILINGOFFSET).x}set _MainTex_STX(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.x=t,this.tilingOffset=r}get _MainTex_STY(){return this._shaderValues.getVector(e.TILINGOFFSET).y}set _MainTex_STY(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.y=t,this.tilingOffset=r}get _MainTex_STZ(){return this._shaderValues.getVector(e.TILINGOFFSET).z}set _MainTex_STZ(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.z=t,this.tilingOffset=r}get _MainTex_STW(){return this._shaderValues.getVector(e.TILINGOFFSET).w}set _MainTex_STW(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.w=t,this.tilingOffset=r}set renderMode(t){switch(t){case e.RENDERMODE_ADDTIVE:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_NONE,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.addDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case e.RENDERMODE_ALPHABLENDED:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_NONE,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.removeDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.")}}get colorR(){return this._TintColorR}set colorR(e){this._TintColorR=e}get colorG(){return this._TintColorG}set colorG(e){this._TintColorG=e}get colorB(){return this._TintColorB}set colorB(e){this._TintColorB=e}get colorA(){return this._TintColorA}set colorA(e){this._TintColorA=e}get color(){return this._shaderValues.getVector(e.TINTCOLOR)}set color(t){this._shaderValues.setVector(e.TINTCOLOR,t)}get texture(){return this._shaderValues.getTexture(e.MAINTEXTURE)}set texture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(e.MAINTEXTURE,t)}get tilingOffsetX(){return this._MainTex_STX}set tilingOffsetX(e){this._MainTex_STX=e}get tilingOffsetY(){return this._MainTex_STY}set tilingOffsetY(e){this._MainTex_STY=e}get tilingOffsetZ(){return this._MainTex_STZ}set tilingOffsetZ(e){this._MainTex_STZ=e}get tilingOffsetW(){return this._MainTex_STW}set tilingOffsetW(e){this._MainTex_STW=e}get tilingOffset(){return this._shaderValues.getVector(e.TILINGOFFSET)}set tilingOffset(t){t&&(1!=t.x||1!=t.y||0!=t.z||0!=t.w)?this._shaderValues.addDefine(e.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(e.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(e.TILINGOFFSET,t)}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.RENDERMODE_ADDTIVE=0,e.RENDERMODE_ALPHABLENDED=1,e.MAINTEXTURE=Ae.propertyNameToID("u_AlbedoTexture"),e.TINTCOLOR=Ae.propertyNameToID("u_AlbedoColor"),e.TILINGOFFSET=Ae.propertyNameToID("u_TilingOffset"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})(),Pe=(()=>{class e extends De{constructor(){super(),this._enableLighting=!0,this.setShaderName("ExtendTerrain"),this.renderMode=e.RENDERMODE_OPAQUE}static __initDefine__(){e.SHADERDEFINE_DETAIL_NUM1=Ae.getDefineByName("ExtendTerrain_DETAIL_NUM1"),e.SHADERDEFINE_DETAIL_NUM2=Ae.getDefineByName("ExtendTerrain_DETAIL_NUM2"),e.SHADERDEFINE_DETAIL_NUM3=Ae.getDefineByName("ExtendTerrain_DETAIL_NUM3"),e.SHADERDEFINE_DETAIL_NUM4=Ae.getDefineByName("ExtendTerrain_DETAIL_NUM4"),e.SHADERDEFINE_DETAIL_NUM5=Ae.getDefineByName("ExtendTerrain_DETAIL_NUM5")}get splatAlphaTexture(){return this._shaderValues.getTexture(e.SPLATALPHATEXTURE)}set splatAlphaTexture(t){this._shaderValues.setTexture(e.SPLATALPHATEXTURE,t)}get diffuseTexture1(){return this._shaderValues.getTexture(e.DIFFUSETEXTURE1)}set diffuseTexture1(t){this._shaderValues.setTexture(e.DIFFUSETEXTURE1,t),this._setDetailNum(1)}get diffuseTexture2(){return this._shaderValues.getTexture(e.DIFFUSETEXTURE2)}set diffuseTexture2(t){this._shaderValues.setTexture(e.DIFFUSETEXTURE2,t),this._setDetailNum(2)}get diffuseTexture3(){return this._shaderValues.getTexture(e.DIFFUSETEXTURE3)}set diffuseTexture3(t){this._shaderValues.setTexture(e.DIFFUSETEXTURE3,t),this._setDetailNum(3)}get diffuseTexture4(){return this._shaderValues.getTexture(e.DIFFUSETEXTURE4)}set diffuseTexture4(t){this._shaderValues.setTexture(e.DIFFUSETEXTURE4,t),this._setDetailNum(4)}get diffuseTexture5(){return this._shaderValues.getTexture(e.DIFFUSETEXTURE5)}set diffuseTexture5(t){this._shaderValues.setTexture(e.DIFFUSETEXTURE5,t),this._setDetailNum(5)}set diffuseScaleOffset1(t){this._shaderValues.setVector(e.DIFFUSESCALEOFFSET1,t)}set diffuseScaleOffset2(t){this._shaderValues.setVector(e.DIFFUSESCALEOFFSET2,t)}set diffuseScaleOffset3(t){this._shaderValues.setVector(e.DIFFUSESCALEOFFSET3,t)}set diffuseScaleOffset4(t){this._shaderValues.setVector(e.DIFFUSESCALEOFFSET4,t)}set diffuseScaleOffset5(t){this._shaderValues.setVector(e.DIFFUSESCALEOFFSET5,t)}set renderMode(t){switch(t){case e.RENDERMODE_OPAQUE:this.renderQueue=De.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS;break;case e.RENDERMODE_TRANSPARENT:this.renderQueue=De.RENDERQUEUE_OPAQUE,this.depthWrite=!1,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LEQUAL;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}_setDetailNum(t){switch(t){case 1:this._shaderValues.addDefine(e.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._shaderValues.addDefine(e.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._shaderValues.addDefine(e.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._shaderValues.addDefine(e.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._shaderValues.addDefine(e.SHADERDEFINE_DETAIL_NUM5),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(e.SHADERDEFINE_DETAIL_NUM4)}}clone(){var t=new e;return this.cloneTo(t),t}}return e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=Ae.propertyNameToID("u_SplatAlphaTexture"),e.DIFFUSETEXTURE1=Ae.propertyNameToID("u_DiffuseTexture1"),e.DIFFUSETEXTURE2=Ae.propertyNameToID("u_DiffuseTexture2"),e.DIFFUSETEXTURE3=Ae.propertyNameToID("u_DiffuseTexture3"),e.DIFFUSETEXTURE4=Ae.propertyNameToID("u_DiffuseTexture4"),e.DIFFUSETEXTURE5=Ae.propertyNameToID("u_DiffuseTexture5"),e.DIFFUSESCALEOFFSET1=Ae.propertyNameToID("u_DiffuseScaleOffset1"),e.DIFFUSESCALEOFFSET2=Ae.propertyNameToID("u_DiffuseScaleOffset2"),e.DIFFUSESCALEOFFSET3=Ae.propertyNameToID("u_DiffuseScaleOffset3"),e.DIFFUSESCALEOFFSET4=Ae.propertyNameToID("u_DiffuseScaleOffset4"),e.DIFFUSESCALEOFFSET5=Ae.propertyNameToID("u_DiffuseScaleOffset5"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})();var we;(we=e.PBRRenderMode||(e.PBRRenderMode={}))[we.Opaque=0]="Opaque",we[we.Cutout=1]="Cutout",we[we.Fade=2]="Fade",we[we.Transparent=3]="Transparent";let Ve=(()=>{class t extends De{constructor(){super(),this._enableEmission=!1,this._shaderValues.setVector(t.ALBEDOCOLOR,new n(1,1,1,1)),this._shaderValues.setVector(t.EMISSIONCOLOR,new n(1,1,1,1)),this._shaderValues.setNumber(t.SMOOTHNESS,.5),this._shaderValues.setNumber(t.SMOOTHNESSSCALE,1),this._shaderValues.setNumber(t.OCCLUSIONSTRENGTH,1),this._shaderValues.setNumber(t.NORMALSCALE,1),this._shaderValues.setNumber(t.PARALLAXSCALE,.001),this._shaderValues.setNumber(De.ALPHATESTVALUE,.5),this.renderMode=e.PBRRenderMode.Opaque}static __init__(){t.SHADERDEFINE_ALBEDOTEXTURE=Ae.getDefineByName("ALBEDOTEXTURE"),t.SHADERDEFINE_NORMALTEXTURE=Ae.getDefineByName("NORMALTEXTURE"),t.SHADERDEFINE_PARALLAXTEXTURE=Ae.getDefineByName("PARALLAXTEXTURE"),t.SHADERDEFINE_OCCLUSIONTEXTURE=Ae.getDefineByName("OCCLUSIONTEXTURE"),t.SHADERDEFINE_EMISSION=Ae.getDefineByName("EMISSION"),t.SHADERDEFINE_EMISSIONTEXTURE=Ae.getDefineByName("EMISSIONTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=Ae.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_TRANSPARENTBLEND=Ae.getDefineByName("TRANSPARENTBLEND"),t.SHADERDEFINE_LAYA_PBR_BRDF_HIGH=Ae.getDefineByName("LAYA_PBR_BRDF_HIGH"),t.SHADERDEFINE_LAYA_PBR_BRDF_LOW=Ae.getDefineByName("LAYA_PBR_BRDF_LOW")}get albedoColor(){return this._shaderValues.getVector(t.ALBEDOCOLOR)}set albedoColor(e){this._shaderValues.setVector(t.ALBEDOCOLOR,e)}get albedoTexture(){return this._shaderValues.getTexture(t.ALBEDOTEXTURE)}set albedoTexture(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(t.ALBEDOTEXTURE,e)}get normalTexture(){return this._shaderValues.getTexture(t.NORMALTEXTURE)}set normalTexture(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(t.NORMALTEXTURE,e)}get normalTextureScale(){return this._shaderValues.getNumber(t.NORMALSCALE)}set normalTextureScale(e){this._shaderValues.setNumber(t.NORMALSCALE,e)}get parallaxTexture(){return this._shaderValues.getTexture(t.PARALLAXTEXTURE)}set parallaxTexture(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(t.PARALLAXTEXTURE,e)}get parallaxTextureScale(){return this._shaderValues.getNumber(t.PARALLAXSCALE)}set parallaxTextureScale(e){this._shaderValues.setNumber(t.PARALLAXSCALE,Math.max(.005,Math.min(.08,e)))}get occlusionTexture(){return this._shaderValues.getTexture(t.OCCLUSIONTEXTURE)}set occlusionTexture(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(t.OCCLUSIONTEXTURE,e)}get occlusionTextureStrength(){return this._shaderValues.getNumber(t.OCCLUSIONSTRENGTH)}set occlusionTextureStrength(e){this._shaderValues.setNumber(t.OCCLUSIONSTRENGTH,Math.max(0,Math.min(1,e)))}get smoothness(){return this._shaderValues.getNumber(t.SMOOTHNESS)}set smoothness(e){this._shaderValues.setNumber(t.SMOOTHNESS,Math.max(0,Math.min(1,e)))}get smoothnessTextureScale(){return this._shaderValues.getNumber(t.SMOOTHNESSSCALE)}set smoothnessTextureScale(e){this._shaderValues.setNumber(t.SMOOTHNESSSCALE,Math.max(0,Math.min(1,e)))}get enableEmission(){return this._enableEmission}set enableEmission(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_EMISSION):this._shaderValues.removeDefine(t.SHADERDEFINE_EMISSION),this._enableEmission=e}get emissionColor(){return this._shaderValues.getVector(t.EMISSIONCOLOR)}set emissionColor(e){this._shaderValues.setVector(t.EMISSIONCOLOR,e)}get emissionTexture(){return this._shaderValues.getTexture(t.EMISSIONTEXTURE)}set emissionTexture(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(t.EMISSIONTEXTURE,e)}get tilingOffset(){return this._shaderValues.getVector(t.TILINGOFFSET)}set tilingOffset(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}get depthWrite(){return this._shaderValues.getBool(t.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(t.CULL)}set cull(e){this._shaderValues.setInt(t.CULL,e)}get blend(){return this._shaderValues.getInt(t.BLEND)}set blend(e){this._shaderValues.setInt(t.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(t.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(t.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(t.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(t.BLEND_DST,e)}get depthTest(){return this._shaderValues.getInt(t.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}set renderMode(r){switch(r){case e.PBRRenderMode.Opaque:this.alphaTest=!1,this.renderQueue=De.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Cutout:this.renderQueue=De.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Fade:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Transparent:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_ONE,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.addDefine(t.SHADERDEFINE_TRANSPARENTBLEND);break;default:throw new Error("PBRMaterial:unknown renderMode value.")}}get enableReflection(){return!0}set enableReflection(e){}}return t.ALBEDOTEXTURE=Ae.propertyNameToID("u_AlbedoTexture"),t.ALBEDOCOLOR=Ae.propertyNameToID("u_AlbedoColor"),t.TILINGOFFSET=Ae.propertyNameToID("u_TilingOffset"),t.NORMALTEXTURE=Ae.propertyNameToID("u_NormalTexture"),t.NORMALSCALE=Ae.propertyNameToID("u_NormalScale"),t.SMOOTHNESS=Ae.propertyNameToID("u_Smoothness"),t.SMOOTHNESSSCALE=Ae.propertyNameToID("u_SmoothnessScale"),t.OCCLUSIONTEXTURE=Ae.propertyNameToID("u_OcclusionTexture"),t.OCCLUSIONSTRENGTH=Ae.propertyNameToID("u_occlusionStrength"),t.PARALLAXTEXTURE=Ae.propertyNameToID("u_ParallaxTexture"),t.PARALLAXSCALE=Ae.propertyNameToID("u_ParallaxScale"),t.EMISSIONTEXTURE=Ae.propertyNameToID("u_EmissionTexture"),t.EMISSIONCOLOR=Ae.propertyNameToID("u_EmissionColor"),t.CULL=Ae.propertyNameToID("s_Cull"),t.BLEND=Ae.propertyNameToID("s_Blend"),t.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),t.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),t.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),t.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),t.renderQuality=e.PBRRenderQuality.High,t})();class Fe{constructor(){this.textureID=-1}}class Be extends t.Resource{constructor(e,t,r,i,n){super(),this._stateParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1,this._vs=e,this._ps=t,this._attributeMap=r,this._uniformMap=i,this._shaderPass=n,this._create(),this.lock=!0}_create(){var e=t.LayaGL.instance;for(var r in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[r],r);if(e.linkProgram(this._program),!t.Render.isConchApp&&Ae.debugMode&&!e.getProgramParameter(this._program,e.LINK_STATUS))throw e.getProgramInfoLog(this._program);var i=[],n=[],a=[],s=[],o=[];this._customUniformParamsMap=[];var l,_,h,c=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);for(t.WebGLContext.useProgram(e,this._program),this._curActTexIndex=0,_=0;_<c;_++){var d=e.getActiveUniform(this._program,_),u=d.name;(l=new Fe).location=e.getUniformLocation(this._program,u),u.indexOf("[0]")>0?(l.name=u=u.substr(0,u.length-3),l.isArray=!0):(l.name=u,l.isArray=!1),l.type=d.type,this._addShaderUnifiormFun(l);var m=this._uniformMap[u];if(null!=m)switch(l.dataOffset=Ae.propertyNameToID(u),m){case Ae.PERIOD_CUSTOM:o.push(l);break;case Ae.PERIOD_MATERIAL:s.push(l);break;case Ae.PERIOD_SPRITE:a.push(l);break;case Ae.PERIOD_CAMERA:n.push(l);break;case Ae.PERIOD_SCENE:i.push(l);break;default:throw new Error("Shader3D: period is unkonw.")}}for(this._sceneUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*i.length*5+4,64,!0),_=0,h=i.length;_<h;_++)this._sceneUniformParamsMap.addShaderUniform(i[_]);for(this._cameraUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*n.length*5+4,64,!0),_=0,h=n.length;_<h;_++)this._cameraUniformParamsMap.addShaderUniform(n[_]);for(this._spriteUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*a.length*5+4,64,!0),_=0,h=a.length;_<h;_++)this._spriteUniformParamsMap.addShaderUniform(a[_]);for(this._materialUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*s.length*5+4,64,!0),_=0,h=s.length;_<h;_++)this._materialUniformParamsMap.addShaderUniform(s[_]);for(this._customUniformParamsMap.length=o.length,_=0,h=o.length;_<h;_++){var f=o[_];this._customUniformParamsMap[f.dataOffset]=f}var T=this._shaderPass._stateMap;for(var E in T)this._stateParamsMap[T[E]]=Ae.propertyNameToID(E)}_getRenderState(e,t){var r=this._stateParamsMap[t];return null==r?null:e[r]}_disposeResource(){t.LayaGL.instance.deleteShader(this._vshader),t.LayaGL.instance.deleteShader(this._pshader),t.LayaGL.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0}_addShaderUnifiormFun(e){var r=t.LayaGL.instance;e.caller=this;var i=e.isArray;switch(e.type){case r.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case r.INT:e.fun=i?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case r.FLOAT:e.fun=i?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case r.FLOAT_VEC2:e.fun=i?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case r.FLOAT_VEC3:e.fun=i?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case r.FLOAT_VEC4:e.fun=i?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case r.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case r.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case r.FLOAT_MAT4:e.fun=i?this._uniformMatrix4fv:this._uniformMatrix4f;break;case r.SAMPLER_2D:case r.SAMPLER_2D_SHADOW:r.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case 35679:r.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case r.SAMPLER_CUBE:r.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!")}}_createShader(e,t,r){var i=e.createShader(r);if(e.shaderSource(i,t),e.compileShader(i),Ae.debugMode&&!e.getShaderParameter(i,e.COMPILE_STATUS))throw e.getShaderInfoLog(i);return i}_uniform1f(e,r){var i=e.uploadedValue;return i[0]!==r?(t.LayaGL.instance.uniform1f(e.location,i[0]=r),1):0}_uniform1fv(e,r){if(r.length<4){var i=e.uploadedValue;return i[0]!==r[0]||i[1]!==r[1]||i[2]!==r[2]||i[3]!==r[3]?(t.LayaGL.instance.uniform1fv(e.location,r),i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],1):0}return t.LayaGL.instance.uniform1fv(e.location,r),1}_uniform_vec2(e,r){var i=e.uploadedValue;return i[0]!==r.x||i[1]!==r.y?(t.LayaGL.instance.uniform2f(e.location,i[0]=r.x,i[1]=r.y),1):0}_uniform_vec2v(e,r){if(r.length<2){var i=e.uploadedValue;return i[0]!==r[0]||i[1]!==r[1]||i[2]!==r[2]||i[3]!==r[3]?(t.LayaGL.instance.uniform2fv(e.location,r),i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],1):0}return t.LayaGL.instance.uniform2fv(e.location,r),1}_uniform_vec3(e,r){var i=e.uploadedValue;return i[0]!==r.x||i[1]!==r.y||i[2]!==r.z?(t.LayaGL.instance.uniform3f(e.location,i[0]=r.x,i[1]=r.y,i[2]=r.z),1):0}_uniform_vec3v(e,r){return t.LayaGL.instance.uniform3fv(e.location,r),1}_uniform_vec4(e,r){var i=e.uploadedValue;return i[0]!==r.x||i[1]!==r.y||i[2]!==r.z||i[3]!==r.w?(t.LayaGL.instance.uniform4f(e.location,i[0]=r.x,i[1]=r.y,i[2]=r.z,i[3]=r.w),1):0}_uniform_vec4v(e,r){return t.LayaGL.instance.uniform4fv(e.location,r),1}_uniformMatrix2fv(e,r){return t.LayaGL.instance.uniformMatrix2fv(e.location,!1,r),1}_uniformMatrix3fv(e,r){return t.LayaGL.instance.uniformMatrix3fv(e.location,!1,r),1}_uniformMatrix4f(e,r){var i=r.elements;return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,i),1}_uniformMatrix4fv(e,r){return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,r),1}_uniform1i(e,r){var i=e.uploadedValue;return i[0]!==r?(t.LayaGL.instance.uniform1i(e.location,i[0]=r),1):0}_uniform1iv(e,r){return t.LayaGL.instance.uniform1iv(e.location,r),1}_uniform_ivec2(e,r){var i=e.uploadedValue;return i[0]!==r[0]||i[1]!==r[1]?(t.LayaGL.instance.uniform2i(e.location,i[0]=r[0],i[1]=r[1]),1):0}_uniform_ivec2v(e,r){return t.LayaGL.instance.uniform2iv(e.location,r),1}_uniform_vec3i(e,r){var i=e.uploadedValue;return i[0]!==r[0]||i[1]!==r[1]||i[2]!==r[2]?(t.LayaGL.instance.uniform3i(e.location,i[0]=r[0],i[1]=r[1],i[2]=r[2]),1):0}_uniform_vec3vi(e,r){return t.LayaGL.instance.uniform3iv(e.location,r),1}_uniform_vec4i(e,r){var i=e.uploadedValue;return i[0]!==r[0]||i[1]!==r[1]||i[2]!==r[2]||i[3]!==r[3]?(t.LayaGL.instance.uniform4i(e.location,i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3]),1):0}_uniform_vec4vi(e,r){return t.LayaGL.instance.uniform4iv(e.location,r),1}_uniform_sampler2D(e,r){var i=r._getSource()||r.defaulteTexture._getSource(),n=t.LayaGL.instance;return t.WebGLContext.activeTexture(n,e.textureID),t.WebGLContext.bindTexture(n,n.TEXTURE_2D,i),0}_uniform_sampler3D(e,r){var i=r._getSource()||r.defaulteTexture._getSource(),n=t.LayaGL.instance;return t.WebGLContext.activeTexture(n,e.textureID),t.WebGLContext.bindTexture(n,WebGL2RenderingContext.TEXTURE_3D,i),0}_uniform_samplerCube(e,r){var i=r._getSource()||r.defaulteTexture._getSource(),n=t.LayaGL.instance;return t.WebGLContext.activeTexture(n,e.textureID),t.WebGLContext.bindTexture(n,n.TEXTURE_CUBE_MAP,i),0}bind(){return t.WebGLContext.useProgram(t.LayaGL.instance,this._program)}uploadUniforms(e,r,i){t.Stat.shaderCall+=t.LayaGLRunner.uploadShaderUniforms(t.LayaGL.instance,e,r,i)}uploadRenderStateBlendDepth(e){var r=t.LayaGL.instance,i=this._shaderPass.renderState,n=e.getData(),a=this._getRenderState(n,Ae.RENDER_STATE_DEPTH_WRITE),s=this._getRenderState(n,Ae.RENDER_STATE_DEPTH_TEST),o=this._getRenderState(n,Ae.RENDER_STATE_BLEND);switch(null==a&&(a=i.depthWrite),null==s&&(s=i.depthTest),null==o&&(o=i.blend),t.WebGLContext.setDepthMask(r,a),s===Oe.DEPTHTEST_OFF?t.WebGLContext.setDepthTest(r,!1):(t.WebGLContext.setDepthTest(r,!0),t.WebGLContext.setDepthFunc(r,s)),o){case Oe.BLEND_DISABLE:t.WebGLContext.setBlend(r,!1);break;case Oe.BLEND_ENABLE_ALL:var l=this._getRenderState(n,Ae.RENDER_STATE_BLEND_EQUATION),_=this._getRenderState(n,Ae.RENDER_STATE_BLEND_SRC),h=this._getRenderState(n,Ae.RENDER_STATE_BLEND_DST);null==l&&(l=i.blendEquation),null==_&&(_=i.srcBlend),null==h&&(h=i.dstBlend),t.WebGLContext.setBlend(r,!0),t.WebGLContext.setBlendEquation(r,l),t.WebGLContext.setBlendFunc(r,_,h);break;case Oe.BLEND_ENABLE_SEPERATE:var c=this._getRenderState(n,Ae.RENDER_STATE_BLEND_EQUATION_RGB),d=this._getRenderState(n,Ae.RENDER_STATE_BLEND_EQUATION_ALPHA),u=this._getRenderState(n,Ae.RENDER_STATE_BLEND_SRC_RGB),m=this._getRenderState(n,Ae.RENDER_STATE_BLEND_DST_RGB),f=this._getRenderState(n,Ae.RENDER_STATE_BLEND_SRC_ALPHA),T=this._getRenderState(n,Ae.RENDER_STATE_BLEND_DST_ALPHA);null==c&&(c=i.blendEquationRGB),null==d&&(d=i.blendEquationAlpha),null==u&&(u=i.srcBlendRGB),null==m&&(m=i.dstBlendRGB),null==f&&(f=i.srcBlendAlpha),null==T&&(T=i.dstBlendAlpha),t.WebGLContext.setBlend(r,!0),t.WebGLContext.setBlendEquationSeparate(r,c,d),t.WebGLContext.setBlendFuncSeperate(r,u,m,f,T)}}uploadRenderStateFrontFace(e,r,i){var n,a=t.LayaGL.instance,s=this._shaderPass.renderState,o=e.getData(),l=this._getRenderState(o,Ae.RENDER_STATE_CULL);switch(null==l&&(l=s.cull),l){case Oe.CULL_NONE:t.WebGLContext.setCullFace(a,!1);break;case Oe.CULL_FRONT:t.WebGLContext.setCullFace(a,!0),n=r?i?a.CCW:a.CW:i?a.CW:a.CCW,t.WebGLContext.setFrontFace(a,n);break;case Oe.CULL_BACK:t.WebGLContext.setCullFace(a,!0),n=r?i?a.CW:a.CCW:i?a.CCW:a.CW,t.WebGLContext.setFrontFace(a,n)}}uploadCustomUniform(e,r){t.Stat.shaderCall+=t.LayaGLRunner.uploadCustomUniform(t.LayaGL.instance,this._customUniformParamsMap,e,r)}_uniformMatrix2fvForNative(e,r){return t.LayaGL.instance.uniformMatrix2fvEx(e.location,!1,r),1}_uniformMatrix3fvForNative(e,r){return t.LayaGL.instance.uniformMatrix3fvEx(e.location,!1,r),1}_uniformMatrix4fvForNative(e,r){return t.LayaGL.instance.uniformMatrix4fvEx(e.location,!1,r),1}}class Ue extends E{constructor(){super()}add(e){if(-1!==e._getIndexInList())throw"SimpleSingletonList:"+e+" has  in  SingletonList.";this._add(e),e._setIndexInList(this.length++)}remove(e){var t=e._getIndexInList();if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._setIndexInList(t)}e._setIndexInList(-1)}clear(){for(var e=this.elements,t=0,r=this.length;t<r;t++)e[t]._setIndexInList(-1);this.length=0}}let Ge=(()=>{class e{constructor(e=1,t=1,r=1,i=1){this.r=e,this.g=t,this.b=r,this.a=i}static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}toLinear(t){t.r=e.gammaToLinearSpace(this.r),t.g=e.gammaToLinearSpace(this.g),t.b=e.gammaToLinearSpace(this.b)}toGamma(t){t.r=e.linearToGammaSpace(this.r),t.g=e.linearToGammaSpace(this.g),t.b=e.linearToGammaSpace(this.b)}cloneTo(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}clone(){var t=new e;return this.cloneTo(t),t}forNativeElement(){}}return e.RED=new e(1,0,0,1),e.GREEN=new e(0,1,0,1),e.BLUE=new e(0,0,1,1),e.CYAN=new e(0,1,1,1),e.YELLOW=new e(1,.92,.016,1),e.MAGENTA=new e(1,0,1,1),e.GRAY=new e(.5,.5,.5,1),e.WHITE=new e(1,1,1,1),e.BLACK=new e(0,0,0,1),e})();class ze{}class He{}let We=(()=>{class e{static __init__(){t.Render.supportWebGLPlusCulling&&(e._cullingBufferLength=0,e._cullingBuffer=new Float32Array(4096))}static _drawTraversalCullingBound(t,r){for(var i=t.elements,n=0,a=t.length;n<a;n++){var s=e._tempColor0;s.r=0,s.g=1,s.b=0,s.a=1,k._drawBound(r,i[n].bounds._getBoundBox(),s)}}static _traversalCulling(e,r,i,n,s,o,l){for(var _=n.elements,h=e.boundFrustum,c=e.position,d=e.cullingMask,u=t.Stat.loopCount,m=0,f=n.length;m<f;m++){var T=_[m];if((l?T._castShadow&&T._enable:0!=(Math.pow(2,T._owner._layer)&d)&&T._enable)&&(t.Stat.frustumCulling++,!e.useOcclusionCulling||T._needRender(h,i))){T._renderMark=u,T._distanceForSort=a.distance(T.bounds.getCenter(),c);for(var E=T._renderElements,p=0,g=E.length;p<g;p++)E[p]._update(r,i,s,o)}}}static renderObjectCulling(t,r,i,n,a,s){var o=r._opaqueQueue,l=r._transparentQueue,_=r._renders;r._clearRenderQueue();var h=r._octree;if(h&&(h.updateMotionObjects(),h.shrinkRootIfPossible(),h.getCollidingWithFrustum(t,i,n,a,s)),e._traversalCulling(t,r,i,_,n,a,s),e.debugFrustumCulling){var c=r._debugTool;c.clear(),h&&(h.drawAllBounds(c),h.drawAllObjects(c)),e._drawTraversalCullingBound(_,c)}var d=o.elements.length;d>0&&o._quickSort(0,d-1),(d=l.elements.length)>0&&l._quickSort(0,d-1)}static cullingShadow(e,r,i){var n=r._renders;r._clearRenderQueue();for(var s=r._opaqueQueue,o=e.position,l=e.cullPlaneCount,_=e.cullPlanes,h=(e.cullSphere,e.direction,n.elements),c=t.Stat.loopCount,d=0,u=n.length;d<u;d++){var m=h[d];if(m._castShadow&&m._enable){t.Stat.frustumCulling++;for(var f=m.bounds,T=f.getMin(),E=f.getMax(),p=T.x,g=T.y,S=T.z,R=E.x,v=E.y,A=E.z,I=!0,x=0;x<l;x++){var C=_[x],L=C.normal;if(C.distance+L.x*(L.x<0?p:R)+L.y*(L.y<0?g:v)+L.z*(L.z<0?S:A)<0){I=!1;break}}if(I){m._renderMark=c,m._distanceForSort=a.distance(f.getCenter(),o);for(var y=m._renderElements,D=(x=0,y.length);x<D;x++)y[x]._update(r,i,null,null)}}}return s.elements.length>0}static cullingSpotShadow(e,r,i){var n=r._renders;r._clearRenderQueue();for(var s=r._opaqueQueue,o=n.elements,l=t.Stat.loopCount,_=0,h=n.length;_<h;_++){var c=o[_];if(c._castShadow&&c._enable&&c._needRender(e.boundFrustum,i)){var d=c.bounds;c._renderMark=l,c._distanceForSort=a.distance(d.getCenter(),e.position);for(var u=c._renderElements,m=0,f=u.length;m<f;m++)u[m]._update(r,i,null,null)}}return s.elements.length>0}static renderObjectCullingNative(r,i,n,s,o,l){var _,h,c,d=i._opaqueQueue,u=i._transparentQueue;i._clearRenderQueue();var m=s.length,f=s.elements;for(_=0;_<m;_++)f[_].bounds,f[_]._updateForNative&&f[_]._updateForNative(n);r.boundFrustum;e.cullingNative(r._boundFrustumBuffer,e._cullingBuffer,i._cullingBufferIndices,m,i._cullingBufferResult);var T=t.Stat.loopCount,E=n.camera._transform.position;for(_=0;_<m;_++){var p=f[_];if(!r.useOcclusionCulling||r._isLayerVisible(p._owner._layer)&&p._enable&&i._cullingBufferResult[_]){p._renderMark=T,p._distanceForSort=a.distance(p.bounds.getCenter(),E);var g=p._renderElements;for(h=0,c=g.length;h<c;h++){g[h]._update(i,n,o,l)}}}var S=d.elements.length;S>0&&d._quickSort(0,S-1),(S=u.elements.length)>0&&u._quickSort(0,S-1)}static cullingNative(e,r,i,n,a){return t.LayaGL.instance.culling(e,r,i,n,a)}}return e._tempColor0=new Ge,e._tempVector0=new a,e._cameraCullInfo=new ze,e._shadowCullInfo=new He,e.debugFrustumCulling=!1,e})();class ke{}class Xe{constructor(){this.updateMark=-1,this.pointLightCount=0,this.spotLightCount=0,this.indices=[]}}let Ye=(()=>{class e{constructor(e,t,r,n){this._updateMark=0,this._depthSliceParam=new i,this._xSlices=e,this._ySlices=t,this._zSlices=r;var a=e*t,s=r*(1+Math.ceil(n/4));this._clusterTexture=k._createFloatTextureBuffer(a,s),this._clusterTexture.lock=!0,this._clusterPixels=new Float32Array(a*s*4);for(var o=new Array(this._zSlices),l=0;l<this._zSlices;l++){o[l]=new Array(this._ySlices);for(var _=0;_<this._ySlices;_++){o[l][_]=new Array(this._xSlices);for(var h=0;h<this._xSlices;h++)o[l][_][h]=new Xe}}this._clusterDatas=o}_insertSpotLightSphere(t,r,i,n,s){var o=e._tempVector35;o.x=s.x-t.x,o.y=s.y-t.y,o.z=s.z-t.z;var l=a.dot(o,o),_=s.w;if(!(l>_*_))return!1;var h=a.dot(o,r);return!(Math.cos(n)*Math.sqrt(l-h*h)-h*Math.sin(n)>_||h>_+i||h<-_)}_placePointLightToClusters(e,t){for(var r=this._clusterDatas,i=this._updateMark,n=t.zMin,a=t.zMax;n<a;n++)for(var s=t.yMin,o=t.yMax;s<o;s++)for(var l=t.xMin,_=t.xMax;l<_;l++){var h=r[n][s][l];h.updateMark!=i&&(h.pointLightCount=0,h.spotLightCount=0,h.updateMark=i);var c=h.indices,d=h.pointLightCount++;d<c.length?c[d]=e:c.push(e)}}_placeSpotLightToClusters(e,t){for(var r=this._clusterDatas,i=this._updateMark,n=t.zMin,a=t.zMax;n<a;n++)for(var s=t.yMin,o=t.yMax;s<o;s++)for(var l=t.xMin,_=t.xMax;l<_;l++){var h=r[n][s][l];h.updateMark!=i&&(h.pointLightCount=0,h.spotLightCount=0,h.updateMark=i);var c=h.indices,d=h.pointLightCount+h.spotLightCount++;d<c.length?c[d]=e:c.push(e)}}_insertConePlane(t,r,i,n,s){var o=e._tempVector36,l=e._tempVector37;a.cross(s,r,o),a.cross(o,r,l),a.normalize(l,l);var _=i*Math.tan(n),h=t.x+i*r.x+_*l.x,c=t.y+i*r.y+_*l.y,d=t.z+i*r.z+_*l.z;return h*s.x+c*s.y+d*s.z<=0||t.x*s.x+t.y*s.y+t.z*s.z<=0}_shrinkSphereLightZPerspective(e,t,r,i,n){var a=r.z,s=a-i,o=a+i;if(s>t||o<=e)return!1;var l=this._depthSliceParam;return n.zMin=Math.floor(Math.log2(Math.max(s,e))*l.x-l.y),n.zMax=Math.min(Math.ceil(Math.log2(o)*l.x-l.y),this._zSlices),!0}_shrinkSpotLightZPerspective(e,t,r,i,n,a,s){var o=i.x,l=i.y,_=i.z,h=Math.tan(a)*n,c=r.x,d=r.y,u=r.z,m=o-c,f=l-d,T=_-u,E=m*m+f*f+T*T,p=Math.sqrt(1-T*T/E),g=Math.max(Math.min(u,_-p*h),r.z-n),S=Math.min(Math.max(u,_+p*h),r.z+n);if(g>t||S<=e)return!1;var R=this._depthSliceParam;return s.zMin=Math.floor(Math.log2(Math.max(g,e))*R.x-R.y),s.zMax=Math.min(Math.ceil(Math.log2(S)*R.x-R.y),this._zSlices),!0}_shrinkSphereLightByBoundOrth(e,t,r,i,n,a,s){var o=n.z,l=o-a,_=o+a;if(l>i||_<=r)return!1;var h=n.x,c=h-a,d=h+a;if(c>e||d<=-e)return!1;var u=n.y,m=u-a,f=u+a;if(m>t||f<=-t)return!1;var T=this._xSlices,E=this._ySlices,p=this._depthSliceParam,g=2*e/T,S=2*t/E;return s.xMin=Math.max(Math.floor((c+e)/g),0),s.xMax=Math.min(Math.ceil((d+e)/g),T),s.yMin=Math.max(Math.floor((t-f)/S),0),s.yMax=Math.min(Math.ceil((t-m)/S),E),s.zMin=Math.floor(Math.log2(Math.max(l,r))*p.x-p.y),s.zMax=Math.min(Math.ceil(Math.log2(_)*p.x-p.y),this._zSlices),!0}_shrinkSpotLightByBoundOrth(e,t,r,i,n,a,s,o,l){var _=a.x,h=a.y,c=a.z,d=Math.tan(o)*s,u=n.x,m=n.y,f=n.z,T=_-u,E=h-m,p=c-f,g=T*T+E*E+p*p,S=Math.sqrt(1-p*p/g),R=Math.max(Math.min(f,c-S*d),n.z-s),v=Math.min(Math.max(f,c+S*d),n.z+s);if(R>i||v<=r)return!1;var A=Math.sqrt(1-T*T/g),I=Math.max(Math.min(u,_-A*d),n.x-s),x=Math.min(Math.max(u,_+A*d),n.x+s);if(I>e||x<=-e)return!1;var C=Math.sqrt(1-E*E/g),L=Math.max(Math.min(m,h-C*d),n.y-s),y=Math.min(Math.max(m,h+C*d),n.y+s);if(L>t||y<=-t)return!1;var D=this._xSlices,M=this._ySlices,O=this._depthSliceParam,N=2*e/D,b=2*t/M;return l.xMin=Math.max(Math.floor((I+e)/N),0),l.xMax=Math.min(Math.ceil((x+e)/N),D),l.yMin=Math.max(Math.floor((t-y)/b),0),l.yMax=Math.min(Math.ceil((t-L)/b),M),l.zMin=Math.floor(Math.log2(Math.max(R,r))*O.x-O.y),l.zMax=Math.min(Math.ceil(Math.log2(v)*O.x-O.y),this._zSlices),!0}_shrinkXYByRadiusPerspective(e,t,r,i,n){var a,s,o,l,_,h=e.x,c=e.y,d=e.z,u=this._ySlices+1;for(_=0;_<u;_++){if(c*(m=n[_]).y+d*m.z<t){s=Math.max(0,_-1);break}}if(_==u)return!1;for(l=this._ySlices,_=s+1;_<u;_++){if(c*(m=n[_]).y+d*m.z<=-t){l=Math.max(0,_);break}}for(u=this._xSlices+1,_=0;_<u;_++){if(h*(m=i[_]).x+d*m.z<t){a=Math.max(0,_-1);break}}for(o=this._xSlices,_=a+1;_<u;_++){var m;if(h*(m=i[_]).x+d*m.z<=-t){o=Math.max(0,_);break}}return r.xMin=a,r.xMax=o,r.yMin=s,r.yMax=l,!0}_shrinkSpotXYByConePerspective(t,r,i,n,a,s,o){for(var l,_,h,c,d=e._tempVector32,u=a.yMax+1,m=a.yMin+1;m<u;m++)if(this._insertConePlane(t,r,i,n,o[m])){_=Math.max(0,m-1);break}c=a.yMax;for(m=_+1;m<u;m++){var f=o[m];if(d.setValue(0,-f.y,-f.z),!this._insertConePlane(t,r,i,n,d)){c=Math.max(0,m);break}}u=a.xMax+1;for(m=a.xMin+1;m<u;m++)if(this._insertConePlane(t,r,i,n,s[m])){l=Math.max(0,m-1);break}h=a.xMax;for(m=l+1;m<u;m++){f=s[m];if(d.setValue(-f.x,0,-f.z),!this._insertConePlane(t,r,i,n,d)){h=Math.max(0,m);break}}a.xMin=l,a.xMax=h,a.yMin=_,a.yMax=c}_updatePointLightPerspective(t,r,i,n,s,o,l){var _=e._tempLightBound,h=e._tempVector30;a.transformV3ToV3(n._transform.position,i,h),h.z*=-1,this._shrinkSphereLightZPerspective(t,r,h,n.range,_)&&this._shrinkXYByRadiusPerspective(h,n.range,_,o,l)&&this._placePointLightToClusters(s,_)}_updateSpotLightPerspective(t,r,i,n,s,o,l){var _=e._tempLightBound,h=e._tempVector30,c=e._tempVector31,d=e._tempVector34,u=n._transform.position,m=n.range;n._transform.worldMatrix.getForward(c),a.normalize(c,c),a.scale(c,m,d),a.add(u,d,d),a.transformV3ToV3(u,i,h),a.transformV3ToV3(d,i,d),h.z*=-1,d.z*=-1;var f=n.spotAngle/2*Math.PI/180;if(this._shrinkSpotLightZPerspective(t,r,h,d,m,f,_)&&this._shrinkXYByRadiusPerspective(h,m,_,o,l)){var T=e._tempVector33;T.x=d.x-h.x,T.y=d.y-h.y,T.z=d.z-h.z,a.normalize(T,T),this._shrinkSpotXYByConePerspective(h,T,m,f,_,o,l),this._placeSpotLightToClusters(s,_)}}_updatePointLightOrth(t,r,i,n,s,o,l){var _=e._tempLightBound,h=e._tempVector30;a.transformV3ToV3(o._transform.position,s,h),h.z*=-1,this._shrinkSphereLightByBoundOrth(t,r,i,n,h,o.range,_)&&this._placePointLightToClusters(l,_)}_updateSpotLightOrth(t,r,i,n,s,o,l){var _=e._tempLightBound,h=e._tempVector30,c=e._tempVector31,d=e._tempVector34,u=o._transform.position,m=o.range;o._transform.worldMatrix.getForward(c),a.normalize(c,c),a.scale(c,m,d),a.add(u,d,d),a.transformV3ToV3(u,s,h),a.transformV3ToV3(d,s,d),h.z*=-1,d.z*=-1;var f=o.spotAngle/2*Math.PI/180;this._shrinkSpotLightByBoundOrth(t,r,i,n,h,d,m,f,_)&&this._placeSpotLightToClusters(l,_)}update(e,t){this._updateMark++;var r=e.nearPlane;this._depthSliceParam.x=Q._config.lightClusterCount.z/Math.log2(e.farPlane/r),this._depthSliceParam.y=Math.log2(r)*this._depthSliceParam.x;var i=e.nearPlane,n=e.farPlane,a=e.viewMatrix,s=t._directionLights._length,o=t._pointLights,l=o._length,_=o._elements,h=t._spotLights,c=h._length,d=h._elements;if(e.orthographic){for(var u=e.orthographicVerticalSize/2,m=u*e.aspectRatio,f=0;f<l;f++,s++)this._updatePointLightOrth(m,u,i,n,a,_[f],s);for(f=0;f<c;f++,s++)this._updateSpotLightOrth(m,u,i,n,a,d[f],s)}else{e._updateClusterPlaneXY();var T=e._clusterXPlanes,E=e._clusterYPlanes;for(f=0;f<l;f++,s++)this._updatePointLightPerspective(i,n,a,_[f],s,T,E);for(f=0;f<c;f++,s++)this._updateSpotLightPerspective(i,n,a,d[f],s,T,E)}if(l+c>0){for(var p=this._xSlices,g=this._ySlices,S=this._zSlices,R=p*g*4,v=R*S,A=this._clusterPixels,I=A.length,x=this._clusterDatas,C=this._updateMark,L=!0,y=0;y<S;y++)for(var D=0;D<g;D++)for(var M=0;M<p;M++){var O=x[y][D][M],N=4*(M+D*p+y*p*g);if(O.updateMark!==C)A[N]=0,A[N+1]=0;else if(L){var b=O.indices,P=O.pointLightCount,w=O.spotLightCount,V=P+w;if(v+V<I){A[N]=P,A[N+1]=w,A[N+2]=Math.floor(v/R),A[N+3]=v%R;for(f=0;f<V;f++)A[v++]=b[f]}else{V=I-(v+V),P=Math.min(P,V),A[N]=P,A[N+1]=Math.min(w,V-P),A[N+2]=Math.floor(v/R),A[N+3]=v%R;for(f=0;f<V;f++)A[v++]=b[f];L=!1}}}var F=this._clusterTexture.width;this._clusterTexture.setSubPixels(0,0,F,Math.ceil(v/(4*F)),A)}}}return e._tempVector30=new a,e._tempVector31=new a,e._tempVector32=new a,e._tempVector33=new a,e._tempVector34=new a,e._tempVector35=new a,e._tempVector36=new a,e._tempVector37=new a,e._tempLightBound=new ke,e})(),je=(()=>{class e{constructor(){this._coefficients=new Float32Array(27)}getCoefficient(e,t){return this._coefficients[9*e+t]}setCoefficient(e,t,r){this._coefficients[9*e+t]=r}setCoefficients(e,t,r,i,n,a,s,o,l,_){var h=9*e;this._coefficients[h]=t,this._coefficients[++h]=r,this._coefficients[++h]=i,this._coefficients[++h]=n,this._coefficients[++h]=a,this._coefficients[++h]=s,this._coefficients[++h]=o,this._coefficients[++h]=l,this._coefficients[++h]=_}cloneTo(e){if(this!==e)for(var t=this._coefficients,r=e._coefficients,i=0;i<27;i++)r[i]=t[i]}}return e._default=new e,e})();class Ze{constructor(){this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0}}class qe{constructor(){this._indexInList=-1,this._identifier=-1,this._position=new i}get identifier(){return this._identifier}get position(){return this._position}_getIndexInList(){return this._indexInList}_setIndexInList(e){this._indexInList=e}}let Qe=(()=>{class e{constructor(e,t=0){this.normal=e,this.distance=t}static createPlaneBy3P(e,t,r,i){var n=t.x-e.x,a=t.y-e.y,s=t.z-e.z,o=r.x-e.x,l=r.y-e.y,_=r.z-e.z,h=a*_-s*l,c=s*o-n*_,d=n*l-a*o,u=1/Math.sqrt(h*h+c*c+d*d),m=h*u,f=c*u,T=d*u,E=i.normal;E.x=m,E.y=f,E.z=T,i.distance=-(m*e.x+f*e.y+T*e.z)}normalize(){var e=this.normal.x,t=this.normal.y,r=this.normal.z,i=1/Math.sqrt(e*e+t*t+r*r);this.normal.x=e*i,this.normal.y=t*i,this.normal.z=r*i,this.distance*=i}cloneTo(e){var t=e;this.normal.cloneTo(t.normal),t.distance=this.distance}clone(){var t=new e(new a);return this.cloneTo(t),t}}return e.PlaneIntersectionType_Back=0,e.PlaneIntersectionType_Front=1,e.PlaneIntersectionType_Intersecting=2,e})();class Ke{constructor(e,t){this.origin=e,this.direction=t}}let Je=(()=>{class e{}return e.Disjoint=0,e.Contains=1,e.Intersects=2,e})(),$e=(()=>{class e{constructor(){}static distancePlaneToPoint(e,t){return a.dot(e.normal,t)-e.distance}static distanceBoxToPoint(e,t){var r=e.min,i=r.x,n=r.y,a=r.z,s=e.max,o=s.x,l=s.y,_=s.z,h=t.x,c=t.y,d=t.z,u=0;return h<i&&(u+=(i-h)*(i-h)),h>o&&(u+=(o-h)*(o-h)),c<n&&(u+=(n-c)*(n-c)),c>l&&(u+=(l-c)*(l-c)),d<a&&(u+=(a-d)*(a-d)),d>_&&(u+=(_-d)*(_-d)),Math.sqrt(u)}static distanceBoxToBox(e,t){var r,i=e.min,n=i.x,a=i.y,s=i.z,o=e.max,l=o.x,_=o.y,h=o.z,c=t.min,d=c.x,u=c.y,m=c.z,f=t.max,T=f.x,E=f.y,p=f.z,g=0;return n>T?g+=(r=n-T)*r:d>l&&(g+=(r=d-l)*r),a>E?g+=(r=a-E)*r:u>_&&(g+=(r=u-_)*r),s>p?g+=(r=s-p)*r:m>h&&(g+=(r=m-h)*r),Math.sqrt(g)}static distanceSphereToPoint(e,t){var r=Math.sqrt(a.distanceSquared(e.center,t));return r-=e.radius,Math.max(r,0)}static distanceSphereToSphere(e,t){var r=Math.sqrt(a.distanceSquared(e.center,t.center));return r-=e.radius+t.radius,Math.max(r,0)}static intersectsRayAndTriangleRD(t,i,n,a,s){var o=t.origin,l=o.x,_=o.y,h=o.z,c=t.direction,d=c.x,u=c.y,m=c.z,f=i.x,T=i.y,E=i.z,p=n.x,g=n.y,S=n.z,R=a.x,v=a.y,A=a.z,I=e._tempV30.x,x=e._tempV30.y,C=e._tempV30.z;I=p-f,x=g-T,C=S-E;var L=e._tempV31.x,y=e._tempV31.y,D=e._tempV31.z;L=R-f,y=v-T,D=A-E;var M=e._tempV32.x,O=e._tempV32.y,N=e._tempV32.z,b=I*(M=u*D-m*y)+x*(O=m*L-d*D)+C*(N=d*y-u*L);if(r.isZero(b))return!1;var P=1/b,w=e._tempV33.x,V=e._tempV33.y,F=e._tempV33.z,B=(w=l-f)*M+(V=_-T)*O+(F=h-E)*N;if((B*=P)<0||B>1)return!1;var U=e._tempV34.x,G=e._tempV34.y,z=e._tempV34.z,H=d*(U=V*C-F*x)+u*(G=F*I-w*C)+m*(z=w*x-V*I);if((H*=P)<0||B+H>1)return!1;var W=L*U+y*G+D*z;return!((W*=P)<0)}static intersectsRayAndTriangleRP(t,r,i,n,s){return e.intersectsRayAndTriangleRD(t,r,i,n,void 0)?(a.scale(t.direction,void 0,e._tempV30),a.add(t.origin,e._tempV30,s),!0):(s=a._ZERO,!1)}static intersectsRayAndPoint(t,i){a.subtract(t.origin,i,e._tempV30);var n=a.dot(e._tempV30,t.direction),s=a.dot(e._tempV30,e._tempV30)-r.zeroTolerance;return!(s>0&&n>0)&&!(n*n-s<0)}static intersectsRayAndRay(t,i,n){var s=t.origin,o=s.x,l=s.y,_=s.z,h=t.direction,c=h.x,d=h.y,u=h.z,m=i.origin,f=m.x,T=m.y,E=m.z,p=i.direction,g=p.x,S=p.y,R=p.z;a.cross(h,p,e._tempV30);var v=e._tempV30,A=a.scalarLength(e._tempV30);if(r.isZero(A)&&r.nearEqual(f,o)&&r.nearEqual(T,l)&&r.nearEqual(E,_))return!0;A*=A;var I=f-o,x=T-l,C=E-_,L=g,y=S,D=R,M=v.x,O=v.y,N=v.z,b=I*y*N+x*D*M+C*L*O-I*D*O-x*L*N-C*y*M;L=c,y=d,D=u;var P=b/A;a.scale(h,P,e._tempV30),a.scale(p,P,e._tempV31),a.add(s,e._tempV30,e._tempV32),a.add(m,e._tempV31,e._tempV33);var w=e._tempV32,V=e._tempV33;return!!(r.nearEqual(V.x,w.x)&&r.nearEqual(V.y,w.y)&&r.nearEqual(V.z,w.z))}static intersectsPlaneAndTriangle(t,r,i,n){var a=e.intersectsPlaneAndPoint(t,r),s=e.intersectsPlaneAndPoint(t,i),o=e.intersectsPlaneAndPoint(t,n);return a==Qe.PlaneIntersectionType_Front&&s==Qe.PlaneIntersectionType_Front&&o==Qe.PlaneIntersectionType_Front?Qe.PlaneIntersectionType_Front:a==Qe.PlaneIntersectionType_Back&&s==Qe.PlaneIntersectionType_Back&&o==Qe.PlaneIntersectionType_Back?Qe.PlaneIntersectionType_Back:Qe.PlaneIntersectionType_Intersecting}static intersectsRayAndPlaneRD(e,t){var i=t.normal,n=a.dot(i,e.direction);if(Math.abs(n)<r.zeroTolerance)return-1;var s=a.dot(i,e.origin),o=(-t.distance-s)/n;if(o<0){if(o<-r.zeroTolerance)return-1;o=0}return o}static intersectsRayAndPlaneRP(t,r,i){var n=e.intersectsRayAndPlaneRD(t,r);if(-1==n)return i.setValue(0,0,0),!1;var s=e._tempV30;return a.scale(t.direction,n,s),a.add(t.origin,s,i),!0}static intersectsRayAndBoxRD(e,t){var i=e.origin,n=i.x,a=i.y,s=i.z,o=e.direction,l=o.x,_=o.y,h=o.z,c=t.min,d=c.x,u=c.y,m=c.z,f=t.max,T=f.x,E=f.y,p=f.z,g=0,S=r.MaxValue;if(r.isZero(l)){if(n<d||n>T)return-1}else{var R=1/l,v=(d-n)*R,A=(T-n)*R;if(v>A){var I=v;v=A,A=I}if((g=Math.max(v,g))>(S=Math.min(A,S)))return-1}if(r.isZero(_)){if(a<u||a>E)return-1}else{var x=1/_,C=(u-a)*x,L=(E-a)*x;if(C>L){var y=C;C=L,L=y}if((g=Math.max(C,g))>(S=Math.min(L,S)))return-1}if(r.isZero(h)){if(s<m||s>p)return-1}else{var D=1/h,M=(m-s)*D,O=(p-s)*D;if(M>O){var N=M;M=O,O=N}if((g=Math.max(M,g))>(S=Math.min(O,S)))return-1}return g}static intersectsRayAndBoxRP(t,r,i){var n=e.intersectsRayAndBoxRD(t,r);return-1===n?(a._ZERO.cloneTo(i),n):(a.scale(t.direction,n,e._tempV30),a.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),n)}static intersectsRayAndSphereRD(t,r){var i=r.radius;a.subtract(t.origin,r.center,e._tempV30);var n=a.dot(e._tempV30,t.direction),s=a.dot(e._tempV30,e._tempV30)-i*i;if(s>0&&n>0)return-1;var o=n*n-s;if(o<0)return-1;var l=-n-Math.sqrt(o);return l<0&&(l=0),l}static intersectsRayAndSphereRP(t,r,i){var n=e.intersectsRayAndSphereRD(t,r);return-1===n?(a._ZERO.cloneTo(i),n):(a.scale(t.direction,n,e._tempV30),a.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),n)}static intersectsSphereAndTriangle(t,r,i,n){var s=t.center,o=t.radius;return e.closestPointPointTriangle(s,r,i,n,e._tempV30),a.subtract(e._tempV30,s,e._tempV31),a.dot(e._tempV31,e._tempV31)<=o*o}static intersectsPlaneAndPoint(e,t){var r=a.dot(e.normal,t)+e.distance;return r>0?Qe.PlaneIntersectionType_Front:r<0?Qe.PlaneIntersectionType_Back:Qe.PlaneIntersectionType_Intersecting}static intersectsPlaneAndPlane(t,i){a.cross(t.normal,i.normal,e._tempV30);var n=a.dot(e._tempV30,e._tempV30);return!r.isZero(n)}static intersectsPlaneAndPlaneRL(t,i,n){var s=t.normal,o=i.normal;a.cross(s,o,e._tempV34);var l=a.dot(e._tempV34,e._tempV34);return!r.isZero(l)&&(a.scale(o,t.distance,e._tempV30),a.scale(s,i.distance,e._tempV31),a.subtract(e._tempV30,e._tempV31,e._tempV32),a.cross(e._tempV32,e._tempV34,e._tempV33),a.normalize(e._tempV34,e._tempV34),!0)}static intersectsPlaneAndBox(t,r){var i=t.distance,n=t.normal,s=n.x,o=n.y,l=n.z,_=r.min,h=_.x,c=_.y,d=_.z,u=r.max,m=u.x,f=u.y,T=u.z;e._tempV30.x=s>0?h:m,e._tempV30.y=o>0?c:f,e._tempV30.z=l>0?d:T,e._tempV31.x=s>0?m:h,e._tempV31.y=o>0?f:c,e._tempV31.z=l>0?T:d;var E=a.dot(n,e._tempV30);return E+i>0?Qe.PlaneIntersectionType_Front:(E=a.dot(n,e._tempV31))+i<0?Qe.PlaneIntersectionType_Back:Qe.PlaneIntersectionType_Intersecting}static intersectsPlaneAndSphere(e,t){var r=t.radius,i=a.dot(e.normal,t.center)+e.distance;return i>r?Qe.PlaneIntersectionType_Front:i<-r?Qe.PlaneIntersectionType_Back:Qe.PlaneIntersectionType_Intersecting}static intersectsBoxAndBox(e,t){var r=e.min,i=e.max,n=t.min,a=t.max;return!(r.x>a.x||n.x>i.x)&&(!(r.y>a.y||n.y>i.y)&&!(r.z>a.z||n.z>i.z))}static intersectsBoxAndSphere(t,r){var i=r.center,n=r.radius,s=e._tempV30;return a.Clamp(i,t.min,t.max,s),a.distanceSquared(i,s)<=n*n}static intersectsSphereAndSphere(e,t){var r=e.radius+t.radius;return a.distanceSquared(e.center,t.center)<=r*r}static boxContainsPoint(e,t){var r=e.min,i=e.max;return r.x<=t.x&&i.x>=t.x&&r.y<=t.y&&i.y>=t.y&&r.z<=t.z&&i.z>=t.z?Je.Contains:Je.Disjoint}static boxContainsBox(e,t){var r=e.min,i=r.x,n=r.y,a=r.z,s=e.max,o=s.x,l=s.y,_=s.z,h=t.min,c=h.x,d=h.y,u=h.z,m=t.max,f=m.x,T=m.y,E=m.z;return o<c||i>f||l<d||n>T||_<u||a>E?Je.Disjoint:i<=c&&f<=o&&n<=d&&T<=l&&a<=u&&E<=_?Je.Contains:Je.Intersects}static boxContainsSphere(t,r){var i=t.min,n=i.x,s=i.y,o=i.z,l=t.max,_=l.x,h=l.y,c=l.z,d=r.center,u=d.x,m=d.y,f=d.z,T=r.radius;return a.Clamp(d,i,l,e._tempV30),a.distanceSquared(d,e._tempV30)>T*T?Je.Disjoint:n+T<=u&&u<=_-T&&_-n>T&&s+T<=m&&m<=h-T&&h-s>T&&o+T<=f&&f<=c-T&&c-o>T?Je.Contains:Je.Intersects}static sphereContainsPoint(e,t){return a.distanceSquared(t,e.center)<=e.radius*e.radius?Je.Contains:Je.Disjoint}static sphereContainsTriangle(t,r,i,n){var a=e.sphereContainsPoint(t,r),s=e.sphereContainsPoint(t,i),o=e.sphereContainsPoint(t,n);return a==Je.Contains&&s==Je.Contains&&o==Je.Contains?Je.Contains:e.intersectsSphereAndTriangle(t,r,i,n)?Je.Intersects:Je.Disjoint}static sphereContainsBox(t,r){var i=t.center,n=i.x,s=i.y,o=i.z,l=t.radius,_=r.min,h=_.x,c=_.y,d=_.z,u=r.max,m=u.x,f=u.y,T=u.z,E=e._tempV30;E.x,E.y,E.z;if(!e.intersectsBoxAndSphere(r,t))return Je.Disjoint;var p=l*l;return n-h,s-f,o-T,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-m,s-f,o-T,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-m,s-c,o-T,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-h,s-c,o-T,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-h,s-f,o-d,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-m,s-f,o-d,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-m,s-c,o-d,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:(n-h,s-c,o-d,a.scalarLengthSquared(e._tempV30)>p?Je.Intersects:Je.Contains)))))))}static sphereContainsSphere(e,t){var r=e.radius,i=t.radius,n=a.distance(e.center,t.center);return r+i<n?Je.Disjoint:r-i<n?Je.Intersects:Je.Contains}static closestPointPointTriangle(t,r,i,n,s){a.subtract(i,r,e._tempV30),a.subtract(n,r,e._tempV31),a.subtract(t,r,e._tempV32),a.subtract(t,i,e._tempV33),a.subtract(t,n,e._tempV34);var o=a.dot(e._tempV30,e._tempV32),l=a.dot(e._tempV31,e._tempV32),_=a.dot(e._tempV30,e._tempV33),h=a.dot(e._tempV31,e._tempV33),c=a.dot(e._tempV30,e._tempV34),d=a.dot(e._tempV31,e._tempV34);if(o<=0&&l<=0)r.cloneTo(s);else if(_>=0&&h<=_)i.cloneTo(s);else{var u=o*h-_*l;if(u<=0&&o>=0&&_<=0){var m=o/(o-_);return a.scale(e._tempV30,m,s),void a.add(r,s,s)}if(d>=0&&c<=d)n.cloneTo(s);else{var f=c*l-o*d;if(f<=0&&l>=0&&d<=0){var T=l/(l-d);return a.scale(e._tempV31,T,s),void a.add(r,s,s)}var E=_*d-c*h;if(E<=0&&h-_>=0&&c-d>=0){var p=(h-_)/(h-_+(c-d));return a.subtract(n,i,s),a.scale(s,p,s),void a.add(i,s,s)}var g=1/(E+f+u),S=f*g,R=u*g;a.scale(e._tempV30,S,e._tempV35),a.scale(e._tempV31,R,e._tempV36),a.add(e._tempV35,e._tempV36,s),a.add(r,s,s)}}}static closestPointPlanePoint(t,r,i){var n=t.normal,s=a.dot(n,r)-t.distance;a.scale(n,s,e._tempV30),a.subtract(r,e._tempV30,i)}static closestPointBoxPoint(t,r,i){a.max(r,t.min,e._tempV30),a.min(e._tempV30,t.max,i)}static closestPointSpherePoint(e,t,r){var i=e.center;a.subtract(t,i,r),a.normalize(r,r),a.scale(r,e.radius,r),a.add(r,i,r)}static closestPointSphereSphere(e,t,r){var i=e.center;a.subtract(t.center,i,r),a.normalize(r,r),a.scale(r,e.radius,r),a.add(r,i,r)}}return e._tempV30=new a,e._tempV31=new a,e._tempV32=new a,e._tempV33=new a,e._tempV34=new a,e._tempV35=new a,e._tempV36=new a,e})();var et;(et=e.FrustumCorner||(e.FrustumCorner={}))[et.FarBottomLeft=0]="FarBottomLeft",et[et.FarTopLeft=1]="FarTopLeft",et[et.FarTopRight=2]="FarTopRight",et[et.FarBottomRight=3]="FarBottomRight",et[et.nearBottomLeft=4]="nearBottomLeft",et[et.nearTopLeft=5]="nearTopLeft",et[et.nearTopRight=6]="nearTopRight",et[et.nearBottomRight=7]="nearBottomRight",et[et.unknown=8]="unknown";let tt=(()=>{class t{constructor(e){this._matrix=e,this._near=new Qe(new a),this._far=new Qe(new a),this._left=new Qe(new a),this._right=new Qe(new a),this._top=new Qe(new a),this._bottom=new Qe(new a),t.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}static getPlanesFromMatrix(e,t,r,i,n,a,s){var o=e.elements,l=o[0],_=o[1],h=o[2],c=o[3],d=o[4],u=o[5],m=o[6],f=o[7],T=o[8],E=o[9],p=o[10],g=o[11],S=o[12],R=o[13],v=o[14],A=o[15],I=t.normal;I.x=h,I.y=m,I.z=p,t.distance=v,t.normalize();var x=r.normal;x.x=c-h,x.y=f-m,x.z=g-p,r.distance=A-v,r.normalize();var C=i.normal;C.x=c+l,C.y=f+d,C.z=g+T,i.distance=A+S,i.normalize();var L=n.normal;L.x=c-l,L.y=f-d,L.z=g-T,n.distance=A-S,n.normalize();var y=a.normal;y.x=c-_,y.y=f-u,y.z=g-E,a.distance=A-R,a.normalize();var D=s.normal;D.x=c+_,D.y=f+u,D.z=g+E,s.distance=A+R,s.normalize()}get matrix(){return this._matrix}set matrix(e){e.cloneTo(this._matrix),t.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}get near(){return this._near}get far(){return this._far}get left(){return this._left}get right(){return this._right}get top(){return this._top}get bottom(){return this._bottom}equalsBoundFrustum(e){return this._matrix.equalsOtherMatrix(e.matrix)}equalsObj(e){if(e instanceof t){var r=e;return this.equalsBoundFrustum(r)}return!1}getPlane(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}}static get3PlaneInterPoint(e,r,i,n){var s=e.normal,o=r.normal,l=i.normal;a.cross(o,l,t._tempV30),a.cross(l,s,t._tempV31),a.cross(s,o,t._tempV32);var _=a.dot(s,t._tempV30),h=a.dot(o,t._tempV31),c=a.dot(l,t._tempV32);a.scale(t._tempV30,-e.distance/_,t._tempV33),a.scale(t._tempV31,-r.distance/h,t._tempV34),a.scale(t._tempV32,-i.distance/c,t._tempV35),a.add(t._tempV33,t._tempV34,t._tempV36),a.add(t._tempV35,t._tempV36,n)}getCorners(r){t.get3PlaneInterPoint(this._near,this._bottom,this._right,r[e.FrustumCorner.nearBottomRight]),t.get3PlaneInterPoint(this._near,this._top,this._right,r[e.FrustumCorner.nearTopRight]),t.get3PlaneInterPoint(this._near,this._top,this._left,r[e.FrustumCorner.nearTopLeft]),t.get3PlaneInterPoint(this._near,this._bottom,this._left,r[e.FrustumCorner.nearBottomLeft]),t.get3PlaneInterPoint(this._far,this._bottom,this._right,r[e.FrustumCorner.FarBottomRight]),t.get3PlaneInterPoint(this._far,this._top,this._right,r[e.FrustumCorner.FarTopRight]),t.get3PlaneInterPoint(this._far,this._top,this._left,r[e.FrustumCorner.FarTopLeft]),t.get3PlaneInterPoint(this._far,this._bottom,this._left,r[e.FrustumCorner.FarBottomLeft])}containsPoint(e){for(var t=Qe.PlaneIntersectionType_Front,r=Qe.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:r=$e.intersectsPlaneAndPoint(this._near,e);break;case 1:r=$e.intersectsPlaneAndPoint(this._far,e);break;case 2:r=$e.intersectsPlaneAndPoint(this._left,e);break;case 3:r=$e.intersectsPlaneAndPoint(this._right,e);break;case 4:r=$e.intersectsPlaneAndPoint(this._top,e);break;case 5:r=$e.intersectsPlaneAndPoint(this._bottom,e)}switch(r){case Qe.PlaneIntersectionType_Back:return Je.Disjoint;case Qe.PlaneIntersectionType_Intersecting:t=Qe.PlaneIntersectionType_Intersecting}}switch(t){case Qe.PlaneIntersectionType_Intersecting:return Je.Intersects;default:return Je.Contains}}intersects(e){var t=e.min,r=e.max,i=t.x,n=t.y,a=t.z,s=r.x,o=r.y,l=r.z,_=this._near.normal;if(this._near.distance+_.x*(_.x<0?i:s)+_.y*(_.y<0?n:o)+_.z*(_.z<0?a:l)<0)return!1;var h=this._left.normal;if(this._left.distance+h.x*(h.x<0?i:s)+h.y*(h.y<0?n:o)+h.z*(h.z<0?a:l)<0)return!1;var c=this._right.normal;if(this._right.distance+c.x*(c.x<0?i:s)+c.y*(c.y<0?n:o)+c.z*(c.z<0?a:l)<0)return!1;var d=this._bottom.normal;if(this._bottom.distance+d.x*(d.x<0?i:s)+d.y*(d.y<0?n:o)+d.z*(d.z<0?a:l)<0)return!1;var u=this._top.normal;if(this._top.distance+u.x*(u.x<0?i:s)+u.y*(u.y<0?n:o)+u.z*(u.z<0?a:l)<0)return!1;var m=this._far.normal;return!(this._far.distance+m.x*(m.x<0?i:s)+m.y*(m.y<0?n:o)+m.z*(m.z<0?a:l)<0)}containsBoundBox(e){for(var r=t._tempV30,i=t._tempV31,n=e.min,a=e.max,s=Je.Contains,o=0;o<6;o++){var l=this.getPlane(o),_=l.normal;if(_.x>=0?(r.x=a.x,i.x=n.x):(r.x=n.x,i.x=a.x),_.y>=0?(r.y=a.y,i.y=n.y):(r.y=n.y,i.y=a.y),_.z>=0?(r.z=a.z,i.z=n.z):(r.z=n.z,i.z=a.z),$e.intersectsPlaneAndPoint(l,r)===Qe.PlaneIntersectionType_Back)return Je.Disjoint;$e.intersectsPlaneAndPoint(l,i)===Qe.PlaneIntersectionType_Back&&(s=Je.Intersects)}return s}containsBoundSphere(e){for(var t=Qe.PlaneIntersectionType_Front,r=Qe.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:r=$e.intersectsPlaneAndSphere(this._near,e);break;case 1:r=$e.intersectsPlaneAndSphere(this._far,e);break;case 2:r=$e.intersectsPlaneAndSphere(this._left,e);break;case 3:r=$e.intersectsPlaneAndSphere(this._right,e);break;case 4:r=$e.intersectsPlaneAndSphere(this._top,e);break;case 5:r=$e.intersectsPlaneAndSphere(this._bottom,e)}switch(r){case Qe.PlaneIntersectionType_Back:return Je.Disjoint;case Qe.PlaneIntersectionType_Intersecting:t=Qe.PlaneIntersectionType_Intersecting}}switch(t){case Qe.PlaneIntersectionType_Intersecting:return Je.Intersects;default:return Je.Contains}}}return t._tempV30=new a,t._tempV31=new a,t._tempV32=new a,t._tempV33=new a,t._tempV34=new a,t._tempV35=new a,t._tempV36=new a,t})(),rt=(()=>{class e{constructor(e,t,r,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=r,this.height=i}project(e,t,r){a.transformV3ToV4(e,t,r);var i=r.x,n=r.y,s=r.z,o=r.w;1!==o&&(i/=o,n/=o,s/=o),r.x=.5*(i+1)*this.width+this.x,r.y=.5*(1-n)*this.height+this.y,r.z=s*(this.maxDepth-this.minDepth)+this.minDepth}unprojectFromMat(e,t,r){var i=t.elements;r.x=(e.x-this.x)/this.width*2-1,r.y=-((e.y-this.y)/this.height*2-1),r.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var n=r.x*i[3]+r.y*i[7]+r.z*i[11]+i[15];a.transformV3ToV3(r,t,r),1!==n&&(r.x=r.x/n,r.y=r.y/n,r.z=r.z/n)}unprojectFromWVP(t,r,i,n,a){h.multiply(r,i,e._tempMatrix4x4),n&&h.multiply(e._tempMatrix4x4,n,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)}cloneTo(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}return e._tempMatrix4x4=new h,e})(),it=(()=>{class e{constructor(){}static calculateCursorRay(t,r,i,n,s,o){var l=t.x,_=t.y,h=e._tempVector30,c=h;c.x=l,c.y=_,c.z=r.minDepth;var d=e._tempVector31,u=d;u.x=l,u.y=_,u.z=r.maxDepth;var m=o.origin,f=e._tempVector32;r.unprojectFromWVP(h,i,n,s,m),r.unprojectFromWVP(d,i,n,s,f);var T=o.direction;T.x=f.x-m.x,T.y=f.y-m.y,T.z=f.z-m.z,a.normalize(o.direction,o.direction)}static rayIntersectsTriangle(t,r,i,n){var s=e._tempVector30,o=e._tempVector31;a.subtract(i,r,s),a.subtract(n,r,o);var l,_=e._tempVector32;if(a.cross(t.direction,o,_),(l=a.dot(s,_))>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return Number.NaN;var h,c=1/l,d=e._tempVector33;if(a.subtract(t.origin,r,d),h=a.dot(d,_),(h*=c)<0||h>1)return Number.NaN;var u,m,f=e._tempVector34;return a.cross(d,s,f),u=a.dot(t.direction,f),(u*=c)<0||h+u>1?Number.NaN:(m=a.dot(o,f),(m*=c)<0?Number.NaN:m)}}return e._tempVector30=new a,e._tempVector31=new a,e._tempVector32=new a,e._tempVector33=new a,e._tempVector34=new a,e})();class nt extends t.BufferStateBase{constructor(){super()}applyVertexBuffer(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var r=t.LayaGL.instance,i=e.vertexDeclaration,n=i._shaderValues.getData();for(var a in this.vertexDeclaration=i,e.bind(),n){var s=parseInt(a),o=n[a];r.enableVertexAttribArray(s),r.vertexAttribPointer(s,o[0],o[1],!!o[2],o[3],o[4])}}applyVertexBuffers(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var r=t.LayaGL.instance,i=0,n=e.length;i<n;i++){var a=e[i],s=a.vertexDeclaration._shaderValues.getData();for(var o in a.bind(),s){var l=parseInt(o),_=s[o];r.enableVertexAttribArray(l),r.vertexAttribPointer(l,_[0],_[1],!!_[2],_[3],_[4])}}}applyInstanceVertexBuffer(e){if(t.LayaGL.layaGPUInstance.supportInstance()){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var r=t.LayaGL.instance,i=e.vertexDeclaration._shaderValues.getData();for(var n in e.bind(),i){var a=parseInt(n),s=i[n];r.enableVertexAttribArray(a),r.vertexAttribPointer(a,s[0],s[1],!!s[2],s[3],s[4]),t.LayaGL.layaGPUInstance.vertexAttribDivisor(a,1)}}}applyIndexBuffer(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._bindForVAO(),this._bindedIndexBuffer=e)}}var at;(at=e.IndexFormat||(e.IndexFormat={}))[at.UInt8=0]="UInt8",at[at.UInt16=1]="UInt16",at[at.UInt32=2]="UInt32";class st extends t.Buffer{constructor(r,i,n=35044,a=!1){switch(super(),this._indexType=r,this._indexCount=i,this._bufferUsage=n,this._bufferType=t.LayaGL.instance.ELEMENT_ARRAY_BUFFER,this._canRead=a,r){case e.IndexFormat.UInt32:this._indexTypeByteCount=4;break;case e.IndexFormat.UInt16:this._indexTypeByteCount=2;break;case e.IndexFormat.UInt8:this._indexTypeByteCount=1;break;default:throw new Error("unidentification index type.")}var s=this._indexTypeByteCount*i,o=t.BufferStateBase._curBindedBufferState;if(this._byteLength=s,o?o._bindedIndexBuffer===this?t.LayaGL.instance.bufferData(this._bufferType,s,this._bufferUsage):(o.unBind(),this.bind(),t.LayaGL.instance.bufferData(this._bufferType,s,this._bufferUsage),o.bind()):(this.bind(),t.LayaGL.instance.bufferData(this._bufferType,s,this._bufferUsage)),a)switch(r){case e.IndexFormat.UInt32:this._buffer=new Uint32Array(i);break;case e.IndexFormat.UInt16:this._buffer=new Uint16Array(i);break;case e.IndexFormat.UInt8:this._buffer=new Uint8Array(i)}}get indexType(){return this._indexType}get indexTypeByteCount(){return this._indexTypeByteCount}get indexCount(){return this._indexCount}get canRead(){return this._canRead}_bindForVAO(){if(!t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";var e=t.LayaGL.instance;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer)}bind(){if(t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";if(t.Buffer._bindedIndexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedIndexBuffer=this._glBuffer,!0}return!1}setData(r,i=0,n=0,a=4294967295){var s=this._indexTypeByteCount;if(0!==n||4294967295!==a)switch(this._indexType){case e.IndexFormat.UInt32:r=new Uint32Array(r.buffer,n*s,a);break;case e.IndexFormat.UInt16:r=new Uint16Array(r.buffer,n*s,a);break;case e.IndexFormat.UInt8:r=new Uint8Array(r.buffer,n*s,a)}var o=t.BufferStateBase._curBindedBufferState;if(o?o._bindedIndexBuffer===this?t.LayaGL.instance.bufferSubData(this._bufferType,i*s,r):(o.unBind(),this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,i*s,r),o.bind()):(this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,i*s,r)),this._canRead)if(0!==i||0!==n||4294967295!==a){var l=this._buffer.length-i;a>l&&(a=l);for(var _=0;_<a;_++)this._buffer[i+_]=r[_]}else this._buffer=r}getData(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}destroy(){super.destroy(),this._buffer=null}}let ot=(()=>{class e{static __init__(){var r=t.LayaGL.instance;e._elementInfos={single:[1,r.FLOAT,0],vector2:[2,r.FLOAT,0],vector3:[3,r.FLOAT,0],vector4:[4,r.FLOAT,0],color:[4,r.FLOAT,0],byte4:[4,r.UNSIGNED_BYTE,0],short2:[2,r.FLOAT,0],short4:[4,r.FLOAT,0],normalizedshort2:[2,r.FLOAT,0],normalizedshort4:[4,r.FLOAT,0],halfvector2:[2,r.FLOAT,0],halfvector4:[4,r.FLOAT,0]}}static getElementInfos(t){var r=e._elementInfos[t];if(r)return r;throw"VertexElementFormat: this vertexElementFormat is not implement."}}return e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="color",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4",e})(),lt=(()=>{class e{constructor(t,r){this._id=++e._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=r;var i=r.length;this._shaderValues=new Ie(null);for(var n=0;n<i;n++){var a=r[n],s=a._elementUsage;this._vertexElementsDic[s]=a;var o=new Int32Array(5),l=ot.getElementInfos(a._elementFormat);o[0]=l[0],o[1]=l[1],o[2]=l[2],o[3]=this._vertexStride,o[4]=a._offset,this._shaderValues.setAttribute(s,o)}}get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}return e._uniqueIDCounter=1,e})();class _t{constructor(e,t,r){this._offset=e,this._elementFormat=t,this._elementUsage=r}get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}}let ht=(()=>{class e{static __init__(){e.instanceWorldMatrixDeclaration=new lt(64,[new _t(0,ot.Vector4,e.MESH_WORLDMATRIX_ROW0),new _t(16,ot.Vector4,e.MESH_WORLDMATRIX_ROW1),new _t(32,ot.Vector4,e.MESH_WORLDMATRIX_ROW2),new _t(48,ot.Vector4,e.MESH_WORLDMATRIX_ROW3)]),e.instanceMVPMatrixDeclaration=new lt(64,[new _t(0,ot.Vector4,e.MESH_MVPMATRIX_ROW0),new _t(16,ot.Vector4,e.MESH_MVPMATRIX_ROW1),new _t(32,ot.Vector4,e.MESH_MVPMATRIX_ROW2),new _t(48,ot.Vector4,e.MESH_MVPMATRIX_ROW3)])}static getVertexDeclaration(t,r=!0){var i=e._vertexDeclarationMap[t+(r?"_0":"_1")];if(!i){for(var n=t.split(","),a=0,s=[],o=0,l=n.length;o<l;o++){var _;switch(n[o]){case"POSITION":_=new _t(a,ot.Vector3,e.MESH_POSITION0),a+=12;break;case"NORMAL":_=new _t(a,ot.Vector3,e.MESH_NORMAL0),a+=12;break;case"COLOR":_=new _t(a,ot.Vector4,e.MESH_COLOR0),a+=16;break;case"UV":_=new _t(a,ot.Vector2,e.MESH_TEXTURECOORDINATE0),a+=8;break;case"UV1":_=new _t(a,ot.Vector2,e.MESH_TEXTURECOORDINATE1),a+=8;break;case"BLENDWEIGHT":_=new _t(a,ot.Vector4,e.MESH_BLENDWEIGHT0),a+=16;break;case"BLENDINDICES":r?(_=new _t(a,ot.Vector4,e.MESH_BLENDINDICES0),a+=16):(_=new _t(a,ot.Byte4,e.MESH_BLENDINDICES0),a+=4);break;case"TANGENT":_=new _t(a,ot.Vector4,e.MESH_TANGENT0),a+=16;break;default:throw"VertexMesh: unknown vertex flag."}s.push(_)}i=new lt(a,s),e._vertexDeclarationMap[t+(r?"_0":"_1")]=i}return i}}return e.MESH_POSITION0=0,e.MESH_COLOR0=1,e.MESH_TEXTURECOORDINATE0=2,e.MESH_NORMAL0=3,e.MESH_TANGENT0=4,e.MESH_BLENDINDICES0=5,e.MESH_BLENDWEIGHT0=6,e.MESH_TEXTURECOORDINATE1=7,e.MESH_WORLDMATRIX_ROW0=8,e.MESH_WORLDMATRIX_ROW1=9,e.MESH_WORLDMATRIX_ROW2=10,e.MESH_WORLDMATRIX_ROW3=11,e.MESH_MVPMATRIX_ROW0=12,e.MESH_MVPMATRIX_ROW1=13,e.MESH_MVPMATRIX_ROW2=14,e.MESH_MVPMATRIX_ROW3=15,e._vertexDeclarationMap={},e})(),ct=(()=>{class e extends t.Buffer{constructor(e,r,i=!1){super(),this._vertexDeclaration=null,this._float32Reader=null;var n=t.LayaGL.instance;this._bufferUsage=r,this._bufferType=n.ARRAY_BUFFER,this._canRead=i,this._byteLength=e,this.bind(),n.bufferData(this._bufferType,this._byteLength,this._bufferUsage),i&&(this._buffer=new Uint8Array(e),this._float32Reader=new Float32Array(this._buffer.buffer))}get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get canRead(){return this._canRead}bind(){if(t.Buffer._bindedVertexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedVertexBuffer=this._glBuffer,!0}return!1}orphanStorage(){this.bind(),t.LayaGL.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage)}setData(e,r=0,i=0,n=Number.MAX_SAFE_INTEGER){if(this.bind(),0!==i||n!==Number.MAX_SAFE_INTEGER){var a=new Uint8Array(e,i,n);t.LayaGL.instance.bufferSubData(this._bufferType,r,a),this._canRead&&this._buffer.set(a,r)}else t.LayaGL.instance.bufferSubData(this._bufferType,r,e),this._canRead&&this._buffer.set(new Uint8Array(e),r)}getUint8Data(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}getFloat32Data(){if(this._canRead)return this._float32Reader;throw new Error("Can't read data from VertexBuffer with only write flag!")}markAsUnreadbale(){this._canRead=!1,this._buffer=null,this._float32Reader=null}destroy(){super.destroy(),this._buffer=null,this._float32Reader=null,this._vertexDeclaration=null}}return e.DATATYPE_FLOAT32ARRAY=0,e.DATATYPE_UINT8ARRAY=1,e})();class dt{constructor(){}_render(e){}}class ut extends dt{constructor(){super();var r=t.LayaGL.instance,i=new Float32Array([-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1]),n=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),a=ht.getVertexDeclaration("POSITION");this._vertexBuffer=new ct(8*a.vertexStride,r.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=a,this._indexBuffer=new st(e.IndexFormat.UInt8,36,r.STATIC_DRAW,!1),this._vertexBuffer.setData(i.buffer),this._indexBuffer.setData(n);var s=new nt;s.bind(),s.applyVertexBuffer(this._vertexBuffer),s.applyIndexBuffer(this._indexBuffer),s.unBind(),this._bufferState=s}static __init__(){ut.instance=new ut}_render(e){var r=t.LayaGL.instance;r.drawElements(r.TRIANGLES,36,r.UNSIGNED_BYTE,0),t.Stat.trianglesFaces+=12,t.Stat.renderBatches++}}let mt=(()=>{class e{constructor(){this._mesh=ut.instance}get material(){return this._material}set material(e){this._material!==e&&(this._material&&this._material._removeReference(),e&&e._addReference(),this._material=e)}get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e)}_isAvailable(){return!(!this._material||!this._mesh)}_render(r){if(this._material&&this._mesh){var i=t.LayaGL.instance,n=r.scene,s=r.cameraShaderValue,o=r.camera,l=Ie._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&Ie.setRuntimeValueMode(!1),t.WebGLContext.setCullFace(i,!1),t.WebGLContext.setDepthFunc(i,i.LEQUAL),t.WebGLContext.setDepthMask(i,!1);var _=e._compileDefine;this._material._shaderValues._defineDatas.cloneTo(_);var c=r.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(_),d=c.bind(),u=t.Stat.loopCount!==c._uploadMark,m=c._uploadScene!==n||u;(m||d)&&(c.uploadUniforms(c._sceneUniformParamsMap,n._shaderValues,m),c._uploadScene=n);o._getRenderTexture();var f=c._uploadCameraShaderValue!==s||u;if(f||d){var T=e._tempMatrix0,E=e._tempMatrix1;o.viewMatrix.cloneTo(T),o.projectionMatrix.cloneTo(E),T.setTranslationVector(a._ZERO),o.orthographic&&h.createPerspective(o.fieldOfView,o.aspectRatio,o.nearPlane,o.farPlane,E);var p=1/Math.tan(3.1416*o.fieldOfView/180*.5);E.elements[0]=p/o.aspectRatio,E.elements[5]=p,E.elements[10]=-.999999,E.elements[11]=-1,E.elements[14]=-0,o._applyViewProject(r,T,E),c.uploadUniforms(c._cameraUniformParamsMap,s,f),c._uploadCameraShaderValue=s}var g=c._uploadMaterial!==this._material||u;(g||d)&&(c.uploadUniforms(c._materialUniformParamsMap,this._material._shaderValues,g),c._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(r),t.ILaya.Render.supportWebGLPlusRendering&&Ie.setRuntimeValueMode(l),t.WebGLContext.setDepthFunc(i,i.LESS),t.WebGLContext.setDepthMask(i,!0),o._applyViewProject(r,o.viewMatrix,o.projectionMatrix)}}destroy(){this._material&&(this._material._removeReference(),this._material=null)}}return e._tempMatrix0=new h,e._tempMatrix1=new h,e._compileDefine=new ge,e})(),ft=(()=>{class e extends t.Node{constructor(t=null,r=!1){super(),this._needProcessCollisions=!1,this._needProcessTriggers=!1,this._id=++e._uniqueIDCounter,this._transform=new d(this),this._isStatic=r,this.layer=0,this.name=t||"New Sprite3D"}static __init__(){}static instantiate(e,t=null,r=!0,i=null,n=null){var a=e.clone();t&&t.addChild(a);var s=a.transform;if(r){var o=s.worldMatrix;e.transform.worldMatrix.cloneTo(o),s.worldMatrix=o}else i&&(s.position=i),n&&(s.rotation=n);return a}static load(r,i){t.Laya.loader.create(r,i,null,e.HIERARCHY)}get extData(){return this._extData}set extData(e){this._extData=e}get id(){return this._id}get layer(){return this._layer}set layer(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e}}get url(){return this._url}get isStatic(){return this._isStatic}get transform(){return this._transform}_setCreateURL(e){this._url=t.URL.formatURL(e)}_changeAnimatorsToLinkSprite3D(t,r,i){var n=this.getComponent(fe);if(n&&(n.avatar||t._changeAnimatorToLinkSprite3DNoAvatar(n,r,i)),this._parent&&this._parent instanceof e){i.unshift(this._parent.name);var a=this._parent;a._hierarchyAnimator&&a._changeAnimatorsToLinkSprite3D(t,r,i)}}_setHierarchyAnimator(e,t){this._changeHierarchyAnimator(e),this._changeAnimatorAvatar(e.avatar);for(var r=0,i=this._children.length;r<i;r++){var n=this._children[r];n._hierarchyAnimator==t&&n._setHierarchyAnimator(e,t)}}_clearHierarchyAnimator(e,t){this._changeHierarchyAnimator(t),this._changeAnimatorAvatar(t?t.avatar:null);for(var r=0,i=this._children.length;r<i;r++){var n=this._children[r];n._hierarchyAnimator==e&&n._clearHierarchyAnimator(e,t)}}_changeHierarchyAnimatorAvatar(e,t){this._changeAnimatorAvatar(t);for(var r=0,i=this._children.length;r<i;r++){var n=this._children[r];n._hierarchyAnimator==e&&n._changeHierarchyAnimatorAvatar(e,t)}}_changeAnimatorToLinkSprite3DNoAvatar(e,t,r){e._handleSpriteOwnersBySprite(t,r,this);for(var i=0,n=this._children.length;i<n;i++){var a=this._children[i],s=r.length;r.push(a.name),a._changeAnimatorToLinkSprite3DNoAvatar(e,t,r),r.splice(s,1)}}_changeHierarchyAnimator(e){this._hierarchyAnimator=e}_changeAnimatorAvatar(e){}_onAdded(){if(this._parent instanceof e){var t=this._parent;this.transform._setParent(t.transform),t._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(t._hierarchyAnimator,null),t._changeAnimatorsToLinkSprite3D(this,!0,[this.name]))}super._onAdded()}_onRemoved(){if(super._onRemoved(),this._parent instanceof e){var t=this._parent;this.transform._setParent(null),t._hierarchyAnimator&&(this._hierarchyAnimator==t._hierarchyAnimator&&this._clearHierarchyAnimator(t._hierarchyAnimator,null),t._changeAnimatorsToLinkSprite3D(this,!1,[this.name]))}}_parse(e,t){if(void 0!==e.isStatic&&(this._isStatic=e.isStatic),void 0!==e.active&&(this.active=e.active),null!=e.name&&(this.name=e.name),void 0!==e.position){var r=this.transform.localPosition;r.fromArray(e.position),this.transform.localPosition=r}if(void 0!==e.rotationEuler){var i=this.transform.localRotationEuler;i.fromArray(e.rotationEuler),this.transform.localRotationEuler=i}if(void 0!==e.rotation){var n=this.transform.localRotation;n.fromArray(e.rotation),this.transform.localRotation=n}if(void 0!==e.scale){var a=this.transform.localScale;a.fromArray(e.scale),this.transform.localScale=a}null!=e.layer&&(this.layer=e.layer),void 0!==e.extData&&(this.extData=e.extData)}_cloneTo(e,t,r){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var i=e,n=this._transform,a=i._transform;i.name=this.name,i.destroyed=this.destroyed,i.active=this.active,a.localPosition=n.localPosition,a.localRotation=n.localRotation,a.localScale=n.localScale,i._isStatic=this._isStatic,i.layer=this.layer,super._cloneTo(i,t,r)}static _createSprite3DInstance(t){for(var r=t._create(),i=t._children,n=0,a=i.length;n<a;n++){var s=e._createSprite3DInstance(i[n]);r.addChild(s)}return r}static _parseSprite3DInstance(t,r,i,n){for(var a=i._children,s=n._children,o=0,l=a.length;o<l;o++)e._parseSprite3DInstance(t,r,a[o],s[o]);i._cloneTo(n,t,r)}clone(){var t=e._createSprite3DInstance(this);return e._parseSprite3DInstance(this,t,this,t),t}destroy(e=!0){this.destroyed||(super.destroy(e),this._transform=null,this._scripts=null,this._url&&t.Loader.clearRes(this._url))}_create(){return new e}}return e.HIERARCHY="HIERARCHY",e.WORLDMATRIX=Ae.propertyNameToID("u_WorldMat"),e.MVPMATRIX=Ae.propertyNameToID("u_MvpMatrix"),e._uniqueIDCounter=0,e})(),Tt=(()=>{class e extends ft{constructor(e=.3,t=1e3){super(),this._skyRenderer=new mt,this._forward=new a,this._up=new a,this.clearColor=new n(100/255,149/255,237/255,1),this._shaderValues=new Ie(null),this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=t,this.cullingMask=2147483647,this.useOcclusionCulling=!0}get skyRenderer(){return this._skyRenderer}get fieldOfView(){return this._fieldOfView}set fieldOfView(e){this._fieldOfView=e,this._calculateProjectionMatrix()}get nearPlane(){return this._nearPlane}set nearPlane(e){this._nearPlane=e,this._calculateProjectionMatrix()}get farPlane(){return this._farPlane}set farPlane(e){this._farPlane=e,this._calculateProjectionMatrix()}get orthographic(){return this._orthographic}set orthographic(e){this._orthographic=e,this._calculateProjectionMatrix()}get orthographicVerticalSize(){return this._orthographicVerticalSize}set orthographicVerticalSize(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}get renderingOrder(){return this._renderingOrder}set renderingOrder(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}_sortCamerasByRenderingOrder(){if(this.displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,r=0;r<t;r++)if(e[r].renderingOrder>e[t].renderingOrder){var i=e[r];e[r]=e[t],e[t]=i}}_calculateProjectionMatrix(){}_onScreenSizeChanged(){this._calculateProjectionMatrix()}_prepareCameraToRender(){var t=this._shaderValues;this.transform.getForward(this._forward),this.transform.getUp(this._up),t.setVector3(e.CAMERAPOS,this.transform.position),t.setVector3(e.CAMERADIRECTION,this._forward),t.setVector3(e.CAMERAUP,this._up)}render(e=null,t=null){}addLayer(e){this.cullingMask|=Math.pow(2,e)}removeLayer(e){this.cullingMask&=~Math.pow(2,e)}addAllLayers(){this.cullingMask=2147483647}removeAllLayers(){this.cullingMask=0}resetProjectionMatrix(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()}_onActive(){this._scene._addCamera(this),super._onActive()}_onInActive(){this._scene._removeCamera(this),super._onInActive()}_parse(e,r){super._parse(e,r),this.orthographic=e.orthographic,void 0!==e.orthographicVerticalSize&&(this.orthographicVerticalSize=e.orthographicVerticalSize),void 0!==e.fieldOfView&&(this.fieldOfView=e.fieldOfView),this.nearPlane=e.nearPlane,this.farPlane=e.farPlane;var i=e.clearColor;this.clearColor=new n(i[0],i[1],i[2],i[3]);var a=e.skyboxMaterial;a&&(this._skyRenderer.material=t.Loader.getRes(a.path))}destroy(e=!0){this._skyRenderer.destroy(),this._skyRenderer=null,t.Laya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),super.destroy(e)}_create(){return new e}}return e._tempMatrix4x40=new h,e.CAMERAPOS=Ae.propertyNameToID("u_CameraPos"),e.VIEWMATRIX=Ae.propertyNameToID("u_View"),e.PROJECTMATRIX=Ae.propertyNameToID("u_Projection"),e.VIEWPROJECTMATRIX=Ae.propertyNameToID("u_ViewProjection"),e.CAMERADIRECTION=Ae.propertyNameToID("u_CameraDirection"),e.CAMERAUP=Ae.propertyNameToID("u_CameraUp"),e.VIEWPORT=Ae.propertyNameToID("u_Viewport"),e.PROJECTION_PARAMS=Ae.propertyNameToID("u_ProjectionParams"),e.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",e.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",e._invertYScaleMatrix=new h(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),e._invertYProjectionMatrix=new h,e._invertYProjectionViewMatrix=new h,e.CLEARFLAG_SOLIDCOLOR=0,e.CLEARFLAG_SKY=1,e.CLEARFLAG_DEPTHONLY=2,e.CLEARFLAG_NONE=3,e})();var Et;(Et=e.ShadowMode||(e.ShadowMode={}))[Et.None=0]="None",Et[Et.Hard=1]="Hard",Et[Et.SoftLow=2]="SoftLow",Et[Et.SoftHigh=3]="SoftHigh";let pt=(()=>{class e extends t.Resource{constructor(){super(),this._bufferState=new nt,this._bufferStateInvertUV=new nt;var r=t.LayaGL.instance;this._vertexBuffer=new ct(64,r.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=e._vertexDeclaration,this._vertexBuffer.setData(e._vertices.buffer),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind(),this._vertexBufferInvertUV=new ct(64,r.STATIC_DRAW,!1),this._vertexBufferInvertUV.vertexDeclaration=e._vertexDeclaration,this._vertexBufferInvertUV.setData(e._verticesInvertUV.buffer),this._bufferStateInvertUV.bind(),this._bufferStateInvertUV.applyVertexBuffer(this._vertexBufferInvertUV),this._bufferStateInvertUV.unBind(),this._setGPUMemory(this._vertexBuffer._byteLength+this._vertexBufferInvertUV._byteLength)}static __init__(){e._vertexDeclaration=new lt(16,[new _t(0,ot.Vector4,e.SCREENQUAD_POSITION_UV)]),e.instance=new e,e.instance.lock=!0}render(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}renderInvertUV(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}destroy(){super.destroy(),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}return e.SCREENQUAD_POSITION_UV=0,e._vertices=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),e._verticesInvertUV=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]),e})(),gt=(()=>{class e extends t.Resource{constructor(){super(),this._bufferState=new nt,this._bufferStateInvertUV=new nt;var r=t.LayaGL.instance;this._vertexBuffer=new ct(48,r.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=e._vertexDeclaration,this._vertexBuffer.setData(e._vertices.buffer),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind(),this._vertexBufferInvertUV=new ct(48,r.STATIC_DRAW,!1),this._vertexBufferInvertUV.vertexDeclaration=e._vertexDeclaration,this._vertexBufferInvertUV.setData(e._verticesInvertUV.buffer),this._bufferStateInvertUV.bind(),this._bufferStateInvertUV.applyVertexBuffer(this._vertexBufferInvertUV),this._bufferStateInvertUV.unBind(),this._setGPUMemory(this._vertexBuffer._byteLength+this._vertexBufferInvertUV._byteLength)}static __init__(){e._vertexDeclaration=new lt(16,[new _t(0,ot.Vector4,e.SCREENTRIANGLE_POSITION_UV)]),e.instance=new e,e.instance.lock=!0}render(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}renderInvertUV(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}destroy(){super.destroy(),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}return e.SCREENTRIANGLE_POSITION_UV=0,e._vertices=new Float32Array([-1,-1,0,0,-1,3,0,2,3,-1,2,0]),e._verticesInvertUV=new Float32Array([-1,-1,0,1,-1,3,0,-1,3,-1,2,1]),e})(),St=(()=>{class e{constructor(){this._commandBuffer=null}static __init__(){e._screenShaderData=new Ie,e._screenShader=Ae.find("BlitScreen")}run(){}recover(){this._commandBuffer=null}}return e.SCREENTEXTURE_NAME="u_MainTex",e.SCREENTEXTUREOFFSETSCALE_NAME="u_OffsetScale",e.MAINTEXTURE_TEXELSIZE_NAME="u_MainTex_TexelSize",e.SCREENTEXTURE_ID=Ae.propertyNameToID(e.SCREENTEXTURE_NAME),e.SCREENTEXTUREOFFSETSCALE_ID=Ae.propertyNameToID(e.SCREENTEXTUREOFFSETSCALE_NAME),e.MAINTEXTURE_TEXELSIZE_ID=Ae.propertyNameToID(e.MAINTEXTURE_TEXELSIZE_NAME),e})(),Rt=(()=>{class e extends St{constructor(){super(...arguments),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,this._subShader=0,this._sourceTexelSize=new n,this._screenType=0}static create(t,r,i=null,n=null,a=null,s=0,o=e._SCREENTYPE_QUAD){var l;return(l=e._pool.length>0?e._pool.pop():new e)._source=t,l._dest=r,l._offsetScale=i,l._shader=n,l._shaderData=a,l._subShader=s,l._screenType=o,l}run(){var r=this._shader||St._screenShader,i=this._shaderData||St._screenShaderData,n=this._dest;t.LayaGL.instance.viewport(0,0,n?n.width:Ee.clientWidth,n?n.height:Ee.clientHeight),i.setTexture(St.SCREENTEXTURE_ID,this._source),i.setVector(St.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale||e._defaultOffsetScale),this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height),i.setVector(St.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),n&&n._start();for(var a=r.getSubShaderAt(this._subShader)._passes,s=0,o=a.length;s<o;s++){var l=e._compileDefine;i._defineDatas.cloneTo(l);var _=a[s].withCompile(l);switch(_.bind(),_.uploadUniforms(_._materialUniformParamsMap,i,!0),_.uploadRenderStateBlendDepth(i),_.uploadRenderStateFrontFace(i,!1,null),this._screenType){case e._SCREENTYPE_QUAD:Ee._instance.invertY?pt.instance.renderInvertUV():pt.instance.render();break;case e._SCREENTYPE_TRIANGLE:Ee._instance.invertY?gt.instance.renderInvertUV():gt.instance.render();break;default:throw"BlitScreenQuadCMD:unknown screen Type."}}n&&n._end()}recover(){e._pool.push(this),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,super.recover()}}return e._SCREENTYPE_QUAD=0,e._SCREENTYPE_TRIANGLE=1,e._compileDefine=new ge,e._pool=[],e._defaultOffsetScale=new n(0,0,1,1),e})(),vt=(()=>{class e extends St{constructor(){super(...arguments),this._renderTexture=null}static create(t){var r;return(r=e._pool.length>0?e._pool.pop():new e)._renderTexture=t,r}run(){this._renderTexture._start()}recover(){e._pool.push(this),this._renderTexture=null}}return e._pool=[],e})(),At=(()=>{class e extends St{constructor(){super(...arguments),this._shaderData=null,this._nameID=0,this._texture=null}static create(t,r,i){var n;return(n=e._pool.length>0?e._pool.pop():new e)._shaderData=t,n._nameID=r,n._texture=i,n}run(){this._shaderData.setTexture(this._nameID,this._texture)}recover(){e._pool.push(this),this._shaderData=null,this._nameID=0,this._texture=null}}return e._pool=[],e})();class It{constructor(){this._camera=null,this._commands=[]}_apply(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].run()}setShaderDataTexture(e,t,r){this._commands.push(At.create(e,t,r))}blitScreenQuad(e,t,r=null,i=null,n=null,a=0){this._commands.push(Rt.create(e,t,r,i,n,a,Rt._SCREENTYPE_QUAD))}blitScreenTriangle(e,t,r=null,i=null,n=null,a=0){this._commands.push(Rt.create(e,t,r,i,n,a,Rt._SCREENTYPE_TRIANGLE))}setRenderTarget(e){this._commands.push(vt.create(e))}clear(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].recover();this._commands.length=0}}class xt{}var Ct;(Ct=e.LightType||(e.LightType={}))[Ct.Directional=0]="Directional",Ct[Ct.Spot=1]="Spot",Ct[Ct.Point=2]="Point";let Lt=(()=>{class t extends ft{constructor(){super(),this._shadowMode=e.ShadowMode.None,this._isAlternate=!1,this._shadowResolution=2048,this._shadowDistance=50,this._shadowDepthBias=1,this._shadowNormalBias=1,this._shadowNearPlane=.1,this._shadowStrength=1,this._intensity=1,this._intensityColor=new a,this.color=new a(1,1,1),this._lightmapBakedType=t.LIGHTMAPBAKEDTYPE_REALTIME}get intensity(){return this._intensity}set intensity(e){this._intensity=e}get shadowMode(){return this._shadowMode}set shadowMode(e){this._shadowMode=e}get shadowDistance(){return this._shadowDistance}set shadowDistance(e){this._shadowDistance=e}get shadowResolution(){return this._shadowResolution}set shadowResolution(e){this._shadowResolution=e}get shadowDepthBias(){return this._shadowDepthBias}set shadowDepthBias(e){this._shadowDepthBias=e}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(e){this._shadowNormalBias=e}get shadowStrength(){return this._shadowStrength}set shadowStrength(e){this._shadowStrength=e}get shadowNearPlane(){return this._shadowNearPlane}set shadowNearPlane(e){this._shadowNearPlane=e}get lightmapBakedType(){return this._lightmapBakedType}set lightmapBakedType(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this.activeInHierarchy&&(e!==t.LIGHTMAPBAKEDTYPE_BAKED?this._addToScene():this._removeFromScene()))}_parse(e,t){super._parse(e,t);var r=e.color;this.color.fromArray(r),this.intensity=e.intensity,this.lightmapBakedType=e.lightmapBakedType,null!=e.shadowMode&&(this.shadowMode=e.shadowMode),null!=e.shadowStrength&&(this.shadowStrength=e.shadowStrength),null!=e.shadowDistance&&(this.shadowDistance=e.shadowDistance),null!=e.shadowNearPlane&&(this.shadowNearPlane=e.shadowNearPlane),null!=e.shadowResolution&&(this.shadowResolution=e.shadowResolution)}_addToScene(){var e=this._scene,t=Q._config.maxLightCount;e._lightCount<t?(e._lightCount++,this._addToLightQueue(),this._isAlternate=!1):(e._alternateLights.add(this),this._isAlternate=!0,console.warn("LightSprite:light count has large than maxLightCount,the latest added light will be ignore."))}_removeFromScene(){var e=this._scene;if(this._isAlternate)e._alternateLights.remove(this);else if(e._lightCount--,this._removeFromLightQueue(),e._alternateLights._length>0){var t=e._alternateLights.shift();t._addToLightQueue(),t._isAlternate=!1,e._lightCount++}}_addToLightQueue(){}_removeFromLightQueue(){}_onActive(){super._onActive(),this.lightmapBakedType!==t.LIGHTMAPBAKEDTYPE_BAKED&&this._addToScene()}_onInActive(){super._onInActive(),this.lightmapBakedType!==t.LIGHTMAPBAKEDTYPE_BAKED&&this._removeFromScene()}_create(){return new t}get diffuseColor(){return console.log("LightSprite: discard property,please use color property instead."),this.color}set diffuseColor(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}}return t.LIGHTMAPBAKEDTYPE_REALTIME=0,t.LIGHTMAPBAKEDTYPE_MIXED=1,t.LIGHTMAPBAKEDTYPE_BAKED=2,t})();var yt,Dt;(yt=e.ShadowCascadesMode||(e.ShadowCascadesMode={}))[yt.NoCascades=0]="NoCascades",yt[yt.TwoCascades=1]="TwoCascades",yt[yt.FourCascades=2]="FourCascades",function(e){e[e.Near=0]="Near",e[e.Far=1]="Far",e[e.Left=2]="Left",e[e.Right=3]="Right",e[e.Bottom=4]="Bottom",e[e.Top=5]="Top"}(Dt||(Dt={}));let Mt=(()=>{class i{static supportShadow(){return t.LayaGL.layaGPUInstance._isWebGL2||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.Depth)}static init(){t.LayaGL.layaGPUInstance._isWebGL2?i._shadowTextureFormat=t.RenderTextureFormat.ShadowMap:i._shadowTextureFormat=t.RenderTextureFormat.Depth}static getTemporaryShadowTexture(e,r,n){var a=pe.createFromPool(e,r,i._shadowTextureFormat,n);return a.filterMode=t.FilterMode.Bilinear,a.wrapModeU=t.WarpMode.Clamp,a.wrapModeV=t.WarpMode.Clamp,a}static getShadowBias(t,i,n,a){var s;t._lightType==e.LightType.Directional?s=2/i.elements[0]:t._lightType==e.LightType.Spot?s=Math.tan(.5*t.spotAngle*r.Deg2Rad)*t.range:(console.warn("ShadowUtils:Only spot and directional shadow casters are supported now."),s=0);var o=s/n,l=-t._shadowDepthBias*o,_=-t._shadowNormalBias*o;if(t.shadowMode==e.ShadowMode.SoftHigh){const e=2.5;l*=e,_*=e}a.setValue(l,_,0,0)}static getCameraFrustumPlanes(e,t){tt.getPlanesFromMatrix(e,t[Dt.Near],t[Dt.Far],t[Dt.Left],t[Dt.Right],t[Dt.Top],t[Dt.Bottom])}static getFarWithRadius(e,t){return Math.sqrt(e*e/t)}static getCascadesSplitDistance(t,r,n,a,s,o,l,_){_[0]=n;var h=a-n,c=Math.tan(.5*s),d=1+c*c*(o*o+1);switch(l){case e.ShadowCascadesMode.NoCascades:_[1]=i.getFarWithRadius(a,d);break;case e.ShadowCascadesMode.TwoCascades:_[1]=i.getFarWithRadius(n+h*t,d),_[2]=i.getFarWithRadius(a,d);break;case e.ShadowCascadesMode.FourCascades:_[1]=i.getFarWithRadius(n+h*r.x,d),_[2]=i.getFarWithRadius(n+h*r.y,d),_[3]=i.getFarWithRadius(n+h*r.z,d),_[4]=i.getFarWithRadius(a,d)}}static applySliceTransform(e,t,r,n,a){var s=i._tempMatrix0.elements,o=1/t,l=1/r;s[0]=e.resolution*o,s[5]=e.resolution*l,s[12]=e.offsetX*o,s[13]=e.offsetY*l,s[1]=s[2]=s[2]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[14]=0,s[10]=s[15]=1;var _=16*n;k._mulMatrixArray(s,a,_,a,_)}static getDirectionLightShadowCullPlanes(t,r,n,s,o,l){var _=i._frustumCorners,h=i._backPlaneFaces,c=i._frustumPlaneNeighbors,d=i._frustumTwoPlaneCorners,u=i._edgePlanePoint2,m=l.cullPlanes,f=t[Dt.Near],T=t[Dt.Far],E=t[Dt.Left],p=t[Dt.Right],g=t[Dt.Bottom],S=t[Dt.Top],R=n[r]-s,v=i._adjustNearPlane,A=i._adjustFarPlane;f.normal.cloneTo(v.normal),T.normal.cloneTo(A.normal),v.distance=f.distance-R,A.distance=Math.min(-f.distance+l.sphereCenterZ+l.splitBoundSphere.radius,T.distance),tt.get3PlaneInterPoint(v,g,p,_[e.FrustumCorner.nearBottomRight]),tt.get3PlaneInterPoint(v,S,p,_[e.FrustumCorner.nearTopRight]),tt.get3PlaneInterPoint(v,S,E,_[e.FrustumCorner.nearTopLeft]),tt.get3PlaneInterPoint(v,g,E,_[e.FrustumCorner.nearBottomLeft]),tt.get3PlaneInterPoint(A,g,p,_[e.FrustumCorner.FarBottomRight]),tt.get3PlaneInterPoint(A,S,p,_[e.FrustumCorner.FarTopRight]),tt.get3PlaneInterPoint(A,S,E,_[e.FrustumCorner.FarTopLeft]),tt.get3PlaneInterPoint(A,g,E,_[e.FrustumCorner.FarBottomLeft]);for(var I=0,x=0;x<6;x++){var C;switch(x){case Dt.Near:C=v;break;case Dt.Far:C=A;break;default:C=t[x]}a.dot(C.normal,o)<0&&(C.cloneTo(m[I]),h[I]=x,I++)}var L=I;for(x=0;x<I;x++)for(var y=h[x],D=c[y],M=0;M<4;M++){for(var O=D[M],N=!0,b=0;b<I;b++)if(O==h[b]){N=!1;break}if(N){var P=d[y][O],w=_[P[0]],V=_[P[1]];a.add(w,o,u),Qe.createPlaneBy3P(w,V,u,m[L++])}}l.cullPlaneCount=L}static getBoundSphereByFrustum(e,t,r,i,n,s,o){var l,_,h=Math.sqrt(1+i*i)*Math.tan(r/2),c=h*h,d=t-e,u=t+e;c>d/u?(l=t,_=t*h):(l=.5*u*(1+c),_=.5*Math.sqrt(d*d+2*(t*t+e*e)*c+u*u*c*c));var m=o.center;return o.radius=_,a.scale(s,l,m),a.add(n,m,m),l}static getMaxTileResolutionInAtlas(e,t,r){for(var i=Math.min(e,t),n=Math.floor(e/i)*Math.floor(t/i);n<r;)i=Math.floor(i>>1),n=Math.floor(e/i)*Math.floor(t/i);return i}static getDirectionalLightMatrices(e,t,r,n,s,o,l,_){var c=l.splitBoundSphere,d=c.center,u=c.radius,m=o/2,f=u*m/(m-i.atlasBorderSize),T=2*f,E=o/T,p=T/o,g=Math.ceil(a.dot(d,e)*E)*p,S=Math.ceil(a.dot(d,t)*E)*p,R=a.dot(d,r);d.x=e.x*g+t.x*S+r.x*R,d.y=e.y*g+t.y*S+r.y*R,d.z=e.z*g+t.z*S+r.z*R;var v=l.position,A=l.viewMatrix,I=l.projectionMatrix,x=l.viewProjectMatrix;l.resolution=o,l.offsetX=n%2*o,l.offsetY=Math.floor(n/2)*o,a.scale(r,u+s,v),a.subtract(d,v,v),h.createLookAt(v,d,e,A),h.createOrthoOffCenter(-f,f,-f,f,0,2*u+s,I),h.multiply(I,A,x),k._mulMatrixArray(i._shadowMapScaleOffsetMatrix.elements,x.elements,0,_,16*n)}static getSpotLightShadowData(e,t,r,i,n,a){var s=e.position=t.transform.position;e.resolution=r,a.setValue(1/r,1/r,r,r),e.offsetX=0,e.offsetY=0;var o=t.transform.worldMatrix,l=e.viewMatrix,_=e.projectionMatrix,c=e.viewProjectMatrix,d=e.cameraCullInfo.boundFrustum;o.invert(l),h.createPerspective(3.1416*t.spotAngle/180,1,.1,t.range,_),i.y=t.shadowStrength,h.multiply(_,l,c),d.matrix=c,c.cloneTo(n),e.cameraCullInfo.position=s}static prepareShadowReceiverShaderValues(e,t,r,i,n,a,s,o,l){if(a.setValue(1/t,1/r,t,r),s.setValue(e._shadowStrength,0,0,0),n>1){const e=16;for(var _=n*e,h=4*e;_<h;_++)o[_]=0;for(_=0;_<n;_++){var c=i[_].splitBoundSphere,d=c.center,u=c.radius,m=4*_;l[m]=d.x,l[m+1]=d.y,l[m+2]=d.z,l[m+3]=u*u}const t=4;for(_=n*t,h=4*t;_<h;_++)l[_]=0}}}return i._tempMatrix0=new h,i._shadowMapScaleOffsetMatrix=new h(.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1),i._frustumCorners=[new a,new a,new a,new a,new a,new a,new a,new a],i._adjustNearPlane=new Qe(new a),i._adjustFarPlane=new Qe(new a),i._backPlaneFaces=new Array(5),i._edgePlanePoint2=new a,i._frustumPlaneNeighbors=[[Dt.Left,Dt.Right,Dt.Top,Dt.Bottom],[Dt.Left,Dt.Right,Dt.Top,Dt.Bottom],[Dt.Near,Dt.Far,Dt.Top,Dt.Bottom],[Dt.Near,Dt.Far,Dt.Top,Dt.Bottom],[Dt.Near,Dt.Far,Dt.Left,Dt.Right],[Dt.Near,Dt.Far,Dt.Left,Dt.Right]],i._frustumTwoPlaneCorners=[[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearTopRight]],[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarTopRight],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarTopLeft]],[[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.nearTopLeft]],[[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearTopRight,e.FrustumCorner.FarTopRight]],[[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]],[[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarTopRight],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.FarTopRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]]],i.atlasBorderSize=4,i})();var Ot;(Ot=e.CameraClearFlags||(e.CameraClearFlags={}))[Ot.SolidColor=0]="SolidColor",Ot[Ot.Sky=1]="Sky",Ot[Ot.DepthOnly=2]="DepthOnly",Ot[Ot.Nothing=3]="Nothing";let Nt=(()=>{class r extends Tt{constructor(r=0,a=.3,s=1e3){super(a,s),this._updateViewMatrix=!0,this._postProcess=null,this._enableHDR=!1,this._viewportParams=new n,this._projectionParams=new n,this._offScreenRenderTexture=null,this._internalRenderTexture=null,this._postProcessCommandBuffers=[],this._clusterPlaneCacheFlag=new i(-1,-1),this._screenOffsetScale=new n,this.enableRender=!0,this.clearFlag=e.CameraClearFlags.SolidColor,this._viewMatrix=new h,this._projectionMatrix=new h,this._projectionViewMatrix=new h,this._viewport=new rt(0,0,0,0),this._normalizedViewport=new rt(0,0,1,1),this._aspectRatio=r,this._boundFrustum=new tt(new h),t.Render.supportWebGLPlusCulling&&(this._boundFrustumBuffer=new Float32Array(24)),this._calculateProjectionMatrix(),t.Laya.stage.on(t.Event.RESIZE,this,this._onScreenSizeChanged),this.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}get aspectRatio(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio}set aspectRatio(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}get viewport(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,Ee.clientWidth,Ee.clientHeight),this._viewport}set viewport(e){var t,r;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,r=this._offScreenRenderTexture.height):(t=Ee.clientWidth,r=Ee.clientHeight),this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/r,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/r,this._calculationViewport(this._normalizedViewport,t,r),this._calculateProjectionMatrix()}get normalizedViewport(){return this._normalizedViewport}set normalizedViewport(e){var t,r;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,r=this._offScreenRenderTexture.height):(t=Ee.clientWidth,r=Ee.clientHeight),this._normalizedViewport!==e&&e.cloneTo(this._normalizedViewport),this._calculationViewport(e,t,r),this._calculateProjectionMatrix()}get viewMatrix(){if(this._updateViewMatrix){var e=this.transform.getWorldLossyScale(),t=e.x,r=e.y,i=e.z,n=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),n[0]/=t,n[1]/=t,n[2]/=t,n[4]/=r,n[5]/=r,n[6]/=r,n[8]/=i,n[9]/=i,n[10]/=i,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1}return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}set projectionMatrix(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}get projectionViewMatrix(){return h.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}get boundFrustum(){if(this._boundFrustum.matrix=this.projectionViewMatrix,t.Render.supportWebGLPlusCulling){var e=this._boundFrustum.near,r=this._boundFrustum.far,i=this._boundFrustum.left,n=this._boundFrustum.right,a=this._boundFrustum.top,s=this._boundFrustum.bottom,o=e.normal,l=r.normal,_=i.normal,h=n.normal,c=a.normal,d=s.normal,u=this._boundFrustumBuffer;u[0]=o.x,u[1]=o.y,u[2]=o.z,u[3]=e.distance,u[4]=l.x,u[5]=l.y,u[6]=l.z,u[7]=r.distance,u[8]=_.x,u[9]=_.y,u[10]=_.z,u[11]=i.distance,u[12]=h.x,u[13]=h.y,u[14]=h.z,u[15]=n.distance,u[16]=c.x,u[17]=c.y,u[18]=c.z,u[19]=a.distance,u[20]=d.x,u[21]=d.y,u[22]=d.z,u[23]=s.distance}return this._boundFrustum}get renderTarget(){return this._offScreenRenderTexture}set renderTarget(e){var t=this._offScreenRenderTexture;t!==e&&(t&&(t._isCameraTarget=!1),e&&(e._isCameraTarget=!0),this._offScreenRenderTexture=e,this._calculateProjectionMatrix())}get postProcess(){return this._postProcess}set postProcess(e){this._postProcess=e;var t=new It;this.addCommandBuffer(r.CAMERAEVENT_POSTPROCESS,t),e._init(this,t)}get enableHDR(){return this._enableHDR}set enableHDR(e){!e||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.R16G16B16A16)?this._enableHDR=e:console.warn("Camera:can't enable HDR in this device.")}_calculationViewport(e,t,r){var i=e.x*t,n=e.y*r,a=i+Math.max(e.width*t,0),s=n+Math.max(e.height*r,0),o=Math.ceil(i),l=Math.ceil(n),_=Math.floor(a),h=Math.floor(s),c=o-i>=.5?Math.floor(i):o,d=l-n>=.5?Math.floor(n):l,u=a-_>=.5?Math.ceil(a):_,m=s-h>=.5?Math.ceil(s):h;this._viewport.x=c,this._viewport.y=d,this._viewport.width=u-c,this._viewport.height=m-d}_calculateProjectionMatrix(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=.5*this.orthographicVerticalSize,t=e*this.aspectRatio;h.createOrthoOffCenter(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else h.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)}_isLayerVisible(e){return 0!=(Math.pow(2,e)&this.cullingMask)}_onTransformChanged(e){(e&=d.TRANSFORM_WORLDMATRIX)&&(this._updateViewMatrix=!0)}_parse(e,t){super._parse(e,t);var r=e.clearFlag;void 0!==r&&(this.clearFlag=r);var i=e.viewport;this.normalizedViewport=new rt(i[0],i[1],i[2],i[3]);var n=e.enableHDR;void 0!==n&&(this.enableHDR=n)}_getCanvasWidth(){return this._offScreenRenderTexture?this._offScreenRenderTexture.width:Ee.clientWidth}_getCanvasHeight(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:Ee.clientHeight}_getRenderTexture(){return this._internalRenderTexture||this._offScreenRenderTexture}_needInternalRenderTexture(){return!(!this._postProcess&&!this._enableHDR)}_applyPostProcessCommandBuffers(){for(var e=0,t=this._postProcessCommandBuffers.length;e<t;e++)this._postProcessCommandBuffers[e]._apply()}_getRenderTextureFormat(){return this._enableHDR?t.RenderTextureFormat.R16G16B16A16:t.RenderTextureFormat.R8G8B8}_prepareCameraToRender(){super._prepareCameraToRender();var e=this.viewport;this._viewportParams.setValue(e.x,e.y,e.width,e.height),this._projectionParams.setValue(this._nearPlane,this._farPlane,Ee._instance.invertY?-1:1,0),this._shaderValues.setVector(Tt.VIEWPORT,this._viewportParams),this._shaderValues.setVector(Tt.PROJECTION_PARAMS,this._projectionParams)}_applyViewProject(e,t,r){var i,n=this._shaderValues;e.invertY?(h.multiply(Tt._invertYScaleMatrix,r,Tt._invertYProjectionMatrix),h.multiply(Tt._invertYProjectionMatrix,t,Tt._invertYProjectionViewMatrix),r=Tt._invertYProjectionMatrix,i=Tt._invertYProjectionViewMatrix):(h.multiply(r,t,this._projectionViewMatrix),i=this._projectionViewMatrix),e.viewMatrix=t,e.projectionMatrix=r,e.projectionViewMatrix=i,n.setMatrix4x4(Tt.VIEWMATRIX,t),n.setMatrix4x4(Tt.PROJECTMATRIX,r),n.setMatrix4x4(Tt.VIEWPROJECTMATRIX,i)}_updateClusterPlaneXY(){var e=this.fieldOfView,t=this.aspectRatio;if(this._clusterPlaneCacheFlag.x!==e||this._clusterPlaneCacheFlag.y!==t){var r=Q._config.lightClusterCount,i=r.x,n=r.y,s=i+1,o=n+1,l=this._clusterXPlanes,_=this._clusterYPlanes;if(!l){l=this._clusterXPlanes=new Array(s),_=this._clusterYPlanes=new Array(o);for(var h=0;h<s;h++)l[h]=new a;for(h=0;h<o;h++)_[h]=new a}var c=Math.tan(this.fieldOfView/2*Math.PI/180),d=this.aspectRatio*c,u=2*c/i,m=2*d/n;for(h=0;h<s;h++){var f=m*h-d,T=1/Math.sqrt(1+f*f);l[h].setValue(T,0,-f*T)}for(h=0;h<o;h++){f=c-u*h;var E=-1/Math.sqrt(1+f*f);_[h].setValue(0,E,-f*E)}this._clusterPlaneCacheFlag.x=e,this._clusterPlaneCacheFlag.y=t}}render(i=null,n=null){if(this.activeInHierarchy){var a,s=this.viewport,o=this._needInternalRenderTexture(),_=t.LayaGL.instance,h=Ee._instance,c=h.scene=this._scene;h.pipelineMode="Forward",o?(this._internalRenderTexture=pe.createFromPool(s.width,s.height,this._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16),this._internalRenderTexture.filterMode=t.FilterMode.Bilinear):this._internalRenderTexture=null;var d=c._mainDirectionLight,u=d&&d.shadowMode!==e.ShadowMode.None&&Mt.supportShadow();u?(c._shaderValues.removeDefine(xt.SHADERDEFINE_SHADOW_SPOT),c._shaderValues.addDefine(xt.SHADERDEFINE_SHADOW),(a=l.Scene3D._shadowCasterPass).update(this,d,l.ShadowLightType.DirectionLight),a.render(h,c,l.ShadowLightType.DirectionLight)):c._shaderValues.removeDefine(xt.SHADERDEFINE_SHADOW);var m=c._mainSpotLight,f=m&&m.shadowMode!==e.ShadowMode.None&&Mt.supportShadow();if(f?(c._shaderValues.removeDefine(xt.SHADERDEFINE_SHADOW),c._shaderValues.addDefine(xt.SHADERDEFINE_SHADOW_SPOT),(a=l.Scene3D._shadowCasterPass).update(this,m,l.ShadowLightType.SpotLight),a.render(h,c,l.ShadowLightType.SpotLight)):c._shaderValues.removeDefine(xt.SHADERDEFINE_SHADOW_SPOT),u&&c._shaderValues.addDefine(xt.SHADERDEFINE_SHADOW),f&&c._shaderValues.addDefine(xt.SHADERDEFINE_SHADOW_SPOT),h.camera=this,h.cameraShaderValue=this._shaderValues,r._updateMark++,c._preRenderScript(),o&&!this._offScreenRenderTexture&&(this.clearFlag==e.CameraClearFlags.DepthOnly||this.clearFlag==e.CameraClearFlags.Nothing))if(this._enableHDR){var T=pe.createFromPool(s.width,s.height,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTH_16);T.filterMode=t.FilterMode.Bilinear,t.WebGLContext.bindTexture(_,_.TEXTURE_2D,T._getSource()),_.copyTexSubImage2D(_.TEXTURE_2D,0,0,0,s.x,Ee.clientHeight-(s.y+s.height),s.width,s.height),(p=Rt.create(T,this._internalRenderTexture)).run(),p.recover(),pe.recoverToPool(T)}else t.WebGLContext.bindTexture(_,_.TEXTURE_2D,this._internalRenderTexture._getSource()),_.copyTexSubImage2D(_.TEXTURE_2D,0,0,0,s.x,Ee.clientHeight-(s.y+s.height),s.width,s.height);var E=this._getRenderTexture();if(E&&E._start(),h.viewport=s,this._prepareCameraToRender(),Q._config._multiLighting&&Ye.instance.update(this,this._scene),this._applyViewProject(h,this.viewMatrix,this._projectionMatrix),c._preCulling(h,this,i,n),c._clear(_,h),c._renderScene(h),c._postRenderScript(),E&&E._end(),o){if(this._postProcess)this._postProcess._render(),this._applyPostProcessCommandBuffers();else if(this._enableHDR){var p,g=this._getCanvasWidth(),S=this._getCanvasHeight();this._screenOffsetScale.setValue(s.x/g,s.y/S,s.width/g,s.height/S),(p=Rt.create(this._internalRenderTexture,this._offScreenRenderTexture?this._offScreenRenderTexture:null,this._screenOffsetScale)).run(),p.recover()}pe.recoverToPool(this._internalRenderTexture)}(u||f)&&a.cleanUp()}}viewportPointToRay(e,t){it.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}normalizedViewportPointToRay(e,t){var i=r._tempVector20,n=this.viewport;i.x=e.x*n.width,i.y=e.y*n.height,it.calculateCursorRay(i,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}worldToViewportPoint(e,r){h.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,r),r.x=r.x/t.Laya.stage.clientScaleX,r.y=r.y/t.Laya.stage.clientScaleY}worldToNormalizedViewportPoint(e,r){h.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,r),r.x=r.x/t.Laya.stage.clientScaleX,r.y=r.y/t.Laya.stage.clientScaleY}convertScreenCoordToOrthographicCoord(e,r){if(this._orthographic){var i=Ee.clientWidth,n=Ee.clientHeight,s=this.orthographicVerticalSize*this.aspectRatio/i,o=this.orthographicVerticalSize/n;return r.x=(-i/2+e.x*t.Laya.stage.clientScaleX)*s,r.y=(n/2-e.y*t.Laya.stage.clientScaleY)*o,r.z=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,a.transformCoordinate(r,this.transform.worldMatrix,r),!0}return!1}destroy(e=!0){this._offScreenRenderTexture=null,this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),super.destroy(e)}addCommandBuffer(e,t){switch(e){case r.CAMERAEVENT_POSTPROCESS:this._postProcessCommandBuffers.push(t),t._camera=this;break;default:throw"Camera:unknown event."}}removeCommandBuffer(e,t){switch(e){case r.CAMERAEVENT_POSTPROCESS:var i=this._postProcessCommandBuffers.indexOf(t);-1!==i&&this._postProcessCommandBuffers.splice(i,1);break;default:throw"Camera:unknown event."}}removeCommandBuffers(e){switch(e){case r.CAMERAEVENT_POSTPROCESS:this._postProcessCommandBuffers.length=0;break;default:throw"Camera:unknown event."}}_create(){return new r}}return r.CAMERAEVENT_POSTPROCESS=0,r._tempVector20=new i,r._updateMark=0,r})(),bt=(()=>{class r{constructor(){this._eventList=[],this._mouseTouch=new Ze,this._touchPool=[],this._touches=new Ue,this._multiTouchEnabled=!0,this._pushEventList=(e=>{e.cancelable&&e.preventDefault(),this._eventList.push(e)}).bind(this)}__init__(e,t){this._scene=t,e.oncontextmenu=function(e){return!1}}_onCanvasEvent(e){e.addEventListener("mousedown",this._pushEventList),e.addEventListener("mouseup",this._pushEventList,!0),e.addEventListener("mousemove",this._pushEventList,!0),e.addEventListener("touchstart",this._pushEventList),e.addEventListener("touchend",this._pushEventList,!0),e.addEventListener("touchmove",this._pushEventList,!0),e.addEventListener("touchcancel",this._pushEventList,!0)}_offCanvasEvent(e){e.removeEventListener("mousedown",this._pushEventList),e.removeEventListener("mouseup",this._pushEventList,!0),e.removeEventListener("mousemove",this._pushEventList,!0),e.removeEventListener("touchstart",this._pushEventList),e.removeEventListener("touchend",this._pushEventList,!0),e.removeEventListener("touchmove",this._pushEventList,!0),e.removeEventListener("touchcancel",this._pushEventList,!0),this._eventList.length=0,this._touches.clear()}touchCount(){return this._touches.length}get multiTouchEnabled(){return this._multiTouchEnabled}set multiTouchEnabled(e){this._multiTouchEnabled=e}_getTouch(e){var t=this._touchPool[e];return t||(t=new qe,this._touchPool[e]=t,t._identifier=e),t}_mouseTouchDown(){var e=this._mouseTouch,r=e.sprite;if(e._pressedSprite=r,e._pressedLoopCount=t.Stat.loopCount,r){var i=r._scripts;if(i)for(var n=0,a=i.length;n<a;n++)i[n].onMouseDown()}}_mouseTouchUp(){var e,t,r=this._mouseTouch,i=r._pressedSprite;r._pressedSprite=null,r._pressedLoopCount=-1;var n=r.sprite;if(n&&n===i){var a=n._scripts;if(a)for(e=0,t=a.length;e<t;e++)a[e].onMouseClick()}if(i){var s=i._scripts;if(s)for(e=0,t=s.length;e<t;e++)s[e].onMouseUp()}}_mouseTouchRayCast(t){var i=r._tempHitResult0,n=r._tempVector20,a=r._tempRay0;i.succeeded=!1;var s=this._mouseTouch.mousePositionX,o=this._mouseTouch.mousePositionY;n.x=s,n.y=o;for(var l=t.length-1;l>=0;l--){var _=t[l],h=_.viewport;if(n.x>=h.x&&n.y>=h.y&&n.x<=h.width&&n.y<=h.height)if(_.viewportPointToRay(n,a),this._scene._physicsSimulation.rayCast(a,i)||_.clearFlag===e.CameraClearFlags.SolidColor||_.clearFlag===e.CameraClearFlags.Sky)break}var c=this._mouseTouch,d=c.sprite;if(i.succeeded){var u=i.collider.owner;c.sprite=u;var m=u._scripts;if(d!==u&&m)for(var f=0,T=m.length;f<T;f++)m[f].onMouseEnter()}else c.sprite=null;if(d&&d!==u){var E=d._scripts;if(E)for(f=0,T=E.length;f<T;f++)E[f].onMouseOut()}}_changeTouches(e,i){for(var n=0,a=0,s=this._touches.length,o=0,l=e.length;o<l;o++){var _=e[o],h=_.identifier;if(this._multiTouchEnabled||0===h){var c=this._getTouch(h),d=c._position,u=r._tempPoint;u.setTo(_.pageX,_.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(u);var m=u.x,f=u.y;switch(i){case 0:this._touches.add(c),n+=m,a+=f;break;case 1:this._touches.remove(c),n-=m,a-=f;break;case 2:n=m-d.x,a=f-d.y}d.x=m,d.y=f}}var T=this._touches.length;0===T?(this._mouseTouch.mousePositionX=0,this._mouseTouch.mousePositionY=0):(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*s+n)/T,this._mouseTouch.mousePositionY=(this._mouseTouch.mousePositionY*s+a)/T)}_update(){var e,i,n,a,s=Z._enablePhysics&&!H.disableSimulation;i=this._eventList.length;var o=this._scene._cameraPool;if(i>0){var l=!1;for(e=0;e<i;e++){var _=this._eventList[e];switch(_.type){case"mousedown":s&&this._mouseTouchDown();break;case"mouseup":s&&this._mouseTouchUp();break;case"mousemove":var h=r._tempPoint;h.setTo(_.pageX,_.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(h),this._mouseTouch.mousePositionX=h.x,this._mouseTouch.mousePositionY=h.y,s&&(l=!0);break;case"touchstart":var c=this._touches.length;this._changeTouches(_.changedTouches,0),s&&(l=!0,0===c&&this._mouseTouchDown());break;case"touchend":case"touchcancel":this._changeTouches(_.changedTouches,1),s&&0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(_.changedTouches,2),s&&(l=!0);break;default:throw"Input3D:unkonwn event type."}}l&&!Q._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),this._eventList.length=0}if(s){var d=this._mouseTouch,u=d._pressedSprite;if(u&&t.Stat.loopCount>d._pressedLoopCount){var m=u._scripts;if(m)for(n=0,a=m.length;n<a;n++)m[n].onMouseDrag()}var f=d.sprite;if(f){var T=f._scripts;if(T)for(n=0,a=T.length;n<a;n++)T[n].onMouseOver()}}}getTouch(e){return e<this._touches.length?this._touches.elements[e]:null}}return r._tempPoint=new t.Point,r._tempVector20=new i,r._tempRay0=new Ke(new a,new a),r._tempHitResult0=new U,r})();class Pt{constructor(){this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60}}class wt{constructor(e,t){this._position=e,this._textureCoordinate0=t}static get vertexDeclaration(){return wt._vertexDeclaration}static __init__(){wt._vertexDeclaration=new lt(20,[new _t(0,ot.Vector3,ht.MESH_POSITION0),new _t(12,ot.Vector2,ht.MESH_TEXTURECOORDINATE0)])}get position(){return this._position}get textureCoordinate0(){return this._textureCoordinate0}get vertexDeclaration(){return wt._vertexDeclaration}}let Vt=(()=>{class r extends dt{constructor(i=48,n=48){super();var a=t.LayaGL.instance;this._stacks=i,this._slices=n;for(var s=wt.vertexDeclaration,o=s.vertexStride/4,l=(this._stacks+1)*(this._slices+1),_=3*this._stacks*(this._slices+1)*2,h=new Float32Array(l*o),c=new Uint16Array(_),d=Math.PI/this._stacks,u=2*Math.PI/this._slices,m=0,f=0,T=0,E=0;E<this._stacks+1;E++)for(var p=Math.sin(E*d),g=Math.cos(E*d),S=0;S<this._slices+1;S++){var R=p*Math.sin(S*u),v=p*Math.cos(S*u);h[f+0]=R*r._radius,h[f+1]=g*r._radius,h[f+2]=v*r._radius,h[f+3]=-S/this._slices+.75,h[f+4]=E/this._stacks,f+=o,E!=this._stacks-1&&(c[T++]=m+1,c[T++]=m,c[T++]=m+(this._slices+1),c[T++]=m+(this._slices+1),c[T++]=m,c[T++]=m+this._slices,m++)}this._vertexBuffer=new ct(4*h.length,a.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=s,this._indexBuffer=new st(e.IndexFormat.UInt16,c.length,a.STATIC_DRAW,!1),this._vertexBuffer.setData(h.buffer),this._indexBuffer.setData(c);var A=new nt;A.bind(),A.applyVertexBuffer(this._vertexBuffer),A.applyIndexBuffer(this._indexBuffer),A.unBind(),this._bufferState=A}static __init__(){r.instance=new r}get stacks(){return this._stacks}get slices(){return this._slices}_render(e){var r=t.LayaGL.instance,i=this._indexBuffer.indexCount;r.drawElements(r.TRIANGLES,i,r.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=i/3,t.Stat.renderBatches++}}return r._radius=1,r})();var Ft;(Ft=e.TextureCubeFace||(e.TextureCubeFace={}))[Ft.PositiveX=0]="PositiveX",Ft[Ft.NegativeX=1]="NegativeX",Ft[Ft.PositiveY=2]="PositiveY",Ft[Ft.NegativeY=3]="NegativeY",Ft[Ft.PositiveZ=4]="PositiveZ",Ft[Ft.NegativeZ=5]="NegativeZ";let Bt=(()=>{class r extends t.BaseTexture{constructor(e,r=t.TextureFormat.R8G8B8,i=!1){super(r,i),this._glTextureType=t.LayaGL.instance.TEXTURE_CUBE_MAP,this._width=e,this._height=e;var n=t.LayaGL.instance;if(this._setWarpMode(n.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(n.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._mipmap){this._mipmapCount=Math.ceil(Math.log2(e))+1;for(var a=0;a<this._mipmapCount;a++)this._setPixels([],a,Math.max(e>>a,1),Math.max(e>>a,1));this._setGPUMemory(e*e*4*(1+1/3)*6)}else this._mipmapCount=1,this._setGPUMemory(e*e*4*6)}static get blackTexture(){return r._blackTexture}static get grayTexture(){return r._grayTexture}static __init__(){var e=new r(1,t.TextureFormat.R8G8B8,!1),i=new r(1,t.TextureFormat.R8G8B8,!1),n=new Uint8Array(3);n[0]=0,n[1]=0,n[2]=0,e.setSixSidePixels([n,n,n,n,n,n]),e.lock=!0,n[0]=128,n[1]=128,n[2]=128,i.setSixSidePixels([n,n,n,n,n,n]),i.lock=!0,r._grayTexture=i,r._blackTexture=e}static _parse(e,t=null,i=null){var n=i?new r(0,i[0],i[1]):new r(0);return n.setSixSideImageSources(e),n}static _parseBin(e,t=null,i=null){var n=i?new r(0,i[0],i[1]):new r(0);return n.setSixSideImageSources(e),n}static load(e,i){t.ILaya.loader.create(e,i,null,r.TEXTURECUBE)}get defaulteTexture(){return r.grayTexture}_setPixels(e,r,i,n){var a=t.LayaGL.instance,s=this._getGLFormat();t.WebGLContext.bindTexture(a,this._glTextureType,this._glTexture),this.format===t.TextureFormat.R8G8B8?(a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[5]),a.pixelStorei(a.UNPACK_ALIGNMENT,4)):(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,s,i,n,0,s,a.UNSIGNED_BYTE,e[5]))}setSixSideImageSources(e,r=!1){for(var i,n,a=0;a<6;a++){var s=e[a];if(!s)return void console.log("TextureCube: image Source can't be null.");var o=s.width,l=s.height;if(a>0&&i!==o)return void console.log("TextureCube: each side image's width and height must same.");if((i=o)!==(n=l))return void console.log("TextureCube: each side image's width and height must same.")}this._width=i,this._height=n;var _=t.LayaGL.instance;t.WebGLContext.bindTexture(_,this._glTextureType,this._glTexture);var h=this._getGLFormat();if(t.Render.isConchApp){if(1==r)for(var c=0;c<6;c++)e[c].setPremultiplyAlpha(r);_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Z,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[0]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[1]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[2]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_X,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[3]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Y,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[4]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[5])}else r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Z,0,h,h,_.UNSIGNED_BYTE,e[0]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,h,h,_.UNSIGNED_BYTE,e[1]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X,0,h,h,_.UNSIGNED_BYTE,e[2]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_X,0,h,h,_.UNSIGNED_BYTE,e[3]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Y,0,h,h,_.UNSIGNED_BYTE,e[4]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,h,h,_.UNSIGNED_BYTE,e[5]),r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);this._mipmap&&this._isPot(i)&&this._isPot(n)?(_.generateMipmap(this._glTextureType),this._setGPUMemory(i*n*4*(1+1/3)*6)):this._setGPUMemory(i*n*4*6),this._setWarpMode(_.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(_.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()}setSixSidePixels(e,r=0){if(!e)throw new Error("TextureCube:pixels can't be null.");var i=Math.max(this._width>>r,1),n=Math.max(this._height>>r,1),a=i*n*this._getFormatByteCount();if(e[0].length<a)throw"TextureCube:pixels length should at least "+a+".";if(this._setPixels(e,r,i,n),0===r){var s=t.LayaGL.instance;this._setWarpMode(s.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(s.TEXTURE_WRAP_T,this._wrapModeV)}this._readyed=!0,this._activeResource()}setImageSource(r,i,n=0){var a=this._width,s=this._height;if(!i||a===i.width&&s===i.height){var o=t.LayaGL.instance;t.WebGLContext.bindTexture(o,this._glTextureType,this._glTexture);var l=this._getGLFormat();switch(r){case e.TextureCubeFace.NegativeX:o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_X,n,l,l,o.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveX:o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X,n,l,l,o.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.NegativeY:o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,l,l,o.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveY:o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_Y,n,l,l,o.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.NegativeZ:o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,l,l,o.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveZ:o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_Z,n,l,l,o.UNSIGNED_BYTE,i)}this._mipmap&&this._isPot(a)&&this._isPot(s)?(o.generateMipmap(this._glTextureType),this._setGPUMemory(a*s*4*(1+1/3)*6)):this._setGPUMemory(a*s*4*6),this._setWarpMode(o.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(o.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0}else console.log("TextureCube: imageSource's width and height must same.")}}return r.TEXTURECUBE="TEXTURECUBE",r})();class Ut{constructor(){this._length=0,this._elements=[]}add(e){this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++}remove(e){var t=this._elements.indexOf(e);if(this._length--,t!==this._length){var r=this._elements[this._length];this._elements[t]=r}}shift(){return this._length--,this._elements.shift()}getBrightestLight(){for(var e,t=-1,r=this._elements,i=0;i<this._length;i++){var n=r[i]._intensity;t<n&&(t=n,e=i)}return e}normalLightOrdering(e){this._elements;var t=this._elements[0];this._elements[0]=this._elements[e],this._elements[e]=t}}class Gt extends Ut{remove(e){var t=this._elements.indexOf(e);this._elements.splice(t,1),this._length--}}let zt=(()=>{class e extends De{constructor(){super(),this.setShaderName("LineShader"),this._shaderValues.setVector(e.COLOR,new n(1,1,1,1))}static __initDefine__(){}get color(){return this._shaderValues.getVector(e.COLOR)}set color(t){this._shaderValues.setVector(e.COLOR,t)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}clone(){var t=new e;return this.cloneTo(t),t}}return e.COLOR=Ae.propertyNameToID("u_Color"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})(),Ht=(()=>{class e{constructor(e,t){this.min=e,this.max=t}_rotateExtents(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.elements;r.x=Math.abs(s[0]*i)+Math.abs(s[4]*n)+Math.abs(s[8]*a),r.y=Math.abs(s[1]*i)+Math.abs(s[5]*n)+Math.abs(s[9]*a),r.z=Math.abs(s[2]*i)+Math.abs(s[6]*n)+Math.abs(s[10]*a)}getCorners(e){e.length=8;var t=this.min.x,r=this.min.y,i=this.min.z,n=this.max.x,s=this.max.y,o=this.max.z;e[0]=new a(t,s,o),e[1]=new a(n,s,o),e[2]=new a(n,r,o),e[3]=new a(t,r,o),e[4]=new a(t,s,i),e[5]=new a(n,s,i),e[6]=new a(n,r,i),e[7]=new a(t,r,i)}getCenter(e){a.add(this.min,this.max,e),a.scale(e,.5,e)}getExtent(e){a.subtract(this.max,this.min,e),a.scale(e,.5,e)}setCenterAndExtent(e,t){a.subtract(e,t,this.min),a.add(e,t,this.max)}tranform(t,r){var i=e._tempVector30,n=e._tempVector31;this.getCenter(i),this.getExtent(n),a.transformCoordinate(i,t,i),this._rotateExtents(n,t,n),r.setCenterAndExtent(i,n)}toDefault(){this.min.toDefault(),this.max.toDefault()}static createfromPoints(e,t){if(null==e)throw new Error("points");var r=t.min,i=t.max;r.x=Number.MAX_VALUE,r.y=Number.MAX_VALUE,r.z=Number.MAX_VALUE,i.x=-Number.MAX_VALUE,i.y=-Number.MAX_VALUE,i.z=-Number.MAX_VALUE;for(var n=0,s=e.length;n<s;++n)a.min(r,e[n],r),a.max(i,e[n],i)}static merge(e,t,r){a.min(e.min,t.min,r.min),a.max(e.max,t.max,r.max)}cloneTo(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)}clone(){var t=new e(new a,new a);return this.cloneTo(t),t}}return e._tempVector30=new a,e._tempVector31=new a,e})(),Wt=(()=>{class e{constructor(t,r){this._updateFlag=0,this._center=new a,this._extent=new a,this._boundBox=new Ht(new a,new a),t.cloneTo(this._boundBox.min),r.cloneTo(this._boundBox.max),this._setUpdateFlag(e._UPDATE_CENTER|e._UPDATE_EXTENT,!0)}setMin(t){var r=this._boundBox.min;t!==r&&t.cloneTo(r),this._setUpdateFlag(e._UPDATE_CENTER|e._UPDATE_EXTENT,!0),this._setUpdateFlag(e._UPDATE_MIN,!1)}getMin(){var t=this._boundBox.min;return this._getUpdateFlag(e._UPDATE_MIN)&&(this._getMin(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(e._UPDATE_MIN,!1)),t}setMax(t){var r=this._boundBox.max;t!==r&&t.cloneTo(r),this._setUpdateFlag(e._UPDATE_CENTER|e._UPDATE_EXTENT,!0),this._setUpdateFlag(e._UPDATE_MAX,!1)}getMax(){var t=this._boundBox.max;return this._getUpdateFlag(e._UPDATE_MAX)&&(this._getMax(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(e._UPDATE_MAX,!1)),t}setCenter(t){t!==this._center&&t.cloneTo(this._center),this._setUpdateFlag(e._UPDATE_MIN|e._UPDATE_MAX,!0),this._setUpdateFlag(e._UPDATE_CENTER,!1)}getCenter(){return this._getUpdateFlag(e._UPDATE_CENTER)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(e._UPDATE_CENTER,!1)),this._center}setExtent(t){t!==this._extent&&t.cloneTo(this._extent),this._setUpdateFlag(e._UPDATE_MIN|e._UPDATE_MAX,!0),this._setUpdateFlag(e._UPDATE_EXTENT,!1)}getExtent(){return this._getUpdateFlag(e._UPDATE_EXTENT)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(e._UPDATE_EXTENT,!1)),this._extent}_getUpdateFlag(e){return 0!=(this._updateFlag&e)}_setUpdateFlag(e,t){t?this._updateFlag|=e:this._updateFlag&=~e}_getCenter(e,t,r){a.add(e,t,r),a.scale(r,.5,r)}_getExtent(e,t,r){a.subtract(t,e,r),a.scale(r,.5,r)}_getMin(e,t,r){a.subtract(e,t,r)}_getMax(e,t,r){a.add(e,t,r)}_rotateExtents(e,t,r){var i=e.x,n=e.y,a=e.z,s=t.elements;r.x=Math.abs(s[0]*i)+Math.abs(s[4]*n)+Math.abs(s[8]*a),r.y=Math.abs(s[1]*i)+Math.abs(s[5]*n)+Math.abs(s[9]*a),r.z=Math.abs(s[2]*i)+Math.abs(s[6]*n)+Math.abs(s[10]*a)}_tranform(e,t){var r=t._center,i=t._extent;a.transformCoordinate(this.getCenter(),e,r),this._rotateExtents(this.getExtent(),e,i),t._boundBox.setCenterAndExtent(r,i),t._updateFlag=0}_getBoundBox(){if(this._updateFlag&e._UPDATE_MIN){var t=this._boundBox.min;this._getMin(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(e._UPDATE_MIN,!1)}if(this._updateFlag&e._UPDATE_MAX){var r=this._boundBox.max;this._getMax(this.getCenter(),this.getExtent(),r),this._setUpdateFlag(e._UPDATE_MAX,!1)}return this._boundBox}cloneTo(e){var t=e;this.getMin().cloneTo(t._boundBox.min),this.getMax().cloneTo(t._boundBox.max),this.getCenter().cloneTo(t._center),this.getExtent().cloneTo(t._extent),t._updateFlag=0}clone(){var t=new e(new a,new a);return this.cloneTo(t),t}}return e._UPDATE_MIN=1,e._UPDATE_MAX=2,e._UPDATE_CENTER=4,e._UPDATE_EXTENT=8,e})(),kt=(()=>{class e{constructor(){this._destroyed=!1}get destroyed(){return this._destroyed}_getType(){throw"GeometryElement:must override it."}_prepareRender(e){return!0}_render(e){throw"GeometryElement:must override it."}destroy(){this._destroyed||(this._destroyed=!0)}}return e._typeCounter=0,e})();class Xt{constructor(){}static get vertexDeclaration(){return Xt._vertexDeclaration}static __init__(){Xt._vertexDeclaration=new lt(28,[new _t(0,ot.Vector3,ht.MESH_POSITION0),new _t(12,ot.Vector4,ht.MESH_COLOR0)])}get vertexDeclaration(){return Xt._vertexDeclaration}}let Yt=(()=>{class e extends kt{constructor(r,i){super(),this._floatCountPerVertices=7,this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE,this._bufferState=new nt,this._floatBound=new Float32Array(6),this._calculateBound=!1,this._maxLineCount=0,this._lineCount=0;var n=2*i;this._owner=r,this._maxLineCount=i,this._vertices=new Float32Array(n*this._floatCountPerVertices),this._vertexBuffer=new ct(Xt.vertexDeclaration.vertexStride*n,t.LayaGL.instance.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=Xt.vertexDeclaration,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind();var a=e._tempVector0,s=e._tempVector1;a.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._bounds=new Wt(a,s)}_getType(){return e._type}_resizeLineData(e){var r=2*e,i=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=e;var n=r*this._floatCountPerVertices;this._vertices=new Float32Array(n),this._vertexBuffer=new ct(Xt.vertexDeclaration.vertexStride*r,t.LayaGL.instance.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=Xt.vertexDeclaration,n<i.length?(this._vertices.set(new Float32Array(i.buffer,0,n)),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*n)):(this._vertices.set(i),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*i.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()}_updateLineVertices(e,t,r,i,n){t&&(this._vertices[e+0]=t.x,this._vertices[e+1]=t.y,this._vertices[e+2]=t.z),i&&(this._vertices[e+3]=i.r,this._vertices[e+4]=i.g,this._vertices[e+5]=i.b,this._vertices[e+6]=i.a),r&&(this._vertices[e+7]=r.x,this._vertices[e+8]=r.y,this._vertices[e+9]=r.z),n&&(this._vertices[e+10]=n.r,this._vertices[e+11]=n.g,this._vertices[e+12]=n.b,this._vertices[e+13]=n.a),this._minUpdate=Math.min(this._minUpdate,e),this._maxUpdate=Math.max(this._maxUpdate,e+2*this._floatCountPerVertices);var s=this._bounds,o=this._floatBound,l=s.getMin(),_=s.getMax();a.min(l,t,l),a.min(l,r,l),a.max(_,t,_),a.max(_,r,_),s.setMin(l),s.setMax(_),o[0]=l.x,o[1]=l.y,o[2]=l.z,o[3]=_.x,o[4]=_.y,o[5]=_.z}_reCalculateBound(){if(this._calculateBound){var t=this._vertices,r=e._tempVector0,i=e._tempVector1;r.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var n=0;n<2*this._lineCount;++n){var a=this._floatCountPerVertices*n,s=t[a+0],o=t[a+1],l=t[a+2];r.x=Math.min(s,r.x),r.y=Math.min(o,r.y),r.z=Math.min(l,r.z),i.x=Math.max(s,i.x),i.y=Math.max(o,i.y),i.z=Math.max(l,i.z)}this._bounds.setMin(r),this._bounds.setMax(i);var _=this._floatBound;_[0]=r.x,_[1]=r.y,_[2]=r.z,_[3]=i.x,_[4]=i.y,_[5]=i.z,this._calculateBound=!1}}_removeLineData(e){var t=2*this._floatCountPerVertices,r=e+1,i=e*t,n=this._vertices,a=new Float32Array(n.buffer,r*t*4,(this._lineCount-r)*t);n.set(a,i),this._minUpdate=Math.min(this._minUpdate,i),this._maxUpdate=Math.max(this._maxUpdate,i+a.length),this._lineCount--;var s=this._floatBound,o=n[i],l=n[i+1],_=n[i+2],h=n[i+7],c=n[i+8],d=n[i+9],u=s[0],m=s[1],f=s[2],T=s[3],E=s[4],p=s[5];o!==u&&o!==T&&l!==m&&l!==E&&_!==f&&_!==p&&h!==u&&h!==T&&c!==m&&c!==E&&d!==f&&d!==p||(this._calculateBound=!0)}_updateLineData(e,t,r,i,n){var a=2*this._floatCountPerVertices;this._updateLineVertices(e*a,t,r,i,n)}_updateLineDatas(e,t){for(var r=2*this._floatCountPerVertices,i=t.length,n=0;n<i;n++){var a=t[n];this._updateLineVertices((e+n)*r,a.startPosition,a.endPosition,a.startColor,a.endColor)}}_getLineData(e,t){var r=t.startPosition,i=t.startColor,n=t.endPosition,a=t.endColor,s=this._vertices,o=e*this._floatCountPerVertices*2;r.x=s[o+0],r.y=s[o+1],r.z=s[o+2],i.r=s[o+3],i.g=s[o+4],i.b=s[o+5],i.a=s[o+6],n.x=s[o+7],n.y=s[o+8],n.z=s[o+9],a.r=s[o+10],a.g=s[o+11],a.b=s[o+12],a.a=s[o+13]}_prepareRender(e){return!0}_render(e){if(this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices.buffer,4*this._minUpdate,4*this._minUpdate,4*(this._maxUpdate-this._minUpdate)),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),this._lineCount>0){this._bufferState.bind();var r=t.LayaGL.instance;r.drawArrays(r.LINES,0,2*this._lineCount),t.Stat.renderBatches++}}destroy(){this._destroyed||(super.destroy(),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)}}return e._tempVector0=new a,e._tempVector1=new a,e._type=kt._typeCounter++,e})(),jt=(()=>{class e extends ft{constructor(e){super(e)}static __init__(){e.SHADERDEFINE_RECEIVE_SHADOW=Ae.getDefineByName("RECEIVESHADOW"),e.SAHDERDEFINE_LIGHTMAP=Ae.getDefineByName("LIGHTMAP"),e.SHADERDEFINE_LIGHTMAP_DIRECTIONAL=Ae.getDefineByName("LIGHTMAP_DIRECTIONAL")}_onInActive(){super._onInActive(),this._scene._removeRenderObject(this._render)}_onActive(){super._onActive(),this._scene._addRenderObject(this._render)}_onActiveInScene(){if(super._onActiveInScene(),l.Laya3D._editerEnvironment){var t=this._scene,r=new n;t._allotPickColorByID(this.id,r),t._pickIdToSprite[this.id]=this,this._render._shaderValues.setVector(e.PICKCOLOR,r)}}_addToInitStaticBatchManager(){}_setBelongScene(e){super._setBelongScene(e),this._render._setBelongScene(e)}_setUnBelongScene(){this._render._shaderValues.removeDefine(e.SAHDERDEFINE_LIGHTMAP),super._setUnBelongScene()}_changeHierarchyAnimator(e){if(this._hierarchyAnimator){var t=this._hierarchyAnimator._renderableSprites;t.splice(t.indexOf(this),1)}e&&e._renderableSprites.push(this),super._changeHierarchyAnimator(e)}destroy(e=!0){super.destroy(e),this._render._destroy(),this._render=null}_create(){return new e(this.name)}}return e.LIGHTMAPSCALEOFFSET=Ae.propertyNameToID("u_LightmapScaleOffset"),e.LIGHTMAP=Ae.propertyNameToID("u_LightMap"),e.LIGHTMAP_DIRECTION=Ae.propertyNameToID("u_LightMapDirection"),e.PICKCOLOR=Ae.propertyNameToID("u_PickColor"),e})();class Zt{constructor(){this.updateMark=-1,this.indexInList=-1,this.batched=!1}}class qt extends kt{constructor(){super(),this.maxInstanceCount=1024,this.instanceWorldMatrixData=new Float32Array(16*this.maxInstanceCount),this.instanceMVPMatrixData=new Float32Array(16*this.maxInstanceCount);var e=t.LayaGL.instance;this.instanceWorldMatrixBuffer=new ct(4*this.instanceWorldMatrixData.length,e.DYNAMIC_DRAW),this.instanceMVPMatrixBuffer=new ct(4*this.instanceMVPMatrixData.length,e.DYNAMIC_DRAW),this.instanceWorldMatrixBuffer.vertexDeclaration=ht.instanceWorldMatrixDeclaration,this.instanceMVPMatrixBuffer.vertexDeclaration=ht.instanceMVPMatrixDeclaration}static __init__(){qt.instance=new qt}_render(e){var r=t.LayaGL.instance,i=e.renderElement,n=i.instanceSubMesh,a=i.instanceBatchElementList.length,s=n._indexCount;n._mesh._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(r.TRIANGLES,s,r.UNSIGNED_SHORT,2*n._indexStart,a),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=a-1,t.Stat.trianglesFaces+=s*a/3}}let Qt=(()=>{class e{constructor(){this.renderSubShader=null,this.renderType=e.RENDERTYPE_NORMAL}getInvertFront(){return this._transform._isFrontFaceInvert}setTransform(e){this._transform=e}setGeometry(e){this._geometry=e}addToOpaqueRenderQueue(e,t){t.elements.add(this)}addToTransparentRenderQueue(e,t){t.elements.add(this),t.lastTransparentBatched=!1,t.lastTransparentRenderElement=this}_update(e,t,r,i){if(this.material){var n=this.material._shader.getSubShaderAt(0);if(this.renderSubShader=null,r)if(i){var a=n.getFlag(i);if(!a)return;for(var s=r._subShaders,o=0,l=s.length;o<l;o++){var _=s[o];if(a===_.getFlag(i)){this.renderSubShader=_;break}}if(!this.renderSubShader)return}else this.renderSubShader=r.getSubShaderAt(0);else this.renderSubShader=n;var h=e._getRenderQueue(this.material.renderQueue);h.isTransparent?this.addToTransparentRenderQueue(t,h):this.addToOpaqueRenderQueue(t,h)}}_render(t){var r,i,n,a=t.invertY,s=Nt._updateMark,o=t.scene,l=t.cameraShaderValue,_=this._transform,h=this._geometry;t.renderElement=this;var c=s!==this.render._updateMark||this.renderType!==this.render._updateRenderType;c?(this.render._renderUpdate(t,_),this.render._renderUpdateWithCamera(t,_),this.render._updateMark=s,this.render._updateRenderType=this.renderType):this.renderType==e.RENDERTYPE_INSTANCEBATCH&&(this.render._renderUpdate(t,_),this.render._renderUpdateWithCamera(t,_));var d=t.pipelineMode;if(h._prepareRender(t))for(var u=this.renderSubShader._passes,m=0,f=u.length;m<f;m++){var T=u[m];if(T._pipelineMode===d){var E=e._compileDefine;o._shaderValues._defineDatas.cloneTo(E),E.addDefineDatas(this.render._shaderValues._defineDatas),E.addDefineDatas(this.material._shaderValues._defineDatas);var p=t.shader=T.withCompile(E),g=p.bind(),S=s!==p._uploadMark,R=p._uploadScene!==o||S;(R||g)&&(p.uploadUniforms(p._sceneUniformParamsMap,o._shaderValues,R),p._uploadScene=o);var v=p._uploadRender!==this.render||p._uploadRenderType!==this.renderType||S;(v||g)&&(p.uploadUniforms(p._spriteUniformParamsMap,this.render._shaderValues,v),p._uploadRender=this.render,p._uploadRenderType=this.renderType);var A=p._uploadCameraShaderValue!==l||S;(A||g)&&(p.uploadUniforms(p._cameraUniformParamsMap,l,A),p._uploadCameraShaderValue=l);var I=p._uploadMaterial!==this.material||S;(I||g)&&(p.uploadUniforms(p._materialUniformParamsMap,this.material._shaderValues,I),p._uploadMaterial=this.material);var x=this.material._shaderValues;r!==this.material||i!==p?(p.uploadRenderStateBlendDepth(x),p.uploadRenderStateFrontFace(x,a,this.getInvertFront()),r=this.material,i=p,n=this.render):n!==this.render&&(p.uploadRenderStateFrontFace(x,a,this.getInvertFront()),n=this.render),h._render(t),p._uploadMark=s}}c&&this.renderType!==e.RENDERTYPE_NORMAL&&this.render._revertBatchRenderUpdate(t)}destroy(){this._transform=null,this._geometry=null,this.material=null,this.render=null}}return e.RENDERTYPE_NORMAL=0,e.RENDERTYPE_STATICBATCH=1,e.RENDERTYPE_INSTANCEBATCH=2,e.RENDERTYPE_VERTEXBATCH=3,e._compileDefine=new ge,e})();class Kt extends Qt{constructor(){super(),this._dynamicWorldPositionNormalNeedUpdate=!0}_onWorldMatrixChanged(){this._dynamicWorldPositionNormalNeedUpdate=!0}_computeWorldPositionsAndNormals(e,t,r,i){if(this._dynamicWorldPositionNormalNeedUpdate){for(var n=this._geometry,a=n._vertexBuffer,s=a.vertexDeclaration.vertexStride/4,o=a.getFloat32Data(),l=this._transform.worldMatrix,_=this._transform.rotation,h=n._indices,c=0;c<i;c++){var d=(r?h[c]:c)*s,u=3*c;k.transformVector3ArrayToVector3ArrayCoordinate(o,d+e,l,this._dynamicWorldPositions,u),-1!==t&&k.transformVector3ArrayByQuat(o,d+t,_,this._dynamicWorldNormals,u)}this._dynamicWorldPositionNormalNeedUpdate=!1}}setTransform(e){this._transform!==e&&(this._transform&&this._transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),e&&e.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=e)}setGeometry(e){if(this._geometry!==e){var t=e,r=t._mesh;if(r){var i=r._subMeshes.length>1,n=i?t._indexCount:r._vertexCount;if(n<=l.SubMeshDynamicBatch.maxAllowVertexCount){var a=3*n;this._dynamicVertexBatch=!0,this._dynamicWorldPositions=new Float32Array(a),this._dynamicWorldNormals=new Float32Array(a),this._dynamicVertexCount=n,this._dynamicMultiSubMesh=i}else this._dynamicVertexBatch=!1}this._geometry=e}}addToOpaqueRenderQueue(e,r){var i=this.staticBatch,n=r.elements,a=n.elements;if(i){var s=l.MeshRenderStaticBatchManager.instance,o=s.getBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,i._batchID);if(s._updateCountMark===o.updateMark){var _=o.indexInList;if(o.batched)a[_].staticBatchElementList.add(this);else{var h=a[_],c=h.render,d=s._getBatchRenderElementFromPool();d.renderType=Qt.RENDERTYPE_STATICBATCH,d.setGeometry(i),d.material=h.material;var u=i.batchOwner,m=u?u._transform:null;d.setTransform(m),d.render=c,d.renderSubShader=h.renderSubShader;var f=d.staticBatchElementList;f.length=0,f.add(h),f.add(this),a[_]=d,o.batched=!0}}else o.updateMark=s._updateCountMark,o.indexInList=n.length,o.batched=!1,n.add(this)}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0){var T=this._geometry,E=l.MeshRenderDynamicBatchManager.instance,p=E.getInstanceBatchOpaquaMark(this.render.receiveShadow,this.material.id,T._id,this._transform._isFrontFaceInvert);if(E._updateCountMark===p.updateMark){var g=p.indexInList;if(p.batched){var S=a[g].instanceBatchElementList;S.length===qt.instance.maxInstanceCount?(p.updateMark=E._updateCountMark,p.indexInList=n.length,p.batched=!1,n.add(this)):S.add(this)}else{var R=a[g],v=R.render,A=E._getBatchRenderElementFromPool();A.renderType=Qt.RENDERTYPE_INSTANCEBATCH,A.setGeometry(qt.instance),A.material=R.material,A.setTransform(null),A.render=v,A.instanceSubMesh=T,A.renderSubShader=R.renderSubShader;var I=A.instanceBatchElementList;I.length=0,I.add(R),I.add(this),a[g]=A,p.batched=!0}}else p.updateMark=E._updateCountMark,p.indexInList=n.length,p.batched=!1,n.add(this)}else if(this._dynamicVertexBatch){var x=this._geometry._vertexBuffer.vertexDeclaration,C=l.MeshRenderDynamicBatchManager.instance,L=C.getVertexBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,x.id);if(C._updateCountMark===L.updateMark){var y=L.indexInList;if(L.batched)a[y].vertexBatchElementList.add(this);else{var D=a[y],M=D.render,O=C._getBatchRenderElementFromPool();O.renderType=Qt.RENDERTYPE_VERTEXBATCH,O.setGeometry(l.SubMeshDynamicBatch.instance),O.material=D.material,O.setTransform(null),O.render=M,O.vertexBatchVertexDeclaration=x,O.renderSubShader=D.renderSubShader;var N=O.vertexBatchElementList;N.length=0,N.add(D),N.add(this),a[y]=O,L.batched=!0}}else L.updateMark=C._updateCountMark,L.indexInList=n.length,L.batched=!1,n.add(this)}else n.add(this)}addToTransparentRenderQueue(e,r){var i=this.staticBatch,n=r.elements,a=n.elements;if(i){var s=l.MeshRenderStaticBatchManager.instance,o=r.lastTransparentRenderElement;if(o){var _=o.render;if(o._geometry._getType()!==this._geometry._getType()||o.staticBatch!==i||o.material!==this.material||_.receiveShadow!==this.render.receiveShadow||_.lightmapIndex!==this.render.lightmapIndex)n.add(this),r.lastTransparentBatched=!1;else{if(r.lastTransparentBatched)a[n.length-1].staticBatchElementList.add(this);else{var h=s._getBatchRenderElementFromPool();h.renderType=Qt.RENDERTYPE_STATICBATCH,h.setGeometry(i),h.material=o.material;var c=i.batchOwner,d=c?c._transform:null;h.setTransform(d),h.render=this.render,h.renderSubShader=o.renderSubShader;var u=h.staticBatchElementList;u.length=0,u.add(o),u.add(this),a[n.length-1]=h}r.lastTransparentBatched=!0}}else n.add(this),r.lastTransparentBatched=!1}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0){var m=this._geometry,f=l.MeshRenderDynamicBatchManager.instance,T=r.lastTransparentRenderElement;if(T){var E=T.render;if(T._geometry._getType()!==this._geometry._getType()||T._geometry!==m||T.material!==this.material||E.receiveShadow!==this.render.receiveShadow)n.add(this),r.lastTransparentBatched=!1;else if(r.lastTransparentBatched){var p=a[n.length-1].instanceBatchElementList;p.length===qt.instance.maxInstanceCount?(n.add(this),r.lastTransparentBatched=!1):(p.add(this),r.lastTransparentBatched=!0)}else{var g=f._getBatchRenderElementFromPool();g.renderType=Qt.RENDERTYPE_INSTANCEBATCH,g.setGeometry(qt.instance),g.material=T.material,g.setTransform(null),g.render=this.render,g.instanceSubMesh=m,g.renderSubShader=T.renderSubShader;var S=g.instanceBatchElementList;S.length=0,S.add(T),S.add(this),a[n.length-1]=g,r.lastTransparentBatched=!0}}else n.add(this),r.lastTransparentBatched=!1}else if(this._dynamicVertexBatch){var R=this._geometry._vertexBuffer.vertexDeclaration,v=l.MeshRenderDynamicBatchManager.instance,A=r.lastTransparentRenderElement;if(A){var I=A.render;if(A._geometry._getType()!==this._geometry._getType()||A._geometry._vertexBuffer._vertexDeclaration!==R||A.material!==this.material||I.receiveShadow!==this.render.receiveShadow||I.lightmapIndex!==this.render.lightmapIndex)n.add(this),r.lastTransparentBatched=!1;else{if(r.lastTransparentBatched)a[n.length-1].vertexBatchElementList.add(this);else{var x=v._getBatchRenderElementFromPool();x.renderType=Qt.RENDERTYPE_VERTEXBATCH,x.setGeometry(l.SubMeshDynamicBatch.instance),x.material=A.material,x.setTransform(null),x.render=this.render,x.vertexBatchVertexDeclaration=R,x.renderSubShader=A.renderSubShader;var C=x.vertexBatchElementList;C.length=0,C.add(A),C.add(this),a[n.length-1]=x}r.lastTransparentBatched=!0}}else n.add(this),r.lastTransparentBatched=!1}else n.add(this);r.lastTransparentRenderElement=this}getInvertFront(){switch(this.renderType){case Qt.RENDERTYPE_NORMAL:return this._transform._isFrontFaceInvert;case Qt.RENDERTYPE_STATICBATCH:case Qt.RENDERTYPE_VERTEXBATCH:return!1;case Qt.RENDERTYPE_INSTANCEBATCH:return this.instanceBatchElementList.elements[0]._transform._isFrontFaceInvert;default:throw"SubMeshRenderElement: unknown renderType"}}destroy(){super.destroy(),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.staticBatch=null,this.staticBatchElementList=null,this.vertexBatchElementList=null,this.vertexBatchVertexDeclaration=null}}let Jt=(()=>{class e{constructor(){this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[]}static _addToStaticBatchQueue(t,r){t instanceof jt&&r.push(t);for(var i=0,n=t.numChildren;i<n;i++)e._addToStaticBatchQueue(t._children[i],r)}static _registerManager(t){e._managers.push(t)}static combine(t,r=null){r||(r=[],t&&e._addToStaticBatchQueue(t,r));var i=r.length;if(i>0){for(var n=0;n<i;n++){var a=r[n];a.destroyed||(a._render._isPartOfStaticBatch?console.warn("StaticBatchManager: Sprite "+a.name+" has a part of Static Batch,it will be ignore."):a._addToInitStaticBatchManager())}for(var s=0,o=e._managers.length;s<o;s++){e._managers[s]._initStaticBatchs(t)}}}_partition(e,t,r){for(var i=e[Math.floor((r+t)/2)];t<=r;){for(;this._compare(e[t],i)<0;)t++;for(;this._compare(e[r],i)>0;)r--;if(t<r){var n=e[t];e[t]=e[r],e[r]=n,t++,r--}else if(t===r){t++;break}}return t}_quickSort(e,t,r){if(e.length>1){var i=this._partition(e,t,r),n=i-1;t<n&&this._quickSort(e,t,n),i<r&&this._quickSort(e,i,r)}}_compare(e,t){throw"StaticBatch:must override this function."}_initStaticBatchs(e){throw"StaticBatch:must override this function."}_getBatchRenderElementFromPool(){throw"StaticBatch:must override this function."}_addBatchSprite(e){this._initBatchSprites.push(e)}_clear(){this._batchRenderElementPoolIndex=0}_garbageCollection(){throw"StaticBatchManager: must override it."}dispose(){this._staticBatches=null}}return e._managers=[],e})(),$t=(()=>{class r extends kt{constructor(e,t){super(),this._bufferState=new nt,this._batchID=r._batchIDCounter++,this._batchElements=[],this._currentBatchVertexCount=0,this._currentBatchIndexCount=0,this._vertexDeclaration=t,this.batchOwner=e}_getStaticBatchBakedVertexs(e,t,i,n,a,s){var o,l=s._vertexBuffer,_=l.vertexDeclaration,c=_.getVertexElementByUsage(ht.MESH_POSITION0)._offset/4,d=_.getVertexElementByUsage(ht.MESH_NORMAL0),u=d?d._offset/4:-1,m=_.getVertexElementByUsage(ht.MESH_COLOR0),f=m?m._offset/4:-1,T=_.getVertexElementByUsage(ht.MESH_TEXTURECOORDINATE0),E=T?T._offset/4:-1,p=_.getVertexElementByUsage(ht.MESH_TEXTURECOORDINATE1),g=p?p._offset/4:-1,S=_.getVertexElementByUsage(ht.MESH_TANGENT0),R=S?S._offset/4:-1,v=_.vertexStride/4,A=l.getFloat32Data();i?(i.worldMatrix.invert(r._tempMatrix4x40),o=r._tempMatrix4x41,h.multiply(r._tempMatrix4x40,n.worldMatrix,o)):o=n.worldMatrix;var I=r._tempMatrix4x42;o.invert(I),I.transpose();var x=r._tempQuaternion0;o.decomposeTransRotScale(r._tempVector30,x,r._tempVector31);for(var C=a.lightmapScaleOffset,L=s.vertexCount,y=0;y<L;y++){var D,M,O=y*v,N=18*(y+t);k.transformVector3ArrayToVector3ArrayCoordinate(A,O+c,o,e,N+0),-1!==u&&k.transformVector3ArrayToVector3ArrayNormal(A,O+u,I,e,N+3);var b=N+6;if(-1!==f){var P=O+f;for(D=0,M=4;D<M;D++)e[b+D]=A[P+D]}else for(D=0,M=4;D<M;D++)e[b+D]=1;if(-1!==E){var w=O+E;e[N+10]=A[w],e[N+11]=A[w+1]}if(C&&(-1!==g?k.transformLightingMapTexcoordArray(A,O+g,C,e,N+12):k.transformLightingMapTexcoordArray(A,O+E,C,e,N+12)),-1!==R){var V=O+R;e[N+14]=A[V],e[N+15]=A[V+1],e[N+16]=A[V+2],e[N+17]=A[V+3]}}return L}addTest(e){var t=e.meshFilter.sharedMesh.vertexCount;return!(this._currentBatchVertexCount+t>r.maxBatchVertexCount)}add(e){var t=e.meshFilter.sharedMesh,r=t.vertexCount;this._batchElements.push(e);var i=e._render;i._isPartOfStaticBatch=!0,i._staticBatch=this;for(var n=i._renderElements,a=0,s=n.length;a<s;a++)n[a].staticBatch=this;this._currentBatchIndexCount+=t._indexBuffer.indexCount,this._currentBatchVertexCount+=r}remove(e){var t=e.meshFilter.sharedMesh,r=this._batchElements.indexOf(e);if(-1!==r){this._batchElements.splice(r,1);for(var i=e._render._renderElements,n=0,a=i.length;n<a;n++)i[n].staticBatch=null;this._currentBatchIndexCount=this._currentBatchIndexCount-t._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-t.vertexCount,e._render._isPartOfStaticBatch=!1}}finishInit(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addGPUMemory(-(this._vertexBuffer._byteLength+this._indexBuffer._byteLength)));var r=t.LayaGL.instance,i=0,n=0,a=this.batchOwner,s=this._vertexDeclaration.vertexStride/4,o=new Float32Array(s*this._currentBatchVertexCount),l=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new ct(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,r.STATIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new st(e.IndexFormat.UInt16,this._currentBatchIndexCount,r.STATIC_DRAW);for(var _=0,h=this._batchElements.length;_<h;_++){for(var c,d=this._batchElements[_],u=d.meshFilter.sharedMesh,m=this._getStaticBatchBakedVertexs(o,i,a?a._transform:null,d._transform,d._render,u),f=u._indexBuffer.getData(),T=i,E=n+f.length,p=d._render._renderElements,g=0,S=u.subMeshCount;g<S;g++){var R=u._subMeshes[g],v=n+R._indexStart,A=p[g];A.staticBatchIndexStart=v,A.staticBatchIndexEnd=v+R._indexCount}if(l.set(f,n),a?d._transform._isFrontFaceInvert!==a.transform._isFrontFaceInvert:d._transform._isFrontFaceInvert)for(c=n;c<E;c+=3){l[c]=T+l[c];var I=l[c+1],x=l[c+2];l[c+1]=T+x,l[c+2]=T+I}else for(c=n;c<E;c+=3)l[c]=T+l[c],l[c+1]=T+l[c+1],l[c+2]=T+l[c+2];n+=f.length,i+=m}this._vertexBuffer.setData(o.buffer),this._indexBuffer.setData(l);var C=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(C),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}_render(e){this._bufferState.bind();for(var r=t.LayaGL.instance,i=e.renderElement.staticBatchElementList,n=i.elements,a=0,s=0,o=i.length,l=1;l<o;l++){if(n[l-1].staticBatchIndexEnd!==n[l].staticBatchIndexStart){var _=n[a].staticBatchIndexStart,h=n[s].staticBatchIndexEnd-_;r.drawElements(r.TRIANGLES,h,r.UNSIGNED_SHORT,2*_),a=++s,t.Stat.trianglesFaces+=h/3}else s++}_=n[a].staticBatchIndexStart,h=n[s].staticBatchIndexEnd-_,r.drawElements(r.TRIANGLES,h,r.UNSIGNED_SHORT,2*_),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=o-1,t.Stat.trianglesFaces+=h/3}dispose(){var e=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(-e),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null}}return r._tempVector30=new a,r._tempVector31=new a,r._tempQuaternion0=new _,r._tempMatrix4x40=new h,r._tempMatrix4x41=new h,r._tempMatrix4x42=new h,r.maxBatchVertexCount=65535,r._batchIDCounter=0,r})(),er=(()=>{class e extends Jt{constructor(){super(),this._opaqueBatchMarks=[],this._updateCountMark=0}static __init__(){e._verDec=ht.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT")}_compare(e,t){var r=e._render,i=t._render,n=e.meshFilter.sharedMesh,a=t.meshFilter.sharedMesh,s=r.lightmapIndex-i.lightmapIndex;if(0===s){var o=(r.receiveShadow?1:0)-(i.receiveShadow?1:0);if(0===o){var l=r.sharedMaterial&&i.sharedMaterial?r.sharedMaterial.id-i.sharedMaterial.id:0;if(0===l){var _=n._vertexBuffer.vertexDeclaration.id-a._vertexBuffer.vertexDeclaration.id;return 0===_?a._indexBuffer.indexCount-n._indexBuffer.indexCount:_}return l}return o}return s}_getBatchRenderElementFromPool(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new Kt,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.staticBatchElementList=new E),e}_getStaticBatch(t,r,i){var n=t[i];return n||(n=t[i]=new $t(r,e._verDec),this._staticBatches[n._batchID]=n),n}_initStaticBatchs(e){var t=this._initBatchSprites;this._quickSort(t,0,t.length-1);for(var r,i=[],n=!1,a=0,s=0,o=t.length;s<o;s++){var l=t[s];if(n)r.addTest(l)?r.add(l):(n=!1,a++);else s!==o-1&&((r=this._getStaticBatch(i,e,a)).add(l),n=!0)}for(s=0,o=i.length;s<o;s++){var _=i[s];_&&_.finishInit()}this._initBatchSprites.length=0}_removeRenderSprite(e){var t=e._render,r=t._staticBatch,i=r._batchElements,n=i.indexOf(e);if(-1!==n){i.splice(n,1),t._staticBatch=null;for(var a=t._renderElements,s=0,o=a.length;s<o;s++)a[s].staticBatch=null}0===i.length&&(delete this._staticBatches[r._batchID],r.dispose())}_clear(){super._clear(),this._updateCountMark++}_garbageCollection(){for(var e in this._staticBatches){var t=this._staticBatches[e];0===t._batchElements.length&&(t.dispose(),delete this._staticBatches[e])}}getBatchOpaquaMark(e,t,r,i){var n=t?1:0,a=this._opaqueBatchMarks[e]||(this._opaqueBatchMarks[e]=[]),s=a[n]||(a[n]=[]),o=s[r]||(s[r]=[]);return o[i]||(o[i]=new Zt)}}return e.instance=new e,e})(),tr=(()=>{class e extends t.EventDispatcher{constructor(r){if(super(),this._lightmapScaleOffset=new n(1,1,0,0),this._indexInList=-1,this._indexInCastShadowList=-1,this._boundsChange=!0,this._castShadow=!1,this._supportOctree=!0,this._sharedMaterials=[],this._renderMark=-1,this._indexInOctreeMotionList=-1,this._updateMark=-1,this._updateRenderType=-1,this._isPartOfStaticBatch=!1,this._staticBatch=null,this._id=++e._uniqueIDCounter,this._indexInCastShadowList=-1,this._bounds=new Wt(a._ZERO,a._ZERO),t.Render.supportWebGLPlusCulling){var i=We._cullingBufferLength;this._cullingBufferIndex=i;var s=We._cullingBuffer,o=i+7;if(o>=s.length){var l=s;(s=We._cullingBuffer=new Float32Array(s.length+4096)).set(l,0)}s[i]=2,We._cullingBufferLength=o}this._renderElements=[],this._owner=r,this._enable=!0,this._materialsInstance=[],this._shaderValues=new Ie(null),this.lightmapIndex=-1,this.receiveShadow=!1,this.sortingFudge=0,r&&this._owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange)}get id(){return this._id}get lightmapIndex(){return this._lightmapIndex}set lightmapIndex(e){this._lightmapIndex=e}get lightmapScaleOffset(){return this._lightmapScaleOffset}set lightmapScaleOffset(e){if(!e)throw"BaseRender: lightmapScaleOffset can't be null.";this._lightmapScaleOffset=e,this._shaderValues.setVector(jt.LIGHTMAPSCALEOFFSET,e)}get enable(){return this._enable}set enable(e){this._enable=!!e}get material(){var e=this._sharedMaterials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0),r=this._renderElements[0];r&&(r.material=t)}return this._sharedMaterials[0]}set material(e){this.sharedMaterial=e}get materials(){for(var e=0,t=this._sharedMaterials.length;e<t;e++)if(!this._materialsInstance[e]){var r=this._getInstanceMaterial(this._sharedMaterials[e],e),i=this._renderElements[e];i&&(i.material=r)}return this._sharedMaterials.slice()}set materials(e){this.sharedMaterials=e}get sharedMaterial(){return this._sharedMaterials[0]}set sharedMaterial(e){var t=this._sharedMaterials[0];if(t!==e){this._sharedMaterials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e);var r=this._renderElements[0];r&&(r.material=e)}}get sharedMaterials(){return this._sharedMaterials.slice()}set sharedMaterials(e){for(var t=this._materialsInstance,r=this._sharedMaterials,i=0,n=r.length;i<n;i++){var a=r[i];a&&a._removeReference()}if(!e)throw new Error("BaseRender: shadredMaterials value can't be null.");var s=e.length;for(t.length=s,r.length=s,i=0;i<s;i++){a=r[i];var o=e[i];if(a!==o){t[i]=!1;var l=this._renderElements[i];l&&(l.material=o)}o&&o._addReference(),r[i]=o}}get bounds(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._shaderValues.addDefine(jt.SHADERDEFINE_RECEIVE_SHADOW):this._shaderValues.removeDefine(jt.SHADERDEFINE_RECEIVE_SHADOW))}get receiveShadow(){return this._receiveShadow}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e}get isPartOfStaticBatch(){return this._isPartOfStaticBatch}get isRender(){return-1==this._renderMark||this._renderMark==t.Stat.loopCount-1}_getOctreeNode(){return this._octreeNode}_setOctreeNode(e){this._octreeNode=e}_getIndexInMotionList(){return this._indexInOctreeMotionList}_setIndexInMotionList(e){this._indexInOctreeMotionList=e}_changeMaterialReference(e,t){e&&e._removeReference(),t._addReference()}_getInstanceMaterial(e,t){var r=e.clone();return r.name=r.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._sharedMaterials[t],r),this._sharedMaterials[t]=r,r}_applyLightMapParams(){var e=this._scene.lightmaps,t=this._shaderValues,r=this._lightmapIndex;if(r>=0&&r<e.length){var i=e[r];t.setTexture(jt.LIGHTMAP,i.lightmapColor),t.addDefine(jt.SAHDERDEFINE_LIGHTMAP),i.lightmapDirection?(t.setTexture(jt.LIGHTMAP_DIRECTION,i.lightmapDirection),t.addDefine(jt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):t.removeDefine(jt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}else t.removeDefine(jt.SAHDERDEFINE_LIGHTMAP),t.removeDefine(jt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}_onWorldMatNeedChange(e){this._boundsChange=!0,this._octreeNode&&(e&=d.TRANSFORM_WORLDPOSITION|d.TRANSFORM_WORLDQUATERNION|d.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this)}_calculateBoundingBox(){throw"BaseRender: must override it."}_getIndexInList(){return this._indexInList}_setIndexInList(e){this._indexInList=e}_setBelongScene(e){this._scene=e}_needRender(e,t){return!0}_renderUpdate(e,t){}_renderUpdateWithCamera(e,t){}_revertBatchRenderUpdate(e){}_destroy(){-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e].destroy();for(e=0,t=this._sharedMaterials.length;e<t;e++)this._sharedMaterials[e].destroyed||this._sharedMaterials[e]._removeReference();this._renderElements=null,this._owner=null,this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null}markAsUnStatic(){this._isPartOfStaticBatch&&(er.instance._removeRenderSprite(this._owner),this._isPartOfStaticBatch=!1)}}return e._tempBoundBoxCorners=[new a,new a,new a,new a,new a,new a,new a,new a],e._uniqueIDCounter=0,e._defaultLightmapScaleOffset=new n(1,1,0,0),e})();class rr extends tr{constructor(e){super(e),this._projectionViewWorldMatrix=new h}_calculateBoundingBox(){var e=this._owner.transform.worldMatrix,r=this._owner._geometryFilter;if(r._reCalculateBound(),r._bounds._tranform(e,this._bounds),t.Render.supportWebGLPlusCulling){var i=this._bounds.getMin(),n=this._bounds.getMax(),a=We._cullingBuffer;a[this._cullingBufferIndex+1]=i.x,a[this._cullingBufferIndex+2]=i.y,a[this._cullingBufferIndex+3]=i.z,a[this._cullingBufferIndex+4]=n.x,a[this._cullingBufferIndex+5]=n.y,a[this._cullingBufferIndex+6]=n.z}}_renderUpdateWithCamera(e,t){var r=e.projectionViewMatrix,i=this._shaderValues;if(t){var n=t.worldMatrix;i.setMatrix4x4(ft.WORLDMATRIX,n),h.multiply(r,n,this._projectionViewWorldMatrix),i.setMatrix4x4(ft.MVPMATRIX,this._projectionViewWorldMatrix)}else i.setMatrix4x4(ft.WORLDMATRIX,h.DEFAULT),i.setMatrix4x4(ft.MVPMATRIX,r)}}class ir extends jt{constructor(e=2,t=null){super(t),this._geometryFilter=new Yt(this,e),this._render=new rr(this),this._changeRenderObjects(this._render,0,zt.defaultMaterial)}get maxLineCount(){return this._geometryFilter._maxLineCount}set maxLineCount(e){this._geometryFilter._resizeLineData(e),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,e)}get lineCount(){return this._geometryFilter._lineCount}set lineCount(e){if(e>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=e}get pixelLineRenderer(){return this._render}_changeRenderObjects(e,t,r){var i=this._render._renderElements;r||(r=zt.defaultMaterial);var n=i[t];n||(n=i[t]=new Qt),n.setTransform(this._transform),n.setGeometry(this._geometryFilter),n.render=this._render,n.material=r}addLine(e,t,r,i){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,e,t,r,i)}addLines(e){var t=this._geometryFilter._lineCount,r=e.length;if(t+r>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(t,e),this._geometryFilter._lineCount+=r}removeLine(e){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(e)}setLine(e,t,r,i,n){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(e,t,r,i,n)}getLine(e,t){if(!(e<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(e,t)}clear(){this._geometryFilter._lineCount=0}_create(){return new ir}}class nr{constructor(e=!1){this.isTransparent=!1,this.elements=new E,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1,this.isTransparent=e}_compare(e,t){var r=e.material.renderQueue-t.material.renderQueue;return 0===r?(this.isTransparent?t.render._distanceForSort-e.render._distanceForSort:e.render._distanceForSort-t.render._distanceForSort)+t.render.sortingFudge-e.render.sortingFudge:r}_partitionRenderObject(e,t){for(var r=this.elements.elements,i=r[Math.floor((t+e)/2)];e<=t;){for(;this._compare(r[e],i)<0;)e++;for(;this._compare(r[t],i)>0;)t--;if(e<t){var n=r[e];r[e]=r[t],r[t]=n,e++,t--}else if(e===t){e++;break}}return e}_quickSort(e,t){if(this.elements.length>1){var r=this._partitionRenderObject(e,t),i=r-1;e<i&&this._quickSort(e,i),r<t&&this._quickSort(r,t)}}_render(e){for(var t=this.elements.elements,r=0,i=this.elements.length;r<i;r++)t[r]._render(e)}clear(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1}}let ar=(()=>{class e{constructor(e,t,r,i){this._bounds=new Ht(new a,new a),this._objects=[],this._isContaion=!1,this.center=new a,this.baseLength=0,this._setValues(e,t,r,i)}static _encapsulates(e,t){return $e.boxContainsBox(e,t)==Je.Contains}_setValues(e,t,r,i){this._octree=e,this._parent=t,this.baseLength=r,i.cloneTo(this.center);var n=this._bounds.min,a=this._bounds.max,s=e._looseness*r/2;n.setValue(i.x-s,i.y-s,i.z-s),a.setValue(i.x+s,i.y+s,i.z+s)}_getChildBound(t){if(null!=this._children&&this._children[t])return this._children[t]._bounds;var r=this.baseLength/4,i=this.baseLength/2*this._octree._looseness/2,n=e._tempBoundBox,a=n.min,s=n.max;switch(t){case 0:a.x=this.center.x-r-i,a.y=this.center.y+r-i,a.z=this.center.z-r-i,s.x=this.center.x-r+i,s.y=this.center.y+r+i,s.z=this.center.z-r+i;break;case 1:a.x=this.center.x+r-i,a.y=this.center.y+r-i,a.z=this.center.z-r-i,s.x=this.center.x+r+i,s.y=this.center.y+r+i,s.z=this.center.z-r+i;break;case 2:a.x=this.center.x-r-i,a.y=this.center.y+r-i,a.z=this.center.z+r-i,s.x=this.center.x-r+i,s.y=this.center.y+r+i,s.z=this.center.z+r+i;break;case 3:a.x=this.center.x+r-i,a.y=this.center.y+r-i,a.z=this.center.z+r-i,s.x=this.center.x+r+i,s.y=this.center.y+r+i,s.z=this.center.z+r+i;break;case 4:a.x=this.center.x-r-i,a.y=this.center.y-r-i,a.z=this.center.z-r-i,s.x=this.center.x-r+i,s.y=this.center.y-r+i,s.z=this.center.z-r+i;break;case 5:a.x=this.center.x+r-i,a.y=this.center.y-r-i,a.z=this.center.z-r-i,s.x=this.center.x+r+i,s.y=this.center.y-r+i,s.z=this.center.z-r+i;break;case 6:a.x=this.center.x-r-i,a.y=this.center.y-r-i,a.z=this.center.z+r-i,s.x=this.center.x-r+i,s.y=this.center.y-r+i,s.z=this.center.z+r+i;break;case 7:a.x=this.center.x+r-i,a.y=this.center.y-r-i,a.z=this.center.z+r-i,s.x=this.center.x+r+i,s.y=this.center.y-r+i,s.z=this.center.z+r+i}return n}_getChildCenter(t){if(null!=this._children)return this._children[t].center;var r=this.baseLength/4,i=e._tempVector30;switch(t){case 0:i.x=this.center.x-r,i.y=this.center.y+r,i.z=this.center.z-r;break;case 1:i.x=this.center.x+r,i.y=this.center.y+r,i.z=this.center.z-r;break;case 2:i.x=this.center.x-r,i.y=this.center.y+r,i.z=this.center.z+r;break;case 3:i.x=this.center.x+r,i.y=this.center.y+r,i.z=this.center.z+r;break;case 4:i.x=this.center.x-r,i.y=this.center.y-r,i.z=this.center.z-r;break;case 5:i.x=this.center.x+r,i.y=this.center.y-r,i.z=this.center.z-r;break;case 6:i.x=this.center.x-r,i.y=this.center.y-r,i.z=this.center.z+r;break;case 7:i.x=this.center.x+r,i.y=this.center.y-r,i.z=this.center.z+r}return i}_getChild(t){var r=this.baseLength/4;switch(this._children||(this._children=[]),t){case 0:return this._children[0]||(this._children[0]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+-r,this.center.y+r,this.center.z-r)));case 1:return this._children[1]||(this._children[1]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+r,this.center.y+r,this.center.z-r)));case 2:return this._children[2]||(this._children[2]=new e(this._octree,this,this.baseLength/2,new a(this.center.x-r,this.center.y+r,this.center.z+r)));case 3:return this._children[3]||(this._children[3]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+r,this.center.y+r,this.center.z+r)));case 4:return this._children[4]||(this._children[4]=new e(this._octree,this,this.baseLength/2,new a(this.center.x-r,this.center.y-r,this.center.z-r)));case 5:return this._children[5]||(this._children[5]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+r,this.center.y-r,this.center.z-r)));case 6:return this._children[6]||(this._children[6]=new e(this._octree,this,this.baseLength/2,new a(this.center.x-r,this.center.y-r,this.center.z+r)));case 7:return this._children[7]||(this._children[7]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+r,this.center.y-r,this.center.z+r)));default:throw"BoundsOctreeNode: unknown index."}}_shouldMerge(){for(var t=this._objects.length,r=0;r<8;r++){var i=this._children[r];if(i){if(null!=i._children)return!1;t+=i._objects.length}}return t<=e._NUM_OBJECTS_ALLOWED}_mergeChildren(){for(var e=0;e<8;e++){var t=this._children[e];if(t){t._parent=null;for(var r=t._objects,i=r.length-1;i>=0;i--){var n=r[i];this._objects.push(n),n._setOctreeNode(this)}}}this._children=null}_merge(){if(null===this._children){var e=this._parent;e&&e._shouldMerge()&&(e._mergeChildren(),e._merge())}}_checkAddNode(t){if(null==this._children){if(this._objects.length<e._NUM_OBJECTS_ALLOWED||this.baseLength/2<this._octree._minSize)return this;for(var r=this._objects.length-1;r>=0;r--){var i=this._objects[r],n=this._bestFitChild(i.bounds.getCenter());e._encapsulates(this._getChildBound(n),i.bounds._getBoundBox())&&(this._objects.splice(this._objects.indexOf(i),1),this._getChild(n)._add(i))}}var a=this._bestFitChild(t.bounds.getCenter());return e._encapsulates(this._getChildBound(a),t.bounds._getBoundBox())?this._getChild(a)._checkAddNode(t):this}_add(e){var t=this._checkAddNode(e);t._objects.push(e),e._setOctreeNode(t)}_remove(e){var t=this._objects.indexOf(e);this._objects.splice(t,1),e._setOctreeNode(null),this._merge()}_addUp(e){return $e.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Je.Contains?(this._add(e),!0):!!this._parent&&this._parent._addUp(e)}_getCollidingWithFrustum(e,r,i,n,s,o){var l=e.boundFrustum,_=e.position,h=e.cullingMask;if(i){var c=l.containsBoundBox(this._bounds);if(t.Stat.octreeNodeCulling++,c===Je.Disjoint)return;i=c===Je.Intersects}this._isContaion=!i;for(var d=r.scene,u=t.Stat.loopCount,m=0,f=this._objects.length;m<f;m++){var T=this._objects[m];if(o?T._castShadow&&T._enable:0!=(Math.pow(2,T._owner._layer)&h)&&T._enable){if(i&&(t.Stat.frustumCulling++,!T._needRender(l,r)))continue;T._renderMark=u,T._distanceForSort=a.distance(T.bounds.getCenter(),_);for(var E=T._renderElements,p=0,g=E.length;p<g;p++){E[p]._update(d,r,n,s)}}}if(null!=this._children)for(m=0;m<8;m++){var S=this._children[m];S&&S._getCollidingWithFrustum(e,r,i,n,s,o)}}_getCollidingWithBoundBox(e,t,r){if(t){var i=$e.boxContainsBox(this._bounds,e);if(i===Je.Disjoint)return;t=i===Je.Intersects}if(t)for(var n=0,a=this._objects.length;n<a;n++){var s=this._objects[n];$e.intersectsBoxAndBox(s.bounds._getBoundBox(),e)&&r.push(s)}if(null!=this._children)for(n=0;n<8;n++){this._children[n]._getCollidingWithBoundBox(e,t,r)}}_bestFitChild(e){return(e.x<=this.center.x?0:1)+(e.y>=this.center.y?0:4)+(e.z<=this.center.z?0:2)}_update(e){if($e.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Je.Contains){var t=this._checkAddNode(e);if(t!==e._getOctreeNode()){t._objects.push(e),e._setOctreeNode(t);var r=this._objects.indexOf(e);this._objects.splice(r,1),this._merge()}return!0}if(this._parent){var i=this._parent._addUp(e);return i&&(r=this._objects.indexOf(e),this._objects.splice(r,1),this._merge()),i}return!1}add(t){return!!e._encapsulates(this._bounds,t.bounds._getBoundBox())&&(this._add(t),!0)}remove(e){return e._getOctreeNode()===this&&(this._remove(e),!0)}update(e){return e._getOctreeNode()===this&&this._update(e)}shrinkIfPossible(t){if(this.baseLength<2*t)return this;for(var r=-1,i=0,n=this._objects.length;i<n;i++){var a=this._objects[i],s=this._bestFitChild(a.bounds.getCenter());if(0!=i&&s!=r)return this;var o=this._getChildBound(s);if(!e._encapsulates(o,a.bounds._getBoundBox()))return this;0==i&&(r=s)}if(null==this._children){if(-1!=r){var l=this._getChildCenter(r);this._setValues(this._octree,null,this.baseLength/2,l)}return this}var _=!1;for(i=0,n=this._children.length;i<n;i++){var h=this._children[i];if(h&&h.hasAnyObjects()){if(_)return this;if(r>=0&&r!=i)return this;_=!0,r=i}}if(-1!=r){var c=this._children[r];return c._parent=null,c}return this}hasAnyObjects(){if(this._objects.length>0)return!0;if(null!=this._children)for(var e=0;e<8;e++){var t=this._children[e];if(t&&t.hasAnyObjects())return!0}return!1}getCollidingWithBoundBox(e,t){this._getCollidingWithBoundBox(e,!0,t)}getCollidingWithRay(e,t,r=Number.MAX_VALUE){var i=$e.intersectsRayAndBoxRD(e,this._bounds);if(!(-1==i||i>r)){for(var n=0,a=this._objects.length;n<a;n++){var s=this._objects[n];-1!==(i=$e.intersectsRayAndBoxRD(e,s.bounds._getBoundBox()))&&i<=r&&t.push(s)}if(null!=this._children)for(n=0;n<8;n++){this._children[n].getCollidingWithRay(e,t,r)}}}getCollidingWithFrustum(e,t,r,i,n){this._getCollidingWithFrustum(e,t,!0,r,i,n)}isCollidingWithBoundBox(e){if(!$e.intersectsBoxAndBox(this._bounds,e))return!1;for(var t=0,r=this._objects.length;t<r;t++){var i=this._objects[t];if($e.intersectsBoxAndBox(i.bounds._getBoundBox(),e))return!0}if(null!=this._children)for(t=0;t<8;t++){if(this._children[t].isCollidingWithBoundBox(e))return!0}return!1}isCollidingWithRay(e,t=Number.MAX_VALUE){var r=$e.intersectsRayAndBoxRD(e,this._bounds);if(-1==r||r>t)return!1;for(var i=0,n=this._objects.length;i<n;i++){var a=this._objects[i];if(-1!==(r=$e.intersectsRayAndBoxRD(e,a.bounds._getBoundBox()))&&r<=t)return!0}if(null!=this._children)for(i=0;i<8;i++){if(this._children[i].isCollidingWithRay(e,t))return!0}return!1}getBound(){return this._bounds}drawAllBounds(t,r,i){if(null!==this._children||0!=this._objects.length){r++;var n=e._tempColor0;if(this._isContaion)n.r=0,n.g=0,n.b=1;else{var a=i?r/i:0;n.r=1-a,n.g=a,n.b=0}if(n.a=.3,k._drawBound(t,this._bounds,n),null!=this._children)for(var s=0;s<8;s++){var o=this._children[s];o&&o.drawAllBounds(t,r,i)}}}drawAllObjects(t,r,i){r++;var n=e._tempColor0;if(this._isContaion)n.r=0,n.g=0,n.b=1;else{var a=i?r/i:0;n.r=1-a,n.g=a,n.b=0}n.a=1;for(var s=0,o=this._objects.length;s<o;s++)k._drawBound(t,this._objects[s].bounds._getBoundBox(),n);if(null!=this._children)for(s=0;s<8;s++){var l=this._children[s];l&&l.drawAllObjects(t,r,i)}}}return e._tempVector3=new a,e._tempVector30=new a,e._tempVector31=new a,e._tempColor0=new Ge,e._tempBoundBox=new Ht(new a,new a),e._NUM_OBJECTS_ALLOWED=8,e})();class sr extends E{constructor(){super()}add(e){if(-1!==e._getIndexInMotionList())throw"OctreeMotionList:element has  in  PhysicsUpdateList.";this._add(e),e._setIndexInMotionList(this.length++)}remove(e){var t=e._getIndexInMotionList();if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._setIndexInMotionList(t)}e._setIndexInMotionList(-1)}}let or=(()=>{class e{constructor(e,t,r,i){this._motionObjects=new sr,this.count=0,r>e&&(console.warn("Minimum node size must be at least as big as the initial world size. Was: "+r+" Adjusted to: "+e),r=e),this._initialSize=e,this._minSize=r,this._looseness=Math.min(Math.max(i,1),2),this._rootNode=new ar(this,null,e,t)}_getMaxDepth(e,t){t++;var r=e._children;if(null!=r)for(var i=t,n=0,a=r.length;n<a;n++){var s=r[n];s&&(t=Math.max(this._getMaxDepth(s,i),t))}return t}_grow(e){var t=e.x>=0?1:-1,r=e.y>=0?1:-1,i=e.z>=0?1:-1,n=this._rootNode,s=this._rootNode.baseLength/2,o=2*this._rootNode.baseLength,l=this._rootNode.center,_=new a(l.x+t*s,l.y+r*s,l.z+i*s);if(this._rootNode=new ar(this,null,o,_),n.hasAnyObjects()){for(var h=this._rootNode._bestFitChild(n.center),c=[],d=0;d<8;d++)d==h&&(n._parent=this._rootNode,c[d]=n);this._rootNode._children=c}}add(t){for(var r=0;!this._rootNode.add(t);){var i=e._tempVector30;if(a.subtract(t.bounds.getCenter(),this._rootNode.center,i),this._grow(i),++r>20)throw"Aborted Add operation as it seemed to be going on forever ("+(r-1)+") attempts at growing the octree."}this.count++}remove(e){var t=e._getOctreeNode().remove(e);return t&&this.count--,t}update(t){var r=0,i=t._getOctreeNode();if(i){for(;!i._update(t);){var n=e._tempVector30;if(a.subtract(t.bounds.getCenter(),this._rootNode.center,n),this._grow(n),++r>20)throw"Aborted Add operation as it seemed to be going on forever ("+(r-1)+") attempts at growing the octree."}return!0}return!1}shrinkRootIfPossible(){this._rootNode=this._rootNode.shrinkIfPossible(this._initialSize)}addMotionObject(e){this._motionObjects.add(e)}removeMotionObject(e){this._motionObjects.remove(e)}updateMotionObjects(){for(var e=this._motionObjects.elements,t=0,r=this._motionObjects.length;t<r;t++){var i=e[t];this.update(i),i._setIndexInMotionList(-1)}this._motionObjects.length=0}isCollidingWithBoundBox(e){return this._rootNode.isCollidingWithBoundBox(e)}isCollidingWithRay(e,t=Number.MAX_VALUE){return this._rootNode.isCollidingWithRay(e,t)}getCollidingWithBoundBox(e,t){this._rootNode.getCollidingWithBoundBox(e,t)}getCollidingWithRay(e,t,r=Number.MAX_VALUE){this._rootNode.getCollidingWithRay(e,t,r)}getCollidingWithFrustum(e,t,r,i,n){this._rootNode.getCollidingWithFrustum(e,t,r,i,n)}getMaxBounds(){return this._rootNode.getBound()}drawAllBounds(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllBounds(e,-1,t)}drawAllObjects(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllObjects(e,-1,t)}}return e._tempVector30=new a,e})();class lr{}let _r=(()=>{class e{constructor(e,t){this.center=e,this.radius=t}toDefault(){this.center.toDefault(),this.radius=0}static createFromSubPoints(t,r,i,n){if(null==t)throw new Error("points");if(r<0||r>=t.length)throw new Error("start"+r+"Must be in the range [0, "+(t.length-1)+"]");if(i<0||r+i>t.length)throw new Error("count"+i+"Must be in the range <= "+t.length+"}");var s=r+i,o=e._tempVector3;o.x=0,o.y=0,o.z=0;for(var l=r;l<s;++l)a.add(t[l],o,o);var _=n.center;a.scale(o,1/i,_);var h=0;for(l=r;l<s;++l){var c=a.distanceSquared(_,t[l]);c>h&&(h=c)}n.radius=Math.sqrt(h)}static createfromPoints(t,r){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,r)}intersectsRayDistance(e){return $e.intersectsRayAndSphereRD(e,this)}intersectsRayPoint(e,t){return $e.intersectsRayAndSphereRP(e,this,t)}cloneTo(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius}clone(){var t=new e(new a,0);return this.cloneTo(t),t}}return e._tempVector3=new a,e})();class hr{constructor(){this.cameraShaderValue=new Ie,this.position=new a,this.viewMatrix=new h,this.projectionMatrix=new h,this.viewProjectMatrix=new h,this.cullPlanes=[new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a)],this.splitBoundSphere=new _r(new a,0)}}class cr{constructor(){this.cameraShaderValue=new Ie,this.position=new a,this.viewMatrix=new h,this.projectionMatrix=new h,this.viewProjectMatrix=new h,this.cameraCullInfo=new ze}}var dr;(dr=e.ShadowLightType||(e.ShadowLightType={}))[dr.DirectionLight=0]="DirectionLight",dr[dr.SpotLight=1]="SpotLight",dr[dr.PointLight=2]="PointLight";let ur=(()=>{class i{constructor(){this._shadowBias=new n,this._shadowParams=new n,this._shadowMapSize=new n,this._shadowMatrices=new Float32Array(16*i._maxCascades),this._shadowSpotMatrices=new h,this._splitBoundSpheres=new Float32Array(4*i._maxCascades),this._cascadeCount=0,this._shadowMapWidth=0,this._shadowMapHeight=0,this._shadowSliceDatas=[new hr,new hr,new hr,new hr],this._shadowSpotData=new cr,this._lightUp=new a,this._lightSide=new a,this._lightForward=new a,this._shadowSpotData.cameraCullInfo.boundFrustum=new tt(new h)}_setupShadowCasterShaderValues(t,r,n,a,s,o,l){switch(r.setVector(i.SHADOW_BIAS,o),l){case e.LightType.Directional:r.setVector3(i.SHADOW_LIGHT_DIRECTION,a);break;case e.LightType.Spot:r.setVector(i.SHADOW_PARAMS,s);break;case e.LightType.Point:}var _=n.cameraShaderValue;_.setMatrix4x4(Tt.VIEWMATRIX,n.viewMatrix),_.setMatrix4x4(Tt.PROJECTMATRIX,n.projectionMatrix),_.setMatrix4x4(Tt.VIEWPROJECTMATRIX,n.viewProjectMatrix),t.viewMatrix=n.viewMatrix,t.projectionMatrix=n.projectionMatrix,t.projectionViewMatrix=n.viewProjectMatrix}_setupShadowReceiverShaderValues(t){var r=this._light;switch(r.shadowCascadesMode!==e.ShadowCascadesMode.NoCascades?t.addDefine(xt.SHADERDEFINE_SHADOW_CASCADE):t.removeDefine(xt.SHADERDEFINE_SHADOW_CASCADE),r.shadowMode){case e.ShadowMode.Hard:t.removeDefine(xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftLow:t.addDefine(xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH),t.removeDefine(xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW)}t.setTexture(i.SHADOW_MAP,this._shadowDirectLightMap),t.setBuffer(i.SHADOW_MATRICES,this._shadowMatrices),t.setVector(i.SHADOW_MAP_SIZE,this._shadowMapSize),t.setVector(i.SHADOW_PARAMS,this._shadowParams),t.setBuffer(i.SHADOW_SPLIT_SPHERES,this._splitBoundSpheres)}_setupSpotShadowReceiverShaderValues(t){switch(this._light.shadowMode){case e.ShadowMode.Hard:t.removeDefine(xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW);break;case e.ShadowMode.SoftLow:t.addDefine(xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW),t.removeDefine(xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW)}t.setTexture(i.SHADOW_SPOTMAP,this._shadowSpotLightMap),t.setMatrix4x4(i.SHADOW_SPOTMATRICES,this._shadowSpotMatrices),t.setVector(i.SHADOW_MAP_SIZE,this._shadowMapSize),t.setVector(i.SHADOW_PARAMS,this._shadowParams)}update(t,n,s){switch(s){case e.ShadowLightType.DirectionLight:this._light=n;var o=(L=i._tempMatrix0).elements,l=this._lightUp,_=this._lightSide,c=this._lightForward;h.createFromQuaternion(n._transform.rotation,L),_.setValue(o[0],o[1],o[2]),l.setValue(o[4],o[5],o[6]),c.setValue(-o[8],-o[9],-o[10]);var d,u,m,f,T=n._shadowResolution,E=n._shadowCascadesMode;E==e.ShadowCascadesMode.NoCascades?(d=1,u=T,m=T,f=T):(d=E==e.ShadowCascadesMode.TwoCascades?2:4,m=2*(u=Mt.getMaxTileResolutionInAtlas(T,T,d)),f=E==e.ShadowCascadesMode.TwoCascades?u:2*u),this._cascadeCount=d,this._shadowMapWidth=m,this._shadowMapHeight=f;var p=i._cascadesSplitDistance,g=i._frustumPlanes,S=t.nearPlane,R=Math.min(t.farPlane,n._shadowDistance),v=this._shadowMatrices,A=this._splitBoundSpheres;Mt.getCascadesSplitDistance(n._shadowTwoCascadeSplits,n._shadowFourCascadeSplits,S,R,t.fieldOfView*r.Deg2Rad,t.aspectRatio,E,p),Mt.getCameraFrustumPlanes(t.projectionViewMatrix,g);var I=i._tempVector30;t._transform.getForward(I),a.normalize(I,I);for(var x=0;x<d;x++){var C=this._shadowSliceDatas[x];C.sphereCenterZ=Mt.getBoundSphereByFrustum(p[x],p[x+1],t.fieldOfView*r.Deg2Rad,t.aspectRatio,t._transform.position,I,C.splitBoundSphere),Mt.getDirectionLightShadowCullPlanes(g,x,p,S,c,C),Mt.getDirectionalLightMatrices(l,_,c,x,n._shadowNearPlane,u,C,v),d>1&&Mt.applySliceTransform(C,m,f,x,v)}Mt.prepareShadowReceiverShaderValues(n,m,f,this._shadowSliceDatas,d,this._shadowMapSize,this._shadowParams,v,A);break;case e.ShadowLightType.SpotLight:this._light=n;var L=i._tempMatrix0,y=(c=this._lightForward,this._light._shadowResolution);this._shadowMapWidth=y,this._shadowMapHeight=y;var D=this._shadowSpotData;Mt.getSpotLightShadowData(D,this._light,y,this._shadowParams,this._shadowSpotMatrices,this._shadowMapSize);break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}render(r,i,n){switch(n){case e.ShadowLightType.DirectionLight:var a=i._shaderValues;r.pipelineMode="ShadowCaster",Ie.setRuntimeValueMode(!1),(T=this._shadowDirectLightMap=Mt.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();for(var s=this._light,o=0,l=this._cascadeCount;o<l;o++){var _=this._shadowSliceDatas[o];Mt.getShadowBias(s,_.projectionMatrix,_.resolution,this._shadowBias),this._setupShadowCasterShaderValues(r,a,_,this._lightForward,this._shadowParams,this._shadowBias,e.LightType.Directional);var h=We._shadowCullInfo;h.position=_.position,h.cullPlanes=_.cullPlanes,h.cullPlaneCount=_.cullPlaneCount,h.cullSphere=_.splitBoundSphere,h.direction=this._lightForward;var c=We.cullingShadow(h,i,r);r.cameraShaderValue=_.cameraShaderValue,Nt._updateMark++;var d=t.LayaGL.instance,u=_.resolution,m=_.offsetX,f=_.offsetY;d.enable(d.SCISSOR_TEST),d.viewport(m,f,u,u),d.scissor(m,f,u,u),d.clear(d.DEPTH_BUFFER_BIT),c&&(d.scissor(m+1,f+1,u-2,u-2),i._opaqueQueue._render(r))}T._end(),this._setupShadowReceiverShaderValues(a),Ie.setRuntimeValueMode(!0),r.pipelineMode="Forward";break;case e.ShadowLightType.SpotLight:a=i._shaderValues;r.pipelineMode="ShadowCaster",Ie.setRuntimeValueMode(!1);var T,E=this._light;(T=this._shadowSpotLightMap=Mt.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();var p=this._shadowSpotData;Mt.getShadowBias(E,p.projectionMatrix,p.resolution,this._shadowBias),this._setupShadowCasterShaderValues(r,a,p,this._light.transform.position,this._shadowParams,this._shadowBias,e.LightType.Spot);c=We.cullingSpotShadow(p.cameraCullInfo,i,r);r.cameraShaderValue=p.cameraShaderValue,Nt._updateMark++,(d=t.LayaGL.instance).enable(d.SCISSOR_TEST),d.viewport(p.offsetX,p.offsetY,p.resolution,p.resolution),d.scissor(p.offsetX,p.offsetY,p.resolution,p.resolution),d.clear(d.DEPTH_BUFFER_BIT),c&&(d.scissor(p.offsetX,p.offsetY,p.resolution,p.resolution),i._opaqueQueue._render(r)),T._end(),this._setupSpotShadowReceiverShaderValues(a),Ie.setRuntimeValueMode(!0),r.pipelineMode="Forward";break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}cleanUp(){this._shadowDirectLightMap&&pe.recoverToPool(this._shadowDirectLightMap),this._shadowSpotLightMap&&pe.recoverToPool(this._shadowSpotLightMap),this._shadowDirectLightMap=null,this._shadowSpotLightMap=null,this._light=null}}return i._tempVector30=new a,i._tempMatrix0=new h,i.SHADOW_BIAS=Ae.propertyNameToID("u_ShadowBias"),i.SHADOW_LIGHT_DIRECTION=Ae.propertyNameToID("u_ShadowLightDirection"),i.SHADOW_SPLIT_SPHERES=Ae.propertyNameToID("u_ShadowSplitSpheres"),i.SHADOW_MATRICES=Ae.propertyNameToID("u_ShadowMatrices"),i.SHADOW_MAP_SIZE=Ae.propertyNameToID("u_ShadowMapSize"),i.SHADOW_MAP=Ae.propertyNameToID("u_ShadowMap"),i.SHADOW_PARAMS=Ae.propertyNameToID("u_ShadowParams"),i.SHADOW_SPOTMAP=Ae.propertyNameToID("u_SpotShadowMap"),i.SHADOW_SPOTMATRICES=Ae.propertyNameToID("u_SpotViewProjectMatrix"),i._maxCascades=4,i._cascadesSplitDistance=new Array(i._maxCascades+1),i._frustumPlanes=new Array(new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a),new Qe(new a)),i})(),mr=(()=>{class e{constructor(){this._batchRenderElementPool=[]}static _registerManager(t){e._managers.push(t)}_clear(){this._batchRenderElementPoolIndex=0}_getBatchRenderElementFromPool(){throw"StaticBatch:must override this function."}dispose(){}}return e._managers=[],e})();var fr;(fr=e.AmbientMode||(e.AmbientMode={}))[fr.SolidColor=0]="SolidColor",fr[fr.SphericalHarmonics=1]="SphericalHarmonics";let Tr=(()=>{class r extends t.Sprite{constructor(){super(),this._lightCount=0,this._pointLights=new Ut,this._spotLights=new Ut,this._directionLights=new Ut,this._alternateLights=new Gt,this._lightmaps=[],this._skyRenderer=new mt,this._input=new bt,this._timer=t.ILaya.timer,this._time=0,this._shCoefficients=new Array(7),this._ambientMode=e.AmbientMode.SolidColor,this._ambientSphericalHarmonics=new je,this._ambientSphericalHarmonicsIntensity=1,this._reflectionDecodeFormat=t.TextureDecodeFormat.Normal,this._reflectionIntensity=1,this._collsionTestList=[],this._renders=new Ue,this._opaqueQueue=new nr(!1),this._transparentQueue=new nr(!0),this._cameraPool=[],this._animatorPool=new Ue,this._scriptPool=new Array,this._tempScriptPool=new Array,this._needClearScriptPool=!1,this._reflectionCubeHDRParams=new n,this.currentCreationLayer=Math.pow(2,0),this.enableLight=!0,this._key=new t.SubmitKey,this._pickIdToSprite=new Object,this._reflectionMode=0,!Q._config.isUseCannonPhysicsEngine&&Z._bullet?this._physicsSimulation=new H(r.physicsSettings):Z._cannon&&(this._cannonPhysicsSimulation=new A(r.cannonPhysicsSettings)),this._shaderValues=new Ie(null),this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new a(.7,.7,.7),this.ambientColor=new a(.212,.227,.259),this.reflectionIntensity=1,this.reflection=Bt.blackTexture;for(var i=0;i<7;i++)this._shCoefficients[i]=new n;if(this._shaderValues.setVector(r.REFLECTIONCUBE_HDR_PARAMS,this._reflectionCubeHDRParams),t.Render.supportWebGLPlusCulling&&(this._cullingBufferIndices=new Int32Array(1024),this._cullingBufferResult=new Int32Array(1024)),this._scene=this,this._input.__init__(t.Render.canvas,this),r.octreeCulling&&(this._octree=new or(r.octreeInitialSize,r.octreeInitialCenter,r.octreeMinNodeSize,r.octreeLooseness)),We.debugFrustumCulling){this._debugTool=new ir;var s=new zt;s.renderQueue=De.RENDERQUEUE_TRANSPARENT,s.alphaTest=!1,s.depthWrite=!1,s.cull=Oe.CULL_BACK,s.blend=Oe.BLEND_ENABLE_ALL,s.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,s.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,s.depthTest=Oe.DEPTHTEST_LESS,this._debugTool.pixelLineRenderer.sharedMaterial=s}}static __init__(){var i=Q._config;if(i._multiLighting){const e=4;var n=i.maxLightCount,a=i.lightClusterCount;Ye.instance=new Ye(a.x,a.y,a.z,Math.min(i.maxLightCount,i._maxAreaLightCountPerClusterAverage)),r._lightTexture=k._createFloatTextureBuffer(e,n),r._lightTexture.lock=!0,r._lightPixles=new Float32Array(n*e*4)}xt.SHADERDEFINE_FOG=Ae.getDefineByName("FOG"),xt.SHADERDEFINE_DIRECTIONLIGHT=Ae.getDefineByName("DIRECTIONLIGHT"),xt.SHADERDEFINE_POINTLIGHT=Ae.getDefineByName("POINTLIGHT"),xt.SHADERDEFINE_SPOTLIGHT=Ae.getDefineByName("SPOTLIGHT"),xt.SHADERDEFINE_SHADOW=Ae.getDefineByName("SHADOW"),xt.SHADERDEFINE_SHADOW_CASCADE=Ae.getDefineByName("SHADOW_CASCADE"),xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW=Ae.getDefineByName("SHADOW_SOFT_SHADOW_LOW"),xt.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH=Ae.getDefineByName("SHADOW_SOFT_SHADOW_HIGH"),xt.SHADERDEFINE_GI_AMBIENT_SH=Ae.getDefineByName("GI_AMBIENT_SH"),xt.SHADERDEFINE_SHADOW_SPOT=Ae.getDefineByName("SHADOW_SPOT"),xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW=Ae.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_LOW"),xt.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH=Ae.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_HIGH");var s=Q._config,o=r._configDefineValues;switch(s._multiLighting||o.add(Ae.SHADERDEFINE_LEGACYSINGALLIGHTING),t.LayaGL.layaGPUInstance._isWebGL2?o.add(Ae.SHADERDEFINE_GRAPHICS_API_GLES3):o.add(Ae.SHADERDEFINE_GRAPHICS_API_GLES2),s.pbrRenderQuality){case e.PBRRenderQuality.High:o.add(Ve.SHADERDEFINE_LAYA_PBR_BRDF_HIGH);break;case e.PBRRenderQuality.Low:o.add(Ve.SHADERDEFINE_LAYA_PBR_BRDF_LOW);break;default:throw"Scene3D:unknown shader quality."}s.isUseCannonPhysicsEngine?r.cannonPhysicsSettings=new q:r.physicsSettings=new Pt}static load(e,i){t.ILaya.loader.create(e,i,null,r.HIERARCHY)}get url(){return this._url}get enableFog(){return this._enableFog}set enableFog(e){this._enableFog!==e&&(this._enableFog=e,e?this._shaderValues.addDefine(xt.SHADERDEFINE_FOG):this._shaderValues.removeDefine(xt.SHADERDEFINE_FOG))}get fogColor(){return this._shaderValues.getVector3(r.FOGCOLOR)}set fogColor(e){this._shaderValues.setVector3(r.FOGCOLOR,e)}get fogStart(){return this._shaderValues.getNumber(r.FOGSTART)}set fogStart(e){this._shaderValues.setNumber(r.FOGSTART,e)}get fogRange(){return this._shaderValues.getNumber(r.FOGRANGE)}set fogRange(e){this._shaderValues.setNumber(r.FOGRANGE,e)}get ambientMode(){return this._ambientMode}set ambientMode(t){if(this._ambientMode!==t){switch(t){case e.AmbientMode.SolidColor:this._shaderValues.removeDefine(xt.SHADERDEFINE_GI_AMBIENT_SH);break;case e.AmbientMode.SphericalHarmonics:this._shaderValues.addDefine(xt.SHADERDEFINE_GI_AMBIENT_SH);break;default:throw"Scene3D: unknown ambientMode."}this._ambientMode=t}}get ambientColor(){return this._shaderValues.getVector3(r.AMBIENTCOLOR)}set ambientColor(e){this._shaderValues.setVector3(r.AMBIENTCOLOR,e)}get ambientSphericalHarmonics(){return this._ambientSphericalHarmonics}set ambientSphericalHarmonics(e){var t=e||je._default;this._applySHCoefficients(t,Math.pow(this._ambientSphericalHarmonicsIntensity,2.2)),this._ambientSphericalHarmonics!=e&&e.cloneTo(this._ambientSphericalHarmonics)}get ambientSphericalHarmonicsIntensity(){return this._ambientSphericalHarmonicsIntensity}set ambientSphericalHarmonicsIntensity(e){if(e=Math.max(Math.min(e,8),0),this._ambientSphericalHarmonicsIntensity!==e){var t=this._ambientSphericalHarmonics||je._default;this._applySHCoefficients(t,Math.pow(e,2.2)),this._ambientSphericalHarmonicsIntensity=e}}get reflection(){return this._reflection}set reflection(e){this._reflection!=e&&(this._shaderValues.setTexture(r.REFLECTIONTEXTURE,e||Bt.blackTexture),this._reflection=e)}get reflectionDecodingFormat(){return this._reflectionDecodeFormat}set reflectionDecodingFormat(e){this._reflectionDecodeFormat!=e&&(this._reflectionCubeHDRParams.x=this._reflectionIntensity,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionDecodeFormat=e)}get reflectionIntensity(){return this._reflectionIntensity}set reflectionIntensity(e){e=Math.max(Math.min(e,1),0),this._reflectionCubeHDRParams.x=e,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionIntensity=e}get skyRenderer(){return this._skyRenderer}get physicsSimulation(){return this._physicsSimulation}get cannonPhysicsSimulation(){return this._cannonPhysicsSimulation}get timer(){return this._timer}set timer(e){this._timer=e}get input(){return this._input}get lightmaps(){return this._lightmaps.slice()}set lightmaps(e){var t=this._lightmaps;if(t)for(var r=0,i=t.length;r<i;r++){(a=t[r]).lightmapColor._removeReference(),a.lightmapDirection._removeReference()}if(e){var n=e.length;for(t.length=n,r=0;r<n;r++){var a;(a=e[r]).lightmapColor&&a.lightmapColor._addReference(),a.lightmapDirection&&a.lightmapDirection._addReference(),t[r]=a}}else t.length=0}_applySHCoefficients(e,t){for(var i=this._shCoefficients,n=0;n<3;n++){var a=i[n],s=i[n+3];a.setValue(e.getCoefficient(n,3)*t,e.getCoefficient(n,1)*t,e.getCoefficient(n,2)*t,(e.getCoefficient(n,0)-e.getCoefficient(n,6))*t),s.setValue(e.getCoefficient(n,4)*t,e.getCoefficient(n,5)*t,3*e.getCoefficient(n,6)*t,e.getCoefficient(n,7)*t)}i[6].setValue(e.getCoefficient(0,8)*t,e.getCoefficient(1,8)*t,e.getCoefficient(2,8)*t,1);var o=this._shaderValues;o.setVector(r.AMBIENTSHAR,i[0]),o.setVector(r.AMBIENTSHAG,i[1]),o.setVector(r.AMBIENTSHAB,i[2]),o.setVector(r.AMBIENTSHBR,i[3]),o.setVector(r.AMBIENTSHBG,i[4]),o.setVector(r.AMBIENTSHBB,i[5]),o.setVector(r.AMBIENTSHC,i[6])}_update(){var e=this.timer._delta/1e3;this._time+=e,this._shaderValues.setNumber(r.TIME,this._time);var t=this._physicsSimulation;if(!Z._enablePhysics||H.disableSimulation||Q._config.isUseCannonPhysicsEngine||(t._updatePhysicsTransformFromRender(),V._addUpdateList=!1,t._simulate(e),t._updateCharacters(),V._addUpdateList=!0,t._updateCollisions(),t._eventScripts()),Z._cannon&&Q._config.isUseCannonPhysicsEngine){var i=this._cannonPhysicsSimulation;i._updatePhysicsTransformFromRender(),T._addUpdateList=!1,i._simulate(e),T._addUpdateList=!0,i._updateCollisions(),i._eventScripts()}this._input._update(),this._clearScript(),this._updateScript(),fe._update(this),this._lateUpdateScript()}_binarySearchIndexInCameraPool(e){for(var t,r=0,i=this._cameraPool.length-1;r<=i;){t=Math.floor((r+i)/2);var n=this._cameraPool[t]._renderingOrder;if(n==e._renderingOrder)return t;n>e._renderingOrder?i=t-1:r=t+1}return r}_allotPickColorByID(e,t){var r=Math.floor(e/65025);e-=255*r*255;var i=Math.floor(e/255),n=e-=255*i;t.x=r/255,t.y=i/255,t.z=n/255,t.w=1}_searchIDByPickColor(e){return 255*e.x*255+255*e.y+e.z}onEnable(){this._input._onCanvasEvent(t.Render.canvas)}onDisable(){this._input._offCanvasEvent(t.Render.canvas)}_setCreateURL(e){this._url=t.URL.formatURL(e)}_getGroup(){return this._group}_setGroup(e){this._group=e}_clearScript(){if(this._needClearScriptPool){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var i=e[t];i&&(i._indexInPool=this._tempScriptPool.length,this._tempScriptPool.push(i))}this._scriptPool=this._tempScriptPool,e.length=0,this._tempScriptPool=e,this._needClearScriptPool=!1}}_updateScript(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var i=e[t];i&&i.enabled&&i.onUpdate()}}_lateUpdateScript(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var i=e[t];i&&i.enabled&&i.onLateUpdate()}}_onActive(){super._onActive(),t.ILaya.stage._scene3Ds.push(this)}_onInActive(){super._onInActive();var e=t.ILaya.stage._scene3Ds;e.splice(e.indexOf(this),1)}_prepareSceneToRender(){var e=this._shaderValues;if(Q._config._multiLighting){var t=r._lightTexture,i=r._lightPixles;const A=t.width,I=4*A;var n=0,s=this._directionLights._length,o=this._directionLights._elements;if(s>0){var l=this._directionLights.getBrightestLight();this._mainDirectionLight=o[l],this._directionLights.normalLightOrdering(l);for(var _=0;_<s;_++,n++){var h=(R=o[_])._direction,c=R._intensityColor,d=I*n;a.scale(R.color,R._intensity,c),R.transform.worldMatrix.getForward(h),a.normalize(h,h),i[d]=c.x,i[d+1]=c.y,i[d+2]=c.z,i[d+4]=h.x,i[d+5]=h.y,i[d+6]=h.z,0==_&&(e.setVector3(r.SUNLIGHTDIRCOLOR,c),e.setVector3(r.SUNLIGHTDIRECTION,h))}e.addDefine(xt.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(xt.SHADERDEFINE_DIRECTIONLIGHT);var u=this._pointLights._length;if(u>0){var m=this._pointLights._elements,f=this._pointLights.getBrightestLight();this._mainPointLight=m[f],this._pointLights.normalLightOrdering(f);for(_=0;_<u;_++,n++){var T=(v=m[_]).transform.position;c=v._intensityColor,d=I*n;a.scale(v.color,v._intensity,c),i[d]=c.x,i[d+1]=c.y,i[d+2]=c.z,i[d+3]=v.range,i[d+4]=T.x,i[d+5]=T.y,i[d+6]=T.z}e.addDefine(xt.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(xt.SHADERDEFINE_POINTLIGHT);var E=this._spotLights._length;if(E>0){var p=this._spotLights._elements,g=this._spotLights.getBrightestLight();this._mainSpotLight=p[g],this._spotLights.normalLightOrdering(g);for(_=0;_<E;_++,n++){var S=p[_];h=S._direction,T=S.transform.position,c=S._intensityColor,d=I*n;a.scale(S.color,S._intensity,c),S.transform.worldMatrix.getForward(h),a.normalize(h,h),i[d]=c.x,i[d+1]=c.y,i[d+2]=c.z,i[d+3]=S.range,i[d+4]=T.x,i[d+5]=T.y,i[d+6]=T.z,i[d+7]=S.spotAngle*Math.PI/180,i[d+8]=h.x,i[d+9]=h.y,i[d+10]=h.z}e.addDefine(xt.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(xt.SHADERDEFINE_SPOTLIGHT);n>0&&t.setSubPixels(0,0,A,n,i,0),e.setTexture(r.LIGHTBUFFER,t),e.setInt(r.DIRECTIONLIGHTCOUNT,this._directionLights._length),e.setTexture(r.CLUSTERBUFFER,Ye.instance._clusterTexture)}else{if(this._directionLights._length>0){var R=this._directionLights._elements[0];this._mainDirectionLight=R,a.scale(R.color,R._intensity,R._intensityColor),R.transform.worldMatrix.getForward(R._direction),a.normalize(R._direction,R._direction),e.setVector3(r.LIGHTDIRCOLOR,R._intensityColor),e.setVector3(r.LIGHTDIRECTION,R._direction),e.setVector3(r.SUNLIGHTDIRCOLOR,R._intensityColor),e.setVector3(r.SUNLIGHTDIRECTION,R._direction),e.addDefine(xt.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(xt.SHADERDEFINE_DIRECTIONLIGHT);if(this._pointLights._length>0){var v=this._pointLights._elements[0];a.scale(v.color,v._intensity,v._intensityColor),e.setVector3(r.POINTLIGHTCOLOR,v._intensityColor),e.setVector3(r.POINTLIGHTPOS,v.transform.position),e.setNumber(r.POINTLIGHTRANGE,v.range),e.addDefine(xt.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(xt.SHADERDEFINE_POINTLIGHT);if(this._spotLights._length>0){var A=this._spotLights._elements[0];a.scale(A.color,A._intensity,A._intensityColor),e.setVector3(r.SPOTLIGHTCOLOR,A._intensityColor),e.setVector3(r.SPOTLIGHTPOS,A.transform.position),A.transform.worldMatrix.getForward(A._direction),a.normalize(A._direction,A._direction),e.setVector3(r.SPOTLIGHTDIRECTION,A._direction),e.setNumber(r.SPOTLIGHTRANGE,A.range),e.setNumber(r.SPOTLIGHTSPOTANGLE,A.spotAngle*Math.PI/180),e.addDefine(xt.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(xt.SHADERDEFINE_SPOTLIGHT)}}_addScript(e){var t=this._scriptPool;e._indexInPool=t.length,t.push(e)}_removeScript(e){this._scriptPool[e._indexInPool]=null,e._indexInPool=-1,this._needClearScriptPool=!0}_preRenderScript(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var i=e[t];i&&i.enabled&&i.onPreRender()}}_postRenderScript(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var i=e[t];i&&i.enabled&&i.onPostRender()}}_addCamera(e){for(var t=this._binarySearchIndexInCameraPool(e),r=e._renderingOrder,i=this._cameraPool.length;t<i&&this._cameraPool[t]._renderingOrder<=r;)t++;this._cameraPool.splice(t,0,e)}_removeCamera(e){this._cameraPool.splice(this._cameraPool.indexOf(e),1)}_preCulling(e,t,r,i){var n=We._cameraCullInfo;n.position=t._transform.position,n.cullingMask=t.cullingMask,n.boundFrustum=t.boundFrustum,n.useOcclusionCulling=t.useOcclusionCulling,We.renderObjectCulling(n,this,e,r,i,!1)}_clear(r,i){var n,a,s,o=i.viewport,l=i.camera,_=l._getRenderTexture(),h=o.width,c=o.height;l._needInternalRenderTexture()?(n=0,a=0):(n=o.x,a=l._getCanvasHeight()-o.y-c),r.viewport(n,a,h,c);var d=l.clearFlag;switch(d!==e.CameraClearFlags.Sky||l.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(d=e.CameraClearFlags.SolidColor),d){case e.CameraClearFlags.SolidColor:var u=l.clearColor;if(r.enable(r.SCISSOR_TEST),r.scissor(n,a,h,c),u?r.clearColor(u.x,u.y,u.z,u.w):r.clearColor(0,0,0,0),_)switch(s=r.COLOR_BUFFER_BIT,_.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:s|=r.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:s|=r.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:s|=r.DEPTH_BUFFER_BIT,s|=r.STENCIL_BUFFER_BIT}else s=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(r,!0),r.clear(s),r.disable(r.SCISSOR_TEST);break;case e.CameraClearFlags.Sky:case e.CameraClearFlags.DepthOnly:if(r.enable(r.SCISSOR_TEST),r.scissor(n,a,h,c),_)switch(_.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:s=r.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:s=r.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:s=r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT}else s=r.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(r,!0),r.clear(s),r.disable(r.SCISSOR_TEST);break;case e.CameraClearFlags.Nothing:break;default:throw new Error("Scene3D:camera clearFlag invalid.")}}_renderScene(t){var r=t.camera;if(this._opaqueQueue._render(t),r.clearFlag===e.CameraClearFlags.Sky&&(r.skyRenderer._isAvailable()?r.skyRenderer._render(t):this._skyRenderer._isAvailable()&&this._skyRenderer._render(t)),this._transparentQueue._render(t),We.debugFrustumCulling)for(var i=this._debugTool._render._renderElements,n=0,a=i.length;n<a;n++)i[n]._update(this,t,null,null),i[n]._render(t)}_parse(e,r){var i=e.lightmaps;if(i){for(var n=i.length,a=new Array(n),s=0;s<n;s++){var o=new lr,l=i[s];l.path?o.lightmapColor=t.Loader.getRes(l.path):(o.lightmapColor=t.Loader.getRes(l.color.path),l.direction&&(o.lightmapDirection=t.Loader.getRes(l.direction.path))),a[s]=o}this.lightmaps=a}var _=e.ambientColor;if(_){var h=this.ambientColor;h.fromArray(_),this.ambientColor=h}var c=e.sky;if(c)switch(this._skyRenderer.material=t.Loader.getRes(c.material.path),c.mesh){case"SkyBox":this._skyRenderer.mesh=ut.instance;break;case"SkyDome":this._skyRenderer.mesh=Vt.instance;break;default:this.skyRenderer.mesh=ut.instance}this.enableFog=e.enableFog,this.fogStart=e.fogStart,this.fogRange=e.fogRange;var d=e.fogColor;if(d){var u=this.fogColor;u.fromArray(d),this.fogColor=u}var m=e.ambientSphericalHarmonics;if(m){var f=this.ambientSphericalHarmonics;for(s=0;s<3;s++){var T=9*s;f.setCoefficients(s,m[T],m[T+1],m[T+2],m[T+3],m[T+4],m[T+5],m[T+6],m[T+7],m[T+8])}this.ambientSphericalHarmonics=f}var E=e.reflection;null!=E&&(this.reflection=t.Loader.getRes(E));var p=e.reflectionDecodingFormat;null!=p&&(this.reflectionDecodingFormat=p);var g=e.ambientMode;null!=g&&(this.ambientMode=g);var S=e.ambientSphericalHarmonicsIntensity;null!=S&&(this.ambientSphericalHarmonicsIntensity=S);var R=e.reflectionIntensity;null!=R&&(this.reflectionIntensity=R)}_addRenderObject(e){if(this._octree&&e._supportOctree)this._octree.add(e);else if(this._renders.add(e),t.Render.supportWebGLPlusCulling){var r=e._getIndexInList(),i=this._cullingBufferIndices.length;if(r>=i){var n=this._cullingBufferIndices,a=this._cullingBufferResult;this._cullingBufferIndices=new Int32Array(i+1024),this._cullingBufferResult=new Int32Array(i+1024),this._cullingBufferIndices.set(n,0),this._cullingBufferResult.set(a,0)}this._cullingBufferIndices[r]=e._cullingBufferIndex}}_removeRenderObject(e){var r;this._octree&&e._supportOctree?this._octree.remove(e):(t.Render.supportWebGLPlusCulling&&(r=this._renders.elements[this._renders.length-1]),this._renders.remove(e),t.Render.supportWebGLPlusCulling&&(this._cullingBufferIndices[r._getIndexInList()]=r._cullingBufferIndex))}_getRenderQueue(e){return e<=2500?this._opaqueQueue:this._transparentQueue}_clearRenderQueue(){this._opaqueQueue.clear(),this._transparentQueue.clear();for(var e=Jt._managers,t=0,r=e.length;t<r;t++)e[t]._clear();var i=mr._managers;for(t=0,r=i.length;t<r;t++)i[t]._clear()}destroy(e=!0){this.destroyed||(super.destroy(e),this._skyRenderer.destroy(),this._skyRenderer=null,this._directionLights=null,this._pointLights=null,this._spotLights=null,this._alternateLights=null,this._lightmaps=null,this._shaderValues=null,this._renders=null,this._cameraPool=null,this._octree=null,this._physicsSimulation&&this._physicsSimulation._destroy(),t.Loader.clearRes(this.url))}render(e,r,i){e._curSubmit=t.SubmitBase.RENDERBASE,this._children.length>0&&e.addRenderObject(this)}renderSubmit(){var e,r,i;t.LayaGL.instance;for(this._prepareSceneToRender(),e=0,i=(r=this._cameraPool.length)-1;e<r;e++){t.Render.supportWebGLPlusRendering&&Ie.setRuntimeValueMode(e==i);var n=this._cameraPool[e];n.enableRender&&n.render()}return t.Context.set2DRenderConfig(),1}getRenderType(){return 0}releaseRender(){}reUse(e,t){return 0}get customReflection(){return this._reflection}set customReflection(e){this._reflection!=e&&(this._shaderValues.setTexture(r.REFLECTIONTEXTURE,e||Bt.blackTexture),this._reflection=e)}get reflectionMode(){return this._reflectionMode}set reflectionMode(e){this._reflectionMode=e}setlightmaps(e){for(var t=this._lightmaps,r=0,i=t.length;r<i;r++)t[r].lightmapColor._removeReference();if(!e)throw new Error("Scene3D: value value can't be null.");var n=e.length;for(t.length=n,r=0;r<n;r++){var a=e[r];a._addReference(),t[r]||(t[r]=new lr),t[r].lightmapColor=a}}getlightmaps(){for(var e=new Array(this._lightmaps.length),t=0;t<this._lightmaps.length;t++)e[t]=this._lightmaps[t].lightmapColor;return e}}return r._shadowCasterPass=new ur,r.HIERARCHY="HIERARCHY",r.octreeCulling=!1,r.octreeInitialSize=64,r.octreeInitialCenter=new a(0,0,0),r.octreeMinNodeSize=2,r.octreeLooseness=1.25,r.REFLECTIONMODE_SKYBOX=0,r.REFLECTIONMODE_CUSTOM=1,r.FOGCOLOR=Ae.propertyNameToID("u_FogColor"),r.FOGSTART=Ae.propertyNameToID("u_FogStart"),r.FOGRANGE=Ae.propertyNameToID("u_FogRange"),r.DIRECTIONLIGHTCOUNT=Ae.propertyNameToID("u_DirationLightCount"),r.LIGHTBUFFER=Ae.propertyNameToID("u_LightBuffer"),r.CLUSTERBUFFER=Ae.propertyNameToID("u_LightClusterBuffer"),r.SUNLIGHTDIRECTION=Ae.propertyNameToID("u_SunLight.direction"),r.SUNLIGHTDIRCOLOR=Ae.propertyNameToID("u_SunLight.color"),r.AMBIENTSHAR=Ae.propertyNameToID("u_AmbientSHAr"),r.AMBIENTSHAG=Ae.propertyNameToID("u_AmbientSHAg"),r.AMBIENTSHAB=Ae.propertyNameToID("u_AmbientSHAb"),r.AMBIENTSHBR=Ae.propertyNameToID("u_AmbientSHBr"),r.AMBIENTSHBG=Ae.propertyNameToID("u_AmbientSHBg"),r.AMBIENTSHBB=Ae.propertyNameToID("u_AmbientSHBb"),r.AMBIENTSHC=Ae.propertyNameToID("u_AmbientSHC"),r.REFLECTIONPROBE=Ae.propertyNameToID("u_ReflectionProbe"),r.REFLECTIONCUBE_HDR_PARAMS=Ae.propertyNameToID("u_ReflectCubeHDRParams"),r.LIGHTDIRECTION=Ae.propertyNameToID("u_DirectionLight.direction"),r.LIGHTDIRCOLOR=Ae.propertyNameToID("u_DirectionLight.color"),r.POINTLIGHTPOS=Ae.propertyNameToID("u_PointLight.position"),r.POINTLIGHTRANGE=Ae.propertyNameToID("u_PointLight.range"),r.POINTLIGHTATTENUATION=Ae.propertyNameToID("u_PointLight.attenuation"),r.POINTLIGHTCOLOR=Ae.propertyNameToID("u_PointLight.color"),r.SPOTLIGHTPOS=Ae.propertyNameToID("u_SpotLight.position"),r.SPOTLIGHTDIRECTION=Ae.propertyNameToID("u_SpotLight.direction"),r.SPOTLIGHTSPOTANGLE=Ae.propertyNameToID("u_SpotLight.spot"),r.SPOTLIGHTRANGE=Ae.propertyNameToID("u_SpotLight.range"),r.SPOTLIGHTCOLOR=Ae.propertyNameToID("u_SpotLight.color"),r.AMBIENTCOLOR=Ae.propertyNameToID("u_AmbientColor"),r.REFLECTIONTEXTURE=Ae.propertyNameToID("u_ReflectTexture"),r.TIME=Ae.propertyNameToID("u_Time"),r._configDefineValues=new ge,r})(),Er=(()=>{class e extends t.ShaderCompile{constructor(e,t,r,i){for(var n in super(t,r,null),this._cacheSharders={},this._cacheShaderHierarchy=1,this._renderState=new Oe,this._validDefine=new ge,this._tags={},this._owner=e,this._stateMap=i,this.defs)this._validDefine.add(Ae.getDefineByName(n))}get renderState(){return this._renderState}_compileToTree(e,r,i,n,a){var s,o,l,_,h,c,d,u,m,f,T;for(m=i;m<r.length;m++)if(!((l=r[m]).length<1)&&0!==(c=l.indexOf("//"))){if(c>=0&&(l=l.substr(0,c)),s=u||new t.ShaderNode(n),u=null,s.text=l,(c=l.indexOf("#"))>=0){for(_="#",T=c+1,f=l.length;T<f;T++){var E=l.charAt(T);if(" "===E||"\t"===E||"?"===E)break;_+=E}switch(s.name=_,_){case"#ifdef":case"#ifndef":if(s.setParent(e),e=s,a)for(d=l.substr(T).split(t.ShaderCompile._splitToWordExps3),T=0;T<d.length;T++)(l=d[T]).length&&(a[l]=!0);continue;case"#if":case"#elif":if(s.setParent(e),e=s,a)for(d=l.substr(T).split(t.ShaderCompile._splitToWordExps3),T=0;T<d.length;T++)(l=d[T]).length&&"defined"!=l&&(a[l]=!0);continue;case"#else":o=(e=e.parent).childs[e.childs.length-1],s.setParent(e),e=s;continue;case"#endif":o=(e=e.parent).childs[e.childs.length-1],s.setParent(e);continue;case"#include":d=t.ShaderCompile.splitToWords(l,null);var p=t.ShaderCompile.includes[d[1]];if(!p)throw"ShaderCompile error no this include file:"+d[1];if((c=d[0].indexOf("?"))<0){s.setParent(e),l=p.getWith("with"==d[2]?d[3]:null),this._compileToTree(s,l.split("\n"),0,n,a),s.text="";continue}s.setCondition(d[0].substr(c+1),t.ShaderCompile.IFDEF_YES),s.text=p.getWith("with"==d[2]?d[3]:null);break;case"#import":h=(d=t.ShaderCompile.splitToWords(l,null))[1],n.push({node:s,file:t.ShaderCompile.includes[h],ofs:s.text.length});continue}}else{if((o=e.childs[e.childs.length-1])&&!o.name){n.length>0&&t.ShaderCompile.splitToWords(l,o),u=s,o.text+="\n"+l;continue}n.length>0&&t.ShaderCompile.splitToWords(l,s)}s.setParent(e)}}_resizeCacheShaderMap(e,t,r){var i=this._cacheShaderHierarchy-1;if(t==i){for(var n in e)for(var a=e[n],s=0,o=r-i;s<o;s++)s==o-1?e[0]=a:e=e[0==s?n:0]={};this._cacheShaderHierarchy=r}else for(var n in e)this._resizeCacheShaderMap(e[n],++t,r)}_addDebugShaderVariantCollection(e,t,r){var i=Ae._debugShaderVariantInfo,n=this._owner,a=n._owner,s=e._mask;Ae._getNamesByDefineData(e,t),r.length=s.length;for(var o=0,l=s.length;o<l;o++)r[o]=s[o];i?i.setValue(a,a._subShaders.indexOf(n),n._passes.indexOf(this),t):Ae._debugShaderVariantInfo=i=new Re(a,a._subShaders.indexOf(n),n._passes.indexOf(this),t),Ae.debugShaderVariantCollection.add(i)}withCompile(r){var i,n=e._debugDefineString,a=e._debugDefineMask;r._intersectionDefineDatas(this._validDefine),Ae.debugMode&&(i=r._length,this._addDebugShaderVariantCollection(r,n,a)),r.addDefineDatas(Tr._configDefineValues);var s=this._cacheSharders,o=r._length;o>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(s,0,o),this._cacheShaderHierarchy=o);for(var l=r._mask,_=r._length-1,h=this._cacheShaderHierarchy-1,c=0;c<h;c++){var d=_<c?0:l[c],u=s[d];u||(s[d]=u={}),s=u}var m=_<h?0:l[h],f=s[m];if(f)return f;var T=e._defineString;Ae._getNamesByDefineData(r,T);var E,p,g=Q._config,S=g.lightClusterCount,R={},v="";t.WebGL._isWebGL2?(E="#version 300 es\n\n\t\t\t\t#define attribute in\n\t\t\t\t#define varying out\n\t\t\t\t#define texture2D texture\n",p="#version 300 es\n\n\t\t\t\t#define varying in\n\t\t\t\tout highp vec4 pc_fragColor;\n\t\t\t\t#define gl_FragColor pc_fragColor\n\t\t\t\t#define gl_FragDepthEXT gl_FragDepth\n\t\t\t\t#define texture2D texture\n\t\t\t\t#define textureCube texture\n\t\t\t\t#define texture2DProj textureProj\n\t\t\t\t#define texture2DLodEXT textureLod\n\t\t\t\t#define texture2DProjLodEXT textureProjLod\n\t\t\t\t#define textureCubeLodEXT textureLod\n\t\t\t\t#define texture2DGradEXT textureGrad\n\t\t\t\t#define texture2DProjGradEXT textureProjGrad\n\t\t\t\t#define textureCubeGradEXT textureGrad\n"):(E="",p="#ifdef GL_EXT_shader_texture_lod\n\t\t\t\t\t#extension GL_EXT_shader_texture_lod : enable\n\t\t\t\t#endif\n\t\t\t\t#if !defined(GL_EXT_shader_texture_lod)\n\t\t\t\t\t#define texture1DLodEXT texture1D\n\t\t\t\t\t#define texture2DLodEXT texture2D\n\t\t\t\t\t#define texture2DProjLodEXT texture2DProj\n\t\t\t\t\t#define texture3DLodEXT texture3D\n\t\t\t\t\t#define textureCubeLodEXT textureCube\n\t\t\t\t#endif\n"),v+="#define MAX_LIGHT_COUNT "+g.maxLightCount+"\n",v+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+g._maxAreaLightCountPerClusterAverage+"\n",v+="#define CLUSTER_X_COUNT "+S.x+"\n",v+="#define CLUSTER_Y_COUNT "+S.y+"\n",v+="#define CLUSTER_Z_COUNT "+S.z+"\n",v+="#define SHADER_CAPAILITY_LEVEL "+t.SystemUtils._shaderCapailityLevel+"\n";c=0;for(var A=T.length;c<A;c++){var I=T[c];v+="#define "+I+"\n",R[I]=!0}var x=this._VS.toscript(R,[]),C="";0==x[0].indexOf("#version")&&(C=x[0]+"\n",x.shift());var L=this._PS.toscript(R,[]),y="";if(0==L[0].indexOf("#version")&&(y=L[0]+"\n",L.shift()),f=new Be(C+E+v+x.join("\n"),y+p+v+L.join("\n"),this._owner._attributeMap||this._owner._owner._attributeMap,this._owner._uniformMap||this._owner._owner._uniformMap,this),s[m]=f,Ae.debugMode){var D="",M="";for(c=0,A=i;c<A;c++)M+=c==A-1?a[c]:a[c]+",";for(c=0,A=n.length;c<A;c++)D+=c==A-1?n[c]:n[c]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+M+"] DefineNames:["+D+"]","color:green")}return f}setTag(e,t){t?this._tags[e]=t:delete this._tags[e]}getTag(e){return this._tags[e]}}return e._defineString=[],e._debugDefineString=[],e._debugDefineMask=[],e})();class pr{constructor(e,t){this._flags={},this._passes=[],this._attributeMap=e,this._uniformMap=t}setFlag(e,t){t?this._flags[e]=t:delete this._flags[e]}getFlag(e){return this._flags[e]}addShaderPass(e,t,r=null,i="Forward"){var n=new Er(this,e,t,r);return n._pipelineMode=i,this._passes.push(n),n}}var gr;(gr=e.PBRSpecularSmoothnessSource||(e.PBRSpecularSmoothnessSource={}))[gr.SpecularTextureAlpha=0]="SpecularTextureAlpha",gr[gr.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";let Sr=(()=>{class e extends Ve{constructor(){super(),this.setShaderName("PBRSpecular"),this._shaderValues.setVector(e.SPECULARCOLOR,new n(.2,.2,.2,1))}static __init__(){e.SHADERDEFINE_SPECULARGLOSSTEXTURE=Ae.getDefineByName("SPECULARGLOSSTEXTURE"),e.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=Ae.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var t={a_Position:ht.MESH_POSITION0,a_Normal:ht.MESH_NORMAL0,a_Tangent0:ht.MESH_TANGENT0,a_Texcoord0:ht.MESH_TEXTURECOORDINATE0,a_Texcoord1:ht.MESH_TEXTURECOORDINATE1,a_BoneWeights:ht.MESH_BLENDWEIGHT0,a_BoneIndices:ht.MESH_BLENDINDICES0,a_MvpMatrix:ht.MESH_MVPMATRIX_ROW0,a_WorldMat:ht.MESH_WORLDMATRIX_ROW0},r={u_Bones:Ae.PERIOD_CUSTOM,u_MvpMatrix:Ae.PERIOD_SPRITE,u_WorldMat:Ae.PERIOD_SPRITE,u_LightmapScaleOffset:Ae.PERIOD_SPRITE,u_LightMap:Ae.PERIOD_SPRITE,u_LightMapDirection:Ae.PERIOD_SPRITE,u_CameraPos:Ae.PERIOD_CAMERA,u_View:Ae.PERIOD_CAMERA,u_ProjectionParams:Ae.PERIOD_CAMERA,u_Viewport:Ae.PERIOD_CAMERA,u_ViewProjection:Ae.PERIOD_CAMERA,u_AlphaTestValue:Ae.PERIOD_MATERIAL,u_AlbedoColor:Ae.PERIOD_MATERIAL,u_EmissionColor:Ae.PERIOD_MATERIAL,u_AlbedoTexture:Ae.PERIOD_MATERIAL,u_NormalTexture:Ae.PERIOD_MATERIAL,u_ParallaxTexture:Ae.PERIOD_MATERIAL,u_OcclusionTexture:Ae.PERIOD_MATERIAL,u_EmissionTexture:Ae.PERIOD_MATERIAL,u_Smoothness:Ae.PERIOD_MATERIAL,u_SmoothnessScale:Ae.PERIOD_MATERIAL,u_occlusionStrength:Ae.PERIOD_MATERIAL,u_NormalScale:Ae.PERIOD_MATERIAL,u_ParallaxScale:Ae.PERIOD_MATERIAL,u_TilingOffset:Ae.PERIOD_MATERIAL,u_SpecGlossTexture:Ae.PERIOD_MATERIAL,u_SpecularColor:Ae.PERIOD_MATERIAL,u_ReflectTexture:Ae.PERIOD_SCENE,u_ReflectIntensity:Ae.PERIOD_SCENE,u_AmbientColor:Ae.PERIOD_SCENE,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE,u_DirationLightCount:Ae.PERIOD_SCENE,u_LightBuffer:Ae.PERIOD_SCENE,u_LightClusterBuffer:Ae.PERIOD_SCENE,u_ShadowBias:Ae.PERIOD_SCENE,u_ShadowLightDirection:Ae.PERIOD_SCENE,u_ShadowMap:Ae.PERIOD_SCENE,u_ShadowParams:Ae.PERIOD_SCENE,u_ShadowSplitSpheres:Ae.PERIOD_SCENE,u_ShadowMatrices:Ae.PERIOD_SCENE,u_ShadowMapSize:Ae.PERIOD_SCENE,u_AmbientSHAr:Ae.PERIOD_SCENE,u_AmbientSHAg:Ae.PERIOD_SCENE,u_AmbientSHAb:Ae.PERIOD_SCENE,u_AmbientSHBr:Ae.PERIOD_SCENE,u_AmbientSHBg:Ae.PERIOD_SCENE,u_AmbientSHBb:Ae.PERIOD_SCENE,u_AmbientSHC:Ae.PERIOD_SCENE,u_ReflectionProbe:Ae.PERIOD_SCENE,u_ReflectCubeHDRParams:Ae.PERIOD_SCENE,"u_DirectionLight.direction":Ae.PERIOD_SCENE,"u_DirectionLight.color":Ae.PERIOD_SCENE,"u_PointLight.position":Ae.PERIOD_SCENE,"u_PointLight.range":Ae.PERIOD_SCENE,"u_PointLight.color":Ae.PERIOD_SCENE,"u_SpotLight.position":Ae.PERIOD_SCENE,"u_SpotLight.direction":Ae.PERIOD_SCENE,"u_SpotLight.range":Ae.PERIOD_SCENE,"u_SpotLight.spot":Ae.PERIOD_SCENE,"u_SpotLight.color":Ae.PERIOD_SCENE},i={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},n=Ae.add("PBRSpecular"),a=new pr(t,r);n.addSubShader(a),a.addShaderPass('#include "PBRVSInput.glsl";\r\n#include "Lighting.glsl";\r\n#include "PBRVertex.glsl";\r\n\r\nvoid main()\r\n{\r\n\tvertexForward();\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#define SETUP_BRDF_INPUT specularSetup\r\n\r\n#include "Lighting.glsl";\r\n#include "PBRFSInput.glsl";\r\n#include "LayaPBRBRDF.glsl";\r\n#include "GlobalIllumination.glsl";\r\n#include "Shadow.glsl"\r\n#include "PBRCore.glsl";\r\n\r\nvoid main()\r\n{\r\n\tfragmentForward();\r\n}',i,"Forward"),a.addShaderPass('#include "ShadowCasterVS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionCS =  shadowCasterVertex();\r\n\tgl_Position=remapGLPositionZ(positionCS);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "ShadowCasterFS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tgl_FragColor=shadowCasterFragment();\r\n}',i,"ShadowCaster")}get specularTexture(){return this._shaderValues.getTexture(e.SPECULARTEXTURE)}set specularTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_SPECULARGLOSSTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_SPECULARGLOSSTEXTURE),this._shaderValues.setTexture(e.SPECULARTEXTURE,t)}get specularColor(){return this._shaderValues.getVector(e.SPECULARCOLOR)}set specularColor(t){this._shaderValues.setVector(e.SPECULARCOLOR,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.SPECULARTEXTURE=Ae.propertyNameToID("u_SpecGlossTexture"),e.SPECULARCOLOR=Ae.propertyNameToID("u_SpecularColor"),e})();var Rr;(Rr=e.PBRMetallicSmoothnessSource||(e.PBRMetallicSmoothnessSource={}))[Rr.MetallicGlossTextureAlpha=0]="MetallicGlossTextureAlpha",Rr[Rr.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";let vr=(()=>{class e extends Ve{constructor(){super(),this._smoothnessSource=0,this.setShaderName("PBR"),this._shaderValues.setNumber(e.METALLIC,0)}static __init__(){e.SHADERDEFINE_METALLICGLOSSTEXTURE=Ae.getDefineByName("METALLICGLOSSTEXTURE"),e.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=Ae.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var t={a_Position:ht.MESH_POSITION0,a_Normal:ht.MESH_NORMAL0,a_Tangent0:ht.MESH_TANGENT0,a_Texcoord0:ht.MESH_TEXTURECOORDINATE0,a_Texcoord1:ht.MESH_TEXTURECOORDINATE1,a_BoneWeights:ht.MESH_BLENDWEIGHT0,a_BoneIndices:ht.MESH_BLENDINDICES0,a_MvpMatrix:ht.MESH_MVPMATRIX_ROW0,a_WorldMat:ht.MESH_WORLDMATRIX_ROW0},r={u_Bones:Ae.PERIOD_CUSTOM,u_MvpMatrix:Ae.PERIOD_SPRITE,u_WorldMat:Ae.PERIOD_SPRITE,u_LightmapScaleOffset:Ae.PERIOD_SPRITE,u_LightMap:Ae.PERIOD_SPRITE,u_LightMapDirection:Ae.PERIOD_SPRITE,u_CameraPos:Ae.PERIOD_CAMERA,u_View:Ae.PERIOD_CAMERA,u_ProjectionParams:Ae.PERIOD_CAMERA,u_Viewport:Ae.PERIOD_CAMERA,u_ViewProjection:Ae.PERIOD_CAMERA,u_AlphaTestValue:Ae.PERIOD_MATERIAL,u_AlbedoColor:Ae.PERIOD_MATERIAL,u_EmissionColor:Ae.PERIOD_MATERIAL,u_AlbedoTexture:Ae.PERIOD_MATERIAL,u_NormalTexture:Ae.PERIOD_MATERIAL,u_ParallaxTexture:Ae.PERIOD_MATERIAL,u_OcclusionTexture:Ae.PERIOD_MATERIAL,u_EmissionTexture:Ae.PERIOD_MATERIAL,u_Smoothness:Ae.PERIOD_MATERIAL,u_SmoothnessScale:Ae.PERIOD_MATERIAL,u_occlusionStrength:Ae.PERIOD_MATERIAL,u_NormalScale:Ae.PERIOD_MATERIAL,u_ParallaxScale:Ae.PERIOD_MATERIAL,u_TilingOffset:Ae.PERIOD_MATERIAL,u_MetallicGlossTexture:Ae.PERIOD_MATERIAL,u_Metallic:Ae.PERIOD_MATERIAL,u_ReflectTexture:Ae.PERIOD_SCENE,u_ReflectIntensity:Ae.PERIOD_SCENE,u_AmbientColor:Ae.PERIOD_SCENE,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE,u_DirationLightCount:Ae.PERIOD_SCENE,u_LightBuffer:Ae.PERIOD_SCENE,u_LightClusterBuffer:Ae.PERIOD_SCENE,u_ShadowBias:Ae.PERIOD_SCENE,u_ShadowLightDirection:Ae.PERIOD_SCENE,u_ShadowMap:Ae.PERIOD_SCENE,u_ShadowParams:Ae.PERIOD_SCENE,u_ShadowSplitSpheres:Ae.PERIOD_SCENE,u_ShadowMatrices:Ae.PERIOD_SCENE,u_ShadowMapSize:Ae.PERIOD_SCENE,u_AmbientSHAr:Ae.PERIOD_SCENE,u_AmbientSHAg:Ae.PERIOD_SCENE,u_AmbientSHAb:Ae.PERIOD_SCENE,u_AmbientSHBr:Ae.PERIOD_SCENE,u_AmbientSHBg:Ae.PERIOD_SCENE,u_AmbientSHBb:Ae.PERIOD_SCENE,u_AmbientSHC:Ae.PERIOD_SCENE,u_ReflectionProbe:Ae.PERIOD_SCENE,u_ReflectCubeHDRParams:Ae.PERIOD_SCENE,"u_DirectionLight.direction":Ae.PERIOD_SCENE,"u_DirectionLight.color":Ae.PERIOD_SCENE,"u_PointLight.position":Ae.PERIOD_SCENE,"u_PointLight.range":Ae.PERIOD_SCENE,"u_PointLight.color":Ae.PERIOD_SCENE,"u_SpotLight.position":Ae.PERIOD_SCENE,"u_SpotLight.direction":Ae.PERIOD_SCENE,"u_SpotLight.range":Ae.PERIOD_SCENE,"u_SpotLight.spot":Ae.PERIOD_SCENE,"u_SpotLight.color":Ae.PERIOD_SCENE},i={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},n=Ae.add("PBR"),a=new pr(t,r);n.addSubShader(a),a.addShaderPass('#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n#include "PBRVSInput.glsl";\r\n#include "PBRVertex.glsl";\r\n\r\nvoid main()\r\n{\r\n\tvertexForward();\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n#include "PBRFSInput.glsl";\r\n#include "LayaPBRBRDF.glsl";\r\n#include "GlobalIllumination.glsl";\r\n#include "PBRCore.glsl";\r\n\r\nvoid main()\r\n{\r\n\tfragmentForward();\r\n}',i,"Forward"),a.addShaderPass('#include "ShadowCasterVS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionCS =  shadowCasterVertex();\r\n\tgl_Position=remapGLPositionZ(positionCS);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "ShadowCasterFS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tgl_FragColor=shadowCasterFragment();\r\n}',i,"ShadowCaster")}get metallicGlossTexture(){return this._shaderValues.getTexture(e.METALLICGLOSSTEXTURE)}set metallicGlossTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_METALLICGLOSSTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(e.METALLICGLOSSTEXTURE,t)}get metallic(){return this._shaderValues.getNumber(e.METALLIC)}set metallic(t){this._shaderValues.setNumber(e.METALLIC,Math.max(0,Math.min(1,t)))}get smoothnessSource(){return this._smoothnessSource}set smoothnessSource(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA):this._shaderValues.removeDefine(e.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._smoothnessSource=t}clone(){var t=new e;return this.cloneTo(t),t}}return e.METALLICGLOSSTEXTURE=Ae.propertyNameToID("u_MetallicGlossTexture"),e.METALLIC=Ae.propertyNameToID("u_Metallic"),e})(),Ar=(()=>{class e extends De{constructor(){super(),this.setShaderName("SkyBox"),this.tintColor=new n(.5,.5,.5,.5),this.exposure=1,this.rotation=0}static __initDefine__(){}get tintColor(){return this._shaderValues.getVector(e.TINTCOLOR)}set tintColor(t){this._shaderValues.setVector(e.TINTCOLOR,t)}get exposure(){return this._shaderValues.getNumber(e.EXPOSURE)}set exposure(t){this._shaderValues.setNumber(e.EXPOSURE,t)}get rotation(){return this._shaderValues.getNumber(e.ROTATION)}set rotation(t){this._shaderValues.setNumber(e.ROTATION,t)}get textureCube(){return this._shaderValues.getTexture(e.TEXTURECUBE)}set textureCube(t){this._shaderValues.setTexture(e.TEXTURECUBE,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.TINTCOLOR=Ae.propertyNameToID("u_TintColor"),e.EXPOSURE=Ae.propertyNameToID("u_Exposure"),e.ROTATION=Ae.propertyNameToID("u_Rotation"),e.TEXTURECUBE=Ae.propertyNameToID("u_CubeTexture"),e})(),Ir=(()=>{class e extends De{constructor(){super(),this.setShaderName("SkyBoxProcedural"),this.sunDisk=e.SUN_HIGH_QUALITY,this.sunSize=.04,this.sunSizeConvergence=5,this.atmosphereThickness=1,this.skyTint=new n(.5,.5,.5,1),this.groundTint=new n(.369,.349,.341,1),this.exposure=1.3}static __initDefine__(){e.SHADERDEFINE_SUN_HIGH_QUALITY=Ae.getDefineByName("SUN_HIGH_QUALITY"),e.SHADERDEFINE_SUN_SIMPLE=Ae.getDefineByName("SUN_SIMPLE")}get sunDisk(){return this._sunDisk}set sunDisk(t){switch(t){case e.SUN_HIGH_QUALITY:this._shaderValues.removeDefine(e.SHADERDEFINE_SUN_SIMPLE),this._shaderValues.addDefine(e.SHADERDEFINE_SUN_HIGH_QUALITY);break;case e.SUN_SIMPLE:this._shaderValues.removeDefine(e.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.addDefine(e.SHADERDEFINE_SUN_SIMPLE);break;case e.SUN_NODE:this._shaderValues.removeDefine(e.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.removeDefine(e.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=t}get sunSize(){return this._shaderValues.getNumber(e.SUNSIZE)}set sunSize(t){t=Math.min(Math.max(0,t),1),this._shaderValues.setNumber(e.SUNSIZE,t)}get sunSizeConvergence(){return this._shaderValues.getNumber(e.SUNSIZECONVERGENCE)}set sunSizeConvergence(t){t=Math.min(Math.max(0,t),20),this._shaderValues.setNumber(e.SUNSIZECONVERGENCE,t)}get atmosphereThickness(){return this._shaderValues.getNumber(e.ATMOSPHERETHICKNESS)}set atmosphereThickness(t){t=Math.min(Math.max(0,t),5),this._shaderValues.setNumber(e.ATMOSPHERETHICKNESS,t)}get skyTint(){return this._shaderValues.getVector(e.SKYTINT)}set skyTint(t){this._shaderValues.setVector(e.SKYTINT,t)}get groundTint(){return this._shaderValues.getVector(e.GROUNDTINT)}set groundTint(t){this._shaderValues.setVector(e.GROUNDTINT,t)}get exposure(){return this._shaderValues.getNumber(e.EXPOSURE)}set exposure(t){t=Math.min(Math.max(0,t),8),this._shaderValues.setNumber(e.EXPOSURE,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.SUN_NODE=0,e.SUN_SIMPLE=1,e.SUN_HIGH_QUALITY=2,e.SUNSIZE=Ae.propertyNameToID("u_SunSize"),e.SUNSIZECONVERGENCE=Ae.propertyNameToID("u_SunSizeConvergence"),e.ATMOSPHERETHICKNESS=Ae.propertyNameToID("u_AtmosphereThickness"),e.SKYTINT=Ae.propertyNameToID("u_SkyTint"),e.GROUNDTINT=Ae.propertyNameToID("u_GroundTint"),e.EXPOSURE=Ae.propertyNameToID("u_Exposure"),e})(),xr=(()=>{class e extends De{constructor(){super(),this._albedoColor=new n(1,1,1,1),this._albedoIntensity=1,this._enableVertexColor=!1,this.setShaderName("Unlit"),this._shaderValues.setVector(e.ALBEDOCOLOR,new n(1,1,1,1)),this.renderMode=e.RENDERMODE_OPAQUE}static __initDefine__(){e.SHADERDEFINE_ALBEDOTEXTURE=Ae.getDefineByName("ALBEDOTEXTURE"),e.SHADERDEFINE_TILINGOFFSET=Ae.getDefineByName("TILINGOFFSET"),e.SHADERDEFINE_ENABLEVERTEXCOLOR=Ae.getDefineByName("ENABLEVERTEXCOLOR")}get _ColorR(){return this._albedoColor.x}set _ColorR(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}get _ColorG(){return this._albedoColor.y}set _ColorG(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}get _ColorB(){return this._albedoColor.z}set _ColorB(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}get _ColorA(){return this._albedoColor.w}set _ColorA(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}get _AlbedoIntensity(){return this._albedoIntensity}set _AlbedoIntensity(t){if(this._albedoIntensity!==t){var r=this._shaderValues.getVector(e.ALBEDOCOLOR);n.scale(this._albedoColor,t,r),this._albedoIntensity=t,this._shaderValues.setVector(e.ALBEDOCOLOR,r)}}get _MainTex_STX(){return this._shaderValues.getVector(e.TILINGOFFSET).x}set _MainTex_STX(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.x=t,this.tilingOffset=r}get _MainTex_STY(){return this._shaderValues.getVector(e.TILINGOFFSET).y}set _MainTex_STY(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.y=t,this.tilingOffset=r}get _MainTex_STZ(){return this._shaderValues.getVector(e.TILINGOFFSET).z}set _MainTex_STZ(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.z=t,this.tilingOffset=r}get _MainTex_STW(){return this._shaderValues.getVector(e.TILINGOFFSET).w}set _MainTex_STW(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.w=t,this.tilingOffset=r}get _Cutoff(){return this.alphaTestValue}set _Cutoff(e){this.alphaTestValue=e}get albedoColorR(){return this._ColorR}set albedoColorR(e){this._ColorR=e}get albedoColorG(){return this._ColorG}set albedoColorG(e){this._ColorG=e}get albedoColorB(){return this._ColorB}set albedoColorB(e){this._ColorB=e}get albedoColorA(){return this._ColorA}set albedoColorA(e){this._ColorA=e}get albedoColor(){return this._albedoColor}set albedoColor(t){var r=this._shaderValues.getVector(e.ALBEDOCOLOR);n.scale(t,this._albedoIntensity,r),this._albedoColor=t,this._shaderValues.setVector(e.ALBEDOCOLOR,r)}get albedoIntensity(){return this._albedoIntensity}set albedoIntensity(e){this._AlbedoIntensity=e}get albedoTexture(){return this._shaderValues.getTexture(e.ALBEDOTEXTURE)}set albedoTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(e.ALBEDOTEXTURE,t)}get tilingOffsetX(){return this._MainTex_STX}set tilingOffsetX(e){this._MainTex_STX=e}get tilingOffsetY(){return this._MainTex_STY}set tilingOffsetY(e){this._MainTex_STY=e}get tilingOffsetZ(){return this._MainTex_STZ}set tilingOffsetZ(e){this._MainTex_STZ=e}get tilingOffsetW(){return this._MainTex_STW}set tilingOffsetW(e){this._MainTex_STW=e}get tilingOffset(){return this._shaderValues.getVector(e.TILINGOFFSET)}set tilingOffset(t){t&&(1!=t.x||1!=t.y||0!=t.z||0!=t.w)?this._shaderValues.addDefine(e.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(e.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(e.TILINGOFFSET,t)}get enableVertexColor(){return this._enableVertexColor}set enableVertexColor(t){this._enableVertexColor=t,t?this._shaderValues.addDefine(e.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(e.SHADERDEFINE_ENABLEVERTEXCOLOR)}set renderMode(t){switch(t){case e.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=De.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS;break;case e.RENDERMODE_CUTOUT:this.renderQueue=De.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_DISABLE,this.depthTest=Oe.DEPTHTEST_LESS;break;case e.RENDERMODE_TRANSPARENT:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_BACK,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LESS;break;default:throw new Error("UnlitMaterial : renderMode value error.")}}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.RENDERMODE_OPAQUE=0,e.RENDERMODE_CUTOUT=1,e.RENDERMODE_TRANSPARENT=2,e.RENDERMODE_ADDTIVE=3,e.ALBEDOTEXTURE=Ae.propertyNameToID("u_AlbedoTexture"),e.ALBEDOCOLOR=Ae.propertyNameToID("u_AlbedoColor"),e.TILINGOFFSET=Ae.propertyNameToID("u_TilingOffset"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})(),Cr=(()=>{class e extends De{constructor(){super(),this.setShaderName("WaterPrimary"),this._shaderValues.setVector(e.HORIZONCOLOR,new n(.172,.463,.435,0)),this._shaderValues.setNumber(e.WAVESCALE,.15),this._shaderValues.setVector(e.WAVESPEED,new n(19,9,-16,-7))}static __initDefine__(){e.SHADERDEFINE_MAINTEXTURE=Ae.getDefineByName("MAINTEXTURE"),e.SHADERDEFINE_NORMALTEXTURE=Ae.getDefineByName("NORMALTEXTURE")}get horizonColor(){return this._shaderValues.getVector(e.HORIZONCOLOR)}set horizonColor(t){this._shaderValues.setVector(e.HORIZONCOLOR,t)}get mainTexture(){return this._shaderValues.getTexture(e.MAINTEXTURE)}set mainTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(e.MAINTEXTURE,t)}get normalTexture(){return this._shaderValues.getTexture(e.NORMALTEXTURE)}set normalTexture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(e.NORMALTEXTURE,t)}get waveScale(){return this._shaderValues.getNumber(e.WAVESCALE)}set waveScale(t){this._shaderValues.setNumber(e.WAVESCALE,t)}get waveSpeed(){return this._shaderValues.getVector(e.WAVESPEED)}set waveSpeed(t){this._shaderValues.setVector(e.WAVESPEED,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.HORIZONCOLOR=Ae.propertyNameToID("u_HorizonColor"),e.MAINTEXTURE=Ae.propertyNameToID("u_MainTexture"),e.NORMALTEXTURE=Ae.propertyNameToID("u_NormalTexture"),e.WAVESCALE=Ae.propertyNameToID("u_WaveScale"),e.WAVESPEED=Ae.propertyNameToID("u_WaveSpeed"),e})();class Lr{}class yr extends tr{constructor(e){super(e),this._revertStaticBatchDefineUV1=!1,this._projectionViewWorldMatrix=new h}_createRenderElement(){return new Kt}_onMeshChange(e){if(e){var t=e.subMeshCount;this._renderElements.length=t;for(var r=0;r<t;r++){var i=this._renderElements[r];if(!i){var n=this.sharedMaterials[r];(i=this._renderElements[r]=this._createRenderElement()).setTransform(this._owner._transform),i.render=this,i.material=n||Ne.defaultMaterial}i.setGeometry(e.getSubMesh(r))}}else this._renderElements.length=0;this._boundsChange=!0}_calculateBoundingBox(){var e=this._owner.meshFilter.sharedMesh;if(e){var r=this._owner.transform.worldMatrix;e.bounds._tranform(r,this._bounds)}if(t.Render.supportWebGLPlusCulling){var i=this._bounds.getMin(),n=this._bounds.getMax(),a=We._cullingBuffer;a[this._cullingBufferIndex+1]=i.x,a[this._cullingBufferIndex+2]=i.y,a[this._cullingBufferIndex+3]=i.z,a[this._cullingBufferIndex+4]=n.x,a[this._cullingBufferIndex+5]=n.y,a[this._cullingBufferIndex+6]=n.z}}_needRender(e,t){return!e||e.intersects(this.bounds._getBoundBox())}_renderUpdate(e,t){this._applyLightMapParams();var r=e.renderElement;switch(r.renderType){case Qt.RENDERTYPE_NORMAL:this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,t.worldMatrix);break;case Qt.RENDERTYPE_STATICBATCH:t?this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,t.worldMatrix):this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,h.DEFAULT),this._shaderValues.hasDefine(Lr.SHADERDEFINE_UV1)?this._revertStaticBatchDefineUV1=!1:(this._shaderValues.addDefine(Lr.SHADERDEFINE_UV1),this._revertStaticBatchDefineUV1=!0),this._shaderValues.setVector(jt.LIGHTMAPSCALEOFFSET,tr._defaultLightmapScaleOffset);break;case Qt.RENDERTYPE_VERTEXBATCH:this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,h.DEFAULT);break;case Qt.RENDERTYPE_INSTANCEBATCH:for(var i=qt.instance.instanceWorldMatrixData,n=r.instanceBatchElementList,a=n.elements,s=n.length,o=0;o<s;o++)i.set(a[o]._transform.worldMatrix.elements,16*o);var l=qt.instance.instanceWorldMatrixBuffer;l.orphanStorage(),l.setData(i.buffer,0,0,16*s*4),this._shaderValues.addDefine(Lr.SHADERDEFINE_GPU_INSTANCE)}}_renderUpdateWithCamera(e,t){var r=e.projectionViewMatrix;if(r){var i=e.renderElement;switch(i.renderType){case Qt.RENDERTYPE_NORMAL:case Qt.RENDERTYPE_STATICBATCH:case Qt.RENDERTYPE_VERTEXBATCH:t?(h.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ft.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(ft.MVPMATRIX,r);break;case Qt.RENDERTYPE_INSTANCEBATCH:for(var n=qt.instance.instanceMVPMatrixData,a=i.instanceBatchElementList,s=a.elements,o=a.length,l=0;l<o;l++){var _=s[l]._transform.worldMatrix;k.mulMatrixByArray(r.elements,0,_.elements,0,n,16*l)}var c=qt.instance.instanceMVPMatrixBuffer;c.orphanStorage(),c.setData(n.buffer,0,0,16*o*4)}}}_revertBatchRenderUpdate(e){switch(e.renderElement.renderType){case Qt.RENDERTYPE_STATICBATCH:this._revertStaticBatchDefineUV1&&this._shaderValues.removeDefine(Lr.SHADERDEFINE_UV1),this._shaderValues.setVector(jt.LIGHTMAPSCALEOFFSET,this.lightmapScaleOffset);break;case Qt.RENDERTYPE_INSTANCEBATCH:this._shaderValues.removeDefine(Lr.SHADERDEFINE_GPU_INSTANCE)}}_destroy(){this._isPartOfStaticBatch&&er.instance._removeRenderSprite(this._owner),super._destroy()}}let Dr=(()=>{class e{constructor(e){this._owner=e}get sharedMesh(){return this._sharedMesh}set sharedMesh(t){if(this._sharedMesh!==t){var r=this._owner._render._shaderValues,i=this._sharedMesh;if(i){i._removeReference(),this._getMeshDefine(i,e._meshVerticeDefine);for(var n=0,a=e._meshVerticeDefine.length;n<a;n++)r.removeDefine(e._meshVerticeDefine[n])}if(t){t._addReference(),this._getMeshDefine(t,e._meshVerticeDefine);for(n=0,a=e._meshVerticeDefine.length;n<a;n++)r.addDefine(e._meshVerticeDefine[n])}this._owner._render._onMeshChange(t),this._sharedMesh=t}}_getMeshDefine(e,t){t.length=0;for(var r=0,i=e._subMeshes.length;r<i;r++)for(var n=e.getSubMesh(r)._vertexBuffer._vertexDeclaration._vertexElements,a=0,s=n.length;a<s;a++){switch(n[a]._elementUsage){case ht.MESH_COLOR0:t.push(Lr.SHADERDEFINE_COLOR);break;case ht.MESH_TEXTURECOORDINATE0:t.push(Lr.SHADERDEFINE_UV0);break;case ht.MESH_TEXTURECOORDINATE1:t.push(Lr.SHADERDEFINE_UV1)}}}destroy(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)}}return e._meshVerticeDefine=[],e})(),Mr=(()=>{class r extends kt{constructor(){super(),this._bufferState=new nt;var i=t.LayaGL.instance,n=ht.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride*r.maxIndicesCount;this._vertices=new Float32Array(n/4),this._vertexBuffer=new ct(n,i.DYNAMIC_DRAW),this._indices=new Int16Array(r.maxIndicesCount),this._indexBuffer=new st(e.IndexFormat.UInt16,this._indices.length,i.DYNAMIC_DRAW);var a=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addMemory(a,a)}static __init__(){r.instance=new r}_getBatchVertices(e,t,r,i,n,a){var s=e.vertexStride/4,o=a._vertexBuffer.getFloat32Data(),l=(n.render.lightmapScaleOffset,n._dynamicMultiSubMesh),_=n._dynamicVertexCount;n._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,l,_);for(var h=n._dynamicWorldPositions,c=n._dynamicWorldNormals,d=a._indices,u=0;u<_;u++){var m=(l?d[u]:u)*s,f=(u+r)*s,T=3*u,E=f+this._positionOffset;t[E]=h[T],t[E+1]=h[T+1],t[E+2]=h[T+2],-1!==this._normalOffset&&(t[E=f+this._normalOffset]=c[T],t[E+1]=c[T+1],t[E+2]=c[T+2]),-1!==this._colorOffset&&(E=f+this._colorOffset,T=m+this._colorOffset,t[E]=o[T],t[E+1]=o[T+1],t[E+2]=o[T+2],t[E+3]=o[T+3]),-1!==this._uv0Offset&&(E=f+this._uv0Offset,T=m+this._uv0Offset,t[E]=o[T],t[E+1]=o[T+1]),-1!==this._sTangentOffset&&(E=f+this._sTangentOffset,T=m+this._sTangentOffset,t[E]=o[T],t[E+1]=o[T+1],t[E+2]=o[T+2],t[E+3]=o[T+3],E=f+this._sTangentOffset,T=m+this._sTangentOffset,t[E]=o[T],t[E+1]=o[T+1],t[E+2]=o[T+2],t[E+3]=o[T+3])}}_getBatchIndices(e,t,r,i,n,a){var s,o,l,_=n._indices,h=i._isFrontFaceInvert;if(a)if(h)for(s=0,o=_.length;s<o;s+=3){var c=r+s;e[l=t+s]=c,e[l+1]=c+2,e[l+2]=c+1}else for(s=0,o=_.length;s<o;s+=3)c=r+s,e[l=t+s]=c,e[l+1]=c+1,e[l+2]=c+2;else if(h)for(s=0,o=_.length;s<o;s+=3)e[l=t+s]=r+_[s],e[l+1]=r+_[s+2],e[l+2]=r+_[s+1];else for(s=0,o=_.length;s<o;s+=3)e[l=t+s]=r+_[s],e[l+1]=r+_[s+1],e[l+2]=r+_[s+2]}_flush(e,r){var i=t.LayaGL.instance;this._vertexBuffer.setData(this._vertices.buffer,0,0,e*this._bufferState.vertexDeclaration.vertexStride),this._indexBuffer.setData(this._indices,0,0,r),i.drawElements(i.TRIANGLES,r,i.UNSIGNED_SHORT,0)}_prepareRender(e){var t=e.renderElement.vertexBatchVertexDeclaration;this._bufferState=l.MeshRenderDynamicBatchManager.instance._getBufferState(t),this._positionOffset=t.getVertexElementByUsage(ht.MESH_POSITION0)._offset/4;var r=t.getVertexElementByUsage(ht.MESH_NORMAL0);this._normalOffset=r?r._offset/4:-1;var i=t.getVertexElementByUsage(ht.MESH_COLOR0);this._colorOffset=i?i._offset/4:-1;var n=t.getVertexElementByUsage(ht.MESH_TEXTURECOORDINATE0);this._uv0Offset=n?n._offset/4:-1;var a=t.getVertexElementByUsage(ht.MESH_TEXTURECOORDINATE1);this._uv1Offset=a?a._offset/4:-1;var s=t.getVertexElementByUsage(ht.MESH_TANGENT0);return this._sTangentOffset=s?s._offset/4:-1,!0}_render(e){this._bufferState.bind();for(var i=e.renderElement,n=i.vertexBatchVertexDeclaration,a=i.vertexBatchElementList,s=0,o=0,l=(n.vertexStride,0),_=a.length,h=a.elements,c=0;c<_;c++){var d=h[c],u=d._geometry,m=u._indexCount;o+m>r.maxIndicesCount&&(this._flush(s,o),l++,t.Stat.trianglesFaces+=o/3,s=o=0);var f=d._transform;this._getBatchVertices(n,this._vertices,s,f,d,u),this._getBatchIndices(this._indices,o,s,f,u,d._dynamicMultiSubMesh),s+=d._dynamicVertexCount,o+=m}this._flush(s,o),l++,t.Stat.renderBatches+=l,t.Stat.savedRenderBatches+=_-l,t.Stat.trianglesFaces+=o/3}}return r.maxAllowVertexCount=10,r.maxAllowAttribueCount=900,r.maxIndicesCount=32e3,r})(),Or=(()=>{class e extends mr{constructor(){super(),this._instanceBatchOpaqueMarks=[],this._vertexBatchOpaqueMarks=[],this._cacheBufferStates=[],this._updateCountMark=0}getInstanceBatchOpaquaMark(e,t,r,i){var n=this._instanceBatchOpaqueMarks[e?0:1]||(this._instanceBatchOpaqueMarks[e?0:1]=[]),a=n[t]||(n[t]=[]),s=a[r]||(a[r]=[]);return s[i?1:0]||(s[i?1:0]=new Zt)}getVertexBatchOpaquaMark(e,t,r,i){var n=this._vertexBatchOpaqueMarks[e]||(this._vertexBatchOpaqueMarks[e]=[]),a=n[t?0:1]||(n[t?0:1]=[]),s=a[r]||(a[r]=[]);return s[i]||(s[i]=new Zt)}_getBufferState(e){var t=this._cacheBufferStates[e.id];if(!t){var r=Mr.instance;(t=new nt).bind();var i=r._vertexBuffer;i.vertexDeclaration=e,t.applyVertexBuffer(i),t.applyIndexBuffer(r._indexBuffer),t.unBind(),this._cacheBufferStates[e.id]=t}return t}_getBatchRenderElementFromPool(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new Kt,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.vertexBatchElementList=new E,e.instanceBatchElementList=new E),e}_clear(){super._clear(),this._updateCountMark++}}return e.instance=new e,e})();class Nr extends jt{constructor(e=null,t=null){super(t),this._meshFilter=new Dr(this),this._render=new yr(this),e&&(this._meshFilter.sharedMesh=e)}static __init__(){Lr.SHADERDEFINE_UV0=Ae.getDefineByName("UV"),Lr.SHADERDEFINE_COLOR=Ae.getDefineByName("COLOR"),Lr.SHADERDEFINE_UV1=Ae.getDefineByName("UV1"),Lr.SHADERDEFINE_GPU_INSTANCE=Ae.getDefineByName("GPU_INSTANCE"),Jt._registerManager(er.instance),mr._registerManager(Or.instance)}get meshFilter(){return this._meshFilter}get meshRenderer(){return this._render}_parse(e,r){super._parse(e,r);var i=this.meshRenderer,a=e.lightmapIndex;null!=a&&(i.lightmapIndex=a);var s=e.lightmapScaleOffset;s&&(i.lightmapScaleOffset=new n(s[0],s[1],s[2],s[3])),null!=e.meshPath&&(this.meshFilter.sharedMesh=t.Loader.getRes(e.meshPath)),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow);var o=e.materials;if(o){var l=i.sharedMaterials,_=o.length;l.length=_;for(var h=0;h<_;h++)l[h]=t.Loader.getRes(o[h].path);i.sharedMaterials=l}}_addToInitStaticBatchManager(){this.meshFilter.sharedMesh&&er.instance._addBatchSprite(this)}_cloneTo(e,t,r){var i=e;i._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var n=this._render,a=i._render;a.enable=n.enable,a.sharedMaterials=n.sharedMaterials,a.castShadow=n.castShadow;var s=n.lightmapScaleOffset;s&&(a.lightmapScaleOffset=s.clone()),a.lightmapIndex=n.lightmapIndex,a.receiveShadow=n.receiveShadow,a.sortingFudge=n.sortingFudge,super._cloneTo(e,t,r)}destroy(e=!0){this.destroyed||(super.destroy(e),this._meshFilter.destroy())}_create(){return new Nr}}let br=(()=>{class e{}return e.Blend=0,e.Fixed=1,e})();class Pr{constructor(e,t){this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=e,this._maxColorAlphaKeysCount=t,this._rgbElements=new Float32Array(4*e),this._alphaElements=new Float32Array(2*t)}get mode(){return this._mode}set mode(e){this._mode=e}get colorRGBKeysCount(){return this._colorRGBKeysCount}get colorAlphaKeysCount(){return this._colorAlphaKeysCount}get maxColorRGBKeysCount(){return this._maxColorRGBKeysCount}get maxColorAlphaKeysCount(){return this._maxColorAlphaKeysCount}addColorRGB(e,t){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var r=4*this._colorRGBKeysCount;this._rgbElements[r]=e,this._rgbElements[r+1]=t.r,this._rgbElements[r+2]=t.g,this._rgbElements[r+3]=t.b,this._colorRGBKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount)}addColorAlpha(e,t){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var r=2*this._colorAlphaKeysCount;this._alphaElements[r]=e,this._alphaElements[r+1]=t,this._colorAlphaKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount)}updateColorRGB(e,t,r){if(e<this._colorRGBKeysCount){var i=4*e;this._rgbElements[i]=t,this._rgbElements[i+1]=r.r,this._rgbElements[i+2]=r.g,this._rgbElements[i+3]=r.b}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}updateColorAlpha(e,t,r){if(e<this._colorAlphaKeysCount){var i=2*e;this._alphaElements[i]=t,this._alphaElements[i+1]=r}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}evaluateColorRGB(e,t,r=0,i=!1){e=Math.min(Math.max(e,0),1);var n=this._rgbElements,a=r;if(i)for(var s=a;s>=0;s--){var o=4*s;if(e===(u=n[o]))return t.r=n[o+1],t.g=n[o+2],t.b=n[o+3],a;switch(this._mode){case br.Blend:if(e>u){if(e>(d=n[o+4]))throw"Gradient:wrong startSearchIndex.";var l=d-u,_=d-e,h=e-u;return t.r=(_*n[o+1]+h*n[o+5])/l,t.g=(_*n[o+2]+h*n[o+6])/l,t.b=(_*n[o+3]+h*n[o+7])/l,a}a--;continue;case br.Fixed:if(e>u){if(e>n[o+4])throw"Gradient:wrong startSearchIndex.";return t.r=n[o+5],t.g=n[o+6],t.b=n[o+7],a}a--;continue;default:throw"Gradient:unknown mode."}}else{s=0;for(var c=this._rgbElements.length;s<c;s++){var d;if(e===(d=n[o=4*s]))return t.r=n[o+1],t.g=n[o+2],t.b=n[o+3],a;switch(this._mode){case br.Blend:if(e<d){var u;if(e<(u=n[o-4]))throw"Gradient:wrong startSearchIndex.";l=d-u,_=d-e,h=e-u;return t.r=(_*n[o-3]+h*n[o+1])/l,t.g=(_*n[o-2]+h*n[o+2])/l,t.b=(_*n[o-1]+h*n[o+3])/l,a}a++;continue;case br.Fixed:if(e<d){if(e<n[o-4])throw"Gradient:wrong startSearchIndex.";return t.r=n[o+1],t.g=n[o+2],t.b=n[o+3],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}evaluateColorAlpha(e,t,r=0,i=!1){e=Math.min(Math.max(e,0),1);var n=this._alphaElements,a=r;if(i)for(var s=a;s>=0;s--){if(e===(u=n[c=2*s]))return t.a=n[c+1],a;switch(this._mode){case br.Blend:if(e>u){if(e>(d=n[c+2]))throw"Gradient:wrong startSearchIndex.";var o=d-u,l=d-e,_=e-u;return t.a=(l*n[c+1]+_*n[c+3])/o,a}a--;continue;case br.Fixed:if(e>u){if(e>n[c+2])throw"Gradient:wrong startSearchIndex.";return t.a=n[c+3],a}a--;continue;default:throw"Gradient:unknown mode."}}else{s=a;for(var h=this._alphaElements.length;s<h;s++){var c,d;if(e===(d=n[c=2*s]))return t.a=n[c+1],a;switch(this._mode){case br.Blend:if(e<d){var u;if(e<(u=n[c-2]))throw"Gradient:wrong startSearchIndex.";o=d-u,l=d-e,_=e-u;return t.a=(l*n[c-1]+_*n[c+1])/o,a}a++;continue;case br.Fixed:if(e<d){if(e<n[c-2])throw"Gradient:wrong startSearchIndex.";return t.a=n[c+1],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}cloneTo(e){var t,r,i=e;i._colorAlphaKeysCount=this._colorAlphaKeysCount;var n=i._alphaElements;for(t=0,r=this._alphaElements.length;t<r;t++)n[t]=this._alphaElements[t];i._colorRGBKeysCount=this._colorRGBKeysCount;var a=i._rgbElements;for(t=0,r=this._rgbElements.length;t<r;t++)a[t]=this._rgbElements[t]}clone(){var e=new Pr(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(e),e}}class wr{constructor(e,t,r){this._time=e,this._minCount=t,this._maxCount=r}get time(){return this._time}get minCount(){return this._minCount}get maxCount(){return this._maxCount}cloneTo(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount}clone(){var e=new wr(this._time,this._minCount,this._maxCount);return this.cloneTo(e),e}}class Vr{constructor(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}static createByConstant(e){var t=new Vr;return t._type=0,t._constant=e,t}static createByGradient(e){var t=new Vr;return t._type=1,t._gradient=e,t}static createByRandomTwoConstant(e,t){var r=new Vr;return r._type=2,r._constantMin=e,r._constantMax=t,r}static createByRandomTwoGradient(e,t){var r=new Vr;return r._type=3,r._gradientMin=e,r._gradientMax=t,r}get type(){return this._type}get constant(){return this._constant}get constantMin(){return this._constantMin}get constantMax(){return this._constantMax}get gradient(){return this._gradient}get gradientMin(){return this._gradientMin}get gradientMax(){return this._gradientMax}cloneTo(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)}clone(){var e=new Vr;return this.cloneTo(e),e}}class Fr{constructor(e){this._color=e}get color(){return this._color}cloneTo(e){var t=e;this._color.cloneTo(t._color),t.enable=this.enable}clone(){var e;switch(this._color.type){case 0:e=Vr.createByConstant(this._color.constant.clone());break;case 1:e=Vr.createByGradient(this._color.gradient.clone());break;case 2:e=Vr.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=Vr.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new Fr(e);return t.enable=this.enable,t}}class Br{constructor(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}static createByConstant(e=0){var t=new Br;return t._type=0,t._constant=e,t}static createByOverTime(e){var t=new Br;return t._type=1,t._overTime=e,t}static createByRandomTwoConstant(e=0,t=0){var r=new Br;return r._type=2,r._constantMin=e,r._constantMax=t,r}static createByRandomTwoOverTime(e,t){var r=new Br;return r._type=3,r._overTimeMin=e,r._overTimeMax=t,r}get type(){return this._type}get constant(){return this._constant}get frameOverTimeData(){return this._overTime}get constantMin(){return this._constantMin}get constantMax(){return this._constantMax}get frameOverTimeDataMin(){return this._overTimeMin}get frameOverTimeDataMax(){return this._overTimeMax}cloneTo(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime&&this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin&&this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax&&this._overTimeMax.cloneTo(t._overTimeMax)}clone(){var e=new Br;return this.cloneTo(e),e}}class Ur{constructor(){this._type=0,this._separateAxes=!1,this._constant=0,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}static createByConstant(e){var t=new Ur;return t._type=0,t._separateAxes=!1,t._constant=e,t}static createByConstantSeparate(e){var t=new Ur;return t._type=0,t._separateAxes=!0,t._constantSeparate=e,t}static createByGradient(e){var t=new Ur;return t._type=1,t._separateAxes=!1,t._gradient=e,t}static createByGradientSeparate(e,t,r){var i=new Ur;return i._type=1,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=r,i}static createByRandomTwoConstant(e,t){var r=new Ur;return r._type=2,r._separateAxes=!1,r._constantMin=e,r._constantMax=t,r}static createByRandomTwoConstantSeparate(e,t){var r=new Ur;return r._type=2,r._separateAxes=!0,r._constantMinSeparate=e,r._constantMaxSeparate=t,r}static createByRandomTwoGradient(e,t){var r=new Ur;return r._type=3,r._separateAxes=!1,r._gradientMin=e,r._gradientMax=t,r}static createByRandomTwoGradientSeparate(e,t,r,i,n,a,s,o){var l=new Ur;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=t,l._gradientYMin=r,l._gradientYMax=i,l._gradientZMin=n,l._gradientZMax=a,l._gradientWMin=s,l._gradientWMax=o,l}get type(){return this._type}get separateAxes(){return this._separateAxes}get constant(){return this._constant}get constantSeparate(){return this._constantSeparate}get gradient(){return this._gradient}get gradientX(){return this._gradientX}get gradientY(){return this._gradientY}get gradientZ(){return this._gradientZ}get gradientW(){return this._gradientW}get constantMin(){return this._constantMin}get constantMax(){return this._constantMax}get constantMinSeparate(){return this._constantMinSeparate}get constantMaxSeparate(){return this._constantMaxSeparate}get gradientMin(){return this._gradientMin}get gradientMax(){return this._gradientMax}get gradientXMin(){return this._gradientXMin}get gradientXMax(){return this._gradientXMax}get gradientYMin(){return this._gradientYMin}get gradientYMax(){return this._gradientYMax}get gradientZMin(){return this._gradientZMin}get gradientZMax(){return this._gradientZMax}get gradientWMin(){return this._gradientWMin}get gradientWMax(){return this._gradientWMax}cloneTo(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}clone(){var e=new Ur;return this.cloneTo(e),e}}class Gr{constructor(){this._currentLength=0,this._elements=new Float32Array(8)}get gradientCount(){return this._currentLength/2}add(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")}cloneTo(e){var t=e;t._currentLength=this._currentLength;for(var r=t._elements,i=0,n=this._elements.length;i<n;i++)r[i]=this._elements[i]}clone(){var e=new Gr;return this.cloneTo(e),e}}class zr{constructor(){this._currentLength=0,this._elements=new Float32Array(8)}get gradientCount(){return this._currentLength/2}add(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")}getKeyByIndex(e){return this._elements[2*e]}getValueByIndex(e){return this._elements[2*e+1]}getAverageValue(){for(var e=0,t=this._currentLength-2;e<t;e+=2){this._elements[e+1];this._elements[e+3],this._elements[e+2]-this._elements[e]}return 0}cloneTo(e){var t=e;t._currentLength=this._currentLength;for(var r=t._elements,i=0,n=this._elements.length;i<n;i++)r[i]=this._elements[i]}clone(){var e=new zr;return this.cloneTo(e),e}}class Hr{constructor(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}static createByGradient(e){var t=new Hr;return t._type=0,t._separateAxes=!1,t._gradient=e,t}static createByGradientSeparate(e,t,r){var i=new Hr;return i._type=0,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=r,i}static createByRandomTwoConstant(e,t){var r=new Hr;return r._type=1,r._separateAxes=!1,r._constantMin=e,r._constantMax=t,r}static createByRandomTwoConstantSeparate(e,t){var r=new Hr;return r._type=1,r._separateAxes=!0,r._constantMinSeparate=e,r._constantMaxSeparate=t,r}static createByRandomTwoGradient(e,t){var r=new Hr;return r._type=2,r._separateAxes=!1,r._gradientMin=e,r._gradientMax=t,r}static createByRandomTwoGradientSeparate(e,t,r,i,n,a){var s=new Hr;return s._type=2,s._separateAxes=!0,s._gradientXMin=e,s._gradientXMax=t,s._gradientYMin=r,s._gradientYMax=i,s._gradientZMin=n,s._gradientZMax=a,s}get type(){return this._type}get separateAxes(){return this._separateAxes}get gradient(){return this._gradient}get gradientX(){return this._gradientX}get gradientY(){return this._gradientY}get gradientZ(){return this._gradientZ}get constantMin(){return this._constantMin}get constantMax(){return this._constantMax}get constantMinSeparate(){return this._constantMinSeparate}get constantMaxSeparate(){return this._constantMaxSeparate}get gradientMin(){return this._gradientMin}get gradientMax(){return this._gradientMax}get gradientXMin(){return this._gradientXMin}get gradientXMax(){return this._gradientXMax}get gradientYMin(){return this._gradientYMin}get gradientYMax(){return this._gradientYMax}get gradientZMin(){return this._gradientZMin}get gradientZMax(){return this._gradientZMax}getMaxSizeInGradient(){var e,t,r=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)r=Math.max(r,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)r=Math.max(r,this._gradientY.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)r=Math.max(r,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(r=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),r=Math.max(r,this._constantMinSeparate.y),r=Math.max(r,this._constantMaxSeparate.y)):r=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)r=Math.max(r,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)r=Math.max(r,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)r=Math.max(r,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)r=Math.max(r,this._gradientZMax.getValueByIndex(e))}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)r=Math.max(r,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)r=Math.max(r,this._gradientMax.getValueByIndex(e))}}return r}cloneTo(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}clone(){var e=new Hr;return this.cloneTo(e),e}}class Wr{constructor(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}static createByConstant(e){var t=new Wr;return t._type=0,t._constant=e,t}static createByGradient(e,t,r){var i=new Wr;return i._type=1,i._gradientX=e,i._gradientY=t,i._gradientZ=r,i}static createByRandomTwoConstant(e,t){var r=new Wr;return r._type=2,r._constantMin=e,r._constantMax=t,r}static createByRandomTwoGradient(e,t,r,i,n,a){var s=new Wr;return s._type=3,s._gradientXMin=e,s._gradientXMax=t,s._gradientYMin=r,s._gradientYMax=i,s._gradientZMin=n,s._gradientZMax=a,s}get type(){return this._type}get constant(){return this._constant}get gradientX(){return this._gradientX}get gradientY(){return this._gradientY}get gradientZ(){return this._gradientZ}get constantMin(){return this._constantMin}get constantMax(){return this._constantMax}get gradientXMin(){return this._gradientXMin}get gradientXMax(){return this._gradientXMax}get gradientYMin(){return this._gradientYMin}get gradientYMax(){return this._gradientYMax}get gradientZMin(){return this._gradientZMin}get gradientZMax(){return this._gradientZMax}cloneTo(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}clone(){var e=new Wr;return this.cloneTo(e),e}}class kr{constructor(e){this._angularVelocity=e}get angularVelocity(){return this._angularVelocity}cloneTo(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enable=this.enable}clone(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?Ur.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):Ur.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?Ur.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):Ur.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?Ur.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):Ur.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?Ur.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):Ur.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new kr(e);return t.enable=this.enable,t}}class Xr{constructor(){this.enable=!0,this.randomDirection=0}_getShapeBoundBox(e){throw new Error("BaseShape: must override it.")}_getSpeedBoundBox(e){throw new Error("BaseShape: must override it.")}generatePositionAndDirection(e,t,r=null,i=null){throw new Error("BaseShape: must override it.")}_calculateProceduralBounds(e,t,r){this._getShapeBoundBox(e);var i=e.min,n=e.max;a.multiply(i,t,i),a.multiply(n,t,n);var s=new Ht(new a,new a);this.randomDirection?(s.min=new a(-1,-1,-1),s.max=new a(1,1,1)):this._getSpeedBoundBox(s);var o=new Ht(new a,new a),l=o.min,_=o.max;a.scale(s.min,r.y,l),a.scale(s.max,r.y,_),a.add(e.min,l,l),a.add(e.max,_,_),a.min(e.min,l,e.min),a.max(e.max,l,e.max);var h=new Ht(new a,new a),c=h.min,d=h.max;a.scale(s.min,r.x,c),a.scale(s.max,r.x,d),a.min(h.min,d,l),a.max(h.min,d,_),a.min(e.min,l,e.min),a.max(e.max,l,e.max)}cloneTo(e){e.enable=this.enable}clone(){var e=new Xr;return this.cloneTo(e),e}}class Yr{static _randomPointUnitArcCircle(e,t,r=null){var i;i=r?r.getFloat()*e:Math.random()*e,t.x=Math.cos(i),t.y=Math.sin(i)}static _randomPointInsideUnitArcCircle(e,t,r=null){var i;Yr._randomPointUnitArcCircle(e,t,r),i=r?Math.pow(r.getFloat(),.5):Math.pow(Math.random(),.5),t.x=t.x*i,t.y=t.y*i}static _randomPointUnitCircle(e,t=null){var r;r=t?t.getFloat()*Math.PI*2:Math.random()*Math.PI*2,e.x=Math.cos(r),e.y=Math.sin(r)}static _randomPointInsideUnitCircle(e,t=null){var r;Yr._randomPointUnitCircle(e),r=t?Math.pow(t.getFloat(),.5):Math.pow(Math.random(),.5),e.x=e.x*r,e.y=e.y*r}static _randomPointUnitSphere(e,t=null){var r,i;t?(r=e.z=2*t.getFloat()-1,i=t.getFloat()*Math.PI*2):(r=e.z=2*Math.random()-1,i=Math.random()*Math.PI*2);var n=Math.sqrt(1-r*r);e.x=n*Math.cos(i),e.y=n*Math.sin(i)}static _randomPointInsideUnitSphere(e,t=null){var r;Yr._randomPointUnitSphere(e),r=t?Math.pow(t.getFloat(),1/3):Math.pow(Math.random(),1/3),e.x=e.x*r,e.y=e.y*r,e.z=e.z*r}static _randomPointInsideHalfUnitBox(e,t=null){t?(e.x=t.getFloat()-.5,e.y=t.getFloat()-.5,e.z=t.getFloat()-.5):(e.x=Math.random()-.5,e.y=Math.random()-.5,e.z=Math.random()-.5)}constructor(){}}class jr extends Xr{constructor(){super(),this.x=1,this.y=1,this.z=1}_getShapeBoundBox(e){var t=e.min;t.x=.5*-this.x,t.y=.5*-this.y,t.z=.5*-this.z;var r=e.max;r.x=.5*this.x,r.y=.5*this.y,r.z=.5*this.z}_getSpeedBoundBox(e){var t=e.min;t.x=0,t.y=0,t.z=0;var r=e.max;r.x=0,r.y=1,r.z=0}generatePositionAndDirection(e,t,r=null,i=null){r?(r.seed=i[16],Yr._randomPointInsideHalfUnitBox(e,r),i[16]=r.seed):Yr._randomPointInsideHalfUnitBox(e),e.x=this.x*e.x,e.y=this.y*e.y,e.z=this.z*e.z,this.randomDirection?r?(r.seed=i[17],Yr._randomPointUnitSphere(t,r),i[17]=r.seed):Yr._randomPointUnitSphere(t):(t.x=0,t.y=0,t.z=1)}cloneTo(e){super.cloneTo(e);var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.randomDirection=this.randomDirection}clone(){var e=new jr;return this.cloneTo(e),e}}let Zr=(()=>{class e extends Xr{constructor(){super(),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1}_getShapeBoundBox(e){var t=e.min;t.x=t.z=-this.radius,t.y=0;var r=e.max;r.x=r.z=this.radius,r.y=0}_getSpeedBoundBox(e){var t=e.min;t.x=t.y=-1,t.z=0;var r=e.max;r.x=r.y=1,r.z=0}generatePositionAndDirection(t,r,i=null,n=null){var s=e._tempPositionPoint;i?(i.seed=n[16],this.emitFromEdge?Yr._randomPointUnitArcCircle(this.arc,e._tempPositionPoint,i):Yr._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint,i),n[16]=i.seed):this.emitFromEdge?Yr._randomPointUnitArcCircle(this.arc,e._tempPositionPoint):Yr._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint),t.x=-s.x,t.y=s.y,t.z=0,a.scale(t,this.radius,t),this.randomDirection?i?(i.seed=n[17],Yr._randomPointUnitSphere(r,i),n[17]=i.seed):Yr._randomPointUnitSphere(r):t.cloneTo(r)}cloneTo(e){super.cloneTo(e);var t=e;t.radius=this.radius,t.arc=this.arc,t.emitFromEdge=this.emitFromEdge,t.randomDirection=this.randomDirection}clone(){var t=new e;return this.cloneTo(t),t}}return e._tempPositionPoint=new i,e})(),qr=(()=>{class e extends Xr{constructor(){super(),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0}_getShapeBoundBox(e){const t=this.radius+this.length*Math.sin(this.angle),r=this.length*Math.cos(this.angle);var i=e.min;i.x=i.y=-t,i.z=0;var n=e.max;n.x=n.y=t,n.z=r}_getSpeedBoundBox(e){const t=Math.sin(this.angle);var r=e.min;r.x=r.y=-t,r.z=0;var i=e.max;i.x=i.y=t,i.z=1}generatePositionAndDirection(t,r,i=null,n=null){var s,o,l,_=e._tempPositionPoint,h=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:i?(i.seed=n[16],Yr._randomPointInsideUnitCircle(e._tempPositionPoint,i),n[16]=i.seed):Yr._randomPointInsideUnitCircle(e._tempPositionPoint),s=_.x,o=_.y,t.x=s*this.radius,t.y=o*this.radius,t.z=0,this.randomDirection?(i?(i.seed=n[17],Yr._randomPointInsideUnitCircle(e._tempDirectionPoint,i),n[17]=i.seed):Yr._randomPointInsideUnitCircle(e._tempDirectionPoint),l=e._tempDirectionPoint,r.x=l.x*c,r.y=l.y*c):(r.x=s*c,r.y=o*c),r.z=h;break;case 1:i?(i.seed=n[16],Yr._randomPointUnitCircle(e._tempPositionPoint,i),n[16]=i.seed):Yr._randomPointUnitCircle(e._tempPositionPoint),s=_.x,o=_.y,t.x=s*this.radius,t.y=o*this.radius,t.z=0,this.randomDirection?(i?(i.seed=n[17],Yr._randomPointInsideUnitCircle(e._tempDirectionPoint,i),n[17]=i.seed):Yr._randomPointInsideUnitCircle(e._tempDirectionPoint),l=e._tempDirectionPoint,r.x=l.x*c,r.y=l.y*c):(r.x=s*c,r.y=o*c),r.z=h;break;case 2:i?(i.seed=n[16],Yr._randomPointInsideUnitCircle(e._tempPositionPoint,i)):Yr._randomPointInsideUnitCircle(e._tempPositionPoint),s=_.x,o=_.y,t.x=s*this.radius,t.y=o*this.radius,t.z=0,r.x=s*c,r.y=o*c,r.z=h,a.normalize(r,r),i?(a.scale(r,this.length*i.getFloat(),r),n[16]=i.seed):a.scale(r,this.length*Math.random(),r),a.add(t,r,t),this.randomDirection&&(i?(i.seed=n[17],Yr._randomPointUnitSphere(r,i),n[17]=i.seed):Yr._randomPointUnitSphere(r));break;case 3:i?(i.seed=n[16],Yr._randomPointUnitCircle(e._tempPositionPoint,i)):Yr._randomPointUnitCircle(e._tempPositionPoint),s=_.x,o=_.y,t.x=s*this.radius,t.y=o*this.radius,t.z=0,r.x=s*c,r.y=o*c,r.z=h,a.normalize(r,r),i?(a.scale(r,this.length*i.getFloat(),r),n[16]=i.seed):a.scale(r,this.length*Math.random(),r),a.add(t,r,t),this.randomDirection&&(i?(i.seed=n[17],Yr._randomPointUnitSphere(r,i),n[17]=i.seed):Yr._randomPointUnitSphere(r));break;default:throw new Error("ConeShape:emitType is invalid.")}}cloneTo(e){super.cloneTo(e);var t=e;t.angle=this.angle,t.radius=this.radius,t.length=this.length,t.emitType=this.emitType,t.randomDirection=this.randomDirection}clone(){var t=new e;return this.cloneTo(t),t}}return e._tempPositionPoint=new i,e._tempDirectionPoint=new i,e})();class Qr extends Xr{constructor(){super(),this.radius=1,this.emitFromShell=!1}_getShapeBoundBox(e){var t=e.min;t.x=t.y=t.z=-this.radius;var r=e.max;r.x=r.y=this.radius,r.z=0}_getSpeedBoundBox(e){var t=e.min;t.x=t.y=-1,t.z=0;var r=e.max;r.x=r.y=r.z=1}generatePositionAndDirection(e,t,r=null,i=null){r?(r.seed=i[16],this.emitFromShell?Yr._randomPointUnitSphere(e,r):Yr._randomPointInsideUnitSphere(e,r),i[16]=r.seed):this.emitFromShell?Yr._randomPointUnitSphere(e):Yr._randomPointInsideUnitSphere(e),a.scale(e,this.radius,e);var n=e.z;n<0&&(e.z=-1*n),this.randomDirection?r?(r.seed=i[17],Yr._randomPointUnitSphere(t,r),i[17]=r.seed):Yr._randomPointUnitSphere(t):e.cloneTo(t)}cloneTo(e){super.cloneTo(e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}clone(){var e=new Qr;return this.cloneTo(e),e}}class Kr extends Xr{constructor(){super(),this.radius=1,this.emitFromShell=!1}_getShapeBoundBox(e){var t=e.min;t.x=t.y=t.z=-this.radius;var r=e.max;r.x=r.y=r.z=this.radius}_getSpeedBoundBox(e){var t=e.min;t.x=t.y=t.z=-1;var r=e.max;r.x=r.y=r.z=1}generatePositionAndDirection(e,t,r=null,i=null){r?(r.seed=i[16],this.emitFromShell?Yr._randomPointUnitSphere(e,r):Yr._randomPointInsideUnitSphere(e,r),i[16]=r.seed):this.emitFromShell?Yr._randomPointUnitSphere(e):Yr._randomPointInsideUnitSphere(e),a.scale(e,this.radius,e),this.randomDirection?r?(r.seed=i[17],Yr._randomPointUnitSphere(t,r),i[17]=r.seed):Yr._randomPointUnitSphere(t):e.cloneTo(t)}cloneTo(e){super.cloneTo(e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}clone(){var e=new Kr;return this.cloneTo(e),e}}class Jr{constructor(e){this._size=e}get size(){return this._size}cloneTo(e){var t=e;this._size.cloneTo(t._size),t.enable=this.enable}clone(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?Hr.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):Hr.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?Hr.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):Hr.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?Hr.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):Hr.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new Jr(e);return t.enable=this.enable,t}}class $r{constructor(){this._type=0,this._constant=0,this._constantMin=0,this._constantMax=0}static createByConstant(e=0){var t=new $r;return t._type=0,t._constant=e,t}static createByRandomTwoConstant(e=0,t=0){var r=new $r;return r._type=1,r._constantMin=e,r._constantMax=t,r}get type(){return this._type}get constant(){return this._constant}get constantMin(){return this._constantMin}get constantMax(){return this._constantMax}cloneTo(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax}clone(){var e=new $r;return this.cloneTo(e),e}}class ei{constructor(e,t){this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new i(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}get frame(){return this._frame}get startFrame(){return this._startFrame}cloneTo(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,t.rowIndex=this.rowIndex,t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame)}clone(){var e,t;switch(this._frame.type){case 0:e=Br.createByConstant(this._frame.constant);break;case 1:e=Br.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=Br.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=Br.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:t=$r.createByConstant(this._startFrame.constant);break;case 1:t=$r.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var r=new ei(e,t);return this.cloneTo(r),r}}class ti{constructor(e){this.enable=!1,this.space=0,this._velocity=e}get velocity(){return this._velocity}cloneTo(e){var t=e;this._velocity.cloneTo(t._velocity),t.enable=this.enable,t.space=this.space}clone(){var e;switch(this._velocity.type){case 0:e=Wr.createByConstant(this._velocity.constant.clone());break;case 1:e=Wr.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=Wr.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=Wr.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new ti(e);return t.enable=this.enable,t.space=this.space,t}}let ri=(()=>{class e{}return e.WORLDPOSITION=Ae.propertyNameToID("u_WorldPosition"),e.WORLDROTATION=Ae.propertyNameToID("u_WorldRotation"),e.POSITIONSCALE=Ae.propertyNameToID("u_PositionScale"),e.SIZESCALE=Ae.propertyNameToID("u_SizeScale"),e.SCALINGMODE=Ae.propertyNameToID("u_ScalingMode"),e.GRAVITY=Ae.propertyNameToID("u_Gravity"),e.THREEDSTARTROTATION=Ae.propertyNameToID("u_ThreeDStartRotation"),e.STRETCHEDBILLBOARDLENGTHSCALE=Ae.propertyNameToID("u_StretchedBillboardLengthScale"),e.STRETCHEDBILLBOARDSPEEDSCALE=Ae.propertyNameToID("u_StretchedBillboardSpeedScale"),e.SIMULATIONSPACE=Ae.propertyNameToID("u_SimulationSpace"),e.CURRENTTIME=Ae.propertyNameToID("u_CurrentTime"),e.VOLVELOCITYCONST=Ae.propertyNameToID("u_VOLVelocityConst"),e.VOLVELOCITYGRADIENTX=Ae.propertyNameToID("u_VOLVelocityGradientX"),e.VOLVELOCITYGRADIENTY=Ae.propertyNameToID("u_VOLVelocityGradientY"),e.VOLVELOCITYGRADIENTZ=Ae.propertyNameToID("u_VOLVelocityGradientZ"),e.VOLVELOCITYCONSTMAX=Ae.propertyNameToID("u_VOLVelocityConstMax"),e.VOLVELOCITYGRADIENTXMAX=Ae.propertyNameToID("u_VOLVelocityGradientMaxX"),e.VOLVELOCITYGRADIENTYMAX=Ae.propertyNameToID("u_VOLVelocityGradientMaxY"),e.VOLVELOCITYGRADIENTZMAX=Ae.propertyNameToID("u_VOLVelocityGradientMaxZ"),e.VOLSPACETYPE=Ae.propertyNameToID("u_VOLSpaceType"),e.COLOROVERLIFEGRADIENTALPHAS=Ae.propertyNameToID("u_ColorOverLifeGradientAlphas"),e.COLOROVERLIFEGRADIENTCOLORS=Ae.propertyNameToID("u_ColorOverLifeGradientColors"),e.MAXCOLOROVERLIFEGRADIENTALPHAS=Ae.propertyNameToID("u_MaxColorOverLifeGradientAlphas"),e.MAXCOLOROVERLIFEGRADIENTCOLORS=Ae.propertyNameToID("u_MaxColorOverLifeGradientColors"),e.SOLSIZEGRADIENT=Ae.propertyNameToID("u_SOLSizeGradient"),e.SOLSIZEGRADIENTX=Ae.propertyNameToID("u_SOLSizeGradientX"),e.SOLSIZEGRADIENTY=Ae.propertyNameToID("u_SOLSizeGradientY"),e.SOLSizeGradientZ=Ae.propertyNameToID("u_SOLSizeGradientZ"),e.SOLSizeGradientMax=Ae.propertyNameToID("u_SOLSizeGradientMax"),e.SOLSIZEGRADIENTXMAX=Ae.propertyNameToID("u_SOLSizeGradientMaxX"),e.SOLSIZEGRADIENTYMAX=Ae.propertyNameToID("u_SOLSizeGradientMaxY"),e.SOLSizeGradientZMAX=Ae.propertyNameToID("u_SOLSizeGradientMaxZ"),e.ROLANGULARVELOCITYCONST=Ae.propertyNameToID("u_ROLAngularVelocityConst"),e.ROLANGULARVELOCITYCONSTSEPRARATE=Ae.propertyNameToID("u_ROLAngularVelocityConstSeprarate"),e.ROLANGULARVELOCITYGRADIENT=Ae.propertyNameToID("u_ROLAngularVelocityGradient"),e.ROLANGULARVELOCITYGRADIENTX=Ae.propertyNameToID("u_ROLAngularVelocityGradientX"),e.ROLANGULARVELOCITYGRADIENTY=Ae.propertyNameToID("u_ROLAngularVelocityGradientY"),e.ROLANGULARVELOCITYGRADIENTZ=Ae.propertyNameToID("u_ROLAngularVelocityGradientZ"),e.ROLANGULARVELOCITYCONSTMAX=Ae.propertyNameToID("u_ROLAngularVelocityConstMax"),e.ROLANGULARVELOCITYCONSTMAXSEPRARATE=Ae.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate"),e.ROLANGULARVELOCITYGRADIENTMAX=Ae.propertyNameToID("u_ROLAngularVelocityGradientMax"),e.ROLANGULARVELOCITYGRADIENTXMAX=Ae.propertyNameToID("u_ROLAngularVelocityGradientMaxX"),e.ROLANGULARVELOCITYGRADIENTYMAX=Ae.propertyNameToID("u_ROLAngularVelocityGradientMaxY"),e.ROLANGULARVELOCITYGRADIENTZMAX=Ae.propertyNameToID("u_ROLAngularVelocityGradientMaxZ"),e.ROLANGULARVELOCITYGRADIENTWMAX=Ae.propertyNameToID("u_ROLAngularVelocityGradientMaxW"),e.TEXTURESHEETANIMATIONCYCLES=Ae.propertyNameToID("u_TSACycles"),e.TEXTURESHEETANIMATIONSUBUVLENGTH=Ae.propertyNameToID("u_TSASubUVLength"),e.TEXTURESHEETANIMATIONGRADIENTUVS=Ae.propertyNameToID("u_TSAGradientUVs"),e.TEXTURESHEETANIMATIONGRADIENTMAXUVS=Ae.propertyNameToID("u_TSAMaxGradientUVs"),e})(),ii=(()=>{class e extends De{constructor(){super(),this.setShaderName("PARTICLESHURIKEN"),this._color=new n(1,1,1,1),this.renderMode=e.RENDERMODE_ALPHABLENDED}static __initDefine__(){e.SHADERDEFINE_DIFFUSEMAP=Ae.getDefineByName("DIFFUSEMAP"),e.SHADERDEFINE_TINTCOLOR=Ae.getDefineByName("TINTCOLOR"),e.SHADERDEFINE_ADDTIVEFOG=Ae.getDefineByName("ADDTIVEFOG"),e.SHADERDEFINE_TILINGOFFSET=Ae.getDefineByName("TILINGOFFSET")}get _TintColorR(){return this._color.x}set _TintColorR(e){this._color.x=e,this.color=this._color}get _TintColorG(){return this._color.y}set _TintColorG(e){this._color.y=e,this.color=this._color}get _TintColorB(){return this._color.z}set _TintColorB(e){this._color.z=e,this.color=this._color}get _TintColorA(){return this._color.w}set _TintColorA(e){this._color.w=e,this.color=this._color}get _MainTex_STX(){return this._shaderValues.getVector(e.TILINGOFFSET).x}set _MainTex_STX(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.x=t,this.tilingOffset=r}get _MainTex_STY(){return this._shaderValues.getVector(e.TILINGOFFSET).y}set _MainTex_STY(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.y=t,this.tilingOffset=r}get _MainTex_STZ(){return this._shaderValues.getVector(e.TILINGOFFSET).z}set _MainTex_STZ(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.z=t,this.tilingOffset=r}get _MainTex_STW(){return this._shaderValues.getVector(e.TILINGOFFSET).w}set _MainTex_STW(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.w=t,this.tilingOffset=r}set renderMode(t){switch(t){case e.RENDERMODE_ADDTIVE:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=Oe.CULL_NONE,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE,this.alphaTest=!1,this._shaderValues.addDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case e.RENDERMODE_ALPHABLENDED:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=Oe.CULL_NONE,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.alphaTest=!1,this._shaderValues.removeDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.")}}get colorR(){return this._TintColorR}set colorR(e){this._TintColorR=e}get colorG(){return this._TintColorG}set colorG(e){this._TintColorG=e}get colorB(){return this._TintColorB}set colorB(e){this._TintColorB=e}get colorA(){return this._TintColorA}set colorA(e){this._TintColorA=e}get color(){return this._shaderValues.getVector(e.TINTCOLOR)}set color(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_TINTCOLOR):this._shaderValues.removeDefine(e.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(e.TINTCOLOR,t)}get tilingOffsetX(){return this._MainTex_STX}set tilingOffsetX(e){this._MainTex_STX=e}get tilingOffsetY(){return this._MainTex_STY}set tilingOffsetY(e){this._MainTex_STY=e}get tilingOffsetZ(){return this._MainTex_STZ}set tilingOffsetZ(e){this._MainTex_STZ=e}get tilingOffsetW(){return this._MainTex_STW}set tilingOffsetW(e){this._MainTex_STW=e}get tilingOffset(){return this._shaderValues.getVector(e.TILINGOFFSET)}set tilingOffset(t){t&&(1!=t.x||1!=t.y||0!=t.z||0!=t.w)?this._shaderValues.addDefine(e.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(e.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(e.TILINGOFFSET,t)}get texture(){return this._shaderValues.getTexture(e.DIFFUSETEXTURE)}set texture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(e.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(e.DIFFUSETEXTURE,t)}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}clone(){var t=new e;return this.cloneTo(t),t}}return e.RENDERMODE_ALPHABLENDED=0,e.RENDERMODE_ADDTIVE=1,e.DIFFUSETEXTURE=Ae.propertyNameToID("u_texture"),e.TINTCOLOR=Ae.propertyNameToID("u_Tintcolor"),e.TILINGOFFSET=Ae.propertyNameToID("u_TilingOffset"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})();class ni extends tr{constructor(e){super(e),this._finalGravity=new a,this._tempRotationMatrix=new h,this._mesh=null,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=2,this._defaultBoundBox=new Ht(new a,new a),this.renderMode=0,this._supportOctree=!1}get renderMode(){return this._renderMode}set renderMode(e){if(this._renderMode!==e){var t=this._shaderValues;switch(this._renderMode){case 0:t.removeDefine(ri.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.removeDefine(ri.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.removeDefine(ri.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.removeDefine(ri.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.removeDefine(ri.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:t.addDefine(ri.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.addDefine(ri.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.addDefine(ri.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.addDefine(ri.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.addDefine(ri.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}var r=this._owner.particleSystem;r&&r._initBufferDatas()}}get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),this._mesh=e,e&&e._addReference(),this._owner.particleSystem._initBufferDatas())}_calculateBoundingBox(){if((e=this._bounds.getMin()).x=-Number.MAX_VALUE,e.y=-Number.MAX_VALUE,e.z=-Number.MAX_VALUE,this._bounds.setMin(e),(r=this._bounds.getMax()).x=Number.MAX_VALUE,r.y=Number.MAX_VALUE,r.z=Number.MAX_VALUE,this._bounds.setMax(r),t.Render.supportWebGLPlusCulling){var e=this._bounds.getMin(),r=this._bounds.getMax(),i=We._cullingBuffer;i[this._cullingBufferIndex+1]=e.x,i[this._cullingBufferIndex+2]=e.y,i[this._cullingBufferIndex+3]=e.z,i[this._cullingBufferIndex+4]=r.x,i[this._cullingBufferIndex+5]=r.y,i[this._cullingBufferIndex+6]=r.z}}_needRender(e,t){return!e||!!e.intersects(this.bounds._getBoundBox())&&!!this._owner.particleSystem.isAlive}_renderUpdate(e,t){var r=this._owner.particleSystem,i=this._shaderValues,n=this._owner.transform;switch(r.simulationSpace){case 0:break;case 1:i.setVector3(ri.WORLDPOSITION,n.position),i.setQuaternion(ri.WORLDROTATION,n.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(r.scaleMode){case 0:var s=n.getWorldLossyScale();i.setVector3(ri.POSITIONSCALE,s),i.setVector3(ri.SIZESCALE,s);break;case 1:var o=n.localScale;i.setVector3(ri.POSITIONSCALE,o),i.setVector3(ri.SIZESCALE,o);break;case 2:i.setVector3(ri.POSITIONSCALE,n.getWorldLossyScale()),i.setVector3(ri.SIZESCALE,a._ONE)}a.scale(u.gravity,r.gravityModifier,this._finalGravity),i.setVector3(ri.GRAVITY,this._finalGravity),i.setInt(ri.SIMULATIONSPACE,r.simulationSpace),i.setBool(ri.THREEDSTARTROTATION,r.threeDStartRotation),i.setInt(ri.SCALINGMODE,r.scaleMode),i.setNumber(ri.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),i.setNumber(ri.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),i.setNumber(ri.CURRENTTIME,r._currentTime)}get bounds(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}_destroy(){super._destroy(),this._mesh&&(this._mesh._removeReference(),this._mesh=null)}}let ai=(()=>{class e{constructor(){}}return e.PARTICLE_CORNERTEXTURECOORDINATE0=5,e.PARTICLE_POSITION0=1,e.PARTICLE_COLOR0=2,e.PARTICLE_TEXTURECOORDINATE0=3,e.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,e.PARTICLE_DIRECTIONTIME=0,e.PARTICLE_STARTCOLOR0=6,e.PARTICLE_ENDCOLOR0=7,e.PARTICLE_STARTSIZE=8,e.PARTICLE_STARTROTATION=9,e.PARTICLE_STARTSPEED=10,e.PARTICLE_RANDOM0=11,e.PARTICLE_RANDOM1=12,e.PARTICLE_SIMULATIONWORLDPOSTION=13,e.PARTICLE_SIMULATIONWORLDROTATION=14,e})();class si extends ai{constructor(e,t,r,i,n,a,s,o,l,_,h,c,d,u){super(),this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=r,this._startColor=i,this._startSize=n,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=_,this._startSpeed=h,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=u}static get vertexDeclaration(){return si._vertexDeclaration}static __init__(){si._vertexDeclaration=new lt(152,[new _t(0,ot.Vector4,ai.PARTICLE_CORNERTEXTURECOORDINATE0),new _t(16,ot.Vector4,ai.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new _t(32,ot.Vector4,ai.PARTICLE_DIRECTIONTIME),new _t(48,ot.Vector4,ai.PARTICLE_STARTCOLOR0),new _t(64,ot.Vector3,ai.PARTICLE_STARTSIZE),new _t(76,ot.Vector3,ai.PARTICLE_STARTROTATION),new _t(88,ot.Single,ai.PARTICLE_STARTSPEED),new _t(92,ot.Vector4,ai.PARTICLE_RANDOM0),new _t(108,ot.Vector4,ai.PARTICLE_RANDOM1),new _t(124,ot.Vector3,ai.PARTICLE_SIMULATIONWORLDPOSTION),new _t(136,ot.Vector4,ai.PARTICLE_SIMULATIONWORLDROTATION)])}get cornerTextureCoordinate(){return this._cornerTextureCoordinate}get positionStartLifeTime(){return this._positionStartLifeTime}get velocity(){return this._velocity}get startColor(){return this._startColor}get startSize(){return this._startSize}get startRotation0(){return this._startRotation0}get startRotation1(){return this._startRotation1}get startRotation2(){return this._startRotation2}get startLifeTime(){return this._startLifeTime}get time(){return this._time}get startSpeed(){return this._startSpeed}get random0(){return this._randoms0}get random1(){return this._randoms1}get simulationWorldPostion(){return this._simulationWorldPostion}}class oi extends ai{constructor(e,t,r,i,n,a,s,o,l,_,h,c,d,u){super(),this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=r,this._startColor=i,this._startSize=n,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=_,this._startSpeed=h,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=u}static __init__(){oi._vertexDeclaration=new lt(172,[new _t(0,ot.Vector3,ai.PARTICLE_POSITION0),new _t(12,ot.Vector4,ai.PARTICLE_COLOR0),new _t(28,ot.Vector2,ai.PARTICLE_TEXTURECOORDINATE0),new _t(36,ot.Vector4,ai.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new _t(52,ot.Vector4,ai.PARTICLE_DIRECTIONTIME),new _t(68,ot.Vector4,ai.PARTICLE_STARTCOLOR0),new _t(84,ot.Vector3,ai.PARTICLE_STARTSIZE),new _t(96,ot.Vector3,ai.PARTICLE_STARTROTATION),new _t(108,ot.Single,ai.PARTICLE_STARTSPEED),new _t(112,ot.Vector4,ai.PARTICLE_RANDOM0),new _t(128,ot.Vector4,ai.PARTICLE_RANDOM1),new _t(144,ot.Vector3,ai.PARTICLE_SIMULATIONWORLDPOSTION),new _t(156,ot.Vector4,ai.PARTICLE_SIMULATIONWORLDROTATION)])}static get vertexDeclaration(){return oi._vertexDeclaration}get cornerTextureCoordinate(){return this._cornerTextureCoordinate}get position(){return this._positionStartLifeTime}get velocity(){return this._velocity}get startColor(){return this._startColor}get startSize(){return this._startSize}get startRotation0(){return this._startRotation0}get startRotation1(){return this._startRotation1}get startRotation2(){return this._startRotation2}get startLifeTime(){return this._startLifeTime}get time(){return this._time}get startSpeed(){return this._startSpeed}get random0(){return this._randoms0}get random1(){return this._randoms1}get simulationWorldPostion(){return this._simulationWorldPostion}}class li{constructor(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}static getFloatFromInt(e){return 1/8388607*(8388607&e)}static getByteFromInt(e){return(8388607&e)>>>15}get seed(){return this.seeds[0]}set seed(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}getUint(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]}getFloat(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)}getSignedFloat(){return 2*this.getFloat()-1}}class _i{constructor(){this._emissionRate=10,this._destroyed=!1,this._bursts=[]}set emissionRate(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e}get emissionRate(){return this._emissionRate}get destroyed(){return this._destroyed}destroy(){this._bursts=null,this._destroyed=!0}getBurstsCount(){return this._bursts.length}getBurstByIndex(e){return this._bursts[e]}addBurst(e){var t=this._bursts.length;if(t>0)for(var r=0;r<t;r++)this._bursts[r].time>e.time&&this._bursts.splice(r,0,e);this._bursts.push(e)}removeBurst(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)}removeBurstByIndex(e){this._bursts.splice(e,1)}clearBurst(){this._bursts.length=0}cloneTo(e){var t=e,r=t._bursts;r.length=this._bursts.length;for(var i=0,n=this._bursts.length;i<n;i++){var a=r[i];a?this._bursts[i].cloneTo(a):r[i]=this._bursts[i].clone()}t._emissionRate=this._emissionRate,t.enable=this.enable}clone(){var e=new _i;return this.cloneTo(e),e}}let hi=(()=>{class e{constructor(){}static _getStartLifetimeFromGradient(e,r){for(var i=1,n=e.gradientCount;i<n;i++){var a=e.getKeyByIndex(i);if(a>=r){var s=e.getKeyByIndex(i-1),o=(r-s)/(a-s);return t.MathUtil.lerp(e.getValueByIndex(i-1),e.getValueByIndex(i),o)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")}static _randomInvertRoationArray(e,t,r,i,n){var a;i?(i.seed=n[6],a=i.getFloat(),n[6]=i.seed):a=Math.random(),a<r?(t.x=-e.x,t.y=-e.y,t.z=-e.z):(t.x=e.x,t.y=e.y,t.z=e.z)}static _randomInvertRoation(e,t,r,i){var n;return r?(r.seed=i[6],n=r.getFloat(),i[6]=r.seed):n=Math.random(),n<t&&(e=-e),e}static create(r,i,a){var s=r.autoRandomSeed,o=r._rand,l=r._randomSeeds;switch(r.startColorType){case 0:var _=r.startColorConstant;e.startColor.x=_.x,e.startColor.y=_.y,e.startColor.z=_.z,e.startColor.w=_.w;break;case 2:s?n.lerp(r.startColorConstantMin,r.startColorConstantMax,Math.random(),e.startColor):(o.seed=l[3],n.lerp(r.startColorConstantMin,r.startColorConstantMax,o.getFloat(),e.startColor),l[3]=o.seed)}var h=r.colorOverLifetime;if(h&&h.enable){var c=h.color;switch(c.type){case 0:e.startColor.x=e.startColor.x*c.constant.x,e.startColor.y=e.startColor.y*c.constant.y,e.startColor.z=e.startColor.z*c.constant.z,e.startColor.w=e.startColor.w*c.constant.w;break;case 2:var d;s?d=Math.random():(o.seed=l[10],d=o.getFloat(),l[10]=o.seed);var u=c.constantMin,m=c.constantMax;e.startColor.x=e.startColor.x*t.MathUtil.lerp(u.x,m.x,d),e.startColor.y=e.startColor.y*t.MathUtil.lerp(u.y,m.y,d),e.startColor.z=e.startColor.z*t.MathUtil.lerp(u.z,m.z,d),e.startColor.w=e.startColor.w*t.MathUtil.lerp(u.w,m.w,d)}}var f=e.startSize;switch(r.startSizeType){case 0:if(r.threeDStartSize){var T=r.startSizeConstantSeparate;f[0]=T.x,f[1]=T.y,f[2]=T.z}else f[0]=f[1]=f[2]=r.startSizeConstant;break;case 2:if(r.threeDStartSize){var E=r.startSizeConstantMinSeparate,p=r.startSizeConstantMaxSeparate;s?(f[0]=t.MathUtil.lerp(E.x,p.x,Math.random()),f[1]=t.MathUtil.lerp(E.y,p.y,Math.random()),f[2]=t.MathUtil.lerp(E.z,p.z,Math.random())):(o.seed=l[4],f[0]=t.MathUtil.lerp(E.x,p.x,o.getFloat()),f[1]=t.MathUtil.lerp(E.y,p.y,o.getFloat()),f[2]=t.MathUtil.lerp(E.z,p.z,o.getFloat()),l[4]=o.seed)}else s?f[0]=f[1]=f[2]=t.MathUtil.lerp(r.startSizeConstantMin,r.startSizeConstantMax,Math.random()):(o.seed=l[4],f[0]=f[1]=f[2]=t.MathUtil.lerp(r.startSizeConstantMin,r.startSizeConstantMax,o.getFloat()),l[4]=o.seed)}var g=r.sizeOverLifetime;if(g&&g.enable&&1===g.size.type){var S,R=g.size;if(R.separateAxes)s?(f[0]=f[0]*t.MathUtil.lerp(R.constantMinSeparate.x,R.constantMaxSeparate.x,Math.random()),f[1]=f[1]*t.MathUtil.lerp(R.constantMinSeparate.y,R.constantMaxSeparate.y,Math.random()),f[2]=f[2]*t.MathUtil.lerp(R.constantMinSeparate.z,R.constantMaxSeparate.z,Math.random())):(o.seed=l[11],f[0]=f[0]*t.MathUtil.lerp(R.constantMinSeparate.x,R.constantMaxSeparate.x,o.getFloat()),f[1]=f[1]*t.MathUtil.lerp(R.constantMinSeparate.y,R.constantMaxSeparate.y,o.getFloat()),f[2]=f[2]*t.MathUtil.lerp(R.constantMinSeparate.z,R.constantMaxSeparate.z,o.getFloat()),l[11]=o.seed);else s?S=t.MathUtil.lerp(R.constantMin,R.constantMax,Math.random()):(o.seed=l[11],S=t.MathUtil.lerp(R.constantMin,R.constantMax,o.getFloat()),l[11]=o.seed),f[0]=f[0]*S,f[1]=f[1]*S,f[2]=f[2]*S}var v=i.renderMode;if(1!==v)switch(r.startRotationType){case 0:if(r.threeDStartRotation){var A=r.startRotationConstantSeparate,I=e._tempVector30;e._randomInvertRoationArray(A,I,r.randomizeRotationDirection,s?null:o,l),e.startRotation[0]=I.x,e.startRotation[1]=I.y,e.startRotation[2]=4!==v?-I.z:I.z}else e.startRotation[0]=e._randomInvertRoation(r.startRotationConstant,r.randomizeRotationDirection,s?null:o,l),e.startRotation[1]=0,e.startRotation[2]=0;break;case 2:if(r.threeDStartRotation){var x=r.startRotationConstantMinSeparate,C=r.startRotationConstantMaxSeparate,L=e._tempVector30;s?(L.x=t.MathUtil.lerp(x.x,C.x,Math.random()),L.y=t.MathUtil.lerp(x.y,C.y,Math.random()),L.z=t.MathUtil.lerp(x.z,C.z,Math.random())):(o.seed=l[5],L.x=t.MathUtil.lerp(x.x,C.x,o.getFloat()),L.y=t.MathUtil.lerp(x.y,C.y,o.getFloat()),L.z=t.MathUtil.lerp(x.z,C.z,o.getFloat()),l[5]=o.seed),e._randomInvertRoationArray(L,L,r.randomizeRotationDirection,s?null:o,l),e.startRotation[0]=L.x,e.startRotation[1]=L.y,e.startRotation[2]=4!==v?-L.z:L.z}else s?e.startRotation[0]=e._randomInvertRoation(t.MathUtil.lerp(r.startRotationConstantMin,r.startRotationConstantMax,Math.random()),r.randomizeRotationDirection,s?null:o,l):(o.seed=l[5],e.startRotation[0]=e._randomInvertRoation(t.MathUtil.lerp(r.startRotationConstantMin,r.startRotationConstantMax,o.getFloat()),r.randomizeRotationDirection,s?null:o,l),l[5]=o.seed)}switch(r.startLifetimeType){case 0:e.startLifeTime=r.startLifetimeConstant;break;case 1:e.startLifeTime=e._getStartLifetimeFromGradient(r.startLifeTimeGradient,r.emissionTime);break;case 2:s?e.startLifeTime=t.MathUtil.lerp(r.startLifetimeConstantMin,r.startLifetimeConstantMax,Math.random()):(o.seed=l[7],e.startLifeTime=t.MathUtil.lerp(r.startLifetimeConstantMin,r.startLifetimeConstantMax,o.getFloat()),l[7]=o.seed);break;case 3:var y=r.emissionTime;s?e.startLifeTime=t.MathUtil.lerp(e._getStartLifetimeFromGradient(r.startLifeTimeGradientMin,y),e._getStartLifetimeFromGradient(r.startLifeTimeGradientMax,y),Math.random()):(o.seed=l[7],e.startLifeTime=t.MathUtil.lerp(e._getStartLifetimeFromGradient(r.startLifeTimeGradientMin,y),e._getStartLifetimeFromGradient(r.startLifeTimeGradientMax,y),o.getFloat()),l[7]=o.seed)}var D=r.textureSheetAnimation;if(D&&D.enable){var M,O=D.tiles,N=O.x,b=O.y,P=1/N,w=1/b,V=D.startFrame;switch(V.type){case 0:M=V.constant;break;case 1:s?M=t.MathUtil.lerp(V.constantMin,V.constantMax,Math.random()):(o.seed=l[14],M=t.MathUtil.lerp(V.constantMin,V.constantMax,o.getFloat()),l[14]=o.seed)}var F=D.frame,B=D.cycles;switch(F.type){case 0:M+=F.constant*B;break;case 2:s?M+=t.MathUtil.lerp(F.constantMin,F.constantMax,Math.random())*B:(o.seed=l[15],M+=t.MathUtil.lerp(F.constantMin,F.constantMax,o.getFloat())*B,l[15]=o.seed)}var U=0;switch(D.type){case 0:U=Math.floor(M/N);break;case 1:D.randomRow?s?U=Math.floor(Math.random()*b):(o.seed=l[13],U=Math.floor(o.getFloat()*b),l[13]=o.seed):U=D.rowIndex}var G=Math.floor(M%N);e.startUVInfo=e.startUVInfo,e.startUVInfo[0]=P,e.startUVInfo[1]=w,e.startUVInfo[2]=G*P,e.startUVInfo[3]=U*w}else e.startUVInfo=e.startUVInfo,e.startUVInfo[0]=1,e.startUVInfo[1]=1,e.startUVInfo[2]=0,e.startUVInfo[3]=0}}return e._tempVector30=new a,e.startColor=new n,e.startSize=new Float32Array(3),e.startRotation=new Float32Array(3),e.startUVInfo=new Float32Array(4),e})(),ci=(()=>{class r extends kt{constructor(e){super(),this._boundingSphere=null,this._boundingBox=null,this._boundingBoxCorners=null,this._owner=null,this._ownerRender=null,this._vertices=null,this._floatCountPerVertex=0,this._startLifeTimeIndex=0,this._timeIndex=0,this._simulateUpdate=!1,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._drawCounter=0,this._bufferMaxParticles=0,this._emission=null,this._shape=null,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._playStartDelay=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._burstsIndex=0,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null,this._startLifetimeType=0,this._startLifetimeConstant=0,this._startLifeTimeGradient=null,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=0,this._startLifeTimeGradientMin=null,this._startLifeTimeGradientMax=null,this._maxStartLifetime=0,this._uvLength=new i,this._vertexStride=0,this._indexStride=0,this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=new nt,this._currentTime=0,this._startUpdateLoopCount=0,this._rand=null,this._randomSeeds=null,this.duration=0,this.looping=!1,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this.startSpeedType=0,this.startSpeedConstant=0,this.startSpeedConstantMin=0,this.startSpeedConstantMax=0,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=0,this.startSizeConstantSeparate=null,this.startSizeConstantMin=0,this.startSizeConstantMax=0,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=null,this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new n(1,1,1,1),this.startColorConstantMin=new n(0,0,0,0),this.startColorConstantMax=new n(1,1,1,1),this.gravityModifier=0,this.simulationSpace=0,this.simulationSpeed=1,this.scaleMode=1,this.playOnAwake=!1,this.randomSeed=null,this.autoRandomSeed=!1,this.isPerformanceMode=!1,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=e,this._ownerRender=e.particleRenderer,this._boundingBoxCorners=[],this._boundingSphere=new _r(new a,Number.MAX_VALUE),this._boundingBox=new Ht(new a(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new a(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new zr,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new zr,this._startLifeTimeGradientMax=new zr,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new a(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new a(0,0,0),this.startSizeConstantMaxSeparate=new a(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new a(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new a(0,0,0),this.startRotationConstantMaxSeparate=new a(0,0,0),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=1,this.playOnAwake=!0,this._rand=new li(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(r._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new _i,this._emission.enable=!0}get maxParticles(){return this._bufferMaxParticles-1}set maxParticles(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}get emission(){return this._emission}get aliveParticleCount(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}get emissionTime(){return this._emissionTime>this.duration?this.duration:this._emissionTime}get shape(){return this._shape}set shape(e){this._shape!==e&&(e&&e.enable?this._owner._render._shaderValues.addDefine(ri.SHADERDEFINE_SHAPE):this._owner._render._shaderValues.removeDefine(ri.SHADERDEFINE_SHAPE),this._shape=e)}get isAlive(){return!!(this._isPlaying||this.aliveParticleCount>0)}get isEmitting(){return this._isEmitting}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get startLifetimeType(){return this._startLifetimeType}set startLifetimeType(e){var t,r;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,r=i.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var n=n;for(t=0,r=n.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,n.getValueByIndex(t));var a=a;for(t=0,r=a.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}get startLifetimeConstant(){return this._startLifetimeConstant}set startLifetimeConstant(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}get startLifeTimeGradient(){return this._startLifeTimeGradient}set startLifeTimeGradient(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,r=e.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}get startLifetimeConstantMin(){return this._startLifetimeConstantMin}set startLifetimeConstantMin(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}get startLifetimeConstantMax(){return this._startLifetimeConstantMax}set startLifetimeConstantMax(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}get startLifeTimeGradientMin(){return this._startLifeTimeGradientMin}set startLifeTimeGradientMin(e){if(3===this._startLifetimeType){var t,r;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,r=e.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,r=this._startLifeTimeGradientMax.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}get startLifeTimeGradientMax(){return this._startLifeTimeGradientMax}set startLifeTimeGradientMax(e){if(3===this._startLifetimeType){var t,r;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,r=this._startLifeTimeGradientMin.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,r=e.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}get velocityOverLifetime(){return this._velocityOverLifetime}set velocityOverLifetime(e){var t=this._owner._render._shaderValues;if(e){var r=e.velocity,i=r.type;if(e.enable)switch(i){case 0:t.addDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t.addDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t.addDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t.addDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t.setVector3(ri.VOLVELOCITYCONST,r.constant);break;case 1:t.setBuffer(ri.VOLVELOCITYGRADIENTX,r.gradientX._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTY,r.gradientY._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTZ,r.gradientZ._elements);break;case 2:t.setVector3(ri.VOLVELOCITYCONST,r.constantMin),t.setVector3(ri.VOLVELOCITYCONSTMAX,r.constantMax);break;case 3:t.setBuffer(ri.VOLVELOCITYGRADIENTX,r.gradientXMin._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTXMAX,r.gradientXMax._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTY,r.gradientYMin._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTYMAX,r.gradientYMax._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTZ,r.gradientZMin._elements),t.setBuffer(ri.VOLVELOCITYGRADIENTZMAX,r.gradientZMax._elements)}t.setInt(ri.VOLSPACETYPE,e.space)}else t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);this._velocityOverLifetime=e}get colorOverLifetime(){return this._colorOverLifetime}set colorOverLifetime(e){var t=this._owner._render._shaderValues;if(e){var r=e.color;if(e.enable)switch(r.type){case 1:t.addDefine(ri.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t.addDefine(ri.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t.removeDefine(ri.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(ri.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(r.type){case 1:var i=r.gradient;t.setBuffer(ri.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(ri.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements);break;case 3:var n=r.gradientMin,a=r.gradientMax;t.setBuffer(ri.COLOROVERLIFEGRADIENTALPHAS,n._alphaElements),t.setBuffer(ri.COLOROVERLIFEGRADIENTCOLORS,n._rgbElements),t.setBuffer(ri.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(ri.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements)}}else t.removeDefine(ri.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(ri.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t.setBuffer(ri.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(ri.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(ri.COLOROVERLIFEGRADIENTALPHAS,n._alphaElements),t.setBuffer(ri.COLOROVERLIFEGRADIENTCOLORS,n._rgbElements),t.setBuffer(ri.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(ri.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements);this._colorOverLifetime=e}get sizeOverLifetime(){return this._sizeOverLifetime}set sizeOverLifetime(e){var t=this._owner._render._shaderValues;if(e){var r=e.size,i=r.separateAxes,n=r.type;if(e.enable)switch(n){case 0:i?t.addDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t.addDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t.addDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t.addDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(n){case 0:i?(t.setBuffer(ri.SOLSIZEGRADIENTX,r.gradientX._elements),t.setBuffer(ri.SOLSIZEGRADIENTY,r.gradientY._elements),t.setBuffer(ri.SOLSizeGradientZ,r.gradientZ._elements)):t.setBuffer(ri.SOLSIZEGRADIENT,r.gradient._elements);break;case 2:i?(t.setBuffer(ri.SOLSIZEGRADIENTX,r.gradientXMin._elements),t.setBuffer(ri.SOLSIZEGRADIENTXMAX,r.gradientXMax._elements),t.setBuffer(ri.SOLSIZEGRADIENTY,r.gradientYMin._elements),t.setBuffer(ri.SOLSIZEGRADIENTYMAX,r.gradientYMax._elements),t.setBuffer(ri.SOLSizeGradientZ,r.gradientZMin._elements),t.setBuffer(ri.SOLSizeGradientZMAX,r.gradientZMax._elements)):(t.setBuffer(ri.SOLSIZEGRADIENT,r.gradientMin._elements),t.setBuffer(ri.SOLSizeGradientMax,r.gradientMax._elements))}}else t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);this._sizeOverLifetime=e}get rotationOverLifetime(){return this._rotationOverLifetime}set rotationOverLifetime(e){var t=this._owner._render._shaderValues;if(e){var r=e.angularVelocity;if(!r)return;var i=r.separateAxes,n=r.type;if(e.enable)switch(i?t.addDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t.addDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIME),n){case 0:t.addDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t.addDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t.addDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t.addDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(n){case 0:i?t.setVector3(ri.ROLANGULARVELOCITYCONSTSEPRARATE,r.constantSeparate):t.setNumber(ri.ROLANGULARVELOCITYCONST,r.constant);break;case 1:i?(t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTX,r.gradientX._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTY,r.gradientY._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTZ,r.gradientZ._elements)):t.setBuffer(ri.ROLANGULARVELOCITYGRADIENT,r.gradient._elements);break;case 2:i?(t.setVector3(ri.ROLANGULARVELOCITYCONSTSEPRARATE,r.constantMinSeparate),t.setVector3(ri.ROLANGULARVELOCITYCONSTMAXSEPRARATE,r.constantMaxSeparate)):(t.setNumber(ri.ROLANGULARVELOCITYCONST,r.constantMin),t.setNumber(ri.ROLANGULARVELOCITYCONSTMAX,r.constantMax));break;case 3:i?(t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTX,r.gradientXMin._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTXMAX,r.gradientXMax._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTY,r.gradientYMin._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTYMAX,r.gradientYMax._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTZ,r.gradientZMin._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTZMAX,r.gradientZMax._elements)):(t.setBuffer(ri.ROLANGULARVELOCITYGRADIENT,r.gradientMin._elements),t.setBuffer(ri.ROLANGULARVELOCITYGRADIENTMAX,r.gradientMax._elements))}}else t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);this._rotationOverLifetime=e}get textureSheetAnimation(){return this._textureSheetAnimation}set textureSheetAnimation(e){var t=this._owner._render._shaderValues;if(e){var r=e.frame,i=r.type;if(e.enable)switch(i){case 1:t.addDefine(ri.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t.addDefine(ri.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t.removeDefine(ri.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(ri.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===i||3===i){t.setNumber(ri.TEXTURESHEETANIMATIONCYCLES,e.cycles);var n=e.tiles,a=this._uvLength;a.x=1/n.x,a.y=1/n.y,t.setVector2(ri.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength)}switch(i){case 1:t.setBuffer(ri.TEXTURESHEETANIMATIONGRADIENTUVS,r.frameOverTimeData._elements);break;case 3:t.setBuffer(ri.TEXTURESHEETANIMATIONGRADIENTUVS,r.frameOverTimeDataMin._elements),t.setBuffer(ri.TEXTURESHEETANIMATIONGRADIENTMAXUVS,r.frameOverTimeDataMax._elements)}}else t.removeDefine(ri.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(ri.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);this._textureSheetAnimation=e}_getVertexBuffer(e=0){return 0===e?this._vertexBuffer:null}_getIndexBuffer(){return this._indexBuffer}_generateBoundingSphere(){var e=this._boundingSphere.center;e.x=0,e.y=0,e.z=0,this._boundingSphere.radius=Number.MAX_VALUE}_generateBoundingBox(){var e,t,i,n,s,o,l,_,h,c=this._owner.particleRenderer,d=this._boundingBox.min,u=this._boundingBox.max;switch(this.startLifetimeType){case 0:i=this.startLifetimeConstant;break;case 1:i=-Number.MAX_VALUE;var m=m;for(e=0,t=m.gradientCount;e<t;e++)i=Math.max(i,m.getValueByIndex(e));break;case 2:i=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:i=-Number.MAX_VALUE;var f=f;for(e=0,t=f.gradientCount;e<t;e++)i=Math.max(i,f.getValueByIndex(e));var T=T;for(e=0,t=T.gradientCount;e<t;e++)i=Math.max(i,T.getValueByIndex(e))}switch(this.startSpeedType){case 0:n=s=this.startSpeedConstant;break;case 1:break;case 2:n=this.startLifetimeConstantMin,s=this.startLifetimeConstantMax}this._shape&&this._shape.enable||(o=l=a._ZERO,_=a._ZERO,h=a._UnitZ);var E,p,g=new a(_.x*n,_.y*n,_.z*n),S=new a(h.x*s,h.y*s,h.z*s);if(this._velocityOverLifetime&&this._velocityOverLifetime.enable){var R=this._velocityOverLifetime.velocity;switch(R.type){case 0:R.constant;break;case 1:new a(R.gradientX.getAverageValue(),R.gradientY.getAverageValue(),R.gradientZ.getAverageValue());break;case 2:R.constantMin,R.constantMax;break;case 3:new a(R.gradientXMin.getAverageValue(),R.gradientYMin.getAverageValue(),R.gradientZMin.getAverageValue()),new a(R.gradientXMax.getAverageValue(),R.gradientYMax.getAverageValue(),R.gradientZMax.getAverageValue())}}var v,A,I,x,C=this._owner.transform,L=C.position,y=r._tempVector39,D=c.renderMode;switch(this.scaleMode){case 0:var M=C.getWorldLossyScale();E=M,y.x=M.x,y.y=M.z,y.z=M.y,1===D&&(p=M);break;case 1:var O=C.localScale;E=O,y.x=O.x,y.y=O.z,y.z=O.y,1===D&&(p=O);break;case 2:E=C.getWorldLossyScale(),y.x=y.y=y.z=1,1===D&&(p=a._ONE)}switch(this._velocityOverLifetime&&this._velocityOverLifetime.enable||(v=new a(g.x*i,g.y*i,g.z*i),A=new a(S.x*i,S.y*i,S.z*i),2!=this.scaleMode?(a.add(o,v,d),a.multiply(E,d,d),a.add(l,A,u),a.multiply(E,u,u)):(a.multiply(E,o,d),a.add(d,v,d),a.multiply(E,l,u),a.add(u,A,u))),this.simulationSpace){case 0:break;case 1:a.add(d,L,d),a.add(u,L,u)}switch(this.startSizeType){case 0:if(this.threeDStartSize){var N=N;I=Math.max(N.x,N.y),1===D&&(x=N.y)}else I=this.startSizeConstant,1===D&&(x=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var b=b;I=Math.max(b.x,b.y),1===D&&(x=b.y)}else I=this.startSizeConstantMax,1===D&&(x=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enable){this._sizeOverLifetime.size;I*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var P,w,V=r._tempVector30;switch(D){case 0:P=I*r.halfKSqrtOf2,a.scale(y,I,V),a.subtract(d,V,d),a.add(u,V,u);break;case 1:var F=r._tempVector31,B=r._tempVector32,U=r._tempVector33,G=r._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enable||(a.multiply(p,S,B),a.multiply(p,g,U));var z=x*c.stretchedBillboardLengthScale,H=a.scalarLength(B)*c.stretchedBillboardSpeedScale+z,W=a.scalarLength(U)*c.stretchedBillboardSpeedScale+z,k=r._tempVector35,X=r._tempVector36;a.normalize(B,k),a.scale(k,H,G),a.subtract(A,G,G),a.normalize(U,X),a.scale(X,W,F),a.add(v,F,F),P=I*r.halfKSqrtOf2,a.scale(y,P,V);var Y=r._tempVector37,j=r._tempVector38;a.scale(k,.5,Y),a.scale(X,.5,j),a.multiply(Y,y,Y),a.multiply(j,y,j),a.add(d,j,d),a.min(d,G,d),a.subtract(d,V,d),a.subtract(u,Y,u),a.max(u,F,u),a.add(u,V,u);break;case 2:w=.5*(I*=Math.cos(.7853981633974483)),V.x=y.x*w,V.y=y.z*w,a.subtract(d,V,d),a.add(u,V,u);break;case 3:w=.5*(I*=Math.cos(.7853981633974483)),a.scale(y,w,V),a.subtract(d,V,d),a.add(u,V,u)}this._boundingBox.getCorners(this._boundingBoxCorners)}_updateEmission(){if(this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===t.Stat.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;e=Math.min(r._maxElapsedTime,e*this.simulationSpeed),this._updateParticles(e)}}_updateParticles(e){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enable&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))}_updateParticlesSimulationRestart(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enable&&this._advanceTime(e,e)}_retireActiveParticles(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}}_freeRetiredParticles(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}}_burst(e,r){for(var i=0,n=this._emission._bursts,a=n.length;this._burstsIndex<a;this._burstsIndex++){var s,o=n[this._burstsIndex],l=o.time;if(!(e<=l&&l<r))break;this.autoRandomSeed?s=t.MathUtil.lerp(o.minCount,o.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],s=t.MathUtil.lerp(o.minCount,o.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),i+=s}return i}_advanceTime(e,t){var r,i=this._emissionTime;this._emissionTime+=e;var n=0;if(this._emissionTime>this.duration){if(!this.looping){for(n=Math.min(this.maxParticles-this.aliveParticleCount,n),r=0;r<n;r++)this.emit(t);return this._isPlaying=!1,void this.stop()}n+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,n+=this._burst(0,this._emissionTime)}else n+=this._burst(i,this._emissionTime);for(n=Math.min(this.maxParticles-this.aliveParticleCount,n),r=0;r<n;r++)this.emit(t);var a=this.emission.emissionRate;if(a>0){var s=1/a;for(this._frameRateTime+=s,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=s;this._frameRateTime=Math.floor(t/s)*s}}_initBufferDatas(){if(this._vertexBuffer){this._vertexBuffer.destroy(),this._indexBuffer.destroy();var r=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;t.Resource._addMemory(-r,-r)}var i=t.LayaGL.instance,n=this._ownerRender,a=n.renderMode;if(-1!==a&&this.maxParticles>0){var s,o,l,_,h,c,d,u=0,m=(r=0,n.mesh);if(4===a){if(m){d=oi.vertexDeclaration,this._floatCountPerVertex=d.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=m._vertexCount;var f=this._bufferMaxParticles*this._vertexStride,T=f%65535;if(Math.floor(f/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");u=d.vertexStride*T,this._vertexBuffer=new ct(u,i.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=d,this._vertices=new Float32Array(this._floatCountPerVertex*T),this._indexStride=m._indexBuffer.indexCount;var E=m._indexBuffer.getData(),p=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new st(e.IndexFormat.UInt16,p,i.STATIC_DRAW),s=new Uint16Array(p),r=u+2*p,h=0,o=0;o<this._bufferMaxParticles;o++){var g=o*this._vertexStride;for(l=0,_=E.length;l<_;l++)s[h++]=g+E[l]}this._indexBuffer.setData(s),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}}else{for(d=si.vertexDeclaration,this._floatCountPerVertex=d.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,u=d.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new ct(u,i.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=d,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),o=0;o<this._bufferMaxParticles;o++)c=o*this._floatCountPerVertex*this._vertexStride,this._vertices[c]=-.5,this._vertices[c+1]=-.5,this._vertices[c+2]=0,this._vertices[c+3]=1,c+=this._floatCountPerVertex,this._vertices[c]=.5,this._vertices[c+1]=-.5,this._vertices[c+2]=1,this._vertices[c+3]=1,c+=this._floatCountPerVertex,this._vertices[c]=.5,this._vertices[c+1]=.5,this._vertices[c+2]=1,this._vertices[c+3]=0,c+=this._floatCountPerVertex,this._vertices[c]=-.5,this._vertices[c+1]=.5,this._vertices[c+2]=0,this._vertices[c+3]=0;for(this._indexStride=6,this._indexBuffer=new st(e.IndexFormat.UInt16,6*this._bufferMaxParticles,i.STATIC_DRAW),s=new Uint16Array(6*this._bufferMaxParticles),o=0;o<this._bufferMaxParticles;o++){h=6*o;var S=o*this._vertexStride,R=S+2;s[h++]=S,s[h++]=R,s[h++]=S+1,s[h++]=S,s[h++]=S+3,s[h++]=R}this._indexBuffer.setData(s),r=u+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}t.Resource._addMemory(r,r)}}destroy(){super.destroy();var e=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null}emit(e){var t=r._tempPosition,i=r._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(t,i):this._shape.generatePositionAndDirection(t,i,this._rand,this._randomSeeds):(t.x=t.y=t.z=0,i.x=i.y=0,i.z=1),this.addParticle(t,i,e)}addParticle(e,r,i){a.normalize(r,r);var n=this._firstFreeElement+1;if(n>=this._bufferMaxParticles&&(n=0),n===this._firstRetiredElement)return!1;var s,o,l,_,h,c,d,u,m,f,T=this._owner.transform;if(hi.create(this,this._ownerRender,T),this._currentTime-i>=hi.startLifeTime)return!0;switch(0==this.simulationSpace&&(s=T.position,o=T.rotation),this.startSpeedType){case 0:l=this.startSpeedConstant;break;case 2:this.autoRandomSeed?l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,Math.random()):(this._rand.seed=this._randomSeeds[8],l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,this._rand.getFloat()),this._randomSeeds[8]=this._rand.seed)}var E=this._velocityOverLifetime&&this._velocityOverLifetime.enable;if(E){var p=this._velocityOverLifetime.velocity.type;2===p||3===p?this.autoRandomSeed?(_=Math.random(),h=Math.random(),c=Math.random()):(this._rand.seed=this._randomSeeds[9],_=this._rand.getFloat(),h=this._rand.getFloat(),c=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):E=!1}else E=!1;var g=this._colorOverLifetime&&this._colorOverLifetime.enable;g?3===this._colorOverLifetime.color.type?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[10],d=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):g=!1:g=!1;var S=this._sizeOverLifetime&&this._sizeOverLifetime.enable;S?3===this._sizeOverLifetime.size.type?this.autoRandomSeed?u=Math.random():(this._rand.seed=this._randomSeeds[11],u=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):S=!1:S=!1;var R=this._rotationOverLifetime&&this._rotationOverLifetime.enable;if(R){var v=this._rotationOverLifetime.angularVelocity.type;2===v||3===v?this.autoRandomSeed?m=Math.random():(this._rand.seed=this._randomSeeds[12],m=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):R=!1}else R=!1;var A=this._textureSheetAnimation&&this._textureSheetAnimation.enable;A?3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?f=Math.random():(this._rand.seed=this._randomSeeds[15],f=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):A=!1:A=!1;var I,x,C,L,y,D,M=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,O=hi.startUVInfo[0],N=hi.startUVInfo[1],b=hi.startUVInfo[2],P=hi.startUVInfo[3],w=this._ownerRender;if(4===w.renderMode){var V=w.mesh._vertexBuffer;I=V.getFloat32Data();var F=V.vertexDeclaration;C=F.getVertexElementByUsage(ht.MESH_POSITION0)._offset/4;var B=F.getVertexElementByUsage(ht.MESH_COLOR0);L=B?B._offset/4:-1;var U=F.getVertexElementByUsage(ht.MESH_TEXTURECOORDINATE0);y=U?U._offset/4:-1,x=F.vertexStride/4,D=0}else{this._vertices[M+2]=b,this._vertices[M+3]=P+N;var G=M+this._floatCountPerVertex;this._vertices[G+2]=b+O,this._vertices[G+3]=P+N;var z=G+this._floatCountPerVertex;this._vertices[z+2]=b+O,this._vertices[z+3]=P;var H=z+this._floatCountPerVertex;this._vertices[H+2]=b,this._vertices[H+3]=P}for(var W=M,k=M+this._floatCountPerVertex*this._vertexStride;W<k;W+=this._floatCountPerVertex){var X;if(4===w.renderMode){X=W;var Y=x*D++,j=Y+C;this._vertices[X++]=I[j++],this._vertices[X++]=I[j++],this._vertices[X++]=I[j],-1===L?(this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1):(j=Y+L,this._vertices[X++]=I[j++],this._vertices[X++]=I[j++],this._vertices[X++]=I[j++],this._vertices[X++]=I[j]),-1===y?(this._vertices[X++]=0,this._vertices[X++]=0):(j=Y+y,this._vertices[X++]=b+I[j++]*O,this._vertices[X++]=P+I[j]*N)}else X=W+4;switch(this._vertices[X++]=e.x,this._vertices[X++]=e.y,this._vertices[X++]=e.z,this._vertices[X++]=hi.startLifeTime,this._vertices[X++]=r.x,this._vertices[X++]=r.y,this._vertices[X++]=r.z,this._vertices[X++]=i,this._vertices[X++]=hi.startColor.x,this._vertices[X++]=hi.startColor.y,this._vertices[X++]=hi.startColor.z,this._vertices[X++]=hi.startColor.w,this._vertices[X++]=hi.startSize[0],this._vertices[X++]=hi.startSize[1],this._vertices[X++]=hi.startSize[2],this._vertices[X++]=hi.startRotation[0],this._vertices[X++]=hi.startRotation[1],this._vertices[X++]=hi.startRotation[2],this._vertices[X++]=l,g&&(this._vertices[X+1]=d),S&&(this._vertices[X+2]=u),R&&(this._vertices[X+3]=m),A&&(this._vertices[X+4]=f),E&&(this._vertices[X+5]=_,this._vertices[X+6]=h,this._vertices[X+7]=c),this.simulationSpace){case 0:X+=8,this._vertices[X++]=s.x,this._vertices[X++]=s.y,this._vertices[X++]=s.z,this._vertices[X++]=o.x,this._vertices[X++]=o.y,this._vertices[X++]=o.z,this._vertices[X++]=o.w;break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=n,!0}addNewParticlesToVertexBuffer(){var e,t=this._vertexStride*this._floatCountPerVertex*4;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._firstFreeElement-this._firstNewElement)*t)):(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._bufferMaxParticles-this._firstNewElement)*t),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices.buffer,0,0,this._firstFreeElement*t)),this._firstNewElement=this._firstFreeElement}_getType(){return r._type}_prepareRender(e){return this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement}_render(e){var r;this._bufferState.bind();var i=t.LayaGL.instance;this._firstActiveElement<this._firstFreeElement?(r=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,i.drawElements(i.TRIANGLES,r,i.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++):(r=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,i.drawElements(i.TRIANGLES,r,i.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++,this._firstFreeElement>0&&(r=this._firstFreeElement*this._indexStride,i.drawElements(i.TRIANGLES,r,i.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++))}play(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,i=this._randomSeeds.length;e<i;e++)this._randomSeeds[e]=this.randomSeed[0]+r._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=t.Stat.loopCount}pause(){this._isPaused=!0}simulate(e,t=!0){this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()}stop(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0}cloneTo(e){var t=e;t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.autoRandomSeed=this.autoRandomSeed,t.randomSeed[0]=this.randomSeed[0],t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex}clone(){var e=new r(null);return this.cloneTo(e),e}}return r._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447]),r.halfKSqrtOf2=.71,r._maxElapsedTime=1/3,r._tempVector30=new a,r._tempVector31=new a,r._tempVector32=new a,r._tempVector33=new a,r._tempVector34=new a,r._tempVector35=new a,r._tempVector36=new a,r._tempVector37=new a,r._tempVector38=new a,r._tempVector39=new a,r._tempPosition=new a,r._tempDirection=new a,r._type=kt._typeCounter++,r})();class di extends jt{constructor(){super(null),this._render=new ni(this),this._particleSystem=new ci(this);var e=this._render._renderElements[0]=new Qt;e.setTransform(this._transform),e.render=this._render,e.setGeometry(this._particleSystem),e.material=ii.defaultMaterial}static __init__(){ri.SHADERDEFINE_RENDERMODE_BILLBOARD=Ae.getDefineByName("SPHERHBILLBOARD"),ri.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=Ae.getDefineByName("STRETCHEDBILLBOARD"),ri.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=Ae.getDefineByName("HORIZONTALBILLBOARD"),ri.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=Ae.getDefineByName("VERTICALBILLBOARD"),ri.SHADERDEFINE_COLOROVERLIFETIME=Ae.getDefineByName("COLOROVERLIFETIME"),ri.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=Ae.getDefineByName("RANDOMCOLOROVERLIFETIME"),ri.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=Ae.getDefineByName("VELOCITYOVERLIFETIMECONSTANT"),ri.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=Ae.getDefineByName("VELOCITYOVERLIFETIMECURVE"),ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=Ae.getDefineByName("VELOCITYOVERLIFETIMERANDOMCONSTANT"),ri.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=Ae.getDefineByName("VELOCITYOVERLIFETIMERANDOMCURVE"),ri.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=Ae.getDefineByName("TEXTURESHEETANIMATIONCURVE"),ri.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=Ae.getDefineByName("TEXTURESHEETANIMATIONRANDOMCURVE"),ri.SHADERDEFINE_ROTATIONOVERLIFETIME=Ae.getDefineByName("ROTATIONOVERLIFETIME"),ri.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=Ae.getDefineByName("ROTATIONOVERLIFETIMESEPERATE"),ri.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=Ae.getDefineByName("ROTATIONOVERLIFETIMECONSTANT"),ri.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=Ae.getDefineByName("ROTATIONOVERLIFETIMECURVE"),ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=Ae.getDefineByName("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),ri.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=Ae.getDefineByName("ROTATIONOVERLIFETIMERANDOMCURVES"),ri.SHADERDEFINE_SIZEOVERLIFETIMECURVE=Ae.getDefineByName("SIZEOVERLIFETIMECURVE"),ri.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=Ae.getDefineByName("SIZEOVERLIFETIMECURVESEPERATE"),ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=Ae.getDefineByName("SIZEOVERLIFETIMERANDOMCURVES"),ri.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=Ae.getDefineByName("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),ri.SHADERDEFINE_RENDERMODE_MESH=Ae.getDefineByName("RENDERMODE_MESH"),ri.SHADERDEFINE_SHAPE=Ae.getDefineByName("SHAPE")}get particleSystem(){return this._particleSystem}get particleRenderer(){return this._render}_parseModule(e,r){for(var i in r)switch(i){case"bases":var n=r.bases;for(var a in n)e[a]=n[a];break;case"vector2s":var s=r.vector2s;for(var a in s){var o=e[a],l=s[a];o.setValue(l[0],l[1]),e[a]=o}break;case"vector3s":var _=r.vector3s;for(var a in _){var h=e[a],c=_[a];h.setValue(c[0],c[1],c[2]),e[a]=h}break;case"vector4s":var d=r.vector4s;for(var a in d){var u=e[a],m=d[a];u.setValue(m[0],m[1],m[2],m[3]),e[a]=u}break;case"gradientDataNumbers":var f=r.gradientDataNumbers;for(var a in f){for(var T=e[a],E=r[a],p=0,g=E.length;p<g;p++){var S=E[p];T.add(S.key,S.value)}e[a]=T}break;case"resources":var R=r.resources;for(var a in R)e[a]=t.Loader.getRes(R[a]);break;case"bursts":var v=r.bursts;for(p=0,g=v.length;p<g;p++){var A=v[p];e.addBurst(new wr(A.time,A.min,A.max))}break;case"randomSeed":e.randomSeed[0]=r.randomSeed;break;case"shapeType":case"type":case"color":case"size":case"frame":case"startFrame":case"angularVelocity":case"velocity":break;default:throw"ShurikenParticle3D:unknown type."}}_parse(e,t){if(super._parse(e,t),e.main){var r=this.particleSystem,i=this.particleRenderer;this._parseModule(i,e.renderer),this._parseModule(r,e.main),this._parseModule(r.emission,e.emission);var s=e.shape;if(s){var o;switch(s.shapeType){case 0:o=new Kr;break;case 1:o=new Qr;break;case 2:o=new qr;break;case 3:o=new jr;break;case 7:o=new Zr;break;default:throw"ShuriKenParticle3D:unknown shape type."}this._parseModule(o,s),r.shape=o}var l=e.velocityOverLifetime;if(l){var _,h=l.velocity;switch(h.type){case 0:var c=h.constant;_=Wr.createByConstant(c?new a(c[0],c[1],c[2]):new a(0,0,0));break;case 1:_=Wr.createByGradient(this._initParticleVelocity(h.gradientX),this._initParticleVelocity(h.gradientY),this._initParticleVelocity(h.gradientZ));break;case 2:var d=h.constantMin,u=h.constantMax;_=Wr.createByRandomTwoConstant(d?new a(d[0],d[1],d[2]):new a(0,0,0),u?new a(u[0],u[1],u[2]):new a(0,0,0));break;case 3:_=Wr.createByRandomTwoGradient(this._initParticleVelocity(h.gradientXMin),this._initParticleVelocity(h.gradientXMax),this._initParticleVelocity(h.gradientYMin),this._initParticleVelocity(h.gradientYMax),this._initParticleVelocity(h.gradientZMin),this._initParticleVelocity(h.gradientZMax))}var m=new ti(_);this._parseModule(m,l),r.velocityOverLifetime=m}var f=e.colorOverLifetime;if(f){var T,E=f.color;switch(E.type){case 0:var p=E.constant;T=Vr.createByConstant(p?new n(p[0],p[1],p[2],p[3]):new n(0,0,0,0));break;case 1:T=Vr.createByGradient(this._initParticleColor(E.gradient));break;case 2:var g=E.constantMin,S=E.constantMax;T=Vr.createByRandomTwoConstant(g?new n(g[0],g[1],g[2],g[3]):new n(0,0,0,0),g?new n(S[0],S[1],S[2],S[3]):new n(0,0,0,0));break;case 3:T=Vr.createByRandomTwoGradient(this._initParticleColor(E.gradientMin),this._initParticleColor(E.gradientMax))}var R=new Fr(T);this._parseModule(R,f),r.colorOverLifetime=R}var v=e.sizeOverLifetime;if(v){var A,I=v.size;switch(I.type){case 0:A=I.separateAxes?Hr.createByGradientSeparate(this._initParticleSize(I.gradientX),this._initParticleSize(I.gradientY),this._initParticleSize(I.gradientZ)):Hr.createByGradient(this._initParticleSize(I.gradient));break;case 1:if(I.separateAxes){var x=I.constantMinSeparate,C=I.constantMaxSeparate;A=Hr.createByRandomTwoConstantSeparate(x?new a(x[0],x[1],x[2]):new a(0,0,0),C?new a(C[0],C[1],C[2]):new a(0,0,0))}else A=Hr.createByRandomTwoConstant(I.constantMin||0,I.constantMax||0);break;case 2:A=I.separateAxes?Hr.createByRandomTwoGradientSeparate(this._initParticleSize(I.gradientXMin),this._initParticleSize(I.gradientYMin),this._initParticleSize(I.gradientZMin),this._initParticleSize(I.gradientXMax),this._initParticleSize(I.gradientYMax),this._initParticleSize(I.gradientZMax)):Hr.createByRandomTwoGradient(this._initParticleSize(I.gradientMin),this._initParticleSize(I.gradientMax))}var L=new Jr(A);this._parseModule(L,v),r.sizeOverLifetime=L}var y=e.rotationOverLifetime;if(y){var D,M=y.angularVelocity;switch(M.type){case 0:if(M.separateAxes){var O=M.constantSeparate;D=Ur.createByConstantSeparate(O?new a(O[0],O[1],O[2]):new a(0,0,Math.PI/4))}else D=Ur.createByConstant(M.constant||Math.PI/4);break;case 1:D=M.separateAxes?Ur.createByGradientSeparate(this._initParticleRotation(M.gradientX),this._initParticleRotation(M.gradientY),this._initParticleRotation(M.gradientZ)):Ur.createByGradient(this._initParticleRotation(M.gradient));break;case 2:if(M.separateAxes){var N=M.constantMinSeparate,b=M.constantMaxSeparate;D=Ur.createByRandomTwoConstantSeparate(N?new a(N[0],N[1],N[2]):new a(0,0,0),b?new a(b[0],b[1],b[2]):new a(0,0,Math.PI/4))}else D=Ur.createByRandomTwoConstant(M.constantMin||0,M.constantMax||Math.PI/4);break;case 3:M.separateAxes||(D=Ur.createByRandomTwoGradient(this._initParticleRotation(M.gradientMin),this._initParticleRotation(M.gradientMax)))}var P=new kr(D);this._parseModule(P,y),r.rotationOverLifetime=P}var w=e.textureSheetAnimation;if(w){var V,F=w.frame;switch(F.type){case 0:V=Br.createByConstant(F.constant);break;case 1:V=Br.createByOverTime(this._initParticleFrame(F.overTime));break;case 2:V=Br.createByRandomTwoConstant(F.constantMin,F.constantMax);break;case 3:V=Br.createByRandomTwoOverTime(this._initParticleFrame(F.overTimeMin),this._initParticleFrame(F.overTimeMax))}var B,U=w.startFrame;switch(U.type){case 0:B=$r.createByConstant(U.constant);break;case 1:B=$r.createByRandomTwoConstant(U.constantMin,U.constantMax)}var G=new ei(V,B);this._parseModule(G,w),r.textureSheetAnimation=G}}else this._parseOld(e)}_activeHierarchy(e){super._activeHierarchy(e),this.particleSystem.playOnAwake&&this.particleSystem.play()}_inActiveHierarchy(e){super._inActiveHierarchy(e),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)}_cloneTo(e,t,r){var i=e,n=i._particleSystem;this._particleSystem.cloneTo(n);var a=i._render,s=this._render;a.sharedMaterials=s.sharedMaterials,a.enable=s.enable,a.renderMode=s.renderMode,a.mesh=s.mesh,a.stretchedBillboardCameraSpeedScale=s.stretchedBillboardCameraSpeedScale,a.stretchedBillboardSpeedScale=s.stretchedBillboardSpeedScale,a.stretchedBillboardLengthScale=s.stretchedBillboardLengthScale,a.sortingFudge=s.sortingFudge,super._cloneTo(e,t,r)}destroy(e=!0){this.destroyed||(super.destroy(e),this._particleSystem.destroy(),this._particleSystem=null)}_create(){return new di}_parseOld(e){const r=Math.PI/180;var s,o,l,_=this.particleRenderer,h=e.material;h&&(l=t.Loader.getRes(h.path)),_.sharedMaterial=l;var c=e.meshPath;c&&(_.mesh=t.Loader.getRes(c)),_.renderMode=e.renderMode,_.stretchedBillboardCameraSpeedScale=e.stretchedBillboardCameraSpeedScale,_.stretchedBillboardSpeedScale=e.stretchedBillboardSpeedScale,_.stretchedBillboardLengthScale=e.stretchedBillboardLengthScale,_.sortingFudge=e.sortingFudge?e.sortingFudge:0;var d=this.particleSystem;d.isPerformanceMode=e.isPerformanceMode,d.duration=e.duration,d.looping=e.looping,d.prewarm=e.prewarm,d.startDelayType=e.startDelayType,d.startDelay=e.startDelay,d.startDelayMin=e.startDelayMin,d.startDelayMax=e.startDelayMax,d.startLifetimeType=e.startLifetimeType,d.startLifetimeConstant=e.startLifetimeConstant,d.startLifeTimeGradient=di._initStartLife(e.startLifetimeGradient),d.startLifetimeConstantMin=e.startLifetimeConstantMin,d.startLifetimeConstantMax=e.startLifetimeConstantMax,d.startLifeTimeGradientMin=di._initStartLife(e.startLifetimeGradientMin),d.startLifeTimeGradientMax=di._initStartLife(e.startLifetimeGradientMax),d.startSpeedType=e.startSpeedType,d.startSpeedConstant=e.startSpeedConstant,d.startSpeedConstantMin=e.startSpeedConstantMin,d.startSpeedConstantMax=e.startSpeedConstantMax,d.threeDStartSize=e.threeDStartSize,d.startSizeType=e.startSizeType,d.startSizeConstant=e.startSizeConstant;var u=e.startSizeConstantSeparate,m=d.startSizeConstantSeparate;m.x=u[0],m.y=u[1],m.z=u[2],d.startSizeConstantMin=e.startSizeConstantMin,d.startSizeConstantMax=e.startSizeConstantMax;var f=e.startSizeConstantMinSeparate,T=d.startSizeConstantMinSeparate;T.x=f[0],T.y=f[1],T.z=f[2];var E=e.startSizeConstantMaxSeparate,p=d.startSizeConstantMaxSeparate;p.x=E[0],p.y=E[1],p.z=E[2],d.threeDStartRotation=e.threeDStartRotation,d.startRotationType=e.startRotationType,d.startRotationConstant=e.startRotationConstant*r;var g=e.startRotationConstantSeparate,S=d.startRotationConstantSeparate;S.x=g[0]*r,S.y=g[1]*r,S.z=g[2]*r,d.startRotationConstantMin=e.startRotationConstantMin*r,d.startRotationConstantMax=e.startRotationConstantMax*r;var R=e.startRotationConstantMinSeparate,v=d.startRotationConstantMinSeparate;v.x=R[0]*r,v.y=R[1]*r,v.z=R[2]*r;var A=e.startRotationConstantMaxSeparate,I=d.startRotationConstantMaxSeparate;I.x=A[0]*r,I.y=A[1]*r,I.z=A[2]*r,d.randomizeRotationDirection=e.randomizeRotationDirection,d.startColorType=e.startColorType;var x=e.startColorConstant,C=d.startColorConstant;C.x=x[0],C.y=x[1],C.z=x[2],C.w=x[3];var L=e.startColorConstantMin,y=d.startColorConstantMin;y.x=L[0],y.y=L[1],y.z=L[2],y.w=L[3];var D=e.startColorConstantMax,M=d.startColorConstantMax;M.x=D[0],M.y=D[1],M.z=D[2],M.w=D[3],d.gravityModifier=e.gravityModifier,d.simulationSpace=e.simulationSpace,void 0!==e.simulationSpeed&&(d.simulationSpeed=e.simulationSpeed),d.scaleMode=e.scaleMode,d.playOnAwake=e.playOnAwake,d.maxParticles=e.maxParticles;var O=e.autoRandomSeed;null!=O&&(d.autoRandomSeed=O);var N=e.randomSeed;null!=N&&(d.randomSeed[0]=N);var b=e.emission,P=d.emission;if(b){P.emissionRate=b.emissionRate;var w=b.bursts;if(w)for(s=0,o=w.length;s<o;s++){var V=w[s];P.addBurst(new wr(V.time,V.min,V.max))}P.enable=b.enable}else P.enable=!1;var F=e.shape;if(F){var B;switch(F.shapeType){case 0:var U;B=U=new Kr,U.radius=F.sphereRadius,U.emitFromShell=F.sphereEmitFromShell,U.randomDirection=F.sphereRandomDirection;break;case 1:var G;B=G=new Qr,G.radius=F.hemiSphereRadius,G.emitFromShell=F.hemiSphereEmitFromShell,G.randomDirection=F.hemiSphereRandomDirection;break;case 2:var z;B=z=new qr,z.angle=F.coneAngle*r,z.radius=F.coneRadius,z.length=F.coneLength,z.emitType=F.coneEmitType,z.randomDirection=F.coneRandomDirection;break;case 3:var H;B=H=new jr,H.x=F.boxX,H.y=F.boxY,H.z=F.boxZ,H.randomDirection=F.boxRandomDirection;break;case 7:var W;B=W=new Zr,W.radius=F.circleRadius,W.arc=F.circleArc*r,W.emitFromEdge=F.circleEmitFromEdge,W.randomDirection=F.circleRandomDirection;break;default:var k;B=k=new Zr,k.radius=F.circleRadius,k.arc=F.circleArc*r,k.emitFromEdge=F.circleEmitFromEdge,k.randomDirection=F.circleRandomDirection}B.enable=F.enable,d.shape=B}var X=e.velocityOverLifetime;if(X){var Y,j=X.velocity;switch(j.type){case 0:var Z=j.constant;Y=Wr.createByConstant(new a(Z[0],Z[1],Z[2]));break;case 1:Y=Wr.createByGradient(this._initParticleVelocity(j.gradientX),this._initParticleVelocity(j.gradientY),this._initParticleVelocity(j.gradientZ));break;case 2:var q=j.constantMin,Q=j.constantMax;Y=Wr.createByRandomTwoConstant(new a(q[0],q[1],q[2]),new a(Q[0],Q[1],Q[2]));break;case 3:Y=Wr.createByRandomTwoGradient(this._initParticleVelocity(j.gradientXMin),this._initParticleVelocity(j.gradientXMax),this._initParticleVelocity(j.gradientYMin),this._initParticleVelocity(j.gradientYMax),this._initParticleVelocity(j.gradientZMin),this._initParticleVelocity(j.gradientZMax))}var K=new ti(Y);K.space=X.space,K.enable=X.enable,d.velocityOverLifetime=K}var J=e.colorOverLifetime;if(J){var $,ee=J.color;switch(ee.type){case 0:var te=ee.constant;$=Vr.createByConstant(new n(te[0],te[1],te[2],te[3]));break;case 1:$=Vr.createByGradient(this._initParticleColor(ee.gradient));break;case 2:var re=ee.constantMin,ie=ee.constantMax;$=Vr.createByRandomTwoConstant(new n(re[0],re[1],re[2],re[3]),new n(ie[0],ie[1],ie[2],ie[3]));break;case 3:$=Vr.createByRandomTwoGradient(this._initParticleColor(ee.gradientMin),this._initParticleColor(ee.gradientMax))}var ne=new Fr($);ne.enable=J.enable,d.colorOverLifetime=ne}var ae=e.sizeOverLifetime;if(ae){var se,oe=ae.size;switch(oe.type){case 0:se=oe.separateAxes?Hr.createByGradientSeparate(this._initParticleSize(oe.gradientX),this._initParticleSize(oe.gradientY),this._initParticleSize(oe.gradientZ)):Hr.createByGradient(this._initParticleSize(oe.gradient));break;case 1:if(oe.separateAxes){var le=oe.constantMinSeparate,_e=oe.constantMaxSeparate;se=Hr.createByRandomTwoConstantSeparate(new a(le[0],le[1],le[2]),new a(_e[0],_e[1],_e[2]))}else se=Hr.createByRandomTwoConstant(oe.constantMin,oe.constantMax);break;case 2:se=oe.separateAxes?Hr.createByRandomTwoGradientSeparate(this._initParticleSize(oe.gradientXMin),this._initParticleSize(oe.gradientYMin),this._initParticleSize(oe.gradientZMin),this._initParticleSize(oe.gradientXMax),this._initParticleSize(oe.gradientYMax),this._initParticleSize(oe.gradientZMax)):Hr.createByRandomTwoGradient(this._initParticleSize(oe.gradientMin),this._initParticleSize(oe.gradientMax))}var he=new Jr(se);he.enable=ae.enable,d.sizeOverLifetime=he}var ce=e.rotationOverLifetime;if(ce){var de,ue=ce.angularVelocity;switch(ue.type){case 0:if(ue.separateAxes){var me=ue.constantSeparate;de=Ur.createByConstantSeparate(new a(me[0]*r,me[1]*r,me[2]*r))}else de=Ur.createByConstant(ue.constant*r);break;case 1:de=ue.separateAxes?Ur.createByGradientSeparate(this._initParticleRotation(ue.gradientX),this._initParticleRotation(ue.gradientY),this._initParticleRotation(ue.gradientZ)):Ur.createByGradient(this._initParticleRotation(ue.gradient));break;case 2:if(ue.separateAxes){var fe=ue.constantMinSeparate,Te=ue.constantMaxSeparate;de=Ur.createByRandomTwoConstantSeparate(new a(fe[0]*r,fe[1]*r,fe[2]*r),new a(Te[0]*r,Te[1]*r,Te[2]*r))}else de=Ur.createByRandomTwoConstant(ue.constantMin*r,ue.constantMax*r);break;case 3:ue.separateAxes||(de=Ur.createByRandomTwoGradient(this._initParticleRotation(ue.gradientMin),this._initParticleRotation(ue.gradientMax)))}var Ee=new kr(de);Ee.enable=ce.enable,d.rotationOverLifetime=Ee}var pe=e.textureSheetAnimation;if(pe){var ge,Se=pe.frame;switch(Se.type){case 0:ge=Br.createByConstant(Se.constant);break;case 1:ge=Br.createByOverTime(this._initParticleFrame(Se.overTime));break;case 2:ge=Br.createByRandomTwoConstant(Se.constantMin,Se.constantMax);break;case 3:ge=Br.createByRandomTwoOverTime(this._initParticleFrame(Se.overTimeMin),this._initParticleFrame(Se.overTimeMax))}var Re,ve=pe.startFrame;switch(ve.type){case 0:Re=$r.createByConstant(ve.constant);break;case 1:Re=$r.createByRandomTwoConstant(ve.constantMin,ve.constantMax)}var Ae=new ei(ge,Re);Ae.enable=pe.enable;var Ie=pe.tiles;Ae.tiles=new i(Ie[0],Ie[1]),Ae.type=pe.type,Ae.randomRow=pe.randomRow;var xe=pe.rowIndex;void 0!==xe&&(Ae.rowIndex=xe),Ae.cycles=pe.cycles,d.textureSheetAnimation=Ae}}_initParticleColor(e){var t=new Pr(4,4);if(e){var r,i,n=e.alphas;if(n)for(r=0,i=n.length;r<i;r++){3==r&&i>4&&(r=i-1,console.warn("GradientDataColor warning:alpha data length is large than 4, will ignore the middle data."));var a=n[r];t.addColorAlpha(a.key,a.value)}else t.addColorAlpha(0,1),t.addColorAlpha(1,1);var s=e.rgbs;if(s)for(r=0,i=s.length;r<i;r++){3==r&&i>4&&(r=i-1,console.warn("GradientDataColor warning:rgb data length is large than 4, will ignore the middle data."));var o=s[r],l=o.value;t.addColorRGB(o.key,new Ge(l[0],l[1],l[2],1))}else t.addColorRGB(0,new Ge(1,1,1,1)),t.addColorRGB(1,new Ge(1,1,1,1))}else t.addColorAlpha(0,1),t.addColorAlpha(1,1),t.addColorRGB(0,new Ge(1,1,1,1)),t.addColorRGB(1,new Ge(1,1,1,1));return t}_initParticleFrame(e){var t=new Gr;if(e)for(var r=e.frames,i=0,n=r.length;i<n;i++){var a=r[i];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}static _initStartLife(e){for(var t=new zr,r=e.startLifetimes,i=0,n=r.length;i<n;i++){var a=r[i];t.add(a.key,a.value)}return t}_initParticleVelocity(e){for(var t=new zr,r=e.velocitys,i=0,n=r.length;i<n;i++){var a=r[i];t.add(a.key,a.value)}return t}_initParticleSize(e){var t=new zr;if(e)for(var r=e.sizes,i=0,n=r.length;i<n;i++){var a=r[i];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}_initParticleRotation(e){for(var t=new zr,r=e.angularVelocitys,i=0,n=r.length;i<n;i++){var a=r[i];t.add(a.key,a.value/180*Math.PI)}return t}}class ui{}let mi=(()=>{class e extends yr{constructor(e){super(e),this._bones=[],this._skinnedDataLoopMarks=[],this._localBounds=new Wt(a._ZERO,a._ZERO),this._cacheAnimationNode=[]}get localBounds(){return this._localBounds}set localBounds(e){this._localBounds=e}get rootBone(){return this._cacheRootBone}set rootBone(e){this._cacheRootBone!=e&&(this._cacheRootBone?this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e?e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootBone=e,this._onWorldMatNeedChange(d.TRANSFORM_WORLDPOSITION|d.TRANSFORM_WORLDQUATERNION|d.TRANSFORM_WORLDSCALE))}get bones(){return this._bones}_computeSkinnedData(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,t=this._cacheMesh._skinnedMatrixCaches,r=0,i=this._cacheMesh.subMeshCount;r<i;r++)for(var n=this._cacheMesh.getSubMesh(r)._boneIndicesList,a=this._skinnedData[r],s=0,o=n.length;s<o;s++){var l=n[s];this._computeSubSkinnedData(e,l,a[s],t)}}_computeSubSkinnedData(e,r,i,n){for(var a=0,s=r.length;a<s;a++){var o=r[a];if(this._skinnedDataLoopMarks[o]===t.Stat.loopCount)for(var l=n[o],_=this._skinnedData[l.subMeshIndex][l.batchIndex],h=16*l.batchBoneIndex,c=16*a,d=0;d<16;d++)i[c+d]=_[h+d];else this._cacheAvatar?k._mulMatrixArray(this._cacheAnimationNode[o].transform.getWorldMatrix(),e[o].elements,0,i,16*a):k._mulMatrixArray(this._bones[o].transform.worldMatrix.elements,e[o].elements,0,i,16*a),this._skinnedDataLoopMarks[o]=t.Stat.loopCount}}_onWorldMatNeedChange(e){this._boundsChange=!0,this._octreeNode&&(this._cacheAvatar?-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this):(e&=d.TRANSFORM_WORLDPOSITION|d.TRANSFORM_WORLDQUATERNION|d.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this))}_createRenderElement(){return new Qt}_onMeshChange(e){super._onMeshChange(e),this._cacheMesh=e;var t=e.subMeshCount;this._skinnedData=[],this._skinnedDataLoopMarks.length=e._inverseBindPoses.length;for(var r=0;r<t;r++)for(var i=e.getSubMesh(r)._boneIndicesList,n=i.length,a=this._skinnedData[r]=[],s=0;s<n;s++)a[s]=new Float32Array(16*i[s].length);this._cacheAvatar&&e&&this._getCacheAnimationNodes()}_setCacheAnimator(e){this._cacheAnimator=e,this._shaderValues.addDefine(ui.SHADERDEFINE_BONE),this._setRootNode()}_calculateBoundingBox(){if(this._cacheAvatar)if(this._cacheAnimator&&this._rootBone){var r=e._tempMatrix4x4;k.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheRootAnimationNode.transform.getWorldMatrix(),r),this._localBounds._tranform(r,this._bounds)}else super._calculateBoundingBox();else this._cacheRootBone?this._localBounds._tranform(this._cacheRootBone.transform.worldMatrix,this._bounds):this._localBounds._tranform(this._owner.transform.worldMatrix,this._bounds);if(t.Render.supportWebGLPlusCulling){var i=this._bounds.getMin(),n=this._bounds.getMax(),a=We._cullingBuffer;a[this._cullingBufferIndex+1]=i.x,a[this._cullingBufferIndex+2]=i.y,a[this._cullingBufferIndex+3]=i.z,a[this._cullingBufferIndex+4]=n.x,a[this._cullingBufferIndex+5]=n.y,a[this._cullingBufferIndex+6]=n.z}}_renderUpdate(e,t){if(this._cacheAnimator)if(this._computeSkinnedData(),this._cacheAvatar){var r=this._cacheAnimator.owner._transform;this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,r.worldMatrix)}else this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,h.DEFAULT);else this._shaderValues.setMatrix4x4(ft.WORLDMATRIX,t.worldMatrix)}_renderUpdateWithCamera(e,t){var r=e.projectionViewMatrix;if(this._cacheAnimator)if(this._cacheAvatar){var i=this._cacheAnimator.owner._transform;h.multiply(r,i.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ft.MVPMATRIX,this._projectionViewWorldMatrix)}else this._shaderValues.setMatrix4x4(ft.MVPMATRIX,r);else h.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ft.MVPMATRIX,this._projectionViewWorldMatrix)}_destroy(){super._destroy(),this._cacheAvatar?this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._cacheRootBone?!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner&&!this._owner.destroyed&&this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange)}get bounds(){return(this._boundsChange||this._cacheAvatar)&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}_setRootBone(e){this._rootBone=e,this._setRootNode()}_setRootNode(){var e;e=this._cacheAnimator&&this._rootBone&&this._cacheAvatar?this._cacheAnimator._avatarNodeMap[this._rootBone]:null,this._cacheRootAnimationNode!=e&&(this._onWorldMatNeedChange(d.TRANSFORM_WORLDPOSITION|d.TRANSFORM_WORLDQUATERNION|d.TRANSFORM_WORLDSCALE),this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e&&e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode=e)}_getCacheAnimationNodes(){var e=this._cacheMesh._boneNames,r=this._cacheMesh._inverseBindPoses.length;if(t.Render.supportWebGLPlusAnimation){this._cacheAnimationNodeIndices=new Uint16Array(r);var i=this._cacheAnimator._avatarNodeMap;for(s=0;s<r;s++){var n=i[e[s]];this._cacheAnimationNodeIndices[s]=n?n._worldMatrixIndex:0}}else{this._cacheAnimationNode.length=r;for(var a=this._cacheAnimator._avatarNodeMap,s=0;s<r;s++){var o=a[e[s]];this._cacheAnimationNode[s]=o}}}_setCacheAvatar(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar=e,e&&(this._shaderValues.addDefine(ui.SHADERDEFINE_BONE),this._getCacheAnimationNodes())):this._cacheAvatar=e,this._setRootNode())}_computeSubSkinnedDataNative(e,r,i,n,a){t.LayaGL.instance.computeSubSkinnedData(e,r,i,n,a)}_computeSkinnedDataForNative(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,r=this._cacheMesh._skinnedMatrixCaches,i=0,n=this._cacheMesh.subMeshCount;i<n;i++)for(var a=this._cacheMesh.getSubMesh(i)._boneIndicesList,s=this._skinnedData[i],o=0,l=a.length;o<l;o++){var _=a[o];this._cacheAvatar&&t.Render.supportWebGLPlusAnimation?this._computeSubSkinnedDataNative(this._cacheAnimator._animationNodeWorldMatrixs,this._cacheAnimationNodeIndices,this._cacheMesh._inverseBindPosesBuffer,_,s[o]):this._computeSubSkinnedData(e,_,s[o],r)}}}return e._tempMatrix4x4=new h,e})(),fi=(()=>{class e extends jt{constructor(e=null,t=null){super(t),this._meshFilter=new Dr(this),this._render=new mi(this),e&&(this._meshFilter.sharedMesh=e)}static __init__(){ui.SHADERDEFINE_BONE=Ae.getDefineByName("BONE")}get meshFilter(){return this._meshFilter}get skinnedMeshRenderer(){return this._render}_parse(e,r){super._parse(e,r);var i=this.skinnedMeshRenderer,s=e.lightmapIndex;null!=s&&(i.lightmapIndex=s);var o,l=e.lightmapScaleOffset;if(l&&(i.lightmapScaleOffset=new n(l[0],l[1],l[2],l[3])),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow),o=e.meshPath){var _=t.Loader.getRes(o);_&&(this.meshFilter.sharedMesh=_)}var h=e.materials;if(h){var c=i.sharedMaterials,d=h.length;c.length=d;for(var u=0;u<d;u++)c[u]=t.Loader.getRes(h[u].path);i.sharedMaterials=c}var m=e.boundBox,f=m.min,T=m.max;if(i.localBounds.setMin(new a(f[0],f[1],f[2])),i.localBounds.setMax(new a(T[0],T[1],T[2])),r){var E=e.rootBone;i.rootBone=r[E];var p,g=e.bones;for(u=0,p=g.length;u<p;u++)i.bones.push(r[g[u]])}else e.rootBone&&i._setRootBone(e.rootBone)}_changeHierarchyAnimator(e){super._changeHierarchyAnimator(e),this.skinnedMeshRenderer._setCacheAnimator(e)}_changeAnimatorAvatar(e){this.skinnedMeshRenderer._setCacheAvatar(e)}_cloneTo(t,r,i){var n=t;n.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var a=this._render,s=n._render;s.enable=a.enable,s.sharedMaterials=a.sharedMaterials,s.castShadow=a.castShadow;var o=a.lightmapScaleOffset;o&&(s.lightmapScaleOffset=o.clone()),s.receiveShadow=a.receiveShadow,s.sortingFudge=a.sortingFudge,s._rootBone=a._rootBone;var l=a.bones,_=s.bones,h=l.length;_.length=h;var c=a.rootBone;if(c){var d=k._getHierarchyPath(r,c,e._tempArray0);s.rootBone=d?k._getNodeByHierarchyPath(i,d):c}for(var u=0;u<l.length;u++)d=k._getHierarchyPath(r,l[u],e._tempArray0),_[u]=d?k._getNodeByHierarchyPath(i,d):l[u];var m=a.localBounds;m&&m.cloneTo(s.localBounds),super._cloneTo(t,r,i)}destroy(e=!0){this.destroyed||(super.destroy(e),this._meshFilter.destroy())}_create(){return new e}}return e._tempArray0=[],e.BONES=Ae.propertyNameToID("u_Bones"),e})(),Ti=(()=>{class e extends De{constructor(){super(),this.setShaderName("Trail"),this._color=new n(1,1,1,1),this._shaderValues.setVector(e.TINTCOLOR,new n(1,1,1,1)),this.renderMode=e.RENDERMODE_ALPHABLENDED}static __initDefine__(){e.SHADERDEFINE_MAINTEXTURE=Ae.getDefineByName("MAINTEXTURE"),e.SHADERDEFINE_TILINGOFFSET=Ae.getDefineByName("TILINGOFFSET"),e.SHADERDEFINE_ADDTIVEFOG=Ae.getDefineByName("ADDTIVEFOG")}get _TintColorR(){return this._color.x}set _TintColorR(e){this._color.x=e,this.color=this._color}get _TintColorG(){return this._color.y}set _TintColorG(e){this._color.y=e,this.color=this._color}get _TintColorB(){return this._color.z}set _TintColorB(e){this._color.z=e,this.color=this._color}get _TintColorA(){return this._color.w}set _TintColorA(e){this._color.w=e,this.color=this._color}get _MainTex_STX(){return this._shaderValues.getVector(e.TILINGOFFSET).x}set _MainTex_STX(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.x=t,this.tilingOffset=r}get _MainTex_STY(){return this._shaderValues.getVector(e.TILINGOFFSET).y}set _MainTex_STY(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.y=t,this.tilingOffset=r}get _MainTex_STZ(){return this._shaderValues.getVector(e.TILINGOFFSET).z}set _MainTex_STZ(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.z=t,this.tilingOffset=r}get _MainTex_STW(){return this._shaderValues.getVector(e.TILINGOFFSET).w}set _MainTex_STW(t){var r=this._shaderValues.getVector(e.TILINGOFFSET);r.w=t,this.tilingOffset=r}set renderMode(t){switch(t){case e.RENDERMODE_ADDTIVE:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_NONE,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.addDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case e.RENDERMODE_ALPHABLENDED:this.renderQueue=De.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Oe.CULL_NONE,this.blend=Oe.BLEND_ENABLE_ALL,this.blendSrc=Oe.BLENDPARAM_SRC_ALPHA,this.blendDst=Oe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Oe.DEPTHTEST_LESS,this._shaderValues.removeDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.")}}get colorR(){return this._TintColorR}set colorR(e){this._TintColorR=e}get colorG(){return this._TintColorG}set colorG(e){this._TintColorG=e}get colorB(){return this._TintColorB}set colorB(e){this._TintColorB=e}get colorA(){return this._TintColorA}set colorA(e){this._TintColorA=e}get color(){return this._shaderValues.getVector(e.TINTCOLOR)}set color(t){this._shaderValues.setVector(e.TINTCOLOR,t)}get texture(){return this._shaderValues.getTexture(e.MAINTEXTURE)}set texture(t){t?this._shaderValues.addDefine(e.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(e.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(e.MAINTEXTURE,t)}get tilingOffsetX(){return this._MainTex_STX}set tilingOffsetX(e){this._MainTex_STX=e}get tilingOffsetY(){return this._MainTex_STY}set tilingOffsetY(e){this._MainTex_STY=e}get tilingOffsetZ(){return this._MainTex_STZ}set tilingOffsetZ(e){this._MainTex_STZ=e}get tilingOffsetW(){return this._MainTex_STW}set tilingOffsetW(e){this._MainTex_STW=e}get tilingOffset(){return this._shaderValues.getVector(e.TILINGOFFSET)}set tilingOffset(t){t&&(1!=t.x||1!=t.y||0!=t.z||0!=t.w)?this._shaderValues.addDefine(e.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(e.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(e.TILINGOFFSET,t)}set depthWrite(t){this._shaderValues.setBool(e.DEPTH_WRITE,t)}get depthWrite(){return this._shaderValues.getBool(e.DEPTH_WRITE)}set cull(t){this._shaderValues.setInt(e.CULL,t)}get cull(){return this._shaderValues.getInt(e.CULL)}set blend(t){this._shaderValues.setInt(e.BLEND,t)}get blend(){return this._shaderValues.getInt(e.BLEND)}set blendSrc(t){this._shaderValues.setInt(e.BLEND_SRC,t)}get blendSrc(){return this._shaderValues.getInt(e.BLEND_SRC)}set blendDst(t){this._shaderValues.setInt(e.BLEND_DST,t)}get blendDst(){return this._shaderValues.getInt(e.BLEND_DST)}set depthTest(t){this._shaderValues.setInt(e.DEPTH_TEST,t)}get depthTest(){return this._shaderValues.getInt(e.DEPTH_TEST)}clone(){var t=new e;return this.cloneTo(t),t}}return e.RENDERMODE_ALPHABLENDED=0,e.RENDERMODE_ADDTIVE=1,e.MAINTEXTURE=Ae.propertyNameToID("u_MainTexture"),e.TINTCOLOR=Ae.propertyNameToID("u_MainColor"),e.TILINGOFFSET=Ae.propertyNameToID("u_TilingOffset"),e.CULL=Ae.propertyNameToID("s_Cull"),e.BLEND=Ae.propertyNameToID("s_Blend"),e.BLEND_SRC=Ae.propertyNameToID("s_BlendSrc"),e.BLEND_DST=Ae.propertyNameToID("s_BlendDst"),e.DEPTH_TEST=Ae.propertyNameToID("s_DepthTest"),e.DEPTH_WRITE=Ae.propertyNameToID("s_DepthWrite"),e})(),Ei=(()=>{class e{}return e.Stretch=0,e.Tile=1,e})();var pi;(pi=e.TrailAlignment||(e.TrailAlignment={}))[pi.View=0]="View",pi[pi.TransformZ=1]="TransformZ";let gi=(()=>{class e{static get vertexDeclaration1(){return e._vertexDeclaration1}static get vertexDeclaration2(){return e._vertexDeclaration2}get vertexDeclaration(){return e._vertexDeclaration1}static __init__(){e._vertexDeclaration1=new lt(32,[new _t(0,ot.Vector3,e.TRAIL_POSITION0),new _t(12,ot.Vector3,e.TRAIL_OFFSETVECTOR),new _t(24,ot.Single,e.TRAIL_TIME0),new _t(28,ot.Single,e.TRAIL_TEXTURECOORDINATE0Y)]),e._vertexDeclaration2=new lt(20,[new _t(0,ot.Single,e.TRAIL_TEXTURECOORDINATE0X),new _t(4,ot.Color,e.TRAIL_COLOR)])}}return e.TRAIL_POSITION0=0,e.TRAIL_OFFSETVECTOR=1,e.TRAIL_TIME0=2,e.TRAIL_TEXTURECOORDINATE0Y=3,e.TRAIL_TEXTURECOORDINATE0X=4,e.TRAIL_COLOR=5,e})(),Si=(()=>{class i extends kt{constructor(e){super(),this._floatCountPerVertices1=8,this._floatCountPerVertices2=5,this._increaseSegementCount=16,this._activeIndex=0,this._endIndex=0,this._needAddFirstVertex=!1,this._isTempEndVertex=!1,this._vertices1=null,this._vertices2=null,this._lastFixedVertexPosition=new a,this._bufferState=new nt,this.tmpColor=new Ge,this._disappearBoundsMode=!1,this._owner=e,this._segementCount=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState);var r=this._owner._owner.trailRenderer.bounds,i=this._owner._owner.transform.position;r.setMin(i),r.setMax(i),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative()}_resizeData(e,r){this._subBirthTime=new Float32Array(e),this._subDistance=new Float64Array(e);var i=t.LayaGL.instance,n=2*e,a=gi.vertexDeclaration1,s=gi.vertexDeclaration2,o=[],l=n*a.vertexStride,_=n*s.vertexStride,h=l+_;this._vertices1=new Float32Array(n*this._floatCountPerVertices1),this._vertices2=new Float32Array(n*this._floatCountPerVertices2),this._vertexBuffer1=new ct(l,i.STATIC_DRAW,!1),this._vertexBuffer1.vertexDeclaration=a,this._vertexBuffer2=new ct(_,i.DYNAMIC_DRAW,!1),this._vertexBuffer2.vertexDeclaration=s,o.push(this._vertexBuffer1),o.push(this._vertexBuffer2),r.bind(),r.applyVertexBuffers(o),r.unBind(),t.Resource._addMemory(h,h)}_resetData(){var e=this._endIndex-this._activeIndex,r=new Float32Array(this._vertices1.buffer,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e),i=new Float32Array(this._vertices2.buffer,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e),n=new Float64Array(this._subDistance.buffer,8*this._activeIndex,e),a=new Float32Array(this._subBirthTime.buffer,4*this._activeIndex,e);if(e===this._segementCount){this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy();var s=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-s,-s),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)}this._vertices1.set(r,0),this._vertices2.set(i,0),this._subDistance.set(n,0),this._subBirthTime.set(a,0),this._endIndex=e,this._activeIndex=0,this._vertexBuffer1.setData(this._vertices1.buffer,0,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e*4),this._vertexBuffer2.setData(this._vertices2.buffer,0,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e*4)}_updateTrail(e,t,r){a.equals(t,r)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(e,r):this._addTrailByNextPosition(e,r))}_addTrailByFirstPosition(e,t){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,t.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0}_addTrailByNextPosition(t,n){var s=i._tempVector30,o=i._tempVector31;switch(this._owner.alignment){case e.TrailAlignment.View:var l=t.viewMatrix;a.transformCoordinate(n,l,i._tempVector33),a.transformCoordinate(this._lastFixedVertexPosition,l,i._tempVector34),a.subtract(i._tempVector33,i._tempVector34,s),a.cross(i._tempVector33,s,o);break;case e.TrailAlignment.TransformZ:a.subtract(n,this._lastFixedVertexPosition,s);var _=i._tempVector32;this._owner._owner.transform.getForward(_),a.cross(s,_,o)}a.normalize(o,o),a.scale(o,this._owner.widthMultiplier/2,o);var h,c,d=a.scalarLength(s);this._needAddFirstVertex&&(this._updateVerticesByPositionData(n,o,this._endIndex-1),this._needAddFirstVertex=!1),d-this._owner.minVertexDistance>=r.zeroTolerance?(this._isTempEndVertex?(h=this._endIndex-1,c=d-this._subDistance[h],this._updateVerticesByPosition(n,o,d,h),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(n,o,d,this._endIndex),this._owner._totalLength+=d,this._endIndex++),n.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(h=this._endIndex-1,c=d-this._subDistance[h],this._updateVerticesByPosition(n,o,d,h),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(n,o,d,this._endIndex),this._owner._totalLength+=d,this._endIndex++),this._isTempEndVertex=!0)}_updateVerticesByPositionData(e,r,n){var s=2*this._floatCountPerVertices1*n,o=this._owner._curtime;this._vertices1[s]=e.x,this._vertices1[s+1]=e.y,this._vertices1[s+2]=e.z,this._vertices1[s+3]=-r.x,this._vertices1[s+4]=-r.y,this._vertices1[s+5]=-r.z,this._vertices1[s+6]=o,this._vertices1[s+7]=1,this._vertices1[s+8]=e.x,this._vertices1[s+9]=e.y,this._vertices1[s+10]=e.z,this._vertices1[s+11]=r.x,this._vertices1[s+12]=r.y,this._vertices1[s+13]=r.z,this._vertices1[s+14]=o,this._vertices1[s+15]=0;var l=this._owner._owner.trailRenderer.bounds,_=l.getMin(),h=l.getMax(),c=i._tempVector35,d=i._tempVector36,u=i._tempVector32;a.add(e,r,c),a.subtract(e,r,d),a.min(d,c,u),a.min(_,u,_),l.setMin(_),a.max(c,d,u),a.max(h,u,h),l.setMax(h),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative();var m=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1.buffer,4*s,4*s,4*m)}_updateVerticesByPosition(e,t,r,i){this._updateVerticesByPositionData(e,t,i),this._subDistance[i]=r,this._subBirthTime[i]=this._owner._curtime}_updateVertexBufferUV(){var e,r,n;if(this._disappearBoundsMode){e=this._owner._owner.trailRenderer.bounds;var s=this._owner._owner.transform.position;e.setMin(s),e.setMax(s),r=e.getMin(),n=e.getMax(),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative()}for(var o=this._endIndex,l=0,_=this._owner.colorGradient,h=_.colorAlphaKeysCount-1,c=_.colorRGBKeysCount-1,d=this._owner._totalLength,u=2*this._floatCountPerVertices2,m=this._activeIndex;m<o;m++){var f,T;m!==this._activeIndex&&(l+=this._subDistance[m]),this._owner.textureMode==Ei.Stretch?T=f=1-l/d:(T=1-l/d,f=1-(d-l)),c=_.evaluateColorRGB(T,this.tmpColor,c,!0),h=_.evaluateColorAlpha(T,this.tmpColor,h,!0);var E=m*u;if(this._vertices2[E+0]=f,this._vertices2[E+1]=this.tmpColor.r,this._vertices2[E+2]=this.tmpColor.g,this._vertices2[E+3]=this.tmpColor.b,this._vertices2[E+4]=this.tmpColor.a,this._vertices2[E+5]=f,this._vertices2[E+6]=this.tmpColor.r,this._vertices2[E+7]=this.tmpColor.g,this._vertices2[E+8]=this.tmpColor.b,this._vertices2[E+9]=this.tmpColor.a,this._disappearBoundsMode){var p=2*this._floatCountPerVertices1*m,g=i._tempVector32,S=i._tempVector33,R=i._tempVector34;g.setValue(this._vertices1[p+0],this._vertices1[p+1],this._vertices1[p+2]),S.setValue(this._vertices1[p+3],this._vertices1[p+4],this._vertices1[p+5]),a.add(g,S,R),a.min(R,r,r),a.max(R,n,n),a.subtract(g,S,R),a.min(R,r,r),a.max(R,n,n)}}this._disappearBoundsMode&&(e.setMin(r),e.setMax(n),this._disappearBoundsMode=!1,t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative());var v=this._activeIndex*u;this._vertexBuffer2.setData(this._vertices2.buffer,4*v,4*v,4*(o*u-v))}_updateDisappear(){for(var e=this._endIndex,t=this._activeIndex;t<e&&this._owner._curtime-this._subBirthTime[t]>=this._owner.time+r.zeroTolerance;t++){var i=t+1;if(i!==e&&(this._owner._totalLength-=this._subDistance[i]),this._isTempEndVertex&&i===e-1){this._floatCountPerVertices1;var n=this._lastFixedVertexPosition;n.x=this._vertices1[0],n.y=this._vertices1[1],n.z=this._vertices1[2],this._isTempEndVertex=!1}this._activeIndex++,this._disappearBoundsMode=!0}}_getType(){return i._type}_prepareRender(e){return this._endIndex-this._activeIndex>1}_render(e){this._bufferState.bind();var r=t.LayaGL.instance,i=2*this._activeIndex,n=2*this._endIndex-i;r.drawArrays(r.TRIANGLE_STRIP,i,n),t.Stat.renderBatches++,t.Stat.trianglesFaces+=n-2}destroy(){super.destroy();var e=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null,this._disappearBoundsMode=!1}_calculateBoundingBoxForNative(){var e=this._owner._owner.trailRenderer,t=e.bounds,r=t.getMin(),i=t.getMax(),n=We._cullingBuffer;n[e._cullingBufferIndex+1]=r.x,n[e._cullingBufferIndex+2]=r.y,n[e._cullingBufferIndex+3]=r.z,n[e._cullingBufferIndex+4]=i.x,n[e._cullingBufferIndex+5]=i.y,n[e._cullingBufferIndex+6]=i.z}clear(){this._activeIndex=0,this._endIndex=0,this._disappearBoundsMode=!1,this._subBirthTime.fill(0),this._subDistance.fill(0),this._segementCount=0,this._isTempEndVertex=!1,this._needAddFirstVertex=!1,this._lastFixedVertexPosition.setValue(0,0,0)}}return i.ALIGNMENT_VIEW=0,i.ALIGNMENT_TRANSFORM_Z=1,i._tempVector30=new a,i._tempVector31=new a,i._tempVector32=new a,i._tempVector33=new a,i._tempVector34=new a,i._tempVector35=new a,i._tempVector36=new a,i._type=kt._typeCounter++,i})(),Ri=(()=>{class e{constructor(t){this._totalLength=0,this._lastPosition=new a,this._curtime=0,this.alignment=e.ALIGNMENT_VIEW,this._owner=t,this._initDefaultData(),this.addRenderElement()}get time(){return this._time}set time(t){this._time=t,this._owner._render._shaderValues.setNumber(e.LIFETIME,t)}get minVertexDistance(){return this._minVertexDistance}set minVertexDistance(e){this._minVertexDistance=e}get widthMultiplier(){return this._widthMultiplier}set widthMultiplier(e){this._widthMultiplier=e}get widthCurve(){return this._widthCurve}set widthCurve(t){this._widthCurve=t;var r,i,n=new Float32Array(4*t.length),a=0;for(r=0,i=t.length;r<i;r++)n[a++]=t[r].time,n[a++]=t[r].inTangent,n[a++]=t[r].outTangent,n[a++]=t[r].value;this._owner._render._shaderValues.setBuffer(e.WIDTHCURVE,n),this._owner._render._shaderValues.setInt(e.WIDTHCURVEKEYLENGTH,t.length)}get colorGradient(){return this._colorGradient}set colorGradient(e){this._colorGradient=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode=e}addRenderElement(){var e=this._owner._render,t=e._renderElements,r=e.sharedMaterials[0];r||(r=Ti.defaultMaterial);var i=new Qt;i.setTransform(this._owner._transform),i.render=e,i.material=r,this._trialGeometry=new Si(this),i.setGeometry(this._trialGeometry),t.push(i)}_update(t){var r=this._owner._render;this._curtime+=t.scene.timer._delta/1e3,r._shaderValues.setNumber(e.CURTIME,this._curtime);var i=this._owner.transform.position,n=r._renderElements[0]._geometry;n._updateDisappear(),n._updateTrail(t.camera,this._lastPosition,i),n._updateVertexBufferUV(),i.cloneTo(this._lastPosition)}_initDefaultData(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=Ei.Stretch;var e=[],t=new ee;t.time=0,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t);var r=new ee;r.time=1,r.inTangent=0,r.outTangent=0,r.value=1,e.push(r),this.widthCurve=e;var i=new Pr(2,2);i.mode=br.Blend,i.addColorRGB(0,Ge.WHITE),i.addColorRGB(1,Ge.WHITE),i.addColorAlpha(0,1),i.addColorAlpha(1,1),this.colorGradient=i}destroy(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null}clear(){this._trialGeometry.clear(),this._lastPosition.setValue(0,0,0),this._curtime=0,this._totalLength=0}}return e.CURTIME=Ae.propertyNameToID("u_CurTime"),e.LIFETIME=Ae.propertyNameToID("u_LifeTime"),e.WIDTHCURVE=Ae.propertyNameToID("u_WidthCurve"),e.WIDTHCURVEKEYLENGTH=Ae.propertyNameToID("u_WidthCurveKeyLength"),e.ALIGNMENT_VIEW=0,e.ALIGNMENT_TRANSFORM_Z=1,e})();class vi extends tr{constructor(e){super(e),this._projectionViewWorldMatrix=new h}_calculateBoundingBox(){}_needRender(e,t){return this._owner.trailFilter._update(t),!e||e.intersects(this.bounds._getBoundBox())}_updateForNative(e){this._owner.trailFilter._update(e)}_renderUpdate(e,t){super._renderUpdate(e,t)}_renderUpdateWithCamera(e,t){var r=e.projectionViewMatrix;t?(h.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ft.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(ft.MVPMATRIX,r)}}class Ai extends jt{constructor(e=null){super(e),this._render=new vi(this),this._geometryFilter=new Ri(this)}static __init__(){}get trailFilter(){return this._geometryFilter}get trailRenderer(){return this._render}_parse(e,r){super._parse(e,r);var i,n,a=this._render,s=this._geometryFilter,o=e.materials;if(o){var l=a.sharedMaterials,_=o.length;for(l.length=_,i=0;i<_;i++)l[i]=t.Loader.getRes(o[i].path);a.sharedMaterials=l}s.time=e.time,s.minVertexDistance=e.minVertexDistance,s.widthMultiplier=e.widthMultiplier,s.textureMode=e.textureMode,null!=e.alignment&&(s.alignment=e.alignment);var h=[],c=e.widthCurve;for(i=0,n=c.length;i<n;i++){var d=new ee;d.time=c[i].time,d.inTangent=c[i].inTangent,d.outTangent=c[i].outTangent,d.value=c[i].value,h.push(d)}s.widthCurve=h;var u=e.colorGradient,m=u.colorKeys,f=u.alphaKeys,T=new Pr(m.length,f.length);for(T.mode=u.mode,i=0,n=m.length;i<n;i++){var E=m[i];T.addColorRGB(E.time,new Ge(E.value[0],E.value[1],E.value[2],1))}for(i=0,n=f.length;i<n;i++){var p=f[i];T.addColorAlpha(p.time,p.value)}s.colorGradient=T}_onActive(){super._onActive(),this._transform.position.cloneTo(this._geometryFilter._lastPosition)}_cloneTo(e,t,r){var i,n;super._cloneTo(e,t,r);var a=e,s=a.trailFilter;s.time=this.trailFilter.time,s.minVertexDistance=this.trailFilter.minVertexDistance,s.widthMultiplier=this.trailFilter.widthMultiplier,s.textureMode=this.trailFilter.textureMode,s.alignment=this.trailFilter.alignment;var o=this.trailFilter.widthCurve,l=[];for(i=0,n=o.length;i<n;i++){var _=new ee;o[i].cloneTo(_),l.push(_)}s.widthCurve=l;var h=new Pr(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(h),s.colorGradient=h,a.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial}destroy(e=!0){this.destroyed||(super.destroy(e),this._geometryFilter.destroy(),this._geometryFilter=null)}clear(){this._geometryFilter.clear()}_create(){return new Ai}}let Ii=(()=>{class e{constructor(e,t,r,i){this._position=e,this._normal=t,this._textureCoord0=r,this._textureCoord1=i}static __init__(){e._vertexDeclaration=new lt(40,[new _t(0,ot.Vector3,e.TERRAIN_POSITION0),new _t(12,ot.Vector3,e.TERRAIN_NORMAL0),new _t(24,ot.Vector2,e.TERRAIN_TEXTURECOORDINATE0),new _t(32,ot.Vector2,e.TERRAIN_TEXTURECOORDINATE1)])}static get vertexDeclaration(){return e._vertexDeclaration}get position(){return this._position}get normal(){return this._normal}get textureCoord0(){return this._textureCoord0}get textureCoord1(){return this._textureCoord1}get vertexDeclaration(){return e._vertexDeclaration}}return e.TERRAIN_POSITION0=0,e.TERRAIN_NORMAL0=1,e.TERRAIN_TEXTURECOORDINATE0=2,e.TERRAIN_TEXTURECOORDINATE1=3,e})(),xi=(()=>{class e{}return e._interactive={getWorldTransform:(e,t)=>{},setWorldTransform:(e,t)=>{var r=V._physicObjectsMap[e];r._simulation._updatedRigidbodies++,r._updateTransformComponent(t)}},e})();class Ci extends Y{constructor(e=u.COLLISIONFILTERGROUP_DEFAULTFILTER,t=u.COLLISIONFILTERGROUP_ALLFILTER){super(e,t),this._enableProcessCollisions=!1}_addToSimulation(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith)}_removeFromSimulation(){this._simulation._removePhysicsCollider(this)}_parse(e){null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),super._parse(e),this._parseShape(e.shapes)}_onAdded(){var e=Z._bullet,t=e.btCollisionObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_forceActivationState(t,V.ACTIVATIONSTATE_DISABLE_SIMULATION);var r=e.btCollisionObject_getCollisionFlags(t);this.owner.isStatic?((r&V.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(r^=V.COLLISIONFLAGS_KINEMATIC_OBJECT),r|=V.COLLISIONFLAGS_STATIC_OBJECT):((r&V.COLLISIONFLAGS_STATIC_OBJECT)>0&&(r^=V.COLLISIONFLAGS_STATIC_OBJECT),r|=V.COLLISIONFLAGS_KINEMATIC_OBJECT),e.btCollisionObject_setCollisionFlags(t,r),this._btColliderObject=t,super._onAdded()}}let Li=(()=>{class r extends kt{constructor(e){super(),this._id=++r._uniqueIDCounter,this._mesh=e,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}get indexCount(){return this._indexCount}_setIndexRange(e,t){this._indexStart=e,this._indexCount=t,this._indices=new Uint16Array(this._indexBuffer.getData().buffer,2*e,t)}_getType(){return r._type}_prepareRender(e){return this._mesh._uploadVerticesData(),!0}_render(r){var i=this._mesh;if(i.indexFormat!==e.IndexFormat.UInt32||t.LayaGL.layaGPUInstance.supportElementIndexUint32()){var n,a,s=t.LayaGL.instance,o=r.renderElement.render._skinnedData;switch(i.indexFormat){case e.IndexFormat.UInt32:n=s.UNSIGNED_INT,a=4;break;case e.IndexFormat.UInt16:n=s.UNSIGNED_SHORT,a=2;break;case e.IndexFormat.UInt8:n=s.UNSIGNED_BYTE,a=1}if(i._bufferState.bind(),o)for(var l=o[this._indexInMesh],_=0,h=this._boneIndicesList.length;_<h;_++)r.shader.uploadCustomUniform(fi.BONES,l[_]),s.drawElements(s.TRIANGLES,this._subIndexBufferCount[_],n,this._subIndexBufferStart[_]*a);else s.drawElements(s.TRIANGLES,this._indexCount,n,this._indexStart*a);t.Stat.trianglesFaces+=this._indexCount/3,t.Stat.renderBatches++}else console.warn("SubMesh:this device do not support IndexFormat.UInt32.")}getIndices(){if(this._mesh._isReadable)return this._indices.slice();throw"SubMesh:can't get indices on subMesh,mesh's isReadable must be true."}setIndices(e){this._indexBuffer.setData(e,this._indexStart,0,this._indexCount)}destroy(){this._destroyed||(super.destroy(),this._indexBuffer.destroy(),this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null)}}return r._uniqueIDCounter=0,r._type=kt._typeCounter++,r})();class yi{constructor(e,t,r){this.subMeshIndex=e,this.batchIndex=t,this.batchBoneIndex=r}}let Di=(()=>{class r extends t.Resource{constructor(t=!0){super(),this._tempVector30=new a,this._tempVector31=new a,this._tempVector32=new a,this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1,this._needUpdateBounds=!0,this._bounds=new Wt(new a,new a),this._bufferState=new nt,this._instanceBufferState=new nt,this._vertexBuffer=null,this._indexBuffer=null,this._skinnedMatrixCaches=[],this._vertexCount=0,this._indexFormat=e.IndexFormat.UInt16,this._isReadable=t,this._subMeshes=[]}static __init__(){var e=Z._bullet;e&&(r._nativeTempVector30=e.btVector3_create(0,0,0),r._nativeTempVector31=e.btVector3_create(0,0,0),r._nativeTempVector32=e.btVector3_create(0,0,0))}static load(e,i){t.ILaya.loader.create(e,i,null,r.MESH)}get inverseAbsoluteBindPoses(){return this._inverseBindPoses}get vertexCount(){return this._vertexCount}get indexCount(){return this._indexBuffer.indexCount}get subMeshCount(){return this._subMeshes.length}get bounds(){return this._bounds}set bounds(e){this._bounds!==e&&e.cloneTo(this._bounds)}get indexFormat(){return this._indexFormat}_getPositionElement(e){for(var t=e.vertexDeclaration._vertexElements,r=0,i=t.length;r<i;r++){var n=t[r];if(n._elementFormat===ot.Vector3&&n._elementUsage===ht.MESH_POSITION0)return n}return null}_getVerticeElementData(e,t){e.length=this._vertexCount;var r=this._vertexBuffer.vertexDeclaration,s=r.getVertexElementByUsage(t);if(s){var o=this._vertexBuffer.getUint8Data(),l=this._vertexBuffer.getFloat32Data(),_=r.vertexStride,h=_/4,c=s._offset,d=c/4;switch(t){case ht.MESH_TEXTURECOORDINATE0:case ht.MESH_TEXTURECOORDINATE1:for(var u=0;u<this._vertexCount;u++){var m=h*u+d;e[u]=new i(l[m],l[m+1])}break;case ht.MESH_POSITION0:case ht.MESH_NORMAL0:for(u=0;u<this._vertexCount;u++){m=h*u+d;e[u]=new a(l[m],l[m+1],l[m+2])}break;case ht.MESH_TANGENT0:case ht.MESH_BLENDWEIGHT0:for(u=0;u<this._vertexCount;u++){m=h*u+d;e[u]=new n(l[m],l[m+1],l[m+2],l[m+3])}break;case ht.MESH_COLOR0:for(u=0;u<this._vertexCount;u++){m=h*u+d;e[u]=new Ge(l[m],l[m+1],l[m+2],l[m+3])}break;case ht.MESH_BLENDINDICES0:for(u=0;u<this._vertexCount;u++){m=_*u+c;e[u]=new n(o[m],o[m+1],o[m+2],o[m+3])}break;default:throw"Mesh:Unknown elementUsage."}}}_setVerticeElementData(e,t){var r=this._vertexBuffer.vertexDeclaration,i=r.getVertexElementByUsage(t);if(i){var n=this._vertexBuffer.getUint8Data(),a=this._vertexBuffer.getFloat32Data(),s=r.vertexStride,o=s/4,l=i._offset,_=l/4;switch(t){case ht.MESH_TEXTURECOORDINATE0:case ht.MESH_TEXTURECOORDINATE1:for(var h=0,c=e.length;h<c;h++){var d=o*h+_,u=e[h];a[d]=u.x,a[d+1]=u.y}break;case ht.MESH_POSITION0:case ht.MESH_NORMAL0:for(h=0,c=e.length;h<c;h++){d=o*h+_;var m=e[h];a[d]=m.x,a[d+1]=m.y,a[d+2]=m.z}break;case ht.MESH_TANGENT0:case ht.MESH_BLENDWEIGHT0:for(h=0,c=e.length;h<c;h++){d=o*h+_;var f=e[h];a[d]=f.x,a[d+1]=f.y,a[d+2]=f.z,a[d+3]=f.w}break;case ht.MESH_COLOR0:for(h=0,c=e.length;h<c;h++){d=o*h+_;var T=e[h];a[d]=T.r,a[d+1]=T.g,a[d+2]=T.b,a[d+3]=T.a}break;case ht.MESH_BLENDINDICES0:for(h=0,c=e.length;h<c;h++){d=s*h+l,f=e[h];n[d]=f.x,n[d+1]=f.y,n[d+2]=f.z,n[d+3]=f.w}break;default:throw"Mesh:Unknown elementUsage."}this._minVerticesUpdate=0,this._maxVerticesUpdate=Number.MAX_SAFE_INTEGER}else console.warn("Mesh: the mesh don't have  this VertexElement.")}_disposeResource(){for(var e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();this._btTriangleMesh&&Z._bullet.btStridingMeshInterface_destroy(this._btTriangleMesh),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._subMeshes=null,this._btTriangleMesh=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null}_setSubMeshes(e){this._subMeshes=e;for(var t=0,r=e.length;t<r;t++)e[t]._indexInMesh=t}_setBuffer(e,t){var r=this._bufferState;r.bind(),r.applyVertexBuffer(e),r.applyIndexBuffer(t),r.unBind();var i=this._instanceBufferState;i.bind(),i.applyVertexBuffer(e),i.applyInstanceVertexBuffer(qt.instance.instanceWorldMatrixBuffer),i.applyInstanceVertexBuffer(qt.instance.instanceMVPMatrixBuffer),i.applyIndexBuffer(t),i.unBind()}_getPhysicMesh(){if(!this._btTriangleMesh){for(var e=Z._bullet,t=e.btTriangleMesh_create(),i=r._nativeTempVector30,n=r._nativeTempVector31,a=r._nativeTempVector32,s=this._tempVector30,o=this._tempVector31,l=this._tempVector32,_=this._vertexBuffer,h=this._getPositionElement(_),c=_.getFloat32Data(),d=_.vertexDeclaration.vertexStride/4,u=h._offset/4,m=this._indexBuffer.getData(),f=0,T=m.length;f<T;f+=3){var E=m[f]*d+u,p=m[f+1]*d+u,g=m[f+2]*d+u;s.setValue(c[E],c[E+1],c[E+2]),o.setValue(c[p],c[p+1],c[p+2]),l.setValue(c[g],c[g+1],c[g+2]),k._convertToBulletVec3(s,i,!0),k._convertToBulletVec3(o,n,!0),k._convertToBulletVec3(l,a,!0),e.btTriangleMesh_addTriangle(t,i,n,a,!0)}this._btTriangleMesh=t}return this._btTriangleMesh}_uploadVerticesData(){var e=this._minVerticesUpdate,t=this._maxVerticesUpdate;if(-1!==e&&-1!==t){var r=e;this._vertexBuffer.setData(this._vertexBuffer.getUint8Data().buffer,r,r,t-e),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1}}getSubMesh(e){return this._subMeshes[e]}getPositions(e){if(!this._isReadable)throw"Mesh:can't get positions on mesh,isReadable must be true.";this._getVerticeElementData(e,ht.MESH_POSITION0)}setPositions(e){if(!this._isReadable)throw"Mesh:setPosition() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,ht.MESH_POSITION0),this._needUpdateBounds=!0}getColors(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,ht.MESH_COLOR0)}setColors(e){if(!this._isReadable)throw"Mesh:setColors() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,ht.MESH_COLOR0)}getUVs(e,t=0){if(!this._isReadable)throw"Mesh:can't get uvs on mesh,isReadable must be true.";switch(t){case 0:this._getVerticeElementData(e,ht.MESH_TEXTURECOORDINATE0);break;case 1:this._getVerticeElementData(e,ht.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}setUVs(e,t=0){if(!this._isReadable)throw"Mesh:setUVs() need isReadable must be true or use setVertices().";switch(t){case 0:this._setVerticeElementData(e,ht.MESH_TEXTURECOORDINATE0);break;case 1:this._setVerticeElementData(e,ht.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}getNormals(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,ht.MESH_NORMAL0)}setNormals(e){if(!this._isReadable)throw"Mesh:setNormals() need must be true or use setVertices().";this._setVerticeElementData(e,ht.MESH_NORMAL0)}getTangents(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,ht.MESH_TANGENT0)}setTangents(e){if(!this._isReadable)throw"Mesh:setTangents() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,ht.MESH_TANGENT0)}getBoneWeights(e){if(!this._isReadable)throw"Mesh:can't get boneWeights on mesh,isReadable must be true.";this._getVerticeElementData(e,ht.MESH_BLENDWEIGHT0)}setBoneWeights(e){if(!this._isReadable)throw"Mesh:setBoneWeights() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,ht.MESH_BLENDWEIGHT0)}getBoneIndices(e){if(!this._isReadable)throw"Mesh:can't get boneIndices on mesh,isReadable must be true.";this._getVerticeElementData(e,ht.MESH_BLENDINDICES0)}setBoneIndices(e){if(!this._isReadable)throw"Mesh:setBoneIndices() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,ht.MESH_BLENDINDICES0)}markAsUnreadbale(){this._uploadVerticesData(),this._vertexBuffer.markAsUnreadbale(),this._isReadable=!1}getVertexDeclaration(){return this._vertexBuffer._vertexDeclaration}getVertices(){if(this._isReadable)return this._vertexBuffer.getUint8Data().buffer.slice(0);throw"Mesh:can't get vertices on mesh,isReadable must be true."}setVertices(e){this._vertexBuffer.setData(e),this._needUpdateBounds=!0}getIndices(){if(this._isReadable)return this._indexBuffer.getData().slice();throw"Mesh:can't get indices on subMesh,mesh's isReadable must be true."}setIndices(r){var i;r instanceof Uint32Array?i=e.IndexFormat.UInt32:r instanceof Uint16Array?i=e.IndexFormat.UInt16:r instanceof Uint8Array&&(i=e.IndexFormat.UInt8);var n=this._indexBuffer;this._indexFormat===i&&n.indexCount===r.length||(n.destroy(),this._indexBuffer=n=new st(i,r.length,t.LayaGL.instance.STATIC_DRAW,this._isReadable)),n.setData(r),this._indexFormat=i}calculateBounds(){if(!this._isReadable)throw"Mesh:can't calculate bounds on subMesh,mesh's isReadable must be true.";if(this._needUpdateBounds){var e=this._tempVector30,t=this._tempVector31;e.x=e.y=e.z=Number.MAX_VALUE,t.x=t.y=t.z=-Number.MAX_VALUE;for(var r=this._vertexBuffer,i=this._getPositionElement(r),n=r.getFloat32Data(),a=r.vertexDeclaration.vertexStride/4,s=i._offset/4,o=0,l=n.length;o<l;o+=a){var _=o+s,h=n[_],c=n[_+1],d=n[_+2];e.x=Math.min(e.x,h),e.y=Math.min(e.y,c),e.z=Math.min(e.z,d),t.x=Math.max(t.x,h),t.y=Math.max(t.y,c),t.z=Math.max(t.z,d)}this._bounds.setMin(e),this._bounds.setMax(t),this._needUpdateBounds=!1}}cloneTo(t){var r=t,i=this._vertexBuffer,n=new ct(i._byteLength,i.bufferUsage,i.canRead);n.vertexDeclaration=i.vertexDeclaration,n.setData(i.getUint8Data().slice().buffer),r._vertexBuffer=n,r._vertexCount=this._vertexCount;var a,s=this._indexBuffer,o=new st(e.IndexFormat.UInt16,s.indexCount,s.bufferUsage,s.canRead);o.setData(s.getData().slice()),r._indexBuffer=o,r._setBuffer(r._vertexBuffer,o),r._setCPUMemory(this.cpuMemory),r._setGPUMemory(this.gpuMemory);var l=this._boneNames;if(l){var _=r._boneNames=[];for(a=0;a<l.length;a++)_[a]=l[a]}var h=this._inverseBindPoses;if(h){var c=r._inverseBindPoses=[];for(a=0;a<h.length;a++)c[a]=h[a]}var d=this._skinnedMatrixCaches.length;for(r._skinnedMatrixCaches.length=d,a=0;a<d;a++){var u=this._skinnedMatrixCaches[a];r._skinnedMatrixCaches[a]=new yi(u.subMeshIndex,u.batchIndex,u.batchBoneIndex)}for(a=0;a<this.subMeshCount;a++){var m=this._subMeshes[a],f=m._subIndexBufferStart,T=m._subIndexBufferCount,E=m._boneIndicesList,p=new Li(r);p._subIndexBufferStart.length=f.length,p._subIndexBufferCount.length=T.length,p._boneIndicesList.length=E.length;for(var g=0;g<f.length;g++)p._subIndexBufferStart[g]=f[g];for(g=0;g<T.length;g++)p._subIndexBufferCount[g]=T[g];for(g=0;g<E.length;g++)p._boneIndicesList[g]=new Uint16Array(E[g]);p._indexBuffer=o,p._indexStart=m._indexStart,p._indexCount=m._indexCount,p._indices=new Uint16Array(o.getData().buffer,2*m._indexStart,m._indexCount);var S=r._vertexBuffer;p._vertexBuffer=S,r._subMeshes.push(p)}r._setSubMeshes(r._subMeshes)}clone(){var e=new r;return this.cloneTo(e),e}}return r.MESH="MESH",r})();class Mi{static __init__(){}static _createMesh(r,i,n){var a=t.LayaGL.instance,s=new Di,o=new Li(s),l=new ct(4*i.length,a.STATIC_DRAW,!0);l.vertexDeclaration=r,l.setData(i.buffer),s._vertexBuffer=l,s._vertexCount=l._byteLength/r.vertexStride;var _=new st(e.IndexFormat.UInt16,n.length,a.STATIC_DRAW,!0);_.setData(n),s._indexBuffer=_,s._setBuffer(l,_),o._vertexBuffer=l,o._indexBuffer=_,o._setIndexRange(0,_.indexCount);var h=o._subIndexBufferStart,c=o._subIndexBufferCount,d=o._boneIndicesList;h.length=1,c.length=1,d.length=1,h[0]=0,c[0]=_.indexCount;var u=[];u.push(o),s._setSubMeshes(u),s.calculateBounds();var m=l._byteLength+_._byteLength;return s._setCPUMemory(m),s._setGPUMemory(m),s}static createBox(e=1,t=1,r=1){var i=ht.getVertexDeclaration("POSITION,NORMAL,UV"),n=e/2,a=t/2,s=r/2,o=new Float32Array([-n,a,-s,0,1,0,0,0,n,a,-s,0,1,0,1,0,n,a,s,0,1,0,1,1,-n,a,s,0,1,0,0,1,-n,-a,-s,0,-1,0,0,1,n,-a,-s,0,-1,0,1,1,n,-a,s,0,-1,0,1,0,-n,-a,s,0,-1,0,0,0,-n,a,-s,-1,0,0,0,0,-n,a,s,-1,0,0,1,0,-n,-a,s,-1,0,0,1,1,-n,-a,-s,-1,0,0,0,1,n,a,-s,1,0,0,1,0,n,a,s,1,0,0,0,0,n,-a,s,1,0,0,0,1,n,-a,-s,1,0,0,1,1,-n,a,s,0,0,1,0,0,n,a,s,0,0,1,1,0,n,-a,s,0,0,1,1,1,-n,-a,s,0,0,1,0,1,-n,a,-s,0,0,-1,1,0,n,a,-s,0,0,-1,0,0,n,-a,-s,0,0,-1,0,1,-n,-a,-s,0,0,-1,1,1]),l=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return Mi._createMesh(i,o,l)}static createCapsule(e=.5,t=2,r=16,i=32){var n,a,s=(r+1)*(i+1)*2+2*(i+1),o=3*r*(i+1)*2*2+2*i*3,l=ht.getVertexDeclaration("POSITION,NORMAL,UV"),_=l.vertexStride/4,h=new Float32Array(s*_),c=new Uint16Array(o),d=Math.PI/2/r,u=2*Math.PI/i,m=t/2-e,f=0,T=0,E=0,p=0,g=0,S=0;for(n=0;n<=r;n++)for(a=0;a<=i;a++)f=e*Math.cos(n*d)*Math.cos(a*u+Math.PI),T=e*Math.sin(n*d),E=e*Math.cos(n*d)*Math.sin(a*u+Math.PI),h[p++]=f,h[p++]=T+m,h[p++]=E,h[p++]=f,h[p++]=T,h[p++]=E,h[p++]=1-a/i,h[p++]=(1-n/r)*(Math.PI*e/2/(t+Math.PI*e)),n<r&&(c[g++]=n*(i+1)+a+(i+1),c[g++]=n*(i+1)+a,c[g++]=n*(i+1)+a+1,c[g++]=n*(i+1)+a+i,c[g++]=n*(i+1)+a,c[g++]=n*(i+1)+a+(i+1));for(S+=(r+1)*(i+1),n=0;n<=r;n++)for(a=0;a<=i;a++)f=e*Math.cos(n*d)*Math.cos(a*u+Math.PI),T=e*Math.sin(-n*d),E=e*Math.cos(n*d)*Math.sin(a*u+Math.PI),h[p++]=f,h[p++]=T-m,h[p++]=E,h[p++]=f,h[p++]=T,h[p++]=E,h[p++]=1-a/i,h[p++]=(n/r*(Math.PI*e/2)+(t+Math.PI*e/2))/(t+Math.PI*e),n<r&&(c[g++]=S+n*(i+1)+a,c[g++]=S+n*(i+1)+a+(i+1),c[g++]=S+n*(i+1)+a+1,c[g++]=S+n*(i+1)+a,c[g++]=S+n*(i+1)+a+i,c[g++]=S+n*(i+1)+a+(i+1));for(S+=(r+1)*(i+1),a=0;a<=i;a++)f=e*Math.cos(a*u+Math.PI),T=m,E=e*Math.sin(a*u+Math.PI),h[p++]=f,h[p+8*(i+1)-1]=f,h[p++]=T,h[p+8*(i+1)-1]=-T,h[p++]=E,h[p+8*(i+1)-1]=E,h[p++]=f,h[p+8*(i+1)-1]=f,h[p++]=0,h[p+8*(i+1)-1]=0,h[p++]=E,h[p+8*(i+1)-1]=E,h[p++]=1-1*a/i,h[p+8*(i+1)-1]=1-1*a/i,h[p++]=Math.PI*e/2/(t+Math.PI*e),h[p+8*(i+1)-1]=(Math.PI*e/2+t)/(t+Math.PI*e);for(a=0;a<i;a++)c[g++]=a+S+(i+1),c[g++]=a+S+1,c[g++]=a+S,c[g++]=a+S+(i+1),c[g++]=a+S+(i+1)+1,c[g++]=a+S+1;return S+=2*(i+1),Mi._createMesh(l,h,c)}static createCone(e=.5,t=1,r=32){for(var i,n=r+1+1+2*(r+1),s=6*r+3*r,o=ht.getVertexDeclaration("POSITION,NORMAL,UV"),l=o.vertexStride/4,h=new Float32Array(n*l),c=new Uint16Array(s),d=2*Math.PI/r,u=t/2,m=0,f=0,T=0,E=0,p=0,g=new a,S=new a(0,-1,0),R=new a(0,u,0),v=new a,A=new a,I=new _,x=new a,C=0,L=0,y=0;y<=r;y++)m=y*d,T=Math.cos(m+Math.PI)*e,E=u,p=Math.sin(m+Math.PI)*e,h[C++]=0,h[C+8*(r+1)-1]=T,h[C++]=E,h[C+8*(r+1)-1]=-E,h[C++]=0,h[C+8*(r+1)-1]=p,g.x=T,g.y=0,g.z=p,v.x=T,v.y=-E,v.z=p,a.subtract(v,R,A),a.normalize(A,A),i=Math.acos(a.dot(S,A)),a.cross(S,A,x),a.normalize(x,x),_.createFromAxisAngle(x,i,I),a.normalize(g,g),a.transformQuat(g,I,g),a.normalize(g,g),h[C++]=g.x,h[C+8*(r+1)-1]=g.x,h[C++]=g.y,h[C+8*(r+1)-1]=g.y,h[C++]=g.z,h[C+8*(r+1)-1]=g.z,h[C++]=1-1*y/r,h[C+8*(r+1)-1]=1-1*y/r,h[C++]=0,h[C+8*(r+1)-1]=1;C+=8*(r+1);for(var D=0;D<r;D++)c[L++]=D+f+(r+1),c[L++]=D+f+1,c[L++]=D+f,c[L++]=D+f+(r+1),c[L++]=D+f+(r+1)+1,c[L++]=D+f+1;f+=2*(r+1);for(var M=0;M<=r;M++)0===M&&(h[C++]=0,h[C++]=-u,h[C++]=0,h[C++]=0,h[C++]=-1,h[C++]=0,h[C++]=.5,h[C++]=.5),m=M*d,T=Math.cos(m+Math.PI)*e,E=-u,p=Math.sin(m+Math.PI)*e,h[C++]=T,h[C++]=E,h[C++]=p,h[C++]=0,h[C++]=-1,h[C++]=0,h[C++]=.5+.5*Math.cos(m),h[C++]=.5+.5*Math.sin(m);for(var O=0;O<r;O++)c[L++]=0+f,c[L++]=O+2+f,c[L++]=O+1+f;return f+=r+1+1,Mi._createMesh(o,h,c)}static createCylinder(e=.5,t=2,r=32){for(var i=r+1+1+2*(r+1)+(r+1+1),n=3*r+6*r+3*r,a=ht.getVertexDeclaration("POSITION,NORMAL,UV"),s=a.vertexStride/4,o=new Float32Array(i*s),l=new Uint16Array(n),_=2*Math.PI/r,h=t/2,c=0,d=0,u=0,m=0,f=0,T=0,E=0,p=0;p<=r;p++)0===p&&(o[T++]=0,o[T++]=h,o[T++]=0,o[T++]=0,o[T++]=1,o[T++]=0,o[T++]=.5,o[T++]=.5),c=p*_,u=Math.cos(c)*e,m=h,f=Math.sin(c)*e,o[T++]=u,o[T++]=m,o[T++]=f,o[T++]=0,o[T++]=1,o[T++]=0,o[T++]=.5+.5*Math.cos(c),o[T++]=.5+.5*Math.sin(c);for(var g=0;g<r;g++)l[E++]=0,l[E++]=g+1,l[E++]=g+2;d+=r+1+1;for(var S=0;S<=r;S++)c=S*_,u=Math.cos(c+Math.PI)*e,m=h,f=Math.sin(c+Math.PI)*e,o[T++]=u,o[T+8*(r+1)-1]=u,o[T++]=m,o[T+8*(r+1)-1]=-m,o[T++]=f,o[T+8*(r+1)-1]=f,o[T++]=u,o[T+8*(r+1)-1]=u,o[T++]=0,o[T+8*(r+1)-1]=0,o[T++]=f,o[T+8*(r+1)-1]=f,o[T++]=1-1*S/r,o[T+8*(r+1)-1]=1-1*S/r,o[T++]=0,o[T+8*(r+1)-1]=1;T+=8*(r+1);for(var R=0;R<r;R++)l[E++]=R+d+(r+1),l[E++]=R+d+1,l[E++]=R+d,l[E++]=R+d+(r+1),l[E++]=R+d+(r+1)+1,l[E++]=R+d+1;d+=2*(r+1);for(var v=0;v<=r;v++)0===v&&(o[T++]=0,o[T++]=-h,o[T++]=0,o[T++]=0,o[T++]=-1,o[T++]=0,o[T++]=.5,o[T++]=.5),c=v*_,u=Math.cos(c+Math.PI)*e,m=-h,f=Math.sin(c+Math.PI)*e,o[T++]=u,o[T++]=m,o[T++]=f,o[T++]=0,o[T++]=-1,o[T++]=0,o[T++]=.5+.5*Math.cos(c),o[T++]=.5+.5*Math.sin(c);for(var A=0;A<r;A++)l[E++]=0+d,l[E++]=A+2+d,l[E++]=A+1+d;return d+=r+1+1,Mi._createMesh(a,o,l)}static createPlane(e=10,t=10,r=10,i=10){for(var n=(r+1)*(i+1),a=new Uint16Array(r*i*2*3),s=ht.getVertexDeclaration("POSITION,NORMAL,UV"),o=s.vertexStride/4,l=new Float32Array(n*o),_=e/2,h=t/2,c=e/r,d=t/i,u=0,m=0;m<=i;m++)for(var f=0;f<=r;f++)l[u++]=f*c-_,l[u++]=0,l[u++]=m*d-h,l[u++]=0,l[u++]=1,l[u++]=0,l[u++]=1*f/r,l[u++]=1*m/i;var T=0;for(m=0;m<i;m++)for(f=0;f<r;f++)a[T++]=(m+1)*(r+1)+f,a[T++]=m*(r+1)+f,a[T++]=(m+1)*(r+1)+f+1,a[T++]=m*(r+1)+f,a[T++]=m*(r+1)+f+1,a[T++]=(m+1)*(r+1)+f+1;return Mi._createMesh(s,l,a)}static createQuad(e=1,t=1){var r=ht.getVertexDeclaration("POSITION,NORMAL,UV"),i=e/2,n=t/2,a=new Float32Array([-i,n,0,0,0,1,0,0,i,n,0,0,0,1,1,0,-i,-n,0,0,0,1,0,1,i,-n,0,0,0,1,1,1]),s=new Uint16Array([0,1,2,3,2,1]);return Mi._createMesh(r,a,s)}static createSphere(e=.5,t=32,r=32){var i=(t+1)*(r+1),n=3*t*(r+1)*2,a=new Uint16Array(n),s=ht.getVertexDeclaration("POSITION,NORMAL,UV"),o=s.vertexStride/4,l=new Float32Array(i*o),_=Math.PI/t,h=2*Math.PI/r,c=0;i=0,n=0;for(var d=0;d<t+1;d++)for(var u=Math.sin(d*_),m=Math.cos(d*_),f=0;f<r+1;f++){var T=u*Math.sin(f*h+1*Math.PI/2),E=u*Math.cos(f*h+1*Math.PI/2);l[i+0]=T*e,l[i+1]=m*e,l[i+2]=E*e,l[i+3]=T,l[i+4]=m,l[i+5]=E,l[i+6]=f/r,l[i+7]=d/t,i+=o,d!=t-1&&(a[n++]=c+(r+1),a[n++]=c,a[n++]=c+1,a[n++]=c+r,a[n++]=c,a[n++]=c+(r+1),c++)}return Mi._createMesh(s,l,a)}}var Oi='#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}';class Ni{constructor(){}static __init__(){Ae.SHADERDEFINE_LEGACYSINGALLIGHTING=Ae.getDefineByName("LEGACYSINGLELIGHTING"),Ae.SHADERDEFINE_GRAPHICS_API_GLES2=Ae.getDefineByName("GRAPHICS_API_GLES2"),Ae.SHADERDEFINE_GRAPHICS_API_GLES3=Ae.getDefineByName("GRAPHICS_API_GLES3"),Ae.addInclude("Lighting.glsl","#ifdef GRAPHICS_API_GLES3\r\n\t#define INVERSE_MAT(mat) inverse(mat)\r\n#else\r\n\t#define INVERSE_MAT(mat) inverseMat(mat)\r\n#endif\r\n\r\nstruct DirectionLight {\r\n\tvec3 color;\r\n\tvec3 direction;\r\n};\r\n\r\nstruct PointLight {\r\n\tvec3 color;\r\n\tvec3 position;\r\n\tfloat range;\r\n};\r\n\r\nstruct SpotLight {\r\n\tvec3 color;\r\n\tvec3 position;\r\n\tfloat range;\r\n\tvec3 direction;\r\n\tfloat spot;\r\n};\r\n\r\nstruct LayaGI{\r\n\tvec3 diffuse;\r\n\tvec3 specular;\r\n};\r\n\r\nstruct LayaLight{\r\n\tvec3 color;\r\n\tvec3 dir;\r\n};\r\n\r\nconst int c_ClusterBufferWidth = CLUSTER_X_COUNT*CLUSTER_Y_COUNT;\r\nconst int c_ClusterBufferHeight = CLUSTER_Z_COUNT*(1+int(ceil(float(MAX_LIGHT_COUNT_PER_CLUSTER)/4.0)));\r\nconst int c_ClusterBufferFloatWidth = c_ClusterBufferWidth*4;\r\n\r\n#ifndef GRAPHICS_API_GLES3\r\n\tmat3 inverseMat(mat3 m) {\r\n\t\tfloat a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\r\n\t\tfloat a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\r\n\t\tfloat a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\r\n\r\n\t\tfloat b01 = a22 * a11 - a12 * a21;\r\n\t\tfloat b11 = -a22 * a10 + a12 * a20;\r\n\t\tfloat b21 = a21 * a10 - a11 * a20;\r\n\r\n\t\tfloat det = a00 * b01 + a01 * b11 + a02 * b21;\r\n\r\n\t\treturn mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\r\n\t\t\t\t\tb11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\r\n\t\t\t\t\tb21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\r\n\t}\r\n#endif\r\n\r\nivec4 getClusterInfo(sampler2D clusterBuffer,mat4 viewMatrix,vec4 viewport,vec3 position,vec4 fragCoord,vec4 projectParams)\r\n{\r\n\tvec3 viewPos = vec3(viewMatrix*vec4(position, 1.0)); //position in viewspace\r\n\r\n\tint clusterXIndex = int(floor(fragCoord.x/ (float(viewport.z)/float(CLUSTER_X_COUNT))));\r\n    int clusterYIndex = int(floor((viewport.w * (projectParams.z <0.0? 0.0 : 1.0) - fragCoord.y * projectParams.z)/ (float(viewport.w)/float(CLUSTER_Y_COUNT))));//Maybe Flipped ProjectMatrix\r\n\tfloat zSliceParam =float(CLUSTER_Z_COUNT)/log2(projectParams.y / projectParams.x);\r\n \tint clusterZIndex = int(floor(log2(-viewPos.z) * zSliceParam- log2(projectParams.x) * zSliceParam));//projectParams x:cameraNear y:cameraFar\r\n\r\n\tvec2 uv= vec2((float(clusterXIndex + clusterYIndex * CLUSTER_X_COUNT)+0.5)/float(c_ClusterBufferWidth),\r\n\t\t\t\t(float(clusterZIndex)+0.5)/float(c_ClusterBufferHeight));\r\n\tvec4 clusterPixel=texture2D(clusterBuffer, uv);\r\n\treturn ivec4(clusterPixel);//X:Point Count Y:Spot Count ZW:Light Offset\r\n}\r\n\r\n\r\nint getLightIndex(sampler2D clusterBuffer,int offset,int index) \r\n{\r\n\tint totalOffset=offset+index;\r\n\tint row=totalOffset/c_ClusterBufferFloatWidth;\r\n\tint lastRowFloat=totalOffset-row*c_ClusterBufferFloatWidth;\r\n\tint col=lastRowFloat/4;\r\n\tvec2 uv=vec2((float(col)+0.5)/float(c_ClusterBufferWidth),\r\n\t\t\t\t(float(row)+0.5)/float(c_ClusterBufferHeight));\r\n\tvec4 texel = texture2D(clusterBuffer, uv);\r\n    int pixelComponent = lastRowFloat-col*4;\r\n    if (pixelComponent == 0) \r\n      return int(texel.x);\r\n    else if (pixelComponent == 1) \r\n      return int(texel.y);\r\n    else if (pixelComponent == 2) \r\n      return int(texel.z);\r\n    else //pixelComponent==3\r\n      return int(texel.w);\r\n}\r\n\r\nDirectionLight getDirectionLight(sampler2D lightBuffer,int index) \r\n{\r\n    DirectionLight light;\r\n    float v = (float(index)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tlight.color=p1.rgb;\r\n    light.direction = p2.rgb;\r\n    return light;\r\n}\r\n\r\nPointLight getPointLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \r\n{\r\n    PointLight light;\r\n\tint pointIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,index);\r\n    float v = (float(pointIndex)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tlight.color=p1.rgb;\r\n\tlight.range = p1.a;\r\n    light.position = p2.rgb;\r\n    return light;\r\n}\r\n\r\nSpotLight getSpotLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \r\n{\r\n    SpotLight light;\r\n\tint spoIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,clusterInfo.x+index);\r\n    float v = (float(spoIndex)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tvec4 p3 = texture2D(lightBuffer, vec2(0.625,v));\r\n    light.color = p1.rgb;\r\n\tlight.range=p1.a;\r\n    light.position = p2.rgb;\r\n\tlight.spot = p2.a;\r\n\tlight.direction = p3.rgb;\r\n    return light;\r\n}\r\n\r\n// Laya\r\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\r\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\r\n\tfRatio *= fRatio;\r\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\r\n}\r\n\r\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\r\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\r\n\tvec3 distance = L * invLightRadius;\r\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\r\n\treturn attenuation * attenuation;\r\n}\r\n\r\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\r\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\r\n\tfloat attenuationFactor = 30.0;\r\n\tvec3 distance = L * invLightRadius;\r\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\r\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\r\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\r\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\r\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\r\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\r\n\tattenuation /= 1.0 - attenuationFactor;\r\n\treturn attenuation;\r\n}\r\n\r\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tmediump vec3 h = normalize(viewDir-lightVec);\r\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\r\n\tfloat nh = max (0.0, dot (h,normal));\r\n\tdiffuseColor=lightColor * ln;\r\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\r\n}\r\n\r\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec=normalize(light.direction);\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\r\n}\r\n\r\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec =  pos-light.position;\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\r\n\tdiffuseColor *= attenuate;\r\n\tspecularColor*= attenuate;\r\n}\r\n\r\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec =  pos-light.position;\r\n\tvec3 normalLightVec=lightVec/length(lightVec);\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\r\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\r\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\r\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\r\n\tdiffuseColor *=attenuate;\r\n\tspecularColor *=attenuate;\r\n}\r\n\r\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\r\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\r\n\tmediump vec3 N = unitNormal;\r\n\tmediump vec3 T = tangent;\r\n\tmediump vec3 B = binormal;\r\n\tmat3 TBN = mat3(T, B, N);\r\n\r\n\t// Transform from tangent space to world space.\r\n\tvec3 bumpedNormal =normalize(TBN*normalT);\r\n\treturn bumpedNormal;\r\n}\r\n\r\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\r\n\tvec3 normalT;\r\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\r\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\r\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\r\n\r\n\tvec3 T = normalize(tangent);\r\n\tvec3 B = normalize(binormal);\r\n\tvec3 N = normalize(unitNormal);\r\n\tmat3 TBN = mat3(T, B, N);\r\n\r\n\t// Transform from tangent space to world space.\r\n\tvec3 bumpedNormal = TBN * normalize(normalT);\r\n\r\n\treturn bumpedNormal;\r\n}\r\n\r\nvec3 DecodeLightmap(vec4 color) {\r\n\treturn color.rgb*color.a*5.0;\r\n}\r\n\r\nvec3 decodeHDR(vec4 color,float range) {\r\n\treturn color.rgb*color.a*range;\r\n}\r\n\r\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\r\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\r\n\ttransTexcoord.y+=1.0;\r\n\treturn transTexcoord;\r\n}\r\n\r\nvec4 remapGLPositionZ(vec4 position) {\r\n\tposition.z=position.z * 2.0 - position.w;\r\n\treturn position;\r\n}\r\n\r\nmediump vec3 layaLinearToGammaSpace (mediump vec3 linRGB)\r\n{\r\n    linRGB = max(linRGB, vec3(0.0));\r\n    // An almost-perfect approximation from http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\r\n    return max(1.055 * pow(linRGB,vec3(0.416666667)) - 0.055, 0.0);   \r\n}\r\n\r\nLayaLight layaDirectionLightToLight(in DirectionLight light,in float attenuate)\r\n{\r\n\tLayaLight relight;\r\n\trelight.color = light.color*attenuate;\r\n\trelight.dir = light.direction;\r\n\treturn relight;\r\n}\r\n\r\nLayaLight layaPointLightToLight(in vec3 pos,in vec3 normal, in PointLight light,in float attenuate)\r\n{\r\n\tLayaLight relight;\r\n\tvec3 lightVec =  pos-light.position;\r\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range);\r\n\trelight.color = light.color*attenuate;\r\n\trelight.dir = normalize(lightVec);\r\n\treturn relight;\r\n}\r\n\r\nLayaLight layaSpotLightToLight(in vec3 pos,in vec3 normal, in SpotLight light,in float attenuate)\r\n{\r\n\tLayaLight relight;\r\n\tvec3 lightVec =  pos-light.position;\r\n\tvec3 normalLightVec=lightVec/length(lightVec);\r\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\r\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\r\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\r\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range)*dl;\r\n\trelight.dir = lightVec;\r\n\trelight.color = light.color*attenuate;\r\n\treturn relight;\r\n}\r\n\r\n"),Ae.addInclude("ShadowSampleTent.glsl",'// ------------------------------------------------------------------\r\n//  PCF Filtering Tent Functions\r\n// ------------------------------------------------------------------\r\n\r\n// Assuming a isoceles right angled triangle of height "triangleHeight" (as drawn below).\r\n// This function return the area of the triangle above the first texel(in Y the first texel).\r\n//\r\n// |\\      <-- 45 degree slop isosceles right angled triangle\r\n// | \\\r\n// ----    <-- length of this side is "triangleHeight"\r\n// _ _ _ _ <-- texels\r\nfloat sampleShadowGetIRTriangleTexelArea(float triangleHeight)\r\n{\r\n    return triangleHeight - 0.5;\r\n}\r\n\r\n// Assuming a isoceles triangle of 1.5 texels height and 3 texels wide lying on 4 texels.\r\n// This function return the area of the triangle above each of those texels.\r\n//    |    <-- offset from -0.5 to 0.5, 0 meaning triangle is exactly in the center\r\n//   / \\   <-- 45 degree slop isosceles triangle (ie tent projected in 2D)\r\n//  /   \\\r\n// _ _ _ _ <-- texels\r\n// X Y Z W <-- result indices (in computedArea.xyzw and computedAreaUncut.xyzw)\r\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\r\nvoid sampleShadowGetTexelAreasTent3x3(float offset, out vec4 computedArea, out vec4 computedAreaUncut)\r\n{\r\n    // Compute the exterior areas,a and h is same.\r\n    float a = offset + 0.5;\r\n    float offsetSquaredHalved = a * a * 0.5;\r\n    computedAreaUncut.x = computedArea.x = offsetSquaredHalved - offset;\r\n    computedAreaUncut.w = computedArea.w = offsetSquaredHalved;\r\n\r\n    // Compute the middle areas\r\n    // For Y : We find the area in Y of as if the left section of the isoceles triangle would\r\n    // intersect the axis between Y and Z (ie where offset = 0).\r\n    computedAreaUncut.y = sampleShadowGetIRTriangleTexelArea(1.5 - offset);\r\n    // This area is superior to the one we are looking for if (offset < 0) thus we need to\r\n    // subtract the area of the triangle defined by (0,1.5-offset), (0,1.5+offset), (-offset,1.5).\r\n    float clampedOffsetLeft = min(offset,0.0);\r\n    float areaOfSmallLeftTriangle = clampedOffsetLeft * clampedOffsetLeft;\r\n    computedArea.y = computedAreaUncut.y - areaOfSmallLeftTriangle;\r\n\r\n    // We do the same for the Z but with the right part of the isoceles triangle\r\n    computedAreaUncut.z = sampleShadowGetIRTriangleTexelArea(1.5 + offset);\r\n    float clampedOffsetRight = max(offset,0.0);\r\n    float areaOfSmallRightTriangle = clampedOffsetRight * clampedOffsetRight;\r\n    computedArea.z = computedAreaUncut.z - areaOfSmallRightTriangle;\r\n}\r\n\r\n// Assuming a isoceles triangle of 2.5 texel height and 5 texels wide lying on 6 texels.\r\n// This function return the weight of each texels area relative to the full triangle area.\r\n//  /       \\\r\n// _ _ _ _ _ _ <-- texels\r\n// 0 1 2 3 4 5 <-- computed area indices (in texelsWeights[])\r\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\r\nvoid sampleShadowGetTexelWeightsTent5x5(float offset, out vec3 texelsWeightsA, out vec3 texelsWeightsB)\r\n{\r\n    vec4 areaFrom3texelTriangle;\r\n    vec4 areaUncutFrom3texelTriangle;\r\n    sampleShadowGetTexelAreasTent3x3(offset, areaFrom3texelTriangle, areaUncutFrom3texelTriangle);\r\n\r\n    // Triangle slope is 45 degree thus we can almost reuse the result of the 3 texel wide computation.\r\n    // the 5 texel wide triangle can be seen as the 3 texel wide one but shifted up by one unit/texel.\r\n    // 0.16 is 1/(the triangle area)\r\n    texelsWeightsA.x = 0.16 * (areaFrom3texelTriangle.x);\r\n    texelsWeightsA.y = 0.16 * (areaUncutFrom3texelTriangle.y);\r\n    texelsWeightsA.z = 0.16 * (areaFrom3texelTriangle.y + 1.0);\r\n    texelsWeightsB.x = 0.16 * (areaFrom3texelTriangle.z + 1.0);\r\n    texelsWeightsB.y = 0.16 * (areaUncutFrom3texelTriangle.z);\r\n    texelsWeightsB.z = 0.16 * (areaFrom3texelTriangle.w);\r\n}\r\n\r\n// 5x5 Tent filter (45 degree sloped triangles in U and V)\r\nvoid sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize, vec2 coord, out float fetchesWeights[9], out vec2 fetchesUV[9])\r\n{\r\n    // tent base is 5x5 base thus covering from 25 to 36 texels, thus we need 9 bilinear PCF fetches\r\n    vec2 tentCenterInTexelSpace = coord.xy * shadowMapTextureTexelSize.zw;\r\n    vec2 centerOfFetchesInTexelSpace = floor(tentCenterInTexelSpace + 0.5);\r\n    vec2 offsetFromTentCenterToCenterOfFetches = tentCenterInTexelSpace - centerOfFetchesInTexelSpace;\r\n\r\n    // find the weight of each texel based on the area of a 45 degree slop tent above each of them.\r\n    vec3 texelsWeightsUA, texelsWeightsUB;\r\n    vec3 texelsWeightsVA, texelsWeightsVB;\r\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x, texelsWeightsUA, texelsWeightsUB);\r\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y, texelsWeightsVA, texelsWeightsVB);\r\n\r\n    // each fetch will cover a group of 2x2 texels, the weight of each group is the sum of the weights of the texels\r\n    vec3 fetchesWeightsU = vec3(texelsWeightsUA.xz, texelsWeightsUB.y) + vec3(texelsWeightsUA.y, texelsWeightsUB.xz);\r\n    vec3 fetchesWeightsV = vec3(texelsWeightsVA.xz, texelsWeightsVB.y) + vec3(texelsWeightsVA.y, texelsWeightsVB.xz);\r\n\r\n    // move the PCF bilinear fetches to respect texels weights\r\n    vec3 fetchesOffsetsU = vec3(texelsWeightsUA.y, texelsWeightsUB.xz) / fetchesWeightsU.xyz + vec3(-2.5,-0.5,1.5);\r\n    vec3 fetchesOffsetsV = vec3(texelsWeightsVA.y, texelsWeightsVB.xz) / fetchesWeightsV.xyz + vec3(-2.5,-0.5,1.5);\r\n    fetchesOffsetsU *= shadowMapTextureTexelSize.xxx;\r\n    fetchesOffsetsV *= shadowMapTextureTexelSize.yyy;\r\n\r\n    vec2 bilinearFetchOrigin = centerOfFetchesInTexelSpace * shadowMapTextureTexelSize.xy;\r\n    fetchesUV[0] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.x);\r\n    fetchesUV[1] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.x);\r\n    fetchesUV[2] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.x);\r\n    fetchesUV[3] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.y);\r\n    fetchesUV[4] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.y);\r\n    fetchesUV[5] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.y);\r\n    fetchesUV[6] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.z);\r\n    fetchesUV[7] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.z);\r\n    fetchesUV[8] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.z);\r\n\r\n    fetchesWeights[0] = fetchesWeightsU.x * fetchesWeightsV.x;\r\n    fetchesWeights[1] = fetchesWeightsU.y * fetchesWeightsV.x;\r\n    fetchesWeights[2] = fetchesWeightsU.z * fetchesWeightsV.x;\r\n    fetchesWeights[3] = fetchesWeightsU.x * fetchesWeightsV.y;\r\n    fetchesWeights[4] = fetchesWeightsU.y * fetchesWeightsV.y;\r\n    fetchesWeights[5] = fetchesWeightsU.z * fetchesWeightsV.y;\r\n    fetchesWeights[6] = fetchesWeightsU.x * fetchesWeightsV.z;\r\n    fetchesWeights[7] = fetchesWeightsU.y * fetchesWeightsV.z;\r\n    fetchesWeights[8] = fetchesWeightsU.z * fetchesWeightsV.z;\r\n}'),Ae.addInclude("GlobalIllumination.glsl",'struct LayaGIInput\r\n{\r\n\tvec2 lightmapUV;\r\n};\r\n\r\n#define LAYA_SPECCUBE_LOD_STEPS 6.0\r\n\r\nuniform vec3 u_AmbientColor;\r\n\r\n#if defined(GI_AMBIENT_SH)\r\n\tuniform vec4 u_AmbientSHAr;\r\n\tuniform vec4 u_AmbientSHAg;\r\n\tuniform vec4 u_AmbientSHAb;\r\n\tuniform vec4 u_AmbientSHBr;\r\n\tuniform vec4 u_AmbientSHBg;\r\n\tuniform vec4 u_AmbientSHBb;\r\n\tuniform vec4 u_AmbientSHC;\r\n#endif\r\n\r\nuniform samplerCube u_ReflectTexture;\r\nuniform vec4 u_ReflectCubeHDRParams;\r\n\r\n\r\n#ifdef GI_AMBIENT_SH\r\n\tmediump vec3 shEvalLinearL0L1(mediump vec4 normal)\r\n\t{\r\n\t\tmediump vec3 x;\r\n\t\t// Linear (L1) + constant (L0) polynomial terms\r\n\t\tx.r = dot(u_AmbientSHAr, normal);\r\n\t\tx.g = dot(u_AmbientSHAg, normal);\r\n\t\tx.b = dot(u_AmbientSHAb, normal);\r\n\t\treturn x;\r\n\t}\r\n\r\n\tmediump vec3 shEvalLinearL2(mediump vec4 normal)\r\n\t{\r\n\t\tmediump vec3 x1,x2;\r\n\t\t// 4 of the quadratic (L2) polynomials\r\n\t\tmediump vec4 vB = normal.xyzz * normal.yzzx;\r\n\t\tx1.r = dot(u_AmbientSHBr, vB);\r\n\t\tx1.g = dot(u_AmbientSHBg, vB);\r\n\t\tx1.b = dot(u_AmbientSHBb, vB);\r\n\r\n\t\t// Final (5th) quadratic (L2) polynomial\r\n\t\tmediump float vC = normal.x*normal.x - normal.y*normal.y;\r\n\t\tx2 = u_AmbientSHC.rgb * vC;\r\n\r\n\t\treturn x1 + x2;\r\n\t}\r\n\t\r\n\tmediump vec3 shadeSHPerPixel(mediump vec3 normal)\r\n\t{\r\n\t\tmediump vec3 ambientContrib;\r\n\t\tmediump vec4 normalV4=vec4(-normal.x,normal.yz, 1.0);//Note:SH Data is left-hand,so x need inverse\r\n\t\tambientContrib = shEvalLinearL0L1(normalV4);\r\n\t\tambientContrib += shEvalLinearL2(normalV4);\r\n\t\tmediump vec3 ambient = max(vec3(0.0), ambientContrib);\r\n\t\tambient = layaLinearToGammaSpace(ambient);\r\n\t\treturn ambient;\r\n\t}\r\n#endif\r\n\r\nmediump vec3 layaDecodeDirectionalLightmap (mediump vec3 color, lowp vec4 dirTex, mediump vec3 normalWorld)\r\n{\r\n    // In directional (non-specular) mode Enlighten bakes dominant light direction\r\n    // in a way, that using it for half Lambert and then dividing by a "rebalancing coefficient"\r\n    // gives a result close to plain diffuse response lightmaps, but normalmapped.\r\n\r\n    // Note that dir is not unit length on purpose. Its length is "directionality", like\r\n    // for the directional specular lightmaps.\r\n\tlowp vec3 directional=dirTex.xyz - 0.5;\r\n\tdirectional.x=-directional.x;//NOTE:because coord System\r\n    mediump float halfLambert = dot(normalWorld,directional) + 0.5;\r\n\r\n    return color * halfLambert / max(1e-4, dirTex.w);\r\n}\r\n\r\nvec3 layaGIBase(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld)\r\n{\r\n\tvec3 indirectDiffuse;\r\n\t#ifdef LIGHTMAP\t\r\n\t\tmediump vec3 bakedColor =decodeHDR(texture2D(u_LightMap, giInput.lightmapUV),5.0);\r\n\t\t#ifdef LIGHTMAP_DIRECTIONAL\r\n\t\t\tlowp vec4 bakedDirTex = texture2D (u_LightMapDirection, giInput.lightmapUV);\r\n            indirectDiffuse = layaDecodeDirectionalLightmap (bakedColor, bakedDirTex, normalWorld);\r\n\t\t#else //unDirectional lightmap\r\n\t\t\tindirectDiffuse = bakedColor;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef GI_AMBIENT_SH\r\n\t\t\tindirectDiffuse = shadeSHPerPixel(normalWorld);\r\n\t\t#else\r\n\t\t\tindirectDiffuse = u_AmbientColor; //already in gamma space\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tindirectDiffuse*=occlusion;\r\n\treturn indirectDiffuse;\r\n}\r\n\r\nmediump vec3 layaGlossyEnvironment(mediump vec4 glossIn)\r\n{\r\n\tmediump float perceptualRoughness = glossIn.a;\r\n\r\n\t// use approximation to solve,below is more reasonable,but maybe slow. \r\n\t// float m = perceptualRoughnessToRoughness(perceptualRoughness); // m is the real roughness parameter\r\n    // const float fEps = 1.192092896e-07F;        // smallest such that 1.0+FLT_EPSILON != 1.0  (+1e-4h is NOT good here. is visibly very wrong)\r\n    // float n =  (2.0/max(fEps, m*m))-2.0;        // remap to spec power. See eq. 21 in --\x3e https://dl.dropboxusercontent.com/u/55891920/papers/mm_brdf.pdf\r\n    // n /= 4;                                     // remap from n_dot_h formulatino to n_dot_r. See section "Pre-convolved Cube Maps vs Path Tracers" --\x3e https://s3.amazonaws.com/docs.knaldtech.com/knald/1.0.0/lys_power_drops.html\r\n    // perceptualRoughness = pow( 2/(n+2), 0.25);  // remap back to square root of real roughness (0.25 include both the sqrt root of the conversion and sqrt for going from roughness to perceptualRoughness)\r\n\tperceptualRoughness = perceptualRoughness * (1.7 - 0.7*perceptualRoughness);//just a approximation,but fast.\r\n \r\n\tmediump float mip = perceptualRoughness * LAYA_SPECCUBE_LOD_STEPS;\r\n\tmediump vec3 uvw = glossIn.rgb;\r\n\tuvw.x=-uvw.x;//Note:reflectCube is left-hand,so x need inverse\r\n\tmediump vec4 rgbm=textureCubeLodEXT(u_ReflectTexture,uvw,mip);\r\n\treturn decodeHDR(rgbm,u_ReflectCubeHDRParams.x);\r\n}\r\n\r\nmediump vec3 layaGIIndirectSpecular(LayaGIInput giInput,mediump float occlusion, vec4 glossIn)\r\n{\r\n\tmediump vec3 specular = layaGlossyEnvironment(glossIn);\r\n\treturn specular * occlusion;\r\n}\r\n\r\n\r\nLayaGI layaGlobalIllumination(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld,mediump vec4 uvwRoughness)\r\n{\r\n\tLayaGI gi;\r\n\tgi.diffuse = layaGIBase(giInput,occlusion, normalWorld);\r\n\tgi.specular = layaGIIndirectSpecular(giInput,occlusion, uvwRoughness);\r\n\treturn gi;\r\n}\r\n\r\n\r\n'),Ae.addInclude("Shadow.glsl",'#ifndef GRAPHICS_API_GLES3\r\n\t#define NO_NATIVE_SHADOWMAP\r\n#endif\r\n\r\n#ifdef NO_NATIVE_SHADOWMAP\r\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2D textureName\r\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName,coord3.xy).r<coord3.z?0.0:1.0)\r\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap\r\n#else\r\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2DShadow textureName\r\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName,coord3,0.0)\r\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap\r\n#endif\r\n\r\n#if defined(RECEIVESHADOW)&&defined(SHADOW)\r\n    #define CALCULATE_SHADOWS\r\n#endif\r\n\r\n#if defined(RECEIVESHADOW)&&defined(SHADOW_SPOT)\r\n\t#define CALCULATE_SPOTSHADOWS\r\n#endif\r\n\r\nuniform vec4 u_ShadowBias; // x: depth bias, y: normal bias\r\n\r\n#if defined(CALCULATE_SHADOWS)||defined(CALCULATE_SPOTSHADOWS)\r\n\t#include "ShadowSampleTent.glsl"\r\n\tuniform vec4 u_ShadowMapSize;\r\n\tuniform vec4 u_ShadowParams; // x: shadowStrength y: ShadowSpotLightStrength\r\n\r\n\t\r\n\tfloat sampleShdowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize)\r\n\t{\r\n\t\tfloat attenuation;\r\n\t\tvec4 attenuation4;\r\n\t\tvec2 offset=shadowMapSize.xy/2.0;\r\n\t\tvec3 shadowCoord0=shadowCoord + vec3(-offset,0.0);\r\n\t\tvec3 shadowCoord1=shadowCoord + vec3(offset.x,-offset.y,0.0);\r\n\t\tvec3 shadowCoord2=shadowCoord + vec3(-offset.x,offset.y,0.0);\r\n\t\tvec3 shadowCoord3=shadowCoord + vec3(offset,0.0);\r\n\t\tattenuation4.x = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord0);\r\n\t\tattenuation4.y = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord1);\r\n\t\tattenuation4.z = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord2);\r\n\t\tattenuation4.w = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord3);\r\n\t\tattenuation = dot(attenuation4, vec4(0.25));\r\n\t\treturn attenuation;\r\n\t}\r\n\r\n\tfloat sampleShdowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize)\r\n\t{\r\n\t\tfloat attenuation;\r\n\t\tfloat fetchesWeights[9];\r\n\t\tvec2 fetchesUV[9];\r\n\t\tsampleShadowComputeSamplesTent5x5(shadowmapSize, shadowCoord.xy, fetchesWeights, fetchesUV);\r\n\t\tattenuation = fetchesWeights[0] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[0].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[1] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[1].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[2] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[2].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[3] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[3].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[4] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[4].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[5] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[5].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[6] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[6].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[7] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[7].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[8] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[8].xy, shadowCoord.z));\r\n\t\treturn attenuation;\r\n\t}\r\n\r\n#endif\r\n\r\n\r\n\r\n\r\n#ifdef CALCULATE_SHADOWS\r\n\r\n\tTEXTURE2D_SHADOW(u_ShadowMap);\r\n\r\n\tuniform mat4 u_ShadowMatrices[4];\r\n\tuniform vec4 u_ShadowSplitSpheres[4];// max cascade is 4\r\n\r\n\tmediump int computeCascadeIndex(vec3 positionWS)\r\n\t{\r\n\t\tvec3 fromCenter0 = positionWS - u_ShadowSplitSpheres[0].xyz;\r\n\t\tvec3 fromCenter1 = positionWS - u_ShadowSplitSpheres[1].xyz;\r\n\t\tvec3 fromCenter2 = positionWS - u_ShadowSplitSpheres[2].xyz;\r\n\t\tvec3 fromCenter3 = positionWS - u_ShadowSplitSpheres[3].xyz;\r\n\r\n\t\tmediump vec4 comparison = vec4(\r\n\t\t\tdot(fromCenter0, fromCenter0)<u_ShadowSplitSpheres[0].w,\r\n\t\t\tdot(fromCenter1, fromCenter1)<u_ShadowSplitSpheres[1].w,\r\n\t\t\tdot(fromCenter2, fromCenter2)<u_ShadowSplitSpheres[2].w,\r\n\t\t\tdot(fromCenter3, fromCenter3)<u_ShadowSplitSpheres[3].w);\r\n\t\tcomparison.yzw = clamp(comparison.yzw - comparison.xyz,0.0,1.0);//keep the nearest\r\n\t\tmediump vec4 indexCoefficient = vec4(4.0,3.0,2.0,1.0);\r\n\t\tmediump int index = 4 - int(dot(comparison, indexCoefficient));\r\n\t\treturn index;\r\n\t}\r\n\r\n\tvec4 getShadowCoord(vec4 positionWS)\r\n\t{\r\n\t\t#ifdef SHADOW_CASCADE\r\n\t\t\tmediump int cascadeIndex = computeCascadeIndex(positionWS.xyz);\r\n\t\t\tif(cascadeIndex > 3)// out of shadow range cascadeIndex is 4.\r\n\t\t\t\treturn vec4(0.0);\r\n\t\t\t\r\n\t\t\t#ifdef GRAPHICS_API_GLES3\r\n\t\t\t\treturn u_ShadowMatrices[cascadeIndex] * positionWS;\r\n\t\t\t#else\r\n\t\t\t\tmat4 shadowMat;\r\n\t\t\t\tif(cascadeIndex == 0)\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[0];\r\n\t\t\t\telse if(cascadeIndex == 1)\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[1];\r\n\t\t\t\telse if(cascadeIndex == 2)\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[2];\r\n\t\t\t\telse\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[3];\r\n\t\t\t\treturn shadowMat * positionWS;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\treturn u_ShadowMatrices[0] * positionWS;\r\n\t\t#endif\r\n\t}\r\n\r\n\tfloat sampleShadowmap(vec4 shadowCoord)\r\n\t{\r\n\t\tshadowCoord.xyz /= shadowCoord.w;\r\n\t\tfloat attenuation = 1.0;\r\n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\r\n\t\t{\r\n\t\t\t#if defined(SHADOW_SOFT_SHADOW_HIGH)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#elif defined(SHADOW_SOFT_SHADOW_LOW)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#else\r\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_ShadowMap,shadowCoord.xyz);\r\n\t\t\t#endif\r\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.x);//shadowParams.x:shadow strength\r\n\t\t}\r\n\t\treturn attenuation;\r\n\t}\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tTEXTURE2D_SHADOW(u_SpotShadowMap);\r\n\tuniform mat4 u_SpotViewProjectMatrix;\r\n\tfloat sampleSpotShadowmap(vec4 shadowCoord)\r\n\t{\r\n\t\tshadowCoord.xyz /= shadowCoord.w;\r\n\t\tfloat attenuation = 1.0;\r\n\t\tshadowCoord.xy +=1.0;\r\n\t\tshadowCoord.xy/=2.0; \r\n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\r\n\t\t{\r\n\t\t\t#if defined(SHADOW_SPOT_SOFT_SHADOW_HIGH)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_SpotShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#elif defined(SHADOW_SPOT_SOFT_SHADOW_LOW)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_SpotShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#else\r\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_SpotShadowMap,shadowCoord.xyz);\r\n\t\t\t#endif\r\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.y);//shadowParams.y:shadow strength\r\n\t\t}\r\n\t\treturn attenuation;\r\n\t}\r\n#endif\r\n\r\nvec3 applyShadowBias(vec3 positionWS, vec3 normalWS, vec3 lightDirection)\r\n{\r\n    float invNdotL = 1.0 - clamp(dot(-lightDirection, normalWS),0.0,1.0);\r\n    float scale = invNdotL * u_ShadowBias.y;\r\n\r\n    // normal bias is negative since we want to apply an inset normal offset\r\n    positionWS += -lightDirection * u_ShadowBias.xxx;\r\n    positionWS += normalWS * vec3(scale);\r\n    return positionWS;\r\n}\r\n'),Ae.addInclude("ShadowCasterVS.glsl",'#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\nuniform mat4 u_ViewProjection;\r\n\r\n#ifdef SHADOW\r\n\tuniform vec3 u_ShadowLightDirection;\r\n#endif\r\n\r\n\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\nvec4 shadowCasterVertex()\r\n{\r\n\tmat4 worldMat;\r\n\t#ifdef GPU_INSTANCE\r\n\t\tworldMat = a_WorldMat;\r\n\t#else\r\n\t\tworldMat = u_WorldMat;\r\n\t#endif\r\n\t\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tworldMat = worldMat * skinTransform;\r\n\t#endif\r\n\r\n\tvec4 positionWS = worldMat * a_Position;\r\n\tvec3 normalWS = normalize(a_Normal*INVERSE_MAT(mat3(worldMat)));//if no normalize will cause precision problem\r\n\r\n\t#ifdef SHADOW\r\n\t\tpositionWS.xyz = applyShadowBias(positionWS.xyz,normalWS,u_ShadowLightDirection);\r\n\t#endif\r\n\r\n\tvec4 positionCS = u_ViewProjection * positionWS;\r\n\t#ifdef SHADOW_SPOT\r\n\t\tpositionCS.z = positionCS.z-u_ShadowBias.x/positionCS.w;\r\n\t#endif\r\n\tpositionCS.z = max(positionCS.z, 0.0);//min ndc z is 0.0\r\n\t\r\n\t// //TODOUV\r\n\t// #if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t// \tv_Texcoord0=a_Texcoord0;\r\n\t// #endif\r\n    return positionCS;\r\n}\r\n'),Ae.addInclude("ShadowCasterFS.glsl","// #ifdef ALPHATEST\r\n// \tuniform float u_AlphaTestValue;\r\n// #endif\r\n\r\n// #ifdef DIFFUSEMAP\r\n// \tuniform sampler2D u_DiffuseTexture;\r\n// #endif\r\n\r\n// #if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n// \tvarying vec2 v_Texcoord0;\r\n// #endif\r\n\r\nvec4 shadowCasterFragment()\r\n{\r\n    return vec4(0.0);\r\n    // #if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t// \tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\r\n\t// \tif( alpha < u_AlphaTestValue )\r\n\t// \t{\r\n\t// \t\tdiscard;\r\n\t// \t}\r\n\t// #endif\r\n}\r\n"),Ae.addInclude("Colors.glsl",'#include "StdLib.glsl";\r\n\r\n#define EPSILON 1.0e-4\r\n\r\n// Quadratic color thresholding\r\n// curve = (threshold - knee, knee * 2, 0.25 / knee)\r\nmediump vec4 quadraticThreshold(mediump vec4 color, mediump float threshold, mediump vec3 curve) {\r\n\t// Pixel brightness\r\n\tmediump float br = max3(color.r, color.g, color.b);\r\n\r\n\t// Under-threshold part: quadratic curve\r\n\tmediump float rq = clamp(br - curve.x, 0.0, curve.y);\r\n\trq = curve.z * rq * rq;\r\n\r\n\t// Combine and apply the brightness response curve.\r\n\tcolor *= max(rq, br - threshold) / max(br, EPSILON);\r\n\r\n\treturn color;\r\n}\r\n\r\n\r\n\r\n//\r\n// sRGB transfer functions\r\n// Fast path ref: http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\r\n//\r\nmediump vec3 sRGBToLinear(mediump vec3 c) {\r\n\t#ifdef USE_VERY_FAST_SRGB\r\n\t\treturn c * c;\r\n\t#elif defined(USE_FAST_SRGB)\r\n\t\treturn c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);\r\n\t#else\r\n\t\tmediump vec3 linearRGBLo = c / 12.92;\r\n\t\tmediump vec3 power=vec3(2.4, 2.4, 2.4);\r\n\t\tmediump vec3 linearRGBHi = positivePow((c + 0.055) / 1.055, power);\r\n\t\tmediump vec3 linearRGB =vec3((c.r<=0.04045) ? linearRGBLo.r : linearRGBHi.r,(c.g<=0.04045) ? linearRGBLo.g : linearRGBHi.g,(c.b<=0.04045) ? linearRGBLo.b : linearRGBHi.b);\r\n\t\treturn linearRGB;\r\n\t#endif\r\n}\r\n\r\nmediump vec4 sRGBToLinear(mediump vec4 c){\r\n    return vec4(sRGBToLinear(c.rgb), c.a);\r\n}\r\n\r\n\r\n\r\nmediump vec3 linearToSRGB(mediump vec3 c) {\r\n\t#ifdef USE_VERY_FAST_SRGB\r\n\t\treturn sqrt(c);\r\n\t#elif defined(USE_FAST_SRGB)\r\n\t\treturn max(1.055 * PositivePow(c, 0.416666667) - 0.055, 0.0);\r\n\t#else\r\n\t\tmediump vec3 sRGBLo = c * 12.92;\r\n\t\tmediump vec3 power=vec3(1.0 / 2.4, 1.0 / 2.4, 1.0 / 2.4);\r\n\t\tmediump vec3 sRGBHi = (positivePow(c, power) * 1.055) - 0.055;\r\n\t\tmediump vec3 sRGB =vec3((c.r<=0.0031308) ? sRGBLo.r : sRGBHi.r,(c.g<=0.0031308) ? sRGBLo.g : sRGBHi.g,(c.b<=0.0031308) ? sRGBLo.b : sRGBHi.b);\r\n\t\treturn sRGB;\r\n\t#endif\r\n}\r\n\r\nmediump vec4 linearToSRGB(mediump vec4 c){\r\n    return vec4(linearToSRGB(c.rgb), c.a);\r\n}'),Ae.addInclude("Sampling.glsl","// Better, temporally stable box filtering\r\n// [Jimenez14] http://goo.gl/eomGso\r\n// . . . . . . .\r\n// . A . B . C .\r\n// . . D . E . .\r\n// . F . G . H .\r\n// . . I . J . .\r\n// . K . L . M .\r\n// . . . . . . .\r\nmediump vec4 downsampleBox13Tap(sampler2D tex, vec2 uv, vec2 texelSize)\r\n{\r\n    mediump vec4 A = texture2D(tex, uv + texelSize * vec2(-1.0, -1.0));\r\n    mediump vec4 B = texture2D(tex, uv + texelSize * vec2( 0.0, -1.0));\r\n    mediump vec4 C = texture2D(tex, uv + texelSize * vec2( 1.0, -1.0));\r\n    mediump vec4 D = texture2D(tex, uv + texelSize * vec2(-0.5, -0.5));\r\n    mediump vec4 E = texture2D(tex, uv + texelSize * vec2( 0.5, -0.5));\r\n    mediump vec4 F = texture2D(tex, uv + texelSize * vec2(-1.0,  0.0));\r\n    mediump vec4 G = texture2D(tex, uv);\r\n    mediump vec4 H = texture2D(tex, uv + texelSize * vec2( 1.0,  0.0));\r\n    mediump vec4 I = texture2D(tex, uv + texelSize * vec2(-0.5,  0.5));\r\n    mediump vec4 J = texture2D(tex, uv + texelSize * vec2( 0.5,  0.5));\r\n    mediump vec4 K = texture2D(tex, uv + texelSize * vec2(-1.0,  1.0));\r\n    mediump vec4 L = texture2D(tex, uv + texelSize * vec2( 0.0,  1.0));\r\n    mediump vec4 M = texture2D(tex, uv + texelSize * vec2( 1.0,  1.0));\r\n\r\n\tmediump vec2 scale= vec2(0.5, 0.125);\r\n    mediump vec2 div = (1.0 / 4.0) * scale;\r\n\r\n    mediump vec4 o = (D + E + I + J) * div.x;\r\n    o += (A + B + G + F) * div.y;\r\n    o += (B + C + H + G) * div.y;\r\n    o += (F + G + L + K) * div.y;\r\n    o += (G + H + M + L) * div.y;\r\n\r\n    return o;\r\n}\r\n\r\n// Standard box filtering\r\nmediump vec4 downsampleBox4Tap(sampler2D tex, vec2 uv, vec2 texelSize)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0);\r\n\r\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.xw);\r\n    s += texture2D(tex, uv + d.zw);\r\n\r\n    return s * (1.0 / 4.0);\r\n}\r\n\r\n// 9-tap bilinear upsampler (tent filter)\r\n// . . . . . . .\r\n// . 1 . 2 . 1 .\r\n// . . . . . . .\r\n// . 2 . 4 . 2 .\r\n// . . . . . . .\r\n// . 1 . 2 . 1 .\r\n// . . . . . . .\r\nmediump vec4 upsampleTent(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(1.0, 1.0, -1.0, 0.0) * sampleScale;\r\n\r\n    mediump vec4 s =  texture2D(tex, uv - d.xy);\r\n    s += texture2D(tex, uv - d.wy) * 2.0;\r\n    s += texture2D(tex, uv - d.zy);\r\n\r\n    s += texture2D(tex, uv + d.zw) * 2.0;\r\n    s += texture2D(tex, uv) * 4.0;\r\n    s += texture2D(tex,\tuv + d.xw) * 2.0;\r\n\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.wy) * 2.0;\r\n    s += texture2D(tex, uv + d.xy);\r\n\r\n    return s * (1.0 / 16.0);\r\n}\r\n\r\n// Standard box filtering\r\nmediump vec4 upsampleBox(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0) * 0.5 * sampleScale;\r\n\r\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.xw);\r\n    s += texture2D(tex, uv + d.zw);\r\n\r\n    return s * (1.0 / 4.0);\r\n}"),Ae.addInclude("StdLib.glsl","#define HALF_MAX       65504.0 // (2 - 2^-10) * 2^15\r\n\r\n#define FLT_EPSILON    1.192092896e-07 // Smallest positive number, such that 1.0 + FLT_EPSILON != 1.0\r\n\r\nmediump vec4 safeHDR(mediump vec4 c)\r\n{\r\n    return min(c, HALF_MAX);\r\n}\r\n\r\nfloat max3(float a, float b, float c)\r\n{\r\n    return max(max(a, b), c);\r\n}\r\n\r\nvec3 positivePow(vec3 base, vec3 power)\r\n{\r\n    return pow(max(abs(base), vec3(FLT_EPSILON, FLT_EPSILON, FLT_EPSILON)), power);\r\n}"),Ae.addInclude("PBRVSInput.glsl","attribute vec4 a_Position;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nattribute vec3 a_Normal;\r\nvarying vec3 v_Normal; \r\n\r\n#if defined(NORMALTEXTURE)||defined(PARALLAXTEXTURE)\r\n\tattribute vec4 a_Tangent0;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n    #ifdef PARALLAXTEXTURE\r\n\t    varying vec3 v_ViewDirForParallax;\r\n    #endif\r\n#endif\r\n\r\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#if defined(LIGHTMAP)&&defined(UV1)\r\n\tattribute vec2 a_Texcoord1;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\nuniform vec3 u_CameraPos;\r\nvarying vec3 v_EyeVec;\r\nvarying vec3 v_PositionWorld;\r\nvarying float v_posViewZ;\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif"),Ae.addInclude("PBRFSInput.glsl","#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n\tuniform float u_NormalScale;\r\n#endif\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n\r\n#ifdef METALLICGLOSSTEXTURE\r\n\tuniform sampler2D u_MetallicGlossTexture;\r\n#endif\r\nuniform float u_Metallic;\r\n\r\n#ifdef SPECULARGLOSSTEXTURE\r\n\tuniform sampler2D u_SpecGlossTexture;\r\n#endif\r\nuniform vec3 u_SpecularColor;\r\n\r\nuniform float u_Smoothness;\r\nuniform float u_SmoothnessScale;\r\n\r\n#ifdef PARALLAXTEXTURE\r\n\tuniform sampler2D u_ParallaxTexture;\r\n\tuniform float u_ParallaxScale;\r\n\tvarying vec3 v_ViewDirForParallax;\r\n#endif\r\n\r\n#ifdef OCCLUSIONTEXTURE\r\n\tuniform sampler2D u_OcclusionTexture;\r\n\tuniform float u_occlusionStrength;\r\n#endif\r\n\r\n#ifdef EMISSION \r\n\t#ifdef EMISSIONTEXTURE\r\n\t\tuniform sampler2D u_EmissionTexture;\r\n\t#endif\r\n\tuniform vec4 u_EmissionColor;\r\n#endif\r\n\r\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform sampler2D u_LightMap;\r\n\t#ifdef LIGHTMAP_DIRECTIONAL\r\n\t\tuniform sampler2D u_LightMapDirection;\r\n\t#endif\r\n#endif\r\n\r\nvarying vec3 v_Normal; \r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n#endif\r\n\r\nvarying vec3 v_EyeVec;\r\n\r\n#ifdef NORMALTEXTURE\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n\r\n//TODO\r\nvarying vec3 v_PositionWorld;\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\nmediump float lerpOneTo(mediump float b, mediump float t)\r\n{\r\n    mediump float oneMinusT = 1.0 - t;\r\n    return oneMinusT + b * t;\r\n}\r\n\r\n#ifdef EMISSION \r\n\tvec3 emission(vec2 uv)\r\n\t{\r\n\t\t#ifdef EMISSIONTEXTURE\r\n\t\t\treturn texture2D(u_EmissionTexture, uv).rgb * u_EmissionColor.rgb;\r\n\t\t#else\r\n\t\t\treturn u_EmissionColor.rgb;\r\n\t\t#endif\r\n\t}\r\n#endif\r\n\r\nmediump float getAlpha(vec2 uv)\r\n{\r\n\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\treturn u_AlbedoColor.a;\r\n\t#else\r\n\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\treturn texture2D(u_AlbedoTexture, uv).a * u_AlbedoColor.a;\r\n\t\t#else\r\n\t\t\treturn u_AlbedoColor.a;\r\n\t\t#endif\r\n\t#endif\r\n}\r\n\r\nmediump float getOcclusion(vec2 uv)\r\n{\r\n\t#ifdef OCCLUSIONTEXTURE\r\n\t\tmediump float occ = texture2D(u_OcclusionTexture, uv).g;\r\n\t\treturn lerpOneTo(occ, u_occlusionStrength);\r\n\t#else\r\n\t\treturn 1.0;\r\n\t#endif\r\n}\r\n\r\nmediump vec3 albedo(vec2 uv)\r\n{\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\treturn u_AlbedoColor.rgb * texture2D(u_AlbedoTexture, uv).rgb;\r\n\t#else\r\n\t\treturn u_AlbedoColor.rgb;\r\n\t#endif\r\n\t//TODO:Detail Texture\r\n}\r\n\r\nmediump vec2 getMetallicGloss(vec2 uv)\r\n{\r\n\tmediump vec2 ms;//x is metallic,y is smoothness\r\n\t#ifdef METALLICGLOSSTEXTURE\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tms.x = texture2D(u_MetallicGlossTexture, uv).r;\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tms.y = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tms = texture2D(u_MetallicGlossTexture, uv).ra;\r\n\t\t\tms.y *= u_SmoothnessScale;\r\n\t\t#endif\r\n\t#else\r\n\t\tms.x = u_Metallic;\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tms.y = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tms.y = u_Smoothness;\r\n\t\t#endif\r\n\t#endif\r\n\treturn ms;\r\n}\r\n\r\nmediump vec4 specularGloss(vec2 uv)\r\n{\r\n\tmediump vec4 sg;\r\n\t#ifdef SPECULARGLOSSTEXTURE\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tsg.rgb = texture2D(u_SpecGlossTexture, uv).rgb;\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tsg.a = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tsg = texture2D(u_SpecGlossTexture, uv);\r\n\t\t\tsg.a *= u_SmoothnessScale;\r\n\t\t#endif\r\n\t#else\r\n\t\tsg.rgb = u_SpecularColor.rgb;\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tsg.a = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tsg.a = u_Smoothness;\r\n\t\t#endif\r\n\t#endif\r\n\t\treturn sg;\r\n}\r\n\r\n\r\n#ifdef NORMALTEXTURE\r\n\tmediump vec3 unpackScaleNormal(mediump vec3 packednormal, mediump float bumpScale)\r\n\t{\r\n\t\tmediump vec3 normal = packednormal.xyz * 2.0 - 1.0;\r\n\t\tnormal.y=-normal.y;//NOTE:because unity to LayaAir coordSystem.\r\n\t\tnormal.xy *= bumpScale;\r\n\t\treturn normal;\r\n\t}\r\n\t\r\n\tmediump vec3 normalInTangentSpace(vec2 texcoords)\r\n\t{\r\n\t\tmediump vec3 normalTangent = unpackScaleNormal(texture2D(u_NormalTexture, texcoords).rgb,u_NormalScale);\r\n\t\treturn normalTangent;\r\n\t}\r\n#endif\r\n\r\n#ifdef PARALLAXTEXTURE\r\n\tmediump vec2 parallaxOffset1Step(mediump float h, mediump float height, mediump vec3 viewDir)\r\n\t{\r\n\t\th = h * height - height / 2.0;\r\n\t\tviewDir.z += 0.42;\r\n\t\treturn h * (viewDir.xy / viewDir.z);\r\n\t}\r\n\r\n\tvec2 parallax(vec2 texcoords, mediump vec3 viewDir)\r\n\t{\r\n\t\tmediump float h = texture2D(u_ParallaxTexture, texcoords.xy).g;\r\n\t\tvec2 offset = parallaxOffset1Step(h, u_ParallaxScale, viewDir);\r\n\t\treturn texcoords+offset;\r\n\t}\r\n#endif\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"),Ae.addInclude("LayaPBRBRDF.glsl",'// allow to explicitly override LAYA_BRDF_GI and LAYA_BRDF_LIGHT in custom shader,default is layaBRDFHighGI and layaBRDFHighLight\r\n#if !defined (LAYA_BRDF_GI) \r\n\t#if defined(LAYA_PBR_BRDF_LOW)\r\n\t\t#define LAYA_BRDF_GI layaBRDFLowGI\r\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\r\n\t\t#define LAYA_BRDF_GI layaBRDFHighGI\r\n\t#endif\r\n#endif\r\n#if !defined (LAYA_BRDF_LIGHT)\r\n\t#if defined(LAYA_PBR_BRDF_LOW)\r\n\t\t#define LAYA_BRDF_LIGHT layaBRDFLowLight\r\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\r\n\t\t#define LAYA_BRDF_LIGHT layaBRDFHighLight\r\n\t#endif\r\n#endif\r\n\r\n#define PI 3.14159265359\r\n#define INV_PI 0.31830988618\r\n\r\nmediump float pow4(mediump float x)\r\n{\r\n\treturn x * x * x * x;\r\n}\r\n\r\nmediump float pow5(mediump float x)\r\n{\r\n\treturn x * x * x * x * x;\r\n}\r\n\r\nmediump vec3 fresnelLerp(mediump vec3 F0,mediump vec3 F90,mediump float cosA)\r\n{\r\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\r\n\treturn mix(F0, F90, t);\r\n}\r\n\r\nmediump vec3 fresnelTerm(mediump vec3 F0,mediump float cosA)\r\n{\r\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\r\n\treturn F0 + (vec3(1.0) - F0) * t;\r\n}\r\n\r\n// approximage Schlick with ^4 instead of ^5\r\nmediump vec3 fresnelLerpFast (mediump vec3 F0, mediump vec3 F90,mediump float cosA)\r\n{\r\n    mediump float t = pow4 (1.0 - cosA);\r\n    return mix (F0, F90, t);\r\n}\r\n\r\nfloat smoothnessToPerceptualRoughness(float smoothness)\r\n{\r\n    return 1.0 - smoothness;\r\n}\r\n\r\nfloat perceptualRoughnessToRoughness(float perceptualRoughness)\r\n{\r\n    return perceptualRoughness * perceptualRoughness;\r\n}\r\n\r\nvec3 safeNormalize(vec3 inVec)\r\n{\r\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\r\n\treturn inVec * inversesqrt(dp3);\r\n}\r\n\r\n// Note: Disney diffuse must be multiply by diffuseAlbedo / PI. This is done outside of this function.\r\nmediump float disneyDiffuse(mediump float NdotV,mediump float NdotL,mediump float LdotH,mediump float perceptualRoughness)\r\n{\r\n\t//https://www.cnblogs.com/herenzhiming/articles/5790389.html\r\n\tmediump float fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\r\n\t// Two schlick fresnel term\r\n\tmediump float lightScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotL));\r\n\tmediump float viewScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotV));\r\n\r\n\treturn lightScatter * viewScatter;\r\n}\r\n\r\n// Ref: http://jcgt.org/published/0003/02/03/paper.pdf\r\nfloat smithJointGGXVisibilityTerm(float NdotL, float NdotV, float roughness)\r\n{\r\n\t// Original formulation:\r\n    // lambda_v    = (-1 + sqrt(a2 * (1 - NdotL2) / NdotL2 + 1)) * 0.5f;\r\n    // lambda_l    = (-1 + sqrt(a2 * (1 - NdotV2) / NdotV2 + 1)) * 0.5f;\r\n    // G           = 1 / (1 + lambda_v + lambda_l);\r\n\r\n\t// scientific code implement:\r\n\t// Reorder code to be more optimal\r\n    // half a          = roughness;\r\n    // half a2         = a * a;\r\n\r\n    // half lambdaV    = NdotL * sqrt((-NdotV * a2 + NdotV) * NdotV + a2);\r\n    // half lambdaL    = NdotV * sqrt((-NdotL * a2 + NdotL) * NdotL + a2);\r\n\r\n    // Simplify visibility term: (2.0f * NdotL * NdotV) /  ((4.0f * NdotL * NdotV) * (lambda_v + lambda_l + 1e-5f));\r\n    // return 0.5f / (lambdaV + lambdaL + 1e-5f);  \r\n\t// This function is not intended to be running on Mobile,therefore epsilon is smaller than can be represented by half\r\n\r\n\t// Approximation of the above formulation (simplify the sqrt, not mathematically correct but close enough)\r\n\tfloat a = roughness;\r\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\r\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\r\n\treturn 0.5 / (lambdaV + lambdaL + 1e-5);\r\n}\r\n\r\nfloat ggxTerm(float NdotH, float roughness)\r\n{\r\n\tfloat a2 = roughness * roughness;\r\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0; // 2 mad\r\n\treturn INV_PI * a2 / (d * d + 1e-7); // This function is not intended to be running on Mobile,therefore epsilon is smaller than what can be represented by half//half\r\n}\r\n\r\n// BRDF1-------------------------------------------------------------------------------------\r\n\r\n// Note: BRDF entry points use smoothness and oneMinusReflectivity for optimization purposes,\r\n// mostly for DX9 SM2.0 level. Most of the math is being done on these (1-x) values, and that saves a few precious ALU slots.\r\n\r\n// Main Physically Based BRDF\r\n// Derived from Disney work and based on Torrance-Sparrow micro-facet model\r\n//\r\n// BRDF = kD / pi + kS * (D * V * F) / 4\r\n// I = BRDF * NdotL\r\n//\r\n// *NDF GGX:\r\n// *Smith for Visiblity term\r\n// *Schlick approximation for Fresnel\r\nmediump vec4 layaBRDFHighLight(mediump vec3 diffColor, mediump vec3 specColor, mediump float oneMinusReflectivity, float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaLight light)\r\n{\r\n\tvec3 halfDir = safeNormalize(viewDir-light.dir);\r\n\r\n\tfloat nl = clamp(dot(normal, -light.dir),0.0,1.0);\r\n\tfloat nh = clamp(dot(normal, halfDir),0.0,1.0);\r\n\tmediump float lv = clamp(dot(light.dir, viewDir),0.0,1.0);\r\n\tmediump float lh = clamp(dot(light.dir, -halfDir),0.0,1.0);\r\n\r\n\t// Diffuse term\r\n\tmediump float diffuseTerm = disneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\r\n\r\n\t// Specular term\r\n    // HACK: theoretically we should divide diffuseTerm by Pi and not multiply specularTerm!\r\n    // BUT that will make shader look significantly darker than Legacy ones\r\n\r\n\t// GGX with roughtness to 0 would mean no specular at all, using max(roughness, 0.002) here to match HDrenderloop roughtness remapping.\r\n\troughness = max(roughness, 0.002);\r\n\tfloat V = smithJointGGXVisibilityTerm(nl, nv, roughness);\r\n\tfloat D = ggxTerm(nh, roughness);\r\n\r\n\tfloat specularTerm = V * D * PI; // Torrance-Sparrow model, Fresnel is applied later\r\n\r\n\t//#ifdef LAYA_COLORSPACE_GAMMA\r\n\tspecularTerm = sqrt(max(1e-4, specularTerm));\r\n\t//#endif\r\n\tspecularTerm = max(0.0, specularTerm * nl);\r\n\t\t\r\n\tmediump vec3 color = diffColor * light.color * diffuseTerm + specularTerm * light.color * fresnelTerm(specColor, lh);\r\n\treturn vec4(color, 1.0);\r\n}\r\n\r\nvec4 layaBRDFHighGI(mediump vec3 diffColor,mediump vec3 specColor,mediump float oneMinusReflectivity,float smoothness ,float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaGI gi)\r\n{\r\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(roughness^2+1)\r\n\tfloat surfaceReduction;\r\n\tsurfaceReduction = 1.0 - 0.28*roughness*perceptualRoughness;// 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\r\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity),0.0,1.0);\r\n\tmediump vec3 color =diffColor * gi.diffuse + surfaceReduction * gi.specular * fresnelLerp(specColor,vec3(grazingTerm), nv);\r\n\treturn vec4(color,1.0);\r\n}\r\n// BRDF1-------------------------------------------------------------------------------------\r\n\r\n\r\n// BRDF2-------------------------------------------------------------------------------------\r\n// Based on Minimalist CookTorrance BRDF\r\n// Implementation is slightly different from original derivation: http://www.thetenthplanet.de/archives/255\r\n//\r\n// *NDF [Modified] GGX:\r\n// *Modified Kelemen and Szirmay-Kalos for Visibility term\r\n// *Fresnel approximated with 1/LdotH\r\nmediump vec4 layaBRDFLowLight (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaLight light)\r\n{\r\n    vec3 halfDir = safeNormalize (viewDir-light.dir);\r\n    mediump float nl = clamp(dot(normal, -light.dir),0.0,1.0);\r\n    float nh = clamp(dot(normal, halfDir),0.0,1.0);\r\n    float lh = clamp(dot(-light.dir, halfDir),0.0,1.0);\r\n\r\n    // GGX Distribution multiplied by combined approximation of Visibility and Fresnel\r\n    // See "Optimizing PBR for Mobile" from Siggraph 2015 moving mobile graphics course\r\n    // https://community.arm.com/events/1155\r\n    mediump float a = roughness;\r\n    float a2 = a*a;\r\n\r\n    float d = nh * nh * (a2 - 1.0) + 1.00001;\r\n\t// #ifdef LAYA_COLORSPACE_GAMMA\r\n\t\t// Tighter approximation for Gamma only rendering mode!\r\n\t\t// DVF = sqrt(DVF);\r\n\t\t// DVF = (a * sqrt(.25)) / (max(sqrt(0.1), lh)*sqrt(roughness + .5) * d);\r\n\t\tfloat specularTerm = a / (max(0.32, lh) * (1.5 + roughness) * d);\r\n\t// #else\r\n\t// \tfloat specularTerm = a2 / (max(0.1f, lh*lh) * (roughness + 0.5f) * (d * d) * 4);\r\n\t// #endif\r\n\r\n    // on mobiles (where half actually means something) denominator have risk of overflow\r\n    // clamp below was added specifically to "fix" that, but dx compiler (we convert bytecode to metal/gles)\r\n    // sees that specularTerm have only non-negative terms, so it skips max(0,..) in clamp (leaving only min(100,...))\r\n\r\n\t//#if defined (SHADER_API_MOBILE)\r\n    specularTerm = specularTerm - 1e-4;\r\n\t//#endif\r\n\r\n\t// #else\r\n\t\t// // Legacy\r\n\t\t// half specularPower = PerceptualRoughnessToSpecPower(perceptualRoughness);\r\n\t\t// // Modified with approximate Visibility function that takes roughness into account\r\n\t\t// // Original ((n+1)*N.H^n) / (8*Pi * L.H^3) didn\'t take into account roughness\r\n\t\t// // and produced extremely bright specular at grazing angles\r\n\r\n\t\t// half invV = lh * lh * smoothness + perceptualRoughness * perceptualRoughness; // approx ModifiedKelemenVisibilityTerm(lh, perceptualRoughness);\r\n\t\t// half invF = lh;\r\n\r\n\t\t// half specularTerm = ((specularPower + 1) * pow (nh, specularPower)) / (8 * invV * invF + 1e-4h);\r\n\r\n\t\t// #ifdef LAYA_COLORSPACE_GAMMA\r\n\t\t// \tspecularTerm = sqrt(max(1e-4f, specularTerm));\r\n\t\t// #endif\r\n\t// #endif\r\n\r\n\t// #if defined (SHADER_API_MOBILE)\r\n\t\tspecularTerm = clamp(specularTerm, 0.0, 100.0); // Prevent FP16 overflow on mobiles\r\n\t// #endif\r\n    \r\n    mediump vec3 color = (diffColor + specularTerm * specColor) * light.color * nl;\r\n\r\n    return vec4(color, 1.0);\r\n}\r\n\r\nmediump vec4 layaBRDFLowGI (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,mediump float smoothness,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaGI gi)\r\n{\r\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(realRoughness^2+1)\r\n\r\n    // 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\r\n    // 1-x^3*(0.6-0.08*x)   approximation for 1/(x^4+1)\r\n\t// #ifdef LAYA_COLORSPACE_GAMMA\r\n\t\tmediump float surfaceReduction = 0.28;\r\n\t// #else\r\n\t\t// mediump float surfaceReduction = (0.6-0.08*perceptualRoughness);\r\n\t// #endif\r\n\r\n    surfaceReduction = 1.0 - roughness*perceptualRoughness*surfaceReduction;\r\n\r\n\tmediump float grazingTerm = clamp(smoothness + (1.0-oneMinusReflectivity),0.0,1.0);\r\n\tmediump vec3 color =gi.diffuse * diffColor+ surfaceReduction * gi.specular * fresnelLerpFast (specColor, vec3(grazingTerm), nv);\r\n\r\n    return vec4(color, 1.0);\r\n}\r\n// BRDF2-------------------------------------------------------------------------------------'),Ae.addInclude("PBRCore.glsl","struct FragmentCommonData{\r\n\tvec3 diffColor;\r\n\tvec3 specColor;\r\n\tfloat oneMinusReflectivity;\r\n\tfloat smoothness;\r\n\t//vec3 eyeVec;TODO:maybe can remove\r\n\t//float alpha;\r\n\t//vec3 reflUVW;\r\n};\r\n\r\n#ifndef SETUP_BRDF_INPUT\r\n    #define SETUP_BRDF_INPUT metallicSetup//default is metallicSetup,also can be other. \r\n#endif\r\n\r\nconst mediump vec4 dielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\r\n\r\nmediump vec3 diffuseAndSpecularFromMetallic(mediump vec3 albedo,mediump float metallic, out mediump vec3 specColor, out mediump float oneMinusReflectivity)\r\n{\r\n\tspecColor = mix(dielectricSpecularColor.rgb, albedo, metallic);\r\n\toneMinusReflectivity= dielectricSpecularColor.a*(1.0-metallic);//diffuse proportion\r\n\treturn albedo * oneMinusReflectivity;\r\n}\r\n\r\nmediump float specularStrength(mediump vec3 specular)\r\n{\r\n    return max (max (specular.r, specular.g), specular.b);\r\n}\r\n\r\n// Diffuse/Spec Energy conservation\r\nmediump vec3 energyConservationBetweenDiffuseAndSpecular (mediump vec3 albedo, mediump vec3 specColor, out mediump float oneMinusReflectivity)\r\n{\r\n\toneMinusReflectivity = 1.0 - specularStrength(specColor);\r\n    return albedo * (vec3(1.0) - specColor);\r\n}\r\n\r\n#ifdef TRANSPARENTBLEND\r\n\tmediump vec3 preMultiplyAlpha (mediump vec3 diffColor, mediump float alpha, mediump float oneMinusReflectivity,out mediump float modifiedAlpha)\r\n\t{\r\n\t\t// Transparency 'removes' from Diffuse component\r\n\t\tdiffColor *= alpha;\r\n\t\t// Reflectivity 'removes' from the rest of components, including Transparency\r\n\t\t// modifiedAlpha = 1.0-(1.0-alpha)*(1.0-reflectivity) = 1.0-(oneMinusReflectivity - alpha*oneMinusReflectivity) = 1.0-oneMinusReflectivity + alpha*oneMinusReflectivity\r\n\t\tmodifiedAlpha = 1.0 - oneMinusReflectivity + alpha*oneMinusReflectivity;\r\n\t\treturn diffColor;\r\n\t}\r\n#endif\r\n\r\nFragmentCommonData metallicSetup(vec2 uv)\r\n{\r\n\tmediump vec2 metallicGloss = getMetallicGloss(uv);\r\n\tmediump float metallic = metallicGloss.x;\r\n\tmediump float smoothness = metallicGloss.y; // this is 1 minus the square root of real roughness m.\r\n\tmediump float oneMinusReflectivity;\r\n\tmediump vec3 specColor;\r\n\tmediump vec3 diffColor = diffuseAndSpecularFromMetallic(albedo(uv), metallic,/*out*/specColor,/*out*/oneMinusReflectivity);\r\n\r\n\tFragmentCommonData o;\r\n\to.diffColor = diffColor;\r\n\to.specColor = specColor;\r\n\to.oneMinusReflectivity = oneMinusReflectivity;\r\n\to.smoothness = smoothness;\r\n\treturn o;\r\n}\r\n\r\nFragmentCommonData specularSetup(vec2 uv)\r\n{\r\n    mediump vec4 specGloss = specularGloss(uv);\r\n    mediump vec3 specColor = specGloss.rgb;\r\n    mediump float smoothness = specGloss.a;\r\n\r\n    mediump float oneMinusReflectivity;\r\n    mediump vec3 diffColor = energyConservationBetweenDiffuseAndSpecular (albedo(uv), specColor, /*out*/ oneMinusReflectivity);\r\n\r\n    FragmentCommonData o;\r\n    o.diffColor = diffColor;\r\n    o.specColor = specColor;\r\n    o.oneMinusReflectivity = oneMinusReflectivity;\r\n    o.smoothness = smoothness;\r\n    return o;\r\n}\r\n\r\nLayaGI fragmentGI(float smoothness,vec3 eyeVec,mediump float occlusion,mediump vec2 lightmapUV,vec3 worldnormal)\r\n{\r\n\tLayaGIInput giInput;\r\n\t#ifdef LIGHTMAP\r\n\t\tgiInput.lightmapUV=lightmapUV;\r\n\t#endif\r\n\r\n\tvec3 worldViewDir = -eyeVec;\r\n\tmediump vec4 uvwRoughness;\r\n\tuvwRoughness.rgb = reflect(worldViewDir, worldnormal);//reflectUVW\r\n\tuvwRoughness.a= smoothnessToPerceptualRoughness(smoothness);//perceptualRoughness\r\n\r\n\treturn layaGlobalIllumination(giInput,occlusion, worldnormal, uvwRoughness);\r\n}\r\n\r\n\r\nvec3 perPixelWorldNormal(vec2 uv,vec3 normal,vec3 binormal,vec3 tangent)\r\n{\r\n\t#ifdef NORMALTEXTURE\r\n\t\tmediump vec3 normalTangent=normalInTangentSpace(uv);\r\n\t\tvec3 normalWorld = normalize(tangent * normalTangent.x + binormal * normalTangent.y + normal * normalTangent.z);\r\n\t#else\r\n\t\tvec3 normalWorld = normalize(normal);\r\n\t#endif\r\n\t\treturn normalWorld;\r\n}\r\n\r\nvoid fragmentForward()\r\n{\r\n\tvec2 uv;\r\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\r\n\t\t#ifdef PARALLAXTEXTURE\r\n\t\t\tuv = parallax(v_Texcoord0,normalize(v_ViewDirForParallax));\r\n\t\t#else\r\n\t\t\tuv = v_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tmediump float alpha = getAlpha(uv);\r\n\t#ifdef ALPHATEST\r\n\t\tif(alpha<u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n\r\n\tFragmentCommonData o = SETUP_BRDF_INPUT(uv);\r\n\t\r\n\tvec3 binormal;\r\n\tvec3 tangent;\r\n\t#ifdef NORMALTEXTURE\r\n\t\ttangent = v_Tangent;\r\n\t\tbinormal = v_Binormal;\r\n\t#endif\r\n\r\n\tvec3 normal = v_Normal;\r\n\tvec3 normalWorld = perPixelWorldNormal(uv,normal,binormal,tangent);//In FS if the normal use mediump before normalize will cause precision prolem in mobile device.\r\n\tvec3 eyeVec = normalize(v_EyeVec);\r\n\tvec3 posworld = v_PositionWorld;\r\n\r\n\t#ifdef TRANSPARENTBLEND\r\n\t\to.diffColor=preMultiplyAlpha(o.diffColor,alpha,o.oneMinusReflectivity,/*out*/alpha);// shader relies on pre-multiply alpha-blend (srcBlend = One, dstBlend = OneMinusSrcAlpha)\r\n\t#endif\r\n\r\n\tmediump float occlusion = getOcclusion(uv);\r\n\tmediump vec2 lightMapUV;\r\n\t#ifdef LIGHTMAP\r\n\t\tlightMapUV=v_LightMapUV;\r\n\t#endif\r\n\tfloat perceptualRoughness = smoothnessToPerceptualRoughness(o.smoothness);\r\n\tfloat roughness = perceptualRoughnessToRoughness(perceptualRoughness);\r\n\tfloat nv = abs(dot(normalWorld, eyeVec));\r\n\tLayaGI gi =fragmentGI(o.smoothness,eyeVec,occlusion,lightMapUV,normalWorld);\r\n\tvec4 color = LAYA_BRDF_GI(o.diffColor,o.specColor,o.oneMinusReflectivity,o.smoothness,perceptualRoughness,roughness,nv,normalWorld,eyeVec,gi);\r\n\t\r\n\tfloat shadowAttenuation = 1.0;\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t#else\r\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t#endif\r\n\t\t\t\tshadowAttenuation=sampleShadowmap(shadowCoord);\r\n\t\t\t#endif\r\n\t\t\tLayaLight dirLight = layaDirectionLightToLight(u_DirectionLight,shadowAttenuation);\r\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tshadowAttenuation = 1.0;\r\n\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,u_PointLight,shadowAttenuation);\r\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\r\n\t\t#endif\r\n\t\t\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\tshadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t#endif\r\n\t\t    LayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,u_SpotLight,shadowAttenuation);\r\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\r\n\t\t#endif\r\n\t#else\r\n\t \t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\tshadowAttenuation *= sampleShadowmap(shadowCoord);\r\n\t\t\t\t\t}\r\n\t\t\t\t#endif\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tLayaLight dirLight = layaDirectionLightToLight(directionLight,shadowAttenuation);\r\n\t\t\t \tcolor+=LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\r\n\t\t\t}\r\n\t \t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,pointLight,shadowAttenuation);\r\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\t\t\t\tshadowAttenuation= sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,spotLight,shadowAttenuation);\r\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t #endif\r\n\r\n\t#ifdef EMISSION\r\n\t\tcolor.rgb += emission(uv);\r\n\t#endif\r\n\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\tcolor.rgb=mix(color.rgb,u_FogColor,lerpFact);\r\n\t#endif\r\n\t\r\n\tgl_FragColor=vec4(color.rgb,alpha);\r\n}\r\n\r\n\r\n"),Ae.addInclude("PBRVertex.glsl","vec2 transformLightMapUV(in vec2 texcoord,in vec4 lightmapScaleOffset)\r\n{\r\n\tvec2 lightMapUV=vec2(texcoord.x,1.0-texcoord.y)*lightmapScaleOffset.xy+lightmapScaleOffset.zw;\r\n\tlightMapUV.y=1.0-lightMapUV.y;\r\n\treturn lightMapUV; \r\n}\r\n\r\nvoid vertexForward()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\r\n\tmat4 worldMat;\r\n\t#ifdef GPU_INSTANCE\r\n\t\tworldMat = a_WorldMat;\r\n\t#else\r\n\t\tworldMat = u_WorldMat;\r\n\t#endif\r\n\r\n\tv_PositionWorld=(worldMat*position).xyz;\r\n\r\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\r\n\t\t#ifdef TILINGOFFSET\r\n\t\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t\t#else\r\n\t\t\tv_Texcoord0=a_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tv_EyeVec =u_CameraPos-v_PositionWorld;//will normalize per-pixel\r\n\r\n\t#ifdef LIGHTMAP\r\n\t\tvec2 texcoord;\r\n\t\t#ifdef UV1\r\n\t\t\ttexcoord=a_Texcoord1;\r\n\t\t#else\r\n\t\t\ttexcoord=a_Texcoord0;\r\n\t\t#endif\r\n\t\tv_LightMapUV=transformLightMapUV(texcoord,u_LightmapScaleOffset);\r\n\t#endif\r\n\r\n\tmat3 worldInvMat;\r\n\t#ifdef BONE\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\r\n\t#else\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\r\n\t#endif\r\n\r\n\tv_Normal=normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem.\r\n\r\n\t#ifdef NORMALTEXTURE\r\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\r\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t#endif\r\n\r\n\t#ifdef PARALLAXTEXTURE\r\n\t\tvec3 binormal = cross(a_Normal, a_Tangent0.xyz)*a_Tangent0.w;\r\n\t\tmat3 objectTBN = mat3(a_Tangent0.xyz, binormal, a_Normal);\r\n\t\tv_ViewDirForParallax=(worldInvMat*u_CameraPos-position.xyz)*objectTBN;\r\n\t#endif\r\n\r\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t#endif\r\n\r\n\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(positionWS,1.0);\r\n\t#endif\r\n}");var e={a_Position:ht.MESH_POSITION0,a_Color:ht.MESH_COLOR0,a_Normal:ht.MESH_NORMAL0,a_Texcoord0:ht.MESH_TEXTURECOORDINATE0,a_Texcoord1:ht.MESH_TEXTURECOORDINATE1,a_BoneWeights:ht.MESH_BLENDWEIGHT0,a_BoneIndices:ht.MESH_BLENDINDICES0,a_Tangent0:ht.MESH_TANGENT0,a_MvpMatrix:ht.MESH_MVPMATRIX_ROW0,a_WorldMat:ht.MESH_WORLDMATRIX_ROW0},t={u_Bones:Ae.PERIOD_CUSTOM,u_DiffuseTexture:Ae.PERIOD_MATERIAL,u_SpecularTexture:Ae.PERIOD_MATERIAL,u_NormalTexture:Ae.PERIOD_MATERIAL,u_AlphaTestValue:Ae.PERIOD_MATERIAL,u_DiffuseColor:Ae.PERIOD_MATERIAL,u_MaterialSpecular:Ae.PERIOD_MATERIAL,u_Shininess:Ae.PERIOD_MATERIAL,u_TilingOffset:Ae.PERIOD_MATERIAL,u_WorldMat:Ae.PERIOD_SPRITE,u_MvpMatrix:Ae.PERIOD_SPRITE,u_LightmapScaleOffset:Ae.PERIOD_SPRITE,u_LightMap:Ae.PERIOD_SPRITE,u_LightMapDirection:Ae.PERIOD_SPRITE,u_CameraPos:Ae.PERIOD_CAMERA,u_Viewport:Ae.PERIOD_CAMERA,u_ProjectionParams:Ae.PERIOD_CAMERA,u_View:Ae.PERIOD_CAMERA,u_ViewProjection:Ae.PERIOD_CAMERA,u_ReflectTexture:Ae.PERIOD_SCENE,u_ReflectIntensity:Ae.PERIOD_SCENE,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE,u_DirationLightCount:Ae.PERIOD_SCENE,u_LightBuffer:Ae.PERIOD_SCENE,u_LightClusterBuffer:Ae.PERIOD_SCENE,u_AmbientColor:Ae.PERIOD_SCENE,u_ShadowBias:Ae.PERIOD_SCENE,u_ShadowLightDirection:Ae.PERIOD_SCENE,u_ShadowMap:Ae.PERIOD_SCENE,u_ShadowParams:Ae.PERIOD_SCENE,u_ShadowSplitSpheres:Ae.PERIOD_SCENE,u_ShadowMatrices:Ae.PERIOD_SCENE,u_ShadowMapSize:Ae.PERIOD_SCENE,u_SpotShadowMap:Ae.PERIOD_SCENE,u_SpotViewProjectMatrix:Ae.PERIOD_SCENE,u_ShadowLightPosition:Ae.PERIOD_SCENE,u_AmbientSHAr:Ae.PERIOD_SCENE,u_AmbientSHAg:Ae.PERIOD_SCENE,u_AmbientSHAb:Ae.PERIOD_SCENE,u_AmbientSHBr:Ae.PERIOD_SCENE,u_AmbientSHBg:Ae.PERIOD_SCENE,u_AmbientSHBb:Ae.PERIOD_SCENE,u_AmbientSHC:Ae.PERIOD_SCENE,"u_DirectionLight.color":Ae.PERIOD_SCENE,"u_DirectionLight.direction":Ae.PERIOD_SCENE,"u_PointLight.position":Ae.PERIOD_SCENE,"u_PointLight.range":Ae.PERIOD_SCENE,"u_PointLight.color":Ae.PERIOD_SCENE,"u_SpotLight.position":Ae.PERIOD_SCENE,"u_SpotLight.direction":Ae.PERIOD_SCENE,"u_SpotLight.range":Ae.PERIOD_SCENE,"u_SpotLight.spot":Ae.PERIOD_SCENE,"u_SpotLight.color":Ae.PERIOD_SCENE},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("BLINNPHONG",null,null,!0),n=new pr(e,t);i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n#include "Shadow.glsl";\r\n\r\nattribute vec4 a_Position;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#if defined(LIGHTMAP)&&defined(UV1)\r\n\tattribute vec2 a_Texcoord1;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tattribute vec4 a_Color;\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nattribute vec3 a_Normal;\r\nvarying vec3 v_Normal; \r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\tuniform vec3 u_CameraPos;\r\n\tvarying vec3 v_ViewDir; \r\n#endif\r\n\r\n#if defined(NORMALMAP)\r\n\tattribute vec4 a_Tangent0;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\tmat4 worldMat;\r\n\t#ifdef GPU_INSTANCE\r\n\t\tworldMat = a_WorldMat;\r\n\t#else\r\n\t\tworldMat = u_WorldMat;\r\n\t#endif\r\n\r\n\tmat3 worldInvMat;\r\n\t#ifdef BONE\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\r\n\t#else\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\r\n\t#endif  \r\n\tv_Normal=normalize(a_Normal*worldInvMat);\r\n\t#if defined(NORMALMAP)\r\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\r\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\t\tvec3 positionWS=(worldMat*position).xyz;\r\n\t\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tv_ViewDir = u_CameraPos-positionWS;\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\t\t\tv_PositionWorld = positionWS;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n\t\t#ifdef TILINGOFFSET\r\n\t\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t\t#else\r\n\t\t\tv_Texcoord0=a_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LIGHTMAP\r\n\t\t#ifdef UV1\r\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\r\n\t\t#else\r\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\r\n\t\t#endif \r\n\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\r\n\t#endif\r\n\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tv_Color=a_Color;\r\n\t#endif\r\n\r\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\t\tv_ShadowCoord =getShadowCoord(vec4(positionWS,1.0));\r\n\t#endif\r\n\r\n\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(positionWS,1.0);\r\n\t#endif\r\n\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n\r\nuniform vec4 u_DiffuseColor;\r\n\r\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\n#ifdef DIFFUSEMAP\r\n\tuniform sampler2D u_DiffuseTexture;\r\n#endif\r\n\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform sampler2D u_LightMap;\r\n#endif\r\n\r\nvarying vec3 v_Normal;\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\tvarying vec3 v_ViewDir; \r\n\r\n\tuniform vec3 u_MaterialSpecular;\r\n\tuniform float u_Shininess;\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n\r\n\t#ifdef SPECULARMAP \r\n\t\tuniform sampler2D u_SpecularTexture;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef NORMALMAP \r\n\tuniform sampler2D u_NormalTexture;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n\r\n#include "GlobalIllumination.glsl";//"GlobalIllumination.glsl use uniform should at front of this\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\n\r\nvoid main()\r\n{\r\n\tvec3 normal;//light and SH maybe use normal\r\n\t#if defined(NORMALMAP)\r\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\r\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\r\n\t#else\r\n\t\tnormal = normalize(v_Normal);\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 viewDir= normalize(v_ViewDir);\r\n\t#endif\r\n\r\n\tLayaGIInput giInput;\r\n\t#ifdef LIGHTMAP\t\r\n\t\tgiInput.lightmapUV=v_LightMapUV;\r\n\t#endif\r\n\tvec3 globalDiffuse=layaGIBase(giInput,1.0,normal);\r\n\t\r\n\tvec4 mainColor=u_DiffuseColor;\r\n\t#ifdef DIFFUSEMAP\r\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\r\n\t\tmainColor=mainColor*difTexColor;\r\n\t#endif \r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tmainColor=mainColor*v_Color;\r\n\t#endif \r\n    \r\n\t#ifdef ALPHATEST\r\n\t\tif(mainColor.a<u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n  \r\n\t\r\n\tvec3 diffuse = vec3(0.0);\r\n\tvec3 specular= vec3(0.0);\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 dif,spe;\r\n\t\t#ifdef SPECULARMAP\r\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\r\n\t\t#else\r\n\t\t\t#ifdef DIFFUSEMAP\r\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\r\n\t\t\t#else\r\n\t\t\t\tvec3 gloss=vec3(1.0);\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t\r\n\t\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\r\n\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t#else\r\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t#endif\r\n\t\t\t\tfloat shadowAttenuation=sampleShadowmap(shadowCoord);\r\n\t\t\t\tdif *= shadowAttenuation;\r\n\t\t\t\tspe *= shadowAttenuation;\r\n\t\t\t#endif\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\r\n\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\tfloat spotShadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t\tdif *= shadowAttenuation;\r\n\t\t\t\tspe *= shadowAttenuation;\r\n\t\t\t#endif\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\tdirectionLight.color *= sampleShadowmap(shadowCoord);\r\n\t\t\t\t\t}\r\n\t\t\t\t#endif\r\n\t\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,directionLight,dif,spe);\r\n\t\t\t\tdiffuse+=dif;\r\n\t\t\t\tspecular+=spe;\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,pointLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\t\t\t\tspotLight.color *= sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,spotLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tgl_FragColor.rgb+=specular;\r\n\t#endif\r\n\t  \r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n\t#endif\r\n}\r\n\r\n',r,"Forward");n.addShaderPass('#include "ShadowCasterVS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionCS =  shadowCasterVertex();\r\n\tgl_Position=remapGLPositionZ(positionCS);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "ShadowCasterFS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tgl_FragColor=shadowCasterFragment();\r\n}',r,"ShadowCaster");e={a_Position:ht.MESH_POSITION0,a_Color:ht.MESH_COLOR0},t={u_MvpMatrix:Ae.PERIOD_SPRITE,u_Color:Ae.PERIOD_MATERIAL},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("LineShader"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nuniform mat4 u_MvpMatrix;\r\nuniform vec4 u_Color;\r\nattribute vec4 a_Color;\r\nvarying vec4 v_Color;\r\n\r\n\r\nvoid main()\r\n{\r\n\tgl_Position = u_MvpMatrix * a_Position;\r\n\tv_Color=a_Color*u_Color;\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nuniform vec4 u_Color;\r\n\r\nvoid main()\r\n{\r\n  gl_FragColor = v_Color * u_Color; \r\n}\r\n\r\n",r),e={a_Position:ht.MESH_POSITION0,a_Color:ht.MESH_COLOR0,a_Texcoord0:ht.MESH_TEXTURECOORDINATE0,a_BoneWeights:ht.MESH_BLENDWEIGHT0,a_BoneIndices:ht.MESH_BLENDINDICES0,a_MvpMatrix:ht.MESH_MVPMATRIX_ROW0},t={u_Bones:Ae.PERIOD_CUSTOM,u_AlbedoTexture:Ae.PERIOD_MATERIAL,u_AlbedoColor:Ae.PERIOD_MATERIAL,u_TilingOffset:Ae.PERIOD_MATERIAL,u_AlphaTestValue:Ae.PERIOD_MATERIAL,u_MvpMatrix:Ae.PERIOD_SPRITE,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("Unlit",null,null,!0),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\n\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\nattribute vec4 a_Color;\r\nvarying vec4 v_Color;\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main() {\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tv_Color = a_Color;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 color =  u_AlbedoColor;\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\r\n\t#endif\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tcolor *= v_Color;\r\n\t#endif\r\n\t\r\n\t#ifdef ALPHATEST\r\n\t\tif(color.a < u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n\t\r\n\tgl_FragColor = color;\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n}\r\n\r\n",r),e={a_Position:ht.MESH_POSITION0,a_Texcoord0:ht.MESH_TEXTURECOORDINATE0,a_BoneWeights:ht.MESH_BLENDWEIGHT0,a_BoneIndices:ht.MESH_BLENDINDICES0,a_MvpMatrix:ht.MESH_MVPMATRIX_ROW0},t={u_Bones:Ae.PERIOD_CUSTOM,u_AlbedoTexture:Ae.PERIOD_MATERIAL,u_AlbedoColor:Ae.PERIOD_MATERIAL,u_TilingOffset:Ae.PERIOD_MATERIAL,u_AlphaTestValue:Ae.PERIOD_MATERIAL,u_MvpMatrix:Ae.PERIOD_SPRITE,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("Effect",null,null,!0),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec4 a_Color;\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tvarying vec4 v_Color;\r\n#endif\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\t\t\r\n\t#ifdef COLOR\r\n\t\tv_Color = a_Color;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tvarying vec4 v_Color;\r\n#endif\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef MAINTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 color =  2.0 * u_AlbedoColor;\r\n\t#ifdef COLOR\r\n\t\tcolor *= v_Color;\r\n\t#endif\r\n\t#ifdef MAINTEXTURE\r\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\r\n\t#endif\r\n\t\r\n\tgl_FragColor = color;\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n}\r\n\r\n",r),e={a_CornerTextureCoordinate:ai.PARTICLE_CORNERTEXTURECOORDINATE0,a_MeshPosition:ai.PARTICLE_POSITION0,a_MeshColor:ai.PARTICLE_COLOR0,a_MeshTextureCoordinate:ai.PARTICLE_TEXTURECOORDINATE0,a_ShapePositionStartLifeTime:ai.PARTICLE_SHAPEPOSITIONSTARTLIFETIME,a_DirectionTime:ai.PARTICLE_DIRECTIONTIME,a_StartColor:ai.PARTICLE_STARTCOLOR0,a_EndColor:ai.PARTICLE_ENDCOLOR0,a_StartSize:ai.PARTICLE_STARTSIZE,a_StartRotation0:ai.PARTICLE_STARTROTATION,a_StartSpeed:ai.PARTICLE_STARTSPEED,a_Random0:ai.PARTICLE_RANDOM0,a_Random1:ai.PARTICLE_RANDOM1,a_SimulationWorldPostion:ai.PARTICLE_SIMULATIONWORLDPOSTION,a_SimulationWorldRotation:ai.PARTICLE_SIMULATIONWORLDROTATION},t={u_Tintcolor:Ae.PERIOD_MATERIAL,u_TilingOffset:Ae.PERIOD_MATERIAL,u_texture:Ae.PERIOD_MATERIAL,u_WorldPosition:Ae.PERIOD_SPRITE,u_WorldRotation:Ae.PERIOD_SPRITE,u_PositionScale:Ae.PERIOD_SPRITE,u_SizeScale:Ae.PERIOD_SPRITE,u_ScalingMode:Ae.PERIOD_SPRITE,u_Gravity:Ae.PERIOD_SPRITE,u_ThreeDStartRotation:Ae.PERIOD_SPRITE,u_StretchedBillboardLengthScale:Ae.PERIOD_SPRITE,u_StretchedBillboardSpeedScale:Ae.PERIOD_SPRITE,u_SimulationSpace:Ae.PERIOD_SPRITE,u_CurrentTime:Ae.PERIOD_SPRITE,u_ColorOverLifeGradientAlphas:Ae.PERIOD_SPRITE,u_ColorOverLifeGradientColors:Ae.PERIOD_SPRITE,u_MaxColorOverLifeGradientAlphas:Ae.PERIOD_SPRITE,u_MaxColorOverLifeGradientColors:Ae.PERIOD_SPRITE,u_VOLVelocityConst:Ae.PERIOD_SPRITE,u_VOLVelocityGradientX:Ae.PERIOD_SPRITE,u_VOLVelocityGradientY:Ae.PERIOD_SPRITE,u_VOLVelocityGradientZ:Ae.PERIOD_SPRITE,u_VOLVelocityConstMax:Ae.PERIOD_SPRITE,u_VOLVelocityGradientMaxX:Ae.PERIOD_SPRITE,u_VOLVelocityGradientMaxY:Ae.PERIOD_SPRITE,u_VOLVelocityGradientMaxZ:Ae.PERIOD_SPRITE,u_VOLSpaceType:Ae.PERIOD_SPRITE,u_SOLSizeGradient:Ae.PERIOD_SPRITE,u_SOLSizeGradientX:Ae.PERIOD_SPRITE,u_SOLSizeGradientY:Ae.PERIOD_SPRITE,u_SOLSizeGradientZ:Ae.PERIOD_SPRITE,u_SOLSizeGradientMax:Ae.PERIOD_SPRITE,u_SOLSizeGradientMaxX:Ae.PERIOD_SPRITE,u_SOLSizeGradientMaxY:Ae.PERIOD_SPRITE,u_SOLSizeGradientMaxZ:Ae.PERIOD_SPRITE,u_ROLAngularVelocityConst:Ae.PERIOD_SPRITE,u_ROLAngularVelocityConstSeprarate:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradient:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientX:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientY:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientZ:Ae.PERIOD_SPRITE,u_ROLAngularVelocityConstMax:Ae.PERIOD_SPRITE,u_ROLAngularVelocityConstMaxSeprarate:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientMax:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxX:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxY:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxZ:Ae.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxW:Ae.PERIOD_SPRITE,u_TSACycles:Ae.PERIOD_SPRITE,u_TSASubUVLength:Ae.PERIOD_SPRITE,u_TSAGradientUVs:Ae.PERIOD_SPRITE,u_TSAMaxGradientUVs:Ae.PERIOD_SPRITE,u_CameraPos:Ae.PERIOD_CAMERA,u_CameraDirection:Ae.PERIOD_CAMERA,u_CameraUp:Ae.PERIOD_CAMERA,u_View:Ae.PERIOD_CAMERA,u_Projection:Ae.PERIOD_CAMERA,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("PARTICLESHURIKEN"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\n#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n  precision highp float;\r\n#else\r\n  precision mediump float;\r\n#endif\r\n\r\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\r\n\tattribute vec4 a_CornerTextureCoordinate;\r\n#endif\r\n#ifdef RENDERMODE_MESH\r\n\tattribute vec3 a_MeshPosition;\r\n\tattribute vec4 a_MeshColor;\r\n\tattribute vec2 a_MeshTextureCoordinate;\r\n\tvarying vec4 v_MeshColor;\r\n#endif\r\n\r\nattribute vec4 a_ShapePositionStartLifeTime;\r\nattribute vec4 a_DirectionTime;\r\nattribute vec4 a_StartColor;\r\nattribute vec3 a_StartSize;\r\nattribute vec3 a_StartRotation0;\r\nattribute float a_StartSpeed;\r\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n  attribute vec4 a_Random0;\r\n#endif\r\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  attribute vec4 a_Random1;\r\n#endif\r\nattribute vec3 a_SimulationWorldPostion;\r\nattribute vec4 a_SimulationWorldRotation;\r\n\r\nvarying vec4 v_Color;\r\n#ifdef DIFFUSEMAP\r\n\tvarying vec2 v_TextureCoordinate;\r\n#endif\r\n\r\nuniform float u_CurrentTime;\r\nuniform vec3 u_Gravity;\r\n\r\nuniform vec3 u_WorldPosition;\r\nuniform vec4 u_WorldRotation;\r\nuniform bool u_ThreeDStartRotation;\r\nuniform int u_ScalingMode;\r\nuniform vec3 u_PositionScale;\r\nuniform vec3 u_SizeScale;\r\nuniform mat4 u_View;\r\nuniform mat4 u_Projection;\r\n\r\n#ifdef STRETCHEDBILLBOARD\r\n\tuniform vec3 u_CameraPos;\r\n#endif\r\nuniform vec3 u_CameraDirection;//TODO:\r\nuniform vec3 u_CameraUp;\r\n\r\nuniform  float u_StretchedBillboardLengthScale;\r\nuniform  float u_StretchedBillboardSpeedScale;\r\nuniform int u_SimulationSpace;\r\n\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  uniform  int  u_VOLSpaceType;\r\n#endif\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\r\n  uniform  vec3 u_VOLVelocityConst;\r\n#endif\r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  uniform  vec2 u_VOLVelocityGradientX[4];//xkey,y\r\n  uniform  vec2 u_VOLVelocityGradientY[4];//xkey,y\r\n  uniform  vec2 u_VOLVelocityGradientZ[4];//xkey,y\r\n#endif\r\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n  uniform  vec3 u_VOLVelocityConstMax;\r\n#endif\r\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//xkey,y\r\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//xkey,y\r\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//xkey,y\r\n#endif\r\n\r\n#ifdef COLOROVERLIFETIME\r\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//xkey,yzwColor\r\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//xkey,yAlpha\r\n#endif\r\n#ifdef RANDOMCOLOROVERLIFETIME\r\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//xkey,yzwColor\r\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//xkey,yAlpha\r\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//xkey,yzwColor\r\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//xkey,yAlpha\r\n#endif\r\n\r\n\r\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\r\n  uniform  vec2 u_SOLSizeGradient[4];//xkey,y\r\n#endif\r\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n  uniform  vec2 u_SOLSizeGradientMax[4];//xkey,y\r\n#endif\r\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\r\n  uniform  vec2 u_SOLSizeGradientX[4];//xkey,y\r\n  uniform  vec2 u_SOLSizeGradientY[4];//xkey,y\r\n  uniform  vec2 u_SOLSizeGradientZ[4];//xkey,y\r\n#endif\r\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//xkey,y\r\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//xkey,y\r\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//xkey,y\r\n#endif\r\n\r\n\r\n#ifdef ROTATIONOVERLIFETIME\r\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\r\n    uniform  float u_ROLAngularVelocityConst;\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n    uniform  float u_ROLAngularVelocityConstMax;\r\n  #endif\r\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//xkey,y\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//xkey,y\r\n  #endif\r\n#endif\r\n#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\r\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\r\n  #endif\r\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\r\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\r\n  #endif\r\n#endif\r\n\r\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\r\n  uniform  float u_TSACycles;\r\n  uniform  vec2 u_TSASubUVLength;\r\n  uniform  vec2 u_TSAGradientUVs[4];//xkey,yframe\r\n#endif\r\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\r\n  uniform  vec2 u_TSAMaxGradientUVs[4];//xkey,yframe\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\r\n{\r\n\tfloat halfRoll = rot.z * 0.5;\r\n    float halfPitch = rot.x * 0.5;\r\n\tfloat halfYaw = rot.y * 0.5;\r\n\r\n\tfloat sinRoll = sin(halfRoll);\r\n\tfloat cosRoll = cos(halfRoll);\r\n\tfloat sinPitch = sin(halfPitch);\r\n\tfloat cosPitch = cos(halfPitch);\r\n\tfloat sinYaw = sin(halfYaw);\r\n\tfloat cosYaw = cos(halfYaw);\r\n\r\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\r\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\r\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\r\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\r\n\t\r\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\r\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\r\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\r\n\t\r\n\tfloat x = quaX + quaX;\r\n    float y = quaY + quaY;\r\n    float z = quaZ + quaZ;\r\n    float wx = quaW * x;\r\n    float wy = quaW * y;\r\n    float wz = quaW * z;\r\n\tfloat xx = quaX * x;\r\n    float xy = quaX * y;\r\n\tfloat xz = quaX * z;\r\n    float yy = quaY * y;\r\n    float yz = quaY * z;\r\n    float zz = quaZ * z;\r\n\r\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\r\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\r\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\r\n\t\r\n}\r\n\r\n//axis\r\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\r\n{\r\n\tfloat halfAngle = angle * 0.5;\r\n\tfloat sin = sin(halfAngle);\r\n\t\r\n\tfloat quaX = axis.x * sin;\r\n\tfloat quaY = axis.y * sin;\r\n\tfloat quaZ = axis.z * sin;\r\n\tfloat quaW = cos(halfAngle);\r\n\t\r\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\r\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\r\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\r\n\t\r\n\tfloat x = quaX + quaX;\r\n    float y = quaY + quaY;\r\n    float z = quaZ + quaZ;\r\n    float wx = quaW * x;\r\n    float wy = quaW * y;\r\n    float wz = quaW * z;\r\n\tfloat xx = quaX * x;\r\n    float xy = quaX * y;\r\n\tfloat xz = quaX * z;\r\n    float yy = quaY * y;\r\n    float yz = quaY * z;\r\n    float zz = quaZ * z;\r\n\r\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\r\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\r\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\r\n\t\r\n}\r\n\r\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \r\n{\r\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\r\n}\r\n\r\n \r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\r\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\r\n{\r\n\tfloat curValue;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientNumber=gradientNumbers[i];\r\n\t\tfloat key=gradientNumber.x;\r\n\t\tif(key>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\r\n\t\t\tfloat lastKey=lastGradientNumber.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn curValue;\r\n}\r\n#endif\r\n\r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\r\n{\r\n\tfloat totalValue=0.0;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientNumber=gradientNumbers[i];\r\n\t\tfloat key=gradientNumber.x;\r\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\r\n\t\tfloat lastValue=lastGradientNumber.y;\r\n\t\t\r\n\t\tif(key>=normalizedAge){\r\n\t\t\tfloat lastKey=lastGradientNumber.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\telse{\r\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\r\n\t\t}\r\n\t}\r\n\treturn totalValue;\r\n}\r\n#endif\r\n\r\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\r\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\r\n{\r\n\tvec4 overTimeColor;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientAlpha=gradientAlphas[i];\r\n\t\tfloat alphaKey=gradientAlpha.x;\r\n\t\tif(alphaKey>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\r\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\r\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\r\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec4 gradientColor=gradientColors[i];\r\n\t\tfloat colorKey=gradientColor.x;\r\n\t\tif(colorKey>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\r\n\t\t\tfloat lastColorKey=lastGradientColor.x;\r\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\r\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn overTimeColor;\r\n}\r\n#endif\r\n\r\n\r\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\r\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\r\n{\r\n\tfloat overTimeFrame;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientFrame=gradientFrames[i];\r\n\t\tfloat key=gradientFrame.x;\r\n\t\tif(key>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\r\n\t\t\tfloat lastKey=lastGradientFrame.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn floor(overTimeFrame);\r\n}\r\n#endif\r\n\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\nvec3 computeParticleLifeVelocity(in float normalizedAge)\r\n{\r\n  vec3 outLifeVelocity;\r\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\r\n\t outLifeVelocity=u_VOLVelocityConst; \r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMECURVE\r\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\r\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\r\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\r\n  #endif\r\n\t\t\t\t\t\r\n  return outLifeVelocity;\r\n} \r\n#endif\r\n\r\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\r\n{\r\n   vec3 startPosition;\r\n   vec3 lifePosition;\r\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=lifeVelocity*age;\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMECURVE\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=lifeVelocity*age;\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\r\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\r\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\r\n\t#endif\r\n\t\r\n\tvec3 finalPosition;\r\n\tif(u_VOLSpaceType==0){\r\n\t  if(u_ScalingMode!=2)\r\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\r\n\t  else\r\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\r\n\t}\r\n\telse{\r\n\t  if(u_ScalingMode!=2)\r\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\r\n\t  else\r\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\r\n\t}\r\n  #else\r\n\t startPosition=startVelocity*age;\r\n\t vec3 finalPosition;\r\n\t if(u_ScalingMode!=2)\r\n\t\t\tfinalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\r\n\t else\r\n\t   \tfinalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\r\n  #endif\r\n  \r\n  if(u_SimulationSpace==0)\r\n    finalPosition=finalPosition+a_SimulationWorldPostion;\r\n  else if(u_SimulationSpace==1) \r\n    finalPosition=finalPosition+u_WorldPosition;\r\n  \r\n  finalPosition+=0.5*gravityVelocity*age;\r\n \r\n  return  finalPosition;\r\n}\r\n\r\n\r\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\r\n{\r\n\t#ifdef COLOROVERLIFETIME\r\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\r\n\t#endif\r\n\t\r\n\t#ifdef RANDOMCOLOROVERLIFETIME\r\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\r\n\t#endif\r\n\r\n    return color;\r\n}\r\n\r\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\r\n{\r\n\t#ifdef SIZEOVERLIFETIMECURVE\r\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\r\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\r\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\r\n\t#endif\r\n\treturn size;\r\n}\r\n\r\n#ifdef RENDERMODE_MESH\r\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\r\n{\r\n\t#ifdef SIZEOVERLIFETIMECURVE\r\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\r\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\r\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\r\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\r\n\t#endif\r\n\treturn size;\r\n}\r\n#endif\r\n\r\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\r\n{ \r\n\t#ifdef ROTATIONOVERLIFETIME\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\r\n\t\t#endif\r\n\t#endif\r\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\r\n\t\t#endif\r\n\t#endif\r\n\treturn rotation;\r\n}\r\n\r\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\r\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\r\n{ \r\n\t#ifdef ROTATIONOVERLIFETIME\r\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\r\n\t\t#endif\r\n\t#endif\r\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\r\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\r\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\r\n\t\t#endif\r\n\t#endif\r\n\treturn rotation;\r\n}\r\n#endif\r\n\r\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\r\n{ \r\n\t#ifdef TEXTURESHEETANIMATIONCURVE\r\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\r\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\r\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\r\n\t\tfloat floorTotalULength=floor(totalULength);\r\n\t    uv.x+=totalULength-floorTotalULength;\r\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\r\n    #endif\r\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\r\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\r\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\r\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\r\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\r\n\t\tfloat floorTotalULength=floor(totalULength);\r\n\t    uv.x+=totalULength-floorTotalULength;\r\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\r\n    #endif\r\n\treturn uv;\r\n}\r\n\r\nvoid main()\r\n{\r\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\r\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\r\n\tvec3 lifeVelocity;\r\n\tif(normalizedAge<1.0)\r\n\t{ \r\n\t\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\r\n\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//\r\n\t\t#endif \r\n\t\tvec3 gravityVelocity=u_Gravity*age;\r\n\t\t\r\n\t\tvec4 worldRotation;\r\n\t\tif(u_SimulationSpace==0)\r\n\t\t\tworldRotation=a_SimulationWorldRotation;\r\n\t\telse\r\n\t\t\tworldRotation=u_WorldRotation;\r\n\t\t\r\n\t\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//\r\n\t\r\n\t\r\n\t\t#ifdef SPHERHBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\r\n\t\t\tvec3 cameraUpVector =normalize(u_CameraUp);//TODO:\r\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\r\n\t\t\tvec3 upVector = normalize(cross(sideVector,u_CameraDirection));\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\t\t\tfloat c = cos(rot);\r\n\t\t\t\t\tfloat s = sin(rot);\r\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\t\t\tcorner=rotation*corner;\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\r\n\t\t\t\t}\r\n\t\t\t#else\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfloat c = cos(a_StartRotation0.x);\r\n\t\t\t\t\tfloat s = sin(a_StartRotation0.x);\r\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\t\t\tcorner=rotation*corner;\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef STRETCHEDBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\r\n\t\t\tvec3 velocity;\r\n\t\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t\t\t\tif(u_VOLSpaceType==0)\r\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\r\n\t\t\t\telse\r\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\r\n\t\t\t#else\r\n\t\t\t\tvelocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\r\n\t\t\t#endif\t\r\n\t\t\tvec3 cameraUpVector = normalize(velocity);\r\n\t\t\tvec3 direction = normalize(center-u_CameraPos);\r\n\t\t\tvec3 sideVector = normalize(cross(direction,normalize(velocity)));\r\n\t\t\t\r\n\t\t\tsideVector=u_SizeScale.xzy*sideVector;\r\n\t\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\r\n\t\t\t\r\n\t\t\tvec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\t\r\n\t\t\tconst mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\r\n\t\t\tcorner=rotaionZHalfPI*corner;\r\n\t\t\tcorner.y=corner.y-abs(corner.y);\r\n\t\t\t\r\n\t\t\tfloat speed=length(velocity);//TODO:\r\n\t\t\tcenter +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef HORIZONTALBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\r\n\t\t\tconst vec3 cameraUpVector=vec3(0.0,0.0,1.0);\r\n\t\t\tconst vec3 sideVector = vec3(-1.0,0.0,0.0);\r\n\t\t\t\r\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\tfloat c = cos(rot);\r\n\t\t\tfloat s = sin(rot);\r\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:cos45,U3D\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef VERTICALBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\r\n\t\t\tconst vec3 cameraUpVector =vec3(0.0,1.0,0.0);\r\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\r\n\t\t\t\r\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\tfloat c = cos(rot);\r\n\t\t\tfloat s = sin(rot);\r\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:cos45,U3D\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef RENDERMODE_MESH\r\n\t\t\tvec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\r\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\r\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIME\r\n\t\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\r\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t#ifdef SHAPE\r\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\r\n\t\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//\r\n\t\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//\r\n\t\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t\t\t\t\t//TODO:if(u_ThreeDStartRotation),\r\n\t\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\r\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//\r\n\t\t\t\t\t#endif\t\t\r\n\t\t\t\t}\r\n\t\t\t#else\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\r\n\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\r\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\t#ifdef SHAPE\r\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\r\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\r\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\tv_MeshColor=a_MeshColor;\r\n\t\t#endif\r\n\t\r\n\t\tgl_Position=u_Projection*u_View*vec4(center,1.0);\r\n\t\tv_Color = computeParticleColor(a_StartColor, normalizedAge);\r\n\t\t#ifdef DIFFUSEMAP\r\n\t\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\r\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\r\n\t\t\t#endif\r\n\t\t\t#ifdef RENDERMODE_MESH\r\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\r\n\t\t\t#endif\r\n\t\t\t\r\n\t\t\t#ifdef TILINGOFFSET\r\n\t\t\t\tv_TextureCoordinate=TransformUV(v_TextureCoordinate,u_TilingOffset);\r\n\t\t\t#endif\r\n\t\t#endif\r\n   \t}\r\n   \telse\r\n\t{\r\n\t\tgl_Position=vec4(2.0,2.0,2.0,1.0);//Discard use out of X(-1,1),Y(-1,1),Z(0,1)\r\n\t}\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n  precision highp float;\r\n#else\r\n  precision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\nuniform sampler2D u_texture;\r\nuniform vec4 u_Tintcolor;\r\n\r\n#ifdef RENDERMODE_MESH\r\n\tvarying vec4 v_MeshColor;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\n\r\nvoid main()\r\n{\t\r\n\t#ifdef RENDERMODE_MESH\r\n\t\tgl_FragColor=v_MeshColor;\r\n\t#else\r\n\t\tgl_FragColor=vec4(1.0);\t\r\n\t#endif\r\n\t\t\r\n\t#ifdef DIFFUSEMAP\r\n\t\t#ifdef TINTCOLOR\r\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\r\n\t\t#else\r\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef TINTCOLOR\r\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\r\n\t\t#else\r\n\t\t\tgl_FragColor*=v_Color;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n}",r),e={a_Position:ht.MESH_POSITION0},t={u_TintColor:Ae.PERIOD_MATERIAL,u_Exposure:Ae.PERIOD_MATERIAL,u_Rotation:Ae.PERIOD_MATERIAL,u_CubeTexture:Ae.PERIOD_MATERIAL,u_ViewProjection:Ae.PERIOD_CAMERA},i=Ae.add("SkyBox"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nuniform mat4 u_ViewProjection;\r\nuniform float u_Rotation;\r\nvarying vec3 v_Texcoord;\r\n\r\n\r\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\r\n{\r\n\tfloat angle = degrees * 3.141593 / 180.0;\r\n\tfloat sina=sin(angle);\r\n\tfloat cosa=cos(angle);\r\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\r\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\r\n}\r\n\t\t\r\nvoid main()\r\n{\r\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\r\n\tgl_Position = u_ViewProjection*position;\r\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec3 v_Texcoord;\r\n\r\nuniform samplerCube u_CubeTexture;\r\nuniform float u_Exposure;\r\nuniform vec4 u_TintColor;\r\n\r\n\r\nvoid main()\r\n{\t\r\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\r\n\tgl_FragColor=vec4(color,1.0);\r\n}\r\n\r\n"),e={a_Position:ht.MESH_POSITION0},t={u_SunSize:Ae.PERIOD_MATERIAL,u_SunSizeConvergence:Ae.PERIOD_MATERIAL,u_AtmosphereThickness:Ae.PERIOD_MATERIAL,u_SkyTint:Ae.PERIOD_MATERIAL,u_GroundTint:Ae.PERIOD_MATERIAL,u_Exposure:Ae.PERIOD_MATERIAL,u_ViewProjection:Ae.PERIOD_CAMERA,"u_SunLight.direction":Ae.PERIOD_SCENE,"u_SunLight.color":Ae.PERIOD_SCENE},i=Ae.add("SkyBoxProcedural"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass("#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include \"Lighting.glsl\";\r\n\r\n#define OUTER_RADIUS 1.025\r\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh\r\n#define MIE 0.0010             // Mie constant \r\n#define SUN_BRIGHTNESS 20.0    // Sun brightness\r\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\r\n\r\nconst float SKY_GROUND_THRESHOLD = 0.02;\r\nconst float outerRadius = OUTER_RADIUS;\r\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\r\nconst float innerRadius = 1.0;\r\nconst float innerRadius2 = 1.0;\r\nconst float cameraHeight = 0.0001;\r\n\r\nconst float HDSundiskIntensityFactor = 15.0;\r\nconst float simpleSundiskIntensityFactor = 27.0;\r\n\r\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\r\nconst float kmESun = MIE * SUN_BRIGHTNESS;\r\nconst float km4PI = MIE * 4.0 * 3.14159265;\r\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\r\nconst float scaleDepth = 0.25;\r\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\r\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\r\n\r\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\r\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//\r\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//\r\n\r\nattribute vec4 a_Position;\r\n\r\nuniform mat4 u_ViewProjection;\r\nuniform vec3 u_SkyTint;\r\nuniform vec3 u_GroundTint;\r\nuniform float u_Exposure;\r\nuniform float u_AtmosphereThickness;\r\nuniform DirectionLight u_SunLight;\r\n\r\nvarying vec3 v_GroundColor;\r\nvarying vec3 v_SkyColor;\r\n\r\n#ifdef SUN_HIGH_QUALITY\r\n\tvarying vec3 v_Vertex;\r\n#elif defined(SUN_SIMPLE)\r\n\tvarying vec3 v_RayDir;\r\n#else\r\n\tvarying float v_SkyGroundFactor;\r\n#endif\r\n\r\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\tvarying vec3 v_SunColor;\r\n#endif\r\n\r\n// Calculates the Rayleigh phase function\r\nfloat getRayleighPhase(vec3 light, vec3 ray) \r\n{\r\n\tfloat eyeCos = dot(light, ray);\r\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\r\n}\r\n\r\nfloat scaleAngle(float inCos)\r\n{\r\n\tfloat x = 1.0 - inCos;\r\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\r\n}\r\n\r\n\r\nvoid main () {\r\n\tgl_Position = u_ViewProjection*a_Position;\r\n\r\n\tvec3 skyTintInGammaSpace = u_SkyTint;//GAMMA\r\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\r\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\r\n\r\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\r\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\r\n\r\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\r\n\r\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\r\n\tvec3 eyeRay = normalize(a_Position.xyz);\r\n\r\n\tfloat far = 0.0;\r\n\tvec3 cIn, cOut;\r\n\tif (eyeRay.y >= 0.0) {// Sky\r\n\t\t// Calculate the length of the \"atmosphere\"\r\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\r\n\r\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\r\n\t\tfloat height = innerRadius + cameraHeight;\r\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\r\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\r\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\r\n\r\n\t\t// Initialize the scattering loop variables\r\n\t\tfloat sampleLength = far / samples;\r\n\t\tfloat scaledLength = sampleLength * scale;\r\n\t\tvec3 sampleRay = eyeRay * sampleLength;\r\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\r\n\r\n\t\tvec3 frontColor = vec3(0.0);\r\n\t\t//unrolling this manually to avoid some platform for loop slow\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\r\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\r\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\r\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\r\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\r\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\r\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\r\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\r\n\t\tcIn = frontColor * (invWavelength * krESun);\r\n\t\tcOut = frontColor * kmESun;\r\n\t} else {// Ground\r\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\r\n\t\tvec3 pos = cameraPos + far * eyeRay;\r\n\r\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\r\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\r\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\r\n\t\tfloat lightAngle = dot(-u_SunLight.direction, pos);\r\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\r\n\t\tfloat lightScale = scaleAngle(lightAngle);\r\n\t\tfloat cameraOffset = depth*cameraScale;\r\n\t\tfloat temp = lightScale + cameraScale;\r\n\r\n\t\t// Initialize the scattering loop variables\r\n\t\tfloat sampleLength = far / samples;\r\n\t\tfloat scaledLength = sampleLength * scale;\r\n\t\tvec3 sampleRay = eyeRay * sampleLength;\r\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\r\n\r\n\t\t// Now loop through the sample rays\r\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\r\n\t\tvec3 attenuate;\r\n\r\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat scatter = depth*temp - cameraOffset;\r\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\r\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\r\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\r\n\t}\r\n\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tv_Vertex = -a_Position.xyz;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tv_RayDir = -eyeRay;\r\n\t#else\r\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\r\n\t#endif\r\n\r\n\t// if we want to calculate color in vprog:\r\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\r\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\r\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_SunLight.direction, -eyeRay));\r\n\r\n\t\r\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\r\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\r\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\r\n\tfloat lightColorIntensity = clamp(length(u_SunLight.color), 0.25, 1.0);\r\n\r\n\t#ifdef SUN_HIGH_QUALITY \r\n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_SunLight.color / lightColorIntensity;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_SunLight.color / lightColorIntensity;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n",'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\nconst float MIE_G = -0.990;\r\nconst float MIE_G2 = 0.9801;\r\nconst float SKY_GROUND_THRESHOLD = 0.02;\r\n\r\nuniform float u_SunSize;\r\nuniform float u_SunSizeConvergence;\r\nuniform DirectionLight u_SunLight;\r\n\r\n\r\nvarying vec3 v_GroundColor;\r\nvarying vec3 v_SkyColor;\r\n\r\n\r\n#ifdef SUN_HIGH_QUALITY\r\n\tvarying vec3 v_Vertex;\r\n#elif defined(SUN_SIMPLE)\r\n\tvarying vec3 v_RayDir;\r\n#else\r\n\tvarying float v_SkyGroundFactor;\r\n#endif\r\n\r\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\tvarying vec3 v_SunColor;\r\n#endif\r\n\r\n// Calculates the Mie phase function\r\nfloat getMiePhase(float eyeCos, float eyeCos2) {\r\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\r\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\r\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\r\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\r\n\treturn temp;\r\n}\r\n\r\n// Calculates the sun shape\r\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\r\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\r\n\t#else //SUN_SIMPLE\r\n\t\tvec3 delta = lightPos - ray;\r\n\t\tfloat dist = length(delta);\r\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\r\n\t\treturn spot * spot;\r\n\t#endif\r\n}\r\n\r\nvoid main() {\r\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\r\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\r\n\t// if y < 0 [eyeRay.y > 0] - sky\r\n\tvec3 col = vec3(0.0, 0.0, 0.0);\r\n\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tvec3 ray = normalize(v_Vertex);\r\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tvec3 ray = v_RayDir;\r\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\r\n\t#else\r\n\t\tfloat y = v_SkyGroundFactor;\r\n\t#endif\r\n\r\n\t// if we did precalculate color in vprog: just do lerp between them\r\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\r\n\r\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\t\tif (y < 0.0)\r\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_SunLight.direction, -ray);\r\n\t#endif\r\n\r\n\tcol = sqrt(col);//linear space convert to gamma space\r\n\tgl_FragColor=vec4(col,1.0);\r\n}\r\n\r\n'),e={a_Position:ht.MESH_POSITION0,a_Normal:ht.MESH_NORMAL0,a_Texcoord0:ht.MESH_TEXTURECOORDINATE0},t={u_MvpMatrix:Ae.PERIOD_SPRITE,u_WorldMat:Ae.PERIOD_SPRITE,u_CameraPos:Ae.PERIOD_CAMERA,u_Viewport:Ae.PERIOD_CAMERA,u_ProjectionParams:Ae.PERIOD_CAMERA,u_View:Ae.PERIOD_CAMERA,u_LightmapScaleOffset:Ae.PERIOD_SPRITE,u_LightMap:Ae.PERIOD_SPRITE,u_SplatAlphaTexture:Ae.PERIOD_MATERIAL,u_DiffuseTexture1:Ae.PERIOD_MATERIAL,u_DiffuseTexture2:Ae.PERIOD_MATERIAL,u_DiffuseTexture3:Ae.PERIOD_MATERIAL,u_DiffuseTexture4:Ae.PERIOD_MATERIAL,u_DiffuseTexture5:Ae.PERIOD_MATERIAL,u_DiffuseScaleOffset1:Ae.PERIOD_MATERIAL,u_DiffuseScaleOffset2:Ae.PERIOD_MATERIAL,u_DiffuseScaleOffset3:Ae.PERIOD_MATERIAL,u_DiffuseScaleOffset4:Ae.PERIOD_MATERIAL,u_DiffuseScaleOffset5:Ae.PERIOD_MATERIAL,u_FogStart:Ae.PERIOD_SCENE,u_FogRange:Ae.PERIOD_SCENE,u_FogColor:Ae.PERIOD_SCENE,u_DirationLightCount:Ae.PERIOD_SCENE,u_LightBuffer:Ae.PERIOD_SCENE,u_LightClusterBuffer:Ae.PERIOD_SCENE,u_AmbientColor:Ae.PERIOD_SCENE,u_ShadowMap:Ae.PERIOD_SCENE,u_shadowMap2:Ae.PERIOD_SCENE,u_shadowMap3:Ae.PERIOD_SCENE,u_ShadowSplitSpheres:Ae.PERIOD_SCENE,u_ShadowMatrices:Ae.PERIOD_SCENE,u_ShadowMapSize:Ae.PERIOD_SCENE,"u_DirectionLight.color":Ae.PERIOD_SCENE,"u_DirectionLight.direction":Ae.PERIOD_SCENE,"u_PointLight.position":Ae.PERIOD_SCENE,"u_PointLight.range":Ae.PERIOD_SCENE,"u_PointLight.color":Ae.PERIOD_SCENE,"u_SpotLight.position":Ae.PERIOD_SCENE,"u_SpotLight.direction":Ae.PERIOD_SCENE,"u_SpotLight.range":Ae.PERIOD_SCENE,"u_SpotLight.spot":Ae.PERIOD_SCENE,"u_SpotLight.color":Ae.PERIOD_SCENE},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("ExtendTerrain"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec2 a_Texcoord0;\r\n\r\nuniform mat4 u_MvpMatrix;\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\r\n\tattribute vec3 a_Normal;\r\n\tvarying vec3 v_Normal;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\r\n\tuniform mat4 u_WorldMat;\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n#endif\r\n\r\n#ifdef CALCULATE_SHADOWS\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tgl_Position = u_MvpMatrix * a_Position;\r\n  \r\n\tv_Texcoord0 = a_Texcoord0;\r\n  \r\n\t#ifdef LIGHTMAP\r\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\r\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\r\n\t#endif\r\n  \r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tv_Normal = a_Normal;\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\r\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\r\n\t#endif\r\n\r\n\t#ifdef CALCULATE_SHADOWS\r\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld));\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\r\n\tuniform vec3 u_CameraPos;\r\n\tvarying vec3 v_Normal;\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n#endif\r\n\r\n#include "Shadow.glsl"\r\n#ifdef CALCULATE_SHADOWS\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\nvarying float v_posViewZ;\r\n\r\nuniform vec3 u_AmbientColor;\r\n\r\nuniform sampler2D u_SplatAlphaTexture;\r\n\r\nuniform sampler2D u_DiffuseTexture1;\r\nuniform sampler2D u_DiffuseTexture2;\r\nuniform sampler2D u_DiffuseTexture3;\r\nuniform sampler2D u_DiffuseTexture4;\r\nuniform sampler2D u_DiffuseTexture5;\r\n\r\nuniform vec4 u_DiffuseScaleOffset1;\r\nuniform vec4 u_DiffuseScaleOffset2;\r\nuniform vec4 u_DiffuseScaleOffset3;\r\nuniform vec4 u_DiffuseScaleOffset4;\r\nuniform vec4 u_DiffuseScaleOffset5;\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform sampler2D u_LightMap;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 splatAlpha = vec4(1.0);\r\n\t#ifdef ExtendTerrain_DETAIL_NUM1\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM2\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM3\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM4\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM5\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\r\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\r\n\t#endif\r\n\t\tgl_FragColor.w = splatAlpha.a;\r\n\t\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 normal = v_Normal;\r\n\t\tvec3 dif, spe;\r\n\t#endif\r\n\r\n\tvec3 diffuse = vec3(0.0);\r\n\tvec3 specular= vec3(0.0);\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\r\n\t\tvec3 toEye;\r\n\t\t#ifdef FOG\r\n\t\t\ttoEye=u_CameraPos-v_PositionWorld;\r\n\t\t\tfloat toEyeLength=length(toEye);\r\n\t\t\ttoEye/=toEyeLength;\r\n\t\t#else\r\n\t\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,u_DirectionLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_PointLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_SpotLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,directionLight,dif,spe);\r\n\t\t\t\tdiffuse+=dif;\r\n\t\t\t\tspecular+=spe;\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,pointLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye\t,spotLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\nvec3 globalDiffuse = u_AmbientColor;\r\n#ifdef LIGHTMAP\r\n\tglobalDiffuse += decodeHDR(texture2D(u_LightMap, v_LightMapUV),5.0);\r\n#endif\r\n\r\n#ifdef CALCULATE_SHADOWS\r\n\tfloat shadowValue = shadowValue = sampleShadowmap(v_ShadowCoord);\r\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\r\n#else\r\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef CALCULATE_SHADOWS\r\n\t\tgl_FragColor.rgb += specular * shadowValue;\r\n\t#else\r\n\t\tgl_FragColor.rgb += specular;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef FOG\r\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\r\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n#endif\r\n}\r\n\r\n\r\n\r\n\r\n\r\n',r),e={a_Position:gi.TRAIL_POSITION0,a_OffsetVector:gi.TRAIL_OFFSETVECTOR,a_Texcoord0X:gi.TRAIL_TEXTURECOORDINATE0X,a_Texcoord0Y:gi.TRAIL_TEXTURECOORDINATE0Y,a_BirthTime:gi.TRAIL_TIME0,a_Color:gi.TRAIL_COLOR},t={u_MvpMatrix:Ae.PERIOD_SPRITE,u_View:Ae.PERIOD_CAMERA,u_Projection:Ae.PERIOD_CAMERA,u_TilingOffset:Ae.PERIOD_MATERIAL,u_MainTexture:Ae.PERIOD_MATERIAL,u_MainColor:Ae.PERIOD_MATERIAL,u_CurTime:Ae.PERIOD_SPRITE,u_LifeTime:Ae.PERIOD_SPRITE,u_WidthCurve:Ae.PERIOD_SPRITE,u_WidthCurveKeyLength:Ae.PERIOD_SPRITE,u_GradientColorkey:Ae.PERIOD_SPRITE,u_GradientAlphakey:Ae.PERIOD_SPRITE},r={s_Cull:Ae.RENDER_STATE_CULL,s_Blend:Ae.RENDER_STATE_BLEND,s_BlendSrc:Ae.RENDER_STATE_BLEND_SRC,s_BlendDst:Ae.RENDER_STATE_BLEND_DST,s_DepthTest:Ae.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Ae.RENDER_STATE_DEPTH_WRITE},i=Ae.add("Trail"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec3 a_Position;\r\nattribute vec3 a_OffsetVector;\r\nattribute vec4 a_Color;\r\nattribute float a_Texcoord0X;\r\nattribute float a_Texcoord0Y;\r\nattribute float a_BirthTime;\r\n\r\nuniform mat4 u_View;\r\nuniform mat4 u_Projection;\r\n\r\nuniform vec4 u_TilingOffset;\r\n\r\nuniform float u_CurTime;\r\nuniform float u_LifeTime;\r\nuniform vec4 u_WidthCurve[10];\r\nuniform int u_WidthCurveKeyLength;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec4 v_Color;\r\n\r\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\r\n{\r\n\tfloat t2 = t * t;\r\n\tfloat t3 = t2 * t;\r\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\r\n\tfloat b = t3 - 2.0 * t2 + t;\r\n\tfloat c = t3 - t2;\r\n\tfloat d = -2.0 * t3 + 3.0 * t2;\r\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\r\n}\r\n\r\nfloat getCurWidth(in float normalizeTime)\r\n{\r\n\tfloat width;\r\n\tif(normalizeTime == 0.0){\r\n\t\twidth=u_WidthCurve[0].w;\r\n\t}\r\n\telse if(normalizeTime >= 1.0){\r\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\r\n\t}\r\n\telse{\r\n\t\tfor(int i = 0; i < 10; i ++ )\r\n\t\t{\r\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\r\n\t\t\t\twidth=u_WidthCurve[i].w;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\r\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\r\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\r\n\t\t\t{\r\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\r\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\r\n\t\t\t\tfloat outTangent = lastFrame.z;\r\n\t\t\t\tfloat inTangent = nextFrame.y;\r\n\t\t\t\tfloat value1 = lastFrame.w;\r\n\t\t\t\tfloat value2 = nextFrame.w;\r\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn width;\r\n}\t\r\n\r\nvoid main()\r\n{\r\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\r\n\t\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\r\n\t#else\r\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\r\n\t#endif\r\n\t\r\n\tv_Color = a_Color;\r\n\t\r\n\tgl_Position = u_Projection * u_View * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D u_MainTexture;\r\nuniform vec4 u_MainColor;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec4 v_Color;\r\n\r\nvoid main()\r\n{\r\n\tvec4 color = 2.0 * u_MainColor * v_Color;\r\n\t#ifdef MAINTEXTURE\r\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\r\n\t\tcolor *= mainTextureColor;\r\n\t#endif\r\n\tgl_FragColor = color;\r\n}\r\n\r\n     ",r),e={a_Position:ht.MESH_POSITION0,a_Normal:ht.MESH_NORMAL0,a_Tangent0:ht.MESH_TANGENT0},t={u_MvpMatrix:Ae.PERIOD_SPRITE,u_WorldMat:Ae.PERIOD_SPRITE,u_CameraPos:Ae.PERIOD_CAMERA,u_Time:Ae.PERIOD_SCENE,u_MainTexture:Ae.PERIOD_MATERIAL,u_NormalTexture:Ae.PERIOD_MATERIAL,u_HorizonColor:Ae.PERIOD_MATERIAL,u_WaveScale:Ae.PERIOD_MATERIAL,u_WaveSpeed:Ae.PERIOD_MATERIAL},i=Ae.add("WaterPrimary"),n=new pr(e,t),i.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\nattribute vec4 a_Tangent0;\r\n\r\nuniform mat4 u_MvpMatrix;\r\nuniform mat4 u_WorldMat;\r\nuniform vec3 u_CameraPos;\r\nuniform float u_WaveScale;\r\nuniform vec4 u_WaveSpeed;\r\nuniform float u_Time;\r\n\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec2 v_Texcoord0;\r\nvarying vec2 v_Texcoord1;\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionWorld = u_WorldMat * a_Position;\r\n\tvec4 position = u_MvpMatrix * a_Position;\r\n\t\r\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\r\n\t\r\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\r\n\tv_Texcoord1 = temp.wz;\r\n\t\r\n\tmat3 worldMat = mat3(u_WorldMat);\r\n\tv_Normal = worldMat * a_Normal;\r\n\tv_Tangent = worldMat * a_Tangent0.xyz;\r\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\r\n\t\r\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\r\n\tgl_Position = position;\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#ifdef MAINTEXTURE\r\n\tuniform sampler2D u_MainTexture;\r\n#endif\r\n\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n#endif\r\n\r\nuniform vec4 u_HorizonColor;\r\n\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec2 v_Texcoord0;\r\nvarying vec2 v_Texcoord1;\r\n\r\n\r\n#include "Lighting.glsl"\r\n\r\n\r\n\r\nvec3 NormalSampleToWorldSpace(vec4 normalMapSample) {\r\n\tvec3 normalT;\r\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\r\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\r\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\r\n\r\n\tvec3 bumpedNormal = normalize(normalT);\r\n\r\n\treturn bumpedNormal;\r\n}\r\n\r\n\r\nvoid main()\r\n{\r\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\r\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\r\n\r\n\tvec3 normal1 = NormalSampleToWorldSpace(bumpColor1);\r\n\tvec3 normal2 = NormalSampleToWorldSpace(bumpColor2);\r\n\t\r\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\r\n\tvec3 viewDir = normalize(v_ViewDir);\r\n\tfloat fresnel = dot(viewDir, normal);\r\n\t\r\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\r\n\t\r\n\tvec4 color;\r\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\r\n\tcolor.a = u_HorizonColor.a;\r\n\t\r\n\tgl_FragColor = color;\r\n}\r\n\r\n\r\n'),e={a_PositionTexcoord:ht.MESH_POSITION0},t={u_MainTex:Ae.PERIOD_MATERIAL,u_OffsetScale:Ae.PERIOD_MATERIAL},i=Ae.add("BlitScreen"),n=new pr(e,t),i.addSubShader(n);var a=n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nuniform vec4 u_OffsetScale;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\t\r\n\tgl_Position = vec4(u_OffsetScale.x*2.0-1.0+(a_PositionTexcoord.x+1.0)*u_OffsetScale.z,(1.0-((u_OffsetScale.y*2.0-1.0+(-a_PositionTexcoord.y+1.0)*u_OffsetScale.w)+1.0)/2.0)*2.0-1.0, 0.0, 1.0);\t\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D u_MainTex;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_FragColor = texture2D(u_MainTex, v_Texcoord0);\r\n}\r\n\r\n").renderState;a.depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,e={a_PositionTexcoord:ht.MESH_POSITION0},t={u_MainTex:Ae.PERIOD_MATERIAL,u_BloomTex:Ae.PERIOD_MATERIAL,u_AutoExposureTex:Ae.PERIOD_MATERIAL,u_MainTex_TexelSize:Ae.PERIOD_MATERIAL,u_SampleScale:Ae.PERIOD_MATERIAL,u_Threshold:Ae.PERIOD_MATERIAL,u_Params:Ae.PERIOD_MATERIAL},i=Ae.add("PostProcessBloom"),n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass(Oi,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\r\nuniform vec4 u_Params; // x: clamp, yzw: unused\r\n\r\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\r\n\tcolor *= autoExposure;\r\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\r\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\r\n\treturn color;\r\n}\r\n\r\nvoid fragPrefilter13() {\r\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragPrefilter13();\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass(Oi,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\r\nuniform vec4 u_Params; // x: clamp, yzw: unused\r\n\r\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\r\n\tcolor *= autoExposure;\r\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\r\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\r\n\treturn color;\r\n}\r\n\r\nvoid fragPrefilter4() {\r\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragPrefilter4();\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass(Oi,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\n\r\nvoid fragDownsample13() {\r\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = color;\r\n}\r\n\r\nvoid main() {\r\n\tfragDownsample13();\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass(Oi,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\n\r\nvoid fragDownsample4() {\r\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = color;\r\n}\r\n\r\nvoid main() {\r\n\tfragDownsample4();\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass(Oi,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform float u_SampleScale;\r\n\r\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\r\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\r\n\treturn bloom + color;\r\n}\r\n\r\nvoid fragUpsampleTent() {\r\n\tmediump vec4 bloom = upsampleTent(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\r\n\tgl_FragColor = combine(bloom, v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragUpsampleTent();\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass(Oi,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform float u_SampleScale;\r\n\r\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\r\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\r\n\treturn bloom + color;\r\n}\r\n\r\nvoid fragUpsampleBox() {\r\n\tmediump vec4 bloom = upsampleBox(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\r\n\tgl_FragColor = combine(bloom, v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragUpsampleBox();\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE,e={a_PositionTexcoord:ht.MESH_POSITION0},t={u_MainTex:Ae.PERIOD_MATERIAL,u_BloomTex:Ae.PERIOD_MATERIAL,u_AutoExposureTex:Ae.PERIOD_MATERIAL,u_Bloom_DirtTileOffset:Ae.PERIOD_MATERIAL,u_Bloom_DirtTex:Ae.PERIOD_MATERIAL,u_BloomTex_TexelSize:Ae.PERIOD_MATERIAL,u_Bloom_Settings:Ae.PERIOD_MATERIAL,u_Bloom_Color:Ae.PERIOD_MATERIAL},i=Ae.add("PostProcessComposite"),n=new pr(e,t),i.addSubShader(n),(a=n.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform sampler2D u_Bloom_DirtTex;\r\nuniform vec4 u_BloomTex_TexelSize;\r\nuniform vec4 u_Bloom_DirtTileOffset; // xy: tiling, zw: offset\r\nuniform mediump vec3 u_Bloom_Settings;// x: sampleScale, y: intensity, z: dirt intensity\r\nuniform mediump vec3 u_Bloom_Color;\r\n\r\nvoid main() {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, v_Texcoord0).r;\r\n\tmediump vec4 color=vec4(0.0);\r\n\tcolor = texture2D(u_MainTex, v_Texcoord0);\r\n\t\r\n\tcolor = sRGBToLinear(color);\r\n\tcolor.rgb *= autoExposure;\r\n\t\r\n\t#if defined(BLOOM)||defined(BLOOM_LOW)\r\n\t\t#ifdef BLOOM\r\n\t\t\tmediump vec4 bloom = upsampleTent(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\r\n\t\t#else\r\n\t\t\tmediump vec4 bloom = upsampleBox(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\r\n\t\t#endif\r\n\r\n\t\t// UVs should be Distort(uv * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw)\r\n\t\t// but considering we use a cover-style scale on the dirt texture the difference\r\n\t\t// isn\'t massive so we chose to save a few ALUs here instead in case lens distortion\r\n\t\t// is active\r\n\t\tmediump vec4 dirt =vec4(texture2D(u_Bloom_DirtTex, v_Texcoord0 * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw).rgb, 0.0);\r\n\r\n\t\t// Additive bloom (artist friendly)\r\n\t\tbloom *= u_Bloom_Settings.y;\r\n\t\tdirt *= u_Bloom_Settings.z;\r\n\t\tmediump vec4 bloomColor=vec4(u_Bloom_Color, 1.0);\r\n\t\tcolor += bloom * bloomColor;\r\n\t\tcolor += dirt * bloom;\r\n\t#endif\r\n\t\r\n\tmediump vec4 finalColor = color;\r\n\tfinalColor = linearToSRGB(finalColor);\r\n\t//finalColor.rgb = Dither(finalColor.rgb, v_Texcoord0);//TODO:\r\n\tgl_FragColor = finalColor;\r\n}').renderState).depthTest=Oe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Oe.CULL_NONE,a.blend=Oe.BLEND_DISABLE}}class bi extends Lt{constructor(){super(),this._direction=new a,this._shadowCascadesMode=e.ShadowCascadesMode.NoCascades,this._shadowTwoCascadeSplits=1/3,this._shadowFourCascadeSplits=new a(1/15,.2,7/15),this._lightType=e.LightType.Directional}get shadowCascadesMode(){return this._shadowCascadesMode}set shadowCascadesMode(e){this._shadowCascadesMode=e}get shadowTwoCascadeSplits(){return this._shadowTwoCascadeSplits}set shadowTwoCascadeSplits(e){this._shadowTwoCascadeSplits=e}get shadowFourCascadeSplits(){return this._shadowFourCascadeSplits}set shadowFourCascadeSplits(e){if(e.x>e.y||e.y>e.z||e.z>1)throw"DiretionLight:Invalid value.";e.cloneTo(this._shadowFourCascadeSplits)}_addToLightQueue(){this._scene._directionLights.add(this)}_removeFromLightQueue(){this._scene._directionLights.remove(this)}_parse(e,t){super._parse(e,t),null!=e.shadowCascadesMode&&(this.shadowCascadesMode=e.shadowCascadesMode)}}class Pi extends Lt{constructor(){super(),this._range=6,this._lightType=e.LightType.Point}get range(){return this._range}set range(e){this._range=e}_addToLightQueue(){this._scene._pointLights.add(this)}_removeFromLightQueue(){this._scene._pointLights.remove(this)}_parse(e,t){super._parse(e,t),this.range=e.range}}class wi extends Lt{constructor(){super(),this._spotAngle=30,this._range=10,this._direction=new a,this._lightType=e.LightType.Spot}get spotAngle(){return this._spotAngle}set spotAngle(e){this._spotAngle=Math.max(Math.min(e,179),0)}get range(){return this._range}set range(e){this._range=e}_addToLightQueue(){this._scene._spotLights.add(this)}_removeFromLightQueue(){this._scene._spotLights.remove(this)}_parse(e,t){super._parse(e,t),this.range=e.range,this.spotAngle=e.spotAngle}}class Vi{static _createSprite3DInstance(e,t,r){var i;switch(e.type){case"Scene3D":i=new Tr;break;case"Sprite3D":i=new ft;break;case"MeshSprite3D":i=new Nr,r&&e.props.isStatic&&r.push(i);break;case"SkinnedMeshSprite3D":i=new fi;break;case"ShuriKenParticle3D":i=new di;break;case"Camera":i=new Nt;break;case"DirectionLight":i=new bi;break;case"PointLight":i=new Pi;break;case"SpotLight":i=new wi;break;case"TrailSprite3D":i=new Ai;break;default:throw console.error("",e),new Error("Utils3D:unidentified class type in (.lh) file.")}var n=e.child;if(n)for(var a=0,s=n.length;a<s;a++){var o=Vi._createSprite3DInstance(n[a],t,r);i.addChild(o)}return t[e.instanceID]=i,i}static _createComponentInstance(e,r,i){var n=r[e.instanceID];n._parse(e.props,r);var a=e.child;if(a)for(var s=0,o=a.length;s<o;s++)Vi._createComponentInstance(a[s],r,i);var l=e.components;if(l)for(var _=0,h=l.length;_<h;_++){var c=l[_],d=t.ClassUtils.getRegClass(c.type);if(d)n.addComponent(d)._parse(c,i);else console.warn("Unkown component type.")}}static _createNodeByJson02(e,t){var r={},i={component:[],data:[]},n=Vi._createSprite3DInstance(e,r,t);return Vi._createComponentInstance(e,r,i),Vi._createInteractInstance(i,r),n}static _createInteractInstance(e,t){for(var r=e.component,i=e.data,n=0,a=r.length;n<a;n++)r[n]._parseInteractive(i[n],t)}static _parse(e,t=null,r=null){var i,n=e.data,a=[];switch(e.version){case"LAYAHIERARCHY:02":i=Vi._createNodeByJson02(n,a);break;default:i=Vi._createNodeByJson(n,a)}return Jt.combine(i,a),i}static _parseScene(e,t=null,r=null){var i,n=e.data,a=[];switch(e.version){case"LAYASCENE3D:02":i=Vi._createNodeByJson02(n,a);break;default:i=Vi._createNodeByJson(n,a)}return Jt.combine(null,a),i}static _createNodeByJson(e,r){var i;switch(e.type){case"Scene3D":i=new Tr;break;case"Sprite3D":i=new ft;break;case"MeshSprite3D":i=new Nr,r&&e.props.isStatic&&r.push(i);break;case"SkinnedMeshSprite3D":i=new fi;break;case"ShuriKenParticle3D":i=new di;break;case"Camera":i=new Nt;break;case"DirectionLight":i=new bi;break;case"PointLight":i=new Pi;break;case"SpotLight":i=new wi;break;case"TrailSprite3D":i=new Ai;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var n=e.child;if(n)for(var a=0,s=n.length;a<s;a++){var o=Vi._createNodeByJson(n[a],r);i.addChild(o)}var l=e.components;if(l)for(var _=0,h=l.length;_<h;_++){var c=l[_],d=t.ClassUtils.getRegClass(c.type);if(d)i.addComponent(d)._parse(c);else console.warn("Unkown component type.")}return i._parse(e.props,null),i}}let Fi=(()=>{class r{static parse(e,t,i,n){r._mesh=i,r._subMeshes=n,r._version=t,r._readData=e,r.READ_DATA(),r.READ_BLOCK(),r.READ_STRINGS();for(var a=0,s=r._BLOCK.count;a<s;a++){r._readData.pos=r._BLOCK.blockStarts[a];var o=r._readData.getUint16(),l=r._strings[o],_=r["READ_"+l];if(null==_)throw new Error("model file err,no this function:"+o+" "+l);_.call(null)}r._strings.length=0,r._readData=null,r._version=null,r._mesh=null,r._subMeshes=null}static _readString(){return r._strings[r._readData.getUint16()]}static READ_DATA(){r._DATA.offset=r._readData.getUint32(),r._DATA.size=r._readData.getUint32()}static READ_BLOCK(){for(var e=r._BLOCK.count=r._readData.getUint16(),t=r._BLOCK.blockStarts=[],i=r._BLOCK.blockLengths=[],n=0;n<e;n++)t.push(r._readData.getUint32()),i.push(r._readData.getUint32())}static READ_STRINGS(){var e=r._readData.getUint32(),t=r._readData.getUint16(),i=r._readData.pos;r._readData.pos=e+r._DATA.offset;for(var n=0;n<t;n++)r._strings[n]=r._readData.readUTFString();r._readData.pos=i}static READ_MESH(){var i,n=t.LayaGL.instance,a=(r._readString(),r._readData.__getBuffer()),s=0,o=r._readData.getInt16(),l=r._DATA.offset;for(i=0;i<o;i++){var _,c=l+r._readData.getUint32(),d=r._readData.getUint32(),u=a.slice(c,c+d),m=new Float32Array(u),f=r._readString();switch(r._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":_=ht.getVertexDeclaration(f);break;case"LAYAMODEL:0401":_=ht.getVertexDeclaration(f,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!_)throw new Error("LoadModelV03: unknown vertexDeclaration.");var T=new ct(4*m.length,n.STATIC_DRAW,!0);T.vertexDeclaration=_,T.setData(m.buffer),r._mesh._vertexBuffer=T,r._mesh._vertexCount+=T._byteLength/_.vertexStride,s+=4*m.length}var E=l+r._readData.getUint32(),p=r._readData.getUint32(),g=new Uint16Array(a.slice(E,E+p)),S=new st(e.IndexFormat.UInt16,p/2,n.STATIC_DRAW,!0);S.setData(g),r._mesh._indexBuffer=S,s+=2*S.indexCount,r._mesh._setBuffer(r._mesh._vertexBuffer,S),r._mesh._setCPUMemory(s),r._mesh._setGPUMemory(s);var R=r._mesh._boneNames=[],v=r._readData.getUint16();for(R.length=v,i=0;i<v;i++)R[i]=r._strings[r._readData.getUint16()];r._readData.pos+=8;var A=r._readData.getUint32(),I=r._readData.getUint32(),x=new Float32Array(a.slice(l+A,l+A+I)),C=x.length,L=r._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*C);for(r._mesh._inverseBindPoses=[],i=0;i<C;i+=16){var y=new h(x[i+0],x[i+1],x[i+2],x[i+3],x[i+4],x[i+5],x[i+6],x[i+7],x[i+8],x[i+9],x[i+10],x[i+11],x[i+12],x[i+13],x[i+14],x[i+15],new Float32Array(L,4*i,16));r._mesh._inverseBindPoses[i/16]=y}return!0}static READ_SUBMESH(){var e=r._readData.__getBuffer(),t=new Li(r._mesh);r._readData.getInt16(),r._readData.getUint32(),r._readData.getUint32();var i=r._readData.getUint32(),n=r._readData.getUint32(),a=r._mesh._indexBuffer;t._indexBuffer=a,t._setIndexRange(i,n);var s=r._mesh._vertexBuffer;t._vertexBuffer=s;var o=r._DATA.offset,l=t._subIndexBufferStart,_=t._subIndexBufferCount,h=t._boneIndicesList,c=r._readData.getUint16();l.length=c,_.length=c,h.length=c;var d=r._mesh._skinnedMatrixCaches,u=r._subMeshes.length;d.length=r._mesh._inverseBindPoses.length;for(var m=0;m<c;m++){l[m]=r._readData.getUint32(),_[m]=r._readData.getUint32();for(var f=r._readData.getUint32(),T=r._readData.getUint32(),E=h[m]=new Uint16Array(e.slice(o+f,o+f+T)),p=E.length,g=0;g<p;g++){var S=E[g];d[S]||(d[S]=new yi(u,m,g))}}return r._subMeshes.push(t),!0}}return r._BLOCK={count:0},r._DATA={offset:0,size:0},r._strings=[],r})(),Bi=(()=>{class r{static parse(e,t,i,n){r._mesh=i,r._subMeshes=n,r._version=t,r._readData=e,r.READ_DATA(),r.READ_BLOCK(),r.READ_STRINGS();for(var a=0,s=r._BLOCK.count;a<s;a++){r._readData.pos=r._BLOCK.blockStarts[a];var o=r._readData.getUint16(),l=r._strings[o],_=r["READ_"+l];if(null==_)throw new Error("model file err,no this function:"+o+" "+l);_.call(null)}r._strings.length=0,r._readData=null,r._version=null,r._mesh=null,r._subMeshes=null}static _readString(){return r._strings[r._readData.getUint16()]}static READ_DATA(){r._DATA.offset=r._readData.getUint32(),r._DATA.size=r._readData.getUint32()}static READ_BLOCK(){for(var e=r._BLOCK.count=r._readData.getUint16(),t=r._BLOCK.blockStarts=[],i=r._BLOCK.blockLengths=[],n=0;n<e;n++)t.push(r._readData.getUint32()),i.push(r._readData.getUint32())}static READ_STRINGS(){var e=r._readData.getUint32(),t=r._readData.getUint16(),i=r._readData.pos;r._readData.pos=e+r._DATA.offset;for(var n=0;n<t;n++)r._strings[n]=r._readData.readUTFString();r._readData.pos=i}static READ_MESH(){var i,n=t.LayaGL.instance,a=0,s=(r._readString(),r._readData),o=s.__getBuffer(),l=s.getInt16(),_=r._DATA.offset;for(i=0;i<l;i++){var c,d,u,m=_+s.getUint32(),f=s.getUint32(),T=r._readString(),E=ht.getVertexDeclaration(T,!1),p=E.vertexStride,g=T.split(","),S=g.length,R=r._mesh;switch(r._version){case"LAYAMODEL:05":case"LAYAMODEL:0501":c=o.slice(m,m+f*p),d=new Float32Array(c),u=new Uint8Array(c);break;case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:COMPRESSION_0501":c=new ArrayBuffer(p*f),d=new Float32Array(c),u=new Uint8Array(c);var v=s.pos;s.pos=m;for(var A=0;A<f;A++)for(var I,x=A*p,C=0;C<S;C++)switch(g[C]){case"POSITION":d[I=x/4]=ne.convertToNumber(s.getUint16()),d[I+1]=ne.convertToNumber(s.getUint16()),d[I+2]=ne.convertToNumber(s.getUint16()),x+=12;break;case"NORMAL":d[I=x/4]=s.getUint8()/127.5-1,d[I+1]=s.getUint8()/127.5-1,d[I+2]=s.getUint8()/127.5-1,x+=12;break;case"COLOR":d[I=x/4]=s.getUint8()/255,d[I+1]=s.getUint8()/255,d[I+2]=s.getUint8()/255,d[I+3]=s.getUint8()/255,x+=16;break;case"UV":case"UV1":d[I=x/4]=ne.convertToNumber(s.getUint16()),d[I+1]=ne.convertToNumber(s.getUint16()),x+=8;break;case"BLENDWEIGHT":d[I=x/4]=s.getUint8()/255,d[I+1]=s.getUint8()/255,d[I+2]=s.getUint8()/255,d[I+3]=s.getUint8()/255,x+=16;break;case"BLENDINDICES":u[x]=s.getUint8(),u[x+1]=s.getUint8(),u[x+2]=s.getUint8(),u[x+3]=s.getUint8(),x+=4;break;case"TANGENT":d[I=x/4]=s.getUint8()/127.5-1,d[I+1]=s.getUint8()/127.5-1,d[I+2]=s.getUint8()/127.5-1,d[I+3]=s.getUint8()/127.5-1,x+=16}s.pos=v}var L=new ct(c.byteLength,n.STATIC_DRAW,!0);L.vertexDeclaration=E,L.setData(c);f=L._byteLength/E.vertexStride;R._indexFormat=f>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16,R._vertexBuffer=L,R._vertexCount+=f,a+=4*d.length}var y,D=_+s.getUint32(),M=s.getUint32();y=R.indexFormat==e.IndexFormat.UInt32?new Uint32Array(o.slice(D,D+M)):new Uint16Array(o.slice(D,D+M));var O=new st(R.indexFormat,y.length,n.STATIC_DRAW,!0);if(O.setData(y),R._indexBuffer=O,R._setBuffer(R._vertexBuffer,O),a+=2*O.indexCount,R._setCPUMemory(a),R._setGPUMemory(a),"LAYAMODEL:0501"==r._version||"LAYAMODEL:COMPRESSION_0501"==r._version){var N=R.bounds,b=N.getMin(),P=N.getMax();b.setValue(s.getFloat32(),s.getFloat32(),s.getFloat32()),P.setValue(s.getFloat32(),s.getFloat32(),s.getFloat32()),N.setMin(b),N.setMax(P),R.bounds=N}var w=R._boneNames=[],V=s.getUint16();for(w.length=V,i=0;i<V;i++)w[i]=r._strings[s.getUint16()];var F=s.getUint32(),B=s.getUint32(),U=new Float32Array(o.slice(_+F,_+F+B)),G=U.length,z=R._inverseBindPosesBuffer=new ArrayBuffer(4*G);for(R._inverseBindPoses=[],i=0;i<G;i+=16){var H=new h(U[i+0],U[i+1],U[i+2],U[i+3],U[i+4],U[i+5],U[i+6],U[i+7],U[i+8],U[i+9],U[i+10],U[i+11],U[i+12],U[i+13],U[i+14],U[i+15],new Float32Array(z,4*i,16));R._inverseBindPoses[i/16]=H}return!0}static READ_SUBMESH(){var e=r._readData,t=e.__getBuffer(),i=new Li(r._mesh);e.getInt16();var n=e.getUint32(),a=e.getUint32(),s=r._mesh._indexBuffer;i._indexBuffer=s,i._setIndexRange(n,a);var o=r._mesh._vertexBuffer;i._vertexBuffer=o;var l=r._DATA.offset,_=i._subIndexBufferStart,h=i._subIndexBufferCount,c=i._boneIndicesList,d=e.getUint16();_.length=d,h.length=d,c.length=d;var u=r._mesh._skinnedMatrixCaches,m=r._subMeshes.length;u.length=r._mesh._inverseBindPoses.length;for(var f=0;f<d;f++){_[f]=e.getUint32(),h[f]=e.getUint32();for(var T=e.getUint32(),E=e.getUint32(),p=c[f]=new Uint16Array(t.slice(l+T,l+T+E)),g=0,S=p.length;g<S;g++){var R=p[g];u[R]||(u[R]=new yi(m,f,g))}}return r._subMeshes.push(i),!0}}return r._BLOCK={count:0},r._DATA={offset:0,size:0},r._strings=[],r})();class Ui{static _parse(e,t=null,r=null){var i=new Di;return Ui.read(e,i,i._subMeshes),i}static read(e,r,i){var n=new t.Byte(e);n.pos=0;var a=n.readUTFString();switch(a){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":Fi.parse(n,a,r,i);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:0501":case"LAYAMODEL:COMPRESSION_0501":Bi.parse(n,a,r,i);break;default:throw new Error("MeshReader: unknown mesh version.")}r._setSubMeshes(i),"LAYAMODEL:0501"!=a&&"LAYAMODEL:COMPRESSION_0501"!=a&&r.calculateBounds()}}let Gi=(()=>{class e extends De{constructor(){super(),this._exposure=1,this._textureDecodeFormat=t.TextureDecodeFormat.Normal,this._textureHDRParams=new n(1,0,0,1),this.setShaderName("SkyPanoramic");var r=this._shaderValues;r.setVector(e.TINTCOLOR,new n(.5,.5,.5,.5)),r.setNumber(e.ROTATION,0),r.setVector(e.TEXTURE_HDR_PARAMS,this._textureHDRParams)}static __init__(){var e={a_Position:ht.MESH_POSITION0},t={u_TintColor:Ae.PERIOD_MATERIAL,u_TextureHDRParams:Ae.PERIOD_MATERIAL,u_Rotation:Ae.PERIOD_MATERIAL,u_Texture:Ae.PERIOD_MATERIAL,u_ViewProjection:Ae.PERIOD_CAMERA},r=Ae.add("SkyPanoramic"),i=new pr(e,t);r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\n#define PI 3.14159265359\r\n\r\nattribute vec4 a_Position;\r\n\r\nuniform mat4 u_ViewProjection;\r\nuniform float u_Rotation;\r\n\r\nvarying vec3 v_Texcoord;\r\nvarying vec2 v_Image180ScaleAndCutoff;\r\nvarying vec4 v_Layout3DScaleAndOffset;\r\n\r\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\r\n{\r\n\tfloat angle = degrees * PI / 180.0;\r\n\tfloat sina=sin(angle);\r\n\tfloat cosa=cos(angle);\r\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\r\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\r\n}\r\n\r\n\t\t\r\nvoid main()\r\n{\r\n\tvec4 position = rotateAroundYInDegrees(a_Position, u_Rotation);\r\n\tgl_Position = u_ViewProjection*position;\r\n\r\n\tv_Texcoord=vec3(-a_Position.x,-a_Position.y,a_Position.z);// NOTE: -a_Position.x convert coords system\r\n\r\n\t// Calculate constant horizontal scale and cutoff for 180 (vs 360) image type\r\n\tv_Image180ScaleAndCutoff = vec2(1.0, 1.0);// 360 degree mode\r\n\r\n\t// Calculate constant scale and offset for 3D layouts\r\n\tv_Layout3DScaleAndOffset = vec4(0,0,1,1);\r\n}\r\n','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#define PI 3.14159265359\r\n#include "Lighting.glsl";\r\n\r\nuniform sampler2D u_Texture;\r\nuniform vec4 u_TextureHDRParams;\r\nuniform vec4 u_TintColor;\r\n\r\nvarying vec3 v_Texcoord;\r\nvarying vec2 v_Image180ScaleAndCutoff;\r\nvarying vec4 v_Layout3DScaleAndOffset;\r\n\r\nvec2 ToRadialCoords(vec3 coords)\r\n{\r\n\tvec3 normalizedCoords = normalize(coords);\r\n\tfloat latitude = acos(normalizedCoords.y);\r\n\tfloat longitude = atan(normalizedCoords.z,normalizedCoords.x);\r\n\tvec2 sphereCoords = vec2(longitude, latitude) * vec2(0.5/PI, 1.0/PI);\r\n\treturn vec2(0.5,1.0) - sphereCoords;\r\n}\r\n\r\n\r\nvoid main()\r\n{\t\r\n\tvec2 tc = ToRadialCoords(v_Texcoord);\r\n\tif (tc.x > v_Image180ScaleAndCutoff.y)\r\n\t\tgl_FragColor=vec4(0,0,0,1);\r\n\ttc.x = mod(tc.x*v_Image180ScaleAndCutoff.x, 1.0);\r\n\ttc = (tc + v_Layout3DScaleAndOffset.xy) * v_Layout3DScaleAndOffset.zw;\r\n\r\n\tmediump vec4 tex = texture2D (u_Texture, tc);\r\n\tmediump vec3 c = decodeHDR (tex, u_TextureHDRParams.x);\r\n\tc = c * u_TintColor.rgb * 2.0;//Gamma Space is 2.0,linear space is 4.59479380\r\n\tgl_FragColor=vec4(c, 1.0);\r\n}\r\n\r\n')}get tintColor(){return this._shaderValues.getVector(e.TINTCOLOR)}set tintColor(t){this._shaderValues.setVector(e.TINTCOLOR,t)}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._textureDecodeFormat==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=e*t.BaseTexture._rgbmRange:this._textureHDRParams.x=e)}get rotation(){return this._shaderValues.getNumber(e.ROTATION)}set rotation(t){this._shaderValues.setNumber(e.ROTATION,t)}get panoramicTexture(){return this._shaderValues.getTexture(e.TEXTURE)}set panoramicTexture(t){this._shaderValues.setTexture(e.TEXTURE,t)}get panoramicTextureDecodeFormat(){return this._textureDecodeFormat}set panoramicTextureDecodeFormat(e){this._textureDecodeFormat!==e&&(this._textureDecodeFormat=e,e==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=this._exposure*t.BaseTexture._rgbmRange:this._textureHDRParams.x=this._exposure)}}return e.TINTCOLOR=Ae.propertyNameToID("u_TintColor"),e.EXPOSURE=Ae.propertyNameToID("u_Exposure"),e.ROTATION=Ae.propertyNameToID("u_Rotation"),e.TEXTURE=Ae.propertyNameToID("u_Texture"),e.TEXTURE_HDR_PARAMS=Ae.propertyNameToID("u_TextureHDRParams"),e})(),zi=(()=>{class e extends t.Component{constructor(e){super(),this._anchor=new a,this._connectAnchor=new a,this._feedbackEnabled=!1,this._getJointFeedBack=!1,this._currentForce=new a,this._currentTorque=new a,this._constraintType=e;var t=Z._bullet;this._btframATrans=t.btTransform_create(),this._btframBTrans=t.btTransform_create(),t.btTransform_setIdentity(this._btframATrans),t.btTransform_setIdentity(this._btframBTrans),this._btframAPos=t.btVector3_create(0,0,0),this._btframBPos=t.btVector3_create(0,0,0),t.btTransform_setOrigin(this._btframATrans,this._btframAPos),t.btTransform_setOrigin(this._btframBTrans,this._btframBPos),this._breakForce=-1,this._breakTorque=-1}get enabled(){return super.enabled}set enabled(e){super.enabled=e}get appliedImpulse(){return this._feedbackEnabled||(this._btConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._btConstraint.AppliedImpulse}set connectedBody(e){this._connectedBody=e,e.constaintRigidbodyB=this}get connectedBody(){return this._connectedBody}get ownBody(){return this._ownBody}set ownBody(e){this._ownBody=e,e.constaintRigidbodyA=this}get currentForce(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentForce}get currentTorque(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentTorque}get breakForce(){return this._breakForce}set breakForce(e){this._breakForce=e}get breakTorque(){return this._breakTorque}set breakTorque(e){this._breakTorque=e}set anchor(e){e.cloneTo(this._anchor),this.setFrames()}get anchor(){return this._anchor}set connectAnchor(e){e.cloneTo(this._connectAnchor),this.setFrames()}get connectAnchor(){return this._connectAnchor}setOverrideNumSolverIterations(e){Z._bullet.btTypedConstraint_setOverrideNumSolverIterations(this._btConstraint,e)}setConstraintEnabled(e){Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,e)}_onEnable(){super._onEnable(),this.enabled=!0}_onDisable(){super._onDisable(),this.enabled=!1}setFrames(){var e=Z._bullet;e.btVector3_setValue(this._btframAPos,-this._anchor.x,this.anchor.y,this.anchor.z),e.btVector3_setValue(this._btframBPos,-this._connectAnchor.x,this._connectAnchor.y,this._connectAnchor.z),e.btTransform_setOrigin(this._btframATrans,this._btframAPos),e.btTransform_setOrigin(this._btframBTrans,this._btframBPos)}_addToSimulation(){}_removeFromSimulation(){}_createConstraint(){}setConnectRigidBody(e,t){var r=e&&!!(e._simulation&&e._enabled&&e.colliderShape),i=t&&!!(t._simulation&&t._enabled&&t.colliderShape);if(!r||!i)throw"ownerRigid or connectRigidBody is not in Simulation";e==this._ownBody&&t==this._connectedBody||(!(!this.enabled||!this._simulation)&&this._removeFromSimulation(),this._ownBody=e,this._connectedBody=t,this._ownBody.constaintRigidbodyA=this,this._connectedBody.constaintRigidbodyB=this,this._createConstraint())}getcurrentForce(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=Z._bullet,r=t.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(r),t.btVector3_y(r),t.btVector3_z(r))}getcurrentTorque(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=Z._bullet,r=t.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(r),t.btVector3_y(r),t.btVector3_z(r))}_onDestroy(){var e=Z._bullet;this._removeFromSimulation(),this._btConstraint&&this._btJointFeedBackObj&&this._simulation&&(e.btTypedConstraint_destroy(this._btConstraint),e.btJointFeedback_destroy(this._btJointFeedBackObj),this._btJointFeedBackObj=null,this._btConstraint=null),super._onDisable()}_isBreakConstrained(){if(this._getJointFeedBack=!1,-1==this.breakForce&&-1==this.breakTorque)return!1;this._getFeedBackInfo();var e=-1!=this._breakForce&&a.scalarLength(this._currentForce)>this._breakForce,t=-1!=this._breakTorque&&a.scalarLength(this._currentTorque)>this._breakTorque;return!(!e&&!t)&&(this._breakConstrained(),!0)}_parse(e){this._anchor.fromArray(e.anchor),this._connectAnchor.fromArray(e.connectAnchor),this.setFrames()}_getFeedBackInfo(){var e=Z._bullet,t=e.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj),r=e.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);this._currentTorque.setValue(e.btVector3_x(r),e.btVector3_y(r),e.btVector3_z(r)),this._currentForce.setValue(e.btVector3_x(t),e.btVector3_y(t),e.btVector3_z(t)),this._getJointFeedBack=!0}_breakConstrained(){this.ownBody.constaintRigidbodyA=null,this.connectedBody.constaintRigidbodyB=null,this.destroy()}}return e.CONSTRAINT_POINT2POINT_CONSTRAINT_TYPE=3,e.CONSTRAINT_HINGE_CONSTRAINT_TYPE=4,e.CONSTRAINT_CONETWIST_CONSTRAINT_TYPE=5,e.CONSTRAINT_D6_CONSTRAINT_TYPE=6,e.CONSTRAINT_SLIDER_CONSTRAINT_TYPE=7,e.CONSTRAINT_CONTACT_CONSTRAINT_TYPE=8,e.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE=9,e.CONSTRAINT_GEAR_CONSTRAINT_TYPE=10,e.CONSTRAINT_FIXED_CONSTRAINT_TYPE=11,e.CONSTRAINT_MAX_CONSTRAINT_TYPE=12,e.CONSTRAINT_CONSTRAINT_ERP=1,e.CONSTRAINT_CONSTRAINT_STOP_ERP=2,e.CONSTRAINT_CONSTRAINT_CFM=3,e.CONSTRAINT_CONSTRAINT_STOP_CFM=4,e.tempForceV3=new a,e})();class Hi extends zi{constructor(){super(zi.CONSTRAINT_FIXED_CONSTRAINT_TYPE),this.breakForce=-1,this.breakTorque=-1}_addToSimulation(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}_removeFromSimulation(){this._simulation.removeConstraint(this),this._simulation=null}_createConstraint(){if(this.ownBody&&this.ownBody._simulation&&this.connectedBody&&this.connectedBody._simulation){var e=Z._bullet;this._btConstraint=e.btFixedConstraint_create(this.ownBody.btColliderObject,this._btframATrans,this.connectedBody.btColliderObject,this._btframBTrans),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._addToSimulation(),Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}}_onAdded(){super._onAdded()}_onEnable(){this._btConstraint&&(super._onEnable(),this._btConstraint&&Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}_onDisable(){super._onDisable(),this.connectedBody||this._removeFromSimulation(),this._btConstraint&&Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}_onDestroy(){super._onDestroy()}_parse(e,t=null){super._parse(e),-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}_parseInteractive(e=null,t=null){var r=t[e.rigidbodyID].getComponent(j),i=t[e.connectRigidbodyID].getComponent(j);this.ownBody=r,this.connectedBody=i}_cloneTo(e){}}let Wi=(()=>{class e extends zi{constructor(){super(zi.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE),this._axis=new a,this._secondaryAxis=new a,this._minLinearLimit=new a,this._maxLinearLimit=new a,this._minAngularLimit=new a,this._maxAngularLimit=new a,this._linearLimitSpring=new a,this._angularLimitSpring=new a,this._linearBounce=new a,this._angularBounce=new a,this._linearDamp=new a,this._angularDamp=new a,this._xMotion=0,this._yMotion=0,this._zMotion=0,this._angularXMotion=0,this._angularYMotion=0,this._angularZMotion=0;var e=Z._bullet;this._btAxis=e.btVector3_create(-1,0,0),this._btSecondaryAxis=e.btVector3_create(0,1,0)}get axis(){return this._axis}get secondaryAxis(){return this._secondaryAxis}set maxAngularLimit(e){e.cloneTo(this._maxAngularLimit)}set minAngularLimit(e){e.cloneTo(this._minAngularLimit)}get maxAngularLimit(){return this._maxAngularLimit}get minAngularLimit(){return this._minAngularLimit}set maxLinearLimit(e){e.cloneTo(this._maxLinearLimit)}set minLinearLimit(e){e.cloneTo(this._minLinearLimit)}get maxLinearLimit(){return this._maxLinearLimit}get minLinearLimit(){return this._minLinearLimit}set XMotion(t){this._xMotion!=t&&(this._xMotion=t,this.setLimit(e.MOTION_LINEAR_INDEX_X,t,-this._maxLinearLimit.x,-this._minLinearLimit.x))}get XMotion(){return this._xMotion}set YMotion(t){this._yMotion!=t&&(this._yMotion=t,this.setLimit(e.MOTION_LINEAR_INDEX_Y,t,this._minLinearLimit.y,this._maxLinearLimit.y))}get YMotion(){return this._yMotion}set ZMotion(t){this._zMotion!=t&&(this._zMotion=t,this.setLimit(e.MOTION_LINEAR_INDEX_Z,t,this._minLinearLimit.z,this._maxLinearLimit.z))}get ZMotion(){return this._zMotion}set angularXMotion(t){this._angularXMotion!=t&&(this._angularXMotion=t,this.setLimit(e.MOTION_ANGULAR_INDEX_X,t,-this._maxAngularLimit.x,-this._minAngularLimit.x))}get angularXMotion(){return this._angularXMotion}set angularYMotion(t){this._angularYMotion!=t&&(this._angularYMotion=t,this.setLimit(e.MOTION_ANGULAR_INDEX_Y,t,this._minAngularLimit.y,this._maxAngularLimit.y))}get angularYMotion(){return this._angularYMotion}set angularZMotion(t){this._angularZMotion!=t&&(this._angularZMotion=t,this.setLimit(e.MOTION_ANGULAR_INDEX_Z,t,this._minAngularLimit.z,this._maxAngularLimit.z))}get angularZMotion(){return this._angularZMotion}set linearLimitSpring(t){a.equals(this._linearLimitSpring,t)||(t.cloneTo(this._linearLimitSpring),this.setSpring(e.MOTION_LINEAR_INDEX_X,t.x),this.setSpring(e.MOTION_LINEAR_INDEX_Y,t.y),this.setSpring(e.MOTION_LINEAR_INDEX_Z,t.z))}get linearLimitSpring(){return this._linearLimitSpring}set angularLimitSpring(t){a.equals(this._angularLimitSpring,t)||(t.cloneTo(this._angularLimitSpring),this.setSpring(e.MOTION_ANGULAR_INDEX_X,t.x),this.setSpring(e.MOTION_ANGULAR_INDEX_Y,t.y),this.setSpring(e.MOTION_ANGULAR_INDEX_Z,t.z))}get angularLimitSpring(){return this._angularLimitSpring}set linearBounce(t){a.equals(this._linearBounce,t)||(t.cloneTo(this._linearBounce),this.setBounce(e.MOTION_LINEAR_INDEX_X,t.x),this.setBounce(e.MOTION_LINEAR_INDEX_Y,t.y),this.setBounce(e.MOTION_LINEAR_INDEX_Z,t.z))}get linearBounce(){return this._linearBounce}set angularBounce(t){a.equals(this._angularBounce,t)||(t.cloneTo(this._angularBounce),this.setBounce(e.MOTION_ANGULAR_INDEX_X,t.x),this.setBounce(e.MOTION_ANGULAR_INDEX_Y,t.y),this.setBounce(e.MOTION_ANGULAR_INDEX_Z,t.z))}get angularBounce(){return this._angularBounce}set linearDamp(t){a.equals(this._linearDamp,t)||(t.cloneTo(this._linearDamp),this.setDamping(e.MOTION_LINEAR_INDEX_X,t.x),this.setDamping(e.MOTION_LINEAR_INDEX_Y,t.y),this.setDamping(e.MOTION_LINEAR_INDEX_Z,t.z))}get linearDamp(){return this._linearDamp}set angularDamp(t){a.equals(this._angularDamp,t)||(t.cloneTo(this._angularDamp),this.setDamping(e.MOTION_ANGULAR_INDEX_X,t.x),this.setDamping(e.MOTION_ANGULAR_INDEX_Y,t.y),this.setDamping(e.MOTION_ANGULAR_INDEX_Z,t.z))}get angularDamp(){return this._angularDamp}set anchor(e){e.cloneTo(this._anchor),this.setFrames()}get anchor(){return this._anchor}set connectAnchor(e){e.cloneTo(this._connectAnchor),this.setFrames()}get connectAnchor(){return this._connectAnchor}setAxis(e,t){if(this._btConstraint){var r=Z._bullet;this._axis.setValue(e.x,e.y,e.y),this._secondaryAxis.setValue(t.x,t.y,t.z),this._btAxis=r.btVector3_setValue(-e.x,e.y,e.z),this._btSecondaryAxis=r.btVector3_setValue(-t.x,t.y,t.z),r.btGeneric6DofSpring2Constraint_setAxis(this._btConstraint,this._btAxis,this._btSecondaryAxis)}}setLimit(t,r,i,n){if(this._btConstraint){var a=Z._bullet;switch(r){case e.CONFIG_MOTION_TYPE_LOCKED:a.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,t,0,0);break;case e.CONFIG_MOTION_TYPE_LIMITED:i<n&&a.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,t,i,n);break;case e.CONFIG_MOTION_TYPE_FREE:a.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,t,1,0);break;default:throw"No Type of Axis Motion"}}}setSpring(e,t,r=!0){if(this._btConstraint){var i=Z._bullet,n=t>0;i.btGeneric6DofSpring2Constraint_enableSpring(this._btConstraint,e,n),n&&i.btGeneric6DofSpring2Constraint_setStiffness(this._btConstraint,e,t,r)}}setBounce(e,t){this._btConstraint&&(t=t<=0?0:t,Z._bullet.btGeneric6DofSpring2Constraint_setBounce(this._btConstraint,e,t))}setDamping(e,t,r=!0){this._btConstraint&&(t=t<=0?0:t,Z._bullet.btGeneric6DofSpring2Constraint_setDamping(this._btConstraint,e,t,r))}setEquilibriumPoint(e,t){Z._bullet.btGeneric6DofSpring2Constraint_setEquilibriumPoint(this._btConstraint,e,t)}enableMotor(e,t){Z._bullet.btGeneric6DofSpring2Constraint_enableMotor(this._btConstraint,e,t)}setServo(e,t){Z._bullet.btGeneric6DofSpring2Constraint_setServo(this._btConstraint,e,t)}setTargetVelocity(e,t){Z._bullet.btGeneric6DofSpring2Constraint_setTargetVelocity(this._btConstraint,e,t)}setTargetPosition(e,t){Z._bullet.btGeneric6DofSpring2Constraint_setServoTarget(this._btConstraint,e,t)}setMaxMotorForce(e,t){Z._bullet.btGeneric6DofSpring2Constraint_setMaxMotorForce(this._btConstraint,e,t)}setParam(e,t,r){Z._bullet.btTypedConstraint_setParam(this._btConstraint,e,t,r)}setFrames(){super.setFrames();var e=Z._bullet;this._btConstraint&&e.btGeneric6DofSpring2Constraint_setFrames(this._btConstraint,this._btframATrans,this._btframBTrans)}_addToSimulation(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}_removeFromSimulation(){this._simulation.removeConstraint(this),this._simulation=null}_createConstraint(){var t=Z._bullet;this._btConstraint=t.btGeneric6DofSpring2Constraint_create(this.ownBody.btColliderObject,this._btframAPos,this.connectedBody.btColliderObject,this._btframBPos,e.RO_XYZ),this._btJointFeedBackObj=t.btJointFeedback_create(this._btConstraint),t.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._initAllConstraintInfo(),this._addToSimulation(),Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}_initAllConstraintInfo(){this.setLimit(e.MOTION_LINEAR_INDEX_X,this._xMotion,-this._maxLinearLimit.x,-this._minLinearLimit.x),this.setLimit(e.MOTION_LINEAR_INDEX_Y,this._yMotion,this._minLinearLimit.y,this._maxLinearLimit.y),this.setLimit(e.MOTION_LINEAR_INDEX_Z,this._zMotion,this._minLinearLimit.z,this._maxLinearLimit.z),this.setLimit(e.MOTION_ANGULAR_INDEX_X,this._angularXMotion,-this._maxAngularLimit.x,-this._minAngularLimit.x),this.setLimit(e.MOTION_ANGULAR_INDEX_Y,this._angularYMotion,this._minAngularLimit.y,this._maxAngularLimit.y),this.setLimit(e.MOTION_ANGULAR_INDEX_Z,this._angularZMotion,this._minAngularLimit.z,this._maxAngularLimit.z),this.setSpring(e.MOTION_LINEAR_INDEX_X,this._linearLimitSpring.x),this.setSpring(e.MOTION_LINEAR_INDEX_Y,this._linearLimitSpring.y),this.setSpring(e.MOTION_LINEAR_INDEX_Z,this._linearLimitSpring.z),this.setSpring(e.MOTION_ANGULAR_INDEX_X,this._angularLimitSpring.x),this.setSpring(e.MOTION_ANGULAR_INDEX_Y,this._angularLimitSpring.y),this.setSpring(e.MOTION_ANGULAR_INDEX_Z,this._angularLimitSpring.z),this.setBounce(e.MOTION_LINEAR_INDEX_X,this._linearBounce.x),this.setBounce(e.MOTION_LINEAR_INDEX_Y,this._linearBounce.y),this.setBounce(e.MOTION_LINEAR_INDEX_Z,this._linearBounce.z),this.setBounce(e.MOTION_ANGULAR_INDEX_X,this._angularBounce.x),this.setBounce(e.MOTION_ANGULAR_INDEX_Y,this._angularBounce.y),this.setBounce(e.MOTION_ANGULAR_INDEX_Z,this._angularBounce.z),this.setDamping(e.MOTION_LINEAR_INDEX_X,this._linearDamp.x),this.setDamping(e.MOTION_LINEAR_INDEX_Y,this._linearDamp.y),this.setDamping(e.MOTION_LINEAR_INDEX_Z,this._linearDamp.z),this.setDamping(e.MOTION_ANGULAR_INDEX_X,this._angularDamp.x),this.setDamping(e.MOTION_ANGULAR_INDEX_Y,this._angularDamp.y),this.setDamping(e.MOTION_ANGULAR_INDEX_Z,this._angularDamp.z),this.setFrames(),this.setEquilibriumPoint(0,0)}_onAdded(){super._onAdded()}_onEnable(){this._btConstraint&&(super._onEnable(),this._btConstraint&&Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}_onDisable(){super._onDisable(),this.connectedBody||this._removeFromSimulation(),this._btConstraint&&Z._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}_parse(e,t=null){super._parse(e),this._axis.fromArray(e.axis),this._secondaryAxis.fromArray(e.secondaryAxis);var r=e.linearLimit;this._minLinearLimit.setValue(-r,-r,-r),this._maxLinearLimit.setValue(r,r,r);var i=e.linearLimitSpring;this._linearLimitSpring.setValue(i,i,i);var n=e.linearLimitDamper;this._linearDamp.setValue(n,n,n);var a=e.linearLimitBounciness;this._linearBounce.setValue(a,a,a);var s=e.lowAngularXLimit,o=e.highAngularXLimit,l=e.angularYLimit,_=e.angularZLimit;this._minAngularLimit.setValue(s,-l,-_),this._maxAngularLimit.setValue(o,l,_);var h=e.highAngularXLimitBounciness,c=e.angularYLimitBounciness,d=e.angularZLimitBounciness;this._angularBounce.setValue(h,c,d);var u=e.angularXLimitSpring,m=e.angularYZLimitSpring;this._angularLimitSpring.setValue(u,m,m);var f=e.angularXLimitDamper,T=e.angularYZLimitDamper;this._angularDamp.setValue(f,T,T),this.XMotion=e.xMotion,this.YMotion=e.yMotion,this.ZMotion=e.zMotion,this.angularXMotion=e.angularXMotion,this.angularYMotion=e.angularYMotion,this.angularZMotion=e.angularZMotion,-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}_parseInteractive(e=null,t=null){var r=t[e.rigidbodyID].getComponent(j),i=t[e.connectRigidbodyID].getComponent(j);this.ownBody=r,this.connectedBody=i}_onDestroy(){super._onDestroy()}_cloneTo(e){}}return e.CONFIG_MOTION_TYPE_LOCKED=0,e.CONFIG_MOTION_TYPE_LIMITED=1,e.CONFIG_MOTION_TYPE_FREE=2,e.MOTION_LINEAR_INDEX_X=0,e.MOTION_LINEAR_INDEX_Y=1,e.MOTION_LINEAR_INDEX_Z=2,e.MOTION_ANGULAR_INDEX_X=3,e.MOTION_ANGULAR_INDEX_Y=4,e.MOTION_ANGULAR_INDEX_Z=5,e.RO_XYZ=0,e.RO_XZY=1,e.RO_YXZ=2,e.RO_YZX=3,e.RO_ZXY=4,e.RO_ZYX=5,e})(),ki=(()=>{class r{constructor(){}static get enablePhysics(){return Z._enablePhysics}static _cancelLoadByUrl(e){t.Laya.loader.cancelLoadByUrl(e),r._innerFirstLevelLoaderManager.cancelLoadByUrl(e),r._innerSecondLevelLoaderManager.cancelLoadByUrl(e),r._innerThirdLevelLoaderManager.cancelLoadByUrl(e),r._innerFourthLevelLoaderManager.cancelLoadByUrl(e)}static _changeWebGLSize(e,r){t.WebGL.onStageResize(e,r),Ee.clientWidth=e,Ee.clientHeight=r}static __init__(i,n,a){if(t.Config.isAntialias=a.isAntialias,t.Config.isAlpha=a.isAlpha,t.Config.premultipliedAlpha=a.premultipliedAlpha,t.Config.isStencil=a.isStencil,t.WebGL.enable()){t.RunDriver.changeWebGLSize=r._changeWebGLSize,t.Render.is3DMode=!0,t.Laya.init(i,n),t.Render.supportWebGLPlusRendering||(t.LayaGL.instance=t.WebGLContext.mainContext,t.LayaGL.instance.createCommandEncoder=function(e=128,r=64,i=!1){return new t.CommandEncoder(this,e,r,i)}),a._multiLighting=a.enableMultiLight&&t.SystemUtils.supportTextureFormat(t.TextureFormat.R32G32B32A32),l.Shader3D=Ae,l.Scene3D=Tr,l.MeshRenderStaticBatchManager=er,l.MeshRenderDynamicBatchManager=Or,l.SubMeshDynamicBatch=Mr,l.Laya3D=r,l.Matrix4x4=h,l.Physics3D=Z,l.ShadowLightType=e.ShadowLightType,r.enableNative3D(),a.isUseCannonPhysicsEngine&&Z.__cannoninit__(),Z.__bulletinit__(),ot.__init__(),ht.__init__(),si.__init__(),oi.__init__(),wt.__init__(),gi.__init__(),Ii.__init__(),Xt.__init__(),qt.__init__(),Mr.__init__(),Ni.__init__(),Mt.init(),Ve.__init__(),vr.__init__(),Sr.__init__(),Gi.__init__(),Di.__init__(),Mi.__init__(),ft.__init__(),jt.__init__(),Nr.__init__(),fi.__init__(),di.__init__(),Ai.__init__(),xe.__init__(),Tr.__init__(),er.__init__(),De.__initDefine__(),Me.__initDefine__(),Ne.__initDefine__(),Ir.__initDefine__(),xr.__initDefine__(),Ti.__initDefine__(),be.__initDefine__(),Cr.__initDefine__(),ii.__initDefine__(),Pe.__initDefine__(),zt.__initDefine__(),Ar.__initDefine__(),St.__init__(),t.ClassUtils.regClass("Laya.SkyPanoramicMaterial",Gi),t.ClassUtils.regClass("Laya.EffectMaterial",be),t.ClassUtils.regClass("Laya.UnlitMaterial",xr),t.ClassUtils.regClass("Laya.BlinnPhongMaterial",Ne),t.ClassUtils.regClass("Laya.SkyProceduralMaterial",Ir),t.ClassUtils.regClass("Laya.PBRStandardMaterial",vr),t.ClassUtils.regClass("Laya.PBRSpecularMaterial",Sr),t.ClassUtils.regClass("Laya.SkyBoxMaterial",Ar),t.ClassUtils.regClass("Laya.WaterPrimaryMaterial",Cr),t.ClassUtils.regClass("Laya.ExtendTerrainMaterial",Pe),t.ClassUtils.regClass("Laya.ShurikenParticleMaterial",ii),t.ClassUtils.regClass("Laya.TrailMaterial",Ti),t.ClassUtils.regClass("Laya.PhysicsCollider",Ci),t.ClassUtils.regClass("Laya.Rigidbody3D",j),t.ClassUtils.regClass("Laya.CharacterController",X),t.ClassUtils.regClass("Laya.Animator",fe),t.ClassUtils.regClass("PhysicsCollider",Ci),t.ClassUtils.regClass("CharacterController",X),t.ClassUtils.regClass("Animator",fe),t.ClassUtils.regClass("Rigidbody3D",j),t.ClassUtils.regClass("FixedConstraint",Hi),t.ClassUtils.regClass("ConfigurableConstraint",Wi),zt.defaultMaterial=new zt,Ne.defaultMaterial=new Ne,be.defaultMaterial=new be,xr.defaultMaterial=new xr,ii.defaultMaterial=new ii,Ti.defaultMaterial=new Ti,Ir.defaultMaterial=new Ir,Ar.defaultMaterial=new Ar,Cr.defaultMaterial=new Cr,zt.defaultMaterial.lock=!0,Ne.defaultMaterial.lock=!0,be.defaultMaterial.lock=!0,xr.defaultMaterial.lock=!0,ii.defaultMaterial.lock=!0,Ti.defaultMaterial.lock=!0,Ir.defaultMaterial.lock=!0,Ar.defaultMaterial.lock=!0,Cr.defaultMaterial.lock=!0,t.Texture2D.__init__(),Bt.__init__(),ut.__init__(),Vt.__init__(),pt.__init__(),gt.__init__(),We.__init__(),ne.__init__();var s=t.LoaderManager.createMap;s.lh=[r.HIERARCHY,Vi._parse],s.ls=[r.HIERARCHY,Vi._parseScene],s.lm=[r.MESH,Ui._parse],s.lmat=[r.MATERIAL,De._parse],s.jpg=[r.TEXTURE2D,t.Texture2D._parse],s.jpeg=[r.TEXTURE2D,t.Texture2D._parse],s.bmp=[r.TEXTURE2D,t.Texture2D._parse],s.gif=[r.TEXTURE2D,t.Texture2D._parse],s.png=[r.TEXTURE2D,t.Texture2D._parse],s.dds=[r.TEXTURE2D,t.Texture2D._parse],s.ktx=[r.TEXTURE2D,t.Texture2D._parse],s.pvr=[r.TEXTURE2D,t.Texture2D._parse],s.lani=[r.ANIMATIONCLIP,oe._parse],s.lav=[r.AVATAR,ye._parse],s.ltc=[r.TEXTURECUBE,Bt._parse],s.ltcb=[r.TEXTURECUBEBIN,Bt._parseBin];var o=t.Loader.parserMap;o[r.HIERARCHY]=r._loadHierarchy,o[r.MESH]=r._loadMesh,o[r.MATERIAL]=r._loadMaterial,o[r.TEXTURECUBE]=r._loadTextureCube,o[r.TEXTURECUBEBIN]=r._loadTextureCubeBin,o[r.TEXTURE2D]=r._loadTexture2D,o[r.ANIMATIONCLIP]=r._loadAnimationClip,o[r.AVATAR]=r._loadAvatar,r._innerFirstLevelLoaderManager.on(t.Event.ERROR,null,r._eventLoadManagerError),r._innerSecondLevelLoaderManager.on(t.Event.ERROR,null,r._eventLoadManagerError),r._innerThirdLevelLoaderManager.on(t.Event.ERROR,null,r._eventLoadManagerError),r._innerFourthLevelLoaderManager.on(t.Event.ERROR,null,r._eventLoadManagerError)}else alert("Laya3D init error,must support webGL!")}static enableNative3D(){var e=Ie,r=Be,i=mi,n=ye,a=We;if(t.Render.supportWebGLPlusRendering&&(e.prototype._initData=e.prototype._initDataForNative,e.prototype.setBool=e.prototype.setBoolForNative,e.prototype.getBool=e.prototype.getBoolForNative,e.prototype.setInt=e.prototype.setIntForNative,e.prototype.getInt=e.prototype.getIntForNative,e.prototype.setNumber=e.prototype.setNumberForNative,e.prototype.getNumber=e.prototype.getNumberForNative,e.prototype.setVector=e.prototype.setVectorForNative,e.prototype.getVector=e.prototype.getVectorForNative,e.prototype.setVector2=e.prototype.setVector2ForNative,e.prototype.getVector2=e.prototype.getVector2ForNative,e.prototype.setVector3=e.prototype.setVector3ForNative,e.prototype.getVector3=e.prototype.getVector3ForNative,e.prototype.setQuaternion=e.prototype.setQuaternionForNative,e.prototype.getQuaternion=e.prototype.getQuaternionForNative,e.prototype.setMatrix4x4=e.prototype.setMatrix4x4ForNative,e.prototype.getMatrix4x4=e.prototype.getMatrix4x4ForNative,e.prototype.setBuffer=e.prototype.setBufferForNative,e.prototype.getBuffer=e.prototype.getBufferForNative,e.prototype.setTexture=e.prototype.setTextureForNative,e.prototype.getTexture=e.prototype.getTextureForNative,e.prototype.setAttribute=e.prototype.setAttributeForNative,e.prototype.getAttribute=e.prototype.getAttributeForNative,e.prototype.cloneTo=e.prototype.cloneToForNative,e.prototype.getData=e.prototype.getDataForNative,r.prototype._uniformMatrix2fv=r.prototype._uniformMatrix2fvForNative,r.prototype._uniformMatrix3fv=r.prototype._uniformMatrix3fvForNative,r.prototype._uniformMatrix4fv=r.prototype._uniformMatrix4fvForNative,t.LayaGLRunner.uploadShaderUniforms=t.LayaGLRunner.uploadShaderUniformsForNative),t.Render.supportWebGLPlusCulling&&(a.renderObjectCulling=We.renderObjectCullingNative),t.Render.supportWebGLPlusAnimation){n.prototype._cloneDatasToAnimator=n.prototype._cloneDatasToAnimatorNative;var s=oe;s.prototype._evaluateClipDatasRealTime=s.prototype._evaluateClipDatasRealTimeForNative,i.prototype._computeSkinnedData=i.prototype._computeSkinnedDataForNative}}static formatRelativePath(e,t){var r;if(r=e+t,"."===t.charAt(0)){for(var i=r.split("/"),n=0,a=i.length;n<a;n++)if(".."==i[n]){var s=n-1;s>0&&".."!==i[s]&&(i.splice(s,2),n-=2)}r=i.join("/")}return r}static _endLoad(e,r=null,i=null){if(i)for(var n=0,a=i.length;n<a;n++){var s=t.Loader.getRes(i[n]);s&&s._removeReference()}e.endLoad(r)}static _eventLoadManagerError(e){t.Laya.loader.event(t.Event.ERROR,e)}static _addHierarchyInnerUrls(e,t,i,n,a,s,o=null,l=null){var _=r.formatRelativePath(n,a);return i&&(_+=i),e.push({url:_,type:s,constructParams:o,propertyParams:l}),t.push(_),_}static _getSprite3DHierarchyInnerUrls(e,t,i,n,a,s,o,l){var _,h,c=e.props;switch(e.type){case"Scene3D":var d=c.lightmaps;for(_=0,h=d.length;_<h;_++){var u=d[_];if(u.path)u.path=r._addHierarchyInnerUrls(a,s,o,l,u.path,r.TEXTURE2D,u.constructParams,u.propertyParams);else{var m=u.color;m.path=r._addHierarchyInnerUrls(a,s,o,l,m.path,r.TEXTURE2D,m.constructParams,m.propertyParams);var f=u.direction;f&&(f.path=r._addHierarchyInnerUrls(a,s,o,l,f.path,r.TEXTURE2D,f.constructParams,f.propertyParams))}}var T=c.reflectionTexture;T&&(c.reflection=r._addHierarchyInnerUrls(n,s,o,l,T,r.TEXTURECUBE));var E=c.reflection;if(E&&(c.reflection=r._addHierarchyInnerUrls(a,s,o,l,E,r.TEXTURECUBEBIN)),c.sky){var p=c.sky.material;p&&(p.path=r._addHierarchyInnerUrls(i,s,o,l,p.path,r.MATERIAL))}break;case"Camera":var g=c.skyboxMaterial;g&&(g.path=r._addHierarchyInnerUrls(i,s,o,l,g.path,r.MATERIAL));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":var S=c.meshPath;S&&(c.meshPath=r._addHierarchyInnerUrls(t,s,o,l,S,r.MESH));var R=c.materials;if(R)for(_=0,h=R.length;_<h;_++)R[_].path=r._addHierarchyInnerUrls(i,s,o,l,R[_].path,r.MATERIAL);break;case"ShuriKenParticle3D":if(c.main){var v=c.renderer.resources,A=v.mesh,I=v.material;A&&(v.mesh=r._addHierarchyInnerUrls(t,s,o,l,A,r.MESH)),I&&(v.material=r._addHierarchyInnerUrls(i,s,o,l,I,r.MATERIAL))}else{var x=c.meshPath;x&&(c.meshPath=r._addHierarchyInnerUrls(t,s,o,l,x,r.MESH)),c.material.path=r._addHierarchyInnerUrls(i,s,o,l,c.material.path,r.MATERIAL)}break;case"Terrain":r._addHierarchyInnerUrls(a,s,o,l,c.dataPath,r.TERRAINRES)}var C=e.components;if(C)for(var L=0,y=C.length;L<y;L++){var D=C[L];switch(D.type){case"Animator":D.avatarPath;var M=D.avatar;M&&(M.path=r._addHierarchyInnerUrls(a,s,o,l,M.path,r.AVATAR));var O=D.clipPaths;if(O)for(_=0,h=O.length;_<h;_++)O[_]=r._addHierarchyInnerUrls(a,s,o,l,O[_],r.ANIMATIONCLIP);else{var N=D.layers;for(_=0;_<N.length;_++)for(var b=N[_].states,P=0,w=b.length;P<w;P++){var V=b[P].clipPath;V&&(b[P].clipPath=r._addHierarchyInnerUrls(a,s,o,l,V,r.ANIMATIONCLIP))}}break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var F=D.shapes;for(_=0;_<F.length;_++){var B=F[_];if("MeshColliderShape"===B.type)(A=B.mesh)&&(B.mesh=r._addHierarchyInnerUrls(t,s,o,l,A,r.MESH))}}}var U=e.child;for(_=0,h=U.length;_<h;_++)r._getSprite3DHierarchyInnerUrls(U[_],t,i,n,a,s,o,l)}static _loadHierarchy(e){e.on(t.Event.LOADED,null,r._onHierarchylhLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}static _onHierarchylhLoaded(e,i){var n=e.url,a=k.getURLVerion(n),s=t.URL.getPath(n),o=[],l=[],_=[],h=[],c=[];r._getSprite3DHierarchyInnerUrls(i.data,o,l,_,h,c,a,s);var d=o.length+l.length+h.length,u=d+1,m=1/u;if(r._onProcessChange(e,0,m,1),h.length>0){var f=d/u,T=t.Handler.create(null,r._onProcessChange,[e,m,f],!1);r._innerFourthLevelLoaderManager._create(h,!1,t.Handler.create(null,r._onHierarchyInnerForthLevResouLoaded,[e,T,i,c,o,l,_,m+f*h.length,f]),T,null,null,null,1,!0)}else r._onHierarchyInnerForthLevResouLoaded(e,null,i,c,o,l,_,m,f)}static _onHierarchyInnerForthLevResouLoaded(e,i,n,a,s,o,l,_,h){if(i&&i.recover(),l.length>0){var c=t.Handler.create(null,r._onProcessChange,[e,_,h],!1);r._innerThirdLevelLoaderManager._create(l,!1,t.Handler.create(null,r._onHierarchyInnerThirdLevResouLoaded,[e,c,n,a,s,o,_+h*o.length,h]),i,null,null,null,1,!0)}else r._onHierarchyInnerThirdLevResouLoaded(e,null,n,a,s,o,_,h)}static _onHierarchyInnerThirdLevResouLoaded(e,i,n,a,s,o,l,_){if(i&&i.recover(),o.length>0){var h=t.Handler.create(null,r._onProcessChange,[e,l,_],!1);r._innerSecondLevelLoaderManager._create(o,!1,t.Handler.create(null,r._onHierarchyInnerSecondLevResouLoaded,[e,h,n,a,s,l+_*o.length,_]),i,null,null,null,1,!0)}else r._onHierarchyInnerSecondLevResouLoaded(e,null,n,a,s,l,_)}static _onHierarchyInnerSecondLevResouLoaded(e,i,n,a,s,o,l){if(i&&i.recover(),s.length>0){var _=t.Handler.create(null,r._onProcessChange,[e,o,l],!1);r._innerFirstLevelLoaderManager._create(s,!1,t.Handler.create(null,r._onHierarchyInnerFirstLevResouLoaded,[e,_,n,a]),i,null,null,null,1,!0)}else r._onHierarchyInnerFirstLevResouLoaded(e,null,n,a)}static _onHierarchyInnerFirstLevResouLoaded(e,t,i,n){t&&t.recover(),e._cache=e._createCache;var a="Scene3D"===i.data.type?Vi._parseScene(i,e._propertyParams,e._constructParams):Vi._parse(i,e._propertyParams,e._constructParams);r._endLoad(e,a,n)}static _loadMesh(e){e.on(t.Event.LOADED,null,r._onMeshLmLoaded,[e]),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}static _onMeshLmLoaded(e,t){e._cache=e._createCache;var i=Ui._parse(t,e._propertyParams,e._constructParams);r._endLoad(e,i)}static _loadMaterial(e){e.on(t.Event.LOADED,null,r._onMaterilLmatLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}static _onMaterilLmatLoaded(e,i){var n,a=e.url,s=k.getURLVerion(a),o=t.URL.getPath(a),l=[],_=[];i.customProps;switch(i.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var h,c,d=i.props.textures;if(d)for(h=0,c=d.length;h<c;h++){var u=d[h],m=u.path;m&&(n=r.formatRelativePath(o,m),s&&(n+=s),l.push({url:n,constructParams:u.constructParams,propertyParams:u.propertyParams}),_.push(n),u.path=n)}break;default:throw new Error("Laya3D:unkonwn version.")}var f=l.length,T=f+1,E=1/T;if(r._onProcessChange(e,0,E,1),f>0){var p=t.Handler.create(null,r._onProcessChange,[e,E,f/T],!1);r._innerFourthLevelLoaderManager._create(l,!1,t.Handler.create(null,r._onMateialTexturesLoaded,[e,p,i,_]),p,null,null,null,1,!0)}else r._onMateialTexturesLoaded(e,null,i,null)}static _onMateialTexturesLoaded(e,t,i,n){e._cache=e._createCache;var a=De._parse(i,e._propertyParams,e._constructParams);r._endLoad(e,a,n),t&&t.recover()}static _loadAvatar(e){e.on(t.Event.LOADED,null,(function(t){e._cache=e._createCache;var i=ye._parse(t,e._propertyParams,e._constructParams);r._endLoad(e,i)})),e.load(e.url,t.Loader.JSON,!1,null,!0)}static _loadAnimationClip(e){e.on(t.Event.LOADED,null,(function(t){e._cache=e._createCache;var i=oe._parse(t,e._propertyParams,e._constructParams);r._endLoad(e,i)})),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}static _loadTexture2D(e){var i,n=e.url,a=n.lastIndexOf(".")+1,s=n.indexOf("?"),o=-1==s?n.length:s;switch(n.substr(a,o-a)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":i="nativeimage";break;case"dds":case"ktx":case"pvr":i=t.Loader.BUFFER}e.on(t.Event.LOADED,null,(function(i){e._cache=e._createCache;var n=t.Texture2D._parse(i,e._propertyParams,e._constructParams);r._endLoad(e,n)})),e.load(e.url,i,!1,null,!0)}static _loadTextureCube(e){e.on(t.Event.LOADED,null,r._onTextureCubeLtcLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}static _loadTextureCubeBin(e){e.on(t.Event.LOADED,null,i=>{e._cache=e._createCache;var n=new t.Byte(i);if("LAYATEXTURECUBE:0000"!==n.readUTFString())throw"Laya3D:unknow version.";var a=n.readUint8(),s=n.getUint8(),o=n.readUint16(),l=n.getUint8(),_=n.getUint8(),h=n.getUint8(),c=n.getUint8(),d=new Bt(o,a,s>1);d.filterMode=l,d.wrapModeU=_,d.wrapModeV=h,d.anisoLevel=c;for(var u=n.pos,m=o,f=0;f<s;f++){for(var T=new Array(6),E=m*m*d._getFormatByteCount(),p=0;p<6;p++)T[p]=new Uint8Array(i,u,E),u+=E;d.setSixSidePixels(T,f),m/=2}r._endLoad(e,d)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}static _onTextureCubeLtcLoaded(e,i){var n=t.URL.getPath(e.url),a=[r.formatRelativePath(n,i.front),r.formatRelativePath(n,i.back),r.formatRelativePath(n,i.left),r.formatRelativePath(n,i.right),r.formatRelativePath(n,i.up),r.formatRelativePath(n,i.down)];r._onProcessChange(e,0,1/7,1);var s=t.Handler.create(null,r._onProcessChange,[e,1/7,6/7],!1);r._innerFourthLevelLoaderManager.load(a,t.Handler.create(null,r._onTextureCubeImagesLoaded,[e,a,s]),s,"nativeimage")}static _onTextureCubeImagesLoaded(e,i,n){for(var a=new Array(6),s=0;s<6;s++)a[s]=t.Loader.getRes(i[s]);e._cache=e._createCache;var o=Bt._parse(a,e._propertyParams,e._constructParams);for(n.recover(),s=0;s<6;s++)t.Loader.clearRes(i[s]);r._endLoad(e,o)}static _onProcessChange(e,r,i,n){(n=r+n*i)<1&&e.event(t.Event.PROGRESS,n)}static init(e,t,i=null,n=null){if(r._isInit)n&&n.run();else{r._isInit=!0,i&&i.cloneTo(Q._config),i=Q._config,We.debugFrustumCulling=i.debugFrustumCulling,r._editerEnvironment=i._editerEnvironment,Tr.octreeCulling=i.octreeCulling,Tr.octreeInitialSize=i.octreeInitialSize,Tr.octreeInitialCenter=i.octreeInitialCenter,Tr.octreeMinNodeSize=i.octreeMinNodeSize,Tr.octreeLooseness=i.octreeLooseness;var a=window.Physics3D;null==a||i.isUseCannonPhysicsEngine?(Z._enablePhysics=!1,r.__init__(e,t,i),n&&n.run()):(Z._enablePhysics=!0,a(16*i.defaultPhysicsMemory,xi._interactive).then((function(){r.__init__(e,t,i),n&&n.run()})))}}}return r.HIERARCHY="HIERARCHY",r.MESH="MESH",r.MATERIAL="MATERIAL",r.TEXTURE2D="TEXTURE2D",r.TEXTURECUBE="TEXTURECUBE",r.TEXTURECUBEBIN="TEXTURECUBEBIN",r.ANIMATIONCLIP="ANIMATIONCLIP",r.AVATAR="AVATAR",r.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",r.TERRAINRES="TERRAIN",r._innerFirstLevelLoaderManager=new t.LoaderManager,r._innerSecondLevelLoaderManager=new t.LoaderManager,r._innerThirdLevelLoaderManager=new t.LoaderManager,r._innerFourthLevelLoaderManager=new t.LoaderManager,r._isInit=!1,r._editerEnvironment=!1,r.physicsSettings=new Pt,r})();window.Laya3D=ki;class Xi extends t.Component{constructor(){super(...arguments),this._indexInPool=-1}get isSingleton(){return!1}_checkProcessTriggers(){var e=Xi.prototype;return this.onTriggerEnter!==e.onTriggerEnter||(this.onTriggerStay!==e.onTriggerStay||this.onTriggerExit!==e.onTriggerExit)}_checkProcessCollisions(){var e=Xi.prototype;return this.onCollisionEnter!==e.onCollisionEnter||(this.onCollisionStay!==e.onCollisionStay||this.onCollisionExit!==e.onCollisionExit)}_onAwake(){this.onAwake(),this.onStart!==Xi.prototype.onStart&&t.Laya.startTimer.callLater(this,this.onStart)}_onEnable(){this.owner._scene._addScript(this),this.onEnable()}_onDisable(){this.owner._scene._removeScript(this),this.owner.offAllCaller(this),this.onDisable()}_onDestroy(){var e=this.owner._scripts;e.splice(e.indexOf(this),1);var t=this.owner;t._needProcessTriggers=!1;for(var r=0,i=e.length;r<i;r++)if(e[r]._checkProcessTriggers()){t._needProcessTriggers=!0;break}for(t._needProcessCollisions=!1,r=0,i=e.length;r<i;r++)if(e[r]._checkProcessCollisions()){t._needProcessCollisions=!0;break}this.onDestroy()}_isScript(){return!0}_onAdded(){var e=this.owner,t=e._scripts;t||(e._scripts=t=[]),t.push(this),e._needProcessCollisions||(e._needProcessCollisions=this._checkProcessCollisions()),e._needProcessTriggers||(e._needProcessTriggers=this._checkProcessTriggers())}onAwake(){}onEnable(){}onStart(){}onTriggerEnter(e){}onTriggerStay(e){}onTriggerExit(e){}onCollisionEnter(e){}onCollisionStay(e){}onCollisionExit(e){}onJointBreak(){}onMouseDown(){}onMouseDrag(){}onMouseClick(){}onMouseUp(){}onMouseEnter(){}onMouseOver(){}onMouseOut(){}onUpdate(){}onLateUpdate(){}onPreRender(){}onPostRender(){}onDisable(){}onDestroy(){}}let Yi=(()=>{class e{constructor(e,t,r,i){this._datas=[],this._w=e,this._h=t,this._minHeight=r,this._maxHeight=i}static creatFromMesh(t,r,i,n){for(var s=[],o=[],l=t.subMeshCount,_=0;_<l;_++){for(var h=t.getSubMesh(_),c=h._vertexBuffer,d=c.getFloat32Data(),u=[],m=0;m<d.length;m+=c.vertexDeclaration.vertexStride/4){var f=new a(d[m+0],d[m+1],d[m+2]);u.push(f)}s.push(u);var T=h._indexBuffer;o.push(T.getData())}var E=t.bounds,p=E.getMin().x,g=E.getMin().z,S=E.getMax().x,R=E.getMax().z,v=E.getMin().y,A=E.getMax().y,I=S-p,x=R-g,C=n.x=I/(r-1),L=n.y=x/(i-1),y=new e(r,i,v,A),D=e._tempRay,M=D.direction;M.x=0,M.y=-1,M.z=0;var O=A+.1;D.origin.y=O;for(var N=0;N<i;N++){var b=g+N*L;y._datas[N]=[];for(var P=0;P<r;P++){var w=p+P*C,V=D.origin;V.x=w,V.z=b;var F=e._getPosition(D,s,o);y._datas[N][P]=F===Number.MAX_VALUE?NaN:O-F}}return y}static createFromImage(t,r,i){for(var n=t.width,a=t.height,s=new e(n,a,r,i),o=(i-r)/254,l=t.getPixels(),_=0,h=0;h<a;h++)for(var c=s._datas[h]=[],d=0;d<n;d++){var u=l[_++],m=l[_++],f=l[_++],T=l[_++];c[d]=255==u&&255==m&&255==f&&255==T?NaN:(u+m+f)/3*o+r}return s}static _getPosition(e,t,r){for(var i=Number.MAX_VALUE,n=0;n<t.length;n++)for(var a=t[n],s=r[n],o=0;o<s.length;o+=3){var l=a[s[o+0]],_=a[s[o+1]],h=a[s[o+2]],c=it.rayIntersectsTriangle(e,l,_,h);!isNaN(c)&&c<i&&(i=c)}return i}get width(){return this._w}get height(){return this._h}get maxHeight(){return this._maxHeight}get minHeight(){return this._minHeight}_inBounds(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w}getHeight(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN}}return e._tempRay=new Ke(new a,new a),e})(),ji=(()=>{class e extends Nr{constructor(e,t,r=null){super(e,r),this._heightMap=t,this._cellSize=new i}static createFromMesh(t,r,i,n=null){var a=new e(t,null,n);return a._initCreateFromMesh(r,i),a}static createFromMeshAndHeightMap(t,r,i,n,a=null){var s=new e(t,null,a);return s._initCreateFromMeshHeightMap(r,i,n),s}get minX(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}get minZ(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}get width(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}get depth(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}_disableRotation(){var e=this.transform.rotation;e.x=0,e.y=0,e.z=0,e.w=1,this.transform.rotation=e}_getScaleX(){var e=this.transform.worldMatrix.elements,t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)}_getScaleZ(){var e=this.transform.worldMatrix.elements,t=e[8],r=e[9],i=e[10];return Math.sqrt(t*t+r*r+i*i)}_initCreateFromMesh(e,t){this._heightMap=Yi.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var r=this.meshFilter.sharedMesh.bounds,i=r.getMin();r.getMax();this._minX=i.x,this._minZ=i.z}_initCreateFromMeshHeightMap(e,t,r){var i=this.meshFilter.sharedMesh.bounds;this._heightMap=Yi.createFromImage(e,t,r),this._computeCellSize(i);var n=i.getMin();i.getMax();this._minX=n.x,this._minZ=n.z}_computeCellSize(e){var t=e.getMin(),r=e.getMax(),i=t.x,n=t.z,a=r.x-i,s=r.z-n;this._cellSize.x=a/(this._heightMap.width-1),this._cellSize.y=s/(this._heightMap.height-1)}_update(e){this._disableRotation()}getHeight(t,r){e._tempVector3.x=t,e._tempVector3.y=0,e._tempVector3.z=r,this._disableRotation();var i=this.transform.worldMatrix;i.invert(e._tempMatrix4x4),a.transformCoordinate(e._tempVector3,e._tempMatrix4x4,e._tempVector3),t=e._tempVector3.x,r=e._tempVector3.z;var n=(t-this._minX)/this._cellSize.x,s=(r-this._minZ)/this._cellSize.y,o=Math.floor(s),l=Math.floor(n),_=n-l,h=s-o,c=i.elements,d=c[4],u=c[5],m=c[6],f=Math.sqrt(d*d+u*u+m*m),T=c[13],E=this._heightMap.getHeight(o,l+1),p=this._heightMap.getHeight(o+1,l);if(isNaN(E)||isNaN(p))return NaN;if(_+h<=1){var g=this._heightMap.getHeight(o,l);return isNaN(g)?NaN:(g+_*(E-g)+h*(p-g))*f+T}var S=this._heightMap.getHeight(o+1,l+1);return isNaN(S)?NaN:(S+(1-_)*(p-S)+(1-h)*(E-S))*f+T}}return e._tempVector3=new a,e._tempMatrix4x4=new h,e})();class Zi{constructor(){this._currentLength=0,this._elements=new Float32Array(12)}get gradientCount(){return this._currentLength/3}add(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")}cloneTo(e){var t=e;t._currentLength=this._currentLength;for(var r=t._elements,i=0,n=this._elements.length;i<n;i++)r[i]=this._elements[i]}clone(){var e=new Zi;return this.cloneTo(e),e}}class qi{constructor(){}render(e){}}let Qi=(()=>{class e extends qi{constructor(){super(),this._shader=null,this._shaderData=new Ie,this._linearColor=new Ge,this._bloomTextureTexelSize=new n,this._shaderThreshold=new n,this._shaderParams=new n,this._pyramid=null,this._intensity=0,this._threshold=1,this._softKnee=.5,this._diffusion=7,this._anamorphicRatio=0,this._dirtIntensity=0,this._shaderSetting=new n,this._dirtTileOffset=new n,this.clamp=65472,this.color=new Ge(1,1,1,1),this.fastMode=!1,this.dirtTexture=null,this._shader=Ae.find("PostProcessBloom"),this._pyramid=new Array(2*e.MAXPYRAMIDSIZE)}get intensity(){return this._intensity}set intensity(e){this._intensity=Math.max(e,0)}get threshold(){return this._threshold}set threshold(e){this._threshold=Math.max(e,0)}get softKnee(){return this._softKnee}set softKnee(e){this._softKnee=Math.min(Math.max(e,0),1)}get diffusion(){return this._diffusion}set diffusion(e){this._diffusion=Math.min(Math.max(e,1),10)}get anamorphicRatio(){return this._anamorphicRatio}set anamorphicRatio(e){this._anamorphicRatio=Math.min(Math.max(e,-1),1)}get dirtIntensity(){return this._dirtIntensity}set dirtIntensity(e){this._dirtIntensity=Math.max(e,0)}render(r){var i=r.command,a=r.camera.viewport;this._shaderData.setTexture(e.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);var s,o=this._anamorphicRatio,l=o<0?-o:0,_=o>0?o:0,h=Math.floor(a.width/(2-l)),c=Math.floor(a.height/(2-_)),d=Math.max(h,c);s=Math.log2(d)+this._diffusion-10;var u=Math.floor(s),m=Math.min(Math.max(u,1),e.MAXPYRAMIDSIZE),f=.5+s-u;this._shaderData.setNumber(e.SHADERVALUE_SAMPLESCALE,f);var T=Ge.gammaToLinearSpace(this.threshold),E=T*this._softKnee+1e-5;this._shaderThreshold.setValue(T,T-E,2*E,.25/E),this._shaderData.setVector(e.SHADERVALUE_THRESHOLD,this._shaderThreshold);var p=Ge.gammaToLinearSpace(this.clamp);this._shaderParams.setValue(p,0,0,0),this._shaderData.setVector(e.SHADERVALUE_PARAMS,this._shaderParams);for(var g=this.fastMode?1:0,S=r.source,R=0;R<m;R++){var v=2*R,A=v+1,I=0==R?e.SUBSHADER_PREFILTER13+g:e.SUBSHADER_DOWNSAMPLE13+g,x=pe.createFromPool(h,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);if(x.filterMode=t.FilterMode.Bilinear,this._pyramid[v]=x,R!==m-1){var C=pe.createFromPool(h,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);C.filterMode=t.FilterMode.Bilinear,this._pyramid[A]=C}i.blitScreenTriangle(S,x,null,this._shader,this._shaderData,I),S=x,h=Math.max(Math.floor(h/2),1),c=Math.max(Math.floor(c/2),1)}var L=this._pyramid[2*(m-1)];for(R=m-2;R>=0;R--)A=(v=2*R)+1,x=this._pyramid[v],C=this._pyramid[A],i.setShaderDataTexture(this._shaderData,e.SHADERVALUE_BLOOMTEX,x),i.blitScreenTriangle(L,C,null,this._shader,this._shaderData,e.SUBSHADER_UPSAMPLETENT+g),L=C;var y=this._linearColor;this.color.toLinear(y);var D=Math.pow(2,this._intensity/10)-1,M=this._shaderSetting;this._shaderSetting.setValue(f,D,this._dirtIntensity,m);var O=this.dirtTexture?this.dirtTexture:t.Texture2D.blackTexture,N=O.width/O.height,b=a.width/a.height,P=this._dirtTileOffset;N>b?P.setValue(b/N,1,.5*(1-P.x),0):N<b&&P.setValue(1,N/b,0,.5*(1-P.y));var w=r.compositeShaderData;for(this.fastMode?w.addDefine(xe.SHADERDEFINE_BLOOM_LOW):w.addDefine(xe.SHADERDEFINE_BLOOM),this._bloomTextureTexelSize.setValue(1/L.width,1/L.height,L.width,L.height),w.setVector(xe.SHADERVALUE_BLOOM_DIRTTILEOFFSET,P),w.setVector(xe.SHADERVALUE_BLOOM_SETTINGS,M),w.setVector(xe.SHADERVALUE_BLOOM_COLOR,new n(y.r,y.g,y.b,y.a)),w.setTexture(xe.SHADERVALUE_BLOOM_DIRTTEX,O),w.setTexture(xe.SHADERVALUE_BLOOMTEX,L),w.setVector(xe.SHADERVALUE_BLOOMTEX_TEXELSIZE,this._bloomTextureTexelSize),R=0;R<m;R++)A=(v=2*R)+1,pe.recoverToPool(this._pyramid[v]),0!==R&&R!==m-1&&pe.recoverToPool(this._pyramid[A]);r.deferredReleaseTextures.push(L)}}return e.SHADERVALUE_MAINTEX=Ae.propertyNameToID("u_MainTex"),e.SHADERVALUE_AUTOEXPOSURETEX=Ae.propertyNameToID("u_AutoExposureTex"),e.SHADERVALUE_SAMPLESCALE=Ae.propertyNameToID("u_SampleScale"),e.SHADERVALUE_THRESHOLD=Ae.propertyNameToID("u_Threshold"),e.SHADERVALUE_PARAMS=Ae.propertyNameToID("u_Params"),e.SHADERVALUE_BLOOMTEX=Ae.propertyNameToID("u_BloomTex"),e.SUBSHADER_PREFILTER13=0,e.SUBSHADER_PREFILTER4=1,e.SUBSHADER_DOWNSAMPLE13=2,e.SUBSHADER_DOWNSAMPLE4=3,e.SUBSHADER_UPSAMPLETENT=4,e.SUBSHADER_UPSAMPLEBOX=5,e.MAXPYRAMIDSIZE=16,e})();let Ki=(()=>{class e{constructor(e){if(!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}randomint(){var e=this._state0U,t=this._state0L,r=this._state1U,i=this._state1L,n=(i>>>0)+(t>>>0),a=r+e+(n/2>>>31)>>>0,s=n>>>0;this._state0U=r,this._state0L=i;var o=0,l=0;o=(e^=o=e<<23|(-512&t)>>>9)^r,l=(t^=l=t<<23)^i;o^=e>>>18,l^=t>>>18|(262143&e)<<14;return o^=r>>>5,l^=i>>>5|(31&r)<<27,this._state1U=o,this._state1L=l,[a,s]}random(){var t=this.randomint(),r=t[0],i=1023<<20|r>>>12,n=0|(t[1]>>>12|(4095&r)<<20);return e._CONVERTION_BUFFER.setUint32(0,i,!1),e._CONVERTION_BUFFER.setUint32(4,n,!1),e._CONVERTION_BUFFER.getFloat64(0,!1)-1}}return e._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8)),e.defaultRand=new e([0,Date.now()/65536,0,Date.now()%65536]),e})(),Ji=(()=>{class e extends c{constructor(){super(),this._childColliderShapes=[],this._type=c.SHAPETYPES_COMPOUND}static __init__(){}_clearChildShape(e){e._attatched=!1,e._compoundParent=null,e._indexInCompound=-1}_addReference(){this._referenceCount++}_removeReference(){this._referenceCount--}addChildShape(t,r=null){if(t._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";t._attatched=!0,t._compoundParent=this,t._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(t),t.localOffset=r,this.physicColliderObject&&(e._tempCannonQue.set(0,0,0,1),e._tempCannonVec.set(r.x*this._scale.x,r.y*this._scale.y,r.z*this._scale.z),this.physicColliderObject._btColliderObject.addShape(t._btShape,e._tempCannonVec,CANNON.Vec3.ZERO))}removeChildShape(e){if(e._compoundParent===this){var t=e._indexInCompound;this._clearChildShape(e);var r=this._childColliderShapes[this._childColliderShapes.length-1];r._indexInCompound=t,this._childColliderShapes[t]=r,this._childColliderShapes.pop(),this.physicColliderObject&&this.bindRigidBody(this.physicColliderObject)}}bindRigidBody(t){this.physicColliderObject=t;var r,i=t._btColliderObject;i.shapes.length=0,i.shapeOffsets.length=0,i.shapeOrientations.length=0;for(var n=0,a=this._childColliderShapes.length;n!=a;n++){var s=this._childColliderShapes[n];i.shapes.push(s._btShape),r=s.localOffset,i.shapeOffsets.push(new CANNON.Vec3(r.x*this._scale.x,r.y*this._scale.y,r.z*this._scale.z)),i.shapeOrientations.push(e._tempCannonQue)}i.updateMassProperties(),i.updateBoundingRadius(),i.aabbNeedsUpdate=!0}_setScale(e){this._scale.setValue(e.x,e.y,e.z);for(var t=this.physicColliderObject._btColliderObject,r=this.getChildShapeCount(),i=t.shapeOffsets,n=0;n<r;n++){var a=i[n],s=this._childColliderShapes[n];s._setScale(e);var o=s.localOffset;a.set(o.x*e.x,o.y*e.y,o.z*e.z)}t.updateMassProperties(),t.updateBoundingRadius(),t.aabbNeedsUpdate=!0}getChildShapeCount(){return this._childColliderShapes.length}cloneTo(e){for(var t=e,r=0,i=this._childColliderShapes.length;r<i;r++)t.addChildShape(this._childColliderShapes[r].clone())}clone(){var t=new e;return this.cloneTo(t),t}destroy(){super.destroy();for(var e=0,t=this._childColliderShapes.length;e<t;e++){var r=this._childColliderShapes[e];0===r._referenceCount&&r.destroy()}}}return e._tempCannonQue=new CANNON.Quaternion(0,0,0,1),e._tempCannonVec=new CANNON.Vec3(0,0,0),e})();class $i{constructor(e,t){this._width=0,this._height=0,this._width=e,this._height=t}static get fullScreen(){return new $i(-1,-1)}get width(){return-1===this._width?Ee.clientWidth:this._width}get height(){return-1===this._height?Ee.clientHeight:this._height}}e.AlternateLightQueue=Gt,e.AnimationClip=oe,e.AnimationClipParser03=ie,e.AnimationClipParser04=ae,e.AnimationEvent=J,e.AnimationNode=Le,e.AnimationTransform3D=Ce,e.Animator=fe,e.AnimatorControllerLayer=_e,e.AnimatorPlayState=le,e.AnimatorState=ue,e.AnimatorStateScript=class{constructor(){}onStateEnter(){}onStateUpdate(){}onStateExit(){}},e.Avatar=ye,e.BaseCamera=Tt,e.BaseMaterial=Me,e.BaseRender=tr,e.BaseShape=Xr,e.BatchMark=Zt,e.BlinnPhongMaterial=Ne,e.BlitScreenQuadCMD=Rt,e.BloomEffect=Qi,e.BoundBox=Ht,e.BoundFrustum=tt,e.BoundSphere=_r,e.Bounds=Wt,e.BoundsOctree=or,e.BoundsOctreeNode=ar,e.BoxColliderShape=M,e.BoxShape=jr,e.BufferState=nt,e.BulletInteractive=xi,e.Burst=wr,e.Camera=Nt,e.CameraCullInfo=ze,e.CannonBoxColliderShape=m,e.CannonColliderShape=c,e.CannonCollision=R,e.CannonCollisionTool=v,e.CannonCompoundColliderShape=Ji,e.CannonContactPoint=g,e.CannonHitResult=S,e.CannonPhysicsCollider=x,e.CannonPhysicsComponent=T,e.CannonPhysicsSettings=q,e.CannonPhysicsSimulation=A,e.CannonPhysicsTriggerComponent=I,e.CannonPhysicsUpdateList=p,e.CannonRigidbody3D=C,e.CannonSphereColliderShape=f,e.CapsuleColliderShape=O,e.CastShadowList=class extends E{constructor(){super()}add(e){if(-1!==e._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(e),e._indexInCastShadowList=this.length++}remove(e){var t=e._indexInCastShadowList;if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._indexInCastShadowList=t}e._indexInCastShadowList=-1}},e.CharacterController=X,e.CircleShape=Zr,e.Cluster=Ye,e.ColliderShape=L,e.Collision=G,e.CollisionTool=z,e.CollisionUtils=$e,e.Color=Ge,e.ColorOverLifetime=Fr,e.Command=St,e.CommandBuffer=It,e.CompoundColliderShape=D,e.ConchQuaternion=de,e.ConchVector3=ce,e.ConchVector4=he,e.ConeColliderShape=N,e.ConeShape=qr,e.Config3D=Q,e.ConfigurableConstraint=Wi,e.Constraint3D=class{constructor(){}},e.ConstraintComponent=zi,e.ContactPoint=B,e.ContainmentType=Je,e.CylinderColliderShape=b,e.DefineDatas=ge,e.DirectionLight=bi,e.DynamicBatchManager=mr,e.EffectMaterial=be,e.Emission=_i,e.ExtendTerrainMaterial=Pe,e.FixedConstraint=Hi,e.FloatKeyframe=ee,e.FrameOverTime=Br,e.FrustumCulling=We,e.GeometryElement=kt,e.Gradient=Pr,e.GradientAngularVelocity=Ur,e.GradientColor=Vr,e.GradientDataInt=Gr,e.GradientDataNumber=zr,e.GradientDataVector2=Zi,e.GradientMode=br,e.GradientSize=Hr,e.GradientVelocity=Wr,e.HalfFloatUtils=ne,e.HeightMap=Yi,e.HeightfieldColliderShape=class{constructor(){}},e.HemisphereShape=Qr,e.HitResult=U,e.ILaya3D=l,e.IndexBuffer3D=st,e.Input3D=bt,e.Keyframe=$,e.KeyframeNode=K,e.KeyframeNodeList=se,e.KeyframeNodeOwner=me,e.Laya3D=ki,e.LightQueue=Ut,e.LightSprite=Lt,e.Lightmap=lr,e.LoadModelV04=Fi,e.LoadModelV05=Bi,e.Material=De,e.MathUtils3D=r,e.Matrix3x3=o,e.Matrix4x4=h,e.Mesh=Di,e.MeshColliderShape=P,e.MeshFilter=Dr,e.MeshReader=Ui,e.MeshRenderDynamicBatchManager=Or,e.MeshRenderStaticBatchManager=er,e.MeshRenderer=yr,e.MeshSprite3D=Nr,e.MeshSprite3DShaderDeclaration=Lr,e.MeshTerrainSprite3D=ji,e.MouseTouch=Ze,e.OctreeMotionList=sr,e.PBRMaterial=Ve,e.PBRSpecularMaterial=Sr,e.PBRStandardMaterial=vr,e.Physics3D=Z,e.Physics3DUtils=u,e.PhysicsCollider=Ci,e.PhysicsComponent=V,e.PhysicsSettings=Pt,e.PhysicsSimulation=H,e.PhysicsTriggerComponent=Y,e.PhysicsUpdateList=F,e.Picker=it,e.PixelLineData=class{constructor(){this.startPosition=new a,this.endPosition=new a,this.startColor=new Ge,this.endColor=new Ge}cloneTo(e){this.startPosition.cloneTo(e.startPosition),this.endPosition.cloneTo(e.endPosition),this.startColor.cloneTo(e.startColor),this.endColor.cloneTo(e.endColor)}},e.PixelLineFilter=Yt,e.PixelLineMaterial=zt,e.PixelLineRenderer=rr,e.PixelLineSprite3D=ir,e.PixelLineVertex=Xt,e.Plane=Qe,e.Point2PointConstraint=class{constructor(){this._pivotInA=new a,this._pivotInB=new a}get pivotInA(){return this._pivotInA}set pivotInA(e){this._pivotInA=e}get pivotInB(){return this._pivotInB}set pivotInB(e){this._pivotInB=e}get damping(){return this._damping}set damping(e){this._damping=e}get impulseClamp(){return this._impulseClamp}set impulseClamp(e){this._impulseClamp=e}get tau(){return this._tau}set tau(e){this._tau=e}},e.PointLight=Pi,e.PostProcess=xe,e.PostProcessEffect=qi,e.PostProcessRenderContext=Te,e.PrimitiveMesh=Mi,e.Quaternion=_,e.QuaternionKeyframe=te,e.Rand=li,e.RandX=Ki,e.Ray=Ke,e.RenderContext3D=Ee,e.RenderElement=Qt,e.RenderQueue=nr,e.RenderState=Oe,e.RenderTexture=pe,e.RenderableSprite3D=jt,e.Rigidbody3D=j,e.RotationOverLifetime=kr,e.Scene3D=Tr,e.Scene3DShaderDeclaration=xt,e.Scene3DUtils=Vi,e.SceneManager=class{constructor(){}},e.ScreenQuad=pt,e.ScreenTriangle=gt,e.Script3D=Xi,e.SetRenderTargetCMD=vt,e.SetShaderDataTextureCMD=At,e.Shader3D=Ae,e.ShaderData=Ie,e.ShaderDefine=Se,e.ShaderInit3D=Ni,e.ShaderInstance=Be,e.ShaderPass=Er,e.ShaderVariable=Fe,e.ShaderVariant=Re,e.ShaderVariantCollection=ve,e.ShadowCasterPass=ur,e.ShadowCullInfo=He,e.ShadowSliceData=hr,e.ShadowSpotData=cr,e.ShadowUtils=Mt,e.ShapeUtils=Yr,e.ShuriKenParticle3D=di,e.ShuriKenParticle3DShaderDeclaration=ri,e.ShurikenParticleData=hi,e.ShurikenParticleMaterial=ii,e.ShurikenParticleRenderer=ni,e.ShurikenParticleSystem=ci,e.SimpleSingletonList=Ue,e.SingletonList=E,e.Size=$i,e.SizeOverLifetime=Jr,e.SkinnedMeshRenderer=mi,e.SkinnedMeshSprite3D=fi,e.SkinnedMeshSprite3DShaderDeclaration=ui,e.SkyBox=ut,e.SkyBoxMaterial=Ar,e.SkyDome=Vt,e.SkyMesh=dt,e.SkyPanoramicMaterial=Gi,e.SkyProceduralMaterial=Ir,e.SkyRenderer=mt,e.SphereColliderShape=w,e.SphereShape=Kr,e.SphericalHarmonicsL2=je,e.SpotLight=wi,e.Sprite3D=ft,e.StartFrame=$r,e.StaticBatchManager=Jt,e.StaticPlaneColliderShape=y,e.SubMesh=Li,e.SubMeshDynamicBatch=Mr,e.SubMeshInstanceBatch=qt,e.SubMeshRenderElement=Kt,e.SubMeshStaticBatch=$t,e.SubShader=pr,e.TextMesh=class{constructor(){}get text(){return this._text}set text(e){this._text=e}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize=e}get color(){return this._color}set color(e){this._color=e}_createVertexBuffer(e){}_resizeVertexBuffer(e){}_addChar(){}},e.TextureCube=Bt,e.TextureGenerator=W,e.TextureMode=Ei,e.TextureSheetAnimation=ei,e.Touch=qe,e.TrailFilter=Ri,e.TrailGeometry=Si,e.TrailMaterial=Ti,e.TrailRenderer=vi,e.TrailSprite3D=Ai,e.Transform3D=d,e.UnlitMaterial=xr,e.Utils3D=k,e.Vector2=i,e.Vector3=a,e.Vector3Keyframe=re,e.Vector4=n,e.VelocityOverLifetime=ti,e.VertexBuffer3D=ct,e.VertexDeclaration=lt,e.VertexElement=_t,e.VertexElementFormat=ot,e.VertexMesh=ht,e.VertexPositionTerrain=Ii,e.VertexPositionTexture0=wt,e.VertexShuriKenParticle=ai,e.VertexShurikenParticleBillboard=si,e.VertexShurikenParticleMesh=oi,e.VertexTrail=gi,e.Viewport=rt,e.WaterPrimaryMaterial=Cr,e.skinnedMatrixCache=yi}(window.Laya=window.Laya||{},Laya);